import{r as w,a as uo,R as ho,b as kt,c as Vr,d as xo}from"./react-vendor-BPcwhftq.js";import{c as ei}from"./supabase-vendor-BVx-vNnC.js";import{X as Et,I as xa,A as Zt,a as Ka,C as pt,S as Ja,R as Ms,D as cr,U as os,b as mo,c as fo,d as ht,e as xt,F as qt,L as ti,E as si,f as en,B as Rt,g as Xr,h as ri,i as Gr,M as nr,j as Nt,T as Xs,k as Hr,l as Cr,V as go,m as ai,n as ni,o as va,p as Ut,H as ii,Q as ma,G as js,q as Ls,r as Zr,s as Qr,P as ks,N as Wr,t as Cs,u as oi,v as Ga,w as fa,x as Wa,W as li,y as Ar,z as ci,J as Na,K as ir,O as ga,Y as di,Z as po,_ as bo,$ as wo,a0 as ui,a1 as yo,a2 as Ba,a3 as pa,a4 as qr,a5 as _o,a6 as vo,a7 as No,a8 as jo,a9 as tn,aa as Nn,ab as Co,ac as Eo,ad as So,ae as jn,af as Ao}from"./ui-vendor-JIt2ANjw.js";function Io(n,l){for(var c=0;c<l.length;c++){const u=l[c];if(typeof u!="string"&&!Array.isArray(u)){for(const f in u)if(f!=="default"&&!(f in n)){const x=Object.getOwnPropertyDescriptor(u,f);x&&Object.defineProperty(n,f,x.get?x:{enumerable:!0,get:()=>u[f]})}}}return Object.freeze(Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}))}(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const f of document.querySelectorAll('link[rel="modulepreload"]'))u(f);new MutationObserver(f=>{for(const x of f)if(x.type==="childList")for(const b of x.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&u(b)}).observe(document,{childList:!0,subtree:!0});function c(f){const x={};return f.integrity&&(x.integrity=f.integrity),f.referrerPolicy&&(x.referrerPolicy=f.referrerPolicy),f.crossOrigin==="use-credentials"?x.credentials="include":f.crossOrigin==="anonymous"?x.credentials="omit":x.credentials="same-origin",x}function u(f){if(f.ep)return;f.ep=!0;const x=c(f);fetch(f.href,x)}})();var hi={exports:{}},ja={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var To=w,Do=Symbol.for("react.element"),ko=Symbol.for("react.fragment"),Mo=Object.prototype.hasOwnProperty,zo=To.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Oo={key:!0,ref:!0,__self:!0,__source:!0};function xi(n,l,c){var u,f={},x=null,b=null;c!==void 0&&(x=""+c),l.key!==void 0&&(x=""+l.key),l.ref!==void 0&&(b=l.ref);for(u in l)Mo.call(l,u)&&!Oo.hasOwnProperty(u)&&(f[u]=l[u]);if(n&&n.defaultProps)for(u in l=n.defaultProps,l)f[u]===void 0&&(f[u]=l[u]);return{$$typeof:Do,type:n,key:x,ref:b,props:f,_owner:zo.current}}ja.Fragment=ko;ja.jsx=xi;ja.jsxs=xi;hi.exports=ja;var e=hi.exports,mi,Cn=uo;mi=Cn.createRoot,Cn.hydrateRoot;/**
 * @remix-run/router v1.23.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Yr(){return Yr=Object.assign?Object.assign.bind():function(n){for(var l=1;l<arguments.length;l++){var c=arguments[l];for(var u in c)Object.prototype.hasOwnProperty.call(c,u)&&(n[u]=c[u])}return n},Yr.apply(this,arguments)}var ar;(function(n){n.Pop="POP",n.Push="PUSH",n.Replace="REPLACE"})(ar||(ar={}));const En="popstate";function Ro(n){n===void 0&&(n={});function l(u,f){let{pathname:x,search:b,hash:v}=u.location;return Ya("",{pathname:x,search:b,hash:v},f.state&&f.state.usr||null,f.state&&f.state.key||"default")}function c(u,f){return typeof f=="string"?f:ba(f)}return Po(l,c,null,n)}function Xt(n,l){if(n===!1||n===null||typeof n>"u")throw new Error(l)}function fi(n,l){if(!n){typeof console<"u"&&console.warn(l);try{throw new Error(l)}catch{}}}function Lo(){return Math.random().toString(36).substr(2,8)}function Sn(n,l){return{usr:n.state,key:n.key,idx:l}}function Ya(n,l,c,u){return c===void 0&&(c=null),Yr({pathname:typeof n=="string"?n:n.pathname,search:"",hash:""},typeof l=="string"?Ir(l):l,{state:c,key:l&&l.key||u||Lo()})}function ba(n){let{pathname:l="/",search:c="",hash:u=""}=n;return c&&c!=="?"&&(l+=c.charAt(0)==="?"?c:"?"+c),u&&u!=="#"&&(l+=u.charAt(0)==="#"?u:"#"+u),l}function Ir(n){let l={};if(n){let c=n.indexOf("#");c>=0&&(l.hash=n.substr(c),n=n.substr(0,c));let u=n.indexOf("?");u>=0&&(l.search=n.substr(u),n=n.substr(0,u)),n&&(l.pathname=n)}return l}function Po(n,l,c,u){u===void 0&&(u={});let{window:f=document.defaultView,v5Compat:x=!1}=u,b=f.history,v=ar.Pop,S=null,g=E();g==null&&(g=0,b.replaceState(Yr({},b.state,{idx:g}),""));function E(){return(b.state||{idx:null}).idx}function p(){v=ar.Pop;let j=E(),M=j==null?null:j-g;g=j,S&&S({action:v,location:R.location,delta:M})}function k(j,M){v=ar.Push;let T=Ya(R.location,j,M);g=E()+1;let F=Sn(T,g),U=R.createHref(T);try{b.pushState(F,"",U)}catch(te){if(te instanceof DOMException&&te.name==="DataCloneError")throw te;f.location.assign(U)}x&&S&&S({action:v,location:R.location,delta:1})}function P(j,M){v=ar.Replace;let T=Ya(R.location,j,M);g=E();let F=Sn(T,g),U=R.createHref(T);b.replaceState(F,"",U),x&&S&&S({action:v,location:R.location,delta:0})}function D(j){let M=f.location.origin!=="null"?f.location.origin:f.location.href,T=typeof j=="string"?j:ba(j);return T=T.replace(/ $/,"%20"),Xt(M,"No window.location.(origin|href) available to create URL for href: "+T),new URL(T,M)}let R={get action(){return v},get location(){return n(f,b)},listen(j){if(S)throw new Error("A history only accepts one active listener");return f.addEventListener(En,p),S=j,()=>{f.removeEventListener(En,p),S=null}},createHref(j){return l(f,j)},createURL:D,encodeLocation(j){let M=D(j);return{pathname:M.pathname,search:M.search,hash:M.hash}},push:k,replace:P,go(j){return b.go(j)}};return R}var An;(function(n){n.data="data",n.deferred="deferred",n.redirect="redirect",n.error="error"})(An||(An={}));function Bo(n,l,c){return c===void 0&&(c="/"),Fo(n,l,c,!1)}function Fo(n,l,c,u){let f=typeof l=="string"?Ir(l):l,x=sn(f.pathname||"/",c);if(x==null)return null;let b=gi(n);Uo(b);let v=null;for(let S=0;v==null&&S<b.length;++S){let g=Ko(x);v=Zo(b[S],g,u)}return v}function gi(n,l,c,u){l===void 0&&(l=[]),c===void 0&&(c=[]),u===void 0&&(u="");let f=(x,b,v)=>{let S={relativePath:v===void 0?x.path||"":v,caseSensitive:x.caseSensitive===!0,childrenIndex:b,route:x};S.relativePath.startsWith("/")&&(Xt(S.relativePath.startsWith(u),'Absolute route path "'+S.relativePath+'" nested under path '+('"'+u+'" is not valid. An absolute child route path ')+"must start with the combined path of all its parent routes."),S.relativePath=S.relativePath.slice(u.length));let g=or([u,S.relativePath]),E=c.concat(S);x.children&&x.children.length>0&&(Xt(x.index!==!0,"Index routes must not have child routes. Please remove "+('all child routes from route path "'+g+'".')),gi(x.children,l,E,g)),!(x.path==null&&!x.index)&&l.push({path:g,score:$o(g,x.index),routesMeta:E})};return n.forEach((x,b)=>{var v;if(x.path===""||!((v=x.path)!=null&&v.includes("?")))f(x,b);else for(let S of pi(x.path))f(x,b,S)}),l}function pi(n){let l=n.split("/");if(l.length===0)return[];let[c,...u]=l,f=c.endsWith("?"),x=c.replace(/\?$/,"");if(u.length===0)return f?[x,""]:[x];let b=pi(u.join("/")),v=[];return v.push(...b.map(S=>S===""?x:[x,S].join("/"))),f&&v.push(...b),v.map(S=>n.startsWith("/")&&S===""?"/":S)}function Uo(n){n.sort((l,c)=>l.score!==c.score?c.score-l.score:Xo(l.routesMeta.map(u=>u.childrenIndex),c.routesMeta.map(u=>u.childrenIndex)))}const Vo=/^:[\w-]+$/,Ho=3,qo=2,Go=1,Wo=10,Yo=-2,In=n=>n==="*";function $o(n,l){let c=n.split("/"),u=c.length;return c.some(In)&&(u+=Yo),l&&(u+=qo),c.filter(f=>!In(f)).reduce((f,x)=>f+(Vo.test(x)?Ho:x===""?Go:Wo),u)}function Xo(n,l){return n.length===l.length&&n.slice(0,-1).every((u,f)=>u===l[f])?n[n.length-1]-l[l.length-1]:0}function Zo(n,l,c){let{routesMeta:u}=n,f={},x="/",b=[];for(let v=0;v<u.length;++v){let S=u[v],g=v===u.length-1,E=x==="/"?l:l.slice(x.length)||"/",p=Tn({path:S.relativePath,caseSensitive:S.caseSensitive,end:g},E),k=S.route;if(!p&&g&&c&&!u[u.length-1].route.index&&(p=Tn({path:S.relativePath,caseSensitive:S.caseSensitive,end:!1},E)),!p)return null;Object.assign(f,p.params),b.push({params:f,pathname:or([x,p.pathname]),pathnameBase:sl(or([x,p.pathnameBase])),route:k}),p.pathnameBase!=="/"&&(x=or([x,p.pathnameBase]))}return b}function Tn(n,l){typeof n=="string"&&(n={path:n,caseSensitive:!1,end:!0});let[c,u]=Qo(n.path,n.caseSensitive,n.end),f=l.match(c);if(!f)return null;let x=f[0],b=x.replace(/(.)\/+$/,"$1"),v=f.slice(1);return{params:u.reduce((g,E,p)=>{let{paramName:k,isOptional:P}=E;if(k==="*"){let R=v[p]||"";b=x.slice(0,x.length-R.length).replace(/(.)\/+$/,"$1")}const D=v[p];return P&&!D?g[k]=void 0:g[k]=(D||"").replace(/%2F/g,"/"),g},{}),pathname:x,pathnameBase:b,pattern:n}}function Qo(n,l,c){l===void 0&&(l=!1),c===void 0&&(c=!0),fi(n==="*"||!n.endsWith("*")||n.endsWith("/*"),'Route path "'+n+'" will be treated as if it were '+('"'+n.replace(/\*$/,"/*")+'" because the `*` character must ')+"always follow a `/` in the pattern. To get rid of this warning, "+('please change the route path to "'+n.replace(/\*$/,"/*")+'".'));let u=[],f="^"+n.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(b,v,S)=>(u.push({paramName:v,isOptional:S!=null}),S?"/?([^\\/]+)?":"/([^\\/]+)"));return n.endsWith("*")?(u.push({paramName:"*"}),f+=n==="*"||n==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):c?f+="\\/*$":n!==""&&n!=="/"&&(f+="(?:(?=\\/|$))"),[new RegExp(f,l?void 0:"i"),u]}function Ko(n){try{return n.split("/").map(l=>decodeURIComponent(l).replace(/\//g,"%2F")).join("/")}catch(l){return fi(!1,'The URL path "'+n+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent '+("encoding ("+l+").")),n}}function sn(n,l){if(l==="/")return n;if(!n.toLowerCase().startsWith(l.toLowerCase()))return null;let c=l.endsWith("/")?l.length-1:l.length,u=n.charAt(c);return u&&u!=="/"?null:n.slice(c)||"/"}function Jo(n,l){l===void 0&&(l="/");let{pathname:c,search:u="",hash:f=""}=typeof n=="string"?Ir(n):n;return{pathname:c?c.startsWith("/")?c:el(c,l):l,search:rl(u),hash:al(f)}}function el(n,l){let c=l.replace(/\/+$/,"").split("/");return n.split("/").forEach(f=>{f===".."?c.length>1&&c.pop():f!=="."&&c.push(f)}),c.length>1?c.join("/"):"/"}function Fa(n,l,c,u){return"Cannot include a '"+n+"' character in a manually specified "+("`to."+l+"` field ["+JSON.stringify(u)+"].  Please separate it out to the ")+("`to."+c+"` field. Alternatively you may provide the full path as ")+'a string in <Link to="..."> and the router will parse it for you.'}function tl(n){return n.filter((l,c)=>c===0||l.route.path&&l.route.path.length>0)}function bi(n,l){let c=tl(n);return l?c.map((u,f)=>f===c.length-1?u.pathname:u.pathnameBase):c.map(u=>u.pathnameBase)}function wi(n,l,c,u){u===void 0&&(u=!1);let f;typeof n=="string"?f=Ir(n):(f=Yr({},n),Xt(!f.pathname||!f.pathname.includes("?"),Fa("?","pathname","search",f)),Xt(!f.pathname||!f.pathname.includes("#"),Fa("#","pathname","hash",f)),Xt(!f.search||!f.search.includes("#"),Fa("#","search","hash",f)));let x=n===""||f.pathname==="",b=x?"/":f.pathname,v;if(b==null)v=c;else{let p=l.length-1;if(!u&&b.startsWith("..")){let k=b.split("/");for(;k[0]==="..";)k.shift(),p-=1;f.pathname=k.join("/")}v=p>=0?l[p]:"/"}let S=Jo(f,v),g=b&&b!=="/"&&b.endsWith("/"),E=(x||b===".")&&c.endsWith("/");return!S.pathname.endsWith("/")&&(g||E)&&(S.pathname+="/"),S}const or=n=>n.join("/").replace(/\/\/+/g,"/"),sl=n=>n.replace(/\/+$/,"").replace(/^\/*/,"/"),rl=n=>!n||n==="?"?"":n.startsWith("?")?n:"?"+n,al=n=>!n||n==="#"?"":n.startsWith("#")?n:"#"+n;function nl(n){return n!=null&&typeof n.status=="number"&&typeof n.statusText=="string"&&typeof n.internal=="boolean"&&"data"in n}const yi=["post","put","patch","delete"];new Set(yi);const il=["get",...yi];new Set(il);/**
 * React Router v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function $r(){return $r=Object.assign?Object.assign.bind():function(n){for(var l=1;l<arguments.length;l++){var c=arguments[l];for(var u in c)Object.prototype.hasOwnProperty.call(c,u)&&(n[u]=c[u])}return n},$r.apply(this,arguments)}const rn=w.createContext(null),ol=w.createContext(null),gr=w.createContext(null),Ca=w.createContext(null),pr=w.createContext({outlet:null,matches:[],isDataRoute:!1}),_i=w.createContext(null);function ll(n,l){let{relative:c}=l===void 0?{}:l;Kr()||Xt(!1);let{basename:u,navigator:f}=w.useContext(gr),{hash:x,pathname:b,search:v}=Ni(n,{relative:c}),S=b;return u!=="/"&&(S=b==="/"?u:or([u,b])),f.createHref({pathname:S,search:v,hash:x})}function Kr(){return w.useContext(Ca)!=null}function Ea(){return Kr()||Xt(!1),w.useContext(Ca).location}function vi(n){w.useContext(gr).static||w.useLayoutEffect(n)}function cl(){let{isDataRoute:n}=w.useContext(pr);return n?vl():dl()}function dl(){Kr()||Xt(!1);let n=w.useContext(rn),{basename:l,future:c,navigator:u}=w.useContext(gr),{matches:f}=w.useContext(pr),{pathname:x}=Ea(),b=JSON.stringify(bi(f,c.v7_relativeSplatPath)),v=w.useRef(!1);return vi(()=>{v.current=!0}),w.useCallback(function(g,E){if(E===void 0&&(E={}),!v.current)return;if(typeof g=="number"){u.go(g);return}let p=wi(g,JSON.parse(b),x,E.relative==="path");n==null&&l!=="/"&&(p.pathname=p.pathname==="/"?l:or([l,p.pathname])),(E.replace?u.replace:u.push)(p,E.state,E)},[l,u,b,x,n])}function Ni(n,l){let{relative:c}=l===void 0?{}:l,{future:u}=w.useContext(gr),{matches:f}=w.useContext(pr),{pathname:x}=Ea(),b=JSON.stringify(bi(f,u.v7_relativeSplatPath));return w.useMemo(()=>wi(n,JSON.parse(b),x,c==="path"),[n,b,x,c])}function ul(n,l){return hl(n,l)}function hl(n,l,c,u){Kr()||Xt(!1);let{navigator:f}=w.useContext(gr),{matches:x}=w.useContext(pr),b=x[x.length-1],v=b?b.params:{};b&&b.pathname;let S=b?b.pathnameBase:"/";b&&b.route;let g=Ea(),E;if(l){var p;let j=typeof l=="string"?Ir(l):l;S==="/"||(p=j.pathname)!=null&&p.startsWith(S)||Xt(!1),E=j}else E=g;let k=E.pathname||"/",P=k;if(S!=="/"){let j=S.replace(/^\//,"").split("/");P="/"+k.replace(/^\//,"").split("/").slice(j.length).join("/")}let D=Bo(n,{pathname:P}),R=pl(D&&D.map(j=>Object.assign({},j,{params:Object.assign({},v,j.params),pathname:or([S,f.encodeLocation?f.encodeLocation(j.pathname).pathname:j.pathname]),pathnameBase:j.pathnameBase==="/"?S:or([S,f.encodeLocation?f.encodeLocation(j.pathnameBase).pathname:j.pathnameBase])})),x,c,u);return l&&R?w.createElement(Ca.Provider,{value:{location:$r({pathname:"/",search:"",hash:"",state:null,key:"default"},E),navigationType:ar.Pop}},R):R}function xl(){let n=_l(),l=nl(n)?n.status+" "+n.statusText:n instanceof Error?n.message:JSON.stringify(n),c=n instanceof Error?n.stack:null,f={padding:"0.5rem",backgroundColor:"rgba(200,200,200, 0.5)"};return w.createElement(w.Fragment,null,w.createElement("h2",null,"Unexpected Application Error!"),w.createElement("h3",{style:{fontStyle:"italic"}},l),c?w.createElement("pre",{style:f},c):null,null)}const ml=w.createElement(xl,null);class fl extends w.Component{constructor(l){super(l),this.state={location:l.location,revalidation:l.revalidation,error:l.error}}static getDerivedStateFromError(l){return{error:l}}static getDerivedStateFromProps(l,c){return c.location!==l.location||c.revalidation!=="idle"&&l.revalidation==="idle"?{error:l.error,location:l.location,revalidation:l.revalidation}:{error:l.error!==void 0?l.error:c.error,location:c.location,revalidation:l.revalidation||c.revalidation}}componentDidCatch(l,c){console.error("React Router caught the following error during render",l,c)}render(){return this.state.error!==void 0?w.createElement(pr.Provider,{value:this.props.routeContext},w.createElement(_i.Provider,{value:this.state.error,children:this.props.component})):this.props.children}}function gl(n){let{routeContext:l,match:c,children:u}=n,f=w.useContext(rn);return f&&f.static&&f.staticContext&&(c.route.errorElement||c.route.ErrorBoundary)&&(f.staticContext._deepestRenderedBoundaryId=c.route.id),w.createElement(pr.Provider,{value:l},u)}function pl(n,l,c,u){var f;if(l===void 0&&(l=[]),c===void 0&&(c=null),u===void 0&&(u=null),n==null){var x;if(!c)return null;if(c.errors)n=c.matches;else if((x=u)!=null&&x.v7_partialHydration&&l.length===0&&!c.initialized&&c.matches.length>0)n=c.matches;else return null}let b=n,v=(f=c)==null?void 0:f.errors;if(v!=null){let E=b.findIndex(p=>p.route.id&&(v==null?void 0:v[p.route.id])!==void 0);E>=0||Xt(!1),b=b.slice(0,Math.min(b.length,E+1))}let S=!1,g=-1;if(c&&u&&u.v7_partialHydration)for(let E=0;E<b.length;E++){let p=b[E];if((p.route.HydrateFallback||p.route.hydrateFallbackElement)&&(g=E),p.route.id){let{loaderData:k,errors:P}=c,D=p.route.loader&&k[p.route.id]===void 0&&(!P||P[p.route.id]===void 0);if(p.route.lazy||D){S=!0,g>=0?b=b.slice(0,g+1):b=[b[0]];break}}}return b.reduceRight((E,p,k)=>{let P,D=!1,R=null,j=null;c&&(P=v&&p.route.id?v[p.route.id]:void 0,R=p.route.errorElement||ml,S&&(g<0&&k===0?(D=!0,j=null):g===k&&(D=!0,j=p.route.hydrateFallbackElement||null)));let M=l.concat(b.slice(0,k+1)),T=()=>{let F;return P?F=R:D?F=j:p.route.Component?F=w.createElement(p.route.Component,null):p.route.element?F=p.route.element:F=E,w.createElement(gl,{match:p,routeContext:{outlet:E,matches:M,isDataRoute:c!=null},children:F})};return c&&(p.route.ErrorBoundary||p.route.errorElement||k===0)?w.createElement(fl,{location:c.location,revalidation:c.revalidation,component:R,error:P,children:T(),routeContext:{outlet:null,matches:M,isDataRoute:!0}}):T()},null)}var ji=function(n){return n.UseBlocker="useBlocker",n.UseRevalidator="useRevalidator",n.UseNavigateStable="useNavigate",n}(ji||{}),wa=function(n){return n.UseBlocker="useBlocker",n.UseLoaderData="useLoaderData",n.UseActionData="useActionData",n.UseRouteError="useRouteError",n.UseNavigation="useNavigation",n.UseRouteLoaderData="useRouteLoaderData",n.UseMatches="useMatches",n.UseRevalidator="useRevalidator",n.UseNavigateStable="useNavigate",n.UseRouteId="useRouteId",n}(wa||{});function bl(n){let l=w.useContext(rn);return l||Xt(!1),l}function wl(n){let l=w.useContext(ol);return l||Xt(!1),l}function yl(n){let l=w.useContext(pr);return l||Xt(!1),l}function Ci(n){let l=yl(),c=l.matches[l.matches.length-1];return c.route.id||Xt(!1),c.route.id}function _l(){var n;let l=w.useContext(_i),c=wl(wa.UseRouteError),u=Ci(wa.UseRouteError);return l!==void 0?l:(n=c.errors)==null?void 0:n[u]}function vl(){let{router:n}=bl(ji.UseNavigateStable),l=Ci(wa.UseNavigateStable),c=w.useRef(!1);return vi(()=>{c.current=!0}),w.useCallback(function(f,x){x===void 0&&(x={}),c.current&&(typeof f=="number"?n.navigate(f):n.navigate(f,$r({fromRouteId:l},x)))},[n,l])}function Nl(n,l){n==null||n.v7_startTransition,n==null||n.v7_relativeSplatPath}function ha(n){Xt(!1)}function jl(n){let{basename:l="/",children:c=null,location:u,navigationType:f=ar.Pop,navigator:x,static:b=!1,future:v}=n;Kr()&&Xt(!1);let S=l.replace(/^\/*/,"/"),g=w.useMemo(()=>({basename:S,navigator:x,static:b,future:$r({v7_relativeSplatPath:!1},v)}),[S,v,x,b]);typeof u=="string"&&(u=Ir(u));let{pathname:E="/",search:p="",hash:k="",state:P=null,key:D="default"}=u,R=w.useMemo(()=>{let j=sn(E,S);return j==null?null:{location:{pathname:j,search:p,hash:k,state:P,key:D},navigationType:f}},[S,E,p,k,P,D,f]);return R==null?null:w.createElement(gr.Provider,{value:g},w.createElement(Ca.Provider,{children:c,value:R}))}function Cl(n){let{children:l,location:c}=n;return ul($a(l),c)}new Promise(()=>{});function $a(n,l){l===void 0&&(l=[]);let c=[];return w.Children.forEach(n,(u,f)=>{if(!w.isValidElement(u))return;let x=[...l,f];if(u.type===w.Fragment){c.push.apply(c,$a(u.props.children,x));return}u.type!==ha&&Xt(!1),!u.props.index||!u.props.children||Xt(!1);let b={id:u.props.id||x.join("-"),caseSensitive:u.props.caseSensitive,element:u.props.element,Component:u.props.Component,index:u.props.index,path:u.props.path,loader:u.props.loader,action:u.props.action,errorElement:u.props.errorElement,ErrorBoundary:u.props.ErrorBoundary,hasErrorBoundary:u.props.ErrorBoundary!=null||u.props.errorElement!=null,shouldRevalidate:u.props.shouldRevalidate,handle:u.props.handle,lazy:u.props.lazy};u.props.children&&(b.children=$a(u.props.children,x)),c.push(b)}),c}/**
 * React Router DOM v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Xa(){return Xa=Object.assign?Object.assign.bind():function(n){for(var l=1;l<arguments.length;l++){var c=arguments[l];for(var u in c)Object.prototype.hasOwnProperty.call(c,u)&&(n[u]=c[u])}return n},Xa.apply(this,arguments)}function El(n,l){if(n==null)return{};var c={},u=Object.keys(n),f,x;for(x=0;x<u.length;x++)f=u[x],!(l.indexOf(f)>=0)&&(c[f]=n[f]);return c}function Sl(n){return!!(n.metaKey||n.altKey||n.ctrlKey||n.shiftKey)}function Al(n,l){return n.button===0&&(!l||l==="_self")&&!Sl(n)}const Il=["onClick","relative","reloadDocument","replace","state","target","to","preventScrollReset","viewTransition"],Tl="6";try{window.__reactRouterVersion=Tl}catch{}const Dl="startTransition",Dn=ho[Dl];function kn(n){let{basename:l,children:c,future:u,window:f}=n,x=w.useRef();x.current==null&&(x.current=Ro({window:f,v5Compat:!0}));let b=x.current,[v,S]=w.useState({action:b.action,location:b.location}),{v7_startTransition:g}=u||{},E=w.useCallback(p=>{g&&Dn?Dn(()=>S(p)):S(p)},[S,g]);return w.useLayoutEffect(()=>b.listen(E),[b,E]),w.useEffect(()=>Nl(u),[u]),w.createElement(jl,{basename:l,children:c,location:v.location,navigationType:v.action,navigator:b,future:u})}const kl=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u",Ml=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,Ei=w.forwardRef(function(l,c){let{onClick:u,relative:f,reloadDocument:x,replace:b,state:v,target:S,to:g,preventScrollReset:E,viewTransition:p}=l,k=El(l,Il),{basename:P}=w.useContext(gr),D,R=!1;if(typeof g=="string"&&Ml.test(g)&&(D=g,kl))try{let F=new URL(window.location.href),U=g.startsWith("//")?new URL(F.protocol+g):new URL(g),te=sn(U.pathname,P);U.origin===F.origin&&te!=null?g=te+U.search+U.hash:R=!0}catch{}let j=ll(g,{relative:f}),M=zl(g,{replace:b,state:v,target:S,preventScrollReset:E,relative:f,viewTransition:p});function T(F){u&&u(F),F.defaultPrevented||M(F)}return w.createElement("a",Xa({},k,{href:D||j,onClick:R||x?u:T,ref:c,target:S}))});var Mn;(function(n){n.UseScrollRestoration="useScrollRestoration",n.UseSubmit="useSubmit",n.UseSubmitFetcher="useSubmitFetcher",n.UseFetcher="useFetcher",n.useViewTransitionState="useViewTransitionState"})(Mn||(Mn={}));var zn;(function(n){n.UseFetcher="useFetcher",n.UseFetchers="useFetchers",n.UseScrollRestoration="useScrollRestoration"})(zn||(zn={}));function zl(n,l){let{target:c,replace:u,state:f,preventScrollReset:x,relative:b,viewTransition:v}=l===void 0?{}:l,S=cl(),g=Ea(),E=Ni(n,{relative:b});return w.useCallback(p=>{if(Al(p,c)){p.preventDefault();let k=u!==void 0?u:ba(g)===ba(E);S(n,{replace:k,state:f,preventScrollReset:x,relative:b,viewTransition:v})}},[g,S,E,u,f,c,n,x,b,v])}const Ol="https://idewdhvmcyhpgvpmkefd.supabase.co",Rl="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkZXdkaHZtY3locGd2cG1rZWZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU1ODgxNDMsImV4cCI6MjA1MTE2NDE0M30.RAIBKUjHAbx_a5_KUvs-Loc2hNd6SU6etOEczz4-moQ";let Ua=null;function Ll(){return Ua||(Ua=ei(Ol,Rl,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,flowType:"pkce",storageKey:"crew-mobile-auth",storage:window.localStorage}}),console.log("Supabase client initialized")),Ua}const Se=Ll();async function Pl(){const{error:n}=await Se.auth.signOut();if(n)throw n}async function Bl(){const{data:{user:n}}=await Se.auth.getUser();return n}const Va="crewmanager_auth_user",Ha="crewmanager_auth_timestamp",Fl=24,Si=w.createContext(void 0),Ul=({children:n})=>{const[l,c]=w.useState(null),[u,f]=w.useState(!0),[x,b]=w.useState(!1);w.useEffect(()=>{v()},[]);const v=async()=>{try{const j=g();if(j){console.log("üîÑ Ripristino sessione salvata per:",j.email),c(j),b(j.isFirstAccess||!1),f(!1);return}await p()}catch(j){console.error("Errore nell'inizializzazione auth:",j),f(!1)}},S=j=>{try{const M={user:j,timestamp:new Date().getTime()};localStorage.setItem(Va,JSON.stringify(M)),localStorage.setItem(Ha,M.timestamp.toString()),console.log("üíæ Sessione salvata nel localStorage per:",j.email)}catch(M){console.error("Errore nel salvataggio sessione:",M)}},g=()=>{try{const j=localStorage.getItem(Va),M=localStorage.getItem(Ha);if(!j||!M)return null;const T=parseInt(M);if((new Date().getTime()-T)/(1e3*60*60)>Fl)return console.log("‚è∞ Sessione scaduta, rimuovo dal localStorage"),E(),null;const te=JSON.parse(j);return console.log("üì± Sessione caricata dal localStorage:",te.user.email),te.user}catch(j){return console.error("Errore nel caricamento sessione:",j),E(),null}},E=()=>{try{localStorage.removeItem(Va),localStorage.removeItem(Ha),console.log("üóëÔ∏è Sessione rimossa dal localStorage")}catch(j){console.error("Errore nella rimozione sessione:",j)}},p=async()=>{try{const j=await Bl();if(j){console.log("üîç Controllo utente corrente:",j.id,j.email);const{data:M,error:T}=await Se.from("registration_requests").select("*, parent_company_id, software_codice, tipologia_registrazione").eq("auth_user_id",j.id).maybeSingle();if(!T&&M)if(M.parent_company_id&&!M.is_suspended){console.log("‚úÖ Trovato come crew:",M.full_name||M.company_name);const F=M.primo_accesso||!1;b(F);const U={id:j.id,email:M.email,role:"crew",displayName:M.full_name||M.company_name||M.email,isFirstAccess:F};c(U),S(U),f(!1);return}else console.log("‚ùå Utente non √® un dipendente valido o √® sospeso"),await Se.auth.signOut(),c(null);else console.log("‚ùå Crew member non trovato"),c(null)}}catch(j){console.error("Error checking user:",j)}finally{f(!1)}},R={user:l,loading:u,isFirstAccess:x,login:async(j,M,T="company")=>{try{console.log("üîë Tentativo login con Supabase Auth per:",j,"Password length:",M.length);const{data:F,error:U}=await Se.auth.signInWithPassword({email:j,password:M});if(U)throw console.error("‚ùå Errore autenticazione Supabase:",U.message,"Code:",U.status),new Error("Email o password non corretti");const te=F.user;if(!te)throw new Error("Dati utente non validi");console.log("‚úÖ Login Supabase riuscito per:",te.email);const{data:N,error:_}=await Se.from("registration_requests").select("*, parent_company_id, software_codice, tipologia_registrazione").eq("auth_user_id",te.id).maybeSingle();if(_||!N)throw console.error("‚ùå Utente NON trovato in registration_requests"),await Se.auth.signOut(),new Error("Accesso negato. Questa app √® riservata ai dipendenti.");if(!N.parent_company_id)throw console.error("‚ùå L'utente √® un'azienda, non un dipendente"),await Se.auth.signOut(),new Error("Accesso negato. Le aziende devono usare l'App Azienda.");if(N.is_suspended)throw console.error("‚ùå Account sospeso"),await Se.auth.signOut(),new Error("Account sospeso. Contatta l'amministratore.");console.log("‚úÖ Dipendente verificato:",N.full_name||N.company_name);const V=N.primo_accesso||!1;b(V);const C={id:te.id,email:N.email,role:"crew",displayName:N.full_name||N.company_name||N.email,isFirstAccess:V};c(C),S(C)}catch(F){throw console.error("Login error:",F),F}},logout:async()=>{try{await Pl(),E(),c(null),b(!1)}catch(j){throw console.error("Logout error:",j),E(),c(null),b(!1),j}},updatePassword:async j=>{try{const{error:M}=await Se.auth.updateUser({password:j});if(M)throw console.error("Errore aggiornamento password Supabase Auth:",M),M;if(console.log("‚úÖ Password aggiornata in Supabase Auth"),l){const{error:T}=await Se.from("registration_requests").update({primo_accesso:!1,password_definitiva:j,temp_password:null,updated_at:new Date().toISOString()}).eq("auth_user_id",l.id);if(T)throw T;console.log("‚úÖ Password sincronizzata in registration_requests"),b(!1);const F={...l,isFirstAccess:!1};c(F),S(F)}return!0}catch(M){return console.error("Password update error:",M),!1}}};return e.jsx(Si.Provider,{value:R,children:n})},Pt=()=>{const n=w.useContext(Si);if(n===void 0)throw new Error("useAuth must be used within an AuthProvider");return n},Vl=w.createContext(void 0),Hl=({children:n})=>{Pt();const[l,c]=w.useState([{crewId:"crew-1",isPublicProfile:!0,hiddenFromCompanies:["company-2"],hiddenFields:{"company-2":["hourlyRate","phone"],"company-3":["hourlyRate","experience","phone","address"]}},{crewId:"crew-2",isPublicProfile:!0,hiddenFromCompanies:[],hiddenFields:{}},{crewId:"crew-3",isPublicProfile:!1,hiddenFromCompanies:["company-1","company-2"],hiddenFields:{"company-1":["hourlyRate","phone","address","availability"],"company-2":["hourlyRate","experience","phone","address","skills","bio"]}}]),[u,f]=w.useState([{userId:"crew-1",userType:"crew",busyDates:[{date:"2025-03-15",eventId:"event-1",companyId:"company-1",type:"freelance_assignment",title:"Fiera Milano",isVisible:!0},{date:"2025-03-20",type:"personal_busy",title:"Impegno Personale",isVisible:!1}],sharedWith:[]},{userId:"crew-2",userType:"crew",busyDates:[{date:"2025-03-12",eventId:"event-2",companyId:"company-1",type:"company_event",title:"Inventario Magazzino",isVisible:!0}],sharedWith:["company-1"]}]),x=j=>{c(M=>[...M,j])},b=(j,M)=>{c(T=>T.map(F=>F.crewId===j?{...F,...M}:F))},v=(j,M,T=[])=>{c(F=>F.map(U=>{if(U.crewId===j){const te=U.hiddenFromCompanies.includes(M)?U.hiddenFromCompanies:[...U.hiddenFromCompanies,M],N={...U.hiddenFields,[M]:T.length>0?T:["hourlyRate","phone"]};return{...U,hiddenFromCompanies:te,hiddenFields:N}}return U})),R(j,"privacy_update",{action:"hidden_from_company",companyId:M,hiddenFields:T})},S=(j,M)=>{c(T=>T.map(F=>{if(F.crewId===j){const U=F.hiddenFromCompanies.filter(N=>N!==M),te={...F.hiddenFields};return delete te[M],{...F,hiddenFromCompanies:U,hiddenFields:te}}return F})),R(j,"privacy_update",{action:"unhidden_from_company",companyId:M})},g=j=>l.filter(M=>M.isPublicProfile&&!M.hiddenFromCompanies.includes(j)).map(M=>M.crewId),E=(j,M)=>{const T=l.find(F=>F.crewId===j);return T?T.isPublicProfile&&!T.hiddenFromCompanies.includes(M):!0},p=(j,M)=>{const T=l.find(F=>F.crewId===j);return T?T.hiddenFields[M]||[]:[]},k=(j,M,T,F)=>{f(U=>U.map(te=>{if(te.userId===j){const N={date:M,eventId:T,companyId:F,type:"freelance_assignment",title:`Evento ${T}`,isVisible:!0};return{...te,busyDates:[...te.busyDates,N]}}return te})),R(j,"calendar_sync",{eventDate:M,eventId:T,companyId:F,message:"Il tuo calendario √® stato aggiornato con un nuovo evento"})},P=j=>{const M=u.find(T=>T.userId===j);return M?M.busyDates.map(T=>T.date):[]},D=(j,M)=>!P(j).includes(M),R=(j,M,T)=>{console.log("üìß Privacy Notification:",{to:j,type:M,data:T,timestamp:new Date})};return e.jsx(Vl.Provider,{value:{crewPrivacySettings:l,addCrewPrivacy:x,updateCrewPrivacy:b,hideFromCompany:v,unhideFromCompany:S,getVisibleCrewForCompany:g,isCrewVisibleToCompany:E,getHiddenFieldsForCompany:p,calendarSyncs:u,syncCrewCalendar:k,getCrewBusyDates:P,isCrewAvailableOnDate:D,sendPrivacyNotification:R},children:n})},Ai=()=>{const[n,l]=w.useState([]),c=w.useCallback(S=>{const g=Math.random().toString(36).substr(2,9),E={...S,id:g,duration:S.duration||5e3};l(p=>[...p,E])},[]),u=w.useCallback(S=>{l(g=>g.filter(E=>E.id!==S))},[]),f=w.useCallback((S,g,E)=>{c({type:"success",title:S,message:g,duration:E})},[c]),x=w.useCallback((S,g,E)=>{c({type:"error",title:S,message:g,duration:E})},[c]),b=w.useCallback((S,g,E)=>{c({type:"warning",title:S,message:g,duration:E})},[c]),v=w.useCallback((S,g,E)=>{c({type:"info",title:S,message:g,duration:E})},[c]);return{toasts:n,addToast:c,removeToast:u,showSuccess:f,showError:x,showWarning:b,showInfo:v}},Ii=w.createContext(void 0),ql=({children:n})=>{const l=Ai();return e.jsx(Ii.Provider,{value:l,children:n})},ms=()=>{const n=w.useContext(Ii);if(n===void 0)throw new Error("useToastContext must be used within a ToastProvider");return n},Gl=({toast:n,onRemove:l})=>{w.useEffect(()=>{const x=setTimeout(()=>{l(n.id)},n.duration||5e3);return()=>clearTimeout(x)},[n.id,n.duration,l]);const c=()=>{switch(n.type){case"success":return e.jsx(pt,{className:"h-7 w-7 text-green-500"});case"error":return e.jsx(Ka,{className:"h-7 w-7 text-red-500"});case"warning":return e.jsx(Zt,{className:"h-7 w-7 text-yellow-500"});case"info":return e.jsx(xa,{className:"h-7 w-7 text-blue-500"});default:return e.jsx(xa,{className:"h-7 w-7 text-blue-500"})}},u=()=>{switch(n.type){case"success":return"bg-white border-green-300 shadow-green-100";case"error":return"bg-white border-red-300 shadow-red-100";case"warning":return"bg-white border-yellow-300 shadow-yellow-100";case"info":return"bg-white border-blue-300 shadow-blue-100";default:return"bg-white border-blue-300 shadow-blue-100"}},f=()=>{switch(n.type){case"success":return"text-green-700";case"error":return"text-red-700";case"warning":return"text-yellow-700";case"info":return"text-blue-700";default:return"text-blue-700"}};return e.jsx("div",{className:`min-w-96 max-w-lg w-full border-2 rounded-xl shadow-2xl pointer-events-auto ${u()} mx-auto transform transition-all duration-300 ease-out`,children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0",children:c()}),e.jsxs("div",{className:"ml-4 w-0 flex-1",children:[e.jsx("p",{className:`text-lg font-semibold ${f()} leading-tight`,children:n.title}),n.message&&e.jsx("p",{className:`mt-3 text-base ${f()} opacity-90 leading-relaxed`,children:n.message})]}),e.jsx("div",{className:"ml-4 flex-shrink-0 flex",children:e.jsxs("button",{className:`rounded-full inline-flex ${f()} hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 p-2 transition-all duration-200 hover:bg-white hover:bg-opacity-20`,onClick:()=>l(n.id),children:[e.jsx("span",{className:"sr-only",children:"Chiudi"}),e.jsx(Et,{className:"h-5 w-5"})]})})]})})})},Wl=({toasts:n,onRemoveToast:l})=>e.jsx("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 space-y-4 pointer-events-none",children:n.map(c=>e.jsx("div",{className:"transform transition-all duration-300 ease-in-out pointer-events-auto",children:e.jsx(Gl,{toast:c,onRemove:l})},c.id))}),Yl=({currentVersion:n,latestVersion:l,releaseNotes:c,isUpdating:u,onUpdate:f,onDismiss:x})=>e.jsx("div",{className:"fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center p-4",children:e.jsx("div",{className:"bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg",children:e.jsx(Ja,{className:"h-8 w-8 text-white"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"Aggiornamento Disponibile"}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Versione Attuale:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:n||"Sconosciuta"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Nuova Versione:"}),e.jsx("span",{className:"text-sm font-bold text-blue-600",children:l})]})]}),c?e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4 mb-6 text-left",children:[e.jsx("h4",{className:"text-sm font-semibold text-blue-900 mb-2",children:"Novit√†:"}),e.jsx("p",{className:"text-blue-800 text-sm leading-relaxed whitespace-pre-line",children:c})]}):e.jsx("p",{className:"text-gray-600 text-sm mb-6 leading-relaxed",children:"√à disponibile una nuova versione dell'app con miglioramenti e correzioni. L'aggiornamento richiede solo pochi secondi."}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:f,disabled:u,className:"w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center space-x-2",children:u?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{children:"Aggiornamento in corso..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(cr,{className:"h-5 w-5"}),e.jsx("span",{children:"Aggiorna Ora"})]})}),!u&&e.jsx("button",{onClick:x,className:"w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-4 rounded-xl transition-colors duration-200",children:"Pi√π Tardi"})]}),u&&e.jsx("div",{className:"mt-4 bg-blue-50 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(pt,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-sm text-blue-800",children:"Pulizia cache e download nuova versione..."})]})})]})})}),$l=()=>{const[n,l]=w.useState({currentVersion:null,latestVersion:null,releaseNotes:null,hasUpdate:!1,isLoading:!1,isUpdating:!1,error:null}),[c,u]=w.useState(0),f=5*60*1e3,x=w.useCallback(()=>{const k=new URLSearchParams(window.location.search).get("_v");return k?(localStorage.setItem("crew_app_version",k),k):localStorage.getItem("crew_app_version")},[]),b=w.useCallback(()=>new URLSearchParams(window.location.search).get("_updated")==="true",[]),v=w.useCallback(async()=>{try{console.log("üîç Controllo versione da database per software_code: crew_mobile");const{data:p,error:k}=await Se.from("software_versions").select("*").eq("software_code","crew_mobile").eq("is_active",!0).order("release_date",{ascending:!1}).limit(1).maybeSingle();return k?(console.error("‚ùå Errore caricamento versione da database:",k),await S()):p?(console.log("‚úÖ Versione caricata da database:",p.current_version),{version:p.current_version,buildTimestamp:p.release_date,features:Array.isArray(p.features)?p.features:[],releaseNotes:p.release_notes||"",description:p.description||""}):(console.warn("‚ö†Ô∏è Nessuna versione attiva trovata nel database per crew_mobile"),await S())}catch(p){return console.error("‚ùå Errore generale nel controllo versione database:",p),await S()}},[]),S=w.useCallback(async()=>{try{console.log("üìÑ Fallback: caricamento versione da file statico");const p=Date.now(),k=await fetch(`/version.json?_t=${p}`,{method:"GET",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}});if(!k.ok)throw new Error(`HTTP ${k.status}: ${k.statusText}`);const P=await k.json();return console.log("‚úÖ Versione caricata da file statico:",P.version),P}catch(p){return console.error("‚ùå Errore nel fetch versione da file:",p),null}},[]),g=w.useCallback(async(p=!1)=>{const k=Date.now();if(!p&&k-c<f||n.isLoading||n.isUpdating)return!1;l(P=>({...P,isLoading:!0,error:null})),u(k);try{const P=x(),D=await v();if(!D)return l(j=>({...j,isLoading:!1,error:"Impossibile verificare aggiornamenti"})),!1;const R=P!==D.version;return l(j=>({...j,currentVersion:P,latestVersion:D.version,releaseNotes:D.releaseNotes||null,hasUpdate:R,isLoading:!1,error:null})),console.log("üîç Controllo versione:",{current:P,latest:D.version,hasUpdate:R,buildTime:D.buildTimestamp}),R}catch(P){return console.error("Errore nel controllo versioni:",P),l(D=>({...D,isLoading:!1,error:"Errore controllo versioni"})),!1}},[x,v,c,n.isLoading,n.isUpdating,f]),E=w.useCallback(async()=>{if(!(n.isUpdating||!n.hasUpdate)){l(p=>({...p,isUpdating:!0}));try{if(console.log("üîÑ Applicazione aggiornamento..."),"caches"in window){const P=await caches.keys();await Promise.all(P.map(D=>caches.delete(D))),console.log("üóëÔ∏è Cache cancellate:",P.length)}n.latestVersion&&(localStorage.setItem("crew_app_version",n.latestVersion),localStorage.setItem("crew_app_last_update",new Date().toISOString()));const p=Date.now(),k=new URL(window.location.href);k.searchParams.set("_v",n.latestVersion||""),k.searchParams.set("_t",p.toString()),k.searchParams.set("_updated","true"),console.log("üöÄ Reindirizzamento a:",k.toString()),window.location.href=k.toString()}catch(p){console.error("Errore nell'applicazione aggiornamento:",p),l(k=>({...k,isUpdating:!1,error:"Errore durante aggiornamento"}))}}},[n.isUpdating,n.hasUpdate,n.latestVersion]);return w.useEffect(()=>{(async()=>{let P=x();if(P)l(D=>({...D,currentVersion:P}));else{const D=await v();D&&(P=D.version,localStorage.setItem("crew_app_version",P),l(R=>({...R,currentVersion:P,latestVersion:P,hasUpdate:!1})))}})(),b()||(async()=>(await new Promise(D=>setTimeout(D,2e3)),await g(!1)))();const k=()=>{g(!1)};return window.addEventListener("focus",k),()=>{window.removeEventListener("focus",k)}},[g,x,b,v]),{...n,checkForUpdates:p=>g(p||!1),applyUpdate:E}},Xl=({onEnter:n})=>{const[l,c]=w.useState(!1),[u,f]=w.useState(0),[x,b]=w.useState(!1),[v,S]=w.useState("1.8.4"),[g,E]=w.useState("Dicembre 2025"),p=R=>{const j=new Date(R),T=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][j.getMonth()],F=j.getFullYear();return`${T} ${F}`};w.useEffect(()=>{(async()=>{try{const{data:U,error:te}=await Se.from("software_versions").select("current_version, release_date").eq("software_code","crew_mobile").eq("is_active",!0).order("release_date",{ascending:!1}).limit(1).maybeSingle();U&&!te&&(S(U.current_version),E(p(U.release_date)))}catch(U){console.error("Errore caricamento versione:",U)}})(),c(!0);const j=setInterval(()=>{f(U=>(U+1)%3)},4e3),M=()=>{window.deferredPrompt&&(console.log("üì± Install prompt disponibile"),b(!0))};M();const T=setInterval(M,1e3);setTimeout(()=>{clearInterval(T)},1e4);const F=()=>{b(!0)};return window.addEventListener("beforeinstallprompt",F),()=>{clearInterval(j),clearInterval(T),window.removeEventListener("beforeinstallprompt",F)}},[]);const k=async()=>{const R=window.deferredPrompt;if(!R){console.log("‚ùå Prompt installazione non disponibile"),P();return}console.log("üì± Avvio installazione PWA"),R.prompt();const{outcome:j}=await R.userChoice;j==="accepted"?(console.log("PWA installata con successo"),b(!1)):console.log("Installazione rifiutata dall'utente"),window.deferredPrompt=null},P=()=>{const R=/iPad|iPhone|iPod/.test(navigator.userAgent),j=/Android/.test(navigator.userAgent);let M="";R?M=`
        <strong>üì± Su iPhone/iPad:</strong><br>
        1. Tocca il pulsante "Condividi" (‚¨ÜÔ∏è)<br>
        2. Scorri e tocca "Aggiungi alla schermata Home"<br>
        3. Conferma il nome dell'app<br>
        4. L'icona apparir√† sulla home screen
      `:j?M=`
        <strong>üì± Su Android:</strong><br>
        1. Tocca i 3 puntini (‚ãÆ) in alto a destra<br>
        2. Seleziona "Aggiungi alla schermata Home"<br>
        3. Conferma il nome dell'app<br>
        4. L'icona apparir√† sulla home screen
      `:M=`
        <strong>üíª Su Desktop:</strong><br>
        1. Cerca l'icona "Installa" nella barra degli indirizzi<br>
        2. Clicca su "Installa"<br>
        3. L'app si aprir√† in una finestra dedicata
      `;const T=document.createElement("div");T.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    `,T.innerHTML=`
      <div style="background: white; border-radius: 16px; padding: 24px; max-width: 400px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 16px;">üì±</div>
        <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 16px; color: #1f2937;">Come Installare CrewApp</h3>
        <div style="color: #6b7280; margin-bottom: 20px; font-size: 14px; text-align: left; line-height: 1.6;">
          ${M}
        </div>
        <button id="close-manual" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%;">
          Ho Capito
        </button>
      </div>
    `,document.body.appendChild(T);const F=T.querySelector("#close-manual");F==null||F.addEventListener("click",()=>{T.remove()}),T.addEventListener("click",U=>{U.target===T&&T.remove()})},D=[{icon:ht,title:"Timesheet Digitale",description:"Registra le tue ore di lavoro con precisione GPS e approvazione automatica",color:"from-blue-500 to-cyan-500"},{icon:xt,title:"Calendario Aziendale",description:"Visualizza eventi, turni magazzino e gestisci le tue disponibilit√†",color:"from-purple-500 to-pink-500"},{icon:qt,title:"Documenti Digitali",description:"Accedi a buste paga, contratti e certificazioni in formato digitale",color:"from-green-500 to-emerald-500"}];return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-600 via-blue-700 to-blue-800 relative overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("div",{className:"absolute top-2 left-2 sm:top-4 sm:left-4 md:top-10 md:left-10 w-16 h-16 sm:w-24 sm:h-24 md:w-48 md:h-48 bg-white rounded-full opacity-5 animate-pulse"}),e.jsx("div",{className:"absolute bottom-2 right-2 sm:bottom-4 sm:right-4 md:bottom-10 md:right-10 w-12 h-12 sm:w-16 sm:h-16 md:w-32 md:h-32 bg-cyan-300 rounded-full opacity-10 animate-bounce",style:{animationDuration:"3s"}}),e.jsx("div",{className:"absolute top-1/3 left-1/4 w-8 h-8 sm:w-12 sm:h-12 md:w-24 md:h-24 bg-blue-300 rounded-full opacity-15 animate-ping",style:{animationDuration:"4s"}})]}),e.jsxs("div",{className:"relative z-10 flex-1 flex flex-col min-h-screen",children:[e.jsx("header",{className:"p-3 sm:p-4 md:p-6 lg:p-8 flex-shrink-0",children:e.jsxs("div",{className:`text-center transform transition-all duration-1000 ${l?"translate-y-0 opacity-100":"-translate-y-10 opacity-0"}`,children:[e.jsx("h1",{className:"text-lg sm:text-xl md:text-2xl lg:text-3xl xl:text-4xl font-bold text-white mb-1 sm:mb-2",children:"ControlStage"}),e.jsx("p",{className:"text-blue-100 text-xs sm:text-sm md:text-base lg:text-lg",children:"Professional Event Management Solutions"})]})}),e.jsx("main",{className:"flex-1 flex items-center justify-center px-3 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 md:py-8",children:e.jsxs("div",{className:"max-w-xs sm:max-w-md md:max-w-2xl lg:max-w-4xl xl:max-w-6xl mx-auto text-center w-full",children:[e.jsx("div",{className:`transform transition-all duration-1000 delay-300 ${l?"translate-y-0 opacity-100 scale-100":"translate-y-10 opacity-0 scale-95"}`,children:e.jsxs("div",{className:"bg-white bg-opacity-95 backdrop-blur-sm rounded-lg sm:rounded-xl md:rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 lg:p-10 mb-4 sm:mb-6 md:mb-8",children:[e.jsx("div",{className:"flex justify-center mb-3 sm:mb-4 md:mb-6 lg:mb-8",children:e.jsx("div",{className:"w-12 h-12 sm:w-16 sm:h-16 md:w-20 md:h-20 lg:w-24 lg:h-24 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg sm:rounded-xl md:rounded-2xl flex items-center justify-center shadow-lg",children:e.jsx(os,{className:"h-6 w-6 sm:h-8 sm:w-8 md:h-10 md:w-10 lg:h-12 lg:w-12 text-white"})})}),e.jsxs("h2",{className:"text-lg sm:text-xl md:text-2xl lg:text-3xl xl:text-4xl font-bold mb-2 sm:mb-3 md:mb-4",children:[e.jsx("span",{className:"text-gray-800",children:"CREW MOBILE "}),e.jsx("span",{className:"text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-600 italic font-extrabold tracking-wider transform -skew-x-12 inline-block text-lg sm:text-xl md:text-2xl lg:text-3xl xl:text-4xl",children:"APP"})]}),e.jsxs("p",{className:"text-gray-600 text-xs sm:text-sm md:text-base lg:text-lg leading-relaxed mb-3 sm:mb-4 md:mb-6 lg:mb-8 max-w-xs sm:max-w-md md:max-w-2xl lg:max-w-4xl mx-auto px-2 sm:px-4",children:["Piattaforma digitale per il personale operativo.",e.jsx("br",{}),"Gestisci autonomamente orari, eventi, ferie, note spese e check-in/out."]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-center space-y-1 sm:space-y-0 sm:space-x-3 md:space-x-4 mb-3 sm:mb-4 md:mb-6 lg:mb-8",children:[e.jsxs("span",{className:"bg-blue-600 text-white px-3 sm:px-4 md:px-5 py-1 sm:py-2 rounded-full font-semibold text-xs sm:text-sm md:text-base",children:["Versione ",v]}),e.jsx("span",{className:"text-gray-500 text-xs sm:text-sm md:text-base",children:g})]}),e.jsxs("button",{onClick:n,className:"group bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-2 sm:py-3 md:py-4 px-4 sm:px-6 md:px-8 lg:px-10 rounded-lg sm:rounded-xl md:rounded-2xl text-sm sm:text-base md:text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-2xl flex items-center justify-center space-x-2 mx-auto w-full sm:w-auto",children:[e.jsx("span",{children:"Accedi al Portale Staff"}),e.jsx(mo,{className:"h-4 w-4 sm:h-5 sm:w-5 md:h-6 md:w-6 group-hover:translate-x-1 transition-transform"})]}),x&&e.jsxs("button",{onClick:k,className:"group bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-2 sm:py-3 md:py-4 px-4 sm:px-6 md:px-8 lg:px-10 rounded-lg sm:rounded-xl md:rounded-2xl text-sm sm:text-base md:text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-2xl flex items-center justify-center space-x-2 mx-auto mt-3 sm:mt-4 w-full sm:w-auto",children:[e.jsx(cr,{className:"h-4 w-4 sm:h-5 sm:w-5 md:h-6 md:w-6"}),e.jsx("span",{children:"üì± Installa App sul Telefono"})]})]})}),e.jsxs("div",{className:`transform transition-all duration-1000 delay-500 ${l?"translate-y-0 opacity-100":"translate-y-10 opacity-0"}`,children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 sm:gap-4 md:gap-6 lg:gap-8",children:D.map((R,j)=>{const M=R.icon,T=j===u;return e.jsx("div",{className:`transform transition-all duration-700 w-full ${T?"scale-102 sm:scale-105 md:scale-110 -translate-y-1 sm:-translate-y-2 md:-translate-y-3":"scale-100 translate-y-0 opacity-90"}`,children:e.jsxs("div",{className:"bg-white bg-opacity-90 backdrop-blur-sm rounded-lg sm:rounded-xl md:rounded-2xl p-3 sm:p-4 md:p-6 lg:p-8 shadow-xl hover:shadow-2xl transition-all duration-300 h-full",children:[e.jsx("div",{className:`w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 lg:w-16 lg:h-16 bg-gradient-to-r ${R.color} rounded-md sm:rounded-lg md:rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 md:mb-4 lg:mb-6 shadow-lg`,children:e.jsx(M,{className:"h-4 w-4 sm:h-5 sm:w-5 md:h-6 md:w-6 lg:h-8 lg:w-8 text-white"})}),e.jsx("h3",{className:"text-sm sm:text-base md:text-lg lg:text-xl font-bold text-gray-800 mb-1 sm:mb-2 md:mb-3",children:R.title}),e.jsx("p",{className:"text-xs sm:text-sm md:text-base text-gray-600 leading-relaxed",children:R.description})]})},j)})}),e.jsx("div",{className:"flex justify-center space-x-2 mt-4 sm:mt-6 md:mt-8",children:D.map((R,j)=>e.jsx("button",{onClick:()=>f(j),className:`w-2 h-2 sm:w-3 sm:h-3 md:w-4 md:h-4 rounded-full transition-all duration-300 ${j===u?"bg-white scale-110 sm:scale-125 md:scale-150 shadow-lg":"bg-white bg-opacity-50 hover:bg-opacity-75"}`},j))})]})]})}),e.jsx("footer",{className:"p-3 sm:p-4 md:p-6 lg:p-8 flex-shrink-0 mt-auto",children:e.jsxs("div",{className:`text-center transform transition-all duration-1000 delay-700 ${l?"translate-y-0 opacity-100":"translate-y-5 opacity-0"}`,children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-center space-y-1 sm:space-y-0 sm:space-x-3 md:space-x-4 lg:space-x-6 text-blue-100 text-xs sm:text-sm mb-2 sm:mb-3 md:mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"}),e.jsx("span",{children:"Sistema Operativo"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(fo,{className:"h-3 w-3 sm:h-4 sm:w-4"}),e.jsx("span",{children:"Sicuro e Protetto"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(pt,{className:"h-3 w-3 sm:h-4 sm:w-4"}),e.jsx("span",{children:"Sempre Aggiornato"})]})]}),e.jsxs("p",{className:"text-blue-200 text-xs sm:text-sm px-2 sm:px-4 md:px-6",children:["¬© 2025 ControlStage - Crew App Mobile V. ",v," - ",g,". Tutti i diritti riservati."]})]})})]}),e.jsx("style",{children:`
        @keyframes float {
          0%, 100% { transform: translateY(0px); }
          50% { transform: translateY(-20px); }
        }

        .animate-float {
          animation: float 6s ease-in-out infinite;
        }

        @media (max-width: 640px) {
          .animate-blob {
            animation-duration: 10s;
          }
        }

        @media (min-width: 1024px) {
          .animate-float {
            animation-duration: 8s;
          }
        }
      `})]})},Zl=()=>{const{login:n}=Pt(),[l,c]=w.useState(""),[u,f]=w.useState(""),[x,b]=w.useState("company"),[v,S]=w.useState(!1),[g,E]=w.useState(!1),[p,k]=w.useState(""),P=async D=>{D.preventDefault(),E(!0),k("");try{await n(l,u,"crew")}catch(R){console.error("Login error:",R),k(R instanceof Error?R.message:"Errore durante il login")}finally{E(!1)}};return e.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"max-w-md w-full space-y-8",children:[e.jsxs("div",{children:[e.jsx(ti,{className:"mx-auto h-12 w-12 text-blue-600"}),e.jsx("h2",{className:"mt-6 text-3xl font-extrabold text-gray-900 text-center",children:"Accedi a CREW MOBILE APP"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600 text-center",children:"App Mobile per Dipendenti"})]}),e.jsxs("form",{className:"mt-8 space-y-6",onSubmit:P,children:[p&&e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center",children:[e.jsx(Zt,{className:"h-5 w-5 mr-2"}),e.jsx("p",{children:p})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700",children:"Email"}),e.jsx("input",{id:"email",name:"email",type:"email",autoComplete:"email",required:!0,value:l,onChange:D=>c(D.target.value),className:"mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm",placeholder:"Inserisci la tua email"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700",children:"Password"}),e.jsxs("div",{className:"mt-1 relative",children:[e.jsx("input",{id:"password",name:"password",type:v?"text":"password",autoComplete:"current-password",required:!0,value:u,onChange:D=>f(D.target.value),className:"appearance-none relative block w-full px-3 py-2 pr-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm",placeholder:x==="crew"?"Password temporanea o definitiva":"Password aziendale"}),e.jsx("button",{type:"button",onClick:()=>S(!v),className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:v?e.jsx(si,{className:"h-5 w-5 text-gray-400"}):e.jsx(en,{className:"h-5 w-5 text-gray-400"})})]})]})]}),e.jsx("div",{children:e.jsx("button",{type:"submit",disabled:g,className:"group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:g?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Accesso in corso..."]}):"üì± Accedi all'App Mobile"})}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-sm text-gray-600",children:["Non hai un account?"," ",e.jsx("span",{className:"font-medium text-gray-400 cursor-not-allowed",children:"Registrati qui (Non disponibile)"})]})})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[e.jsx(Ei,{to:"/azienda",className:"group relative w-full flex justify-center py-3 px-4 border-2 border-green-600 text-sm font-medium rounded-md text-green-600 bg-white hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors",children:e.jsxs("span",{className:"flex items-center",children:[e.jsx("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})}),"Accesso Azienda"]})}),e.jsx("p",{className:"mt-2 text-xs text-center text-gray-500",children:"Area riservata alle aziende per gestione turni e dipendenti"})]}),e.jsx("div",{className:"text-center pt-4 border-t border-gray-200",children:e.jsx("p",{className:"text-xs text-gray-500",children:"¬© 2025 ControlStage. Tutti i diritti riservati. Software V.1.0.9"})})]})})};let ca;const Ql=new Uint8Array(16);function Kl(){if(!ca&&(ca=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ca))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ca(Ql)}const is=[];for(let n=0;n<256;++n)is.push((n+256).toString(16).slice(1));function Jl(n,l=0){return is[n[l+0]]+is[n[l+1]]+is[n[l+2]]+is[n[l+3]]+"-"+is[n[l+4]]+is[n[l+5]]+"-"+is[n[l+6]]+is[n[l+7]]+"-"+is[n[l+8]]+is[n[l+9]]+"-"+is[n[l+10]]+is[n[l+11]]+is[n[l+12]]+is[n[l+13]]+is[n[l+14]]+is[n[l+15]]}const ec=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),On={randomUUID:ec};function Rn(n,l,c){if(On.randomUUID&&!l&&!n)return On.randomUUID();n=n||{};const u=n.random||(n.rng||Kl)();return u[6]=u[6]&15|64,u[8]=u[8]&63|128,Jl(u)}const tc=()=>{const[n,l]=w.useState("azienda"),[c,u]=w.useState(1),[f,x]=w.useState(!1),[b,v]=w.useState(!1),[S,g]=w.useState(null),[E,p]=w.useState({nome_azienda:"",email:"",telefono:"",partita_iva:"",indirizzo:"",persona_contatto:"",email_contatto:"",telefono_contatto:"",sito_web:"",piano:"base",messaggio:""}),[k,P]=w.useState({nome:"",cognome:"",email:"",telefono:"",indirizzo:"",tipo_profilo:"freelance",anni_esperienza:0,tariffa_oraria:"",competenze:[],biografia:"",messaggio:""}),D=["Audio","Luci","Video","Regia","Streaming","Montaggio","Allestimenti","Logistica","Coordinamento","Sicurezza","Elettricista","Carpentiere","Grafica","Fotografia"],R=N=>{const{name:_,value:V}=N.target;p(C=>({...C,[_]:V}))},j=N=>{const{name:_,value:V}=N.target;P(C=>({...C,[_]:V}))},M=N=>{P(_=>{const V=[..._.competenze];return V.includes(N)?{..._,competenze:V.filter(C=>C!==N)}:{..._,competenze:[...V,N]}})},T=()=>{if(n==="azienda"){if(!E.nome_azienda||!E.email||!E.partita_iva)return g("Compila tutti i campi obbligatori (Nome azienda, Email, Partita IVA)"),!1}else if(!k.nome||!k.cognome||!k.email)return g("Compila tutti i campi obbligatori (Nome, Cognome, Email)"),!1;return g(null),!0},F=()=>{T()&&u(2)},U=()=>{u(1)},te=async N=>{N.preventDefault(),x(!0),g(null);try{if(n==="azienda"){const{error:_}=await Se.from("registration_requests").insert({id:Rn(),company_name:E.nome_azienda,email:E.email,phone:E.telefono,plan_type:E.piano,message:E.messaggio,status:"pending"});if(_)throw _}else{const{error:_}=await Se.from("registration_requests").insert({id:Rn(),company_name:`${k.nome} ${k.cognome}`,email:k.email,phone:k.telefono,plan_type:"base",message:k.messaggio,status:"pending"});if(_)throw _}v(!0)}catch(_){console.error("Error during registration:",_),g("Si √® verificato un errore durante la registrazione. Riprova pi√π tardi.")}finally{x(!1)}};return b?e.jsx("div",{className:"bg-white p-8 rounded-lg shadow-md max-w-md mx-auto",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(pt,{className:"h-8 w-8 text-green-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Registrazione Inviata!"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"La tua richiesta di registrazione √® stata inviata con successo. Un amministratore la esaminer√† a breve. Riceverai un'email quando la tua richiesta sar√† stata approvata."}),e.jsx("button",{onClick:()=>window.location.href="/",className:"w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700",children:"Torna alla Home"})]})}):e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Registrazione"}),e.jsx("p",{className:"text-gray-600",children:"Crea un nuovo account per accedere alla piattaforma"})]}),S&&e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 flex items-center",children:[e.jsx(Zt,{className:"h-5 w-5 mr-2"}),e.jsx("p",{children:S})]}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("button",{type:"button",onClick:()=>l("azienda"),className:`flex-1 py-3 px-4 rounded-lg flex items-center justify-center space-x-2 ${n==="azienda"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(Rt,{className:"h-5 w-5"}),e.jsx("span",{children:"Azienda"})]}),e.jsxs("button",{type:"button",onClick:()=>l("tecnico"),className:`flex-1 py-3 px-4 rounded-lg flex items-center justify-center space-x-2 ${n==="tecnico"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(Xr,{className:"h-5 w-5"}),e.jsx("span",{children:"Tecnico"})]})]})}),e.jsxs("form",{onSubmit:te,children:[c===1&&e.jsxs("div",{className:"space-y-6",children:[n==="azienda"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"nome_azienda",className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome Azienda *"}),e.jsx("input",{id:"nome_azienda",name:"nome_azienda",type:"text",value:E.nome_azienda,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email *"}),e.jsx("input",{id:"email",name:"email",type:"email",value:E.email,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"telefono",className:"block text-sm font-medium text-gray-700 mb-1",children:"Telefono"}),e.jsx("input",{id:"telefono",name:"telefono",type:"tel",value:E.telefono,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"partita_iva",className:"block text-sm font-medium text-gray-700 mb-1",children:"Partita IVA *"}),e.jsx("input",{id:"partita_iva",name:"partita_iva",type:"text",value:E.partita_iva,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"indirizzo",className:"block text-sm font-medium text-gray-700 mb-1",children:"Indirizzo"}),e.jsx("input",{id:"indirizzo",name:"indirizzo",type:"text",value:E.indirizzo,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"nome",className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome *"}),e.jsx("input",{id:"nome",name:"nome",type:"text",value:k.nome,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"cognome",className:"block text-sm font-medium text-gray-700 mb-1",children:"Cognome *"}),e.jsx("input",{id:"cognome",name:"cognome",type:"text",value:k.cognome,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email *"}),e.jsx("input",{id:"email",name:"email",type:"email",value:k.email,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"telefono",className:"block text-sm font-medium text-gray-700 mb-1",children:"Telefono"}),e.jsx("input",{id:"telefono",name:"telefono",type:"tel",value:k.telefono,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"indirizzo",className:"block text-sm font-medium text-gray-700 mb-1",children:"Indirizzo"}),e.jsx("input",{id:"indirizzo",name:"indirizzo",type:"text",value:k.indirizzo,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tipo_profilo",className:"block text-sm font-medium text-gray-700 mb-1",children:"Tipo Profilo *"}),e.jsxs("select",{id:"tipo_profilo",name:"tipo_profilo",value:k.tipo_profilo,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"freelance",children:"Freelance"}),e.jsx("option",{value:"dipendente",children:"Dipendente"})]})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"button",onClick:F,className:"bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700",children:"Avanti"})})]}),c===2&&e.jsxs("div",{className:"space-y-6",children:[n==="azienda"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"persona_contatto",className:"block text-sm font-medium text-gray-700 mb-1",children:"Persona di Contatto"}),e.jsx("input",{id:"persona_contatto",name:"persona_contatto",type:"text",value:E.persona_contatto,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email_contatto",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email di Contatto"}),e.jsx("input",{id:"email_contatto",name:"email_contatto",type:"email",value:E.email_contatto,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"telefono_contatto",className:"block text-sm font-medium text-gray-700 mb-1",children:"Telefono di Contatto"}),e.jsx("input",{id:"telefono_contatto",name:"telefono_contatto",type:"tel",value:E.telefono_contatto,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"sito_web",className:"block text-sm font-medium text-gray-700 mb-1",children:"Sito Web"}),e.jsx("input",{id:"sito_web",name:"sito_web",type:"url",value:E.sito_web,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"https://www.example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"piano",className:"block text-sm font-medium text-gray-700 mb-1",children:"Piano"}),e.jsxs("select",{id:"piano",name:"piano",value:E.piano,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"base",children:"Base"}),e.jsx("option",{value:"professional",children:"Professional"}),e.jsx("option",{value:"enterprise",children:"Enterprise"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"messaggio",className:"block text-sm font-medium text-gray-700 mb-1",children:"Messaggio (opzionale)"}),e.jsx("textarea",{id:"messaggio",name:"messaggio",value:E.messaggio,onChange:R,rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"Informazioni aggiuntive o richieste particolari..."})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"anni_esperienza",className:"block text-sm font-medium text-gray-700 mb-1",children:"Anni di Esperienza"}),e.jsx("input",{id:"anni_esperienza",name:"anni_esperienza",type:"number",min:"0",value:k.anni_esperienza,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tariffa_oraria",className:"block text-sm font-medium text-gray-700 mb-1",children:"Tariffa Oraria (‚Ç¨)"}),e.jsx("input",{id:"tariffa_oraria",name:"tariffa_oraria",type:"number",min:"0",step:"0.01",value:k.tariffa_oraria,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Competenze"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:D.map(N=>e.jsx("button",{type:"button",onClick:()=>M(N),className:`px-3 py-1 rounded-full text-sm ${k.competenze.includes(N)?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:N},N))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"biografia",className:"block text-sm font-medium text-gray-700 mb-1",children:"Biografia"}),e.jsx("textarea",{id:"biografia",name:"biografia",value:k.biografia,onChange:j,rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"Breve descrizione della tua esperienza e specializzazioni..."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"messaggio",className:"block text-sm font-medium text-gray-700 mb-1",children:"Messaggio (opzionale)"}),e.jsx("textarea",{id:"messaggio",name:"messaggio",value:k.messaggio,onChange:j,rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"Informazioni aggiuntive o richieste particolari..."})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("button",{type:"button",onClick:U,className:"bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400",children:"Indietro"}),e.jsx("button",{type:"submit",disabled:f,className:"bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:bg-blue-400",children:f?"Invio in corso...":"Invia Richiesta"})]})]})]}),e.jsxs("div",{className:"mt-8 pt-6 border-t border-gray-200 text-center",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Hai gi√† un account?"," ",e.jsx("a",{href:"/",className:"text-blue-600 hover:text-blue-800",children:"Accedi"})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"¬© 2025 ControlStage - Crew App Mobile V. 1.0.1"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Tutti i diritti riservati - Software realizzato da ControlStage"})]})]})]})},sc=({isOpen:n,onClose:l})=>{const{updatePassword:c}=Pt(),{showSuccess:u,showError:f}=ms(),[x,b]=w.useState(""),[v,S]=w.useState(""),[g,E]=w.useState(!1),[p,k]=w.useState(!1),[P,D]=w.useState(""),R=async j=>{if(j.preventDefault(),D(""),x.length<6){D("La password deve essere di almeno 6 caratteri");return}if(x!==v){D("Le password non coincidono");return}k(!0),await c(x)?(u("Password Aggiornata","La tua password √® stata modificata con successo!"),l()):(f("Errore","Si √® verificato un errore durante l'aggiornamento della password"),D("Errore nell'aggiornamento della password")),k(!1)};return n?e.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50",children:e.jsx("div",{className:"relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white",children:e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center space-x-2",children:[e.jsx(ri,{className:"h-5 w-5"}),e.jsx("span",{children:"Cambia Password"})]}),e.jsx("button",{onClick:l,className:"text-gray-400 hover:text-gray-600",children:e.jsx(Et,{className:"h-6 w-6"})})]}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4",children:e.jsxs("p",{className:"text-sm text-yellow-800",children:[e.jsx("strong",{children:"Primo accesso rilevato!"}),e.jsx("br",{}),"Per motivi di sicurezza, devi cambiare la password temporanea."]})}),e.jsxs("form",{onSubmit:R,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nuova Password"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:g?"text":"password",value:x,onChange:j=>b(j.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 pr-10",placeholder:"Inserisci la nuova password",required:!0,minLength:6}),e.jsx("button",{type:"button",onClick:()=>E(!g),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500",children:g?e.jsx(si,{className:"h-4 w-4"}):e.jsx(en,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Conferma Password"}),e.jsx("input",{type:g?"text":"password",value:v,onChange:j=>S(j.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"Conferma la nuova password",required:!0,minLength:6})]}),P&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg text-sm",children:P}),e.jsx("div",{className:"flex justify-end space-x-2 mt-6",children:e.jsxs("button",{type:"submit",disabled:p,className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center space-x-2",children:[p?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsx(Gr,{className:"h-4 w-4"}),e.jsx("span",{children:p?"Salvando...":"Salva Password"})]})})]})]})})}):null},Sa=()=>{const[n,l]=w.useState(navigator.onLine),[c,u]=w.useState([]),[f,x]=w.useState(!1);w.useEffect(()=>{const k=()=>{l(!0),g()},P=()=>{l(!1)};return window.addEventListener("online",k),window.addEventListener("offline",P),b(),()=>{window.removeEventListener("online",k),window.removeEventListener("offline",P)}},[]);const b=()=>{try{const k=localStorage.getItem("crew_app_offline_data");if(k){const P=JSON.parse(k);u(P)}}catch(k){console.error("Errore nel caricamento dati offline:",k)}},v=k=>{try{localStorage.setItem("crew_app_offline_data",JSON.stringify(k)),u(k)}catch(P){console.error("Errore nel salvataggio dati offline:",P)}},S=w.useCallback((k,P)=>{const D={id:Date.now().toString(),type:k,data:P,timestamp:new Date().toISOString()},R=[...c,D];v(R),n&&g()},[c,n]),g=async()=>{if(c.length===0||f)return;x(!0);const k=[];try{for(const D of c)try{await E(D),k.push(D.id)}catch(R){console.error(`Errore sync item ${D.id}:`,R)}const P=c.filter(D=>!k.includes(D.id));v(P),k.length>0&&console.log(`‚úÖ Sincronizzati ${k.length} elementi offline`)}catch(P){console.error("Errore nella sincronizzazione:",P)}finally{x(!1)}},E=async k=>{switch(k.type){case"checkin":await Se.from("warehouse_checkins").insert(k.data);break;case"checkout":await Se.from("warehouse_checkins").update(k.data.updates).eq("id",k.data.id);break;case"expense":await Se.from("expenses").insert(k.data);break;case"timesheet":k.data.id?await Se.from("timesheet_entries").update(k.data.updates).eq("id",k.data.id):await Se.from("timesheet_entries").insert(k.data);break}},p=()=>{localStorage.removeItem("crew_app_offline_data"),u([])};return{isOnline:n,pendingSync:c.length,isSyncing:f,addOfflineData:S,syncPendingData:g,clearPendingData:p}},rc=({currentVersion:n,hasUpdate:l,isLoading:c,isUpdating:u,onCheckUpdate:f})=>{const x=()=>u?e.jsx(Ms,{className:"h-4 w-4 animate-spin text-blue-500"}):c?e.jsx(Ms,{className:"h-4 w-4 animate-spin text-gray-500"}):l?e.jsx(cr,{className:"h-4 w-4 text-orange-500"}):e.jsx(pt,{className:"h-4 w-4 text-green-500"}),b=()=>u?"Aggiornamento...":c?"Controllo...":l?"Aggiornamento disponibile":"Aggiornato",v=()=>u?"text-blue-600":c?"text-gray-500":l?"text-orange-600":"text-green-600",S=`Versione ${n||"Sconosciuta"} - ${b()}`;return e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:f,disabled:c||u,className:`sm:hidden inline-flex items-center space-x-1 px-2 py-1 rounded-md transition-colors text-xs
          ${l?"bg-orange-100 hover:bg-orange-200 text-orange-800":"bg-gray-100 hover:bg-gray-200 text-gray-700"}
          disabled:opacity-50 disabled:cursor-not-allowed`,title:S,"aria-label":S,type:"button",children:[x(),e.jsxs("span",{className:"font-medium text-[11px]",children:["v",n||"?"]})]}),e.jsxs("button",{onClick:f,disabled:c||u,className:`hidden sm:flex items-center space-x-1.5 px-2 py-1 rounded-md transition-colors ${l?"bg-orange-100 hover:bg-orange-200 text-orange-800":"bg-gray-100 hover:bg-gray-200 text-gray-700"} disabled:opacity-50 disabled:cursor-not-allowed`,title:S,type:"button",children:[e.jsx("div",{className:"scale-75",children:x()}),e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"text-[10px] font-medium leading-tight",children:["v",n||"?"]}),e.jsx("div",{className:`text-[9px] leading-tight ${v()}`,children:b()})]})]})]})};function Ti({openTalkId:n,onClose:l}){const{user:c}=Pt(),{showToast:u}=Ai(),[f,x]=w.useState([]),[b,v]=w.useState(!0),[S,g]=w.useState(null),[E,p]=w.useState(!1),k=w.useRef(null);w.useEffect(()=>{c&&(D(),R())},[c,E]),w.useEffect(()=>{if(n&&f.length>0){const C=f.find(K=>K.id===n);C&&N(C)}},[n,f]);const P=async C=>{if(!C)return null;try{const O=new URL(C).pathname.match(/\/storage\/v1\/object\/public\/company-talks\/(.+)$/);if(!O||!O[1])return console.error("Impossibile estrarre il percorso dal file URL:",C),C;const X=O[1],{data:se,error:W}=await Se.storage.from("company-talks").createSignedUrl(X,3600);return W?(console.error("Errore creazione signed URL:",W),C):se.signedUrl}catch(K){return console.error("Errore nel parsing dell'URL:",K),C}},D=async()=>{try{v(!0);let C=Se.from("company_talks").select(`
          *,
          regaziendasoftware!sender_company_id (
            ragione_sociale
          )
        `).eq("recipient_id",c==null?void 0:c.id).order("created_at",{ascending:!1});E&&(C=C.eq("is_read",!1));const{data:K,error:O}=await C;if(O)throw O;const X=await Promise.all((K||[]).map(async se=>{var G;const W=await P(se.file_url);return{...se,company_name:((G=se.regaziendasoftware)==null?void 0:G.ragione_sociale)||"Azienda",file_url:W}}));x(X)}catch(C){console.error("Errore caricamento messaggi:",C),u("Errore nel caricamento dei messaggi","error")}finally{v(!1)}},R=()=>{const C=Se.channel("company_talks_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"company_talks",filter:`recipient_id=eq.${c==null?void 0:c.id}`},K=>{D(),u("Nuovo messaggio ricevuto!","success")}).subscribe();return()=>{Se.removeChannel(C)}},j=async C=>{try{const{error:K}=await Se.rpc("mark_talk_as_read",{talk_id:C});if(K)throw K;x(O=>O.map(X=>X.id===C?{...X,is_read:!0,read_at:new Date().toISOString()}:X))}catch(K){console.error("Errore aggiornamento messaggio:",K)}},M=async C=>{if(confirm("Eliminare questo messaggio?"))try{const{error:K}=await Se.from("company_talks").delete().eq("id",C).eq("recipient_id",c==null?void 0:c.id);if(K)throw K;x(O=>O.filter(X=>X.id!==C)),g(null),u("Messaggio eliminato","success")}catch(K){console.error("Errore eliminazione messaggio:",K),u("Errore durante l'eliminazione","error")}},T=async(C,K)=>{try{const{data:O,error:X}=await Se.storage.from("company-talks").download(C.split("/").pop()||"");if(X)throw X;const se=URL.createObjectURL(O),W=document.createElement("a");W.href=se,W.download=K,document.body.appendChild(W),W.click(),document.body.removeChild(W),URL.revokeObjectURL(se),u("File scaricato","success")}catch(O){console.error("Errore download file:",O),u("Errore durante il download","error")}},F=C=>{switch(C){case"text":return e.jsx(nr,{className:"w-5 h-5"});case"audio":return e.jsx(Cr,{className:"w-5 h-5"});case"image":return e.jsx(Hr,{className:"w-5 h-5"});case"file":return e.jsx(qt,{className:"w-5 h-5"});default:return e.jsx(nr,{className:"w-5 h-5"})}},U=C=>C?C<1024?`${C} B`:C<1048576?`${(C/1024).toFixed(1)} KB`:`${(C/1048576).toFixed(1)} MB`:"",te=C=>{const K=new Date(C),O=new Date,X=O.getTime()-K.getTime(),se=Math.floor(X/6e4),W=Math.floor(X/36e5),G=Math.floor(X/864e5);return se<1?"Ora":se<60?`${se}m fa`:W<24?`${W}h fa`:G<7?`${G}g fa`:K.toLocaleDateString("it-IT",{day:"numeric",month:"short",year:K.getFullYear()!==O.getFullYear()?"numeric":void 0})},N=C=>{g(C),C.is_read||j(C.id)},_=C=>{switch(C.message_type){case"text":return e.jsx("p",{className:"text-sm text-gray-300 line-clamp-2",children:C.message_text});case"audio":return e.jsxs("p",{className:"text-sm text-gray-400 flex items-center gap-2",children:[e.jsx(Cr,{className:"w-4 h-4"}),"Messaggio vocale"]});case"image":return e.jsxs("p",{className:"text-sm text-gray-400 flex items-center gap-2",children:[e.jsx(Hr,{className:"w-4 h-4"}),"Immagine"]});case"file":return e.jsxs("p",{className:"text-sm text-gray-400 flex items-center gap-2",children:[e.jsx(qt,{className:"w-4 h-4"}),C.file_name]});default:return null}},V=C=>{switch(C.message_type){case"text":return e.jsx("div",{className:"prose prose-sm max-w-none",children:e.jsx("p",{className:"text-gray-200 whitespace-pre-wrap",children:C.message_text})});case"audio":return e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(go,{className:"w-6 h-6 text-blue-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-white",children:"Messaggio vocale"}),C.file_size&&e.jsx("p",{className:"text-sm text-gray-400",children:U(C.file_size)})]})]}),C.file_url&&e.jsx("audio",{ref:k,controls:!0,preload:"metadata",className:"w-full",src:C.file_url})]});case"image":return e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[C.file_url&&e.jsx("img",{src:C.file_url,alt:C.file_name||"Immagine",className:"w-full rounded-lg"}),C.file_name&&e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:C.file_name})]});case"file":return e.jsx("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(qt,{className:"w-8 h-8 text-gray-300"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-white",children:C.file_name}),C.file_size&&e.jsx("p",{className:"text-sm text-gray-400",children:U(C.file_size)})]})]}),C.file_url&&e.jsx("button",{onClick:()=>T(C.file_url,C.file_name),className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(cr,{className:"w-5 h-5 text-blue-400"})})]})});default:return null}};return b?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"min-h-screen bg-gray-900 flex flex-col",children:[e.jsxs("div",{className:"bg-gray-800 border-b border-gray-700 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Messaggi Azienda"}),l&&e.jsx("button",{onClick:l,className:"p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(Et,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:()=>p(!E),className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${E?"bg-blue-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"}`,children:E?"Tutti":"Non letti"})})]}),f.filter(C=>!C.is_read).length>0&&e.jsx("div",{className:"bg-blue-900/30 border border-blue-700 rounded-lg p-3",children:e.jsxs("p",{className:"text-sm text-blue-200",children:[f.filter(C=>!C.is_read).length," messaggi non letti"]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:f.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx(nr,{className:"w-16 h-16 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Nessun messaggio"}),e.jsx("p",{className:"text-sm",children:"I messaggi dall'azienda appariranno qui"})]}):e.jsx("div",{className:"divide-y divide-gray-700",children:f.map(C=>e.jsx("div",{onClick:()=>N(C),className:`p-4 cursor-pointer transition-colors ${C.is_read?"hover:bg-gray-800":"bg-blue-900/20 hover:bg-blue-900/30"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${C.is_urgent?"bg-red-900/30 text-red-400":"bg-gray-700 text-gray-300"}`,children:F(C.message_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1",children:[e.jsx("p",{className:"font-semibold text-white",children:C.company_name||C.sender_name}),C.is_urgent&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-red-400 font-medium",children:[e.jsx(Nt,{className:"w-3 h-3"}),"Urgente"]})]}),_(C),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx("p",{className:"text-xs text-gray-400",children:te(C.created_at)}),C.is_read&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-green-400",children:[e.jsx(pt,{className:"w-3 h-3"}),"Letto"]})]})]})]})},C.id))})}),S&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-gray-700",children:[e.jsxs("div",{className:"sticky top-0 bg-gray-800 border-b border-gray-700 p-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:S.company_name||S.sender_name}),e.jsx("p",{className:"text-sm text-gray-400",children:te(S.created_at)})]}),e.jsx("button",{onClick:()=>g(null),className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(Et,{className:"w-5 h-5 text-gray-300"})})]}),e.jsxs("div",{className:"p-4",children:[S.is_urgent&&e.jsxs("div",{className:"bg-red-900/30 border border-red-700 rounded-lg p-3 mb-4 flex items-center gap-2",children:[e.jsx(Nt,{className:"w-5 h-5 text-red-400"}),e.jsx("p",{className:"text-sm text-red-300 font-medium",children:"Messaggio urgente"})]}),V(S),S.expires_at&&e.jsx("div",{className:"mt-4 p-3 bg-amber-900/30 border border-amber-700 rounded-lg",children:e.jsxs("p",{className:"text-sm text-amber-300",children:["Questo messaggio verr√† eliminato automaticamente il"," ",new Date(S.expires_at).toLocaleDateString("it-IT")]})})]}),e.jsxs("div",{className:"sticky bottom-0 bg-gray-800 border-t border-gray-700 p-4 flex gap-2",children:[e.jsxs("button",{onClick:()=>M(S.id),className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center gap-2",children:[e.jsx(Xs,{className:"w-4 h-4"}),"Elimina"]}),e.jsx("button",{onClick:()=>g(null),className:"flex-1 px-4 py-2 bg-gray-700 text-gray-200 rounded-lg hover:bg-gray-600 transition-colors",children:"Chiudi"})]})]})})]})}const ac=({userId:n,onClose:l,onOpenCompanyTalk:c})=>{var V,C,K,O,X,se,W,G;const[u,f]=kt.useState([]),[x,b]=kt.useState(!0),[v,S]=kt.useState([]),[g,E]=kt.useState(!0),[p,k]=kt.useState([]),[P,D]=kt.useState(!0),{showSuccess:R,showError:j}=ms(),[M,T]=kt.useState(null),[F,U]=kt.useState(!1);kt.useEffect(()=>{n&&(async()=>{b(!0);try{const{data:ne,error:ye}=await Se.from("notifiche").select("*").eq("id_utente",n).neq("stato","eliminata").order("created_at",{ascending:!1}).limit(10);!ye&&ne?f(ne):ye&&console.error("Errore caricamento notifiche:",ye)}catch(ne){console.error("Eccezione loadNotifications:",ne)}finally{b(!1)}})()},[n]),kt.useEffect(()=>{n&&(async()=>{D(!0);try{const{data:ne,error:ye}=await Se.from("company_talks").select(`
            *,
            regaziendasoftware!sender_company_id (
              ragione_sociale
            )
          `).eq("recipient_id",n).eq("is_read",!1).order("created_at",{ascending:!1}).limit(10);if(!ye&&ne){const me=ne.map(Q=>{var fe;return{...Q,company_name:((fe=Q.regaziendasoftware)==null?void 0:fe.ragione_sociale)||"Azienda"}});k(me)}else ye&&console.error("Errore caricamento messaggi azienda:",ye)}catch(ne){console.error("Eccezione loadCompanyTalks:",ne)}finally{D(!1)}})()},[n]);const te=kt.useCallback(async()=>{E(!0);try{const{data:B,error:ne}=await Se.from("crew_assegnazionecorsi").select(`
          *,
          corso:corso_id(
            id,
            titolo,
            titolo_corso,
            descrizione,
            note,
            luogo,
            ora_inizio,
            ora_fine,
            istruttore,
            istruttore_nome,
            categoria,
            obbligatorio
          )
        `).eq("persona_id",n).eq("stato_invito","invitato").order("data_invito",{ascending:!1});if(!ne&&B&&B.length>0){const Z=B.map(L=>{const re=L.corso||{},de=L.titolo_corso||L.corso_titolo||re.titolo||re.titolo_corso||re.nome||`Corso ${L.corso_id||L.id||""}`;return{...L,course:re,courseTitle:de}});S(Z),E(!1);return}const{data:ye,error:me}=await Se.from("crew_assegnazionecorsi").select("*").eq("persona_id",n).eq("stato_invito","invitato").order("data_invito",{ascending:!1});if(me){console.error("Errore fetch assignments fallback:",me),S([]),E(!1);return}if(!ye||ye.length===0){S([]),E(!1);return}const Q=Array.from(new Set(ye.map(Z=>Z.corso_id).filter(Boolean)));let fe={};if(Q.length>0){const{data:Z,error:L}=await Se.from("corsi").select("id, titolo, titolo_corso, descrizione, note, luogo, ora_inizio, ora_fine, istruttore, istruttore_nome, categoria, obbligatorio").in("id",Q);L?(console.error("Errore fetch corsi fallback:",L),fe={}):fe=(Z||[]).reduce((re,de)=>(re[de.id]=de,re),{})}const be=ye.map(Z=>{const L=Z.corso||(Z.corso_id?fe[Z.corso_id]:null)||{},re=Z.titolo_corso||Z.corso_titolo||L.titolo||L.titolo_corso||L.nome||`Corso ${Z.corso_id||Z.id||""}`;return{...Z,course:L,courseTitle:re}});S(be)}catch(B){console.error("Eccezione loadPendingCourses (robust):",B),S([])}finally{E(!1)}},[n]);kt.useEffect(()=>{if(!n){S([]),E(!1);return}te();const B=Se.channel(`course-notifs-${n}`).on("postgres_changes",{event:"*",schema:"public",table:"crew_assegnazionecorsi",filter:`persona_id=eq.${n}`},()=>{te()}).subscribe();return()=>{Se.removeChannel(B)}},[n,te]);const N=B=>{if(!B)return"";try{return new Date(B).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}catch{return B}},_=B=>{if(!B)return"";try{return new Date(B).toLocaleDateString("it-IT")}catch{return B}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-40 sm:hidden",onClick:l}),e.jsxs("div",{className:"fixed top-20 left-2 right-2 sm:absolute sm:top-full sm:right-0 sm:left-auto sm:mt-2 sm:w-96 bg-gray-800 rounded-lg shadow-2xl border border-gray-700 z-50",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Notifiche"}),e.jsx("button",{onClick:l,className:"text-gray-400 hover:text-white p-1",children:e.jsx(Et,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"max-h-[60vh] overflow-y-auto",children:[P?e.jsx("div",{className:"p-8 text-center text-gray-400",children:"Caricamento messaggi..."}):p&&p.length>0?e.jsxs("div",{className:"divide-y divide-gray-700",children:[e.jsxs("div",{className:"px-4 py-2 bg-cyan-900/20 border-b border-gray-700 flex items-center justify-between",children:[e.jsxs("h4",{className:"text-sm font-medium text-cyan-300",children:["Messaggi Azienda (",p.length,")"]}),e.jsx("button",{onClick:B=>{B.stopPropagation(),l(),setTimeout(()=>{setShowCompanyTalk(!0),setSelectedTalkId(null)},100)},className:"text-xs text-cyan-400 hover:text-cyan-300 font-medium underline",children:"Vedi tutti"})]}),p.map(B=>e.jsx("div",{className:"p-4 hover:bg-gray-750 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-semibold text-white",children:B.company_name||B.sender_name}),B.is_urgent&&e.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-red-600 text-white rounded",children:"Urgente"})]}),B.message_type==="text"&&B.message_text&&e.jsx("p",{className:"text-sm text-gray-300 line-clamp-2 mt-1",children:B.message_text}),B.message_type==="audio"&&e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"üé§ Messaggio vocale"}),B.message_type==="image"&&e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"üñºÔ∏è Immagine"}),B.message_type==="file"&&e.jsxs("p",{className:"text-sm text-gray-400 mt-1",children:["üìÑ ",B.file_name||"File allegato"]}),e.jsxs("div",{className:"flex items-center space-x-2 mt-2 text-xs text-gray-400",children:[e.jsx(ht,{className:"h-3 w-3"}),e.jsx("span",{children:new Date(B.created_at).toLocaleString("it-IT")})]})]}),e.jsx("div",{className:"ml-2 flex flex-col items-end space-y-2",children:e.jsx("button",{onClick:ne=>{ne.stopPropagation(),l(),setTimeout(()=>{c(B.id)},100)},className:"bg-cyan-600 text-white px-3 py-1 rounded text-xs hover:bg-cyan-700",children:"Leggi"})})]})},B.id))]}):null,g?e.jsx("div",{className:"p-8 text-center text-gray-400",children:"Caricamento corsi..."}):v&&v.length>0?e.jsxs("div",{className:"divide-y divide-gray-700",children:[e.jsx("div",{className:"px-4 py-2 bg-yellow-900/20 border-b border-gray-700",children:e.jsxs("h4",{className:"text-sm font-medium text-yellow-300",children:["Corsi da confermare (",v.length,")"]})}),v.map(B=>{const ne=B.course||{},ye=B.courseTitle||ne.titolo||ne.titolo_corso||"Corso",me=B.data_partecipazione||B.data_invito||ne.data||"",Q=B.ora_inizio||ne.ora_inizio||"",fe=B.luogo||ne.luogo||"";return e.jsx("div",{className:"p-4 hover:bg-gray-750 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-white",children:ye}),me&&e.jsx("p",{className:"text-sm text-gray-300 mt-1",children:_(me)}),Q&&e.jsxs("div",{className:"flex items-center space-x-2 mt-2 text-xs text-gray-400",children:[e.jsx(ht,{className:"h-3 w-3"}),e.jsx("span",{children:Q})]}),fe&&e.jsxs("div",{className:"flex items-center space-x-2 mt-1 text-xs text-gray-400",children:[e.jsx(Ut,{className:"h-3 w-3"}),e.jsx("span",{children:fe})]})]}),e.jsx("div",{className:"ml-2 flex flex-col items-end space-y-2",children:e.jsx("button",{onClick:()=>T(B),className:"bg-cyan-600 text-white px-3 py-1 rounded text-xs hover:bg-cyan-700",children:"Dettaglio"})})]})},B.id)})]}):null,!P&&p.length===0&&e.jsx("div",{className:"px-4 py-3 bg-cyan-900/20 border-b border-gray-700",children:e.jsxs("button",{onClick:B=>{B.stopPropagation(),l(),setTimeout(()=>{c(null)},100)},className:"w-full text-sm text-cyan-400 hover:text-cyan-300 font-medium flex items-center justify-center gap-2",children:[e.jsx(nr,{className:"w-4 h-4"}),"Vedi Messaggi Azienda"]})}),(u.length>0||v&&v.length>0||p&&p.length>0)&&e.jsx("div",{className:"px-4 py-2 border-b border-gray-700",children:e.jsx("h4",{className:"text-xs font-medium text-gray-400 uppercase",children:"Altre notifiche"})}),x?e.jsx("div",{className:"p-8 text-center text-gray-400",children:"Caricamento..."}):u.length===0?v&&v.length>0||p&&p.length>0?null:e.jsx("div",{className:"p-8 text-center text-gray-400",children:"Nessuna notifica"}):e.jsx("div",{className:"divide-y divide-gray-700",children:u.map(B=>{const ne=Q=>{const fe=new Date(Q),Z=new Date().getTime()-fe.getTime(),L=Math.floor(Z/6e4),re=Math.floor(L/60),de=Math.floor(re/24);return L<1?"Ora":L<60?`${L} min fa`:re<24?`${re}h fa`:de<7?`${de}g fa`:fe.toLocaleDateString("it-IT")},ye=async Q=>{try{await Se.rpc("mark_notification_read",{p_notifica_id:Q,p_user_id:n}),f(fe=>fe.map(be=>be.id===Q?{...be,stato:"letta"}:be))}catch(fe){console.error("Errore markAsRead:",fe),j&&j("Errore durante l'operazione")}},me=async Q=>{try{await Se.rpc("delete_notification",{p_notifica_id:Q,p_user_id:n}),f(fe=>fe.filter(be=>be.id!==Q))}catch(fe){console.error("Errore deleteNotification:",fe),j&&j("Errore durante l'eliminazione")}};return e.jsxs("div",{className:`p-4 hover:bg-gray-750 transition-colors ${B.stato==="non_letta"?"bg-gray-750":""}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:`font-semibold ${B.stato==="non_letta"?"text-cyan-400":"text-white"}`,children:B.titolo}),e.jsx("p",{className:"text-sm text-gray-300 mt-1",children:B.messaggio}),e.jsxs("div",{className:"flex items-center space-x-2 mt-2 text-xs text-gray-400",children:[e.jsx(ht,{className:"h-3 w-3"}),e.jsx("span",{children:ne(B.created_at)})]})]}),e.jsx("button",{onClick:()=>me(B.id),className:"text-gray-500 hover:text-red-400 ml-2",children:e.jsx(Et,{className:"h-4 w-4"})})]}),B.stato==="non_letta"&&e.jsx("button",{onClick:()=>ye(B.id),className:"mt-2 text-xs text-cyan-400 hover:text-cyan-300",children:"Segna come letta"})]},B.id)})})]}),M&&e.jsx("div",{className:"fixed inset-0 z-[10000] flex items-center justify-center bg-black/50 p-4",children:e.jsxs("div",{className:"w-full max-w-2xl bg-gray-900 rounded-lg shadow-lg border border-gray-700 overflow-auto max-h-[90vh]",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400",children:N(M.data_partecipazione||M.data_invito)}),e.jsx("h3",{className:"text-lg font-semibold text-white",children:M.courseTitle||((V=M.course)==null?void 0:V.titolo)||"Corso"})]}),e.jsx("button",{onClick:()=>T(null),className:"text-gray-400 hover:text-white p-1",children:e.jsx(Et,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"p-4 space-y-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 text-xs",children:"Titolo"}),e.jsx("div",{className:"text-white font-medium",children:M.courseTitle||((C=M.course)==null?void 0:C.titolo)||"‚Äî"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 text-xs",children:"Descrizione"}),e.jsx("div",{className:"text-gray-300",children:((K=M.course)==null?void 0:K.descrizione)||M.note||"‚Äî"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 text-xs",children:"Inizio"}),e.jsx("div",{className:"text-white",children:M.ora_inizio||((O=M.course)==null?void 0:O.ora_inizio)||"‚Äî"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 text-xs",children:"Fine"}),e.jsx("div",{className:"text-white",children:M.ora_fine||((X=M.course)==null?void 0:X.ora_fine)||"‚Äî"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 text-xs",children:"Luogo"}),e.jsx("div",{className:"text-white",children:M.luogo||((se=M.course)==null?void 0:se.luogo)||"‚Äî"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 text-xs",children:"Istruttore"}),e.jsx("div",{className:"text-white",children:((W=M.course)==null?void 0:W.istruttore_nome)||((G=M.course)==null?void 0:G.istruttore)||"‚Äî"})]})]})]}),e.jsx("div",{className:"flex items-center justify-end gap-2 p-4 border-t border-gray-700",children:M.stato_invito==="confermato"?e.jsx("button",{disabled:!0,className:"bg-green-700 text-white px-3 py-1 rounded text-sm opacity-80",children:"Partecipazione confermata"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:async()=>{U(!0);try{const{error:B}=await Se.from("crew_assegnazionecorsi").update({stato_invito:"confermato",data_conferma:new Date().toISOString()}).eq("id",M.id);if(B){console.error("Errore conferma dal modal:",B),j&&j("Errore durante la conferma: "+(B.message||"Riprova")),U(!1);return}R&&R("Partecipazione confermata"),T(null),await te()}catch(B){console.error("Eccezione conferma dal modal:",B),j&&j((B==null?void 0:B.message)||"Errore durante la conferma")}finally{U(!1)}},disabled:F,className:"bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 disabled:opacity-60",children:F?"Confermo...":"Conferma partecipazione"}),e.jsx("button",{onClick:async()=>{U(!0);try{const{error:B}=await Se.from("crew_assegnazionecorsi").update({stato_invito:"rifiutato"}).eq("id",M.id);if(B){console.error("Errore annulla dal modal:",B),j&&j("Errore durante l'annullamento: "+(B.message||"Riprova")),U(!1);return}R&&R("Partecipazione annullata"),T(null),await te()}catch(B){console.error("Eccezione annulla dal modal:",B),j&&j((B==null?void 0:B.message)||"Errore durante l'operazione")}finally{U(!1)}},disabled:F,className:"bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 disabled:opacity-60",children:"Annulla Partecipazione"})]})})]})})]})]})},nc=({currentVersion:n,hasUpdate:l,isVersionLoading:c,isUpdating:u,onCheckUpdate:f})=>{const{user:x,logout:b}=Pt(),{isOnline:v,pendingSync:S,isSyncing:g,syncPendingData:E}=Sa(),{showSuccess:p,showError:k,showWarning:P}=ms(),[D,R]=kt.useState(navigator.onLine),[j,M]=kt.useState(null),[T,F]=kt.useState(!1),[U,te]=kt.useState(0),[N,_]=kt.useState(!1),[V,C]=kt.useState(!1),[K,O]=kt.useState(null);kt.useEffect(()=>{const se=()=>R(!0),W=()=>R(!1);window.addEventListener("online",se),window.addEventListener("offline",W);const G=()=>{window.deferredPrompt&&F(!0)};G();const B=setInterval(G,2e3),ne=()=>{F(!0)};return window.addEventListener("beforeinstallprompt",ne),"getBattery"in navigator&&navigator.getBattery().then(ye=>{M(Math.round(ye.level*100)),ye.addEventListener("levelchange",()=>{M(Math.round(ye.level*100))})}),()=>{window.removeEventListener("online",se),window.removeEventListener("offline",W),window.removeEventListener("beforeinstallprompt",ne),clearInterval(B)}},[]),kt.useEffect(()=>{if(!(x!=null&&x.id))return;const se=async()=>{const{count:B,error:ne}=await Se.from("notifiche").select("*",{count:"exact",head:!0}).eq("id_utente",x.id).eq("stato","non_letta"),{count:ye,error:me}=await Se.from("company_talks").select("*",{count:"exact",head:!0}).eq("recipient_id",x.id).eq("is_read",!1),Q=(B||0)+(ye||0);!ne&&!me&&te(Q)};se();const W=Se.channel(`notifiche-count-${x.id}`).on("postgres_changes",{event:"*",schema:"public",table:"notifiche",filter:`id_utente=eq.${x.id}`},()=>{se()}).subscribe(),G=Se.channel(`talks-count-${x.id}`).on("postgres_changes",{event:"*",schema:"public",table:"company_talks",filter:`recipient_id=eq.${x.id}`},()=>{se()}).subscribe();return()=>{Se.removeChannel(W),Se.removeChannel(G)}},[x==null?void 0:x.id]);const X=async()=>{const se=window.deferredPrompt;if(!se){console.log("üì± Prompt installazione non disponibile");return}console.log("üì± Avvio installazione..."),se.prompt();const{outcome:W}=await se.userChoice;W==="accepted"&&(console.log("PWA installata con successo"),F(!1)),window.deferredPrompt=null};return e.jsxs("header",{className:"bg-gray-800 border-b border-gray-700 p-4 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center shadow-lg",children:e.jsx(Ja,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-lg font-bold text-white",children:["CREW MOBILE ",e.jsx("span",{className:"text-cyan-400 italic font-extrabold tracking-wider transform -skew-x-12 inline-block text-base",children:"APP"})]}),e.jsx("p",{className:"text-xs text-gray-300",children:(x==null?void 0:x.displayName)||(x==null?void 0:x.email)})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(rc,{currentVersion:n,hasUpdate:l,isLoading:c,isUpdating:u,onCheckUpdate:f}),S>0&&e.jsxs("button",{onClick:E,disabled:!v||g,className:`flex items-center space-x-1 px-2 py-1 rounded-lg text-xs ${g?"bg-blue-600 text-white":v?"bg-orange-600 text-white hover:bg-orange-700":"bg-gray-600 text-gray-300"}`,children:[g?e.jsx(Ms,{className:"h-3 w-3 animate-spin"}):e.jsx(ai,{className:"h-3 w-3"}),e.jsx("span",{children:S})]}),T&&e.jsx("button",{onClick:X,className:"bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 flex items-center space-x-1",title:"Installa App",children:e.jsx(cr,{className:"h-4 w-4"})}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>_(!N),className:"relative p-3 text-gray-400 hover:text-cyan-400 hover:bg-gray-700 rounded-lg transition-colors active:scale-95 touch-manipulation",title:"Notifiche",type:"button",children:[e.jsx(ni,{className:"h-6 w-6"}),U>0&&e.jsx("span",{className:"absolute top-1 right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center animate-pulse",children:U>9?"9+":U})]}),N&&e.jsx(ac,{userId:(x==null?void 0:x.id)||"",onClose:()=>_(!1),onOpenCompanyTalk:se=>{O(se),C(!0)}})]}),e.jsx("button",{onClick:async se=>{se.preventDefault(),se.stopPropagation();try{P("Logout in corso..."),await b(),p("Logout effettuato con successo!"),window.location.href="/"}catch(W){console.error("Errore durante il logout:",W),p("Sessione terminata localmente"),setTimeout(()=>{window.location.href="/"},1e3)}},className:"p-3 text-gray-400 hover:text-red-400 hover:bg-gray-700 rounded-lg transition-colors active:scale-95 touch-manipulation",title:"Logout",type:"button",children:e.jsx(va,{className:"h-6 w-6"})})]})]}),!v&&e.jsx("div",{className:"mt-2 bg-red-600 text-white text-center py-2 rounded-lg",children:e.jsx("div",{className:"flex items-center justify-center space-x-2",children:e.jsxs("span",{className:"text-sm font-medium",children:["Modalit√† Offline - Dati salvati localmente",S>0&&` (${S} in attesa)`]})})}),V&&e.jsx("div",{className:"fixed inset-0 z-[9999] bg-gray-900",children:e.jsx(Ti,{openTalkId:K,onClose:()=>{C(!1),O(null)}})})]})},ic=({activeTab:n,onTabChange:l})=>{const c=[{id:"dashboard",label:"Home",icon:ii,description:"Dashboard principale"},{id:"calendar",label:"Calendario",icon:xt,description:"I miei eventi"},{id:"checkin",label:"Check-in",icon:ma,description:"QR Code e GPS"},{id:"expenses",label:"Richieste",icon:qt,description:"Richieste e Rimborsi"},{id:"talk",label:"Messaggi",icon:nr,description:"Messaggi azienda"},{id:"report",label:"Report",icon:ht,description:"Report mensile"},{id:"profile",label:"Profilo",icon:Xr,description:"Il mio profilo"}];return e.jsx("nav",{className:"fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 z-50 shadow-lg pb-safe",children:e.jsxs("div",{className:"relative max-w-screen-lg mx-auto",children:[e.jsx("div",{className:"flex items-center gap-2 px-2 py-2 overflow-x-auto scrollbar-hide snap-x snap-mandatory",style:{scrollbarWidth:"none",msOverflowStyle:"none",WebkitOverflowScrolling:"touch"},children:c.map(u=>{const f=u.icon,x=n===u.id;return e.jsxs("button",{onClick:()=>l(u.id),className:`flex flex-col items-center space-y-0.5 px-4 py-1.5 rounded-lg transition-all duration-200 flex-shrink-0 w-[85px] snap-center ${x?"bg-blue-600 text-white shadow-lg transform scale-105":"text-gray-400 hover:text-white hover:bg-gray-700"}`,title:u.description,children:[e.jsx(f,{className:`h-5 w-5 flex-shrink-0 ${x?"text-white":""}`}),e.jsx("span",{className:`text-[10px] font-medium leading-tight text-center ${x?"text-white":""}`,children:u.label}),x&&e.jsx("div",{className:"w-1 h-1 bg-cyan-400 rounded-full"})]},u.id)})}),e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-4 bg-gradient-to-r from-gray-800 to-transparent pointer-events-none"}),e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-4 bg-gradient-to-l from-gray-800 to-transparent pointer-events-none"})]})})},oc=()=>{const[n,l]=w.useState("1.0.0"),[c,u]=w.useState(!0);return w.useEffect(()=>{(async()=>{try{const{data:x,error:b}=await Se.from("software_versions").select("current_version").eq("software_code","crew_mobile").eq("is_active",!0).maybeSingle();if(b){console.error("Error fetching version:",b);return}x!=null&&x.current_version&&l(x.current_version)}catch(x){console.error("Error fetching version:",x)}finally{u(!1)}})()},[]),{version:n,loading:c}},Jr=()=>{const{version:n}=oc();return e.jsxs("div",{className:"text-center text-gray-500 text-xs",children:[e.jsxs("p",{children:["¬© 2025 ControlStage - Crew App Mobile V. ",n]}),e.jsx("p",{children:"Tutti i diritti riservati - Software realizzato da ControlStage"})]})},lc=({userProfile:n})=>{var c;const l=((c=n==null?void 0:n.regaziendasoftware)==null?void 0:c.ragione_sociale)||(n==null?void 0:n.company_name_cached)||"Caricamento azienda...";return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Dashboard"}),e.jsx("p",{className:"text-gray-300",children:(n==null?void 0:n.full_name)||(n==null?void 0:n.company_name)||"Dipendente"}),e.jsx("p",{className:"text-sm text-blue-400",children:l})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-gray-300",children:new Date().toLocaleDateString("it-IT")}),e.jsx("div",{className:"text-xs text-gray-400",children:new Date().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})]})},cc=({monthlyStats:n,onNavigate:l})=>e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("button",{onClick:()=>l==null?void 0:l("checkin"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-purple-500 transition-all cursor-pointer",children:[e.jsx(Rt,{className:"h-6 w-6 mx-auto mb-2 text-purple-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.turniOggi}),e.jsx("div",{className:"text-xs text-gray-400",children:"Turni Oggi"})]}),e.jsxs("button",{onClick:()=>l==null?void 0:l("calendar"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-purple-500 transition-all cursor-pointer",children:[e.jsx(Rt,{className:"h-6 w-6 mx-auto mb-2 text-purple-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.turniTotaliMese}),e.jsx("div",{className:"text-xs text-gray-400",children:"Turni Mese"})]}),e.jsxs("button",{onClick:()=>l==null?void 0:l("report"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-green-500 transition-all cursor-pointer",children:[e.jsx(pt,{className:"h-6 w-6 mx-auto mb-2 text-green-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.turniCompletati}),e.jsx("div",{className:"text-xs text-gray-400",children:"Turni Completati"})]}),e.jsxs("button",{onClick:()=>l==null?void 0:l("checkin"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-blue-500 transition-all cursor-pointer",children:[e.jsx(xt,{className:"h-6 w-6 mx-auto mb-2 text-blue-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.eventiOggi}),e.jsx("div",{className:"text-xs text-gray-400",children:"Eventi Oggi"})]}),e.jsxs("button",{onClick:()=>l==null?void 0:l("calendar"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-blue-500 transition-all cursor-pointer",children:[e.jsx(xt,{className:"h-6 w-6 mx-auto mb-2 text-blue-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.eventiTotaliMese}),e.jsx("div",{className:"text-xs text-gray-400",children:"Eventi Mese"})]}),e.jsxs("button",{onClick:()=>l==null?void 0:l("report"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-green-500 transition-all cursor-pointer",children:[e.jsx(pt,{className:"h-6 w-6 mx-auto mb-2 text-green-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.eventiCompletati}),e.jsx("div",{className:"text-xs text-gray-400",children:"Eventi Completati"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center",children:[e.jsx(js,{className:"h-6 w-6 mx-auto mb-2 text-yellow-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.buoniPastoAssegnati}),e.jsx("div",{className:"text-xs text-gray-400",children:"Buoni Pasto"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center",children:[e.jsx(Ls,{className:"h-6 w-6 mx-auto mb-2 text-orange-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.pastiAziendaliUsufruiti}),e.jsx("div",{className:"text-xs text-gray-400",children:"Pasti Azienda"})]}),e.jsxs("button",{onClick:()=>l==null?void 0:l("requests"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-cyan-500 transition-all cursor-pointer",children:[e.jsx(qt,{className:"h-6 w-6 mx-auto mb-2 text-cyan-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.noteSpeseInviate}),e.jsx("div",{className:"text-xs text-gray-400",children:"Note Spese"})]})]}),dc=({eventsWithBenefits:n,warehouseShifts:l})=>{const[c,u]=w.useState(new Date().getMonth()),[f,x]=w.useState(new Date().getFullYear()),[b,v]=w.useState("all"),S=U=>U?/^\d{2}:\d{2}$/.test(U)?U:/^\d{2}:\d{2}:\d{2}$/.test(U)?U.substring(0,5):U:"Non specificato",E=(()=>{const U=new Date,te=new Date(U.getFullYear(),U.getMonth(),U.getDate()).toISOString().split("T")[0],N=[];return n.forEach(_=>{const V=_.assignment,C=new Date(V.giorno_inizio_evento);C.getMonth()===c&&C.getFullYear()===f&&V.giorno_inizio_evento>=te&&N.push({id:V.id,type:"event",title:V.nome_evento,companyName:V.nome_azienda,date:V.giorno_inizio_evento,startTime:"09:00",endTime:"17:00",location:V.evento_localita,address:V.evento_indirizzo,callTime:V.evento_orario_convocazione,isTravel:V.evento_trasferta,eventData:V})}),l.forEach(_=>{const V=new Date(_.data_turno);V.getMonth()===c&&V.getFullYear()===f&&_.data_turno>=te&&N.push({id:_.id,type:"warehouse",title:`Turno ${_.nome_magazzino}`,companyName:_.nome_azienda,date:_.data_turno,startTime:S(_.ora_inizio_turno),endTime:S(_.ora_fine_turno),location:_.nome_magazzino,address:_.indirizzo_magazzino||"Indirizzo non disponibile",callTime:S(_.ora_inizio_turno),shiftData:_})}),N.sort((_,V)=>{const C=new Date(_.date),K=new Date(V.date);return C.getTime()-K.getTime()})})(),p=E.filter(U=>U.type==="event").length,k=E.filter(U=>U.type==="warehouse").length,P=b==="all"?E:b==="events"?E.filter(U=>U.type==="event"):E.filter(U=>U.type==="warehouse"),D=()=>{c===0?(u(11),x(f-1)):u(c-1)},R=()=>{c===11?(u(0),x(f+1)):u(c+1)},j=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],M=new Date().getMonth(),T=new Date().getFullYear(),F=c===M&&f===T;return e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("button",{onClick:D,className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(Zr,{className:"h-5 w-5 text-gray-400"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"I Miei Prossimi Eventi"}),e.jsxs("p",{className:"text-sm text-gray-400",children:[j[c]," ",f," (",P.length,")"]})]}),e.jsx("button",{onClick:R,className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(Qr,{className:"h-5 w-5 text-gray-400"})})]}),F&&e.jsx("div",{className:"bg-blue-900 border border-blue-700 rounded-lg p-2 mb-4",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(xt,{className:"h-4 w-4 text-blue-400"}),e.jsx("span",{className:"text-blue-200 text-sm font-medium",children:"Mese Corrente"})]})}),e.jsx("div",{className:"bg-gray-700 rounded-lg border border-gray-600 overflow-hidden mb-4",children:e.jsxs("div",{className:"grid grid-cols-3",children:[e.jsxs("button",{onClick:()=>v("all"),className:`flex items-center justify-center space-x-1 py-3 px-2 transition-all text-sm ${b==="all"?"bg-blue-600 text-white":"bg-gray-700 text-gray-400 hover:bg-gray-600"}`,children:[e.jsx(xt,{className:"h-4 w-4"}),e.jsx("span",{className:"font-semibold",children:"Tutti"}),E.length>0&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded-full ${b==="all"?"bg-blue-500":"bg-gray-600"}`,children:E.length})]}),e.jsxs("button",{onClick:()=>v("events"),className:`flex items-center justify-center space-x-1 py-3 px-2 transition-all text-sm ${b==="events"?"bg-blue-600 text-white":"bg-gray-700 text-gray-400 hover:bg-gray-600"}`,children:[e.jsx(xt,{className:"h-4 w-4"}),e.jsx("span",{className:"font-semibold",children:"Eventi"}),p>0&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded-full ${b==="events"?"bg-blue-500":"bg-gray-600"}`,children:p})]}),e.jsxs("button",{onClick:()=>v("warehouse"),className:`flex items-center justify-center space-x-1 py-3 px-2 transition-all text-sm ${b==="warehouse"?"bg-blue-600 text-white":"bg-gray-700 text-gray-400 hover:bg-gray-600"}`,children:[e.jsx(Rt,{className:"h-4 w-4"}),e.jsx("span",{className:"font-semibold",children:"Turni"}),k>0&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded-full ${b==="warehouse"?"bg-blue-500":"bg-gray-600"}`,children:k})]})]})}),P.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[b==="warehouse"?e.jsx(Rt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}):e.jsx(xt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsxs("p",{children:[b==="all"&&"Nessun evento in programma",b==="events"&&"Nessun evento in programma",b==="warehouse"&&"Nessun turno magazzino in programma"]}),e.jsx("p",{className:"text-sm mt-1",children:F?"Controlla il calendario per nuove assegnazioni":`Nessun ${b==="warehouse"?"turno":"evento"} per ${j[c]} ${f}`})]}):e.jsx("div",{className:"space-y-3",children:P.map(U=>e.jsxs("div",{className:"bg-gray-700 rounded-lg p-4 border border-gray-600",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[U.type==="warehouse"?e.jsx(Rt,{className:"h-5 w-5 text-purple-400"}):U.isTravel?e.jsx(ks,{className:"h-5 w-5 text-green-400"}):e.jsx(xt,{className:"h-5 w-5 text-blue-400"}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${U.type==="warehouse"?"bg-purple-100 text-purple-800":U.isTravel?"bg-green-100 text-green-800":"bg-blue-100 text-blue-800"}`,children:U.type==="warehouse"?"Turno Magazzino":U.isTravel?"Evento Trasferta":"Evento"})]}),e.jsx("div",{className:"text-right",children:e.jsx("div",{className:"text-sm font-bold text-white",children:new Date(U.date).toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"})})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("h4",{className:"font-bold text-white text-lg",children:U.title}),U.shiftData&&e.jsx("p",{className:"text-xs text-purple-300 font-medium",children:U.shiftData.nome_turno||"Turno Standard"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx(ht,{className:"h-4 w-4 text-green-400"}),e.jsx("span",{className:"text-sm font-medium text-green-400",children:U.type==="warehouse"?"Orario Turno":"Orario Convocazione"})]}),e.jsxs("div",{className:"text-white",children:[U.callTime?e.jsx("p",{className:"text-xl font-bold text-green-200",children:U.callTime}):e.jsx("p",{className:"text-sm text-orange-300",children:"‚ö†Ô∏è Orario non disponibile - Contatta l'azienda"}),U.type==="warehouse"&&U.endTime&&e.jsxs("p",{className:"text-sm text-gray-300 mt-1",children:["Turno: ",U.startTime," - ",U.endTime]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx(Ut,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm font-medium text-cyan-400",children:"Localit√†"})]}),e.jsx("div",{className:"text-white",children:U.type==="warehouse"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm font-medium",children:U.location}),e.jsx("p",{className:"text-xs text-gray-300 mt-1",children:U.address||"Indirizzo non disponibile"})]}):e.jsxs(e.Fragment,{children:[U.location?e.jsx("p",{className:"text-sm font-medium",children:U.location}):e.jsx("p",{className:"text-sm text-gray-400",children:"Localit√† non specificata"}),U.address&&e.jsx("p",{className:"text-xs text-gray-300 mt-1",children:U.address})]})})]}),U.type==="event"&&U.eventData&&(U.eventData.link_scheda_tecnica||U.eventData.link_mappa_gps)&&e.jsxs("div",{className:"mt-3 flex gap-3",children:[U.eventData.link_scheda_tecnica&&e.jsxs("a",{href:U.eventData.link_scheda_tecnica,target:"_blank",rel:"noopener noreferrer",className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors",children:[e.jsx(qt,{className:"h-5 w-5"}),e.jsx("span",{children:"SCHEDA LAVORO"})]}),U.eventData.link_mappa_gps&&e.jsxs("a",{href:U.eventData.link_mappa_gps,target:"_blank",rel:"noopener noreferrer",className:"flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors",children:[e.jsx(Wr,{className:"h-5 w-5"}),e.jsx("span",{children:"MAPPA"})]})]}),e.jsx("div",{className:"mt-3 text-center",children:(()=>{const te=new Date(U.date+"T00:00:00"),N=new Date,_=new Date(N.getFullYear(),N.getMonth(),N.getDate()),V=te.getTime()-_.getTime(),C=Math.ceil(V/(1e3*60*60*24));return C===0?e.jsx("span",{className:"inline-flex px-3 py-1 rounded-full text-sm font-bold bg-red-100 text-red-800",children:"OGGI"}):C===1?e.jsx("span",{className:"inline-flex px-3 py-1 rounded-full text-sm font-bold bg-orange-100 text-orange-800",children:"DOMANI"}):C<=7?e.jsxs("span",{className:"inline-flex px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800",children:["Tra ",C," giorni"]}):e.jsxs("span",{className:"inline-flex px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800",children:[C," giorni"]})})()})]},U.id))}),e.jsx("div",{className:"mt-4 pt-3 border-t border-gray-600",children:e.jsxs("div",{className:"flex items-center justify-center space-x-4 text-xs text-gray-400",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(Rt,{className:"h-3 w-3"}),e.jsx("span",{children:"Turni"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(xt,{className:"h-3 w-3"}),e.jsx("span",{children:"Eventi Standard"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ks,{className:"h-3 w-3"}),e.jsx("span",{children:"Eventi Trasferta"})]})]})})]})},uc=({onNavigate:n})=>e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{onClick:()=>n==null?void 0:n("calendar"),className:"bg-gradient-to-br from-blue-600 to-cyan-600 rounded-xl p-4 text-left hover:from-blue-700 hover:to-cyan-700 transition-all",children:[e.jsx(xt,{className:"h-8 w-8 mb-2 text-white"}),e.jsx("div",{className:"text-white font-bold",children:"Calendario"}),e.jsx("div",{className:"text-blue-100 text-sm",children:"Vedi tutti gli eventi"})]}),e.jsxs("button",{onClick:()=>n==null?void 0:n("checkin"),className:"bg-gradient-to-br from-purple-600 to-pink-600 rounded-xl p-4 text-left hover:from-purple-700 hover:to-pink-700 transition-all",children:[e.jsx(pt,{className:"h-8 w-8 mb-2 text-white"}),e.jsx("div",{className:"text-white font-bold",children:"Check-in"}),e.jsx("div",{className:"text-purple-100 text-sm",children:"QR Code e GPS"})]})]}),hc=({onNavigate:n})=>{const{user:l}=Pt(),[c,u]=w.useState([]),[f,x]=w.useState(null),[b,v]=w.useState([]),[S,g]=w.useState(!0),[E,p]=w.useState({turniOggi:0,turniTotaliMese:0,turniCompletati:0,eventiOggi:0,eventiTotaliMese:0,eventiCompletati:0,buoniPastoAssegnati:0,pastiAziendaliUsufruiti:0,noteSpeseInviate:0,totalBaseAmount:0,totalBenefitsAmount:0,warehouseEvents:0,regularEvents:0,travelEvents:0});w.useEffect(()=>{l!=null&&l.id&&k()},[l==null?void 0:l.id]);const k=async()=>{try{g(!0),console.log("üîç Caricamento dashboard con sistema benefit per user:",l==null?void 0:l.id);const{data:D,error:R}=await Se.from("registration_requests").select(`
          *,
          regaziendasoftware!parent_company_id(
            id,
            ragione_sociale,
            email,
            telefono
          )
        `).eq("auth_user_id",l==null?void 0:l.id).single();if(R||!D){console.error("‚ùå Errore caricamento profilo:",R);return}x(D),console.log("‚úÖ Profilo caricato:",D.full_name);const j=new Date,M=j.getMonth(),T=j.getFullYear(),F=j.toISOString().split("T")[0],U=new Date(T,M,1).toISOString().split("T")[0],te=new Date(T,M+1,0).toISOString().split("T")[0];console.log("üìÖ Periodo analisi:",{startOfMonth:U,endOfMonth:te,todayString:F});const{data:N,error:_}=await Se.from("crew_assegnazione_turni").select("*").eq("dipendente_id",l==null?void 0:l.id).gte("data_turno",U).lte("data_turno",te).order("data_turno",{ascending:!0});_&&console.error("‚ùå Errore caricamento turni:",_),console.log("üè≠ Turni magazzino del mese corrente:",(N==null?void 0:N.length)||0);const{data:V,error:C}=await Se.from("crew_event_assegnazione").select("*").eq("dipendente_freelance_id",l==null?void 0:l.id).order("giorno_inizio_evento",{ascending:!0});if(C){console.error("‚ùå Errore caricamento assegnazioni eventi:",C),u([]);return}console.log("üìÖ Eventi assegnati trovati:",(V==null?void 0:V.length)||0);const{data:K,error:O}=await Se.from("crew_assegnazione_turni").select(`
          *,
          crew_template_turni!turno_id(
            warehouse_id,
            warehouses!warehouse_id(
              name,
              address
            )
          )
        `).eq("dipendente_id",l==null?void 0:l.id).order("data_turno",{ascending:!0});O?(console.error("‚ùå Errore caricamento turni magazzino:",O),v([])):(console.log("üè≠ Turni magazzino assegnati trovati:",(K==null?void 0:K.length)||0),v(K||[]));const{data:X,error:se}=await Se.from("crew_assegnazionetariffa").select("*").eq("dipendente_id",l==null?void 0:l.id).eq("attivo",!0);if(se){console.error("‚ùå Errore caricamento tariffe dipendente:",se);return}console.log("üí∞ Tariffe dipendente caricate:",(X==null?void 0:X.length)||0);const W=[];if(X&&X.length>0){const B=[];if(X.forEach(ne=>{ne.tariffe_ids&&ne.tariffe_ids.length>0&&B.push(...ne.tariffe_ids)}),console.log("üîç ID tariffe da caricare:",B),B.length>0){const ne=[...new Set(B)],{data:ye,error:me}=await Se.from("crew_tariffe").select("*").in("id",ne).eq("attivo",!0);if(me){console.error("‚ùå Errore caricamento dettagli tariffe:",me);return}console.log("‚úÖ Tariffe caricate:",(ye==null?void 0:ye.length)||0),ye==null||ye.forEach(Q=>{W.push({id:Q.id,nome_tariffa:Q.nome_tariffa,categoria:Q.categoria,tipo_calcolo:Q.tipo_calcolo,importo:Q.importo,attivo:Q.attivo})})}}console.log("üéÅ Benefit dipendente disponibili:",W.map(B=>B.nome_tariffa));const G=[];for(const B of V||[]){console.log(`
üé≠ ANALISI EVENTO: "${B.nome_evento}"`),console.log("üìã Benefit evento disponibili:",{benefits_evento_nomi:B.benefits_evento_nomi,bonus_trasferta:B.bonus_trasferta,bonus_diaria:B.bonus_diaria,evento_trasferta:B.evento_trasferta,bonus_previsti:B.bonus_previsti});const ne=[],ye=[];let me=0;if(B.benefits_evento_nomi&&B.benefits_evento_nomi.length>0&&B.benefits_evento_nomi.forEach(Q=>{const fe=W.find(be=>be.nome_tariffa.toLowerCase().includes(Q.toLowerCase())||Q.toLowerCase().includes(be.nome_tariffa.toLowerCase()));fe?(ne.push(fe),me+=fe.importo,ye.push({name:fe.nome_tariffa,amount:fe.importo,category:fe.categoria,applied:!0}),console.log(`‚úÖ BENEFIT APPLICATO: ${fe.nome_tariffa} = ‚Ç¨${fe.importo}`)):(ye.push({name:Q,amount:0,category:"non_disponibile",applied:!1}),console.log(`‚ùå BENEFIT NON DISPONIBILE: ${Q} (dipendente non ha questa tariffa)`))}),B.bonus_trasferta&&B.evento_trasferta){const Q=W.find(fe=>fe.categoria==="indennita_trasferta"||fe.nome_tariffa.toLowerCase().includes("trasferta"));Q&&!ne.find(fe=>fe.id===Q.id)&&(ne.push(Q),me+=Q.importo,ye.push({name:Q.nome_tariffa,amount:Q.importo,category:Q.categoria,applied:!0}),console.log(`‚úÖ BONUS TRASFERTA APPLICATO: ${Q.nome_tariffa} = ‚Ç¨${Q.importo}`))}if(B.bonus_diaria){const Q=W.find(fe=>fe.nome_tariffa.toLowerCase().includes("diaria")||fe.categoria==="indennita_trasferta");Q&&!ne.find(fe=>fe.id===Q.id)&&(ne.push(Q),me+=Q.importo,ye.push({name:Q.nome_tariffa,amount:Q.importo,category:Q.categoria,applied:!0}),console.log(`‚úÖ BONUS DIARIA APPLICATO: ${Q.nome_tariffa} = ‚Ç¨${Q.importo}`))}B.bonus_previsti&&B.bonus_previsti>0&&(me+=B.bonus_previsti,ye.push({name:"Bonus Evento",amount:B.bonus_previsti,category:"bonus_evento",applied:!0}),console.log(`‚úÖ BONUS FISSO EVENTO: ‚Ç¨${B.bonus_previsti}`)),console.log(`üí∞ TOTALE BENEFIT APPLICABILI: ‚Ç¨${me}`),K==null||K.forEach(Q=>{var fe,be;Q.warehouse_address=((be=(fe=Q.crew_template_turni)==null?void 0:fe.warehouses)==null?void 0:be.address)||"Indirizzo non disponibile"}),console.log("üìä DETTAGLIO BENEFIT:",ye),G.push({assignment:B,applicableBenefits:ne,totalBenefitsAmount:me,benefitDetails:ye})}u(G),await P(G,N||[],K||[])}catch(D){console.error("‚ùå Errore generale caricamento dashboard:",D)}finally{g(!1)}},P=async(D,R,j)=>{const M=new Date,T=M.getMonth(),F=M.getFullYear(),U=M.toISOString().split("T")[0],te=new Date(F,T,1).toISOString().split("T")[0],N=new Date(F,T+1,0).toISOString().split("T")[0],_=R.filter(L=>L.data_turno===U).length,V=D.filter(L=>L.assignment.giorno_inizio_evento===U&&!L.assignment.nome_evento.toLowerCase().includes("magazzino")&&!L.assignment.nome_evento.toLowerCase().includes("turno")).length,C=R.length,K=D.filter(L=>{const re=new Date(L.assignment.giorno_inizio_evento);return re.getMonth()===T&&re.getFullYear()===F&&!L.assignment.nome_evento.toLowerCase().includes("magazzino")&&!L.assignment.nome_evento.toLowerCase().includes("turno")}).length,{data:O}=await Se.from("timesheet_entries").select("event_id, end_time, status, is_rectified").eq("crew_id",l==null?void 0:l.id).gte("date",te).lte("date",N),X=new Set((O==null?void 0:O.filter(L=>L.end_time&&(L.status==="completed"||L.status==="submitted")).map(L=>L.event_id))||[]),se=D.filter(L=>{const re=new Date(L.assignment.giorno_inizio_evento);return re.getMonth()===T&&re.getFullYear()===F&&!L.assignment.nome_evento.toLowerCase().includes("magazzino")&&!L.assignment.nome_evento.toLowerCase().includes("turno")&&X.has(L.assignment.evento_id)}).length;let W=0,G=0,B=0,ne=0;try{const{data:L,error:re}=await Se.from("warehouse_checkins").select("date, meal_voucher, company_meal").eq("crew_id",l==null?void 0:l.id).gte("date",te).lte("date",N).not("check_out_time","is",null);!re&&L&&(B=new Set(L.map(we=>we.date)).size,W=new Set(L.filter(we=>we.meal_voucher===!0).map(we=>we.date)).size,G=new Set(L.filter(we=>we.company_meal===!0).map(we=>we.date)).size);const{data:de,error:oe}=await Se.from("spese").select("id").eq("id_tecnico",l==null?void 0:l.id).gte("data_spesa",te).lte("data_spesa",N);!oe&&de&&(ne=de.length)}catch(L){console.error("‚ùå Errore caricamento dati dal database:",L)}const ye=D.filter(L=>{const re=new Date(L.assignment.giorno_inizio_evento);return re.getMonth()===T&&re.getFullYear()===F}),me=ye.reduce((L,re)=>L+(re.assignment.tariffa_evento_assegnata||0),0),Q=ye.reduce((L,re)=>L+re.totalBenefitsAmount,0),fe=ye.filter(L=>L.assignment.nome_evento.toLowerCase().includes("magazzino")||L.assignment.nome_evento.toLowerCase().includes("turno")).length,be=ye.filter(L=>L.assignment.evento_trasferta).length,Z=ye.length-fe-be;console.log("üìä DEBUG EVENTI TRASFERTA:",{monthlyEventsCount:ye.length,eventiConTrasferta:ye.filter(L=>L.assignment.evento_trasferta).map(L=>({nome:L.assignment.nome_evento,evento_trasferta:L.assignment.evento_trasferta})),travelEventsCount:be}),console.log("üìä STATISTICHE CALCOLATE:",{turniOggi:_,turniTotaliMese:C,turniCompletati:B,eventiOggi:V,eventiTotaliMese:K,eventiCompletati:se,buoniPastoAssegnati:W,pastiAziendaliUsufruiti:G,noteSpeseInviate:ne,warehouseEvents:fe,regularEvents:Z,travelEvents:be}),p({turniOggi:_,turniTotaliMese:C,turniCompletati:B,eventiOggi:V,eventiTotaliMese:K,eventiCompletati:se,buoniPastoAssegnati:W,pastiAziendaliUsufruiti:G,noteSpeseInviate:ne,totalBaseAmount:me,totalBenefitsAmount:Q,warehouseEvents:fe,regularEvents:Z,travelEvents:be})};return S?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento dashboard..."})]})}):e.jsx("div",{className:"min-h-screen bg-gray-900 text-white",children:e.jsxs("div",{className:"p-4 pb-20 space-y-6",children:[e.jsx(lc,{userProfile:f}),e.jsx(cc,{monthlyStats:E,onNavigate:n}),e.jsx(dc,{eventsWithBenefits:c,warehouseShifts:b}),e.jsx(uc,{onNavigate:n}),e.jsx(Jr,{})]})})},xc=()=>{var qe;const{user:n}=Pt(),{showSuccess:l,showError:c}=ms(),[u,f]=w.useState(new Date),[x,b]=w.useState([]),[v,S]=w.useState(null),[g,E]=w.useState(!0),[p,k]=w.useState(null),[P,D]=w.useState(!1),[R,j]=w.useState("month"),[M,T]=w.useState([]),[F,U]=w.useState([]),[te,N]=w.useState([]),[_,V]=w.useState(new Set),[C,K]=w.useState({}),[O,X]=w.useState(!1);w.useEffect(()=>{n!=null&&n.id&&se()},[n==null?void 0:n.id]);const se=async()=>{try{const{data:De,error:H}=await Se.from("registration_requests").select(`
          *,
          regaziendasoftware!parent_company_id(ragione_sociale)
        `).eq("auth_user_id",n==null?void 0:n.id).single();if(H){console.error("Errore caricamento profilo:",H),E(!1);return}S(De);const ae=De==null?void 0:De.id;De!=null&&De.parent_company_id?(await G(De.parent_company_id,ae),await W(ae,De.parent_company_id)):(await G(void 0,ae),await W(ae))}catch(De){console.error("Errore loadUserProfile:",De)}finally{E(!1)}},W=async(De,H)=>{try{if(!De)return;const{data:ae,error:he}=await Se.from("crew_richiesteferie_permessi").select("data_inizio, data_fine, tipo_richiesta, stato").eq("dipendente_id",De).eq("stato","approvata");if(he){console.error("Errore caricamento ferie approvate:",he);return}const Ae=new Set;ae&&ae.length>0&&ae.forEach(Re=>{if(Re.tipo_richiesta==="ferie"){const ee=new Date(Re.data_inizio),le=new Date(Re.data_fine);let Ee=new Date(ee);for(;Ee<=le;){const _e=me(Ee);Ae.add(_e),Ee.setDate(Ee.getDate()+1)}}}),V(Ae),console.log("‚úÖ Ferie approvate caricate:",Ae.size,"giorni")}catch(ae){console.error("Eccezione loadApprovedVacations:",ae)}},G=async(De,H)=>{try{console.log("üìÖ Caricamento eventi, turni magazzino e corsi per:",H||(n==null?void 0:n.id));const ae=le=>le?/^\d{2}:\d{2}$/.test(le)?le:/^\d{2}:\d{2}:\d{2}$/.test(le)?le.substring(0,5):"09:00":"09:00";let he=null;try{if(H){const{data:le,error:Ee}=await Se.from("crew_event_assegnazione").select("*").eq("dipendente_freelance_id",H).order("giorno_inizio_evento",{ascending:!0});Ee?console.error("Errore crew_event_assegnazione (personId):",Ee):he=le}else{const{data:le,error:Ee}=await Se.from("crew_event_assegnazione").select("*").eq("dipendente_freelance_id",n==null?void 0:n.id).order("giorno_inizio_evento",{ascending:!0});Ee?console.error("Errore crew_event_assegnazione (fallback):",Ee):he=le}console.log("‚úÖ Eventi assegnati caricati (crew_event_assegnazione):",(he==null?void 0:he.length)||0)}catch(le){console.error("Eccezione crew_event_assegnazione:",le)}let Ae=null;try{const{data:le,error:Ee}=await Se.from("crew_assegnazione_turni").select("*").eq("dipendente_id",H||(n==null?void 0:n.id)).order("data_turno",{ascending:!0});Ee?console.error("Errore crew_assegnazione_turni:",Ee):Ae=le}catch(le){console.error("Eccezione crew_assegnazione_turni:",le)}let Re=null;try{const{data:le,error:Ee}=await Se.from("crew_assegnazionecorsi").select("*").eq("persona_id",H||(n==null?void 0:n.id)).order("data_invito",{ascending:!0});Ee?console.error("Errore crew_assegnazionecorsi:",Ee):Re=le}catch(le){console.error("Eccezione crew_assegnazionecorsi:",le)}T(he||[]),U(Ae||[]),N(Re||[]);const ee=[];if(he&&he.length>0&&he.forEach(le=>{const Ee=le.data_inizio_assegnazione||le.giorno_inizio_evento,_e=le.data_fine_assegnazione||le.giorno_fine_evento||Ee,J=le.evento_orario_convocazione||void 0,ke=(le.nome_evento||"").toString().toLowerCase();let $="event";ke.includes("magazzino")||ke.includes("turno")?$="warehouse":le.evento_trasferta&&($="event_travel"),ee.push({id:le.id||le.evento_id||String(Math.random()),title:le.nome_evento||le.nome_azienda||"Evento Assegnato",description:le.evento_descrizione||void 0,type:$,date:typeof Ee=="string"?Ee:new Date(Ee).toISOString().slice(0,10),endDate:typeof _e=="string"?_e:new Date(_e).toISOString().slice(0,10),startTime:"09:00",endTime:"17:00",location:le.evento_localita||le.nome_azienda||"Localit√† non specificata",address:le.evento_indirizzo||void 0,callTime:J,companyName:le.nome_azienda||"",isAssigned:!0,status:"assigned",assignedCrewNames:le.nome_dipendente_freelance||void 0,isTravel:!!le.evento_trasferta,assignedRate:le.tariffa_evento_assegnata?Number(le.tariffa_evento_assegnata):void 0,bonusTravel:!!le.bonus_trasferta,bonusDiaria:!!le.bonus_diaria,benefitsEventoIds:le.benefits_evento_ids||[],benefitsEventoNomi:le.benefits_evento_nomi||[],benefitsDisponibili:le.benefits_disponibili||{},raw:le})}),Ae&&Ae.length>0&&Ae.forEach(le=>{var _e;const Ee=le.data_turno?typeof le.data_turno=="string"?le.data_turno:new Date(le.data_turno).toISOString().slice(0,10):me(new Date);ee.push({id:le.id,title:le.nome_turno||"Turno Magazzino",description:`Turno di magazzino presso ${le.nome_magazzino||"Magazzino"}`,type:"warehouse",date:Ee,endDate:Ee,startTime:le.ora_inizio_turno?le.ora_inizio_turno.substring(0,5):"09:00",endTime:le.ora_fine_turno?le.ora_fine_turno.substring(0,5):"17:00",location:le.nome_magazzino||"Magazzino",address:le.indirizzo_magazzino||void 0,callTime:le.ora_inizio_turno?le.ora_inizio_turno.substring(0,5):void 0,companyName:le.nome_azienda||((_e=v==null?void 0:v.regaziendasoftware)==null?void 0:_e.ragione_sociale)||"La Mia Azienda",isAssigned:!0,status:"assigned",assignedCrewNames:le.dipendente_nome||void 0,isTravel:!1,assignedRate:void 0,bonusTravel:!1,bonusDiaria:!1,raw:le})}),Re&&Re.length>0){const le=Array.from(new Set(Re.map(_e=>_e.corso_id).filter(Boolean)));let Ee={};try{if(le.length>0){const{data:_e,error:J}=await Se.from("crew_corsi").select("*").in("id",le);J?console.error("Errore caricamento crew_corsi:",J):Ee=(_e||[]).reduce((ke,$)=>(ke[$.id]=$,ke),{})}}catch(_e){console.error("Eccezione caricamento crew_corsi:",_e)}Re.forEach(_e=>{var $;const J=Ee[_e.corso_id],ke=J!=null&&J.data_corso?typeof J.data_corso=="string"?J.data_corso:new Date(J.data_corso).toISOString().slice(0,10):_e.data_partecipazione?typeof _e.data_partecipazione=="string"?_e.data_partecipazione:new Date(_e.data_partecipazione).toISOString().slice(0,10):null;ke&&ee.push({id:_e.id,title:(J==null?void 0:J.titolo)||`Corso ${_e.corso_id}`,description:(J==null?void 0:J.descrizione)||void 0,type:"course",date:ke,endDate:ke,startTime:J!=null&&J.ora_inizio?J.ora_inizio.substring?J.ora_inizio.substring(0,5):J.ora_inizio:"09:00",endTime:J!=null&&J.ora_fine?J.ora_fine.substring?J.ora_fine.substring(0,5):J.ora_fine:"17:00",location:(J==null?void 0:J.luogo)||"Luogo non specificato",address:(J==null?void 0:J.luogo)||void 0,callTime:J!=null&&J.ora_inizio?J.ora_inizio.substring?J.ora_inizio.substring(0,5):J.ora_inizio:void 0,companyName:(($=v==null?void 0:v.regaziendasoftware)==null?void 0:$.ragione_sociale)||"",isAssigned:!0,status:_e.stato_invito||"invitato",assignedCrewNames:_e.persona_nome||void 0,isTravel:!1,assignedRate:void 0,bonusTravel:!1,bonusDiaria:!1,raw:{assignment:_e,corso:J}})})}b(ee),console.log("üìä CALENDARIO COMPLETO CARICATO:",{eventiTotali:ee.length,eventi:(he==null?void 0:he.length)||0,turniMagazzino:(Ae==null?void 0:Ae.length)||0,corsi:(Re==null?void 0:Re.length)||0,eventiTrasferta:ee.filter(le=>le.isTravel).length})}catch(ae){console.error("Errore nel caricamento eventi:",ae),b([]),T([]),U([]),N([])}},B=async De=>{K(H=>({...H,[De]:!0}));try{const H=new Date().toISOString(),{error:ae}=await Se.from("crew_assegnazionecorsi").update({stato_invito:"confermato",data_conferma:H}).eq("id",De);return ae?(console.error("Errore conferma partecipazione corso:",ae),c("Errore","Errore durante la conferma partecipazione."),!1):(N(he=>he.map(Ae=>String(Ae.id)===String(De)?{...Ae,stato_invito:"confermato",data_conferma:H}:Ae)),b(he=>he.map(Ae=>{if(String(Ae.id)===String(De)&&Ae.type==="course"){const Re={...Ae.raw||{}};return Re.assignment&&(Re.assignment={...Re.assignment,stato_invito:"confermato",data_conferma:H}),{...Ae,status:"confermato",raw:Re}}return Ae})),l("Partecipazione confermata"),!0)}catch(H){return console.error("Eccezione handleConfirmCourse:",H),c("Errore","Errore durante la conferma partecipazione."),!1}finally{K(H=>({...H,[De]:!1}))}},ne=async De=>{K(H=>({...H,[De]:!0}));try{const{error:H}=await Se.from("crew_assegnazionecorsi").update({stato_invito:"invitato",data_conferma:null}).eq("id",De);return H?(console.error("Errore annullo partecipazione corso:",H),c("Errore","Errore durante l'annullamento partecipazione."),!1):(N(ae=>ae.map(he=>String(he.id)===String(De)?{...he,stato_invito:"invitato",data_conferma:null}:he)),b(ae=>ae.map(he=>{if(String(he.id)===String(De)&&he.type==="course"){const Ae={...he.raw||{}};return Ae.assignment&&(Ae.assignment={...Ae.assignment,stato_invito:"invitato",data_conferma:null}),{...he,status:"invitato",raw:Ae}}return he})),l("Partecipazione annullata"),!0)}catch(H){return console.error("Eccezione handleCancelCourse:",H),c("Errore","Errore durante l'annullamento partecipazione."),!1}finally{K(H=>({...H,[De]:!1}))}};window.__confirmCourseHandler=B,window.__cancelCourseHandler=ne;const ye=async De=>{var H,ae,he;try{if(console.log("üîé loadColleaguesForEvent (RPC): evt.id=",De.id,"raw=",De.raw),De.type==="warehouse"&&De.raw){const ee=De.raw.turno_id||De.raw.turno||De.raw.turnoId,le=De.date;if(ee){const{data:Ee,error:_e}=await Se.rpc("get_shift_colleagues",{p_turno:ee,p_data:le});if(_e)console.warn("RPC get_shift_colleagues error",_e);else if(Ee&&Ee.length>0)return(Ee||[]).map(J=>({id:J.dipendente_id,name:J.dipendente_nome}))}}const Ae=((H=De.raw)==null?void 0:H.evento_id)||((ae=De.raw)==null?void 0:ae.event_id)||De.id,Re=((he=De.raw)==null?void 0:he.azienda_id)||null;if(Ae){const{data:ee,error:le}=await Se.rpc("get_event_colleagues",{p_evento:Ae,p_company:Re});if(le)console.warn("RPC get_event_colleagues error",le);else if(ee&&ee.length>0)return(ee||[]).map(Ee=>({id:Ee.dipendente_id,name:Ee.dipendente_nome}))}if(Ae)try{const{data:ee,error:le}=await Se.from("crew_event_assegnazione").select("dipendente_freelance_id, nome_dipendente_freelance").eq("evento_id",Ae);if(!le&&ee&&ee.length>0)return(ee||[]).map(Ee=>({id:Ee.dipendente_freelance_id,name:Ee.nome_dipendente_freelance}))}catch(ee){console.warn("fallback crew_event_assegnazione exception",ee)}return[]}catch(Ae){return console.error("Eccezione loadColleaguesForEvent:",Ae),[]}},me=De=>{const H=De.getFullYear(),ae=String(De.getMonth()+1).padStart(2,"0"),he=String(De.getDate()).padStart(2,"0");return`${H}-${ae}-${he}`},Q=(De,H=1)=>{const ae=new Date(De),he=(ae.getDay()+7)%7,Ae=(he<H?7:0)+he-H;return ae.setDate(ae.getDate()-Ae),ae.setHours(0,0,0,0),ae},fe=(De,H)=>{const ae=new Date(De);return ae.setDate(ae.getDate()+H),ae},be=De=>{const H=Q(De,1);return Array.from({length:7}).map((ae,he)=>fe(H,he))},Z=(De,H)=>x.filter(ae=>{const he=ae.date,Ae=ae.endDate||ae.date;return he<=H&&Ae>=De}),L=()=>{f(R==="month"||R==="agenda"?new Date(u.getFullYear(),u.getMonth()-1,1):R==="week"?fe(u,-7):fe(u,-1))},re=()=>{f(R==="month"||R==="agenda"?new Date(u.getFullYear(),u.getMonth()+1,1):R==="week"?fe(u,7):fe(u,1))},de=()=>f(new Date),oe=De=>{const H=De.getFullYear(),ae=De.getMonth(),he=new Date(H,ae,1),Re=new Date(H,ae+1,0).getDate(),ee=[],le=(he.getDay()+6)%7;for(let _e=0;_e<le;_e++){const J=new Date(H,ae,1-(le-_e)),ke=_.has(me(J));ee.push({date:J,isCurrentMonth:!1,isToday:!1,events:ge(J),isAvailable:!0,isVacationDay:ke})}for(let _e=1;_e<=Re;_e++){const J=new Date(H,ae,_e),ke=ge(J),$=_.has(me(J));ee.push({date:J,isCurrentMonth:!0,isToday:me(J)===me(new Date),events:ke,isAvailable:ke.length===0,isVacationDay:$})}const Ee=42-ee.length;for(let _e=1;_e<=Ee;_e++){const J=new Date(H,ae+1,_e),ke=_.has(me(J));ee.push({date:J,isCurrentMonth:!1,isToday:!1,events:ge(J),isAvailable:!0,isVacationDay:ke})}return ee},ge=De=>{const H=De.getFullYear(),ae=String(De.getMonth()+1).padStart(2,"0"),he=String(De.getDate()).padStart(2,"0"),Ae=`${H}-${ae}-${he}`;return x.filter(Re=>{const ee=Re.date,le=Re.endDate||Re.date;return Ae>=ee&&Ae<=le}).sort((Re,ee)=>(Re.startTime||"").localeCompare(ee.startTime||""))},ve=te.filter(De=>De.stato_invito==="invitato"),Te=()=>{const De=be(u),H=me(De[0]),ae=me(De[6]),he=Z(H,ae);return e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 p-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsxs("div",{className:"text-sm font-medium text-gray-200",children:["Settimana: ",new Date(H).toLocaleDateString("it-IT")," ‚Äî ",new Date(ae).toLocaleDateString("it-IT")]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-7 gap-3 md:gap-2",children:De.map(Ae=>{const Re=me(Ae),ee=he.filter(_e=>_e.date<=Re&&(_e.endDate||_e.date)>=Re),le=_.has(Re),Ee=me(Ae)===me(new Date);return e.jsxs("div",{className:`rounded-lg p-3 md:p-2 md:min-h-[140px] ${le?"bg-red-600":"bg-gray-900"}`,children:[e.jsx("div",{className:`text-base md:text-sm font-semibold mb-2 ${Ee?"text-blue-300":"text-white"}`,children:Ae.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"short"})}),le?e.jsx("div",{className:"flex items-center justify-center py-4 md:h-20",children:e.jsx("span",{className:"text-sm md:text-xs font-bold text-white uppercase tracking-wider",children:"FERIE"})}):e.jsx("div",{className:"space-y-2 md:space-y-1",children:ee.map(_e=>e.jsx("div",{className:`text-sm md:text-[11px] leading-tight px-2 md:px-1.5 py-2 md:py-1 rounded text-white font-medium cursor-pointer hover:opacity-90 ${_e.type==="warehouse"?_e.isAssigned?"bg-purple-500":"bg-purple-600 opacity-80":_e.type==="event"?_e.isAssigned?"bg-blue-500":"bg-blue-600 opacity-80":_e.type==="event_travel"?_e.isAssigned?"bg-green-500":"bg-green-600 opacity-80":_e.isAssigned?"bg-yellow-500":"bg-yellow-600 opacity-80"}`,title:_e.title,onClick:()=>Fe(Re),children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"truncate md:block",children:_e.title}),e.jsx("span",{className:"text-xs opacity-75 whitespace-nowrap md:hidden",children:_e.startTime})]})},_e.id))})]},Re)})})]})},we=()=>{const De=new Date(u),H=me(De),ae=x.filter(he=>he.date<=H&&(he.endDate||he.date)>=H).sort((he,Ae)=>(he.startTime||"").localeCompare(Ae.startTime||""));return e.jsx(je,{dayEvents:ae,day:De,loadColleaguesForEvent:ye,userId:n==null?void 0:n.id})},je=({dayEvents:De,day:H,loadColleaguesForEvent:ae,userId:he})=>{const[Ae,Re]=w.useState({}),[ee,le]=w.useState({});return w.useEffect(()=>{let Ee=!0;return(async()=>{for(const J of De){if(!Ee)return;if(J.type==="course"){le(ue=>({...ue,[J.id]:!1})),Re(ue=>({...ue,[J.id]:[]}));continue}le(ue=>({...ue,[J.id]:!0}));const ke=await ae(J);if(!Ee)return;const $=ke.filter(ue=>ue.id!==he);Re(ue=>({...ue,[J.id]:$})),le(ue=>({...ue,[J.id]:!1}))}})(),()=>{Ee=!1}},[De.map(Ee=>Ee.id).join(",")]),e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 p-5",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{children:e.jsxs("div",{className:"text-base font-medium text-gray-200",children:["Giorno: ",H.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})]})})}),De.length===0?e.jsx("div",{className:"text-center text-gray-400 py-10 text-base",children:"Nessun evento in questa data"}):e.jsx("div",{className:"space-y-4",children:De.map(Ee=>e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-lg font-semibold text-white mb-1",children:Ee.title}),e.jsx("div",{className:"text-sm text-gray-300",children:Ee.location}),Ee.callTime&&e.jsxs("div",{className:"text-sm text-gray-400 mt-2",children:["Convocazione: ",Ee.callTime]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-300",children:[Ee.startTime," - ",Ee.endTime]}),e.jsx("div",{className:"text-sm mt-2",children:Ee.isAssigned?e.jsx("span",{className:"text-green-300 font-medium",children:"Assegnato"}):e.jsx("span",{className:"text-yellow-300 font-medium",children:"Non assegnato"})})]})]}),e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-700",children:ee[Ee.id]?e.jsx("div",{className:"text-sm text-gray-400",children:"Caricamento colleghi..."}):Ee.type!=="course"&&Ae[Ee.id]&&Ae[Ee.id].length>0?e.jsxs("div",{className:"p-3 bg-gray-800 rounded text-sm text-gray-200",children:[e.jsx("strong",{className:"text-base",children:"Con te lavoreranno:"}),e.jsx("ul",{className:"mt-2 space-y-1 text-sm",children:Ae[Ee.id].map(_e=>e.jsxs("li",{className:"text-gray-300",children:["‚Ä¢ ",_e.name]},_e.id))})]}):Ee.type==="course"?null:e.jsx("div",{className:"text-sm text-gray-400",children:"Nessun altro membro assegnato trovato."})})]},Ee.id))})]})},Fe=De=>{k(De),D(!0)},Ve=()=>{const De=u.getFullYear(),H=u.getMonth(),ae=new Date(De,H,1),he=new Date(De,H+1,0),Ae=me(ae),Re=me(he),le=Z(Ae,Re).sort((_e,J)=>_e.date!==J.date?_e.date.localeCompare(J.date):(_e.startTime||"").localeCompare(J.startTime||"")).reduce((_e,J)=>{const ke=J.date;return _e[ke]||(_e[ke]=[]),_e[ke].push(J),_e},{}),Ee=Object.keys(le).sort();return e.jsx("div",{className:"space-y-4",children:Ee.length===0?e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 p-8 text-center",children:[e.jsx(xt,{className:"h-16 w-16 mx-auto mb-4 text-gray-600"}),e.jsx("p",{className:"text-base text-gray-400",children:"Nessun evento in questo mese"})]}):Ee.map(_e=>{const J=new Date(_e+"T12:00:00"),ke=me(J)===me(new Date),$=_.has(_e),ue=le[_e];return e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 overflow-hidden",children:[e.jsx("div",{className:`p-4 border-b border-gray-700 ${$?"bg-red-600":ke?"bg-blue-600":"bg-gray-750"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-bold text-white",children:J.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})}),$&&e.jsx("div",{className:"text-sm text-white font-bold mt-1 uppercase tracking-wider",children:"FERIE"}),ke&&!$&&e.jsx("div",{className:"text-sm text-blue-100 mt-1",children:"Oggi"})]}),e.jsxs("div",{className:"text-sm text-gray-300 font-medium",children:[ue.length," ",ue.length===1?"evento":"eventi"]})]})}),e.jsx("div",{className:"p-4 space-y-3",children:ue.map(xe=>{const pe=()=>xe.type==="warehouse"?"Magazzino":xe.type==="event"?"Evento":xe.type==="event_travel"?"Trasferta":"Corso",Ze=()=>xe.type==="warehouse"?"bg-purple-500":xe.type==="event"?"bg-blue-500":xe.type==="event_travel"?"bg-green-500":"bg-yellow-500";return e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700 hover:border-gray-600 transition-colors cursor-pointer",onClick:()=>Fe(_e),children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("span",{className:`inline-block px-3 py-1 text-xs font-semibold text-white rounded-full ${Ze()}`,children:pe()}),xe.isAssigned&&e.jsxs("span",{className:"inline-flex items-center text-xs text-green-300 font-medium",children:[e.jsx(pt,{className:"h-3.5 w-3.5 mr-1"}),"Assegnato"]})]}),e.jsx("h4",{className:"text-base font-bold text-white mb-1",children:xe.title})]})}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-300",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ht,{className:"h-4 w-4 flex-shrink-0 text-gray-400"}),e.jsxs("span",{children:[xe.startTime," - ",xe.endTime,xe.callTime&&e.jsxs("span",{className:"text-gray-400 ml-2",children:["(Convocazione: ",xe.callTime,")"]})]})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 flex-shrink-0 text-gray-400 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:xe.location}),xe.address&&e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:xe.address})]})]}),xe.companyName&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Rt,{className:"h-4 w-4 flex-shrink-0 text-gray-400"}),e.jsx("span",{children:xe.companyName})]}),xe.description&&e.jsx("div",{className:"mt-2 p-2 bg-gray-800 rounded text-xs text-gray-400 border border-gray-700",children:xe.description}),(xe.bonusTravel||xe.bonusDiaria||xe.assignedRate)&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-gray-700 flex flex-wrap gap-2",children:[xe.bonusTravel&&e.jsx("span",{className:"inline-flex px-2 py-1 text-xs bg-green-900 text-green-200 rounded",children:"Bonus Trasferta"}),xe.bonusDiaria&&e.jsx("span",{className:"inline-flex px-2 py-1 text-xs bg-blue-900 text-blue-200 rounded",children:"Bonus Diaria"}),xe.assignedRate&&e.jsxs("span",{className:"inline-flex px-2 py-1 text-xs bg-gray-700 text-gray-200 rounded",children:["Tariffa: ",xe.assignedRate," EUR"]})]})]})]},xe.id)})})]},_e)})})},rt=u.getMonth(),st=u.getFullYear(),Je=M.filter(De=>{const H=De.data_inizio_assegnazione||De.giorno_inizio_evento||De.start_date||De.date;if(!H)return!1;const ae=new Date(H);return ae.getMonth()===rt&&ae.getFullYear()===st}).length,Qe=F.filter(De=>{const H=De.data_turno||De.date||De.start_date;if(!H)return!1;const ae=new Date(H);return ae.getMonth()===rt&&ae.getFullYear()===st}).length;if(g)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento calendario..."})]})});const We=e.jsx("style",{children:`
      .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .hide-scrollbar::-webkit-scrollbar { display: none; }
    `}),gt=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white",children:[We,e.jsxs("div",{className:"p-4 pb-20 space-y-4",children:[e.jsxs("div",{className:"flex flex-col space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Il Mio Calendario"}),e.jsx("p",{className:"text-gray-300",children:((qe=v==null?void 0:v.regaziendasoftware)==null?void 0:qe.ragione_sociale)||"La Mia Azienda"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:L,className:"p-2 hover:bg-gray-800 rounded",children:e.jsx(Zr,{className:"h-5 w-5"})}),e.jsx("button",{onClick:de,className:"px-3 py-1 bg-gray-800 rounded text-sm",children:"Oggi"}),e.jsx("button",{onClick:re,className:"p-2 hover:bg-gray-800 rounded",children:e.jsx(Qr,{className:"h-5 w-5"})}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{className:"p-2 hover:bg-gray-800 rounded relative",onClick:()=>X(De=>!De),"aria-haspopup":"true","aria-expanded":O,title:"Corsi da confermare",children:[e.jsx(ni,{className:"h-5 w-5"}),ve.length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-600 text-white text-xxs rounded-full px-1.5 py-0.5 text-[10px]",children:ve.length})]}),O&&e.jsxs("div",{className:"absolute right-0 mt-2 w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-50 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"text-base font-semibold text-white",children:"Corsi da confermare"}),e.jsx("button",{onClick:()=>X(!1),className:"text-gray-400 hover:text-gray-200",children:e.jsx(Et,{className:"h-5 w-5"})})]}),ve.length===0?e.jsx("div",{className:"text-sm text-gray-400",children:"Nessun corso da confermare"}):e.jsx("div",{className:"space-y-3 max-h-64 overflow-y-auto hide-scrollbar",children:ve.map(De=>{const H=De.data_partecipazione||De.data_invito||De.corso_meta&&(De.corso_meta.data_corso||De.corso_meta.data)||null,ae=H?new Date(String(H)).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"}):"‚Äî";return e.jsxs("div",{className:"p-3 bg-gray-900 rounded-lg border border-gray-700",children:[e.jsxs("div",{className:"text-sm font-semibold text-white mb-1",children:["Giorno: ",ae]}),e.jsx("div",{className:"text-sm text-gray-400 mt-1",children:"Clicca sul calendario per i dettagli, oppure conferma la partecipazione direttamente da qui."}),e.jsxs("div",{className:"mt-3 flex items-center space-x-2",children:[e.jsx("button",{className:"bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1.5 rounded disabled:opacity-60 font-medium",onClick:async()=>{await B(De.id),te.filter(Ae=>Ae.stato_invito==="invitato"&&String(Ae.id)!==String(De.id)).length===0&&X(!1)},disabled:!!C[De.id],children:C[De.id]?"Confermo...":"Conferma"}),e.jsx("button",{className:"bg-gray-700 hover:bg-gray-600 text-white text-sm px-3 py-1.5 rounded disabled:opacity-60 font-medium",onClick:async()=>{await ne(De.id),te.filter(Ae=>Ae.stato_invito==="invitato"&&String(Ae.id)!==String(De.id)).length===0&&X(!1)},disabled:!!C[De.id],children:C[De.id]?"Annullo...":"Annulla"})]})]},De.id)})})]})]})]})]}),e.jsx("div",{className:"flex justify-center px-2",children:e.jsxs("div",{className:"inline-flex items-center gap-1.5",children:[e.jsx("button",{onClick:()=>j("month"),className:`px-2.5 py-2 rounded-lg font-medium text-sm transition-colors ${R==="month"?"bg-gray-700 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"}`,children:"Mensile"}),e.jsx("button",{onClick:()=>j("week"),className:`px-2.5 py-2 rounded-lg font-medium text-sm transition-colors ${R==="week"?"bg-gray-700 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"}`,children:"Settimanale"}),e.jsx("button",{onClick:()=>j("day"),className:`px-2.5 py-2 rounded-lg font-medium text-sm transition-colors ${R==="day"?"bg-gray-700 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"}`,children:"Giornaliera"}),e.jsx("button",{onClick:()=>j("agenda"),className:`px-2.5 py-2 rounded-lg font-medium text-sm transition-colors ${R==="agenda"?"bg-green-600 text-white":"bg-green-700 text-white hover:bg-green-600"}`,children:"Agenda"})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700 text-center",children:[e.jsx(xt,{className:"h-7 w-7 mx-auto mb-2 text-blue-400"}),e.jsx("div",{className:"text-2xl font-bold text-white",children:Je}),e.jsx("div",{className:"text-sm text-gray-400",children:"Eventi Assegnati"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700 text-center",children:[e.jsx(Rt,{className:"h-7 w-7 mx-auto mb-2 text-purple-400"}),e.jsx("div",{className:"text-2xl font-bold text-white",children:Qe}),e.jsx("div",{className:"text-sm text-gray-400",children:"Turni Assegnati"})]})]}),R==="month"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[e.jsxs("h2",{className:"text-lg font-semibold text-white",children:[gt[u.getMonth()]," ",u.getFullYear()]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Vista Mensile"})]}),e.jsxs("div",{className:"p-2 md:p-3",children:[e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["Lun","Mar","Mer","Gio","Ven","Sab","Dom"].map(De=>e.jsx("div",{className:"p-1 md:p-2 text-center text-xs md:text-sm font-semibold text-gray-300",children:De},De))}),e.jsx("div",{className:"grid grid-cols-7 gap-1 md:gap-1.5",children:oe(u).map((De,H)=>{let ae="min-h-[70px] md:min-h-[85px] p-1 md:p-1.5 rounded-lg border cursor-pointer transition-colors relative ";return De.isVacationDay?ae+="bg-red-600 text-white border-red-700 shadow-lg ":De.isCurrentMonth?De.isToday?ae+="bg-blue-600 text-white border-blue-700 shadow-lg ":ae+="bg-gray-750 hover:bg-gray-700 border-gray-700 ":ae+="bg-gray-800 text-gray-500 border-gray-700 ",e.jsxs("div",{className:ae,onClick:()=>Fe(me(De.date)),children:[e.jsx("div",{className:"text-xs md:text-sm font-semibold mb-1",children:De.date.getDate()}),De.isVacationDay?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("span",{className:"text-[8px] md:text-xs font-bold text-white uppercase tracking-wider",children:"FERIE"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-0.5",children:[De.events.slice(0,window.innerWidth<768?1:2).map(he=>e.jsx("div",{className:`text-[8px] md:text-[10px] leading-tight px-0.5 md:px-1 py-0.5 rounded text-white truncate font-medium ${he.type==="warehouse"?he.isAssigned?"bg-purple-500":"bg-purple-600 opacity-80":he.type==="event"?he.isAssigned?"bg-blue-500":"bg-blue-600 opacity-80":he.type==="event_travel"?he.isAssigned?"bg-green-500":"bg-green-600 opacity-80":he.isAssigned?"bg-yellow-500":"bg-yellow-600 opacity-80"}`,title:`${he.title} - ${he.isAssigned?"Assegnato":"Non Assegnato"}`,children:he.title},he.id)),De.events.length>(window.innerWidth<768?1:2)&&e.jsxs("div",{className:"text-[8px] md:text-[10px] text-gray-300 px-0.5 md:px-1 font-medium",children:["+",De.events.length-(window.innerWidth<768?1:2)]})]}),e.jsx("div",{className:"absolute top-0.5 md:top-1 right-0.5 md:right-1",children:De.isAvailable?e.jsx(pt,{className:"h-2.5 w-2.5 md:h-3.5 md:w-3.5 text-green-400"}):e.jsx(Zt,{className:"h-2.5 w-2.5 md:h-3.5 md:w-3.5 text-red-400"})})]})]},H)})})]})]})}),R==="agenda"&&e.jsx(e.Fragment,{children:Ve()}),R==="week"&&e.jsx(e.Fragment,{children:Te()}),R==="day"&&e.jsx(e.Fragment,{children:we()}),e.jsx(Jr,{})]}),P&&p&&e.jsx(mc,{date:p,crewEvents:ge(new Date(p+"T12:00:00")),onClose:()=>D(!1),loadColleaguesForEvent:ye})]})},mc=({date:n,crewEvents:l,onClose:c,loadColleaguesForEvent:u})=>{const{user:f}=Pt(),{showSuccess:x,showError:b}=ms(),[v,S]=w.useState({}),[g,E]=w.useState({}),[p,k]=w.useState({});w.useEffect(()=>{let j=!0;return(async()=>{const T={},F={};await Promise.all(l.map(async U=>{if(U.type==="course"){F[U.id]=!1,T[U.id]=[],j&&E({...F});return}F[U.id]=!0,j&&E({...F});try{const te=await u(U),N=[f==null?void 0:f.id,f==null?void 0:f.sub,f==null?void 0:f.uid].filter(Boolean),_=te.filter(V=>!N.includes(V.id));T[U.id]=_}catch(te){console.error("Errore caricamento colleghi per evento:",te),T[U.id]=[]}finally{F[U.id]=!1,j&&E({...F})}})),j&&S(T)})(),()=>{j=!1}},[n,l]);const P=j=>new Date(j+"T12:00:00").toLocaleDateString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),D=async j=>{try{k(T=>({...T,[j]:!0}));const M=window.__confirmCourseHandler;typeof M=="function"?await M(j):b("Errore","Azione non disponibile")}catch(M){console.error("Errore callGlobalConfirm",M),b("Errore","Errore durante la conferma")}finally{k(M=>({...M,[j]:!1}))}},R=async j=>{try{k(T=>({...T,[j]:!0}));const M=window.__cancelCourseHandler;typeof M=="function"?await M(j):b("Errore","Azione non disponibile")}catch(M){console.error("Errore callGlobalCancel",M),b("Errore","Errore durante l'annullamento")}finally{k(M=>({...M,[j]:!1}))}};return e.jsxs("div",{className:"fixed inset-0 bg-gray-900 bg-opacity-95 z-[9999] flex items-center justify-center p-4",children:[e.jsx("style",{children:`
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
      `}),e.jsxs("div",{className:"w-full max-w-3xl max-h-[90vh] overflow-y-auto p-5 space-y-6 hide-scrollbar bg-gray-800 rounded-xl border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-white",children:["Eventi del ",P(n)]}),e.jsx("button",{onClick:c,className:"bg-gray-700 hover:bg-gray-600 p-2.5 rounded-lg transition-colors",children:e.jsx(Et,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"space-y-4",children:[l.length===0&&e.jsxs("div",{className:"text-center py-10 text-gray-400",children:[e.jsx(xt,{className:"h-12 w-12 mx-auto mb-3 text-gray-600"}),e.jsx("p",{className:"text-base",children:"Nessun evento in questa data"})]}),l.map(j=>{var U,te,N,_,V;const M=j.type==="course"?((U=j.raw)==null?void 0:U.corso)||((N=(te=j.raw)==null?void 0:te.assignment)==null?void 0:N.corso)||((_=j.raw)==null?void 0:_.corso):null,T=j.type==="course"&&((V=j.raw)==null?void 0:V.assignment)||null,F=(M==null?void 0:M.materiali)||(Array.isArray(T==null?void 0:T.materiali)?T.materiali:void 0);return e.jsxs("div",{className:"bg-gray-900 rounded-xl p-5 border border-gray-700",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx("h4",{className:"text-lg font-bold text-white",children:j.title}),e.jsx("span",{className:`inline-flex px-2.5 py-1 text-sm font-semibold rounded-full ${j.type==="warehouse"?"bg-purple-100 text-purple-800":j.type==="event"?"bg-blue-100 text-blue-800":j.type==="event_travel"?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"}`,children:j.type==="warehouse"?"Magazzino":j.type==="event"?"Evento":j.type==="event_travel"?"Trasferta":"Corso"})]}),e.jsxs("div",{className:"text-sm text-gray-300 space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{children:j.location})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ht,{className:"h-4 w-4 flex-shrink-0"}),e.jsxs("span",{children:[new Date(j.date).toLocaleDateString("it-IT"),j.endDate&&j.endDate!==j.date?` - ${new Date(j.endDate).toLocaleDateString("it-IT")}`:""]})]}),j.callTime&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ht,{className:"h-4 w-4 flex-shrink-0"}),e.jsxs("span",{children:["Convocazione: ",j.callTime]})]}),j.address&&e.jsx("div",{className:"text-sm text-gray-400 break-words mt-2",children:j.address}),j.description&&e.jsx("div",{className:"text-sm text-gray-400 break-words mt-2",children:j.description})]}),j.type==="course"&&e.jsxs("div",{className:"mt-4 p-4 bg-gray-800 rounded-lg border border-gray-700",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Titolo"}),e.jsx("div",{className:"text-base text-white font-semibold",children:(M==null?void 0:M.titolo)||j.title})]}),(M==null?void 0:M.descrizione)&&e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Descrizione"}),e.jsx("div",{className:"text-sm text-gray-200",children:M.descrizione})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Inizio"}),e.jsx("div",{className:"text-sm text-white font-medium",children:M!=null&&M.ora_inizio?M.ora_inizio.substring?M.ora_inizio.substring(0,5):M.ora_inizio:j.startTime})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Fine"}),e.jsx("div",{className:"text-sm text-white font-medium",children:M!=null&&M.ora_fine?M.ora_fine.substring?M.ora_fine.substring(0,5):M.ora_fine:j.endTime})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Luogo"}),e.jsx("div",{className:"text-sm text-white font-medium",children:(M==null?void 0:M.luogo)||j.location})]}),(M==null?void 0:M.istruttore)&&e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Istruttore"}),e.jsx("div",{className:"text-sm text-white font-medium",children:M.istruttore})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 items-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Categoria"}),e.jsx("div",{className:"text-sm text-white font-medium",children:(M==null?void 0:M.categoria)||"‚Äî"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Obbligatorio"}),e.jsx("div",{className:"text-sm text-white font-medium",children:M!=null&&M.obbligatorio?"S√¨":"No"})]})]}),F&&(Array.isArray(F)?F.length>0:!!F)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-xs text-gray-400",children:"Richieste / Materiali"}),Array.isArray(F)?e.jsx("ul",{className:"mt-2 list-disc pl-5 text-sm text-gray-200",children:F.map((C,K)=>e.jsx("li",{className:"break-words",children:String(C)},K))}):e.jsx("div",{className:"text-sm text-gray-200 mt-2",children:String(F)})]}),(M==null?void 0:M.note)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-xs text-gray-400",children:"Note del corso"}),e.jsx("div",{className:"text-sm text-gray-200 mt-1",children:M.note})]}),T&&e.jsxs("div",{className:"mt-4 flex items-center space-x-3",children:[T.stato_invito==="invitato"&&e.jsx("button",{className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded disabled:opacity-60",onClick:()=>D(T.id),disabled:!!p[T.id],children:p[T.id]?"Confermo...":"Conferma partecipazione"}),T.stato_invito==="confermato"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-green-300",children:"Partecipazione confermata"}),e.jsx("button",{className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded disabled:opacity-60",onClick:()=>R(T.id),disabled:!!p[T.id],children:p[T.id]?"Annullo...":"Annulla Partecipazione"})]}),T.stato_invito==="rifiutato"&&e.jsx("div",{className:"text-sm text-yellow-300",children:"Hai rifiutato la partecipazione"})]})]})]})}),e.jsx("div",{className:"mt-4",children:j.type!=="course"?g[j.id]?e.jsx("div",{className:"text-sm text-gray-400",children:"Caricamento partecipanti..."}):v[j.id]&&v[j.id].length>0?e.jsxs("div",{className:"mt-2 p-3 bg-gray-800 rounded-lg text-sm text-gray-200 max-h-48 overflow-y-auto hide-scrollbar",children:[e.jsx("strong",{className:"text-base",children:"Partecipanti confermati:"}),e.jsx("ul",{className:"mt-2 space-y-1 list-disc pl-5 text-sm",children:v[j.id].map(C=>e.jsx("li",{className:"break-words",children:C.name},C.id))})]}):e.jsx("div",{className:"mt-2 text-sm text-gray-400",children:"Nessun altro membro assegnato trovato."}):null})]},j.id)})]})]})]})};var tt;(function(n){n[n.QR_CODE=0]="QR_CODE",n[n.AZTEC=1]="AZTEC",n[n.CODABAR=2]="CODABAR",n[n.CODE_39=3]="CODE_39",n[n.CODE_93=4]="CODE_93",n[n.CODE_128=5]="CODE_128",n[n.DATA_MATRIX=6]="DATA_MATRIX",n[n.MAXICODE=7]="MAXICODE",n[n.ITF=8]="ITF",n[n.EAN_13=9]="EAN_13",n[n.EAN_8=10]="EAN_8",n[n.PDF_417=11]="PDF_417",n[n.RSS_14=12]="RSS_14",n[n.RSS_EXPANDED=13]="RSS_EXPANDED",n[n.UPC_A=14]="UPC_A",n[n.UPC_E=15]="UPC_E",n[n.UPC_EAN_EXTENSION=16]="UPC_EAN_EXTENSION"})(tt||(tt={}));var Ln=new Map([[tt.QR_CODE,"QR_CODE"],[tt.AZTEC,"AZTEC"],[tt.CODABAR,"CODABAR"],[tt.CODE_39,"CODE_39"],[tt.CODE_93,"CODE_93"],[tt.CODE_128,"CODE_128"],[tt.DATA_MATRIX,"DATA_MATRIX"],[tt.MAXICODE,"MAXICODE"],[tt.ITF,"ITF"],[tt.EAN_13,"EAN_13"],[tt.EAN_8,"EAN_8"],[tt.PDF_417,"PDF_417"],[tt.RSS_14,"RSS_14"],[tt.RSS_EXPANDED,"RSS_EXPANDED"],[tt.UPC_A,"UPC_A"],[tt.UPC_E,"UPC_E"],[tt.UPC_EAN_EXTENSION,"UPC_EAN_EXTENSION"]]),Pn;(function(n){n[n.UNKNOWN=0]="UNKNOWN",n[n.URL=1]="URL"})(Pn||(Pn={}));function fc(n){return Object.values(tt).includes(n)}var lr;(function(n){n[n.SCAN_TYPE_CAMERA=0]="SCAN_TYPE_CAMERA",n[n.SCAN_TYPE_FILE=1]="SCAN_TYPE_FILE"})(lr||(lr={}));var Rs=function(){function n(){}return n.GITHUB_PROJECT_URL="https://github.com/mebjas/html5-qrcode",n.SCAN_DEFAULT_FPS=2,n.DEFAULT_DISABLE_FLIP=!1,n.DEFAULT_REMEMBER_LAST_CAMERA_USED=!0,n.DEFAULT_SUPPORTED_SCAN_TYPE=[lr.SCAN_TYPE_CAMERA,lr.SCAN_TYPE_FILE],n}(),Di=function(){function n(l,c){this.format=l,this.formatName=c}return n.prototype.toString=function(){return this.formatName},n.create=function(l){if(!Ln.has(l))throw"".concat(l," not in html5QrcodeSupportedFormatsTextMap");return new n(l,Ln.get(l))},n}(),Bn=function(){function n(){}return n.createFromText=function(l){var c={text:l};return{decodedText:l,result:c}},n.createFromQrcodeResult=function(l){return{decodedText:l.text,result:l}},n}(),Za;(function(n){n[n.UNKWOWN_ERROR=0]="UNKWOWN_ERROR",n[n.IMPLEMENTATION_ERROR=1]="IMPLEMENTATION_ERROR",n[n.NO_CODE_FOUND_ERROR=2]="NO_CODE_FOUND_ERROR"})(Za||(Za={}));var ki=function(){function n(){}return n.createFrom=function(l){return{errorMessage:l,type:Za.UNKWOWN_ERROR}},n}(),Mi=function(){function n(l){this.verbose=l}return n.prototype.log=function(l){this.verbose&&console.log(l)},n.prototype.warn=function(l){this.verbose&&console.warn(l)},n.prototype.logError=function(l,c){(this.verbose||c===!0)&&console.error(l)},n.prototype.logErrors=function(l){if(l.length===0)throw"Logger#logError called without arguments";this.verbose&&console.error(l)},n}();function Vs(n){return typeof n>"u"||n===null}function gc(n,l,c){return n>c?c:n<l?l:n}var Er=function(){function n(){}return n.codeParseError=function(l){return"QR code parse error, error = ".concat(l)},n.errorGettingUserMedia=function(l){return"Error getting userMedia, error = ".concat(l)},n.onlyDeviceSupportedError=function(){return"The device doesn't support navigator.mediaDevices , only supported cameraIdOrConfig in this case is deviceId parameter (string)."},n.cameraStreamingNotSupported=function(){return"Camera streaming not supported by the browser."},n.unableToQuerySupportedDevices=function(){return"Unable to query supported devices, unknown error."},n.insecureContextCameraQueryError=function(){return"Camera access is only supported in secure context like https or localhost."},n.scannerPaused=function(){return"Scanner paused"},n}(),Dt=function(){function n(){}return n.scanningStatus=function(){return"Scanning"},n.idleStatus=function(){return"Idle"},n.errorStatus=function(){return"Error"},n.permissionStatus=function(){return"Permission"},n.noCameraFoundErrorStatus=function(){return"No Cameras"},n.lastMatch=function(l){return"Last Match: ".concat(l)},n.codeScannerTitle=function(){return"Code Scanner"},n.cameraPermissionTitle=function(){return"Request Camera Permissions"},n.cameraPermissionRequesting=function(){return"Requesting camera permissions..."},n.noCameraFound=function(){return"No camera found"},n.scanButtonStopScanningText=function(){return"Stop Scanning"},n.scanButtonStartScanningText=function(){return"Start Scanning"},n.torchOnButton=function(){return"Switch On Torch"},n.torchOffButton=function(){return"Switch Off Torch"},n.torchOnFailedMessage=function(){return"Failed to turn on torch"},n.torchOffFailedMessage=function(){return"Failed to turn off torch"},n.scanButtonScanningStarting=function(){return"Launching Camera..."},n.textIfCameraScanSelected=function(){return"Scan an Image File"},n.textIfFileScanSelected=function(){return"Scan using camera directly"},n.selectCamera=function(){return"Select Camera"},n.fileSelectionChooseImage=function(){return"Choose Image"},n.fileSelectionChooseAnother=function(){return"Choose Another"},n.fileSelectionNoImageSelected=function(){return"No image choosen"},n.anonymousCameraPrefix=function(){return"Anonymous Camera"},n.dragAndDropMessage=function(){return"Or drop an image to scan"},n.dragAndDropMessageOnlyImages=function(){return"Or drop an image to scan (other files not supported)"},n.zoom=function(){return"zoom"},n.loadingImage=function(){return"Loading image..."},n.cameraScanAltText=function(){return"Camera based scan"},n.fileScanAltText=function(){return"Fule based scan"},n}(),Fn=function(){function n(){}return n.poweredBy=function(){return"Powered by "},n.reportIssues=function(){return"Report issues"},n}(),zi=function(){function n(){}return n.isMediaStreamConstraintsValid=function(l,c){if(typeof l!="object"){var u=typeof l;return c.logError("videoConstraints should be of type object, the "+"object passed is of type ".concat(u,"."),!0),!1}for(var f=["autoGainControl","channelCount","echoCancellation","latency","noiseSuppression","sampleRate","sampleSize","volume"],x=new Set(f),b=Object.keys(l),v=0,S=b;v<S.length;v++){var g=S[v];if(x.has(g))return c.logError("".concat(g," is not supported videoConstaints."),!0),!1}return!0},n}(),Qa={exports:{}};(function(n,l){(function(c,u){u(l)})(Vr,function(c){function u(A){return A==null}var f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(A,t){A.__proto__=t}||function(A,t){for(var s in t)t.hasOwnProperty(s)&&(A[s]=t[s])};function x(A,t){f(A,t);function s(){this.constructor=A}A.prototype=t===null?Object.create(t):(s.prototype=t.prototype,new s)}function b(A,t){var s=Object.setPrototypeOf;s?s(A,t):A.__proto__=t}function v(A,t){t===void 0&&(t=A.constructor);var s=Error.captureStackTrace;s&&s(A,t)}var S=function(A){x(t,A);function t(s){var r=this.constructor,a=A.call(this,s)||this;return Object.defineProperty(a,"name",{value:r.name,enumerable:!1}),b(a,r.prototype),v(a),a}return t}(Error);class g extends S{constructor(t=void 0){super(t),this.message=t}getKind(){return this.constructor.kind}}g.kind="Exception";class E extends g{}E.kind="ArgumentException";class p extends g{}p.kind="IllegalArgumentException";class k{constructor(t){if(this.binarizer=t,t===null)throw new p("Binarizer must be non-null.")}getWidth(){return this.binarizer.getWidth()}getHeight(){return this.binarizer.getHeight()}getBlackRow(t,s){return this.binarizer.getBlackRow(t,s)}getBlackMatrix(){return(this.matrix===null||this.matrix===void 0)&&(this.matrix=this.binarizer.getBlackMatrix()),this.matrix}isCropSupported(){return this.binarizer.getLuminanceSource().isCropSupported()}crop(t,s,r,a){const i=this.binarizer.getLuminanceSource().crop(t,s,r,a);return new k(this.binarizer.createBinarizer(i))}isRotateSupported(){return this.binarizer.getLuminanceSource().isRotateSupported()}rotateCounterClockwise(){const t=this.binarizer.getLuminanceSource().rotateCounterClockwise();return new k(this.binarizer.createBinarizer(t))}rotateCounterClockwise45(){const t=this.binarizer.getLuminanceSource().rotateCounterClockwise45();return new k(this.binarizer.createBinarizer(t))}toString(){try{return this.getBlackMatrix().toString()}catch{return""}}}class P extends g{static getChecksumInstance(){return new P}}P.kind="ChecksumException";class D{constructor(t){this.source=t}getLuminanceSource(){return this.source}getWidth(){return this.source.getWidth()}getHeight(){return this.source.getHeight()}}class R{static arraycopy(t,s,r,a,i){for(;i--;)r[a++]=t[s++]}static currentTimeMillis(){return Date.now()}}class j extends g{}j.kind="IndexOutOfBoundsException";class M extends j{constructor(t=void 0,s=void 0){super(s),this.index=t,this.message=s}}M.kind="ArrayIndexOutOfBoundsException";class T{static fill(t,s){for(let r=0,a=t.length;r<a;r++)t[r]=s}static fillWithin(t,s,r,a){T.rangeCheck(t.length,s,r);for(let i=s;i<r;i++)t[i]=a}static rangeCheck(t,s,r){if(s>r)throw new p("fromIndex("+s+") > toIndex("+r+")");if(s<0)throw new M(s);if(r>t)throw new M(r)}static asList(...t){return t}static create(t,s,r){return Array.from({length:t}).map(i=>Array.from({length:s}).fill(r))}static createInt32Array(t,s,r){return Array.from({length:t}).map(i=>Int32Array.from({length:s}).fill(r))}static equals(t,s){if(!t||!s||!t.length||!s.length||t.length!==s.length)return!1;for(let r=0,a=t.length;r<a;r++)if(t[r]!==s[r])return!1;return!0}static hashCode(t){if(t===null)return 0;let s=1;for(const r of t)s=31*s+r;return s}static fillUint8Array(t,s){for(let r=0;r!==t.length;r++)t[r]=s}static copyOf(t,s){return t.slice(0,s)}static copyOfUint8Array(t,s){if(t.length<=s){const r=new Uint8Array(s);return r.set(t),r}return t.slice(0,s)}static copyOfRange(t,s,r){const a=r-s,i=new Int32Array(a);return R.arraycopy(t,s,i,0,a),i}static binarySearch(t,s,r){r===void 0&&(r=T.numberComparator);let a=0,i=t.length-1;for(;a<=i;){const o=i+a>>1,d=r(s,t[o]);if(d>0)a=o+1;else if(d<0)i=o-1;else return o}return-a-1}static numberComparator(t,s){return t-s}}class F{static numberOfTrailingZeros(t){let s;if(t===0)return 32;let r=31;return s=t<<16,s!==0&&(r-=16,t=s),s=t<<8,s!==0&&(r-=8,t=s),s=t<<4,s!==0&&(r-=4,t=s),s=t<<2,s!==0&&(r-=2,t=s),r-(t<<1>>>31)}static numberOfLeadingZeros(t){if(t===0)return 32;let s=1;return t>>>16||(s+=16,t<<=16),t>>>24||(s+=8,t<<=8),t>>>28||(s+=4,t<<=4),t>>>30||(s+=2,t<<=2),s-=t>>>31,s}static toHexString(t){return t.toString(16)}static toBinaryString(t){return String(parseInt(String(t),2))}static bitCount(t){return t=t-(t>>>1&1431655765),t=(t&858993459)+(t>>>2&858993459),t=t+(t>>>4)&252645135,t=t+(t>>>8),t=t+(t>>>16),t&63}static truncDivision(t,s){return Math.trunc(t/s)}static parseInt(t,s=void 0){return parseInt(t,s)}}F.MIN_VALUE_32_BITS=-2147483648,F.MAX_VALUE=Number.MAX_SAFE_INTEGER;class U{constructor(t,s){t===void 0?(this.size=0,this.bits=new Int32Array(1)):(this.size=t,s==null?this.bits=U.makeArray(t):this.bits=s)}getSize(){return this.size}getSizeInBytes(){return Math.floor((this.size+7)/8)}ensureCapacity(t){if(t>this.bits.length*32){const s=U.makeArray(t);R.arraycopy(this.bits,0,s,0,this.bits.length),this.bits=s}}get(t){return(this.bits[Math.floor(t/32)]&1<<(t&31))!==0}set(t){this.bits[Math.floor(t/32)]|=1<<(t&31)}flip(t){this.bits[Math.floor(t/32)]^=1<<(t&31)}getNextSet(t){const s=this.size;if(t>=s)return s;const r=this.bits;let a=Math.floor(t/32),i=r[a];i&=~((1<<(t&31))-1);const o=r.length;for(;i===0;){if(++a===o)return s;i=r[a]}const d=a*32+F.numberOfTrailingZeros(i);return d>s?s:d}getNextUnset(t){const s=this.size;if(t>=s)return s;const r=this.bits;let a=Math.floor(t/32),i=~r[a];i&=~((1<<(t&31))-1);const o=r.length;for(;i===0;){if(++a===o)return s;i=~r[a]}const d=a*32+F.numberOfTrailingZeros(i);return d>s?s:d}setBulk(t,s){this.bits[Math.floor(t/32)]=s}setRange(t,s){if(s<t||t<0||s>this.size)throw new p;if(s===t)return;s--;const r=Math.floor(t/32),a=Math.floor(s/32),i=this.bits;for(let o=r;o<=a;o++){const d=o>r?0:t&31,m=(2<<(o<a?31:s&31))-(1<<d);i[o]|=m}}clear(){const t=this.bits.length,s=this.bits;for(let r=0;r<t;r++)s[r]=0}isRange(t,s,r){if(s<t||t<0||s>this.size)throw new p;if(s===t)return!0;s--;const a=Math.floor(t/32),i=Math.floor(s/32),o=this.bits;for(let d=a;d<=i;d++){const h=d>a?0:t&31,y=(2<<(d<i?31:s&31))-(1<<h)&4294967295;if((o[d]&y)!==(r?y:0))return!1}return!0}appendBit(t){this.ensureCapacity(this.size+1),t&&(this.bits[Math.floor(this.size/32)]|=1<<(this.size&31)),this.size++}appendBits(t,s){if(s<0||s>32)throw new p("Num bits must be between 0 and 32");this.ensureCapacity(this.size+s);for(let r=s;r>0;r--)this.appendBit((t>>r-1&1)===1)}appendBitArray(t){const s=t.size;this.ensureCapacity(this.size+s);for(let r=0;r<s;r++)this.appendBit(t.get(r))}xor(t){if(this.size!==t.size)throw new p("Sizes don't match");const s=this.bits;for(let r=0,a=s.length;r<a;r++)s[r]^=t.bits[r]}toBytes(t,s,r,a){for(let i=0;i<a;i++){let o=0;for(let d=0;d<8;d++)this.get(t)&&(o|=1<<7-d),t++;s[r+i]=o}}getBitArray(){return this.bits}reverse(){const t=new Int32Array(this.bits.length),s=Math.floor((this.size-1)/32),r=s+1,a=this.bits;for(let i=0;i<r;i++){let o=a[i];o=o>>1&1431655765|(o&1431655765)<<1,o=o>>2&858993459|(o&858993459)<<2,o=o>>4&252645135|(o&252645135)<<4,o=o>>8&16711935|(o&16711935)<<8,o=o>>16&65535|(o&65535)<<16,t[s-i]=o}if(this.size!==r*32){const i=r*32-this.size;let o=t[0]>>>i;for(let d=1;d<r;d++){const h=t[d];o|=h<<32-i,t[d-1]=o,o=h>>>i}t[r-1]=o}this.bits=t}static makeArray(t){return new Int32Array(Math.floor((t+31)/32))}equals(t){if(!(t instanceof U))return!1;const s=t;return this.size===s.size&&T.equals(this.bits,s.bits)}hashCode(){return 31*this.size+T.hashCode(this.bits)}toString(){let t="";for(let s=0,r=this.size;s<r;s++)s&7||(t+=" "),t+=this.get(s)?"X":".";return t}clone(){return new U(this.size,this.bits.slice())}}var te;(function(A){A[A.OTHER=0]="OTHER",A[A.PURE_BARCODE=1]="PURE_BARCODE",A[A.POSSIBLE_FORMATS=2]="POSSIBLE_FORMATS",A[A.TRY_HARDER=3]="TRY_HARDER",A[A.CHARACTER_SET=4]="CHARACTER_SET",A[A.ALLOWED_LENGTHS=5]="ALLOWED_LENGTHS",A[A.ASSUME_CODE_39_CHECK_DIGIT=6]="ASSUME_CODE_39_CHECK_DIGIT",A[A.ASSUME_GS1=7]="ASSUME_GS1",A[A.RETURN_CODABAR_START_END=8]="RETURN_CODABAR_START_END",A[A.NEED_RESULT_POINT_CALLBACK=9]="NEED_RESULT_POINT_CALLBACK",A[A.ALLOWED_EAN_EXTENSIONS=10]="ALLOWED_EAN_EXTENSIONS"})(te||(te={}));var N=te;class _ extends g{static getFormatInstance(){return new _}}_.kind="FormatException";var V;(function(A){A[A.Cp437=0]="Cp437",A[A.ISO8859_1=1]="ISO8859_1",A[A.ISO8859_2=2]="ISO8859_2",A[A.ISO8859_3=3]="ISO8859_3",A[A.ISO8859_4=4]="ISO8859_4",A[A.ISO8859_5=5]="ISO8859_5",A[A.ISO8859_6=6]="ISO8859_6",A[A.ISO8859_7=7]="ISO8859_7",A[A.ISO8859_8=8]="ISO8859_8",A[A.ISO8859_9=9]="ISO8859_9",A[A.ISO8859_10=10]="ISO8859_10",A[A.ISO8859_11=11]="ISO8859_11",A[A.ISO8859_13=12]="ISO8859_13",A[A.ISO8859_14=13]="ISO8859_14",A[A.ISO8859_15=14]="ISO8859_15",A[A.ISO8859_16=15]="ISO8859_16",A[A.SJIS=16]="SJIS",A[A.Cp1250=17]="Cp1250",A[A.Cp1251=18]="Cp1251",A[A.Cp1252=19]="Cp1252",A[A.Cp1256=20]="Cp1256",A[A.UnicodeBigUnmarked=21]="UnicodeBigUnmarked",A[A.UTF8=22]="UTF8",A[A.ASCII=23]="ASCII",A[A.Big5=24]="Big5",A[A.GB18030=25]="GB18030",A[A.EUC_KR=26]="EUC_KR"})(V||(V={}));class C{constructor(t,s,r,...a){this.valueIdentifier=t,this.name=r,typeof s=="number"?this.values=Int32Array.from([s]):this.values=s,this.otherEncodingNames=a,C.VALUE_IDENTIFIER_TO_ECI.set(t,this),C.NAME_TO_ECI.set(r,this);const i=this.values;for(let o=0,d=i.length;o!==d;o++){const h=i[o];C.VALUES_TO_ECI.set(h,this)}for(const o of a)C.NAME_TO_ECI.set(o,this)}getValueIdentifier(){return this.valueIdentifier}getName(){return this.name}getValue(){return this.values[0]}static getCharacterSetECIByValue(t){if(t<0||t>=900)throw new _("incorect value");const s=C.VALUES_TO_ECI.get(t);if(s===void 0)throw new _("incorect value");return s}static getCharacterSetECIByName(t){const s=C.NAME_TO_ECI.get(t);if(s===void 0)throw new _("incorect value");return s}equals(t){if(!(t instanceof C))return!1;const s=t;return this.getName()===s.getName()}}C.VALUE_IDENTIFIER_TO_ECI=new Map,C.VALUES_TO_ECI=new Map,C.NAME_TO_ECI=new Map,C.Cp437=new C(V.Cp437,Int32Array.from([0,2]),"Cp437"),C.ISO8859_1=new C(V.ISO8859_1,Int32Array.from([1,3]),"ISO-8859-1","ISO88591","ISO8859_1"),C.ISO8859_2=new C(V.ISO8859_2,4,"ISO-8859-2","ISO88592","ISO8859_2"),C.ISO8859_3=new C(V.ISO8859_3,5,"ISO-8859-3","ISO88593","ISO8859_3"),C.ISO8859_4=new C(V.ISO8859_4,6,"ISO-8859-4","ISO88594","ISO8859_4"),C.ISO8859_5=new C(V.ISO8859_5,7,"ISO-8859-5","ISO88595","ISO8859_5"),C.ISO8859_6=new C(V.ISO8859_6,8,"ISO-8859-6","ISO88596","ISO8859_6"),C.ISO8859_7=new C(V.ISO8859_7,9,"ISO-8859-7","ISO88597","ISO8859_7"),C.ISO8859_8=new C(V.ISO8859_8,10,"ISO-8859-8","ISO88598","ISO8859_8"),C.ISO8859_9=new C(V.ISO8859_9,11,"ISO-8859-9","ISO88599","ISO8859_9"),C.ISO8859_10=new C(V.ISO8859_10,12,"ISO-8859-10","ISO885910","ISO8859_10"),C.ISO8859_11=new C(V.ISO8859_11,13,"ISO-8859-11","ISO885911","ISO8859_11"),C.ISO8859_13=new C(V.ISO8859_13,15,"ISO-8859-13","ISO885913","ISO8859_13"),C.ISO8859_14=new C(V.ISO8859_14,16,"ISO-8859-14","ISO885914","ISO8859_14"),C.ISO8859_15=new C(V.ISO8859_15,17,"ISO-8859-15","ISO885915","ISO8859_15"),C.ISO8859_16=new C(V.ISO8859_16,18,"ISO-8859-16","ISO885916","ISO8859_16"),C.SJIS=new C(V.SJIS,20,"SJIS","Shift_JIS"),C.Cp1250=new C(V.Cp1250,21,"Cp1250","windows-1250"),C.Cp1251=new C(V.Cp1251,22,"Cp1251","windows-1251"),C.Cp1252=new C(V.Cp1252,23,"Cp1252","windows-1252"),C.Cp1256=new C(V.Cp1256,24,"Cp1256","windows-1256"),C.UnicodeBigUnmarked=new C(V.UnicodeBigUnmarked,25,"UnicodeBigUnmarked","UTF-16BE","UnicodeBig"),C.UTF8=new C(V.UTF8,26,"UTF8","UTF-8"),C.ASCII=new C(V.ASCII,Int32Array.from([27,170]),"ASCII","US-ASCII"),C.Big5=new C(V.Big5,28,"Big5"),C.GB18030=new C(V.GB18030,29,"GB18030","GB2312","EUC_CN","GBK"),C.EUC_KR=new C(V.EUC_KR,30,"EUC_KR","EUC-KR");class K extends g{}K.kind="UnsupportedOperationException";class O{static decode(t,s){const r=this.encodingName(s);return this.customDecoder?this.customDecoder(t,r):typeof TextDecoder>"u"||this.shouldDecodeOnFallback(r)?this.decodeFallback(t,r):new TextDecoder(r).decode(t)}static shouldDecodeOnFallback(t){return!O.isBrowser()&&t==="ISO-8859-1"}static encode(t,s){const r=this.encodingName(s);return this.customEncoder?this.customEncoder(t,r):typeof TextEncoder>"u"?this.encodeFallback(t):new TextEncoder().encode(t)}static isBrowser(){return typeof window<"u"&&{}.toString.call(window)==="[object Window]"}static encodingName(t){return typeof t=="string"?t:t.getName()}static encodingCharacterSet(t){return t instanceof C?t:C.getCharacterSetECIByName(t)}static decodeFallback(t,s){const r=this.encodingCharacterSet(s);if(O.isDecodeFallbackSupported(r)){let a="";for(let i=0,o=t.length;i<o;i++){let d=t[i].toString(16);d.length<2&&(d="0"+d),a+="%"+d}return decodeURIComponent(a)}if(r.equals(C.UnicodeBigUnmarked))return String.fromCharCode.apply(null,new Uint16Array(t.buffer));throw new K(`Encoding ${this.encodingName(s)} not supported by fallback.`)}static isDecodeFallbackSupported(t){return t.equals(C.UTF8)||t.equals(C.ISO8859_1)||t.equals(C.ASCII)}static encodeFallback(t){const r=btoa(unescape(encodeURIComponent(t))).split(""),a=[];for(let i=0;i<r.length;i++)a.push(r[i].charCodeAt(0));return new Uint8Array(a)}}class X{static castAsNonUtf8Char(t,s=null){const r=s?s.getName():this.ISO88591;return O.decode(new Uint8Array([t]),r)}static guessEncoding(t,s){if(s!=null&&s.get(N.CHARACTER_SET)!==void 0)return s.get(N.CHARACTER_SET).toString();const r=t.length;let a=!0,i=!0,o=!0,d=0,h=0,m=0,y=0,I=0,z=0,Y=0,ie=0,ce=0,Ne=0,ze=0;const Ge=t.length>3&&t[0]===239&&t[1]===187&&t[2]===191;for(let Ye=0;Ye<r&&(a||i||o);Ye++){const Ue=t[Ye]&255;o&&(d>0?Ue&128?d--:o=!1:Ue&128&&(Ue&64?(d++,Ue&32?(d++,Ue&16?(d++,Ue&8?o=!1:y++):m++):h++):o=!1)),a&&(Ue>127&&Ue<160?a=!1:Ue>159&&(Ue<192||Ue===215||Ue===247)&&ze++),i&&(I>0?Ue<64||Ue===127||Ue>252?i=!1:I--:Ue===128||Ue===160||Ue>239?i=!1:Ue>160&&Ue<224?(z++,ie=0,Y++,Y>ce&&(ce=Y)):Ue>127?(I++,Y=0,ie++,ie>Ne&&(Ne=ie)):(Y=0,ie=0))}return o&&d>0&&(o=!1),i&&I>0&&(i=!1),o&&(Ge||h+m+y>0)?X.UTF8:i&&(X.ASSUME_SHIFT_JIS||ce>=3||Ne>=3)?X.SHIFT_JIS:a&&i?ce===2&&z===2||ze*10>=r?X.SHIFT_JIS:X.ISO88591:a?X.ISO88591:i?X.SHIFT_JIS:o?X.UTF8:X.PLATFORM_DEFAULT_ENCODING}static format(t,...s){let r=-1;function a(o,d,h,m,y,I){if(o==="%%")return"%";if(s[++r]===void 0)return;o=m?parseInt(m.substr(1)):void 0;let z=y?parseInt(y.substr(1)):void 0,Y;switch(I){case"s":Y=s[r];break;case"c":Y=s[r][0];break;case"f":Y=parseFloat(s[r]).toFixed(o);break;case"p":Y=parseFloat(s[r]).toPrecision(o);break;case"e":Y=parseFloat(s[r]).toExponential(o);break;case"x":Y=parseInt(s[r]).toString(z||16);break;case"d":Y=parseFloat(parseInt(s[r],z||10).toPrecision(o)).toFixed(0);break}Y=typeof Y=="object"?JSON.stringify(Y):(+Y).toString(z);let ie=parseInt(h),ce=h&&h[0]+""=="0"?"0":" ";for(;Y.length<ie;)Y=d!==void 0?Y+ce:ce+Y;return Y}let i=/%(-)?(0?[0-9]+)?([.][0-9]+)?([#][0-9]+)?([scfpexd%])/g;return t.replace(i,a)}static getBytes(t,s){return O.encode(t,s)}static getCharCode(t,s=0){return t.charCodeAt(s)}static getCharAt(t){return String.fromCharCode(t)}}X.SHIFT_JIS=C.SJIS.getName(),X.GB2312="GB2312",X.ISO88591=C.ISO8859_1.getName(),X.EUC_JP="EUC_JP",X.UTF8=C.UTF8.getName(),X.PLATFORM_DEFAULT_ENCODING=X.UTF8,X.ASSUME_SHIFT_JIS=!1;class se{constructor(t=""){this.value=t}enableDecoding(t){return this.encoding=t,this}append(t){return typeof t=="string"?this.value+=t.toString():this.encoding?this.value+=X.castAsNonUtf8Char(t,this.encoding):this.value+=String.fromCharCode(t),this}appendChars(t,s,r){for(let a=s;s<s+r;a++)this.append(t[a]);return this}length(){return this.value.length}charAt(t){return this.value.charAt(t)}deleteCharAt(t){this.value=this.value.substr(0,t)+this.value.substring(t+1)}setCharAt(t,s){this.value=this.value.substr(0,t)+s+this.value.substr(t+1)}substring(t,s){return this.value.substring(t,s)}setLengthToZero(){this.value=""}toString(){return this.value}insert(t,s){this.value=this.value.substr(0,t)+s+this.value.substr(t+s.length)}}class W{constructor(t,s,r,a){if(this.width=t,this.height=s,this.rowSize=r,this.bits=a,s==null&&(s=t),this.height=s,t<1||s<1)throw new p("Both dimensions must be greater than 0");r==null&&(r=Math.floor((t+31)/32)),this.rowSize=r,a==null&&(this.bits=new Int32Array(this.rowSize*this.height))}static parseFromBooleanArray(t){const s=t.length,r=t[0].length,a=new W(r,s);for(let i=0;i<s;i++){const o=t[i];for(let d=0;d<r;d++)o[d]&&a.set(d,i)}return a}static parseFromString(t,s,r){if(t===null)throw new p("stringRepresentation cannot be null");const a=new Array(t.length);let i=0,o=0,d=-1,h=0,m=0;for(;m<t.length;)if(t.charAt(m)===`
`||t.charAt(m)==="\r"){if(i>o){if(d===-1)d=i-o;else if(i-o!==d)throw new p("row lengths do not match");o=i,h++}m++}else if(t.substring(m,m+s.length)===s)m+=s.length,a[i]=!0,i++;else if(t.substring(m,m+r.length)===r)m+=r.length,a[i]=!1,i++;else throw new p("illegal character encountered: "+t.substring(m));if(i>o){if(d===-1)d=i-o;else if(i-o!==d)throw new p("row lengths do not match");h++}const y=new W(d,h);for(let I=0;I<i;I++)a[I]&&y.set(Math.floor(I%d),Math.floor(I/d));return y}get(t,s){const r=s*this.rowSize+Math.floor(t/32);return(this.bits[r]>>>(t&31)&1)!==0}set(t,s){const r=s*this.rowSize+Math.floor(t/32);this.bits[r]|=1<<(t&31)&4294967295}unset(t,s){const r=s*this.rowSize+Math.floor(t/32);this.bits[r]&=~(1<<(t&31)&4294967295)}flip(t,s){const r=s*this.rowSize+Math.floor(t/32);this.bits[r]^=1<<(t&31)&4294967295}xor(t){if(this.width!==t.getWidth()||this.height!==t.getHeight()||this.rowSize!==t.getRowSize())throw new p("input matrix dimensions do not match");const s=new U(Math.floor(this.width/32)+1),r=this.rowSize,a=this.bits;for(let i=0,o=this.height;i<o;i++){const d=i*r,h=t.getRow(i,s).getBitArray();for(let m=0;m<r;m++)a[d+m]^=h[m]}}clear(){const t=this.bits,s=t.length;for(let r=0;r<s;r++)t[r]=0}setRegion(t,s,r,a){if(s<0||t<0)throw new p("Left and top must be nonnegative");if(a<1||r<1)throw new p("Height and width must be at least 1");const i=t+r,o=s+a;if(o>this.height||i>this.width)throw new p("The region must fit inside the matrix");const d=this.rowSize,h=this.bits;for(let m=s;m<o;m++){const y=m*d;for(let I=t;I<i;I++)h[y+Math.floor(I/32)]|=1<<(I&31)&4294967295}}getRow(t,s){s==null||s.getSize()<this.width?s=new U(this.width):s.clear();const r=this.rowSize,a=this.bits,i=t*r;for(let o=0;o<r;o++)s.setBulk(o*32,a[i+o]);return s}setRow(t,s){R.arraycopy(s.getBitArray(),0,this.bits,t*this.rowSize,this.rowSize)}rotate180(){const t=this.getWidth(),s=this.getHeight();let r=new U(t),a=new U(t);for(let i=0,o=Math.floor((s+1)/2);i<o;i++)r=this.getRow(i,r),a=this.getRow(s-1-i,a),r.reverse(),a.reverse(),this.setRow(i,a),this.setRow(s-1-i,r)}getEnclosingRectangle(){const t=this.width,s=this.height,r=this.rowSize,a=this.bits;let i=t,o=s,d=-1,h=-1;for(let m=0;m<s;m++)for(let y=0;y<r;y++){const I=a[m*r+y];if(I!==0){if(m<o&&(o=m),m>h&&(h=m),y*32<i){let z=0;for(;!(I<<31-z&4294967295);)z++;y*32+z<i&&(i=y*32+z)}if(y*32+31>d){let z=31;for(;!(I>>>z);)z--;y*32+z>d&&(d=y*32+z)}}}return d<i||h<o?null:Int32Array.from([i,o,d-i+1,h-o+1])}getTopLeftOnBit(){const t=this.rowSize,s=this.bits;let r=0;for(;r<s.length&&s[r]===0;)r++;if(r===s.length)return null;const a=r/t;let i=r%t*32;const o=s[r];let d=0;for(;!(o<<31-d&4294967295);)d++;return i+=d,Int32Array.from([i,a])}getBottomRightOnBit(){const t=this.rowSize,s=this.bits;let r=s.length-1;for(;r>=0&&s[r]===0;)r--;if(r<0)return null;const a=Math.floor(r/t);let i=Math.floor(r%t)*32;const o=s[r];let d=31;for(;!(o>>>d);)d--;return i+=d,Int32Array.from([i,a])}getWidth(){return this.width}getHeight(){return this.height}getRowSize(){return this.rowSize}equals(t){if(!(t instanceof W))return!1;const s=t;return this.width===s.width&&this.height===s.height&&this.rowSize===s.rowSize&&T.equals(this.bits,s.bits)}hashCode(){let t=this.width;return t=31*t+this.width,t=31*t+this.height,t=31*t+this.rowSize,t=31*t+T.hashCode(this.bits),t}toString(t="X ",s="  ",r=`
`){return this.buildToString(t,s,r)}buildToString(t,s,r){let a=new se;for(let i=0,o=this.height;i<o;i++){for(let d=0,h=this.width;d<h;d++)a.append(this.get(d,i)?t:s);a.append(r)}return a.toString()}clone(){return new W(this.width,this.height,this.rowSize,this.bits.slice())}}class G extends g{static getNotFoundInstance(){return new G}}G.kind="NotFoundException";class B extends D{constructor(t){super(t),this.luminances=B.EMPTY,this.buckets=new Int32Array(B.LUMINANCE_BUCKETS)}getBlackRow(t,s){const r=this.getLuminanceSource(),a=r.getWidth();s==null||s.getSize()<a?s=new U(a):s.clear(),this.initArrays(a);const i=r.getRow(t,this.luminances),o=this.buckets;for(let h=0;h<a;h++)o[(i[h]&255)>>B.LUMINANCE_SHIFT]++;const d=B.estimateBlackPoint(o);if(a<3)for(let h=0;h<a;h++)(i[h]&255)<d&&s.set(h);else{let h=i[0]&255,m=i[1]&255;for(let y=1;y<a-1;y++){const I=i[y+1]&255;(m*4-h-I)/2<d&&s.set(y),h=m,m=I}}return s}getBlackMatrix(){const t=this.getLuminanceSource(),s=t.getWidth(),r=t.getHeight(),a=new W(s,r);this.initArrays(s);const i=this.buckets;for(let h=1;h<5;h++){const m=Math.floor(r*h/5),y=t.getRow(m,this.luminances),I=Math.floor(s*4/5);for(let z=Math.floor(s/5);z<I;z++){const Y=y[z]&255;i[Y>>B.LUMINANCE_SHIFT]++}}const o=B.estimateBlackPoint(i),d=t.getMatrix();for(let h=0;h<r;h++){const m=h*s;for(let y=0;y<s;y++)(d[m+y]&255)<o&&a.set(y,h)}return a}createBinarizer(t){return new B(t)}initArrays(t){this.luminances.length<t&&(this.luminances=new Uint8ClampedArray(t));const s=this.buckets;for(let r=0;r<B.LUMINANCE_BUCKETS;r++)s[r]=0}static estimateBlackPoint(t){const s=t.length;let r=0,a=0,i=0;for(let y=0;y<s;y++)t[y]>i&&(a=y,i=t[y]),t[y]>r&&(r=t[y]);let o=0,d=0;for(let y=0;y<s;y++){const I=y-a,z=t[y]*I*I;z>d&&(o=y,d=z)}if(a>o){const y=a;a=o,o=y}if(o-a<=s/16)throw new G;let h=o-1,m=-1;for(let y=o-1;y>a;y--){const I=y-a,z=I*I*(o-y)*(r-t[y]);z>m&&(h=y,m=z)}return h<<B.LUMINANCE_SHIFT}}B.LUMINANCE_BITS=5,B.LUMINANCE_SHIFT=8-B.LUMINANCE_BITS,B.LUMINANCE_BUCKETS=1<<B.LUMINANCE_BITS,B.EMPTY=Uint8ClampedArray.from([0]);class ne extends B{constructor(t){super(t),this.matrix=null}getBlackMatrix(){if(this.matrix!==null)return this.matrix;const t=this.getLuminanceSource(),s=t.getWidth(),r=t.getHeight();if(s>=ne.MINIMUM_DIMENSION&&r>=ne.MINIMUM_DIMENSION){const a=t.getMatrix();let i=s>>ne.BLOCK_SIZE_POWER;s&ne.BLOCK_SIZE_MASK&&i++;let o=r>>ne.BLOCK_SIZE_POWER;r&ne.BLOCK_SIZE_MASK&&o++;const d=ne.calculateBlackPoints(a,i,o,s,r),h=new W(s,r);ne.calculateThresholdForBlock(a,i,o,s,r,d,h),this.matrix=h}else this.matrix=super.getBlackMatrix();return this.matrix}createBinarizer(t){return new ne(t)}static calculateThresholdForBlock(t,s,r,a,i,o,d){const h=i-ne.BLOCK_SIZE,m=a-ne.BLOCK_SIZE;for(let y=0;y<r;y++){let I=y<<ne.BLOCK_SIZE_POWER;I>h&&(I=h);const z=ne.cap(y,2,r-3);for(let Y=0;Y<s;Y++){let ie=Y<<ne.BLOCK_SIZE_POWER;ie>m&&(ie=m);const ce=ne.cap(Y,2,s-3);let Ne=0;for(let Ge=-2;Ge<=2;Ge++){const Ye=o[z+Ge];Ne+=Ye[ce-2]+Ye[ce-1]+Ye[ce]+Ye[ce+1]+Ye[ce+2]}const ze=Ne/25;ne.thresholdBlock(t,ie,I,ze,a,d)}}}static cap(t,s,r){return t<s?s:t>r?r:t}static thresholdBlock(t,s,r,a,i,o){for(let d=0,h=r*i+s;d<ne.BLOCK_SIZE;d++,h+=i)for(let m=0;m<ne.BLOCK_SIZE;m++)(t[h+m]&255)<=a&&o.set(s+m,r+d)}static calculateBlackPoints(t,s,r,a,i){const o=i-ne.BLOCK_SIZE,d=a-ne.BLOCK_SIZE,h=new Array(r);for(let m=0;m<r;m++){h[m]=new Int32Array(s);let y=m<<ne.BLOCK_SIZE_POWER;y>o&&(y=o);for(let I=0;I<s;I++){let z=I<<ne.BLOCK_SIZE_POWER;z>d&&(z=d);let Y=0,ie=255,ce=0;for(let ze=0,Ge=y*a+z;ze<ne.BLOCK_SIZE;ze++,Ge+=a){for(let Ye=0;Ye<ne.BLOCK_SIZE;Ye++){const Ue=t[Ge+Ye]&255;Y+=Ue,Ue<ie&&(ie=Ue),Ue>ce&&(ce=Ue)}if(ce-ie>ne.MIN_DYNAMIC_RANGE)for(ze++,Ge+=a;ze<ne.BLOCK_SIZE;ze++,Ge+=a)for(let Ye=0;Ye<ne.BLOCK_SIZE;Ye++)Y+=t[Ge+Ye]&255}let Ne=Y>>ne.BLOCK_SIZE_POWER*2;if(ce-ie<=ne.MIN_DYNAMIC_RANGE&&(Ne=ie/2,m>0&&I>0)){const ze=(h[m-1][I]+2*h[m][I-1]+h[m-1][I-1])/4;ie<ze&&(Ne=ze)}h[m][I]=Ne}}return h}}ne.BLOCK_SIZE_POWER=3,ne.BLOCK_SIZE=1<<ne.BLOCK_SIZE_POWER,ne.BLOCK_SIZE_MASK=ne.BLOCK_SIZE-1,ne.MINIMUM_DIMENSION=ne.BLOCK_SIZE*5,ne.MIN_DYNAMIC_RANGE=24;class ye{constructor(t,s){this.width=t,this.height=s}getWidth(){return this.width}getHeight(){return this.height}isCropSupported(){return!1}crop(t,s,r,a){throw new K("This luminance source does not support cropping.")}isRotateSupported(){return!1}rotateCounterClockwise(){throw new K("This luminance source does not support rotation by 90 degrees.")}rotateCounterClockwise45(){throw new K("This luminance source does not support rotation by 45 degrees.")}toString(){const t=new Uint8ClampedArray(this.width);let s=new se;for(let r=0;r<this.height;r++){const a=this.getRow(r,t);for(let i=0;i<this.width;i++){const o=a[i]&255;let d;o<64?d="#":o<128?d="+":o<192?d=".":d=" ",s.append(d)}s.append(`
`)}return s.toString()}}class me extends ye{constructor(t){super(t.getWidth(),t.getHeight()),this.delegate=t}getRow(t,s){const r=this.delegate.getRow(t,s),a=this.getWidth();for(let i=0;i<a;i++)r[i]=255-(r[i]&255);return r}getMatrix(){const t=this.delegate.getMatrix(),s=this.getWidth()*this.getHeight(),r=new Uint8ClampedArray(s);for(let a=0;a<s;a++)r[a]=255-(t[a]&255);return r}isCropSupported(){return this.delegate.isCropSupported()}crop(t,s,r,a){return new me(this.delegate.crop(t,s,r,a))}isRotateSupported(){return this.delegate.isRotateSupported()}invert(){return this.delegate}rotateCounterClockwise(){return new me(this.delegate.rotateCounterClockwise())}rotateCounterClockwise45(){return new me(this.delegate.rotateCounterClockwise45())}}class Q extends ye{constructor(t){super(t.width,t.height),this.canvas=t,this.tempCanvasElement=null,this.buffer=Q.makeBufferFromCanvasImageData(t)}static makeBufferFromCanvasImageData(t){const s=t.getContext("2d").getImageData(0,0,t.width,t.height);return Q.toGrayscaleBuffer(s.data,t.width,t.height)}static toGrayscaleBuffer(t,s,r){const a=new Uint8ClampedArray(s*r);for(let i=0,o=0,d=t.length;i<d;i+=4,o++){let h;if(t[i+3]===0)h=255;else{const y=t[i],I=t[i+1],z=t[i+2];h=306*y+601*I+117*z+512>>10}a[o]=h}return a}getRow(t,s){if(t<0||t>=this.getHeight())throw new p("Requested row is outside the image: "+t);const r=this.getWidth(),a=t*r;return s===null?s=this.buffer.slice(a,a+r):(s.length<r&&(s=new Uint8ClampedArray(r)),s.set(this.buffer.slice(a,a+r))),s}getMatrix(){return this.buffer}isCropSupported(){return!0}crop(t,s,r,a){return super.crop(t,s,r,a),this}isRotateSupported(){return!0}rotateCounterClockwise(){return this.rotate(-90),this}rotateCounterClockwise45(){return this.rotate(-45),this}getTempCanvasElement(){if(this.tempCanvasElement===null){const t=this.canvas.ownerDocument.createElement("canvas");t.width=this.canvas.width,t.height=this.canvas.height,this.tempCanvasElement=t}return this.tempCanvasElement}rotate(t){const s=this.getTempCanvasElement(),r=s.getContext("2d"),a=t*Q.DEGREE_TO_RADIANS,i=this.canvas.width,o=this.canvas.height,d=Math.ceil(Math.abs(Math.cos(a))*i+Math.abs(Math.sin(a))*o),h=Math.ceil(Math.abs(Math.sin(a))*i+Math.abs(Math.cos(a))*o);return s.width=d,s.height=h,r.translate(d/2,h/2),r.rotate(a),r.drawImage(this.canvas,i/-2,o/-2),this.buffer=Q.makeBufferFromCanvasImageData(s),this}invert(){return new me(this)}}Q.DEGREE_TO_RADIANS=Math.PI/180;class fe{constructor(t,s,r){this.deviceId=t,this.label=s,this.kind="videoinput",this.groupId=r||void 0}toJSON(){return{kind:this.kind,groupId:this.groupId,deviceId:this.deviceId,label:this.label}}}var be=(globalThis||Vr||self||window||void 0)&&(globalThis||Vr||self||window||void 0).__awaiter||function(A,t,s,r){function a(i){return i instanceof s?i:new s(function(o){o(i)})}return new(s||(s=Promise))(function(i,o){function d(y){try{m(r.next(y))}catch(I){o(I)}}function h(y){try{m(r.throw(y))}catch(I){o(I)}}function m(y){y.done?i(y.value):a(y.value).then(d,h)}m((r=r.apply(A,t||[])).next())})};class Z{constructor(t,s=500,r){this.reader=t,this.timeBetweenScansMillis=s,this._hints=r,this._stopContinuousDecode=!1,this._stopAsyncDecode=!1,this._timeBetweenDecodingAttempts=0}get hasNavigator(){return typeof navigator<"u"}get isMediaDevicesSuported(){return this.hasNavigator&&!!navigator.mediaDevices}get canEnumerateDevices(){return!!(this.isMediaDevicesSuported&&navigator.mediaDevices.enumerateDevices)}get timeBetweenDecodingAttempts(){return this._timeBetweenDecodingAttempts}set timeBetweenDecodingAttempts(t){this._timeBetweenDecodingAttempts=t<0?0:t}set hints(t){this._hints=t||null}get hints(){return this._hints}listVideoInputDevices(){return be(this,void 0,void 0,function*(){if(!this.hasNavigator)throw new Error("Can't enumerate devices, navigator is not present.");if(!this.canEnumerateDevices)throw new Error("Can't enumerate devices, method not supported.");const t=yield navigator.mediaDevices.enumerateDevices(),s=[];for(const r of t){const a=r.kind==="video"?"videoinput":r.kind;if(a!=="videoinput")continue;const i=r.deviceId||r.id,o=r.label||`Video device ${s.length+1}`,d=r.groupId,h={deviceId:i,label:o,kind:a,groupId:d};s.push(h)}return s})}getVideoInputDevices(){return be(this,void 0,void 0,function*(){return(yield this.listVideoInputDevices()).map(s=>new fe(s.deviceId,s.label))})}findDeviceById(t){return be(this,void 0,void 0,function*(){const s=yield this.listVideoInputDevices();return s?s.find(r=>r.deviceId===t):null})}decodeFromInputVideoDevice(t,s){return be(this,void 0,void 0,function*(){return yield this.decodeOnceFromVideoDevice(t,s)})}decodeOnceFromVideoDevice(t,s){return be(this,void 0,void 0,function*(){this.reset();let r;t?r={deviceId:{exact:t}}:r={facingMode:"environment"};const a={video:r};return yield this.decodeOnceFromConstraints(a,s)})}decodeOnceFromConstraints(t,s){return be(this,void 0,void 0,function*(){const r=yield navigator.mediaDevices.getUserMedia(t);return yield this.decodeOnceFromStream(r,s)})}decodeOnceFromStream(t,s){return be(this,void 0,void 0,function*(){this.reset();const r=yield this.attachStreamToVideo(t,s);return yield this.decodeOnce(r)})}decodeFromInputVideoDeviceContinuously(t,s,r){return be(this,void 0,void 0,function*(){return yield this.decodeFromVideoDevice(t,s,r)})}decodeFromVideoDevice(t,s,r){return be(this,void 0,void 0,function*(){let a;t?a={deviceId:{exact:t}}:a={facingMode:"environment"};const i={video:a};return yield this.decodeFromConstraints(i,s,r)})}decodeFromConstraints(t,s,r){return be(this,void 0,void 0,function*(){const a=yield navigator.mediaDevices.getUserMedia(t);return yield this.decodeFromStream(a,s,r)})}decodeFromStream(t,s,r){return be(this,void 0,void 0,function*(){this.reset();const a=yield this.attachStreamToVideo(t,s);return yield this.decodeContinuously(a,r)})}stopAsyncDecode(){this._stopAsyncDecode=!0}stopContinuousDecode(){this._stopContinuousDecode=!0}attachStreamToVideo(t,s){return be(this,void 0,void 0,function*(){const r=this.prepareVideoElement(s);return this.addVideoSource(r,t),this.videoElement=r,this.stream=t,yield this.playVideoOnLoadAsync(r),r})}playVideoOnLoadAsync(t){return new Promise((s,r)=>this.playVideoOnLoad(t,()=>s()))}playVideoOnLoad(t,s){this.videoEndedListener=()=>this.stopStreams(),this.videoCanPlayListener=()=>this.tryPlayVideo(t),t.addEventListener("ended",this.videoEndedListener),t.addEventListener("canplay",this.videoCanPlayListener),t.addEventListener("playing",s),this.tryPlayVideo(t)}isVideoPlaying(t){return t.currentTime>0&&!t.paused&&!t.ended&&t.readyState>2}tryPlayVideo(t){return be(this,void 0,void 0,function*(){if(this.isVideoPlaying(t)){console.warn("Trying to play video that is already playing.");return}try{yield t.play()}catch{console.warn("It was not possible to play the video.")}})}getMediaElement(t,s){const r=document.getElementById(t);if(!r)throw new E(`element with id '${t}' not found`);if(r.nodeName.toLowerCase()!==s.toLowerCase())throw new E(`element with id '${t}' must be an ${s} element`);return r}decodeFromImage(t,s){if(!t&&!s)throw new E("either imageElement with a src set or an url must be provided");return s&&!t?this.decodeFromImageUrl(s):this.decodeFromImageElement(t)}decodeFromVideo(t,s){if(!t&&!s)throw new E("Either an element with a src set or an URL must be provided");return s&&!t?this.decodeFromVideoUrl(s):this.decodeFromVideoElement(t)}decodeFromVideoContinuously(t,s,r){if(t===void 0&&s===void 0)throw new E("Either an element with a src set or an URL must be provided");return s&&!t?this.decodeFromVideoUrlContinuously(s,r):this.decodeFromVideoElementContinuously(t,r)}decodeFromImageElement(t){if(!t)throw new E("An image element must be provided.");this.reset();const s=this.prepareImageElement(t);this.imageElement=s;let r;return this.isImageLoaded(s)?r=this.decodeOnce(s,!1,!0):r=this._decodeOnLoadImage(s),r}decodeFromVideoElement(t){const s=this._decodeFromVideoElementSetup(t);return this._decodeOnLoadVideo(s)}decodeFromVideoElementContinuously(t,s){const r=this._decodeFromVideoElementSetup(t);return this._decodeOnLoadVideoContinuously(r,s)}_decodeFromVideoElementSetup(t){if(!t)throw new E("A video element must be provided.");this.reset();const s=this.prepareVideoElement(t);return this.videoElement=s,s}decodeFromImageUrl(t){if(!t)throw new E("An URL must be provided.");this.reset();const s=this.prepareImageElement();this.imageElement=s;const r=this._decodeOnLoadImage(s);return s.src=t,r}decodeFromVideoUrl(t){if(!t)throw new E("An URL must be provided.");this.reset();const s=this.prepareVideoElement(),r=this.decodeFromVideoElement(s);return s.src=t,r}decodeFromVideoUrlContinuously(t,s){if(!t)throw new E("An URL must be provided.");this.reset();const r=this.prepareVideoElement(),a=this.decodeFromVideoElementContinuously(r,s);return r.src=t,a}_decodeOnLoadImage(t){return new Promise((s,r)=>{this.imageLoadedListener=()=>this.decodeOnce(t,!1,!0).then(s,r),t.addEventListener("load",this.imageLoadedListener)})}_decodeOnLoadVideo(t){return be(this,void 0,void 0,function*(){return yield this.playVideoOnLoadAsync(t),yield this.decodeOnce(t)})}_decodeOnLoadVideoContinuously(t,s){return be(this,void 0,void 0,function*(){yield this.playVideoOnLoadAsync(t),this.decodeContinuously(t,s)})}isImageLoaded(t){return!(!t.complete||t.naturalWidth===0)}prepareImageElement(t){let s;return typeof t>"u"&&(s=document.createElement("img"),s.width=200,s.height=200),typeof t=="string"&&(s=this.getMediaElement(t,"img")),t instanceof HTMLImageElement&&(s=t),s}prepareVideoElement(t){let s;return!t&&typeof document<"u"&&(s=document.createElement("video"),s.width=200,s.height=200),typeof t=="string"&&(s=this.getMediaElement(t,"video")),t instanceof HTMLVideoElement&&(s=t),s.setAttribute("autoplay","true"),s.setAttribute("muted","true"),s.setAttribute("playsinline","true"),s}decodeOnce(t,s=!0,r=!0){this._stopAsyncDecode=!1;const a=(i,o)=>{if(this._stopAsyncDecode){o(new G("Video stream has ended before any code could be detected.")),this._stopAsyncDecode=void 0;return}try{const d=this.decode(t);i(d)}catch(d){const h=s&&d instanceof G,y=(d instanceof P||d instanceof _)&&r;if(h||y)return setTimeout(a,this._timeBetweenDecodingAttempts,i,o);o(d)}};return new Promise((i,o)=>a(i,o))}decodeContinuously(t,s){this._stopContinuousDecode=!1;const r=()=>{if(this._stopContinuousDecode){this._stopContinuousDecode=void 0;return}try{const a=this.decode(t);s(a,null),setTimeout(r,this.timeBetweenScansMillis)}catch(a){s(null,a);const i=a instanceof P||a instanceof _,o=a instanceof G;(i||o)&&setTimeout(r,this._timeBetweenDecodingAttempts)}};r()}decode(t){const s=this.createBinaryBitmap(t);return this.decodeBitmap(s)}_isHTMLVideoElement(t){return t.videoWidth!==0}drawFrameOnCanvas(t,s,r){s||(s={sx:0,sy:0,sWidth:t.videoWidth,sHeight:t.videoHeight,dx:0,dy:0,dWidth:t.videoWidth,dHeight:t.videoHeight}),r||(r=this.captureCanvasContext),r.drawImage(t,s.sx,s.sy,s.sWidth,s.sHeight,s.dx,s.dy,s.dWidth,s.dHeight)}drawImageOnCanvas(t,s,r=this.captureCanvasContext){s||(s={sx:0,sy:0,sWidth:t.naturalWidth,sHeight:t.naturalHeight,dx:0,dy:0,dWidth:t.naturalWidth,dHeight:t.naturalHeight}),r||(r=this.captureCanvasContext),r.drawImage(t,s.sx,s.sy,s.sWidth,s.sHeight,s.dx,s.dy,s.dWidth,s.dHeight)}createBinaryBitmap(t){this.getCaptureCanvasContext(t),this._isHTMLVideoElement(t)?this.drawFrameOnCanvas(t):this.drawImageOnCanvas(t);const s=this.getCaptureCanvas(t),r=new Q(s),a=new ne(r);return new k(a)}getCaptureCanvasContext(t){if(!this.captureCanvasContext){const r=this.getCaptureCanvas(t).getContext("2d");this.captureCanvasContext=r}return this.captureCanvasContext}getCaptureCanvas(t){if(!this.captureCanvas){const s=this.createCaptureCanvas(t);this.captureCanvas=s}return this.captureCanvas}decodeBitmap(t){return this.reader.decode(t,this._hints)}createCaptureCanvas(t){if(typeof document>"u")return this._destroyCaptureCanvas(),null;const s=document.createElement("canvas");let r,a;return typeof t<"u"&&(t instanceof HTMLVideoElement?(r=t.videoWidth,a=t.videoHeight):t instanceof HTMLImageElement&&(r=t.naturalWidth||t.width,a=t.naturalHeight||t.height)),s.style.width=r+"px",s.style.height=a+"px",s.width=r,s.height=a,s}stopStreams(){this.stream&&(this.stream.getVideoTracks().forEach(t=>t.stop()),this.stream=void 0),this._stopAsyncDecode===!1&&this.stopAsyncDecode(),this._stopContinuousDecode===!1&&this.stopContinuousDecode()}reset(){this.stopStreams(),this._destroyVideoElement(),this._destroyImageElement(),this._destroyCaptureCanvas()}_destroyVideoElement(){this.videoElement&&(typeof this.videoEndedListener<"u"&&this.videoElement.removeEventListener("ended",this.videoEndedListener),typeof this.videoPlayingEventListener<"u"&&this.videoElement.removeEventListener("playing",this.videoPlayingEventListener),typeof this.videoCanPlayListener<"u"&&this.videoElement.removeEventListener("loadedmetadata",this.videoCanPlayListener),this.cleanVideoSource(this.videoElement),this.videoElement=void 0)}_destroyImageElement(){this.imageElement&&(this.imageLoadedListener!==void 0&&this.imageElement.removeEventListener("load",this.imageLoadedListener),this.imageElement.src=void 0,this.imageElement.removeAttribute("src"),this.imageElement=void 0)}_destroyCaptureCanvas(){this.captureCanvasContext=void 0,this.captureCanvas=void 0}addVideoSource(t,s){try{t.srcObject=s}catch{t.src=URL.createObjectURL(s)}}cleanVideoSource(t){try{t.srcObject=null}catch{t.src=""}this.videoElement.removeAttribute("src")}}class L{constructor(t,s,r=s==null?0:8*s.length,a,i,o=R.currentTimeMillis()){this.text=t,this.rawBytes=s,this.numBits=r,this.resultPoints=a,this.format=i,this.timestamp=o,this.text=t,this.rawBytes=s,r==null?this.numBits=s==null?0:8*s.length:this.numBits=r,this.resultPoints=a,this.format=i,this.resultMetadata=null,o==null?this.timestamp=R.currentTimeMillis():this.timestamp=o}getText(){return this.text}getRawBytes(){return this.rawBytes}getNumBits(){return this.numBits}getResultPoints(){return this.resultPoints}getBarcodeFormat(){return this.format}getResultMetadata(){return this.resultMetadata}putMetadata(t,s){this.resultMetadata===null&&(this.resultMetadata=new Map),this.resultMetadata.set(t,s)}putAllMetadata(t){t!==null&&(this.resultMetadata===null?this.resultMetadata=t:this.resultMetadata=new Map(t))}addResultPoints(t){const s=this.resultPoints;if(s===null)this.resultPoints=t;else if(t!==null&&t.length>0){const r=new Array(s.length+t.length);R.arraycopy(s,0,r,0,s.length),R.arraycopy(t,0,r,s.length,t.length),this.resultPoints=r}}getTimestamp(){return this.timestamp}toString(){return this.text}}var re;(function(A){A[A.AZTEC=0]="AZTEC",A[A.CODABAR=1]="CODABAR",A[A.CODE_39=2]="CODE_39",A[A.CODE_93=3]="CODE_93",A[A.CODE_128=4]="CODE_128",A[A.DATA_MATRIX=5]="DATA_MATRIX",A[A.EAN_8=6]="EAN_8",A[A.EAN_13=7]="EAN_13",A[A.ITF=8]="ITF",A[A.MAXICODE=9]="MAXICODE",A[A.PDF_417=10]="PDF_417",A[A.QR_CODE=11]="QR_CODE",A[A.RSS_14=12]="RSS_14",A[A.RSS_EXPANDED=13]="RSS_EXPANDED",A[A.UPC_A=14]="UPC_A",A[A.UPC_E=15]="UPC_E",A[A.UPC_EAN_EXTENSION=16]="UPC_EAN_EXTENSION"})(re||(re={}));var de=re,oe;(function(A){A[A.OTHER=0]="OTHER",A[A.ORIENTATION=1]="ORIENTATION",A[A.BYTE_SEGMENTS=2]="BYTE_SEGMENTS",A[A.ERROR_CORRECTION_LEVEL=3]="ERROR_CORRECTION_LEVEL",A[A.ISSUE_NUMBER=4]="ISSUE_NUMBER",A[A.SUGGESTED_PRICE=5]="SUGGESTED_PRICE",A[A.POSSIBLE_COUNTRY=6]="POSSIBLE_COUNTRY",A[A.UPC_EAN_EXTENSION=7]="UPC_EAN_EXTENSION",A[A.PDF417_EXTRA_METADATA=8]="PDF417_EXTRA_METADATA",A[A.STRUCTURED_APPEND_SEQUENCE=9]="STRUCTURED_APPEND_SEQUENCE",A[A.STRUCTURED_APPEND_PARITY=10]="STRUCTURED_APPEND_PARITY"})(oe||(oe={}));var ge=oe;class ve{constructor(t,s,r,a,i=-1,o=-1){this.rawBytes=t,this.text=s,this.byteSegments=r,this.ecLevel=a,this.structuredAppendSequenceNumber=i,this.structuredAppendParity=o,this.numBits=t==null?0:8*t.length}getRawBytes(){return this.rawBytes}getNumBits(){return this.numBits}setNumBits(t){this.numBits=t}getText(){return this.text}getByteSegments(){return this.byteSegments}getECLevel(){return this.ecLevel}getErrorsCorrected(){return this.errorsCorrected}setErrorsCorrected(t){this.errorsCorrected=t}getErasures(){return this.erasures}setErasures(t){this.erasures=t}getOther(){return this.other}setOther(t){this.other=t}hasStructuredAppend(){return this.structuredAppendParity>=0&&this.structuredAppendSequenceNumber>=0}getStructuredAppendParity(){return this.structuredAppendParity}getStructuredAppendSequenceNumber(){return this.structuredAppendSequenceNumber}}class Te{exp(t){return this.expTable[t]}log(t){if(t===0)throw new p;return this.logTable[t]}static addOrSubtract(t,s){return t^s}}class we{constructor(t,s){if(s.length===0)throw new p;this.field=t;const r=s.length;if(r>1&&s[0]===0){let a=1;for(;a<r&&s[a]===0;)a++;a===r?this.coefficients=Int32Array.from([0]):(this.coefficients=new Int32Array(r-a),R.arraycopy(s,a,this.coefficients,0,this.coefficients.length))}else this.coefficients=s}getCoefficients(){return this.coefficients}getDegree(){return this.coefficients.length-1}isZero(){return this.coefficients[0]===0}getCoefficient(t){return this.coefficients[this.coefficients.length-1-t]}evaluateAt(t){if(t===0)return this.getCoefficient(0);const s=this.coefficients;let r;if(t===1){r=0;for(let o=0,d=s.length;o!==d;o++){const h=s[o];r=Te.addOrSubtract(r,h)}return r}r=s[0];const a=s.length,i=this.field;for(let o=1;o<a;o++)r=Te.addOrSubtract(i.multiply(t,r),s[o]);return r}addOrSubtract(t){if(!this.field.equals(t.field))throw new p("GenericGFPolys do not have same GenericGF field");if(this.isZero())return t;if(t.isZero())return this;let s=this.coefficients,r=t.coefficients;if(s.length>r.length){const o=s;s=r,r=o}let a=new Int32Array(r.length);const i=r.length-s.length;R.arraycopy(r,0,a,0,i);for(let o=i;o<r.length;o++)a[o]=Te.addOrSubtract(s[o-i],r[o]);return new we(this.field,a)}multiply(t){if(!this.field.equals(t.field))throw new p("GenericGFPolys do not have same GenericGF field");if(this.isZero()||t.isZero())return this.field.getZero();const s=this.coefficients,r=s.length,a=t.coefficients,i=a.length,o=new Int32Array(r+i-1),d=this.field;for(let h=0;h<r;h++){const m=s[h];for(let y=0;y<i;y++)o[h+y]=Te.addOrSubtract(o[h+y],d.multiply(m,a[y]))}return new we(d,o)}multiplyScalar(t){if(t===0)return this.field.getZero();if(t===1)return this;const s=this.coefficients.length,r=this.field,a=new Int32Array(s),i=this.coefficients;for(let o=0;o<s;o++)a[o]=r.multiply(i[o],t);return new we(r,a)}multiplyByMonomial(t,s){if(t<0)throw new p;if(s===0)return this.field.getZero();const r=this.coefficients,a=r.length,i=new Int32Array(a+t),o=this.field;for(let d=0;d<a;d++)i[d]=o.multiply(r[d],s);return new we(o,i)}divide(t){if(!this.field.equals(t.field))throw new p("GenericGFPolys do not have same GenericGF field");if(t.isZero())throw new p("Divide by 0");const s=this.field;let r=s.getZero(),a=this;const i=t.getCoefficient(t.getDegree()),o=s.inverse(i);for(;a.getDegree()>=t.getDegree()&&!a.isZero();){const d=a.getDegree()-t.getDegree(),h=s.multiply(a.getCoefficient(a.getDegree()),o),m=t.multiplyByMonomial(d,h),y=s.buildMonomial(d,h);r=r.addOrSubtract(y),a=a.addOrSubtract(m)}return[r,a]}toString(){let t="";for(let s=this.getDegree();s>=0;s--){let r=this.getCoefficient(s);if(r!==0){if(r<0?(t+=" - ",r=-r):t.length>0&&(t+=" + "),s===0||r!==1){const a=this.field.log(r);a===0?t+="1":a===1?t+="a":(t+="a^",t+=a)}s!==0&&(s===1?t+="x":(t+="x^",t+=s))}}return t}}class je extends g{}je.kind="ArithmeticException";class Fe extends Te{constructor(t,s,r){super(),this.primitive=t,this.size=s,this.generatorBase=r;const a=new Int32Array(s);let i=1;for(let d=0;d<s;d++)a[d]=i,i*=2,i>=s&&(i^=t,i&=s-1);this.expTable=a;const o=new Int32Array(s);for(let d=0;d<s-1;d++)o[a[d]]=d;this.logTable=o,this.zero=new we(this,Int32Array.from([0])),this.one=new we(this,Int32Array.from([1]))}getZero(){return this.zero}getOne(){return this.one}buildMonomial(t,s){if(t<0)throw new p;if(s===0)return this.zero;const r=new Int32Array(t+1);return r[0]=s,new we(this,r)}inverse(t){if(t===0)throw new je;return this.expTable[this.size-this.logTable[t]-1]}multiply(t,s){return t===0||s===0?0:this.expTable[(this.logTable[t]+this.logTable[s])%(this.size-1)]}getSize(){return this.size}getGeneratorBase(){return this.generatorBase}toString(){return"GF(0x"+F.toHexString(this.primitive)+","+this.size+")"}equals(t){return t===this}}Fe.AZTEC_DATA_12=new Fe(4201,4096,1),Fe.AZTEC_DATA_10=new Fe(1033,1024,1),Fe.AZTEC_DATA_6=new Fe(67,64,1),Fe.AZTEC_PARAM=new Fe(19,16,1),Fe.QR_CODE_FIELD_256=new Fe(285,256,0),Fe.DATA_MATRIX_FIELD_256=new Fe(301,256,1),Fe.AZTEC_DATA_8=Fe.DATA_MATRIX_FIELD_256,Fe.MAXICODE_FIELD_64=Fe.AZTEC_DATA_6;class Ve extends g{}Ve.kind="ReedSolomonException";class rt extends g{}rt.kind="IllegalStateException";class st{constructor(t){this.field=t}decode(t,s){const r=this.field,a=new we(r,t),i=new Int32Array(s);let o=!0;for(let Y=0;Y<s;Y++){const ie=a.evaluateAt(r.exp(Y+r.getGeneratorBase()));i[i.length-1-Y]=ie,ie!==0&&(o=!1)}if(o)return;const d=new we(r,i),h=this.runEuclideanAlgorithm(r.buildMonomial(s,1),d,s),m=h[0],y=h[1],I=this.findErrorLocations(m),z=this.findErrorMagnitudes(y,I);for(let Y=0;Y<I.length;Y++){const ie=t.length-1-r.log(I[Y]);if(ie<0)throw new Ve("Bad error location");t[ie]=Fe.addOrSubtract(t[ie],z[Y])}}runEuclideanAlgorithm(t,s,r){if(t.getDegree()<s.getDegree()){const Y=t;t=s,s=Y}const a=this.field;let i=t,o=s,d=a.getZero(),h=a.getOne();for(;o.getDegree()>=(r/2|0);){let Y=i,ie=d;if(i=o,d=h,i.isZero())throw new Ve("r_{i-1} was zero");o=Y;let ce=a.getZero();const Ne=i.getCoefficient(i.getDegree()),ze=a.inverse(Ne);for(;o.getDegree()>=i.getDegree()&&!o.isZero();){const Ge=o.getDegree()-i.getDegree(),Ye=a.multiply(o.getCoefficient(o.getDegree()),ze);ce=ce.addOrSubtract(a.buildMonomial(Ge,Ye)),o=o.addOrSubtract(i.multiplyByMonomial(Ge,Ye))}if(h=ce.multiply(d).addOrSubtract(ie),o.getDegree()>=i.getDegree())throw new rt("Division algorithm failed to reduce polynomial?")}const m=h.getCoefficient(0);if(m===0)throw new Ve("sigmaTilde(0) was zero");const y=a.inverse(m),I=h.multiplyScalar(y),z=o.multiplyScalar(y);return[I,z]}findErrorLocations(t){const s=t.getDegree();if(s===1)return Int32Array.from([t.getCoefficient(1)]);const r=new Int32Array(s);let a=0;const i=this.field;for(let o=1;o<i.getSize()&&a<s;o++)t.evaluateAt(o)===0&&(r[a]=i.inverse(o),a++);if(a!==s)throw new Ve("Error locator degree does not match number of roots");return r}findErrorMagnitudes(t,s){const r=s.length,a=new Int32Array(r),i=this.field;for(let o=0;o<r;o++){const d=i.inverse(s[o]);let h=1;for(let m=0;m<r;m++)if(o!==m){const y=i.multiply(s[m],d),I=y&1?y&-2:y|1;h=i.multiply(h,I)}a[o]=i.multiply(t.evaluateAt(d),i.inverse(h)),i.getGeneratorBase()!==0&&(a[o]=i.multiply(a[o],d))}return a}}var Je;(function(A){A[A.UPPER=0]="UPPER",A[A.LOWER=1]="LOWER",A[A.MIXED=2]="MIXED",A[A.DIGIT=3]="DIGIT",A[A.PUNCT=4]="PUNCT",A[A.BINARY=5]="BINARY"})(Je||(Je={}));class Qe{decode(t){this.ddata=t;let s=t.getBits(),r=this.extractBits(s),a=this.correctBits(r),i=Qe.convertBoolArrayToByteArray(a),o=Qe.getEncodedData(a),d=new ve(i,o,null,null);return d.setNumBits(a.length),d}static highLevelDecode(t){return this.getEncodedData(t)}static getEncodedData(t){let s=t.length,r=Je.UPPER,a=Je.UPPER,i="",o=0;for(;o<s;)if(a===Je.BINARY){if(s-o<5)break;let d=Qe.readCode(t,o,5);if(o+=5,d===0){if(s-o<11)break;d=Qe.readCode(t,o,11)+31,o+=11}for(let h=0;h<d;h++){if(s-o<8){o=s;break}const m=Qe.readCode(t,o,8);i+=X.castAsNonUtf8Char(m),o+=8}a=r}else{let d=a===Je.DIGIT?4:5;if(s-o<d)break;let h=Qe.readCode(t,o,d);o+=d;let m=Qe.getCharacter(a,h);m.startsWith("CTRL_")?(r=a,a=Qe.getTable(m.charAt(5)),m.charAt(6)==="L"&&(r=a)):(i+=m,a=r)}return i}static getTable(t){switch(t){case"L":return Je.LOWER;case"P":return Je.PUNCT;case"M":return Je.MIXED;case"D":return Je.DIGIT;case"B":return Je.BINARY;case"U":default:return Je.UPPER}}static getCharacter(t,s){switch(t){case Je.UPPER:return Qe.UPPER_TABLE[s];case Je.LOWER:return Qe.LOWER_TABLE[s];case Je.MIXED:return Qe.MIXED_TABLE[s];case Je.PUNCT:return Qe.PUNCT_TABLE[s];case Je.DIGIT:return Qe.DIGIT_TABLE[s];default:throw new rt("Bad table")}}correctBits(t){let s,r;this.ddata.getNbLayers()<=2?(r=6,s=Fe.AZTEC_DATA_6):this.ddata.getNbLayers()<=8?(r=8,s=Fe.AZTEC_DATA_8):this.ddata.getNbLayers()<=22?(r=10,s=Fe.AZTEC_DATA_10):(r=12,s=Fe.AZTEC_DATA_12);let a=this.ddata.getNbDatablocks(),i=t.length/r;if(i<a)throw new _;let o=t.length%r,d=new Int32Array(i);for(let z=0;z<i;z++,o+=r)d[z]=Qe.readCode(t,o,r);try{new st(s).decode(d,i-a)}catch(z){throw new _(z)}let h=(1<<r)-1,m=0;for(let z=0;z<a;z++){let Y=d[z];if(Y===0||Y===h)throw new _;(Y===1||Y===h-1)&&m++}let y=new Array(a*r-m),I=0;for(let z=0;z<a;z++){let Y=d[z];if(Y===1||Y===h-1)y.fill(Y>1,I,I+r-1),I+=r-1;else for(let ie=r-1;ie>=0;--ie)y[I++]=(Y&1<<ie)!==0}return y}extractBits(t){let s=this.ddata.isCompact(),r=this.ddata.getNbLayers(),a=(s?11:14)+r*4,i=new Int32Array(a),o=new Array(this.totalBitsInLayer(r,s));if(s)for(let d=0;d<i.length;d++)i[d]=d;else{let d=a+1+2*F.truncDivision(F.truncDivision(a,2)-1,15),h=a/2,m=F.truncDivision(d,2);for(let y=0;y<h;y++){let I=y+F.truncDivision(y,15);i[h-y-1]=m-I-1,i[h+y]=m+I+1}}for(let d=0,h=0;d<r;d++){let m=(r-d)*4+(s?9:12),y=d*2,I=a-1-y;for(let z=0;z<m;z++){let Y=z*2;for(let ie=0;ie<2;ie++)o[h+Y+ie]=t.get(i[y+ie],i[y+z]),o[h+2*m+Y+ie]=t.get(i[y+z],i[I-ie]),o[h+4*m+Y+ie]=t.get(i[I-ie],i[I-z]),o[h+6*m+Y+ie]=t.get(i[I-z],i[y+ie])}h+=m*8}return o}static readCode(t,s,r){let a=0;for(let i=s;i<s+r;i++)a<<=1,t[i]&&(a|=1);return a}static readByte(t,s){let r=t.length-s;return r>=8?Qe.readCode(t,s,8):Qe.readCode(t,s,r)<<8-r}static convertBoolArrayToByteArray(t){let s=new Uint8Array((t.length+7)/8);for(let r=0;r<s.length;r++)s[r]=Qe.readByte(t,8*r);return s}totalBitsInLayer(t,s){return((s?88:112)+16*t)*t}}Qe.UPPER_TABLE=["CTRL_PS"," ","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","CTRL_LL","CTRL_ML","CTRL_DL","CTRL_BS"],Qe.LOWER_TABLE=["CTRL_PS"," ","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","CTRL_US","CTRL_ML","CTRL_DL","CTRL_BS"],Qe.MIXED_TABLE=["CTRL_PS"," ","\\1","\\2","\\3","\\4","\\5","\\6","\\7","\b","	",`
`,"\\13","\f","\r","\\33","\\34","\\35","\\36","\\37","@","\\","^","_","`","|","~","\\177","CTRL_LL","CTRL_UL","CTRL_PL","CTRL_BS"],Qe.PUNCT_TABLE=["","\r",`\r
`,". ",", ",": ","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/",":",";","<","=",">","?","[","]","{","}","CTRL_UL"],Qe.DIGIT_TABLE=["CTRL_PS"," ","0","1","2","3","4","5","6","7","8","9",",",".","CTRL_UL","CTRL_US"];class We{constructor(){}static round(t){return t===NaN?0:t<=Number.MIN_SAFE_INTEGER?Number.MIN_SAFE_INTEGER:t>=Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:t+(t<0?-.5:.5)|0}static distance(t,s,r,a){const i=t-r,o=s-a;return Math.sqrt(i*i+o*o)}static sum(t){let s=0;for(let r=0,a=t.length;r!==a;r++){const i=t[r];s+=i}return s}}class gt{static floatToIntBits(t){return t}}gt.MAX_VALUE=Number.MAX_SAFE_INTEGER;class qe{constructor(t,s){this.x=t,this.y=s}getX(){return this.x}getY(){return this.y}equals(t){if(t instanceof qe){const s=t;return this.x===s.x&&this.y===s.y}return!1}hashCode(){return 31*gt.floatToIntBits(this.x)+gt.floatToIntBits(this.y)}toString(){return"("+this.x+","+this.y+")"}static orderBestPatterns(t){const s=this.distance(t[0],t[1]),r=this.distance(t[1],t[2]),a=this.distance(t[0],t[2]);let i,o,d;if(r>=s&&r>=a?(o=t[0],i=t[1],d=t[2]):a>=r&&a>=s?(o=t[1],i=t[0],d=t[2]):(o=t[2],i=t[0],d=t[1]),this.crossProductZ(i,o,d)<0){const h=i;i=d,d=h}t[0]=i,t[1]=o,t[2]=d}static distance(t,s){return We.distance(t.x,t.y,s.x,s.y)}static crossProductZ(t,s,r){const a=s.x,i=s.y;return(r.x-a)*(t.y-i)-(r.y-i)*(t.x-a)}}class De{constructor(t,s){this.bits=t,this.points=s}getBits(){return this.bits}getPoints(){return this.points}}class H extends De{constructor(t,s,r,a,i){super(t,s),this.compact=r,this.nbDatablocks=a,this.nbLayers=i}getNbLayers(){return this.nbLayers}getNbDatablocks(){return this.nbDatablocks}isCompact(){return this.compact}}class ae{constructor(t,s,r,a){this.image=t,this.height=t.getHeight(),this.width=t.getWidth(),s==null&&(s=ae.INIT_SIZE),r==null&&(r=t.getWidth()/2|0),a==null&&(a=t.getHeight()/2|0);const i=s/2|0;if(this.leftInit=r-i,this.rightInit=r+i,this.upInit=a-i,this.downInit=a+i,this.upInit<0||this.leftInit<0||this.downInit>=this.height||this.rightInit>=this.width)throw new G}detect(){let t=this.leftInit,s=this.rightInit,r=this.upInit,a=this.downInit,i=!1,o=!0,d=!1,h=!1,m=!1,y=!1,I=!1;const z=this.width,Y=this.height;for(;o;){o=!1;let ie=!0;for(;(ie||!h)&&s<z;)ie=this.containsBlackPoint(r,a,s,!1),ie?(s++,o=!0,h=!0):h||s++;if(s>=z){i=!0;break}let ce=!0;for(;(ce||!m)&&a<Y;)ce=this.containsBlackPoint(t,s,a,!0),ce?(a++,o=!0,m=!0):m||a++;if(a>=Y){i=!0;break}let Ne=!0;for(;(Ne||!y)&&t>=0;)Ne=this.containsBlackPoint(r,a,t,!1),Ne?(t--,o=!0,y=!0):y||t--;if(t<0){i=!0;break}let ze=!0;for(;(ze||!I)&&r>=0;)ze=this.containsBlackPoint(t,s,r,!0),ze?(r--,o=!0,I=!0):I||r--;if(r<0){i=!0;break}o&&(d=!0)}if(!i&&d){const ie=s-t;let ce=null;for(let Ye=1;ce===null&&Ye<ie;Ye++)ce=this.getBlackPointOnSegment(t,a-Ye,t+Ye,a);if(ce==null)throw new G;let Ne=null;for(let Ye=1;Ne===null&&Ye<ie;Ye++)Ne=this.getBlackPointOnSegment(t,r+Ye,t+Ye,r);if(Ne==null)throw new G;let ze=null;for(let Ye=1;ze===null&&Ye<ie;Ye++)ze=this.getBlackPointOnSegment(s,r+Ye,s-Ye,r);if(ze==null)throw new G;let Ge=null;for(let Ye=1;Ge===null&&Ye<ie;Ye++)Ge=this.getBlackPointOnSegment(s,a-Ye,s-Ye,a);if(Ge==null)throw new G;return this.centerEdges(Ge,ce,ze,Ne)}else throw new G}getBlackPointOnSegment(t,s,r,a){const i=We.round(We.distance(t,s,r,a)),o=(r-t)/i,d=(a-s)/i,h=this.image;for(let m=0;m<i;m++){const y=We.round(t+m*o),I=We.round(s+m*d);if(h.get(y,I))return new qe(y,I)}return null}centerEdges(t,s,r,a){const i=t.getX(),o=t.getY(),d=s.getX(),h=s.getY(),m=r.getX(),y=r.getY(),I=a.getX(),z=a.getY(),Y=ae.CORR;return i<this.width/2?[new qe(I-Y,z+Y),new qe(d+Y,h+Y),new qe(m-Y,y-Y),new qe(i+Y,o-Y)]:[new qe(I+Y,z+Y),new qe(d+Y,h-Y),new qe(m-Y,y+Y),new qe(i-Y,o-Y)]}containsBlackPoint(t,s,r,a){const i=this.image;if(a){for(let o=t;o<=s;o++)if(i.get(o,r))return!0}else for(let o=t;o<=s;o++)if(i.get(r,o))return!0;return!1}}ae.INIT_SIZE=10,ae.CORR=1;class he{static checkAndNudgePoints(t,s){const r=t.getWidth(),a=t.getHeight();let i=!0;for(let o=0;o<s.length&&i;o+=2){const d=Math.floor(s[o]),h=Math.floor(s[o+1]);if(d<-1||d>r||h<-1||h>a)throw new G;i=!1,d===-1?(s[o]=0,i=!0):d===r&&(s[o]=r-1,i=!0),h===-1?(s[o+1]=0,i=!0):h===a&&(s[o+1]=a-1,i=!0)}i=!0;for(let o=s.length-2;o>=0&&i;o-=2){const d=Math.floor(s[o]),h=Math.floor(s[o+1]);if(d<-1||d>r||h<-1||h>a)throw new G;i=!1,d===-1?(s[o]=0,i=!0):d===r&&(s[o]=r-1,i=!0),h===-1?(s[o+1]=0,i=!0):h===a&&(s[o+1]=a-1,i=!0)}}}class Ae{constructor(t,s,r,a,i,o,d,h,m){this.a11=t,this.a21=s,this.a31=r,this.a12=a,this.a22=i,this.a32=o,this.a13=d,this.a23=h,this.a33=m}static quadrilateralToQuadrilateral(t,s,r,a,i,o,d,h,m,y,I,z,Y,ie,ce,Ne){const ze=Ae.quadrilateralToSquare(t,s,r,a,i,o,d,h);return Ae.squareToQuadrilateral(m,y,I,z,Y,ie,ce,Ne).times(ze)}transformPoints(t){const s=t.length,r=this.a11,a=this.a12,i=this.a13,o=this.a21,d=this.a22,h=this.a23,m=this.a31,y=this.a32,I=this.a33;for(let z=0;z<s;z+=2){const Y=t[z],ie=t[z+1],ce=i*Y+h*ie+I;t[z]=(r*Y+o*ie+m)/ce,t[z+1]=(a*Y+d*ie+y)/ce}}transformPointsWithValues(t,s){const r=this.a11,a=this.a12,i=this.a13,o=this.a21,d=this.a22,h=this.a23,m=this.a31,y=this.a32,I=this.a33,z=t.length;for(let Y=0;Y<z;Y++){const ie=t[Y],ce=s[Y],Ne=i*ie+h*ce+I;t[Y]=(r*ie+o*ce+m)/Ne,s[Y]=(a*ie+d*ce+y)/Ne}}static squareToQuadrilateral(t,s,r,a,i,o,d,h){const m=t-r+i-d,y=s-a+o-h;if(m===0&&y===0)return new Ae(r-t,i-r,t,a-s,o-a,s,0,0,1);{const I=r-i,z=d-i,Y=a-o,ie=h-o,ce=I*ie-z*Y,Ne=(m*ie-z*y)/ce,ze=(I*y-m*Y)/ce;return new Ae(r-t+Ne*r,d-t+ze*d,t,a-s+Ne*a,h-s+ze*h,s,Ne,ze,1)}}static quadrilateralToSquare(t,s,r,a,i,o,d,h){return Ae.squareToQuadrilateral(t,s,r,a,i,o,d,h).buildAdjoint()}buildAdjoint(){return new Ae(this.a22*this.a33-this.a23*this.a32,this.a23*this.a31-this.a21*this.a33,this.a21*this.a32-this.a22*this.a31,this.a13*this.a32-this.a12*this.a33,this.a11*this.a33-this.a13*this.a31,this.a12*this.a31-this.a11*this.a32,this.a12*this.a23-this.a13*this.a22,this.a13*this.a21-this.a11*this.a23,this.a11*this.a22-this.a12*this.a21)}times(t){return new Ae(this.a11*t.a11+this.a21*t.a12+this.a31*t.a13,this.a11*t.a21+this.a21*t.a22+this.a31*t.a23,this.a11*t.a31+this.a21*t.a32+this.a31*t.a33,this.a12*t.a11+this.a22*t.a12+this.a32*t.a13,this.a12*t.a21+this.a22*t.a22+this.a32*t.a23,this.a12*t.a31+this.a22*t.a32+this.a32*t.a33,this.a13*t.a11+this.a23*t.a12+this.a33*t.a13,this.a13*t.a21+this.a23*t.a22+this.a33*t.a23,this.a13*t.a31+this.a23*t.a32+this.a33*t.a33)}}class Re extends he{sampleGrid(t,s,r,a,i,o,d,h,m,y,I,z,Y,ie,ce,Ne,ze,Ge,Ye){const Ue=Ae.quadrilateralToQuadrilateral(a,i,o,d,h,m,y,I,z,Y,ie,ce,Ne,ze,Ge,Ye);return this.sampleGridWithTransform(t,s,r,Ue)}sampleGridWithTransform(t,s,r,a){if(s<=0||r<=0)throw new G;const i=new W(s,r),o=new Float32Array(2*s);for(let d=0;d<r;d++){const h=o.length,m=d+.5;for(let y=0;y<h;y+=2)o[y]=y/2+.5,o[y+1]=m;a.transformPoints(o),he.checkAndNudgePoints(t,o);try{for(let y=0;y<h;y+=2)t.get(Math.floor(o[y]),Math.floor(o[y+1]))&&i.set(y/2,d)}catch{throw new G}}return i}}class ee{static setGridSampler(t){ee.gridSampler=t}static getInstance(){return ee.gridSampler}}ee.gridSampler=new Re;class le{constructor(t,s){this.x=t,this.y=s}toResultPoint(){return new qe(this.getX(),this.getY())}getX(){return this.x}getY(){return this.y}}class Ee{constructor(t){this.EXPECTED_CORNER_BITS=new Int32Array([3808,476,2107,1799]),this.image=t}detect(){return this.detectMirror(!1)}detectMirror(t){let s=this.getMatrixCenter(),r=this.getBullsEyeCorners(s);if(t){let o=r[0];r[0]=r[2],r[2]=o}this.extractParameters(r);let a=this.sampleGrid(this.image,r[this.shift%4],r[(this.shift+1)%4],r[(this.shift+2)%4],r[(this.shift+3)%4]),i=this.getMatrixCornerPoints(r);return new H(a,i,this.compact,this.nbDataBlocks,this.nbLayers)}extractParameters(t){if(!this.isValidPoint(t[0])||!this.isValidPoint(t[1])||!this.isValidPoint(t[2])||!this.isValidPoint(t[3]))throw new G;let s=2*this.nbCenterLayers,r=new Int32Array([this.sampleLine(t[0],t[1],s),this.sampleLine(t[1],t[2],s),this.sampleLine(t[2],t[3],s),this.sampleLine(t[3],t[0],s)]);this.shift=this.getRotation(r,s);let a=0;for(let o=0;o<4;o++){let d=r[(this.shift+o)%4];this.compact?(a<<=7,a+=d>>1&127):(a<<=10,a+=(d>>2&992)+(d>>1&31))}let i=this.getCorrectedParameterData(a,this.compact);this.compact?(this.nbLayers=(i>>6)+1,this.nbDataBlocks=(i&63)+1):(this.nbLayers=(i>>11)+1,this.nbDataBlocks=(i&2047)+1)}getRotation(t,s){let r=0;t.forEach((a,i,o)=>{let d=(a>>s-2<<1)+(a&1);r=(r<<3)+d}),r=((r&1)<<11)+(r>>1);for(let a=0;a<4;a++)if(F.bitCount(r^this.EXPECTED_CORNER_BITS[a])<=2)return a;throw new G}getCorrectedParameterData(t,s){let r,a;s?(r=7,a=2):(r=10,a=4);let i=r-a,o=new Int32Array(r);for(let h=r-1;h>=0;--h)o[h]=t&15,t>>=4;try{new st(Fe.AZTEC_PARAM).decode(o,i)}catch{throw new G}let d=0;for(let h=0;h<a;h++)d=(d<<4)+o[h];return d}getBullsEyeCorners(t){let s=t,r=t,a=t,i=t,o=!0;for(this.nbCenterLayers=1;this.nbCenterLayers<9;this.nbCenterLayers++){let I=this.getFirstDifferent(s,o,1,-1),z=this.getFirstDifferent(r,o,1,1),Y=this.getFirstDifferent(a,o,-1,1),ie=this.getFirstDifferent(i,o,-1,-1);if(this.nbCenterLayers>2){let ce=this.distancePoint(ie,I)*this.nbCenterLayers/(this.distancePoint(i,s)*(this.nbCenterLayers+2));if(ce<.75||ce>1.25||!this.isWhiteOrBlackRectangle(I,z,Y,ie))break}s=I,r=z,a=Y,i=ie,o=!o}if(this.nbCenterLayers!==5&&this.nbCenterLayers!==7)throw new G;this.compact=this.nbCenterLayers===5;let d=new qe(s.getX()+.5,s.getY()-.5),h=new qe(r.getX()+.5,r.getY()+.5),m=new qe(a.getX()-.5,a.getY()+.5),y=new qe(i.getX()-.5,i.getY()-.5);return this.expandSquare([d,h,m,y],2*this.nbCenterLayers-3,2*this.nbCenterLayers)}getMatrixCenter(){let t,s,r,a;try{let d=new ae(this.image).detect();t=d[0],s=d[1],r=d[2],a=d[3]}catch{let h=this.image.getWidth()/2,m=this.image.getHeight()/2;t=this.getFirstDifferent(new le(h+7,m-7),!1,1,-1).toResultPoint(),s=this.getFirstDifferent(new le(h+7,m+7),!1,1,1).toResultPoint(),r=this.getFirstDifferent(new le(h-7,m+7),!1,-1,1).toResultPoint(),a=this.getFirstDifferent(new le(h-7,m-7),!1,-1,-1).toResultPoint()}let i=We.round((t.getX()+a.getX()+s.getX()+r.getX())/4),o=We.round((t.getY()+a.getY()+s.getY()+r.getY())/4);try{let d=new ae(this.image,15,i,o).detect();t=d[0],s=d[1],r=d[2],a=d[3]}catch{t=this.getFirstDifferent(new le(i+7,o-7),!1,1,-1).toResultPoint(),s=this.getFirstDifferent(new le(i+7,o+7),!1,1,1).toResultPoint(),r=this.getFirstDifferent(new le(i-7,o+7),!1,-1,1).toResultPoint(),a=this.getFirstDifferent(new le(i-7,o-7),!1,-1,-1).toResultPoint()}return i=We.round((t.getX()+a.getX()+s.getX()+r.getX())/4),o=We.round((t.getY()+a.getY()+s.getY()+r.getY())/4),new le(i,o)}getMatrixCornerPoints(t){return this.expandSquare(t,2*this.nbCenterLayers,this.getDimension())}sampleGrid(t,s,r,a,i){let o=ee.getInstance(),d=this.getDimension(),h=d/2-this.nbCenterLayers,m=d/2+this.nbCenterLayers;return o.sampleGrid(t,d,d,h,h,m,h,m,m,h,m,s.getX(),s.getY(),r.getX(),r.getY(),a.getX(),a.getY(),i.getX(),i.getY())}sampleLine(t,s,r){let a=0,i=this.distanceResultPoint(t,s),o=i/r,d=t.getX(),h=t.getY(),m=o*(s.getX()-t.getX())/i,y=o*(s.getY()-t.getY())/i;for(let I=0;I<r;I++)this.image.get(We.round(d+I*m),We.round(h+I*y))&&(a|=1<<r-I-1);return a}isWhiteOrBlackRectangle(t,s,r,a){let i=3;t=new le(t.getX()-i,t.getY()+i),s=new le(s.getX()-i,s.getY()-i),r=new le(r.getX()+i,r.getY()-i),a=new le(a.getX()+i,a.getY()+i);let o=this.getColor(a,t);if(o===0)return!1;let d=this.getColor(t,s);return d!==o||(d=this.getColor(s,r),d!==o)?!1:(d=this.getColor(r,a),d===o)}getColor(t,s){let r=this.distancePoint(t,s),a=(s.getX()-t.getX())/r,i=(s.getY()-t.getY())/r,o=0,d=t.getX(),h=t.getY(),m=this.image.get(t.getX(),t.getY()),y=Math.ceil(r);for(let z=0;z<y;z++)d+=a,h+=i,this.image.get(We.round(d),We.round(h))!==m&&o++;let I=o/r;return I>.1&&I<.9?0:I<=.1===m?1:-1}getFirstDifferent(t,s,r,a){let i=t.getX()+r,o=t.getY()+a;for(;this.isValid(i,o)&&this.image.get(i,o)===s;)i+=r,o+=a;for(i-=r,o-=a;this.isValid(i,o)&&this.image.get(i,o)===s;)i+=r;for(i-=r;this.isValid(i,o)&&this.image.get(i,o)===s;)o+=a;return o-=a,new le(i,o)}expandSquare(t,s,r){let a=r/(2*s),i=t[0].getX()-t[2].getX(),o=t[0].getY()-t[2].getY(),d=(t[0].getX()+t[2].getX())/2,h=(t[0].getY()+t[2].getY())/2,m=new qe(d+a*i,h+a*o),y=new qe(d-a*i,h-a*o);i=t[1].getX()-t[3].getX(),o=t[1].getY()-t[3].getY(),d=(t[1].getX()+t[3].getX())/2,h=(t[1].getY()+t[3].getY())/2;let I=new qe(d+a*i,h+a*o),z=new qe(d-a*i,h-a*o);return[m,I,y,z]}isValid(t,s){return t>=0&&t<this.image.getWidth()&&s>0&&s<this.image.getHeight()}isValidPoint(t){let s=We.round(t.getX()),r=We.round(t.getY());return this.isValid(s,r)}distancePoint(t,s){return We.distance(t.getX(),t.getY(),s.getX(),s.getY())}distanceResultPoint(t,s){return We.distance(t.getX(),t.getY(),s.getX(),s.getY())}getDimension(){return this.compact?4*this.nbLayers+11:this.nbLayers<=4?4*this.nbLayers+15:4*this.nbLayers+2*(F.truncDivision(this.nbLayers-4,8)+1)+15}}class _e{decode(t,s=null){let r=null,a=new Ee(t.getBlackMatrix()),i=null,o=null;try{let y=a.detectMirror(!1);i=y.getPoints(),this.reportFoundResultPoints(s,i),o=new Qe().decode(y)}catch(y){r=y}if(o==null)try{let y=a.detectMirror(!0);i=y.getPoints(),this.reportFoundResultPoints(s,i),o=new Qe().decode(y)}catch(y){throw r??y}let d=new L(o.getText(),o.getRawBytes(),o.getNumBits(),i,de.AZTEC,R.currentTimeMillis()),h=o.getByteSegments();h!=null&&d.putMetadata(ge.BYTE_SEGMENTS,h);let m=o.getECLevel();return m!=null&&d.putMetadata(ge.ERROR_CORRECTION_LEVEL,m),d}reportFoundResultPoints(t,s){if(t!=null){let r=t.get(N.NEED_RESULT_POINT_CALLBACK);r!=null&&s.forEach((a,i,o)=>{r.foundPossibleResultPoint(a)})}}reset(){}}class J extends Z{constructor(t=500){super(new _e,t)}}class ke{decode(t,s){try{return this.doDecode(t,s)}catch{if(s&&s.get(N.TRY_HARDER)===!0&&t.isRotateSupported()){const i=t.rotateCounterClockwise(),o=this.doDecode(i,s),d=o.getResultMetadata();let h=270;d!==null&&d.get(ge.ORIENTATION)===!0&&(h=h+d.get(ge.ORIENTATION)%360),o.putMetadata(ge.ORIENTATION,h);const m=o.getResultPoints();if(m!==null){const y=i.getHeight();for(let I=0;I<m.length;I++)m[I]=new qe(y-m[I].getY()-1,m[I].getX())}return o}else throw new G}}reset(){}doDecode(t,s){const r=t.getWidth(),a=t.getHeight();let i=new U(r);const o=s&&s.get(N.TRY_HARDER)===!0,d=Math.max(1,a>>(o?8:5));let h;o?h=a:h=15;const m=Math.trunc(a/2);for(let y=0;y<h;y++){const I=Math.trunc((y+1)/2),z=(y&1)===0,Y=m+d*(z?I:-I);if(Y<0||Y>=a)break;try{i=t.getBlackRow(Y,i)}catch{continue}for(let ie=0;ie<2;ie++){if(ie===1&&(i.reverse(),s&&s.get(N.NEED_RESULT_POINT_CALLBACK)===!0)){const ce=new Map;s.forEach((Ne,ze)=>ce.set(ze,Ne)),ce.delete(N.NEED_RESULT_POINT_CALLBACK),s=ce}try{const ce=this.decodeRow(Y,i,s);if(ie===1){ce.putMetadata(ge.ORIENTATION,180);const Ne=ce.getResultPoints();Ne!==null&&(Ne[0]=new qe(r-Ne[0].getX()-1,Ne[0].getY()),Ne[1]=new qe(r-Ne[1].getX()-1,Ne[1].getY()))}return ce}catch{}}}throw new G}static recordPattern(t,s,r){const a=r.length;for(let m=0;m<a;m++)r[m]=0;const i=t.getSize();if(s>=i)throw new G;let o=!t.get(s),d=0,h=s;for(;h<i;){if(t.get(h)!==o)r[d]++;else{if(++d===a)break;r[d]=1,o=!o}h++}if(!(d===a||d===a-1&&h===i))throw new G}static recordPatternInReverse(t,s,r){let a=r.length,i=t.get(s);for(;s>0&&a>=0;)t.get(--s)!==i&&(a--,i=!i);if(a>=0)throw new G;ke.recordPattern(t,s+1,r)}static patternMatchVariance(t,s,r){const a=t.length;let i=0,o=0;for(let m=0;m<a;m++)i+=t[m],o+=s[m];if(i<o)return Number.POSITIVE_INFINITY;const d=i/o;r*=d;let h=0;for(let m=0;m<a;m++){const y=t[m],I=s[m]*d,z=y>I?y-I:I-y;if(z>r)return Number.POSITIVE_INFINITY;h+=z}return h/i}}class $ extends ke{static findStartPattern(t){const s=t.getSize(),r=t.getNextSet(0);let a=0,i=Int32Array.from([0,0,0,0,0,0]),o=r,d=!1;const h=6;for(let m=r;m<s;m++)if(t.get(m)!==d)i[a]++;else{if(a===h-1){let y=$.MAX_AVG_VARIANCE,I=-1;for(let z=$.CODE_START_A;z<=$.CODE_START_C;z++){const Y=ke.patternMatchVariance(i,$.CODE_PATTERNS[z],$.MAX_INDIVIDUAL_VARIANCE);Y<y&&(y=Y,I=z)}if(I>=0&&t.isRange(Math.max(0,o-(m-o)/2),o,!1))return Int32Array.from([o,m,I]);o+=i[0]+i[1],i=i.slice(2,i.length-1),i[a-1]=0,i[a]=0,a--}else a++;i[a]=1,d=!d}throw new G}static decodeCode(t,s,r){ke.recordPattern(t,r,s);let a=$.MAX_AVG_VARIANCE,i=-1;for(let o=0;o<$.CODE_PATTERNS.length;o++){const d=$.CODE_PATTERNS[o],h=this.patternMatchVariance(s,d,$.MAX_INDIVIDUAL_VARIANCE);h<a&&(a=h,i=o)}if(i>=0)return i;throw new G}decodeRow(t,s,r){const a=r&&r.get(N.ASSUME_GS1)===!0,i=$.findStartPattern(s),o=i[2];let d=0;const h=new Uint8Array(20);h[d++]=o;let m;switch(o){case $.CODE_START_A:m=$.CODE_CODE_A;break;case $.CODE_START_B:m=$.CODE_CODE_B;break;case $.CODE_START_C:m=$.CODE_CODE_C;break;default:throw new _}let y=!1,I=!1,z="",Y=i[0],ie=i[1];const ce=Int32Array.from([0,0,0,0,0,0]);let Ne=0,ze=0,Ge=o,Ye=0,Ue=!0,Ct=!1,ft=!1;for(;!y;){const Nr=I;switch(I=!1,Ne=ze,ze=$.decodeCode(s,ce,ie),h[d++]=ze,ze!==$.CODE_STOP&&(Ue=!0),ze!==$.CODE_STOP&&(Ye++,Ge+=Ye*ze),Y=ie,ie+=ce.reduce((lo,co)=>lo+co,0),ze){case $.CODE_START_A:case $.CODE_START_B:case $.CODE_START_C:throw new _}switch(m){case $.CODE_CODE_A:if(ze<64)ft===Ct?z+=String.fromCharCode(32+ze):z+=String.fromCharCode(32+ze+128),ft=!1;else if(ze<96)ft===Ct?z+=String.fromCharCode(ze-64):z+=String.fromCharCode(ze+64),ft=!1;else switch(ze!==$.CODE_STOP&&(Ue=!1),ze){case $.CODE_FNC_1:a&&(z.length===0?z+="]C1":z+="");break;case $.CODE_FNC_2:case $.CODE_FNC_3:break;case $.CODE_FNC_4_A:!Ct&&ft?(Ct=!0,ft=!1):Ct&&ft?(Ct=!1,ft=!1):ft=!0;break;case $.CODE_SHIFT:I=!0,m=$.CODE_CODE_B;break;case $.CODE_CODE_B:m=$.CODE_CODE_B;break;case $.CODE_CODE_C:m=$.CODE_CODE_C;break;case $.CODE_STOP:y=!0;break}break;case $.CODE_CODE_B:if(ze<96)ft===Ct?z+=String.fromCharCode(32+ze):z+=String.fromCharCode(32+ze+128),ft=!1;else switch(ze!==$.CODE_STOP&&(Ue=!1),ze){case $.CODE_FNC_1:a&&(z.length===0?z+="]C1":z+="");break;case $.CODE_FNC_2:case $.CODE_FNC_3:break;case $.CODE_FNC_4_B:!Ct&&ft?(Ct=!0,ft=!1):Ct&&ft?(Ct=!1,ft=!1):ft=!0;break;case $.CODE_SHIFT:I=!0,m=$.CODE_CODE_A;break;case $.CODE_CODE_A:m=$.CODE_CODE_A;break;case $.CODE_CODE_C:m=$.CODE_CODE_C;break;case $.CODE_STOP:y=!0;break}break;case $.CODE_CODE_C:if(ze<100)ze<10&&(z+="0"),z+=ze;else switch(ze!==$.CODE_STOP&&(Ue=!1),ze){case $.CODE_FNC_1:a&&(z.length===0?z+="]C1":z+="");break;case $.CODE_CODE_A:m=$.CODE_CODE_A;break;case $.CODE_CODE_B:m=$.CODE_CODE_B;break;case $.CODE_STOP:y=!0;break}break}Nr&&(m=m===$.CODE_CODE_A?$.CODE_CODE_B:$.CODE_CODE_A)}const ps=ie-Y;if(ie=s.getNextUnset(ie),!s.isRange(ie,Math.min(s.getSize(),ie+(ie-Y)/2),!1))throw new G;if(Ge-=Ye*Ne,Ge%103!==Ne)throw new P;const zs=z.length;if(zs===0)throw new G;zs>0&&Ue&&(m===$.CODE_CODE_C?z=z.substring(0,zs-2):z=z.substring(0,zs-1));const bs=(i[1]+i[0])/2,Ot=Y+ps/2,ns=h.length,ys=new Uint8Array(ns);for(let Nr=0;Nr<ns;Nr++)ys[Nr]=h[Nr];const vr=[new qe(bs,t),new qe(Ot,t)];return new L(z,ys,0,vr,de.CODE_128,new Date().getTime())}}$.CODE_PATTERNS=[Int32Array.from([2,1,2,2,2,2]),Int32Array.from([2,2,2,1,2,2]),Int32Array.from([2,2,2,2,2,1]),Int32Array.from([1,2,1,2,2,3]),Int32Array.from([1,2,1,3,2,2]),Int32Array.from([1,3,1,2,2,2]),Int32Array.from([1,2,2,2,1,3]),Int32Array.from([1,2,2,3,1,2]),Int32Array.from([1,3,2,2,1,2]),Int32Array.from([2,2,1,2,1,3]),Int32Array.from([2,2,1,3,1,2]),Int32Array.from([2,3,1,2,1,2]),Int32Array.from([1,1,2,2,3,2]),Int32Array.from([1,2,2,1,3,2]),Int32Array.from([1,2,2,2,3,1]),Int32Array.from([1,1,3,2,2,2]),Int32Array.from([1,2,3,1,2,2]),Int32Array.from([1,2,3,2,2,1]),Int32Array.from([2,2,3,2,1,1]),Int32Array.from([2,2,1,1,3,2]),Int32Array.from([2,2,1,2,3,1]),Int32Array.from([2,1,3,2,1,2]),Int32Array.from([2,2,3,1,1,2]),Int32Array.from([3,1,2,1,3,1]),Int32Array.from([3,1,1,2,2,2]),Int32Array.from([3,2,1,1,2,2]),Int32Array.from([3,2,1,2,2,1]),Int32Array.from([3,1,2,2,1,2]),Int32Array.from([3,2,2,1,1,2]),Int32Array.from([3,2,2,2,1,1]),Int32Array.from([2,1,2,1,2,3]),Int32Array.from([2,1,2,3,2,1]),Int32Array.from([2,3,2,1,2,1]),Int32Array.from([1,1,1,3,2,3]),Int32Array.from([1,3,1,1,2,3]),Int32Array.from([1,3,1,3,2,1]),Int32Array.from([1,1,2,3,1,3]),Int32Array.from([1,3,2,1,1,3]),Int32Array.from([1,3,2,3,1,1]),Int32Array.from([2,1,1,3,1,3]),Int32Array.from([2,3,1,1,1,3]),Int32Array.from([2,3,1,3,1,1]),Int32Array.from([1,1,2,1,3,3]),Int32Array.from([1,1,2,3,3,1]),Int32Array.from([1,3,2,1,3,1]),Int32Array.from([1,1,3,1,2,3]),Int32Array.from([1,1,3,3,2,1]),Int32Array.from([1,3,3,1,2,1]),Int32Array.from([3,1,3,1,2,1]),Int32Array.from([2,1,1,3,3,1]),Int32Array.from([2,3,1,1,3,1]),Int32Array.from([2,1,3,1,1,3]),Int32Array.from([2,1,3,3,1,1]),Int32Array.from([2,1,3,1,3,1]),Int32Array.from([3,1,1,1,2,3]),Int32Array.from([3,1,1,3,2,1]),Int32Array.from([3,3,1,1,2,1]),Int32Array.from([3,1,2,1,1,3]),Int32Array.from([3,1,2,3,1,1]),Int32Array.from([3,3,2,1,1,1]),Int32Array.from([3,1,4,1,1,1]),Int32Array.from([2,2,1,4,1,1]),Int32Array.from([4,3,1,1,1,1]),Int32Array.from([1,1,1,2,2,4]),Int32Array.from([1,1,1,4,2,2]),Int32Array.from([1,2,1,1,2,4]),Int32Array.from([1,2,1,4,2,1]),Int32Array.from([1,4,1,1,2,2]),Int32Array.from([1,4,1,2,2,1]),Int32Array.from([1,1,2,2,1,4]),Int32Array.from([1,1,2,4,1,2]),Int32Array.from([1,2,2,1,1,4]),Int32Array.from([1,2,2,4,1,1]),Int32Array.from([1,4,2,1,1,2]),Int32Array.from([1,4,2,2,1,1]),Int32Array.from([2,4,1,2,1,1]),Int32Array.from([2,2,1,1,1,4]),Int32Array.from([4,1,3,1,1,1]),Int32Array.from([2,4,1,1,1,2]),Int32Array.from([1,3,4,1,1,1]),Int32Array.from([1,1,1,2,4,2]),Int32Array.from([1,2,1,1,4,2]),Int32Array.from([1,2,1,2,4,1]),Int32Array.from([1,1,4,2,1,2]),Int32Array.from([1,2,4,1,1,2]),Int32Array.from([1,2,4,2,1,1]),Int32Array.from([4,1,1,2,1,2]),Int32Array.from([4,2,1,1,1,2]),Int32Array.from([4,2,1,2,1,1]),Int32Array.from([2,1,2,1,4,1]),Int32Array.from([2,1,4,1,2,1]),Int32Array.from([4,1,2,1,2,1]),Int32Array.from([1,1,1,1,4,3]),Int32Array.from([1,1,1,3,4,1]),Int32Array.from([1,3,1,1,4,1]),Int32Array.from([1,1,4,1,1,3]),Int32Array.from([1,1,4,3,1,1]),Int32Array.from([4,1,1,1,1,3]),Int32Array.from([4,1,1,3,1,1]),Int32Array.from([1,1,3,1,4,1]),Int32Array.from([1,1,4,1,3,1]),Int32Array.from([3,1,1,1,4,1]),Int32Array.from([4,1,1,1,3,1]),Int32Array.from([2,1,1,4,1,2]),Int32Array.from([2,1,1,2,1,4]),Int32Array.from([2,1,1,2,3,2]),Int32Array.from([2,3,3,1,1,1,2])],$.MAX_AVG_VARIANCE=.25,$.MAX_INDIVIDUAL_VARIANCE=.7,$.CODE_SHIFT=98,$.CODE_CODE_C=99,$.CODE_CODE_B=100,$.CODE_CODE_A=101,$.CODE_FNC_1=102,$.CODE_FNC_2=97,$.CODE_FNC_3=96,$.CODE_FNC_4_A=101,$.CODE_FNC_4_B=100,$.CODE_START_A=103,$.CODE_START_B=104,$.CODE_START_C=105,$.CODE_STOP=106;class ue extends ke{constructor(t=!1,s=!1){super(),this.usingCheckDigit=t,this.extendedMode=s,this.decodeRowResult="",this.counters=new Int32Array(9)}decodeRow(t,s,r){let a=this.counters;a.fill(0),this.decodeRowResult="";let i=ue.findAsteriskPattern(s,a),o=s.getNextSet(i[1]),d=s.getSize(),h,m;do{ue.recordPattern(s,o,a);let ce=ue.toNarrowWidePattern(a);if(ce<0)throw new G;h=ue.patternToChar(ce),this.decodeRowResult+=h,m=o;for(let Ne of a)o+=Ne;o=s.getNextSet(o)}while(h!=="*");this.decodeRowResult=this.decodeRowResult.substring(0,this.decodeRowResult.length-1);let y=0;for(let ce of a)y+=ce;let I=o-m-y;if(o!==d&&I*2<y)throw new G;if(this.usingCheckDigit){let ce=this.decodeRowResult.length-1,Ne=0;for(let ze=0;ze<ce;ze++)Ne+=ue.ALPHABET_STRING.indexOf(this.decodeRowResult.charAt(ze));if(this.decodeRowResult.charAt(ce)!==ue.ALPHABET_STRING.charAt(Ne%43))throw new P;this.decodeRowResult=this.decodeRowResult.substring(0,ce)}if(this.decodeRowResult.length===0)throw new G;let z;this.extendedMode?z=ue.decodeExtended(this.decodeRowResult):z=this.decodeRowResult;let Y=(i[1]+i[0])/2,ie=m+y/2;return new L(z,null,0,[new qe(Y,t),new qe(ie,t)],de.CODE_39,new Date().getTime())}static findAsteriskPattern(t,s){let r=t.getSize(),a=t.getNextSet(0),i=0,o=a,d=!1,h=s.length;for(let m=a;m<r;m++)if(t.get(m)!==d)s[i]++;else{if(i===h-1){if(this.toNarrowWidePattern(s)===ue.ASTERISK_ENCODING&&t.isRange(Math.max(0,o-Math.floor((m-o)/2)),o,!1))return[o,m];o+=s[0]+s[1],s.copyWithin(0,2,2+i-1),s[i-1]=0,s[i]=0,i--}else i++;s[i]=1,d=!d}throw new G}static toNarrowWidePattern(t){let s=t.length,r=0,a;do{let i=2147483647;for(let h of t)h<i&&h>r&&(i=h);r=i,a=0;let o=0,d=0;for(let h=0;h<s;h++){let m=t[h];m>r&&(d|=1<<s-1-h,a++,o+=m)}if(a===3){for(let h=0;h<s&&a>0;h++){let m=t[h];if(m>r&&(a--,m*2>=o))return-1}return d}}while(a>3);return-1}static patternToChar(t){for(let s=0;s<ue.CHARACTER_ENCODINGS.length;s++)if(ue.CHARACTER_ENCODINGS[s]===t)return ue.ALPHABET_STRING.charAt(s);if(t===ue.ASTERISK_ENCODING)return"*";throw new G}static decodeExtended(t){let s=t.length,r="";for(let a=0;a<s;a++){let i=t.charAt(a);if(i==="+"||i==="$"||i==="%"||i==="/"){let o=t.charAt(a+1),d="\0";switch(i){case"+":if(o>="A"&&o<="Z")d=String.fromCharCode(o.charCodeAt(0)+32);else throw new _;break;case"$":if(o>="A"&&o<="Z")d=String.fromCharCode(o.charCodeAt(0)-64);else throw new _;break;case"%":if(o>="A"&&o<="E")d=String.fromCharCode(o.charCodeAt(0)-38);else if(o>="F"&&o<="J")d=String.fromCharCode(o.charCodeAt(0)-11);else if(o>="K"&&o<="O")d=String.fromCharCode(o.charCodeAt(0)+16);else if(o>="P"&&o<="T")d=String.fromCharCode(o.charCodeAt(0)+43);else if(o==="U")d="\0";else if(o==="V")d="@";else if(o==="W")d="`";else if(o==="X"||o==="Y"||o==="Z")d="";else throw new _;break;case"/":if(o>="A"&&o<="O")d=String.fromCharCode(o.charCodeAt(0)-32);else if(o==="Z")d=":";else throw new _;break}r+=d,a++}else r+=i}return r}}ue.ALPHABET_STRING="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-. $/+%",ue.CHARACTER_ENCODINGS=[52,289,97,352,49,304,112,37,292,100,265,73,328,25,280,88,13,268,76,28,259,67,322,19,274,82,7,262,70,22,385,193,448,145,400,208,133,388,196,168,162,138,42],ue.ASTERISK_ENCODING=148;class xe extends ke{constructor(){super(...arguments),this.narrowLineWidth=-1}decodeRow(t,s,r){let a=this.decodeStart(s),i=this.decodeEnd(s),o=new se;xe.decodeMiddle(s,a[1],i[0],o);let d=o.toString(),h=null;r!=null&&(h=r.get(N.ALLOWED_LENGTHS)),h==null&&(h=xe.DEFAULT_ALLOWED_LENGTHS);let m=d.length,y=!1,I=0;for(let ie of h){if(m===ie){y=!0;break}ie>I&&(I=ie)}if(!y&&m>I&&(y=!0),!y)throw new _;const z=[new qe(a[1],t),new qe(i[0],t)];return new L(d,null,0,z,de.ITF,new Date().getTime())}static decodeMiddle(t,s,r,a){let i=new Int32Array(10),o=new Int32Array(5),d=new Int32Array(5);for(i.fill(0),o.fill(0),d.fill(0);s<r;){ke.recordPattern(t,s,i);for(let m=0;m<5;m++){let y=2*m;o[m]=i[y],d[m]=i[y+1]}let h=xe.decodeDigit(o);a.append(h.toString()),h=this.decodeDigit(d),a.append(h.toString()),i.forEach(function(m){s+=m})}}decodeStart(t){let s=xe.skipWhiteSpace(t),r=xe.findGuardPattern(t,s,xe.START_PATTERN);return this.narrowLineWidth=(r[1]-r[0])/4,this.validateQuietZone(t,r[0]),r}validateQuietZone(t,s){let r=this.narrowLineWidth*10;r=r<s?r:s;for(let a=s-1;r>0&&a>=0&&!t.get(a);a--)r--;if(r!==0)throw new G}static skipWhiteSpace(t){const s=t.getSize(),r=t.getNextSet(0);if(r===s)throw new G;return r}decodeEnd(t){t.reverse();try{let s=xe.skipWhiteSpace(t),r;try{r=xe.findGuardPattern(t,s,xe.END_PATTERN_REVERSED[0])}catch(i){i instanceof G&&(r=xe.findGuardPattern(t,s,xe.END_PATTERN_REVERSED[1]))}this.validateQuietZone(t,r[0]);let a=r[0];return r[0]=t.getSize()-r[1],r[1]=t.getSize()-a,r}finally{t.reverse()}}static findGuardPattern(t,s,r){let a=r.length,i=new Int32Array(a),o=t.getSize(),d=!1,h=0,m=s;i.fill(0);for(let y=s;y<o;y++)if(t.get(y)!==d)i[h]++;else{if(h===a-1){if(ke.patternMatchVariance(i,r,xe.MAX_INDIVIDUAL_VARIANCE)<xe.MAX_AVG_VARIANCE)return[m,y];m+=i[0]+i[1],R.arraycopy(i,2,i,0,h-1),i[h-1]=0,i[h]=0,h--}else h++;i[h]=1,d=!d}throw new G}static decodeDigit(t){let s=xe.MAX_AVG_VARIANCE,r=-1,a=xe.PATTERNS.length;for(let i=0;i<a;i++){let o=xe.PATTERNS[i],d=ke.patternMatchVariance(t,o,xe.MAX_INDIVIDUAL_VARIANCE);d<s?(s=d,r=i):d===s&&(r=-1)}if(r>=0)return r%10;throw new G}}xe.PATTERNS=[Int32Array.from([1,1,2,2,1]),Int32Array.from([2,1,1,1,2]),Int32Array.from([1,2,1,1,2]),Int32Array.from([2,2,1,1,1]),Int32Array.from([1,1,2,1,2]),Int32Array.from([2,1,2,1,1]),Int32Array.from([1,2,2,1,1]),Int32Array.from([1,1,1,2,2]),Int32Array.from([2,1,1,2,1]),Int32Array.from([1,2,1,2,1]),Int32Array.from([1,1,3,3,1]),Int32Array.from([3,1,1,1,3]),Int32Array.from([1,3,1,1,3]),Int32Array.from([3,3,1,1,1]),Int32Array.from([1,1,3,1,3]),Int32Array.from([3,1,3,1,1]),Int32Array.from([1,3,3,1,1]),Int32Array.from([1,1,1,3,3]),Int32Array.from([3,1,1,3,1]),Int32Array.from([1,3,1,3,1])],xe.MAX_AVG_VARIANCE=.38,xe.MAX_INDIVIDUAL_VARIANCE=.5,xe.DEFAULT_ALLOWED_LENGTHS=[6,8,10,12,14],xe.START_PATTERN=Int32Array.from([1,1,1,1]),xe.END_PATTERN_REVERSED=[Int32Array.from([1,1,2]),Int32Array.from([1,1,3])];class pe extends ke{constructor(){super(...arguments),this.decodeRowStringBuffer=""}static findStartGuardPattern(t){let s=!1,r,a=0,i=Int32Array.from([0,0,0]);for(;!s;){i=Int32Array.from([0,0,0]),r=pe.findGuardPattern(t,a,!1,this.START_END_PATTERN,i);let o=r[0];a=r[1];let d=o-(a-o);d>=0&&(s=t.isRange(d,o,!1))}return r}static checkChecksum(t){return pe.checkStandardUPCEANChecksum(t)}static checkStandardUPCEANChecksum(t){let s=t.length;if(s===0)return!1;let r=parseInt(t.charAt(s-1),10);return pe.getStandardUPCEANChecksum(t.substring(0,s-1))===r}static getStandardUPCEANChecksum(t){let s=t.length,r=0;for(let a=s-1;a>=0;a-=2){let i=t.charAt(a).charCodeAt(0)-48;if(i<0||i>9)throw new _;r+=i}r*=3;for(let a=s-2;a>=0;a-=2){let i=t.charAt(a).charCodeAt(0)-48;if(i<0||i>9)throw new _;r+=i}return(1e3-r)%10}static decodeEnd(t,s){return pe.findGuardPattern(t,s,!1,pe.START_END_PATTERN,new Int32Array(pe.START_END_PATTERN.length).fill(0))}static findGuardPatternWithoutCounters(t,s,r,a){return this.findGuardPattern(t,s,r,a,new Int32Array(a.length))}static findGuardPattern(t,s,r,a,i){let o=t.getSize();s=r?t.getNextUnset(s):t.getNextSet(s);let d=0,h=s,m=a.length,y=r;for(let I=s;I<o;I++)if(t.get(I)!==y)i[d]++;else{if(d===m-1){if(ke.patternMatchVariance(i,a,pe.MAX_INDIVIDUAL_VARIANCE)<pe.MAX_AVG_VARIANCE)return Int32Array.from([h,I]);h+=i[0]+i[1];let z=i.slice(2,i.length-1);for(let Y=0;Y<d-1;Y++)i[Y]=z[Y];i[d-1]=0,i[d]=0,d--}else d++;i[d]=1,y=!y}throw new G}static decodeDigit(t,s,r,a){this.recordPattern(t,r,s);let i=this.MAX_AVG_VARIANCE,o=-1,d=a.length;for(let h=0;h<d;h++){let m=a[h],y=ke.patternMatchVariance(s,m,pe.MAX_INDIVIDUAL_VARIANCE);y<i&&(i=y,o=h)}if(o>=0)return o;throw new G}}pe.MAX_AVG_VARIANCE=.48,pe.MAX_INDIVIDUAL_VARIANCE=.7,pe.START_END_PATTERN=Int32Array.from([1,1,1]),pe.MIDDLE_PATTERN=Int32Array.from([1,1,1,1,1]),pe.END_PATTERN=Int32Array.from([1,1,1,1,1,1]),pe.L_PATTERNS=[Int32Array.from([3,2,1,1]),Int32Array.from([2,2,2,1]),Int32Array.from([2,1,2,2]),Int32Array.from([1,4,1,1]),Int32Array.from([1,1,3,2]),Int32Array.from([1,2,3,1]),Int32Array.from([1,1,1,4]),Int32Array.from([1,3,1,2]),Int32Array.from([1,2,1,3]),Int32Array.from([3,1,1,2])];class Ze{constructor(){this.CHECK_DIGIT_ENCODINGS=[24,20,18,17,12,6,3,10,9,5],this.decodeMiddleCounters=Int32Array.from([0,0,0,0]),this.decodeRowStringBuffer=""}decodeRow(t,s,r){let a=this.decodeRowStringBuffer,i=this.decodeMiddle(s,r,a),o=a.toString(),d=Ze.parseExtensionString(o),h=[new qe((r[0]+r[1])/2,t),new qe(i,t)],m=new L(o,null,0,h,de.UPC_EAN_EXTENSION,new Date().getTime());return d!=null&&m.putAllMetadata(d),m}decodeMiddle(t,s,r){let a=this.decodeMiddleCounters;a[0]=0,a[1]=0,a[2]=0,a[3]=0;let i=t.getSize(),o=s[1],d=0;for(let m=0;m<5&&o<i;m++){let y=pe.decodeDigit(t,a,o,pe.L_AND_G_PATTERNS);r+=String.fromCharCode(48+y%10);for(let I of a)o+=I;y>=10&&(d|=1<<4-m),m!==4&&(o=t.getNextSet(o),o=t.getNextUnset(o))}if(r.length!==5)throw new G;let h=this.determineCheckDigit(d);if(Ze.extensionChecksum(r.toString())!==h)throw new G;return o}static extensionChecksum(t){let s=t.length,r=0;for(let a=s-2;a>=0;a-=2)r+=t.charAt(a).charCodeAt(0)-48;r*=3;for(let a=s-1;a>=0;a-=2)r+=t.charAt(a).charCodeAt(0)-48;return r*=3,r%10}determineCheckDigit(t){for(let s=0;s<10;s++)if(t===this.CHECK_DIGIT_ENCODINGS[s])return s;throw new G}static parseExtensionString(t){if(t.length!==5)return null;let s=Ze.parseExtension5String(t);return s==null?null:new Map([[ge.SUGGESTED_PRICE,s]])}static parseExtension5String(t){let s;switch(t.charAt(0)){case"0":s="¬£";break;case"5":s="$";break;case"9":switch(t){case"90000":return null;case"99991":return"0.00";case"99990":return"Used"}s="";break;default:s="";break}let r=parseInt(t.substring(1)),a=(r/100).toString(),i=r%100,o=i<10?"0"+i:i.toString();return s+a+"."+o}}class at{constructor(){this.decodeMiddleCounters=Int32Array.from([0,0,0,0]),this.decodeRowStringBuffer=""}decodeRow(t,s,r){let a=this.decodeRowStringBuffer,i=this.decodeMiddle(s,r,a),o=a.toString(),d=at.parseExtensionString(o),h=[new qe((r[0]+r[1])/2,t),new qe(i,t)],m=new L(o,null,0,h,de.UPC_EAN_EXTENSION,new Date().getTime());return d!=null&&m.putAllMetadata(d),m}decodeMiddle(t,s,r){let a=this.decodeMiddleCounters;a[0]=0,a[1]=0,a[2]=0,a[3]=0;let i=t.getSize(),o=s[1],d=0;for(let h=0;h<2&&o<i;h++){let m=pe.decodeDigit(t,a,o,pe.L_AND_G_PATTERNS);r+=String.fromCharCode(48+m%10);for(let y of a)o+=y;m>=10&&(d|=1<<1-h),h!==1&&(o=t.getNextSet(o),o=t.getNextUnset(o))}if(r.length!==2)throw new G;if(parseInt(r.toString())%4!==d)throw new G;return o}static parseExtensionString(t){return t.length!==2?null:new Map([[ge.ISSUE_NUMBER,parseInt(t)]])}}class bt{static decodeRow(t,s,r){let a=pe.findGuardPattern(s,r,!1,this.EXTENSION_START_PATTERN,new Int32Array(this.EXTENSION_START_PATTERN.length).fill(0));try{return new Ze().decodeRow(t,s,a)}catch{return new at().decodeRow(t,s,a)}}}bt.EXTENSION_START_PATTERN=Int32Array.from([1,1,2]);class Oe extends pe{constructor(){super(),this.decodeRowStringBuffer="",Oe.L_AND_G_PATTERNS=Oe.L_PATTERNS.map(t=>Int32Array.from(t));for(let t=10;t<20;t++){let s=Oe.L_PATTERNS[t-10],r=new Int32Array(s.length);for(let a=0;a<s.length;a++)r[a]=s[s.length-a-1];Oe.L_AND_G_PATTERNS[t]=r}}decodeRow(t,s,r){let a=Oe.findStartGuardPattern(s),i=r==null?null:r.get(N.NEED_RESULT_POINT_CALLBACK);if(i!=null){const Ue=new qe((a[0]+a[1])/2,t);i.foundPossibleResultPoint(Ue)}let o=this.decodeMiddle(s,a,this.decodeRowStringBuffer),d=o.rowOffset,h=o.resultString;if(i!=null){const Ue=new qe(d,t);i.foundPossibleResultPoint(Ue)}let m=this.decodeEnd(s,d);if(i!=null){const Ue=new qe((m[0]+m[1])/2,t);i.foundPossibleResultPoint(Ue)}let y=m[1],I=y+(y-m[0]);if(I>=s.getSize()||!s.isRange(y,I,!1))throw new G;let z=h.toString();if(z.length<8)throw new _;if(!Oe.checkChecksum(z))throw new P;let Y=(a[1]+a[0])/2,ie=(m[1]+m[0])/2,ce=this.getBarcodeFormat(),Ne=[new qe(Y,t),new qe(ie,t)],ze=new L(z,null,0,Ne,ce,new Date().getTime()),Ge=0;try{let Ue=bt.decodeRow(t,s,m[1]);ze.putMetadata(ge.UPC_EAN_EXTENSION,Ue.getText()),ze.putAllMetadata(Ue.getResultMetadata()),ze.addResultPoints(Ue.getResultPoints()),Ge=Ue.getText().length}catch{}let Ye=r==null?null:r.get(N.ALLOWED_EAN_EXTENSIONS);if(Ye!=null){let Ue=!1;for(let Ct in Ye)if(Ge.toString()===Ct){Ue=!0;break}if(!Ue)throw new G}return ze}decodeEnd(t,s){return Oe.findGuardPattern(t,s,!1,Oe.START_END_PATTERN,new Int32Array(Oe.START_END_PATTERN.length).fill(0))}static checkChecksum(t){return Oe.checkStandardUPCEANChecksum(t)}static checkStandardUPCEANChecksum(t){let s=t.length;if(s===0)return!1;let r=parseInt(t.charAt(s-1),10);return Oe.getStandardUPCEANChecksum(t.substring(0,s-1))===r}static getStandardUPCEANChecksum(t){let s=t.length,r=0;for(let a=s-1;a>=0;a-=2){let i=t.charAt(a).charCodeAt(0)-48;if(i<0||i>9)throw new _;r+=i}r*=3;for(let a=s-2;a>=0;a-=2){let i=t.charAt(a).charCodeAt(0)-48;if(i<0||i>9)throw new _;r+=i}return(1e3-r)%10}}class It extends Oe{constructor(){super(),this.decodeMiddleCounters=Int32Array.from([0,0,0,0])}decodeMiddle(t,s,r){let a=this.decodeMiddleCounters;a[0]=0,a[1]=0,a[2]=0,a[3]=0;let i=t.getSize(),o=s[1],d=0;for(let m=0;m<6&&o<i;m++){let y=Oe.decodeDigit(t,a,o,Oe.L_AND_G_PATTERNS);r+=String.fromCharCode(48+y%10);for(let I of a)o+=I;y>=10&&(d|=1<<5-m)}r=It.determineFirstDigit(r,d),o=Oe.findGuardPattern(t,o,!0,Oe.MIDDLE_PATTERN,new Int32Array(Oe.MIDDLE_PATTERN.length).fill(0))[1];for(let m=0;m<6&&o<i;m++){let y=Oe.decodeDigit(t,a,o,Oe.L_PATTERNS);r+=String.fromCharCode(48+y);for(let I of a)o+=I}return{rowOffset:o,resultString:r}}getBarcodeFormat(){return de.EAN_13}static determineFirstDigit(t,s){for(let r=0;r<10;r++)if(s===this.FIRST_DIGIT_ENCODINGS[r])return t=String.fromCharCode(48+r)+t,t;throw new G}}It.FIRST_DIGIT_ENCODINGS=[0,11,13,14,19,25,28,21,22,26];class ct extends Oe{constructor(){super(),this.decodeMiddleCounters=Int32Array.from([0,0,0,0])}decodeMiddle(t,s,r){const a=this.decodeMiddleCounters;a[0]=0,a[1]=0,a[2]=0,a[3]=0;let i=t.getSize(),o=s[1];for(let h=0;h<4&&o<i;h++){let m=Oe.decodeDigit(t,a,o,Oe.L_PATTERNS);r+=String.fromCharCode(48+m);for(let y of a)o+=y}o=Oe.findGuardPattern(t,o,!0,Oe.MIDDLE_PATTERN,new Int32Array(Oe.MIDDLE_PATTERN.length).fill(0))[1];for(let h=0;h<4&&o<i;h++){let m=Oe.decodeDigit(t,a,o,Oe.L_PATTERNS);r+=String.fromCharCode(48+m);for(let y of a)o+=y}return{rowOffset:o,resultString:r}}getBarcodeFormat(){return de.EAN_8}}class ws extends Oe{constructor(){super(...arguments),this.ean13Reader=new It}getBarcodeFormat(){return de.UPC_A}decode(t,s){return this.maybeReturnResult(this.ean13Reader.decode(t))}decodeRow(t,s,r){return this.maybeReturnResult(this.ean13Reader.decodeRow(t,s,r))}decodeMiddle(t,s,r){return this.ean13Reader.decodeMiddle(t,s,r)}maybeReturnResult(t){let s=t.getText();if(s.charAt(0)==="0"){let r=new L(s.substring(1),null,null,t.getResultPoints(),de.UPC_A);return t.getResultMetadata()!=null&&r.putAllMetadata(t.getResultMetadata()),r}else throw new G}reset(){this.ean13Reader.reset()}}class $t extends Oe{constructor(){super(),this.decodeMiddleCounters=new Int32Array(4)}decodeMiddle(t,s,r){const a=this.decodeMiddleCounters.map(m=>m);a[0]=0,a[1]=0,a[2]=0,a[3]=0;const i=t.getSize();let o=s[1],d=0;for(let m=0;m<6&&o<i;m++){const y=$t.decodeDigit(t,a,o,$t.L_AND_G_PATTERNS);r+=String.fromCharCode(48+y%10);for(let I of a)o+=I;y>=10&&(d|=1<<5-m)}let h=$t.determineNumSysAndCheckDigit(r,d);return{rowOffset:o,resultString:h}}decodeEnd(t,s){return $t.findGuardPatternWithoutCounters(t,s,!0,$t.MIDDLE_END_PATTERN)}checkChecksum(t){return Oe.checkChecksum($t.convertUPCEtoUPCA(t))}static determineNumSysAndCheckDigit(t,s){for(let r=0;r<=1;r++)for(let a=0;a<10;a++)if(s===this.NUMSYS_AND_CHECK_DIGIT_PATTERNS[r][a]){let i=String.fromCharCode(48+r),o=String.fromCharCode(48+a);return i+t+o}throw G.getNotFoundInstance()}getBarcodeFormat(){return de.UPC_E}static convertUPCEtoUPCA(t){const s=t.slice(1,7).split("").map(i=>i.charCodeAt(0)),r=new se;r.append(t.charAt(0));let a=s[5];switch(a){case 0:case 1:case 2:r.appendChars(s,0,2),r.append(a),r.append("0000"),r.appendChars(s,2,3);break;case 3:r.appendChars(s,0,3),r.append("00000"),r.appendChars(s,3,2);break;case 4:r.appendChars(s,0,4),r.append("00000"),r.append(s[4]);break;default:r.appendChars(s,0,5),r.append("0000"),r.append(a);break}return t.length>=8&&r.append(t.charAt(7)),r.toString()}}$t.MIDDLE_END_PATTERN=Int32Array.from([1,1,1,1,1,1]),$t.NUMSYS_AND_CHECK_DIGIT_PATTERNS=[Int32Array.from([56,52,50,49,44,38,35,42,41,37]),Int32Array.from([7,11,13,14,19,25,28,21,22,26])];class Tt extends ke{constructor(t){super();let s=t==null?null:t.get(N.POSSIBLE_FORMATS),r=[];u(s)?(r.push(new It),r.push(new ws),r.push(new ct),r.push(new $t)):(s.indexOf(de.EAN_13)>-1&&r.push(new It),s.indexOf(de.UPC_A)>-1&&r.push(new ws),s.indexOf(de.EAN_8)>-1&&r.push(new ct),s.indexOf(de.UPC_E)>-1&&r.push(new $t)),this.readers=r}decodeRow(t,s,r){for(let a of this.readers)try{const i=a.decodeRow(t,s,r),o=i.getBarcodeFormat()===de.EAN_13&&i.getText().charAt(0)==="0",d=r==null?null:r.get(N.POSSIBLE_FORMATS),h=d==null||d.includes(de.UPC_A);if(o&&h){const m=i.getRawBytes(),y=new L(i.getText().substring(1),m,m?m.length:null,i.getResultPoints(),de.UPC_A);return y.putAllMetadata(i.getResultMetadata()),y}return i}catch{}throw new G}reset(){for(let t of this.readers)t.reset()}}class mt extends ke{constructor(){super(),this.decodeFinderCounters=new Int32Array(4),this.dataCharacterCounters=new Int32Array(8),this.oddRoundingErrors=new Array(4),this.evenRoundingErrors=new Array(4),this.oddCounts=new Array(this.dataCharacterCounters.length/2),this.evenCounts=new Array(this.dataCharacterCounters.length/2)}getDecodeFinderCounters(){return this.decodeFinderCounters}getDataCharacterCounters(){return this.dataCharacterCounters}getOddRoundingErrors(){return this.oddRoundingErrors}getEvenRoundingErrors(){return this.evenRoundingErrors}getOddCounts(){return this.oddCounts}getEvenCounts(){return this.evenCounts}parseFinderValue(t,s){for(let r=0;r<s.length;r++)if(ke.patternMatchVariance(t,s[r],mt.MAX_INDIVIDUAL_VARIANCE)<mt.MAX_AVG_VARIANCE)return r;throw new G}static count(t){return We.sum(new Int32Array(t))}static increment(t,s){let r=0,a=s[0];for(let i=1;i<t.length;i++)s[i]>a&&(a=s[i],r=i);t[r]++}static decrement(t,s){let r=0,a=s[0];for(let i=1;i<t.length;i++)s[i]<a&&(a=s[i],r=i);t[r]--}static isFinderPattern(t){let s=t[0]+t[1],r=s+t[2]+t[3],a=s/r;if(a>=mt.MIN_FINDER_PATTERN_RATIO&&a<=mt.MAX_FINDER_PATTERN_RATIO){let i=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER;for(let d of t)d>o&&(o=d),d<i&&(i=d);return o<10*i}return!1}}mt.MAX_AVG_VARIANCE=.2,mt.MAX_INDIVIDUAL_VARIANCE=.45,mt.MIN_FINDER_PATTERN_RATIO=9.5/12,mt.MAX_FINDER_PATTERN_RATIO=12.5/14;class hs{constructor(t,s){this.value=t,this.checksumPortion=s}getValue(){return this.value}getChecksumPortion(){return this.checksumPortion}toString(){return this.value+"("+this.checksumPortion+")"}equals(t){if(!(t instanceof hs))return!1;const s=t;return this.value===s.value&&this.checksumPortion===s.checksumPortion}hashCode(){return this.value^this.checksumPortion}}class dr{constructor(t,s,r,a,i){this.value=t,this.startEnd=s,this.value=t,this.startEnd=s,this.resultPoints=new Array,this.resultPoints.push(new qe(r,i)),this.resultPoints.push(new qe(a,i))}getValue(){return this.value}getStartEnd(){return this.startEnd}getResultPoints(){return this.resultPoints}equals(t){if(!(t instanceof dr))return!1;const s=t;return this.value===s.value}hashCode(){return this.value}}class Es{constructor(){}static getRSSvalue(t,s,r){let a=0;for(let h of t)a+=h;let i=0,o=0,d=t.length;for(let h=0;h<d-1;h++){let m;for(m=1,o|=1<<h;m<t[h];m++,o&=~(1<<h)){let y=Es.combins(a-m-1,d-h-2);if(r&&o===0&&a-m-(d-h-1)>=d-h-1&&(y-=Es.combins(a-m-(d-h),d-h-2)),d-h-1>1){let I=0;for(let z=a-m-(d-h-2);z>s;z--)I+=Es.combins(a-m-z-1,d-h-3);y-=I*(d-1-h)}else a-m>s&&y--;i+=y}a-=m}return i}static combins(t,s){let r,a;t-s>s?(a=s,r=t-s):(a=t-s,r=s);let i=1,o=1;for(let d=t;d>r;d--)i*=d,o<=a&&(i/=o,o++);for(;o<=a;)i/=o,o++;return i}}class kr{static buildBitArray(t){let s=t.length*2-1;t[t.length-1].getRightChar()==null&&(s-=1);let r=12*s,a=new U(r),i=0,d=t[0].getRightChar().getValue();for(let h=11;h>=0;--h)d&1<<h&&a.set(i),i++;for(let h=1;h<t.length;++h){let m=t[h],y=m.getLeftChar().getValue();for(let I=11;I>=0;--I)y&1<<I&&a.set(i),i++;if(m.getRightChar()!=null){let I=m.getRightChar().getValue();for(let z=11;z>=0;--z)I&1<<z&&a.set(i),i++}}return a}}class Hs{constructor(t,s){s?this.decodedInformation=null:(this.finished=t,this.decodedInformation=s)}getDecodedInformation(){return this.decodedInformation}isFinished(){return this.finished}}class br{constructor(t){this.newPosition=t}getNewPosition(){return this.newPosition}}class ls extends br{constructor(t,s){super(t),this.value=s}getValue(){return this.value}isFNC1(){return this.value===ls.FNC1}}ls.FNC1="$";class qs extends br{constructor(t,s,r){super(t),r?(this.remaining=!0,this.remainingValue=this.remainingValue):(this.remaining=!1,this.remainingValue=0),this.newString=s}getNewString(){return this.newString}isRemaining(){return this.remaining}getRemainingValue(){return this.remainingValue}}class xs extends br{constructor(t,s,r){if(super(t),s<0||s>10||r<0||r>10)throw new _;this.firstDigit=s,this.secondDigit=r}getFirstDigit(){return this.firstDigit}getSecondDigit(){return this.secondDigit}getValue(){return this.firstDigit*10+this.secondDigit}isFirstDigitFNC1(){return this.firstDigit===xs.FNC1}isSecondDigitFNC1(){return this.secondDigit===xs.FNC1}isAnyFNC1(){return this.firstDigit===xs.FNC1||this.secondDigit===xs.FNC1}}xs.FNC1=10;class et{constructor(){}static parseFieldsInGeneralPurpose(t){if(!t)return null;if(t.length<2)throw new G;let s=t.substring(0,2);for(let i of et.TWO_DIGIT_DATA_LENGTH)if(i[0]===s)return i[1]===et.VARIABLE_LENGTH?et.processVariableAI(2,i[2],t):et.processFixedAI(2,i[1],t);if(t.length<3)throw new G;let r=t.substring(0,3);for(let i of et.THREE_DIGIT_DATA_LENGTH)if(i[0]===r)return i[1]===et.VARIABLE_LENGTH?et.processVariableAI(3,i[2],t):et.processFixedAI(3,i[1],t);for(let i of et.THREE_DIGIT_PLUS_DIGIT_DATA_LENGTH)if(i[0]===r)return i[1]===et.VARIABLE_LENGTH?et.processVariableAI(4,i[2],t):et.processFixedAI(4,i[1],t);if(t.length<4)throw new G;let a=t.substring(0,4);for(let i of et.FOUR_DIGIT_DATA_LENGTH)if(i[0]===a)return i[1]===et.VARIABLE_LENGTH?et.processVariableAI(4,i[2],t):et.processFixedAI(4,i[1],t);throw new G}static processFixedAI(t,s,r){if(r.length<t)throw new G;let a=r.substring(0,t);if(r.length<t+s)throw new G;let i=r.substring(t,t+s),o=r.substring(t+s),d="("+a+")"+i,h=et.parseFieldsInGeneralPurpose(o);return h==null?d:d+h}static processVariableAI(t,s,r){let a=r.substring(0,t),i;r.length<t+s?i=r.length:i=t+s;let o=r.substring(t,i),d=r.substring(i),h="("+a+")"+o,m=et.parseFieldsInGeneralPurpose(d);return m==null?h:h+m}}et.VARIABLE_LENGTH=[],et.TWO_DIGIT_DATA_LENGTH=[["00",18],["01",14],["02",14],["10",et.VARIABLE_LENGTH,20],["11",6],["12",6],["13",6],["15",6],["17",6],["20",2],["21",et.VARIABLE_LENGTH,20],["22",et.VARIABLE_LENGTH,29],["30",et.VARIABLE_LENGTH,8],["37",et.VARIABLE_LENGTH,8],["90",et.VARIABLE_LENGTH,30],["91",et.VARIABLE_LENGTH,30],["92",et.VARIABLE_LENGTH,30],["93",et.VARIABLE_LENGTH,30],["94",et.VARIABLE_LENGTH,30],["95",et.VARIABLE_LENGTH,30],["96",et.VARIABLE_LENGTH,30],["97",et.VARIABLE_LENGTH,3],["98",et.VARIABLE_LENGTH,30],["99",et.VARIABLE_LENGTH,30]],et.THREE_DIGIT_DATA_LENGTH=[["240",et.VARIABLE_LENGTH,30],["241",et.VARIABLE_LENGTH,30],["242",et.VARIABLE_LENGTH,6],["250",et.VARIABLE_LENGTH,30],["251",et.VARIABLE_LENGTH,30],["253",et.VARIABLE_LENGTH,17],["254",et.VARIABLE_LENGTH,20],["400",et.VARIABLE_LENGTH,30],["401",et.VARIABLE_LENGTH,30],["402",17],["403",et.VARIABLE_LENGTH,30],["410",13],["411",13],["412",13],["413",13],["414",13],["420",et.VARIABLE_LENGTH,20],["421",et.VARIABLE_LENGTH,15],["422",3],["423",et.VARIABLE_LENGTH,15],["424",3],["425",3],["426",3]],et.THREE_DIGIT_PLUS_DIGIT_DATA_LENGTH=[["310",6],["311",6],["312",6],["313",6],["314",6],["315",6],["316",6],["320",6],["321",6],["322",6],["323",6],["324",6],["325",6],["326",6],["327",6],["328",6],["329",6],["330",6],["331",6],["332",6],["333",6],["334",6],["335",6],["336",6],["340",6],["341",6],["342",6],["343",6],["344",6],["345",6],["346",6],["347",6],["348",6],["349",6],["350",6],["351",6],["352",6],["353",6],["354",6],["355",6],["356",6],["357",6],["360",6],["361",6],["362",6],["363",6],["364",6],["365",6],["366",6],["367",6],["368",6],["369",6],["390",et.VARIABLE_LENGTH,15],["391",et.VARIABLE_LENGTH,18],["392",et.VARIABLE_LENGTH,15],["393",et.VARIABLE_LENGTH,18],["703",et.VARIABLE_LENGTH,30]],et.FOUR_DIGIT_DATA_LENGTH=[["7001",13],["7002",et.VARIABLE_LENGTH,30],["7003",10],["8001",14],["8002",et.VARIABLE_LENGTH,20],["8003",et.VARIABLE_LENGTH,30],["8004",et.VARIABLE_LENGTH,30],["8005",6],["8006",18],["8007",et.VARIABLE_LENGTH,30],["8008",et.VARIABLE_LENGTH,12],["8018",18],["8020",et.VARIABLE_LENGTH,25],["8100",6],["8101",10],["8102",2],["8110",et.VARIABLE_LENGTH,70],["8200",et.VARIABLE_LENGTH,70]];class Zs{constructor(t){this.buffer=new se,this.information=t}decodeAllCodes(t,s){let r=s,a=null;do{let i=this.decodeGeneralPurposeField(r,a),o=et.parseFieldsInGeneralPurpose(i.getNewString());if(o!=null&&t.append(o),i.isRemaining()?a=""+i.getRemainingValue():a=null,r===i.getNewPosition())break;r=i.getNewPosition()}while(!0);return t.toString()}isStillNumeric(t){if(t+7>this.information.getSize())return t+4<=this.information.getSize();for(let s=t;s<t+3;++s)if(this.information.get(s))return!0;return this.information.get(t+3)}decodeNumeric(t){if(t+7>this.information.getSize()){let i=this.extractNumericValueFromBitArray(t,4);return i===0?new xs(this.information.getSize(),xs.FNC1,xs.FNC1):new xs(this.information.getSize(),i-1,xs.FNC1)}let s=this.extractNumericValueFromBitArray(t,7),r=(s-8)/11,a=(s-8)%11;return new xs(t+7,r,a)}extractNumericValueFromBitArray(t,s){return Zs.extractNumericValueFromBitArray(this.information,t,s)}static extractNumericValueFromBitArray(t,s,r){let a=0;for(let i=0;i<r;++i)t.get(s+i)&&(a|=1<<r-i-1);return a}decodeGeneralPurposeField(t,s){this.buffer.setLengthToZero(),s!=null&&this.buffer.append(s),this.current.setPosition(t);let r=this.parseBlocks();return r!=null&&r.isRemaining()?new qs(this.current.getPosition(),this.buffer.toString(),r.getRemainingValue()):new qs(this.current.getPosition(),this.buffer.toString())}parseBlocks(){let t,s;do{let r=this.current.getPosition();if(this.current.isAlpha()?(s=this.parseAlphaBlock(),t=s.isFinished()):this.current.isIsoIec646()?(s=this.parseIsoIec646Block(),t=s.isFinished()):(s=this.parseNumericBlock(),t=s.isFinished()),!(r!==this.current.getPosition())&&!t)break}while(!t);return s.getDecodedInformation()}parseNumericBlock(){for(;this.isStillNumeric(this.current.getPosition());){let t=this.decodeNumeric(this.current.getPosition());if(this.current.setPosition(t.getNewPosition()),t.isFirstDigitFNC1()){let s;return t.isSecondDigitFNC1()?s=new qs(this.current.getPosition(),this.buffer.toString()):s=new qs(this.current.getPosition(),this.buffer.toString(),t.getSecondDigit()),new Hs(!0,s)}if(this.buffer.append(t.getFirstDigit()),t.isSecondDigitFNC1()){let s=new qs(this.current.getPosition(),this.buffer.toString());return new Hs(!0,s)}this.buffer.append(t.getSecondDigit())}return this.isNumericToAlphaNumericLatch(this.current.getPosition())&&(this.current.setAlpha(),this.current.incrementPosition(4)),new Hs(!1)}parseIsoIec646Block(){for(;this.isStillIsoIec646(this.current.getPosition());){let t=this.decodeIsoIec646(this.current.getPosition());if(this.current.setPosition(t.getNewPosition()),t.isFNC1()){let s=new qs(this.current.getPosition(),this.buffer.toString());return new Hs(!0,s)}this.buffer.append(t.getValue())}return this.isAlphaOr646ToNumericLatch(this.current.getPosition())?(this.current.incrementPosition(3),this.current.setNumeric()):this.isAlphaTo646ToAlphaLatch(this.current.getPosition())&&(this.current.getPosition()+5<this.information.getSize()?this.current.incrementPosition(5):this.current.setPosition(this.information.getSize()),this.current.setAlpha()),new Hs(!1)}parseAlphaBlock(){for(;this.isStillAlpha(this.current.getPosition());){let t=this.decodeAlphanumeric(this.current.getPosition());if(this.current.setPosition(t.getNewPosition()),t.isFNC1()){let s=new qs(this.current.getPosition(),this.buffer.toString());return new Hs(!0,s)}this.buffer.append(t.getValue())}return this.isAlphaOr646ToNumericLatch(this.current.getPosition())?(this.current.incrementPosition(3),this.current.setNumeric()):this.isAlphaTo646ToAlphaLatch(this.current.getPosition())&&(this.current.getPosition()+5<this.information.getSize()?this.current.incrementPosition(5):this.current.setPosition(this.information.getSize()),this.current.setIsoIec646()),new Hs(!1)}isStillIsoIec646(t){if(t+5>this.information.getSize())return!1;let s=this.extractNumericValueFromBitArray(t,5);if(s>=5&&s<16)return!0;if(t+7>this.information.getSize())return!1;let r=this.extractNumericValueFromBitArray(t,7);if(r>=64&&r<116)return!0;if(t+8>this.information.getSize())return!1;let a=this.extractNumericValueFromBitArray(t,8);return a>=232&&a<253}decodeIsoIec646(t){let s=this.extractNumericValueFromBitArray(t,5);if(s===15)return new ls(t+5,ls.FNC1);if(s>=5&&s<15)return new ls(t+5,"0"+(s-5));let r=this.extractNumericValueFromBitArray(t,7);if(r>=64&&r<90)return new ls(t+7,""+(r+1));if(r>=90&&r<116)return new ls(t+7,""+(r+7));let a=this.extractNumericValueFromBitArray(t,8),i;switch(a){case 232:i="!";break;case 233:i='"';break;case 234:i="%";break;case 235:i="&";break;case 236:i="'";break;case 237:i="(";break;case 238:i=")";break;case 239:i="*";break;case 240:i="+";break;case 241:i=",";break;case 242:i="-";break;case 243:i=".";break;case 244:i="/";break;case 245:i=":";break;case 246:i=";";break;case 247:i="<";break;case 248:i="=";break;case 249:i=">";break;case 250:i="?";break;case 251:i="_";break;case 252:i=" ";break;default:throw new _}return new ls(t+8,i)}isStillAlpha(t){if(t+5>this.information.getSize())return!1;let s=this.extractNumericValueFromBitArray(t,5);if(s>=5&&s<16)return!0;if(t+6>this.information.getSize())return!1;let r=this.extractNumericValueFromBitArray(t,6);return r>=16&&r<63}decodeAlphanumeric(t){let s=this.extractNumericValueFromBitArray(t,5);if(s===15)return new ls(t+5,ls.FNC1);if(s>=5&&s<15)return new ls(t+5,"0"+(s-5));let r=this.extractNumericValueFromBitArray(t,6);if(r>=32&&r<58)return new ls(t+6,""+(r+33));let a;switch(r){case 58:a="*";break;case 59:a=",";break;case 60:a="-";break;case 61:a=".";break;case 62:a="/";break;default:throw new rt("Decoding invalid alphanumeric value: "+r)}return new ls(t+6,a)}isAlphaTo646ToAlphaLatch(t){if(t+1>this.information.getSize())return!1;for(let s=0;s<5&&s+t<this.information.getSize();++s)if(s===2){if(!this.information.get(t+2))return!1}else if(this.information.get(t+s))return!1;return!0}isAlphaOr646ToNumericLatch(t){if(t+3>this.information.getSize())return!1;for(let s=t;s<t+3;++s)if(this.information.get(s))return!1;return!0}isNumericToAlphaNumericLatch(t){if(t+1>this.information.getSize())return!1;for(let s=0;s<4&&s+t<this.information.getSize();++s)if(this.information.get(t+s))return!1;return!0}}class Mr{constructor(t){this.information=t,this.generalDecoder=new Zs(t)}getInformation(){return this.information}getGeneralDecoder(){return this.generalDecoder}}class cs extends Mr{constructor(t){super(t)}encodeCompressedGtin(t,s){t.append("(01)");let r=t.length();t.append("9"),this.encodeCompressedGtinWithoutAI(t,s,r)}encodeCompressedGtinWithoutAI(t,s,r){for(let a=0;a<4;++a){let i=this.getGeneralDecoder().extractNumericValueFromBitArray(s+10*a,10);i/100===0&&t.append("0"),i/10===0&&t.append("0"),t.append(i)}cs.appendCheckDigit(t,r)}static appendCheckDigit(t,s){let r=0;for(let a=0;a<13;a++){let i=t.charAt(a+s).charCodeAt(0)-48;r+=a&1?i:3*i}r=10-r%10,r===10&&(r=0),t.append(r)}}cs.GTIN_SIZE=40;class Gs extends cs{constructor(t){super(t)}parseInformation(){let t=new se;t.append("(01)");let s=t.length(),r=this.getGeneralDecoder().extractNumericValueFromBitArray(Gs.HEADER_SIZE,4);return t.append(r),this.encodeCompressedGtinWithoutAI(t,Gs.HEADER_SIZE+4,s),this.getGeneralDecoder().decodeAllCodes(t,Gs.HEADER_SIZE+44)}}Gs.HEADER_SIZE=4;class ur extends Mr{constructor(t){super(t)}parseInformation(){let t=new se;return this.getGeneralDecoder().decodeAllCodes(t,ur.HEADER_SIZE)}}ur.HEADER_SIZE=5;class wr extends cs{constructor(t){super(t)}encodeCompressedWeight(t,s,r){let a=this.getGeneralDecoder().extractNumericValueFromBitArray(s,r);this.addWeightCode(t,a);let i=this.checkWeight(a),o=1e5;for(let d=0;d<5;++d)i/o===0&&t.append("0"),o/=10;t.append(i)}}class Ss extends wr{constructor(t){super(t)}parseInformation(){if(this.getInformation().getSize()!=Ss.HEADER_SIZE+wr.GTIN_SIZE+Ss.WEIGHT_SIZE)throw new G;let t=new se;return this.encodeCompressedGtin(t,Ss.HEADER_SIZE),this.encodeCompressedWeight(t,Ss.HEADER_SIZE+wr.GTIN_SIZE,Ss.WEIGHT_SIZE),t.toString()}}Ss.HEADER_SIZE=5,Ss.WEIGHT_SIZE=15;class ea extends Ss{constructor(t){super(t)}addWeightCode(t,s){t.append("(3103)")}checkWeight(t){return t}}class ta extends Ss{constructor(t){super(t)}addWeightCode(t,s){s<1e4?t.append("(3202)"):t.append("(3203)")}checkWeight(t){return t<1e4?t:t-1e4}}class fs extends cs{constructor(t){super(t)}parseInformation(){if(this.getInformation().getSize()<fs.HEADER_SIZE+cs.GTIN_SIZE)throw new G;let t=new se;this.encodeCompressedGtin(t,fs.HEADER_SIZE);let s=this.getGeneralDecoder().extractNumericValueFromBitArray(fs.HEADER_SIZE+cs.GTIN_SIZE,fs.LAST_DIGIT_SIZE);t.append("(392"),t.append(s),t.append(")");let r=this.getGeneralDecoder().decodeGeneralPurposeField(fs.HEADER_SIZE+cs.GTIN_SIZE+fs.LAST_DIGIT_SIZE,null);return t.append(r.getNewString()),t.toString()}}fs.HEADER_SIZE=8,fs.LAST_DIGIT_SIZE=2;class es extends cs{constructor(t){super(t)}parseInformation(){if(this.getInformation().getSize()<es.HEADER_SIZE+cs.GTIN_SIZE)throw new G;let t=new se;this.encodeCompressedGtin(t,es.HEADER_SIZE);let s=this.getGeneralDecoder().extractNumericValueFromBitArray(es.HEADER_SIZE+cs.GTIN_SIZE,es.LAST_DIGIT_SIZE);t.append("(393"),t.append(s),t.append(")");let r=this.getGeneralDecoder().extractNumericValueFromBitArray(es.HEADER_SIZE+cs.GTIN_SIZE+es.LAST_DIGIT_SIZE,es.FIRST_THREE_DIGITS_SIZE);r/100==0&&t.append("0"),r/10==0&&t.append("0"),t.append(r);let a=this.getGeneralDecoder().decodeGeneralPurposeField(es.HEADER_SIZE+cs.GTIN_SIZE+es.LAST_DIGIT_SIZE+es.FIRST_THREE_DIGITS_SIZE,null);return t.append(a.getNewString()),t.toString()}}es.HEADER_SIZE=8,es.LAST_DIGIT_SIZE=2,es.FIRST_THREE_DIGITS_SIZE=10;class Lt extends wr{constructor(t,s,r){super(t),this.dateCode=r,this.firstAIdigits=s}parseInformation(){if(this.getInformation().getSize()!=Lt.HEADER_SIZE+Lt.GTIN_SIZE+Lt.WEIGHT_SIZE+Lt.DATE_SIZE)throw new G;let t=new se;return this.encodeCompressedGtin(t,Lt.HEADER_SIZE),this.encodeCompressedWeight(t,Lt.HEADER_SIZE+Lt.GTIN_SIZE,Lt.WEIGHT_SIZE),this.encodeCompressedDate(t,Lt.HEADER_SIZE+Lt.GTIN_SIZE+Lt.WEIGHT_SIZE),t.toString()}encodeCompressedDate(t,s){let r=this.getGeneralDecoder().extractNumericValueFromBitArray(s,Lt.DATE_SIZE);if(r==38400)return;t.append("("),t.append(this.dateCode),t.append(")");let a=r%32;r/=32;let i=r%12+1;r/=12;let o=r;o/10==0&&t.append("0"),t.append(o),i/10==0&&t.append("0"),t.append(i),a/10==0&&t.append("0"),t.append(a)}addWeightCode(t,s){t.append("("),t.append(this.firstAIdigits),t.append(s/1e5),t.append(")")}checkWeight(t){return t%1e5}}Lt.HEADER_SIZE=8,Lt.WEIGHT_SIZE=20,Lt.DATE_SIZE=16;function sa(A){try{if(A.get(1))return new Gs(A);if(!A.get(2))return new ur(A);switch(Zs.extractNumericValueFromBitArray(A,1,4)){case 4:return new ea(A);case 5:return new ta(A)}switch(Zs.extractNumericValueFromBitArray(A,1,5)){case 12:return new fs(A);case 13:return new es(A)}switch(Zs.extractNumericValueFromBitArray(A,1,7)){case 56:return new Lt(A,"310","11");case 57:return new Lt(A,"320","11");case 58:return new Lt(A,"310","13");case 59:return new Lt(A,"320","13");case 60:return new Lt(A,"310","15");case 61:return new Lt(A,"320","15");case 62:return new Lt(A,"310","17");case 63:return new Lt(A,"320","17")}}catch(t){throw console.log(t),new rt("unknown decoder: "+A)}}class Ps{constructor(t,s,r,a){this.leftchar=t,this.rightchar=s,this.finderpattern=r,this.maybeLast=a}mayBeLast(){return this.maybeLast}getLeftChar(){return this.leftchar}getRightChar(){return this.rightchar}getFinderPattern(){return this.finderpattern}mustBeLast(){return this.rightchar==null}toString(){return"[ "+this.leftchar+", "+this.rightchar+" : "+(this.finderpattern==null?"null":this.finderpattern.getValue())+" ]"}static equals(t,s){return t instanceof Ps?Ps.equalsOrNull(t.leftchar,s.leftchar)&&Ps.equalsOrNull(t.rightchar,s.rightchar)&&Ps.equalsOrNull(t.finderpattern,s.finderpattern):!1}static equalsOrNull(t,s){return t===null?s===null:Ps.equals(t,s)}hashCode(){return this.leftchar.getValue()^this.rightchar.getValue()^this.finderpattern.getValue()}}class ds{constructor(t,s,r){this.pairs=t,this.rowNumber=s,this.wasReversed=r}getPairs(){return this.pairs}getRowNumber(){return this.rowNumber}isReversed(){return this.wasReversed}isEquivalent(t){return this.checkEqualitity(this,t)}toString(){return"{ "+this.pairs+" }"}equals(t,s){return t instanceof ds?this.checkEqualitity(t,s)&&t.wasReversed===s.wasReversed:!1}checkEqualitity(t,s){if(!t||!s)return;let r;return t.forEach((a,i)=>{s.forEach(o=>{a.getLeftChar().getValue()===o.getLeftChar().getValue()&&a.getRightChar().getValue()===o.getRightChar().getValue()&&a.getFinderPatter().getValue()===o.getFinderPatter().getValue()&&(r=!0)})}),r}}class Be extends mt{constructor(t){super(...arguments),this.pairs=new Array(Be.MAX_PAIRS),this.rows=new Array,this.startEnd=[2],this.verbose=t===!0}decodeRow(t,s,r){this.pairs.length=0,this.startFromEven=!1;try{return Be.constructResult(this.decodeRow2pairs(t,s))}catch(a){this.verbose&&console.log(a)}return this.pairs.length=0,this.startFromEven=!0,Be.constructResult(this.decodeRow2pairs(t,s))}reset(){this.pairs.length=0,this.rows.length=0}decodeRow2pairs(t,s){let r=!1;for(;!r;)try{this.pairs.push(this.retrieveNextPair(s,this.pairs,t))}catch(i){if(i instanceof G){if(!this.pairs.length)throw new G;r=!0}}if(this.checkChecksum())return this.pairs;let a;if(this.rows.length?a=!0:a=!1,this.storeRow(t,!1),a){let i=this.checkRowsBoolean(!1);if(i!=null||(i=this.checkRowsBoolean(!0),i!=null))return i}throw new G}checkRowsBoolean(t){if(this.rows.length>25)return this.rows.length=0,null;this.pairs.length=0,t&&(this.rows=this.rows.reverse());let s=null;try{s=this.checkRows(new Array,0)}catch(r){this.verbose&&console.log(r)}return t&&(this.rows=this.rows.reverse()),s}checkRows(t,s){for(let r=s;r<this.rows.length;r++){let a=this.rows[r];this.pairs.length=0;for(let o of t)this.pairs.push(o.getPairs());if(this.pairs.push(a.getPairs()),!Be.isValidSequence(this.pairs))continue;if(this.checkChecksum())return this.pairs;let i=new Array(t);i.push(a);try{return this.checkRows(i,r+1)}catch(o){this.verbose&&console.log(o)}}throw new G}static isValidSequence(t){for(let s of Be.FINDER_PATTERN_SEQUENCES){if(t.length>s.length)continue;let r=!0;for(let a=0;a<t.length;a++)if(t[a].getFinderPattern().getValue()!=s[a]){r=!1;break}if(r)return!0}return!1}storeRow(t,s){let r=0,a=!1,i=!1;for(;r<this.rows.length;){let o=this.rows[r];if(o.getRowNumber()>t){i=o.isEquivalent(this.pairs);break}a=o.isEquivalent(this.pairs),r++}i||a||Be.isPartialRow(this.pairs,this.rows)||(this.rows.push(r,new ds(this.pairs,t,s)),this.removePartialRows(this.pairs,this.rows))}removePartialRows(t,s){for(let r of s)if(r.getPairs().length!==t.length){for(let a of r.getPairs())for(let i of t)if(Ps.equals(a,i))break}}static isPartialRow(t,s){for(let r of s){let a=!0;for(let i of t){let o=!1;for(let d of r.getPairs())if(i.equals(d)){o=!0;break}if(!o){a=!1;break}}if(a)return!0}return!1}getRows(){return this.rows}static constructResult(t){let s=kr.buildBitArray(t),a=sa(s).parseInformation(),i=t[0].getFinderPattern().getResultPoints(),o=t[t.length-1].getFinderPattern().getResultPoints(),d=[i[0],i[1],o[0],o[1]];return new L(a,null,null,d,de.RSS_EXPANDED,null)}checkChecksum(){let t=this.pairs.get(0),s=t.getLeftChar(),r=t.getRightChar();if(r==null)return!1;let a=r.getChecksumPortion(),i=2;for(let d=1;d<this.pairs.size();++d){let h=this.pairs.get(d);a+=h.getLeftChar().getChecksumPortion(),i++;let m=h.getRightChar();m!=null&&(a+=m.getChecksumPortion(),i++)}return a%=211,211*(i-4)+a==s.getValue()}static getNextSecondBar(t,s){let r;return t.get(s)?(r=t.getNextUnset(s),r=t.getNextSet(r)):(r=t.getNextSet(s),r=t.getNextUnset(r)),r}retrieveNextPair(t,s,r){let a=s.length%2==0;this.startFromEven&&(a=!a);let i,o=!0,d=-1;do this.findNextPair(t,s,d),i=this.parseFoundFinderPattern(t,r,a),i==null?d=Be.getNextSecondBar(t,this.startEnd[0]):o=!1;while(o);let h=this.decodeDataCharacter(t,i,a,!0);if(!this.isEmptyPair(s)&&s[s.length-1].mustBeLast())throw new G;let m;try{m=this.decodeDataCharacter(t,i,a,!1)}catch(y){m=null,this.verbose&&console.log(y)}return new Ps(h,m,i,!0)}isEmptyPair(t){return t.length===0}findNextPair(t,s,r){let a=this.getDecodeFinderCounters();a[0]=0,a[1]=0,a[2]=0,a[3]=0;let i=t.getSize(),o;r>=0?o=r:this.isEmptyPair(s)?o=0:o=s[s.length-1].getFinderPattern().getStartEnd()[1];let d=s.length%2!=0;this.startFromEven&&(d=!d);let h=!1;for(;o<i&&(h=!t.get(o),!!h);)o++;let m=0,y=o;for(let I=o;I<i;I++)if(t.get(I)!=h)a[m]++;else{if(m==3){if(d&&Be.reverseCounters(a),Be.isFinderPattern(a)){this.startEnd[0]=y,this.startEnd[1]=I;return}d&&Be.reverseCounters(a),y+=a[0]+a[1],a[0]=a[2],a[1]=a[3],a[2]=0,a[3]=0,m--}else m++;a[m]=1,h=!h}throw new G}static reverseCounters(t){let s=t.length;for(let r=0;r<s/2;++r){let a=t[r];t[r]=t[s-r-1],t[s-r-1]=a}}parseFoundFinderPattern(t,s,r){let a,i,o;if(r){let m=this.startEnd[0]-1;for(;m>=0&&!t.get(m);)m--;m++,a=this.startEnd[0]-m,i=m,o=this.startEnd[1]}else i=this.startEnd[0],o=t.getNextUnset(this.startEnd[1]+1),a=o-this.startEnd[1];let d=this.getDecodeFinderCounters();R.arraycopy(d,0,d,1,d.length-1),d[0]=a;let h;try{h=this.parseFinderValue(d,Be.FINDER_PATTERNS)}catch{return null}return new dr(h,[i,o],i,o,s)}decodeDataCharacter(t,s,r,a){let i=this.getDataCharacterCounters();for(let Ot=0;Ot<i.length;Ot++)i[Ot]=0;if(a)Be.recordPatternInReverse(t,s.getStartEnd()[0],i);else{Be.recordPattern(t,s.getStartEnd()[1],i);for(let Ot=0,ns=i.length-1;Ot<ns;Ot++,ns--){let ys=i[Ot];i[Ot]=i[ns],i[ns]=ys}}let o=17,d=We.sum(new Int32Array(i))/o,h=(s.getStartEnd()[1]-s.getStartEnd()[0])/15;if(Math.abs(d-h)/h>.3)throw new G;let m=this.getOddCounts(),y=this.getEvenCounts(),I=this.getOddRoundingErrors(),z=this.getEvenRoundingErrors();for(let Ot=0;Ot<i.length;Ot++){let ns=1*i[Ot]/d,ys=ns+.5;if(ys<1){if(ns<.3)throw new G;ys=1}else if(ys>8){if(ns>8.7)throw new G;ys=8}let vr=Ot/2;Ot&1?(y[vr]=ys,z[vr]=ns-ys):(m[vr]=ys,I[vr]=ns-ys)}this.adjustOddEvenCounts(o);let Y=4*s.getValue()+(r?0:2)+(a?0:1)-1,ie=0,ce=0;for(let Ot=m.length-1;Ot>=0;Ot--){if(Be.isNotA1left(s,r,a)){let ns=Be.WEIGHTS[Y][2*Ot];ce+=m[Ot]*ns}ie+=m[Ot]}let Ne=0;for(let Ot=y.length-1;Ot>=0;Ot--)if(Be.isNotA1left(s,r,a)){let ns=Be.WEIGHTS[Y][2*Ot+1];Ne+=y[Ot]*ns}let ze=ce+Ne;if(ie&1||ie>13||ie<4)throw new G;let Ge=(13-ie)/2,Ye=Be.SYMBOL_WIDEST[Ge],Ue=9-Ye,Ct=Es.getRSSvalue(m,Ye,!0),ft=Es.getRSSvalue(y,Ue,!1),ps=Be.EVEN_TOTAL_SUBSET[Ge],zs=Be.GSUM[Ge],bs=Ct*ps+ft+zs;return new hs(bs,ze)}static isNotA1left(t,s,r){return!(t.getValue()==0&&s&&r)}adjustOddEvenCounts(t){let s=We.sum(new Int32Array(this.getOddCounts())),r=We.sum(new Int32Array(this.getEvenCounts())),a=!1,i=!1;s>13?i=!0:s<4&&(a=!0);let o=!1,d=!1;r>13?d=!0:r<4&&(o=!0);let h=s+r-t,m=(s&1)==1,y=(r&1)==0;if(h==1)if(m){if(y)throw new G;i=!0}else{if(!y)throw new G;d=!0}else if(h==-1)if(m){if(y)throw new G;a=!0}else{if(!y)throw new G;o=!0}else if(h==0){if(m){if(!y)throw new G;s<r?(a=!0,d=!0):(i=!0,o=!0)}else if(y)throw new G}else throw new G;if(a){if(i)throw new G;Be.increment(this.getOddCounts(),this.getOddRoundingErrors())}if(i&&Be.decrement(this.getOddCounts(),this.getOddRoundingErrors()),o){if(d)throw new G;Be.increment(this.getEvenCounts(),this.getOddRoundingErrors())}d&&Be.decrement(this.getEvenCounts(),this.getEvenRoundingErrors())}}Be.SYMBOL_WIDEST=[7,5,4,3,1],Be.EVEN_TOTAL_SUBSET=[4,20,52,104,204],Be.GSUM=[0,348,1388,2948,3988],Be.FINDER_PATTERNS=[Int32Array.from([1,8,4,1]),Int32Array.from([3,6,4,1]),Int32Array.from([3,4,6,1]),Int32Array.from([3,2,8,1]),Int32Array.from([2,6,5,1]),Int32Array.from([2,2,9,1])],Be.WEIGHTS=[[1,3,9,27,81,32,96,77],[20,60,180,118,143,7,21,63],[189,145,13,39,117,140,209,205],[193,157,49,147,19,57,171,91],[62,186,136,197,169,85,44,132],[185,133,188,142,4,12,36,108],[113,128,173,97,80,29,87,50],[150,28,84,41,123,158,52,156],[46,138,203,187,139,206,196,166],[76,17,51,153,37,111,122,155],[43,129,176,106,107,110,119,146],[16,48,144,10,30,90,59,177],[109,116,137,200,178,112,125,164],[70,210,208,202,184,130,179,115],[134,191,151,31,93,68,204,190],[148,22,66,198,172,94,71,2],[6,18,54,162,64,192,154,40],[120,149,25,75,14,42,126,167],[79,26,78,23,69,207,199,175],[103,98,83,38,114,131,182,124],[161,61,183,127,170,88,53,159],[55,165,73,8,24,72,5,15],[45,135,194,160,58,174,100,89]],Be.FINDER_PAT_A=0,Be.FINDER_PAT_B=1,Be.FINDER_PAT_C=2,Be.FINDER_PAT_D=3,Be.FINDER_PAT_E=4,Be.FINDER_PAT_F=5,Be.FINDER_PATTERN_SEQUENCES=[[Be.FINDER_PAT_A,Be.FINDER_PAT_A],[Be.FINDER_PAT_A,Be.FINDER_PAT_B,Be.FINDER_PAT_B],[Be.FINDER_PAT_A,Be.FINDER_PAT_C,Be.FINDER_PAT_B,Be.FINDER_PAT_D],[Be.FINDER_PAT_A,Be.FINDER_PAT_E,Be.FINDER_PAT_B,Be.FINDER_PAT_D,Be.FINDER_PAT_C],[Be.FINDER_PAT_A,Be.FINDER_PAT_E,Be.FINDER_PAT_B,Be.FINDER_PAT_D,Be.FINDER_PAT_D,Be.FINDER_PAT_F],[Be.FINDER_PAT_A,Be.FINDER_PAT_E,Be.FINDER_PAT_B,Be.FINDER_PAT_D,Be.FINDER_PAT_E,Be.FINDER_PAT_F,Be.FINDER_PAT_F],[Be.FINDER_PAT_A,Be.FINDER_PAT_A,Be.FINDER_PAT_B,Be.FINDER_PAT_B,Be.FINDER_PAT_C,Be.FINDER_PAT_C,Be.FINDER_PAT_D,Be.FINDER_PAT_D],[Be.FINDER_PAT_A,Be.FINDER_PAT_A,Be.FINDER_PAT_B,Be.FINDER_PAT_B,Be.FINDER_PAT_C,Be.FINDER_PAT_C,Be.FINDER_PAT_D,Be.FINDER_PAT_E,Be.FINDER_PAT_E],[Be.FINDER_PAT_A,Be.FINDER_PAT_A,Be.FINDER_PAT_B,Be.FINDER_PAT_B,Be.FINDER_PAT_C,Be.FINDER_PAT_C,Be.FINDER_PAT_D,Be.FINDER_PAT_E,Be.FINDER_PAT_F,Be.FINDER_PAT_F],[Be.FINDER_PAT_A,Be.FINDER_PAT_A,Be.FINDER_PAT_B,Be.FINDER_PAT_B,Be.FINDER_PAT_C,Be.FINDER_PAT_D,Be.FINDER_PAT_D,Be.FINDER_PAT_E,Be.FINDER_PAT_E,Be.FINDER_PAT_F,Be.FINDER_PAT_F]],Be.MAX_PAIRS=11;class Ie extends hs{constructor(t,s,r){super(t,s),this.count=0,this.finderPattern=r}getFinderPattern(){return this.finderPattern}getCount(){return this.count}incrementCount(){this.count++}}class Pe extends mt{constructor(){super(...arguments),this.possibleLeftPairs=[],this.possibleRightPairs=[]}decodeRow(t,s,r){const a=this.decodePair(s,!1,t,r);Pe.addOrTally(this.possibleLeftPairs,a),s.reverse();let i=this.decodePair(s,!0,t,r);Pe.addOrTally(this.possibleRightPairs,i),s.reverse();for(let o of this.possibleLeftPairs)if(o.getCount()>1){for(let d of this.possibleRightPairs)if(d.getCount()>1&&Pe.checkChecksum(o,d))return Pe.constructResult(o,d)}throw new G}static addOrTally(t,s){if(s==null)return;let r=!1;for(let a of t)if(a.getValue()===s.getValue()){a.incrementCount(),r=!0;break}r||t.push(s)}reset(){this.possibleLeftPairs.length=0,this.possibleRightPairs.length=0}static constructResult(t,s){let r=4537077*t.getValue()+s.getValue(),a=new String(r).toString(),i=new se;for(let m=13-a.length;m>0;m--)i.append("0");i.append(a);let o=0;for(let m=0;m<13;m++){let y=i.charAt(m).charCodeAt(0)-48;o+=m&1?y:3*y}o=10-o%10,o===10&&(o=0),i.append(o.toString());let d=t.getFinderPattern().getResultPoints(),h=s.getFinderPattern().getResultPoints();return new L(i.toString(),null,0,[d[0],d[1],h[0],h[1]],de.RSS_14,new Date().getTime())}static checkChecksum(t,s){let r=(t.getChecksumPortion()+16*s.getChecksumPortion())%79,a=9*t.getFinderPattern().getValue()+s.getFinderPattern().getValue();return a>72&&a--,a>8&&a--,r===a}decodePair(t,s,r,a){try{let i=this.findFinderPattern(t,s),o=this.parseFoundFinderPattern(t,r,s,i),d=a==null?null:a.get(N.NEED_RESULT_POINT_CALLBACK);if(d!=null){let y=(i[0]+i[1])/2;s&&(y=t.getSize()-1-y),d.foundPossibleResultPoint(new qe(y,r))}let h=this.decodeDataCharacter(t,o,!0),m=this.decodeDataCharacter(t,o,!1);return new Ie(1597*h.getValue()+m.getValue(),h.getChecksumPortion()+4*m.getChecksumPortion(),o)}catch{return null}}decodeDataCharacter(t,s,r){let a=this.getDataCharacterCounters();for(let Ne=0;Ne<a.length;Ne++)a[Ne]=0;if(r)ke.recordPatternInReverse(t,s.getStartEnd()[0],a);else{ke.recordPattern(t,s.getStartEnd()[1]+1,a);for(let Ne=0,ze=a.length-1;Ne<ze;Ne++,ze--){let Ge=a[Ne];a[Ne]=a[ze],a[ze]=Ge}}let i=r?16:15,o=We.sum(new Int32Array(a))/i,d=this.getOddCounts(),h=this.getEvenCounts(),m=this.getOddRoundingErrors(),y=this.getEvenRoundingErrors();for(let Ne=0;Ne<a.length;Ne++){let ze=a[Ne]/o,Ge=Math.floor(ze+.5);Ge<1?Ge=1:Ge>8&&(Ge=8);let Ye=Math.floor(Ne/2);Ne&1?(h[Ye]=Ge,y[Ye]=ze-Ge):(d[Ye]=Ge,m[Ye]=ze-Ge)}this.adjustOddEvenCounts(r,i);let I=0,z=0;for(let Ne=d.length-1;Ne>=0;Ne--)z*=9,z+=d[Ne],I+=d[Ne];let Y=0,ie=0;for(let Ne=h.length-1;Ne>=0;Ne--)Y*=9,Y+=h[Ne],ie+=h[Ne];let ce=z+3*Y;if(r){if(I&1||I>12||I<4)throw new G;let Ne=(12-I)/2,ze=Pe.OUTSIDE_ODD_WIDEST[Ne],Ge=9-ze,Ye=Es.getRSSvalue(d,ze,!1),Ue=Es.getRSSvalue(h,Ge,!0),Ct=Pe.OUTSIDE_EVEN_TOTAL_SUBSET[Ne],ft=Pe.OUTSIDE_GSUM[Ne];return new hs(Ye*Ct+Ue+ft,ce)}else{if(ie&1||ie>10||ie<4)throw new G;let Ne=(10-ie)/2,ze=Pe.INSIDE_ODD_WIDEST[Ne],Ge=9-ze,Ye=Es.getRSSvalue(d,ze,!0),Ue=Es.getRSSvalue(h,Ge,!1),Ct=Pe.INSIDE_ODD_TOTAL_SUBSET[Ne],ft=Pe.INSIDE_GSUM[Ne];return new hs(Ue*Ct+Ye+ft,ce)}}findFinderPattern(t,s){let r=this.getDecodeFinderCounters();r[0]=0,r[1]=0,r[2]=0,r[3]=0;let a=t.getSize(),i=!1,o=0;for(;o<a&&(i=!t.get(o),s!==i);)o++;let d=0,h=o;for(let m=o;m<a;m++)if(t.get(m)!==i)r[d]++;else{if(d===3){if(mt.isFinderPattern(r))return[h,m];h+=r[0]+r[1],r[0]=r[2],r[1]=r[3],r[2]=0,r[3]=0,d--}else d++;r[d]=1,i=!i}throw new G}parseFoundFinderPattern(t,s,r,a){let i=t.get(a[0]),o=a[0]-1;for(;o>=0&&i!==t.get(o);)o--;o++;const d=a[0]-o,h=this.getDecodeFinderCounters(),m=new Int32Array(h.length);R.arraycopy(h,0,m,1,h.length-1),m[0]=d;const y=this.parseFinderValue(m,Pe.FINDER_PATTERNS);let I=o,z=a[1];return r&&(I=t.getSize()-1-I,z=t.getSize()-1-z),new dr(y,[o,a[1]],I,z,s)}adjustOddEvenCounts(t,s){let r=We.sum(new Int32Array(this.getOddCounts())),a=We.sum(new Int32Array(this.getEvenCounts())),i=!1,o=!1,d=!1,h=!1;t?(r>12?o=!0:r<4&&(i=!0),a>12?h=!0:a<4&&(d=!0)):(r>11?o=!0:r<5&&(i=!0),a>10?h=!0:a<4&&(d=!0));let m=r+a-s,y=(r&1)===(t?1:0),I=(a&1)===1;if(m===1)if(y){if(I)throw new G;o=!0}else{if(!I)throw new G;h=!0}else if(m===-1)if(y){if(I)throw new G;i=!0}else{if(!I)throw new G;d=!0}else if(m===0){if(y){if(!I)throw new G;r<a?(i=!0,h=!0):(o=!0,d=!0)}else if(I)throw new G}else throw new G;if(i){if(o)throw new G;mt.increment(this.getOddCounts(),this.getOddRoundingErrors())}if(o&&mt.decrement(this.getOddCounts(),this.getOddRoundingErrors()),d){if(h)throw new G;mt.increment(this.getEvenCounts(),this.getOddRoundingErrors())}h&&mt.decrement(this.getEvenCounts(),this.getEvenRoundingErrors())}}Pe.OUTSIDE_EVEN_TOTAL_SUBSET=[1,10,34,70,126],Pe.INSIDE_ODD_TOTAL_SUBSET=[4,20,48,81],Pe.OUTSIDE_GSUM=[0,161,961,2015,2715],Pe.INSIDE_GSUM=[0,336,1036,1516],Pe.OUTSIDE_ODD_WIDEST=[8,6,4,3,1],Pe.INSIDE_ODD_WIDEST=[2,4,6,8],Pe.FINDER_PATTERNS=[Int32Array.from([3,8,2,1]),Int32Array.from([3,5,5,1]),Int32Array.from([3,3,7,1]),Int32Array.from([3,1,9,1]),Int32Array.from([2,7,4,1]),Int32Array.from([2,5,6,1]),Int32Array.from([2,3,8,1]),Int32Array.from([1,5,7,1]),Int32Array.from([1,3,9,1])];class Ke extends ke{constructor(t,s){super(),this.readers=[],this.verbose=s===!0;const r=t?t.get(N.POSSIBLE_FORMATS):null,a=t&&t.get(N.ASSUME_CODE_39_CHECK_DIGIT)!==void 0;r?((r.includes(de.EAN_13)||r.includes(de.UPC_A)||r.includes(de.EAN_8)||r.includes(de.UPC_E))&&this.readers.push(new Tt(t)),r.includes(de.CODE_39)&&this.readers.push(new ue(a)),r.includes(de.CODE_128)&&this.readers.push(new $),r.includes(de.ITF)&&this.readers.push(new xe),r.includes(de.RSS_14)&&this.readers.push(new Pe),r.includes(de.RSS_EXPANDED)&&this.readers.push(new Be(this.verbose))):(this.readers.push(new Tt(t)),this.readers.push(new ue),this.readers.push(new Tt(t)),this.readers.push(new $),this.readers.push(new xe),this.readers.push(new Pe),this.readers.push(new Be(this.verbose)))}decodeRow(t,s,r){for(let a=0;a<this.readers.length;a++)try{return this.readers[a].decodeRow(t,s,r)}catch{}throw new G}reset(){this.readers.forEach(t=>t.reset())}}class nt extends Z{constructor(t=500,s){super(new Ke(s),t,s)}}class He{constructor(t,s,r){this.ecCodewords=t,this.ecBlocks=[s],r&&this.ecBlocks.push(r)}getECCodewords(){return this.ecCodewords}getECBlocks(){return this.ecBlocks}}class $e{constructor(t,s){this.count=t,this.dataCodewords=s}getCount(){return this.count}getDataCodewords(){return this.dataCodewords}}class Xe{constructor(t,s,r,a,i,o){this.versionNumber=t,this.symbolSizeRows=s,this.symbolSizeColumns=r,this.dataRegionSizeRows=a,this.dataRegionSizeColumns=i,this.ecBlocks=o;let d=0;const h=o.getECCodewords(),m=o.getECBlocks();for(let y of m)d+=y.getCount()*(y.getDataCodewords()+h);this.totalCodewords=d}getVersionNumber(){return this.versionNumber}getSymbolSizeRows(){return this.symbolSizeRows}getSymbolSizeColumns(){return this.symbolSizeColumns}getDataRegionSizeRows(){return this.dataRegionSizeRows}getDataRegionSizeColumns(){return this.dataRegionSizeColumns}getTotalCodewords(){return this.totalCodewords}getECBlocks(){return this.ecBlocks}static getVersionForDimensions(t,s){if(t&1||s&1)throw new _;for(let r of Xe.VERSIONS)if(r.symbolSizeRows===t&&r.symbolSizeColumns===s)return r;throw new _}toString(){return""+this.versionNumber}static buildVersions(){return[new Xe(1,10,10,8,8,new He(5,new $e(1,3))),new Xe(2,12,12,10,10,new He(7,new $e(1,5))),new Xe(3,14,14,12,12,new He(10,new $e(1,8))),new Xe(4,16,16,14,14,new He(12,new $e(1,12))),new Xe(5,18,18,16,16,new He(14,new $e(1,18))),new Xe(6,20,20,18,18,new He(18,new $e(1,22))),new Xe(7,22,22,20,20,new He(20,new $e(1,30))),new Xe(8,24,24,22,22,new He(24,new $e(1,36))),new Xe(9,26,26,24,24,new He(28,new $e(1,44))),new Xe(10,32,32,14,14,new He(36,new $e(1,62))),new Xe(11,36,36,16,16,new He(42,new $e(1,86))),new Xe(12,40,40,18,18,new He(48,new $e(1,114))),new Xe(13,44,44,20,20,new He(56,new $e(1,144))),new Xe(14,48,48,22,22,new He(68,new $e(1,174))),new Xe(15,52,52,24,24,new He(42,new $e(2,102))),new Xe(16,64,64,14,14,new He(56,new $e(2,140))),new Xe(17,72,72,16,16,new He(36,new $e(4,92))),new Xe(18,80,80,18,18,new He(48,new $e(4,114))),new Xe(19,88,88,20,20,new He(56,new $e(4,144))),new Xe(20,96,96,22,22,new He(68,new $e(4,174))),new Xe(21,104,104,24,24,new He(56,new $e(6,136))),new Xe(22,120,120,18,18,new He(68,new $e(6,175))),new Xe(23,132,132,20,20,new He(62,new $e(8,163))),new Xe(24,144,144,22,22,new He(62,new $e(8,156),new $e(2,155))),new Xe(25,8,18,6,16,new He(7,new $e(1,5))),new Xe(26,8,32,6,14,new He(11,new $e(1,10))),new Xe(27,12,26,10,24,new He(14,new $e(1,16))),new Xe(28,12,36,10,16,new He(18,new $e(1,22))),new Xe(29,16,36,14,16,new He(24,new $e(1,32))),new Xe(30,16,48,14,22,new He(28,new $e(1,49)))]}}Xe.VERSIONS=Xe.buildVersions();class ot{constructor(t){const s=t.getHeight();if(s<8||s>144||s&1)throw new _;this.version=ot.readVersion(t),this.mappingBitMatrix=this.extractDataRegion(t),this.readMappingMatrix=new W(this.mappingBitMatrix.getWidth(),this.mappingBitMatrix.getHeight())}getVersion(){return this.version}static readVersion(t){const s=t.getHeight(),r=t.getWidth();return Xe.getVersionForDimensions(s,r)}readCodewords(){const t=new Int8Array(this.version.getTotalCodewords());let s=0,r=4,a=0;const i=this.mappingBitMatrix.getHeight(),o=this.mappingBitMatrix.getWidth();let d=!1,h=!1,m=!1,y=!1;do if(r===i&&a===0&&!d)t[s++]=this.readCorner1(i,o)&255,r-=2,a+=2,d=!0;else if(r===i-2&&a===0&&o&3&&!h)t[s++]=this.readCorner2(i,o)&255,r-=2,a+=2,h=!0;else if(r===i+4&&a===2&&!(o&7)&&!m)t[s++]=this.readCorner3(i,o)&255,r-=2,a+=2,m=!0;else if(r===i-2&&a===0&&(o&7)===4&&!y)t[s++]=this.readCorner4(i,o)&255,r-=2,a+=2,y=!0;else{do r<i&&a>=0&&!this.readMappingMatrix.get(a,r)&&(t[s++]=this.readUtah(r,a,i,o)&255),r-=2,a+=2;while(r>=0&&a<o);r+=1,a+=3;do r>=0&&a<o&&!this.readMappingMatrix.get(a,r)&&(t[s++]=this.readUtah(r,a,i,o)&255),r+=2,a-=2;while(r<i&&a>=0);r+=3,a+=1}while(r<i||a<o);if(s!==this.version.getTotalCodewords())throw new _;return t}readModule(t,s,r,a){return t<0&&(t+=r,s+=4-(r+4&7)),s<0&&(s+=a,t+=4-(a+4&7)),this.readMappingMatrix.set(s,t),this.mappingBitMatrix.get(s,t)}readUtah(t,s,r,a){let i=0;return this.readModule(t-2,s-2,r,a)&&(i|=1),i<<=1,this.readModule(t-2,s-1,r,a)&&(i|=1),i<<=1,this.readModule(t-1,s-2,r,a)&&(i|=1),i<<=1,this.readModule(t-1,s-1,r,a)&&(i|=1),i<<=1,this.readModule(t-1,s,r,a)&&(i|=1),i<<=1,this.readModule(t,s-2,r,a)&&(i|=1),i<<=1,this.readModule(t,s-1,r,a)&&(i|=1),i<<=1,this.readModule(t,s,r,a)&&(i|=1),i}readCorner1(t,s){let r=0;return this.readModule(t-1,0,t,s)&&(r|=1),r<<=1,this.readModule(t-1,1,t,s)&&(r|=1),r<<=1,this.readModule(t-1,2,t,s)&&(r|=1),r<<=1,this.readModule(0,s-2,t,s)&&(r|=1),r<<=1,this.readModule(0,s-1,t,s)&&(r|=1),r<<=1,this.readModule(1,s-1,t,s)&&(r|=1),r<<=1,this.readModule(2,s-1,t,s)&&(r|=1),r<<=1,this.readModule(3,s-1,t,s)&&(r|=1),r}readCorner2(t,s){let r=0;return this.readModule(t-3,0,t,s)&&(r|=1),r<<=1,this.readModule(t-2,0,t,s)&&(r|=1),r<<=1,this.readModule(t-1,0,t,s)&&(r|=1),r<<=1,this.readModule(0,s-4,t,s)&&(r|=1),r<<=1,this.readModule(0,s-3,t,s)&&(r|=1),r<<=1,this.readModule(0,s-2,t,s)&&(r|=1),r<<=1,this.readModule(0,s-1,t,s)&&(r|=1),r<<=1,this.readModule(1,s-1,t,s)&&(r|=1),r}readCorner3(t,s){let r=0;return this.readModule(t-1,0,t,s)&&(r|=1),r<<=1,this.readModule(t-1,s-1,t,s)&&(r|=1),r<<=1,this.readModule(0,s-3,t,s)&&(r|=1),r<<=1,this.readModule(0,s-2,t,s)&&(r|=1),r<<=1,this.readModule(0,s-1,t,s)&&(r|=1),r<<=1,this.readModule(1,s-3,t,s)&&(r|=1),r<<=1,this.readModule(1,s-2,t,s)&&(r|=1),r<<=1,this.readModule(1,s-1,t,s)&&(r|=1),r}readCorner4(t,s){let r=0;return this.readModule(t-3,0,t,s)&&(r|=1),r<<=1,this.readModule(t-2,0,t,s)&&(r|=1),r<<=1,this.readModule(t-1,0,t,s)&&(r|=1),r<<=1,this.readModule(0,s-2,t,s)&&(r|=1),r<<=1,this.readModule(0,s-1,t,s)&&(r|=1),r<<=1,this.readModule(1,s-1,t,s)&&(r|=1),r<<=1,this.readModule(2,s-1,t,s)&&(r|=1),r<<=1,this.readModule(3,s-1,t,s)&&(r|=1),r}extractDataRegion(t){const s=this.version.getSymbolSizeRows(),r=this.version.getSymbolSizeColumns();if(t.getHeight()!==s)throw new p("Dimension of bitMatrix must match the version size");const a=this.version.getDataRegionSizeRows(),i=this.version.getDataRegionSizeColumns(),o=s/a|0,d=r/i|0,h=o*a,m=d*i,y=new W(m,h);for(let I=0;I<o;++I){const z=I*a;for(let Y=0;Y<d;++Y){const ie=Y*i;for(let ce=0;ce<a;++ce){const Ne=I*(a+2)+1+ce,ze=z+ce;for(let Ge=0;Ge<i;++Ge){const Ye=Y*(i+2)+1+Ge;if(t.get(Ye,Ne)){const Ue=ie+Ge;y.set(Ue,ze)}}}}}return y}}class St{constructor(t,s){this.numDataCodewords=t,this.codewords=s}static getDataBlocks(t,s){const r=s.getECBlocks();let a=0;const i=r.getECBlocks();for(let ce of i)a+=ce.getCount();const o=new Array(a);let d=0;for(let ce of i)for(let Ne=0;Ne<ce.getCount();Ne++){const ze=ce.getDataCodewords(),Ge=r.getECCodewords()+ze;o[d++]=new St(ze,new Uint8Array(Ge))}const m=o[0].codewords.length-r.getECCodewords(),y=m-1;let I=0;for(let ce=0;ce<y;ce++)for(let Ne=0;Ne<d;Ne++)o[Ne].codewords[ce]=t[I++];const z=s.getVersionNumber()===24,Y=z?8:d;for(let ce=0;ce<Y;ce++)o[ce].codewords[m-1]=t[I++];const ie=o[0].codewords.length;for(let ce=m;ce<ie;ce++)for(let Ne=0;Ne<d;Ne++){const ze=z?(Ne+8)%d:Ne,Ge=z&&ze>7?ce-1:ce;o[ze].codewords[Ge]=t[I++]}if(I!==t.length)throw new p;return o}getNumDataCodewords(){return this.numDataCodewords}getCodewords(){return this.codewords}}class Gt{constructor(t){this.bytes=t,this.byteOffset=0,this.bitOffset=0}getBitOffset(){return this.bitOffset}getByteOffset(){return this.byteOffset}readBits(t){if(t<1||t>32||t>this.available())throw new p(""+t);let s=0,r=this.bitOffset,a=this.byteOffset;const i=this.bytes;if(r>0){const o=8-r,d=t<o?t:o,h=o-d,m=255>>8-d<<h;s=(i[a]&m)>>h,t-=d,r+=d,r===8&&(r=0,a++)}if(t>0){for(;t>=8;)s=s<<8|i[a]&255,a++,t-=8;if(t>0){const o=8-t,d=255>>o<<o;s=s<<t|(i[a]&d)>>o,r+=t}}return this.bitOffset=r,this.byteOffset=a,s}available(){return 8*(this.bytes.length-this.byteOffset)-this.bitOffset}}var jt;(function(A){A[A.PAD_ENCODE=0]="PAD_ENCODE",A[A.ASCII_ENCODE=1]="ASCII_ENCODE",A[A.C40_ENCODE=2]="C40_ENCODE",A[A.TEXT_ENCODE=3]="TEXT_ENCODE",A[A.ANSIX12_ENCODE=4]="ANSIX12_ENCODE",A[A.EDIFACT_ENCODE=5]="EDIFACT_ENCODE",A[A.BASE256_ENCODE=6]="BASE256_ENCODE"})(jt||(jt={}));class ts{static decode(t){const s=new Gt(t),r=new se,a=new se,i=new Array;let o=jt.ASCII_ENCODE;do if(o===jt.ASCII_ENCODE)o=this.decodeAsciiSegment(s,r,a);else{switch(o){case jt.C40_ENCODE:this.decodeC40Segment(s,r);break;case jt.TEXT_ENCODE:this.decodeTextSegment(s,r);break;case jt.ANSIX12_ENCODE:this.decodeAnsiX12Segment(s,r);break;case jt.EDIFACT_ENCODE:this.decodeEdifactSegment(s,r);break;case jt.BASE256_ENCODE:this.decodeBase256Segment(s,r,i);break;default:throw new _}o=jt.ASCII_ENCODE}while(o!==jt.PAD_ENCODE&&s.available()>0);return a.length()>0&&r.append(a.toString()),new ve(t,r.toString(),i.length===0?null:i,null)}static decodeAsciiSegment(t,s,r){let a=!1;do{let i=t.readBits(8);if(i===0)throw new _;if(i<=128)return a&&(i+=128),s.append(String.fromCharCode(i-1)),jt.ASCII_ENCODE;if(i===129)return jt.PAD_ENCODE;if(i<=229){const o=i-130;o<10&&s.append("0"),s.append(""+o)}else switch(i){case 230:return jt.C40_ENCODE;case 231:return jt.BASE256_ENCODE;case 232:s.append("");break;case 233:case 234:break;case 235:a=!0;break;case 236:s.append("[)>05"),r.insert(0,"");break;case 237:s.append("[)>06"),r.insert(0,"");break;case 238:return jt.ANSIX12_ENCODE;case 239:return jt.TEXT_ENCODE;case 240:return jt.EDIFACT_ENCODE;case 241:break;default:if(i!==254||t.available()!==0)throw new _;break}}while(t.available()>0);return jt.ASCII_ENCODE}static decodeC40Segment(t,s){let r=!1;const a=[];let i=0;do{if(t.available()===8)return;const o=t.readBits(8);if(o===254)return;this.parseTwoBytes(o,t.readBits(8),a);for(let d=0;d<3;d++){const h=a[d];switch(i){case 0:if(h<3)i=h+1;else if(h<this.C40_BASIC_SET_CHARS.length){const m=this.C40_BASIC_SET_CHARS[h];r?(s.append(String.fromCharCode(m.charCodeAt(0)+128)),r=!1):s.append(m)}else throw new _;break;case 1:r?(s.append(String.fromCharCode(h+128)),r=!1):s.append(String.fromCharCode(h)),i=0;break;case 2:if(h<this.C40_SHIFT2_SET_CHARS.length){const m=this.C40_SHIFT2_SET_CHARS[h];r?(s.append(String.fromCharCode(m.charCodeAt(0)+128)),r=!1):s.append(m)}else switch(h){case 27:s.append("");break;case 30:r=!0;break;default:throw new _}i=0;break;case 3:r?(s.append(String.fromCharCode(h+224)),r=!1):s.append(String.fromCharCode(h+96)),i=0;break;default:throw new _}}}while(t.available()>0)}static decodeTextSegment(t,s){let r=!1,a=[],i=0;do{if(t.available()===8)return;const o=t.readBits(8);if(o===254)return;this.parseTwoBytes(o,t.readBits(8),a);for(let d=0;d<3;d++){const h=a[d];switch(i){case 0:if(h<3)i=h+1;else if(h<this.TEXT_BASIC_SET_CHARS.length){const m=this.TEXT_BASIC_SET_CHARS[h];r?(s.append(String.fromCharCode(m.charCodeAt(0)+128)),r=!1):s.append(m)}else throw new _;break;case 1:r?(s.append(String.fromCharCode(h+128)),r=!1):s.append(String.fromCharCode(h)),i=0;break;case 2:if(h<this.TEXT_SHIFT2_SET_CHARS.length){const m=this.TEXT_SHIFT2_SET_CHARS[h];r?(s.append(String.fromCharCode(m.charCodeAt(0)+128)),r=!1):s.append(m)}else switch(h){case 27:s.append("");break;case 30:r=!0;break;default:throw new _}i=0;break;case 3:if(h<this.TEXT_SHIFT3_SET_CHARS.length){const m=this.TEXT_SHIFT3_SET_CHARS[h];r?(s.append(String.fromCharCode(m.charCodeAt(0)+128)),r=!1):s.append(m),i=0}else throw new _;break;default:throw new _}}}while(t.available()>0)}static decodeAnsiX12Segment(t,s){const r=[];do{if(t.available()===8)return;const a=t.readBits(8);if(a===254)return;this.parseTwoBytes(a,t.readBits(8),r);for(let i=0;i<3;i++){const o=r[i];switch(o){case 0:s.append("\r");break;case 1:s.append("*");break;case 2:s.append(">");break;case 3:s.append(" ");break;default:if(o<14)s.append(String.fromCharCode(o+44));else if(o<40)s.append(String.fromCharCode(o+51));else throw new _;break}}}while(t.available()>0)}static parseTwoBytes(t,s,r){let a=(t<<8)+s-1,i=Math.floor(a/1600);r[0]=i,a-=i*1600,i=Math.floor(a/40),r[1]=i,r[2]=a-i*40}static decodeEdifactSegment(t,s){do{if(t.available()<=16)return;for(let r=0;r<4;r++){let a=t.readBits(6);if(a===31){const i=8-t.getBitOffset();i!==8&&t.readBits(i);return}a&32||(a|=64),s.append(String.fromCharCode(a))}}while(t.available()>0)}static decodeBase256Segment(t,s,r){let a=1+t.getByteOffset();const i=this.unrandomize255State(t.readBits(8),a++);let o;if(i===0?o=t.available()/8|0:i<250?o=i:o=250*(i-249)+this.unrandomize255State(t.readBits(8),a++),o<0)throw new _;const d=new Uint8Array(o);for(let h=0;h<o;h++){if(t.available()<8)throw new _;d[h]=this.unrandomize255State(t.readBits(8),a++)}r.push(d);try{s.append(O.decode(d,X.ISO88591))}catch(h){throw new rt("Platform does not support required encoding: "+h.message)}}static unrandomize255State(t,s){const r=149*s%255+1,a=t-r;return a>=0?a:a+256}}ts.C40_BASIC_SET_CHARS=["*","*","*"," ","0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],ts.C40_SHIFT2_SET_CHARS=["!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/",":",";","<","=",">","?","@","[","\\","]","^","_"],ts.TEXT_BASIC_SET_CHARS=["*","*","*"," ","0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],ts.TEXT_SHIFT2_SET_CHARS=ts.C40_SHIFT2_SET_CHARS,ts.TEXT_SHIFT3_SET_CHARS=["`","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","{","|","}","~",""];class Qs{constructor(){this.rsDecoder=new st(Fe.DATA_MATRIX_FIELD_256)}decode(t){const s=new ot(t),r=s.getVersion(),a=s.readCodewords(),i=St.getDataBlocks(a,r);let o=0;for(let m of i)o+=m.getNumDataCodewords();const d=new Uint8Array(o),h=i.length;for(let m=0;m<h;m++){const y=i[m],I=y.getCodewords(),z=y.getNumDataCodewords();this.correctErrors(I,z);for(let Y=0;Y<z;Y++)d[Y*h+m]=I[Y]}return ts.decode(d)}correctErrors(t,s){const r=new Int32Array(t);try{this.rsDecoder.decode(r,t.length-s)}catch{throw new P}for(let a=0;a<s;a++)t[a]=r[a]}}class vt{constructor(t){this.image=t,this.rectangleDetector=new ae(this.image)}detect(){const t=this.rectangleDetector.detect();let s=this.detectSolid1(t);if(s=this.detectSolid2(s),s[3]=this.correctTopRight(s),!s[3])throw new G;s=this.shiftToModuleCenter(s);const r=s[0],a=s[1],i=s[2],o=s[3];let d=this.transitionsBetween(r,o)+1,h=this.transitionsBetween(i,o)+1;(d&1)===1&&(d+=1),(h&1)===1&&(h+=1),4*d<7*h&&4*h<7*d&&(d=h=Math.max(d,h));let m=vt.sampleGrid(this.image,r,a,i,o,d,h);return new De(m,[r,a,i,o])}static shiftPoint(t,s,r){let a=(s.getX()-t.getX())/(r+1),i=(s.getY()-t.getY())/(r+1);return new qe(t.getX()+a,t.getY()+i)}static moveAway(t,s,r){let a=t.getX(),i=t.getY();return a<s?a-=1:a+=1,i<r?i-=1:i+=1,new qe(a,i)}detectSolid1(t){let s=t[0],r=t[1],a=t[3],i=t[2],o=this.transitionsBetween(s,r),d=this.transitionsBetween(r,a),h=this.transitionsBetween(a,i),m=this.transitionsBetween(i,s),y=o,I=[i,s,r,a];return y>d&&(y=d,I[0]=s,I[1]=r,I[2]=a,I[3]=i),y>h&&(y=h,I[0]=r,I[1]=a,I[2]=i,I[3]=s),y>m&&(I[0]=a,I[1]=i,I[2]=s,I[3]=r),I}detectSolid2(t){let s=t[0],r=t[1],a=t[2],i=t[3],o=this.transitionsBetween(s,i),d=vt.shiftPoint(r,a,(o+1)*4),h=vt.shiftPoint(a,r,(o+1)*4),m=this.transitionsBetween(d,s),y=this.transitionsBetween(h,i);return m<y?(t[0]=s,t[1]=r,t[2]=a,t[3]=i):(t[0]=r,t[1]=a,t[2]=i,t[3]=s),t}correctTopRight(t){let s=t[0],r=t[1],a=t[2],i=t[3],o=this.transitionsBetween(s,i),d=this.transitionsBetween(r,i),h=vt.shiftPoint(s,r,(d+1)*4),m=vt.shiftPoint(a,r,(o+1)*4);o=this.transitionsBetween(h,i),d=this.transitionsBetween(m,i);let y=new qe(i.getX()+(a.getX()-r.getX())/(o+1),i.getY()+(a.getY()-r.getY())/(o+1)),I=new qe(i.getX()+(s.getX()-r.getX())/(d+1),i.getY()+(s.getY()-r.getY())/(d+1));if(!this.isValid(y))return this.isValid(I)?I:null;if(!this.isValid(I))return y;let z=this.transitionsBetween(h,y)+this.transitionsBetween(m,y),Y=this.transitionsBetween(h,I)+this.transitionsBetween(m,I);return z>Y?y:I}shiftToModuleCenter(t){let s=t[0],r=t[1],a=t[2],i=t[3],o=this.transitionsBetween(s,i)+1,d=this.transitionsBetween(a,i)+1,h=vt.shiftPoint(s,r,d*4),m=vt.shiftPoint(a,r,o*4);o=this.transitionsBetween(h,i)+1,d=this.transitionsBetween(m,i)+1,(o&1)===1&&(o+=1),(d&1)===1&&(d+=1);let y=(s.getX()+r.getX()+a.getX()+i.getX())/4,I=(s.getY()+r.getY()+a.getY()+i.getY())/4;s=vt.moveAway(s,y,I),r=vt.moveAway(r,y,I),a=vt.moveAway(a,y,I),i=vt.moveAway(i,y,I);let z,Y;return h=vt.shiftPoint(s,r,d*4),h=vt.shiftPoint(h,i,o*4),z=vt.shiftPoint(r,s,d*4),z=vt.shiftPoint(z,a,o*4),m=vt.shiftPoint(a,i,d*4),m=vt.shiftPoint(m,r,o*4),Y=vt.shiftPoint(i,a,d*4),Y=vt.shiftPoint(Y,s,o*4),[h,z,m,Y]}isValid(t){return t.getX()>=0&&t.getX()<this.image.getWidth()&&t.getY()>0&&t.getY()<this.image.getHeight()}static sampleGrid(t,s,r,a,i,o,d){return ee.getInstance().sampleGrid(t,o,d,.5,.5,o-.5,.5,o-.5,d-.5,.5,d-.5,s.getX(),s.getY(),i.getX(),i.getY(),a.getX(),a.getY(),r.getX(),r.getY())}transitionsBetween(t,s){let r=Math.trunc(t.getX()),a=Math.trunc(t.getY()),i=Math.trunc(s.getX()),o=Math.trunc(s.getY()),d=Math.abs(o-a)>Math.abs(i-r);if(d){let ce=r;r=a,a=ce,ce=i,i=o,o=ce}let h=Math.abs(i-r),m=Math.abs(o-a),y=-h/2,I=a<o?1:-1,z=r<i?1:-1,Y=0,ie=this.image.get(d?a:r,d?r:a);for(let ce=r,Ne=a;ce!==i;ce+=z){let ze=this.image.get(d?Ne:ce,d?ce:Ne);if(ze!==ie&&(Y++,ie=ze),y+=m,y>0){if(Ne===o)break;Ne+=I,y-=h}}return Y}}class ss{constructor(){this.decoder=new Qs}decode(t,s=null){let r,a;if(s!=null&&s.has(N.PURE_BARCODE)){const m=ss.extractPureBits(t.getBlackMatrix());r=this.decoder.decode(m),a=ss.NO_POINTS}else{const m=new vt(t.getBlackMatrix()).detect();r=this.decoder.decode(m.getBits()),a=m.getPoints()}const i=r.getRawBytes(),o=new L(r.getText(),i,8*i.length,a,de.DATA_MATRIX,R.currentTimeMillis()),d=r.getByteSegments();d!=null&&o.putMetadata(ge.BYTE_SEGMENTS,d);const h=r.getECLevel();return h!=null&&o.putMetadata(ge.ERROR_CORRECTION_LEVEL,h),o}reset(){}static extractPureBits(t){const s=t.getTopLeftOnBit(),r=t.getBottomRightOnBit();if(s==null||r==null)throw new G;const a=this.moduleSize(s,t);let i=s[1];const o=r[1];let d=s[0];const m=(r[0]-d+1)/a,y=(o-i+1)/a;if(m<=0||y<=0)throw new G;const I=a/2;i+=I,d+=I;const z=new W(m,y);for(let Y=0;Y<y;Y++){const ie=i+Y*a;for(let ce=0;ce<m;ce++)t.get(d+ce*a,ie)&&z.set(ce,Y)}return z}static moduleSize(t,s){const r=s.getWidth();let a=t[0];const i=t[1];for(;a<r&&s.get(a,i);)a++;if(a===r)throw new G;const o=a-t[0];if(o===0)throw new G;return o}}ss.NO_POINTS=[];class Ws extends Z{constructor(t=500){super(new ss,t)}}var As;(function(A){A[A.L=0]="L",A[A.M=1]="M",A[A.Q=2]="Q",A[A.H=3]="H"})(As||(As={}));class wt{constructor(t,s,r){this.value=t,this.stringValue=s,this.bits=r,wt.FOR_BITS.set(r,this),wt.FOR_VALUE.set(t,this)}getValue(){return this.value}getBits(){return this.bits}static fromString(t){switch(t){case"L":return wt.L;case"M":return wt.M;case"Q":return wt.Q;case"H":return wt.H;default:throw new E(t+"not available")}}toString(){return this.stringValue}equals(t){if(!(t instanceof wt))return!1;const s=t;return this.value===s.value}static forBits(t){if(t<0||t>=wt.FOR_BITS.size)throw new p;return wt.FOR_BITS.get(t)}}wt.FOR_BITS=new Map,wt.FOR_VALUE=new Map,wt.L=new wt(As.L,"L",1),wt.M=new wt(As.M,"M",0),wt.Q=new wt(As.Q,"Q",3),wt.H=new wt(As.H,"H",2);class Vt{constructor(t){this.errorCorrectionLevel=wt.forBits(t>>3&3),this.dataMask=t&7}static numBitsDiffering(t,s){return F.bitCount(t^s)}static decodeFormatInformation(t,s){const r=Vt.doDecodeFormatInformation(t,s);return r!==null?r:Vt.doDecodeFormatInformation(t^Vt.FORMAT_INFO_MASK_QR,s^Vt.FORMAT_INFO_MASK_QR)}static doDecodeFormatInformation(t,s){let r=Number.MAX_SAFE_INTEGER,a=0;for(const i of Vt.FORMAT_INFO_DECODE_LOOKUP){const o=i[0];if(o===t||o===s)return new Vt(i[1]);let d=Vt.numBitsDiffering(t,o);d<r&&(a=i[1],r=d),t!==s&&(d=Vt.numBitsDiffering(s,o),d<r&&(a=i[1],r=d))}return r<=3?new Vt(a):null}getErrorCorrectionLevel(){return this.errorCorrectionLevel}getDataMask(){return this.dataMask}hashCode(){return this.errorCorrectionLevel.getBits()<<3|this.dataMask}equals(t){if(!(t instanceof Vt))return!1;const s=t;return this.errorCorrectionLevel===s.errorCorrectionLevel&&this.dataMask===s.dataMask}}Vt.FORMAT_INFO_MASK_QR=21522,Vt.FORMAT_INFO_DECODE_LOOKUP=[Int32Array.from([21522,0]),Int32Array.from([20773,1]),Int32Array.from([24188,2]),Int32Array.from([23371,3]),Int32Array.from([17913,4]),Int32Array.from([16590,5]),Int32Array.from([20375,6]),Int32Array.from([19104,7]),Int32Array.from([30660,8]),Int32Array.from([29427,9]),Int32Array.from([32170,10]),Int32Array.from([30877,11]),Int32Array.from([26159,12]),Int32Array.from([25368,13]),Int32Array.from([27713,14]),Int32Array.from([26998,15]),Int32Array.from([5769,16]),Int32Array.from([5054,17]),Int32Array.from([7399,18]),Int32Array.from([6608,19]),Int32Array.from([1890,20]),Int32Array.from([597,21]),Int32Array.from([3340,22]),Int32Array.from([2107,23]),Int32Array.from([13663,24]),Int32Array.from([12392,25]),Int32Array.from([16177,26]),Int32Array.from([14854,27]),Int32Array.from([9396,28]),Int32Array.from([8579,29]),Int32Array.from([11994,30]),Int32Array.from([11245,31])];class Ce{constructor(t,...s){this.ecCodewordsPerBlock=t,this.ecBlocks=s}getECCodewordsPerBlock(){return this.ecCodewordsPerBlock}getNumBlocks(){let t=0;const s=this.ecBlocks;for(const r of s)t+=r.getCount();return t}getTotalECCodewords(){return this.ecCodewordsPerBlock*this.getNumBlocks()}getECBlocks(){return this.ecBlocks}}class q{constructor(t,s){this.count=t,this.dataCodewords=s}getCount(){return this.count}getDataCodewords(){return this.dataCodewords}}class it{constructor(t,s,...r){this.versionNumber=t,this.alignmentPatternCenters=s,this.ecBlocks=r;let a=0;const i=r[0].getECCodewordsPerBlock(),o=r[0].getECBlocks();for(const d of o)a+=d.getCount()*(d.getDataCodewords()+i);this.totalCodewords=a}getVersionNumber(){return this.versionNumber}getAlignmentPatternCenters(){return this.alignmentPatternCenters}getTotalCodewords(){return this.totalCodewords}getDimensionForVersion(){return 17+4*this.versionNumber}getECBlocksForLevel(t){return this.ecBlocks[t.getValue()]}static getProvisionalVersionForDimension(t){if(t%4!==1)throw new _;try{return this.getVersionForNumber((t-17)/4)}catch{throw new _}}static getVersionForNumber(t){if(t<1||t>40)throw new p;return it.VERSIONS[t-1]}static decodeVersionInformation(t){let s=Number.MAX_SAFE_INTEGER,r=0;for(let a=0;a<it.VERSION_DECODE_INFO.length;a++){const i=it.VERSION_DECODE_INFO[a];if(i===t)return it.getVersionForNumber(a+7);const o=Vt.numBitsDiffering(t,i);o<s&&(r=a+7,s=o)}return s<=3?it.getVersionForNumber(r):null}buildFunctionPattern(){const t=this.getDimensionForVersion(),s=new W(t);s.setRegion(0,0,9,9),s.setRegion(t-8,0,8,9),s.setRegion(0,t-8,9,8);const r=this.alignmentPatternCenters.length;for(let a=0;a<r;a++){const i=this.alignmentPatternCenters[a]-2;for(let o=0;o<r;o++)a===0&&(o===0||o===r-1)||a===r-1&&o===0||s.setRegion(this.alignmentPatternCenters[o]-2,i,5,5)}return s.setRegion(6,9,1,t-17),s.setRegion(9,6,t-17,1),this.versionNumber>6&&(s.setRegion(t-11,0,3,6),s.setRegion(0,t-11,6,3)),s}toString(){return""+this.versionNumber}}it.VERSION_DECODE_INFO=Int32Array.from([31892,34236,39577,42195,48118,51042,55367,58893,63784,68472,70749,76311,79154,84390,87683,92361,96236,102084,102881,110507,110734,117786,119615,126325,127568,133589,136944,141498,145311,150283,152622,158308,161089,167017]),it.VERSIONS=[new it(1,new Int32Array(0),new Ce(7,new q(1,19)),new Ce(10,new q(1,16)),new Ce(13,new q(1,13)),new Ce(17,new q(1,9))),new it(2,Int32Array.from([6,18]),new Ce(10,new q(1,34)),new Ce(16,new q(1,28)),new Ce(22,new q(1,22)),new Ce(28,new q(1,16))),new it(3,Int32Array.from([6,22]),new Ce(15,new q(1,55)),new Ce(26,new q(1,44)),new Ce(18,new q(2,17)),new Ce(22,new q(2,13))),new it(4,Int32Array.from([6,26]),new Ce(20,new q(1,80)),new Ce(18,new q(2,32)),new Ce(26,new q(2,24)),new Ce(16,new q(4,9))),new it(5,Int32Array.from([6,30]),new Ce(26,new q(1,108)),new Ce(24,new q(2,43)),new Ce(18,new q(2,15),new q(2,16)),new Ce(22,new q(2,11),new q(2,12))),new it(6,Int32Array.from([6,34]),new Ce(18,new q(2,68)),new Ce(16,new q(4,27)),new Ce(24,new q(4,19)),new Ce(28,new q(4,15))),new it(7,Int32Array.from([6,22,38]),new Ce(20,new q(2,78)),new Ce(18,new q(4,31)),new Ce(18,new q(2,14),new q(4,15)),new Ce(26,new q(4,13),new q(1,14))),new it(8,Int32Array.from([6,24,42]),new Ce(24,new q(2,97)),new Ce(22,new q(2,38),new q(2,39)),new Ce(22,new q(4,18),new q(2,19)),new Ce(26,new q(4,14),new q(2,15))),new it(9,Int32Array.from([6,26,46]),new Ce(30,new q(2,116)),new Ce(22,new q(3,36),new q(2,37)),new Ce(20,new q(4,16),new q(4,17)),new Ce(24,new q(4,12),new q(4,13))),new it(10,Int32Array.from([6,28,50]),new Ce(18,new q(2,68),new q(2,69)),new Ce(26,new q(4,43),new q(1,44)),new Ce(24,new q(6,19),new q(2,20)),new Ce(28,new q(6,15),new q(2,16))),new it(11,Int32Array.from([6,30,54]),new Ce(20,new q(4,81)),new Ce(30,new q(1,50),new q(4,51)),new Ce(28,new q(4,22),new q(4,23)),new Ce(24,new q(3,12),new q(8,13))),new it(12,Int32Array.from([6,32,58]),new Ce(24,new q(2,92),new q(2,93)),new Ce(22,new q(6,36),new q(2,37)),new Ce(26,new q(4,20),new q(6,21)),new Ce(28,new q(7,14),new q(4,15))),new it(13,Int32Array.from([6,34,62]),new Ce(26,new q(4,107)),new Ce(22,new q(8,37),new q(1,38)),new Ce(24,new q(8,20),new q(4,21)),new Ce(22,new q(12,11),new q(4,12))),new it(14,Int32Array.from([6,26,46,66]),new Ce(30,new q(3,115),new q(1,116)),new Ce(24,new q(4,40),new q(5,41)),new Ce(20,new q(11,16),new q(5,17)),new Ce(24,new q(11,12),new q(5,13))),new it(15,Int32Array.from([6,26,48,70]),new Ce(22,new q(5,87),new q(1,88)),new Ce(24,new q(5,41),new q(5,42)),new Ce(30,new q(5,24),new q(7,25)),new Ce(24,new q(11,12),new q(7,13))),new it(16,Int32Array.from([6,26,50,74]),new Ce(24,new q(5,98),new q(1,99)),new Ce(28,new q(7,45),new q(3,46)),new Ce(24,new q(15,19),new q(2,20)),new Ce(30,new q(3,15),new q(13,16))),new it(17,Int32Array.from([6,30,54,78]),new Ce(28,new q(1,107),new q(5,108)),new Ce(28,new q(10,46),new q(1,47)),new Ce(28,new q(1,22),new q(15,23)),new Ce(28,new q(2,14),new q(17,15))),new it(18,Int32Array.from([6,30,56,82]),new Ce(30,new q(5,120),new q(1,121)),new Ce(26,new q(9,43),new q(4,44)),new Ce(28,new q(17,22),new q(1,23)),new Ce(28,new q(2,14),new q(19,15))),new it(19,Int32Array.from([6,30,58,86]),new Ce(28,new q(3,113),new q(4,114)),new Ce(26,new q(3,44),new q(11,45)),new Ce(26,new q(17,21),new q(4,22)),new Ce(26,new q(9,13),new q(16,14))),new it(20,Int32Array.from([6,34,62,90]),new Ce(28,new q(3,107),new q(5,108)),new Ce(26,new q(3,41),new q(13,42)),new Ce(30,new q(15,24),new q(5,25)),new Ce(28,new q(15,15),new q(10,16))),new it(21,Int32Array.from([6,28,50,72,94]),new Ce(28,new q(4,116),new q(4,117)),new Ce(26,new q(17,42)),new Ce(28,new q(17,22),new q(6,23)),new Ce(30,new q(19,16),new q(6,17))),new it(22,Int32Array.from([6,26,50,74,98]),new Ce(28,new q(2,111),new q(7,112)),new Ce(28,new q(17,46)),new Ce(30,new q(7,24),new q(16,25)),new Ce(24,new q(34,13))),new it(23,Int32Array.from([6,30,54,78,102]),new Ce(30,new q(4,121),new q(5,122)),new Ce(28,new q(4,47),new q(14,48)),new Ce(30,new q(11,24),new q(14,25)),new Ce(30,new q(16,15),new q(14,16))),new it(24,Int32Array.from([6,28,54,80,106]),new Ce(30,new q(6,117),new q(4,118)),new Ce(28,new q(6,45),new q(14,46)),new Ce(30,new q(11,24),new q(16,25)),new Ce(30,new q(30,16),new q(2,17))),new it(25,Int32Array.from([6,32,58,84,110]),new Ce(26,new q(8,106),new q(4,107)),new Ce(28,new q(8,47),new q(13,48)),new Ce(30,new q(7,24),new q(22,25)),new Ce(30,new q(22,15),new q(13,16))),new it(26,Int32Array.from([6,30,58,86,114]),new Ce(28,new q(10,114),new q(2,115)),new Ce(28,new q(19,46),new q(4,47)),new Ce(28,new q(28,22),new q(6,23)),new Ce(30,new q(33,16),new q(4,17))),new it(27,Int32Array.from([6,34,62,90,118]),new Ce(30,new q(8,122),new q(4,123)),new Ce(28,new q(22,45),new q(3,46)),new Ce(30,new q(8,23),new q(26,24)),new Ce(30,new q(12,15),new q(28,16))),new it(28,Int32Array.from([6,26,50,74,98,122]),new Ce(30,new q(3,117),new q(10,118)),new Ce(28,new q(3,45),new q(23,46)),new Ce(30,new q(4,24),new q(31,25)),new Ce(30,new q(11,15),new q(31,16))),new it(29,Int32Array.from([6,30,54,78,102,126]),new Ce(30,new q(7,116),new q(7,117)),new Ce(28,new q(21,45),new q(7,46)),new Ce(30,new q(1,23),new q(37,24)),new Ce(30,new q(19,15),new q(26,16))),new it(30,Int32Array.from([6,26,52,78,104,130]),new Ce(30,new q(5,115),new q(10,116)),new Ce(28,new q(19,47),new q(10,48)),new Ce(30,new q(15,24),new q(25,25)),new Ce(30,new q(23,15),new q(25,16))),new it(31,Int32Array.from([6,30,56,82,108,134]),new Ce(30,new q(13,115),new q(3,116)),new Ce(28,new q(2,46),new q(29,47)),new Ce(30,new q(42,24),new q(1,25)),new Ce(30,new q(23,15),new q(28,16))),new it(32,Int32Array.from([6,34,60,86,112,138]),new Ce(30,new q(17,115)),new Ce(28,new q(10,46),new q(23,47)),new Ce(30,new q(10,24),new q(35,25)),new Ce(30,new q(19,15),new q(35,16))),new it(33,Int32Array.from([6,30,58,86,114,142]),new Ce(30,new q(17,115),new q(1,116)),new Ce(28,new q(14,46),new q(21,47)),new Ce(30,new q(29,24),new q(19,25)),new Ce(30,new q(11,15),new q(46,16))),new it(34,Int32Array.from([6,34,62,90,118,146]),new Ce(30,new q(13,115),new q(6,116)),new Ce(28,new q(14,46),new q(23,47)),new Ce(30,new q(44,24),new q(7,25)),new Ce(30,new q(59,16),new q(1,17))),new it(35,Int32Array.from([6,30,54,78,102,126,150]),new Ce(30,new q(12,121),new q(7,122)),new Ce(28,new q(12,47),new q(26,48)),new Ce(30,new q(39,24),new q(14,25)),new Ce(30,new q(22,15),new q(41,16))),new it(36,Int32Array.from([6,24,50,76,102,128,154]),new Ce(30,new q(6,121),new q(14,122)),new Ce(28,new q(6,47),new q(34,48)),new Ce(30,new q(46,24),new q(10,25)),new Ce(30,new q(2,15),new q(64,16))),new it(37,Int32Array.from([6,28,54,80,106,132,158]),new Ce(30,new q(17,122),new q(4,123)),new Ce(28,new q(29,46),new q(14,47)),new Ce(30,new q(49,24),new q(10,25)),new Ce(30,new q(24,15),new q(46,16))),new it(38,Int32Array.from([6,32,58,84,110,136,162]),new Ce(30,new q(4,122),new q(18,123)),new Ce(28,new q(13,46),new q(32,47)),new Ce(30,new q(48,24),new q(14,25)),new Ce(30,new q(42,15),new q(32,16))),new it(39,Int32Array.from([6,26,54,82,110,138,166]),new Ce(30,new q(20,117),new q(4,118)),new Ce(28,new q(40,47),new q(7,48)),new Ce(30,new q(43,24),new q(22,25)),new Ce(30,new q(10,15),new q(67,16))),new it(40,Int32Array.from([6,30,58,86,114,142,170]),new Ce(30,new q(19,118),new q(6,119)),new Ce(28,new q(18,47),new q(31,48)),new Ce(30,new q(34,24),new q(34,25)),new Ce(30,new q(20,15),new q(61,16)))];var Kt;(function(A){A[A.DATA_MASK_000=0]="DATA_MASK_000",A[A.DATA_MASK_001=1]="DATA_MASK_001",A[A.DATA_MASK_010=2]="DATA_MASK_010",A[A.DATA_MASK_011=3]="DATA_MASK_011",A[A.DATA_MASK_100=4]="DATA_MASK_100",A[A.DATA_MASK_101=5]="DATA_MASK_101",A[A.DATA_MASK_110=6]="DATA_MASK_110",A[A.DATA_MASK_111=7]="DATA_MASK_111"})(Kt||(Kt={}));class Is{constructor(t,s){this.value=t,this.isMasked=s}unmaskBitMatrix(t,s){for(let r=0;r<s;r++)for(let a=0;a<s;a++)this.isMasked(r,a)&&t.flip(a,r)}}Is.values=new Map([[Kt.DATA_MASK_000,new Is(Kt.DATA_MASK_000,(A,t)=>(A+t&1)===0)],[Kt.DATA_MASK_001,new Is(Kt.DATA_MASK_001,(A,t)=>(A&1)===0)],[Kt.DATA_MASK_010,new Is(Kt.DATA_MASK_010,(A,t)=>t%3===0)],[Kt.DATA_MASK_011,new Is(Kt.DATA_MASK_011,(A,t)=>(A+t)%3===0)],[Kt.DATA_MASK_100,new Is(Kt.DATA_MASK_100,(A,t)=>(Math.floor(A/2)+Math.floor(t/3)&1)===0)],[Kt.DATA_MASK_101,new Is(Kt.DATA_MASK_101,(A,t)=>A*t%6===0)],[Kt.DATA_MASK_110,new Is(Kt.DATA_MASK_110,(A,t)=>A*t%6<3)],[Kt.DATA_MASK_111,new Is(Kt.DATA_MASK_111,(A,t)=>(A+t+A*t%3&1)===0)]]);class Ui{constructor(t){const s=t.getHeight();if(s<21||(s&3)!==1)throw new _;this.bitMatrix=t}readFormatInformation(){if(this.parsedFormatInfo!==null&&this.parsedFormatInfo!==void 0)return this.parsedFormatInfo;let t=0;for(let i=0;i<6;i++)t=this.copyBit(i,8,t);t=this.copyBit(7,8,t),t=this.copyBit(8,8,t),t=this.copyBit(8,7,t);for(let i=5;i>=0;i--)t=this.copyBit(8,i,t);const s=this.bitMatrix.getHeight();let r=0;const a=s-7;for(let i=s-1;i>=a;i--)r=this.copyBit(8,i,r);for(let i=s-8;i<s;i++)r=this.copyBit(i,8,r);if(this.parsedFormatInfo=Vt.decodeFormatInformation(t,r),this.parsedFormatInfo!==null)return this.parsedFormatInfo;throw new _}readVersion(){if(this.parsedVersion!==null&&this.parsedVersion!==void 0)return this.parsedVersion;const t=this.bitMatrix.getHeight(),s=Math.floor((t-17)/4);if(s<=6)return it.getVersionForNumber(s);let r=0;const a=t-11;for(let o=5;o>=0;o--)for(let d=t-9;d>=a;d--)r=this.copyBit(d,o,r);let i=it.decodeVersionInformation(r);if(i!==null&&i.getDimensionForVersion()===t)return this.parsedVersion=i,i;r=0;for(let o=5;o>=0;o--)for(let d=t-9;d>=a;d--)r=this.copyBit(o,d,r);if(i=it.decodeVersionInformation(r),i!==null&&i.getDimensionForVersion()===t)return this.parsedVersion=i,i;throw new _}copyBit(t,s,r){return(this.isMirror?this.bitMatrix.get(s,t):this.bitMatrix.get(t,s))?r<<1|1:r<<1}readCodewords(){const t=this.readFormatInformation(),s=this.readVersion(),r=Is.values.get(t.getDataMask()),a=this.bitMatrix.getHeight();r.unmaskBitMatrix(this.bitMatrix,a);const i=s.buildFunctionPattern();let o=!0;const d=new Uint8Array(s.getTotalCodewords());let h=0,m=0,y=0;for(let I=a-1;I>0;I-=2){I===6&&I--;for(let z=0;z<a;z++){const Y=o?a-1-z:z;for(let ie=0;ie<2;ie++)i.get(I-ie,Y)||(y++,m<<=1,this.bitMatrix.get(I-ie,Y)&&(m|=1),y===8&&(d[h++]=m,y=0,m=0))}o=!o}if(h!==s.getTotalCodewords())throw new _;return d}remask(){if(this.parsedFormatInfo===null)return;const t=Is.values[this.parsedFormatInfo.getDataMask()],s=this.bitMatrix.getHeight();t.unmaskBitMatrix(this.bitMatrix,s)}setMirror(t){this.parsedVersion=null,this.parsedFormatInfo=null,this.isMirror=t}mirror(){const t=this.bitMatrix;for(let s=0,r=t.getWidth();s<r;s++)for(let a=s+1,i=t.getHeight();a<i;a++)t.get(s,a)!==t.get(a,s)&&(t.flip(a,s),t.flip(s,a))}}class Aa{constructor(t,s){this.numDataCodewords=t,this.codewords=s}static getDataBlocks(t,s,r){if(t.length!==s.getTotalCodewords())throw new p;const a=s.getECBlocksForLevel(r);let i=0;const o=a.getECBlocks();for(const ie of o)i+=ie.getCount();const d=new Array(i);let h=0;for(const ie of o)for(let ce=0;ce<ie.getCount();ce++){const Ne=ie.getDataCodewords(),ze=a.getECCodewordsPerBlock()+Ne;d[h++]=new Aa(Ne,new Uint8Array(ze))}const m=d[0].codewords.length;let y=d.length-1;for(;y>=0&&d[y].codewords.length!==m;)y--;y++;const I=m-a.getECCodewordsPerBlock();let z=0;for(let ie=0;ie<I;ie++)for(let ce=0;ce<h;ce++)d[ce].codewords[ie]=t[z++];for(let ie=y;ie<h;ie++)d[ie].codewords[I]=t[z++];const Y=d[0].codewords.length;for(let ie=I;ie<Y;ie++)for(let ce=0;ce<h;ce++){const Ne=ce<y?ie:ie+1;d[ce].codewords[Ne]=t[z++]}return d}getNumDataCodewords(){return this.numDataCodewords}getCodewords(){return this.codewords}}var Ts;(function(A){A[A.TERMINATOR=0]="TERMINATOR",A[A.NUMERIC=1]="NUMERIC",A[A.ALPHANUMERIC=2]="ALPHANUMERIC",A[A.STRUCTURED_APPEND=3]="STRUCTURED_APPEND",A[A.BYTE=4]="BYTE",A[A.ECI=5]="ECI",A[A.KANJI=6]="KANJI",A[A.FNC1_FIRST_POSITION=7]="FNC1_FIRST_POSITION",A[A.FNC1_SECOND_POSITION=8]="FNC1_SECOND_POSITION",A[A.HANZI=9]="HANZI"})(Ts||(Ts={}));class lt{constructor(t,s,r,a){this.value=t,this.stringValue=s,this.characterCountBitsForVersions=r,this.bits=a,lt.FOR_BITS.set(a,this),lt.FOR_VALUE.set(t,this)}static forBits(t){const s=lt.FOR_BITS.get(t);if(s===void 0)throw new p;return s}getCharacterCountBits(t){const s=t.getVersionNumber();let r;return s<=9?r=0:s<=26?r=1:r=2,this.characterCountBitsForVersions[r]}getValue(){return this.value}getBits(){return this.bits}equals(t){if(!(t instanceof lt))return!1;const s=t;return this.value===s.value}toString(){return this.stringValue}}lt.FOR_BITS=new Map,lt.FOR_VALUE=new Map,lt.TERMINATOR=new lt(Ts.TERMINATOR,"TERMINATOR",Int32Array.from([0,0,0]),0),lt.NUMERIC=new lt(Ts.NUMERIC,"NUMERIC",Int32Array.from([10,12,14]),1),lt.ALPHANUMERIC=new lt(Ts.ALPHANUMERIC,"ALPHANUMERIC",Int32Array.from([9,11,13]),2),lt.STRUCTURED_APPEND=new lt(Ts.STRUCTURED_APPEND,"STRUCTURED_APPEND",Int32Array.from([0,0,0]),3),lt.BYTE=new lt(Ts.BYTE,"BYTE",Int32Array.from([8,16,16]),4),lt.ECI=new lt(Ts.ECI,"ECI",Int32Array.from([0,0,0]),7),lt.KANJI=new lt(Ts.KANJI,"KANJI",Int32Array.from([8,10,12]),8),lt.FNC1_FIRST_POSITION=new lt(Ts.FNC1_FIRST_POSITION,"FNC1_FIRST_POSITION",Int32Array.from([0,0,0]),5),lt.FNC1_SECOND_POSITION=new lt(Ts.FNC1_SECOND_POSITION,"FNC1_SECOND_POSITION",Int32Array.from([0,0,0]),9),lt.HANZI=new lt(Ts.HANZI,"HANZI",Int32Array.from([8,10,12]),13);class Ht{static decode(t,s,r,a){const i=new Gt(t);let o=new se;const d=new Array;let h=-1,m=-1;try{let y=null,I=!1,z;do{if(i.available()<4)z=lt.TERMINATOR;else{const Y=i.readBits(4);z=lt.forBits(Y)}switch(z){case lt.TERMINATOR:break;case lt.FNC1_FIRST_POSITION:case lt.FNC1_SECOND_POSITION:I=!0;break;case lt.STRUCTURED_APPEND:if(i.available()<16)throw new _;h=i.readBits(8),m=i.readBits(8);break;case lt.ECI:const Y=Ht.parseECIValue(i);if(y=C.getCharacterSetECIByValue(Y),y===null)throw new _;break;case lt.HANZI:const ie=i.readBits(4),ce=i.readBits(z.getCharacterCountBits(s));ie===Ht.GB2312_SUBSET&&Ht.decodeHanziSegment(i,o,ce);break;default:const Ne=i.readBits(z.getCharacterCountBits(s));switch(z){case lt.NUMERIC:Ht.decodeNumericSegment(i,o,Ne);break;case lt.ALPHANUMERIC:Ht.decodeAlphanumericSegment(i,o,Ne,I);break;case lt.BYTE:Ht.decodeByteSegment(i,o,Ne,y,d,a);break;case lt.KANJI:Ht.decodeKanjiSegment(i,o,Ne);break;default:throw new _}break}}while(z!==lt.TERMINATOR)}catch{throw new _}return new ve(t,o.toString(),d.length===0?null:d,r===null?null:r.toString(),h,m)}static decodeHanziSegment(t,s,r){if(r*13>t.available())throw new _;const a=new Uint8Array(2*r);let i=0;for(;r>0;){const o=t.readBits(13);let d=o/96<<8&4294967295|o%96;d<959?d+=41377:d+=42657,a[i]=d>>8&255,a[i+1]=d&255,i+=2,r--}try{s.append(O.decode(a,X.GB2312))}catch(o){throw new _(o)}}static decodeKanjiSegment(t,s,r){if(r*13>t.available())throw new _;const a=new Uint8Array(2*r);let i=0;for(;r>0;){const o=t.readBits(13);let d=o/192<<8&4294967295|o%192;d<7936?d+=33088:d+=49472,a[i]=d>>8,a[i+1]=d,i+=2,r--}try{s.append(O.decode(a,X.SHIFT_JIS))}catch(o){throw new _(o)}}static decodeByteSegment(t,s,r,a,i,o){if(8*r>t.available())throw new _;const d=new Uint8Array(r);for(let m=0;m<r;m++)d[m]=t.readBits(8);let h;a===null?h=X.guessEncoding(d,o):h=a.getName();try{s.append(O.decode(d,h))}catch(m){throw new _(m)}i.push(d)}static toAlphaNumericChar(t){if(t>=Ht.ALPHANUMERIC_CHARS.length)throw new _;return Ht.ALPHANUMERIC_CHARS[t]}static decodeAlphanumericSegment(t,s,r,a){const i=s.length();for(;r>1;){if(t.available()<11)throw new _;const o=t.readBits(11);s.append(Ht.toAlphaNumericChar(Math.floor(o/45))),s.append(Ht.toAlphaNumericChar(o%45)),r-=2}if(r===1){if(t.available()<6)throw new _;s.append(Ht.toAlphaNumericChar(t.readBits(6)))}if(a)for(let o=i;o<s.length();o++)s.charAt(o)==="%"&&(o<s.length()-1&&s.charAt(o+1)==="%"?s.deleteCharAt(o+1):s.setCharAt(o,""))}static decodeNumericSegment(t,s,r){for(;r>=3;){if(t.available()<10)throw new _;const a=t.readBits(10);if(a>=1e3)throw new _;s.append(Ht.toAlphaNumericChar(Math.floor(a/100))),s.append(Ht.toAlphaNumericChar(Math.floor(a/10)%10)),s.append(Ht.toAlphaNumericChar(a%10)),r-=3}if(r===2){if(t.available()<7)throw new _;const a=t.readBits(7);if(a>=100)throw new _;s.append(Ht.toAlphaNumericChar(Math.floor(a/10))),s.append(Ht.toAlphaNumericChar(a%10))}else if(r===1){if(t.available()<4)throw new _;const a=t.readBits(4);if(a>=10)throw new _;s.append(Ht.toAlphaNumericChar(a))}}static parseECIValue(t){const s=t.readBits(8);if(!(s&128))return s&127;if((s&192)===128){const r=t.readBits(8);return(s&63)<<8&4294967295|r}if((s&224)===192){const r=t.readBits(16);return(s&31)<<16&4294967295|r}throw new _}}Ht.ALPHANUMERIC_CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:",Ht.GB2312_SUBSET=1;class dn{constructor(t){this.mirrored=t}isMirrored(){return this.mirrored}applyMirroredCorrection(t){if(!this.mirrored||t===null||t.length<3)return;const s=t[0];t[0]=t[2],t[2]=s}}class Vi{constructor(){this.rsDecoder=new st(Fe.QR_CODE_FIELD_256)}decodeBooleanArray(t,s){return this.decodeBitMatrix(W.parseFromBooleanArray(t),s)}decodeBitMatrix(t,s){const r=new Ui(t);let a=null;try{return this.decodeBitMatrixParser(r,s)}catch(i){a=i}try{r.remask(),r.setMirror(!0),r.readVersion(),r.readFormatInformation(),r.mirror();const i=this.decodeBitMatrixParser(r,s);return i.setOther(new dn(!0)),i}catch(i){throw a!==null?a:i}}decodeBitMatrixParser(t,s){const r=t.readVersion(),a=t.readFormatInformation().getErrorCorrectionLevel(),i=t.readCodewords(),o=Aa.getDataBlocks(i,r,a);let d=0;for(const y of o)d+=y.getNumDataCodewords();const h=new Uint8Array(d);let m=0;for(const y of o){const I=y.getCodewords(),z=y.getNumDataCodewords();this.correctErrors(I,z);for(let Y=0;Y<z;Y++)h[m++]=I[Y]}return Ht.decode(h,r,a,s)}correctErrors(t,s){const r=new Int32Array(t);try{this.rsDecoder.decode(r,t.length-s)}catch{throw new P}for(let a=0;a<s;a++)t[a]=r[a]}}class Ia extends qe{constructor(t,s,r){super(t,s),this.estimatedModuleSize=r}aboutEquals(t,s,r){if(Math.abs(s-this.getY())<=t&&Math.abs(r-this.getX())<=t){const a=Math.abs(t-this.estimatedModuleSize);return a<=1||a<=this.estimatedModuleSize}return!1}combineEstimate(t,s,r){const a=(this.getX()+s)/2,i=(this.getY()+t)/2,o=(this.estimatedModuleSize+r)/2;return new Ia(a,i,o)}}class ra{constructor(t,s,r,a,i,o,d){this.image=t,this.startX=s,this.startY=r,this.width=a,this.height=i,this.moduleSize=o,this.resultPointCallback=d,this.possibleCenters=[],this.crossCheckStateCount=new Int32Array(3)}find(){const t=this.startX,s=this.height,r=this.width,a=t+r,i=this.startY+s/2,o=new Int32Array(3),d=this.image;for(let h=0;h<s;h++){const m=i+(h&1?-Math.floor((h+1)/2):Math.floor((h+1)/2));o[0]=0,o[1]=0,o[2]=0;let y=t;for(;y<a&&!d.get(y,m);)y++;let I=0;for(;y<a;){if(d.get(y,m))if(I===1)o[1]++;else if(I===2){if(this.foundPatternCross(o)){const z=this.handlePossibleCenter(o,m,y);if(z!==null)return z}o[0]=o[2],o[1]=1,o[2]=0,I=1}else o[++I]++;else I===1&&I++,o[I]++;y++}if(this.foundPatternCross(o)){const z=this.handlePossibleCenter(o,m,a);if(z!==null)return z}}if(this.possibleCenters.length!==0)return this.possibleCenters[0];throw new G}static centerFromEnd(t,s){return s-t[2]-t[1]/2}foundPatternCross(t){const s=this.moduleSize,r=s/2;for(let a=0;a<3;a++)if(Math.abs(s-t[a])>=r)return!1;return!0}crossCheckVertical(t,s,r,a){const i=this.image,o=i.getHeight(),d=this.crossCheckStateCount;d[0]=0,d[1]=0,d[2]=0;let h=t;for(;h>=0&&i.get(s,h)&&d[1]<=r;)d[1]++,h--;if(h<0||d[1]>r)return NaN;for(;h>=0&&!i.get(s,h)&&d[0]<=r;)d[0]++,h--;if(d[0]>r)return NaN;for(h=t+1;h<o&&i.get(s,h)&&d[1]<=r;)d[1]++,h++;if(h===o||d[1]>r)return NaN;for(;h<o&&!i.get(s,h)&&d[2]<=r;)d[2]++,h++;if(d[2]>r)return NaN;const m=d[0]+d[1]+d[2];return 5*Math.abs(m-a)>=2*a?NaN:this.foundPatternCross(d)?ra.centerFromEnd(d,h):NaN}handlePossibleCenter(t,s,r){const a=t[0]+t[1]+t[2],i=ra.centerFromEnd(t,r),o=this.crossCheckVertical(s,i,2*t[1],a);if(!isNaN(o)){const d=(t[0]+t[1]+t[2])/3;for(const m of this.possibleCenters)if(m.aboutEquals(d,o,i))return m.combineEstimate(o,i,d);const h=new Ia(i,o,d);this.possibleCenters.push(h),this.resultPointCallback!==null&&this.resultPointCallback!==void 0&&this.resultPointCallback.foundPossibleResultPoint(h)}return null}}class Ta extends qe{constructor(t,s,r,a){super(t,s),this.estimatedModuleSize=r,this.count=a,a===void 0&&(this.count=1)}getEstimatedModuleSize(){return this.estimatedModuleSize}getCount(){return this.count}aboutEquals(t,s,r){if(Math.abs(s-this.getY())<=t&&Math.abs(r-this.getX())<=t){const a=Math.abs(t-this.estimatedModuleSize);return a<=1||a<=this.estimatedModuleSize}return!1}combineEstimate(t,s,r){const a=this.count+1,i=(this.count*this.getX()+s)/a,o=(this.count*this.getY()+t)/a,d=(this.count*this.estimatedModuleSize+r)/a;return new Ta(i,o,d,a)}}class Hi{constructor(t){this.bottomLeft=t[0],this.topLeft=t[1],this.topRight=t[2]}getBottomLeft(){return this.bottomLeft}getTopLeft(){return this.topLeft}getTopRight(){return this.topRight}}class Jt{constructor(t,s){this.image=t,this.resultPointCallback=s,this.possibleCenters=[],this.crossCheckStateCount=new Int32Array(5),this.resultPointCallback=s}getImage(){return this.image}getPossibleCenters(){return this.possibleCenters}find(t){const s=t!=null&&t.get(N.TRY_HARDER)!==void 0,r=t!=null&&t.get(N.PURE_BARCODE)!==void 0,a=this.image,i=a.getHeight(),o=a.getWidth();let d=Math.floor(3*i/(4*Jt.MAX_MODULES));(d<Jt.MIN_SKIP||s)&&(d=Jt.MIN_SKIP);let h=!1;const m=new Int32Array(5);for(let I=d-1;I<i&&!h;I+=d){m[0]=0,m[1]=0,m[2]=0,m[3]=0,m[4]=0;let z=0;for(let Y=0;Y<o;Y++)if(a.get(Y,I))(z&1)===1&&z++,m[z]++;else if(z&1)m[z]++;else if(z===4)if(Jt.foundPatternCross(m)){if(this.handlePossibleCenter(m,I,Y,r)===!0)if(d=2,this.hasSkipped===!0)h=this.haveMultiplyConfirmedCenters();else{const ce=this.findRowSkip();ce>m[2]&&(I+=ce-m[2]-d,Y=o-1)}else{m[0]=m[2],m[1]=m[3],m[2]=m[4],m[3]=1,m[4]=0,z=3;continue}z=0,m[0]=0,m[1]=0,m[2]=0,m[3]=0,m[4]=0}else m[0]=m[2],m[1]=m[3],m[2]=m[4],m[3]=1,m[4]=0,z=3;else m[++z]++;Jt.foundPatternCross(m)&&this.handlePossibleCenter(m,I,o,r)===!0&&(d=m[0],this.hasSkipped&&(h=this.haveMultiplyConfirmedCenters()))}const y=this.selectBestPatterns();return qe.orderBestPatterns(y),new Hi(y)}static centerFromEnd(t,s){return s-t[4]-t[3]-t[2]/2}static foundPatternCross(t){let s=0;for(let i=0;i<5;i++){const o=t[i];if(o===0)return!1;s+=o}if(s<7)return!1;const r=s/7,a=r/2;return Math.abs(r-t[0])<a&&Math.abs(r-t[1])<a&&Math.abs(3*r-t[2])<3*a&&Math.abs(r-t[3])<a&&Math.abs(r-t[4])<a}getCrossCheckStateCount(){const t=this.crossCheckStateCount;return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t}crossCheckDiagonal(t,s,r,a){const i=this.getCrossCheckStateCount();let o=0;const d=this.image;for(;t>=o&&s>=o&&d.get(s-o,t-o);)i[2]++,o++;if(t<o||s<o)return!1;for(;t>=o&&s>=o&&!d.get(s-o,t-o)&&i[1]<=r;)i[1]++,o++;if(t<o||s<o||i[1]>r)return!1;for(;t>=o&&s>=o&&d.get(s-o,t-o)&&i[0]<=r;)i[0]++,o++;if(i[0]>r)return!1;const h=d.getHeight(),m=d.getWidth();for(o=1;t+o<h&&s+o<m&&d.get(s+o,t+o);)i[2]++,o++;if(t+o>=h||s+o>=m)return!1;for(;t+o<h&&s+o<m&&!d.get(s+o,t+o)&&i[3]<r;)i[3]++,o++;if(t+o>=h||s+o>=m||i[3]>=r)return!1;for(;t+o<h&&s+o<m&&d.get(s+o,t+o)&&i[4]<r;)i[4]++,o++;if(i[4]>=r)return!1;const y=i[0]+i[1]+i[2]+i[3]+i[4];return Math.abs(y-a)<2*a&&Jt.foundPatternCross(i)}crossCheckVertical(t,s,r,a){const i=this.image,o=i.getHeight(),d=this.getCrossCheckStateCount();let h=t;for(;h>=0&&i.get(s,h);)d[2]++,h--;if(h<0)return NaN;for(;h>=0&&!i.get(s,h)&&d[1]<=r;)d[1]++,h--;if(h<0||d[1]>r)return NaN;for(;h>=0&&i.get(s,h)&&d[0]<=r;)d[0]++,h--;if(d[0]>r)return NaN;for(h=t+1;h<o&&i.get(s,h);)d[2]++,h++;if(h===o)return NaN;for(;h<o&&!i.get(s,h)&&d[3]<r;)d[3]++,h++;if(h===o||d[3]>=r)return NaN;for(;h<o&&i.get(s,h)&&d[4]<r;)d[4]++,h++;if(d[4]>=r)return NaN;const m=d[0]+d[1]+d[2]+d[3]+d[4];return 5*Math.abs(m-a)>=2*a?NaN:Jt.foundPatternCross(d)?Jt.centerFromEnd(d,h):NaN}crossCheckHorizontal(t,s,r,a){const i=this.image,o=i.getWidth(),d=this.getCrossCheckStateCount();let h=t;for(;h>=0&&i.get(h,s);)d[2]++,h--;if(h<0)return NaN;for(;h>=0&&!i.get(h,s)&&d[1]<=r;)d[1]++,h--;if(h<0||d[1]>r)return NaN;for(;h>=0&&i.get(h,s)&&d[0]<=r;)d[0]++,h--;if(d[0]>r)return NaN;for(h=t+1;h<o&&i.get(h,s);)d[2]++,h++;if(h===o)return NaN;for(;h<o&&!i.get(h,s)&&d[3]<r;)d[3]++,h++;if(h===o||d[3]>=r)return NaN;for(;h<o&&i.get(h,s)&&d[4]<r;)d[4]++,h++;if(d[4]>=r)return NaN;const m=d[0]+d[1]+d[2]+d[3]+d[4];return 5*Math.abs(m-a)>=a?NaN:Jt.foundPatternCross(d)?Jt.centerFromEnd(d,h):NaN}handlePossibleCenter(t,s,r,a){const i=t[0]+t[1]+t[2]+t[3]+t[4];let o=Jt.centerFromEnd(t,r),d=this.crossCheckVertical(s,Math.floor(o),t[2],i);if(!isNaN(d)&&(o=this.crossCheckHorizontal(Math.floor(o),Math.floor(d),t[2],i),!isNaN(o)&&(!a||this.crossCheckDiagonal(Math.floor(d),Math.floor(o),t[2],i)))){const h=i/7;let m=!1;const y=this.possibleCenters;for(let I=0,z=y.length;I<z;I++){const Y=y[I];if(Y.aboutEquals(h,d,o)){y[I]=Y.combineEstimate(d,o,h),m=!0;break}}if(!m){const I=new Ta(o,d,h);y.push(I),this.resultPointCallback!==null&&this.resultPointCallback!==void 0&&this.resultPointCallback.foundPossibleResultPoint(I)}return!0}return!1}findRowSkip(){if(this.possibleCenters.length<=1)return 0;let s=null;for(const r of this.possibleCenters)if(r.getCount()>=Jt.CENTER_QUORUM)if(s==null)s=r;else return this.hasSkipped=!0,Math.floor((Math.abs(s.getX()-r.getX())-Math.abs(s.getY()-r.getY()))/2);return 0}haveMultiplyConfirmedCenters(){let t=0,s=0;const r=this.possibleCenters.length;for(const o of this.possibleCenters)o.getCount()>=Jt.CENTER_QUORUM&&(t++,s+=o.getEstimatedModuleSize());if(t<3)return!1;const a=s/r;let i=0;for(const o of this.possibleCenters)i+=Math.abs(o.getEstimatedModuleSize()-a);return i<=.05*s}selectBestPatterns(){const t=this.possibleCenters.length;if(t<3)throw new G;const s=this.possibleCenters;let r;if(t>3){let a=0,i=0;for(const h of this.possibleCenters){const m=h.getEstimatedModuleSize();a+=m,i+=m*m}r=a/t;let o=Math.sqrt(i/t-r*r);s.sort((h,m)=>{const y=Math.abs(m.getEstimatedModuleSize()-r),I=Math.abs(h.getEstimatedModuleSize()-r);return y<I?-1:y>I?1:0});const d=Math.max(.2*r,o);for(let h=0;h<s.length&&s.length>3;h++){const m=s[h];Math.abs(m.getEstimatedModuleSize()-r)>d&&(s.splice(h,1),h--)}}if(s.length>3){let a=0;for(const i of s)a+=i.getEstimatedModuleSize();r=a/s.length,s.sort((i,o)=>{if(o.getCount()===i.getCount()){const d=Math.abs(o.getEstimatedModuleSize()-r),h=Math.abs(i.getEstimatedModuleSize()-r);return d<h?1:d>h?-1:0}else return o.getCount()-i.getCount()}),s.splice(3)}return[s[0],s[1],s[2]]}}Jt.CENTER_QUORUM=2,Jt.MIN_SKIP=3,Jt.MAX_MODULES=57;class zr{constructor(t){this.image=t}getImage(){return this.image}getResultPointCallback(){return this.resultPointCallback}detect(t){this.resultPointCallback=t==null?null:t.get(N.NEED_RESULT_POINT_CALLBACK);const r=new Jt(this.image,this.resultPointCallback).find(t);return this.processFinderPatternInfo(r)}processFinderPatternInfo(t){const s=t.getTopLeft(),r=t.getTopRight(),a=t.getBottomLeft(),i=this.calculateModuleSize(s,r,a);if(i<1)throw new G("No pattern found in proccess finder.");const o=zr.computeDimension(s,r,a,i),d=it.getProvisionalVersionForDimension(o),h=d.getDimensionForVersion()-7;let m=null;if(d.getAlignmentPatternCenters().length>0){const Y=r.getX()-s.getX()+a.getX(),ie=r.getY()-s.getY()+a.getY(),ce=1-3/h,Ne=Math.floor(s.getX()+ce*(Y-s.getX())),ze=Math.floor(s.getY()+ce*(ie-s.getY()));for(let Ge=4;Ge<=16;Ge<<=1)try{m=this.findAlignmentInRegion(i,Ne,ze,Ge);break}catch(Ye){if(!(Ye instanceof G))throw Ye}}const y=zr.createTransform(s,r,a,m,o),I=zr.sampleGrid(this.image,y,o);let z;return m===null?z=[a,s,r]:z=[a,s,r,m],new De(I,z)}static createTransform(t,s,r,a,i){const o=i-3.5;let d,h,m,y;return a!==null?(d=a.getX(),h=a.getY(),m=o-3,y=m):(d=s.getX()-t.getX()+r.getX(),h=s.getY()-t.getY()+r.getY(),m=o,y=o),Ae.quadrilateralToQuadrilateral(3.5,3.5,o,3.5,m,y,3.5,o,t.getX(),t.getY(),s.getX(),s.getY(),d,h,r.getX(),r.getY())}static sampleGrid(t,s,r){return ee.getInstance().sampleGridWithTransform(t,r,r,s)}static computeDimension(t,s,r,a){const i=We.round(qe.distance(t,s)/a),o=We.round(qe.distance(t,r)/a);let d=Math.floor((i+o)/2)+7;switch(d&3){case 0:d++;break;case 2:d--;break;case 3:throw new G("Dimensions could be not found.")}return d}calculateModuleSize(t,s,r){return(this.calculateModuleSizeOneWay(t,s)+this.calculateModuleSizeOneWay(t,r))/2}calculateModuleSizeOneWay(t,s){const r=this.sizeOfBlackWhiteBlackRunBothWays(Math.floor(t.getX()),Math.floor(t.getY()),Math.floor(s.getX()),Math.floor(s.getY())),a=this.sizeOfBlackWhiteBlackRunBothWays(Math.floor(s.getX()),Math.floor(s.getY()),Math.floor(t.getX()),Math.floor(t.getY()));return isNaN(r)?a/7:isNaN(a)?r/7:(r+a)/14}sizeOfBlackWhiteBlackRunBothWays(t,s,r,a){let i=this.sizeOfBlackWhiteBlackRun(t,s,r,a),o=1,d=t-(r-t);d<0?(o=t/(t-d),d=0):d>=this.image.getWidth()&&(o=(this.image.getWidth()-1-t)/(d-t),d=this.image.getWidth()-1);let h=Math.floor(s-(a-s)*o);return o=1,h<0?(o=s/(s-h),h=0):h>=this.image.getHeight()&&(o=(this.image.getHeight()-1-s)/(h-s),h=this.image.getHeight()-1),d=Math.floor(t+(d-t)*o),i+=this.sizeOfBlackWhiteBlackRun(t,s,d,h),i-1}sizeOfBlackWhiteBlackRun(t,s,r,a){const i=Math.abs(a-s)>Math.abs(r-t);if(i){let Y=t;t=s,s=Y,Y=r,r=a,a=Y}const o=Math.abs(r-t),d=Math.abs(a-s);let h=-o/2;const m=t<r?1:-1,y=s<a?1:-1;let I=0;const z=r+m;for(let Y=t,ie=s;Y!==z;Y+=m){const ce=i?ie:Y,Ne=i?Y:ie;if(I===1===this.image.get(ce,Ne)){if(I===2)return We.distance(Y,ie,t,s);I++}if(h+=d,h>0){if(ie===a)break;ie+=y,h-=o}}return I===2?We.distance(r+m,a,t,s):NaN}findAlignmentInRegion(t,s,r,a){const i=Math.floor(a*t),o=Math.max(0,s-i),d=Math.min(this.image.getWidth()-1,s+i);if(d-o<t*3)throw new G("Alignment top exceeds estimated module size.");const h=Math.max(0,r-i),m=Math.min(this.image.getHeight()-1,r+i);if(m-h<t*3)throw new G("Alignment bottom exceeds estimated module size.");return new ra(this.image,o,h,d-o,m-h,t,this.resultPointCallback).find()}}class Ks{constructor(){this.decoder=new Vi}getDecoder(){return this.decoder}decode(t,s){let r,a;if(s!=null&&s.get(N.PURE_BARCODE)!==void 0){const h=Ks.extractPureBits(t.getBlackMatrix());r=this.decoder.decodeBitMatrix(h,s),a=Ks.NO_POINTS}else{const h=new zr(t.getBlackMatrix()).detect(s);r=this.decoder.decodeBitMatrix(h.getBits(),s),a=h.getPoints()}r.getOther()instanceof dn&&r.getOther().applyMirroredCorrection(a);const i=new L(r.getText(),r.getRawBytes(),void 0,a,de.QR_CODE,void 0),o=r.getByteSegments();o!==null&&i.putMetadata(ge.BYTE_SEGMENTS,o);const d=r.getECLevel();return d!==null&&i.putMetadata(ge.ERROR_CORRECTION_LEVEL,d),r.hasStructuredAppend()&&(i.putMetadata(ge.STRUCTURED_APPEND_SEQUENCE,r.getStructuredAppendSequenceNumber()),i.putMetadata(ge.STRUCTURED_APPEND_PARITY,r.getStructuredAppendParity())),i}reset(){}static extractPureBits(t){const s=t.getTopLeftOnBit(),r=t.getBottomRightOnBit();if(s===null||r===null)throw new G;const a=this.moduleSize(s,t);let i=s[1],o=r[1],d=s[0],h=r[0];if(d>=h||i>=o)throw new G;if(o-i!==h-d&&(h=d+(o-i),h>=t.getWidth()))throw new G;const m=Math.round((h-d+1)/a),y=Math.round((o-i+1)/a);if(m<=0||y<=0)throw new G;if(y!==m)throw new G;const I=Math.floor(a/2);i+=I,d+=I;const z=d+Math.floor((m-1)*a)-h;if(z>0){if(z>I)throw new G;d-=z}const Y=i+Math.floor((y-1)*a)-o;if(Y>0){if(Y>I)throw new G;i-=Y}const ie=new W(m,y);for(let ce=0;ce<y;ce++){const Ne=i+Math.floor(ce*a);for(let ze=0;ze<m;ze++)t.get(d+Math.floor(ze*a),Ne)&&ie.set(ze,ce)}return ie}static moduleSize(t,s){const r=s.getHeight(),a=s.getWidth();let i=t[0],o=t[1],d=!0,h=0;for(;i<a&&o<r;){if(d!==s.get(i,o)){if(++h===5)break;d=!d}i++,o++}if(i===a||o===r)throw new G;return(i-t[0])/7}}Ks.NO_POINTS=new Array;class ut{PDF417Common(){}static getBitCountSum(t){return We.sum(t)}static toIntArray(t){if(t==null||!t.length)return ut.EMPTY_INT_ARRAY;const s=new Int32Array(t.length);let r=0;for(const a of t)s[r++]=a;return s}static getCodeword(t){const s=T.binarySearch(ut.SYMBOL_TABLE,t&262143);return s<0?-1:(ut.CODEWORD_TABLE[s]-1)%ut.NUMBER_OF_CODEWORDS}}ut.NUMBER_OF_CODEWORDS=929,ut.MAX_CODEWORDS_IN_BARCODE=ut.NUMBER_OF_CODEWORDS-1,ut.MIN_ROWS_IN_BARCODE=3,ut.MAX_ROWS_IN_BARCODE=90,ut.MODULES_IN_CODEWORD=17,ut.MODULES_IN_STOP_PATTERN=18,ut.BARS_IN_MODULE=8,ut.EMPTY_INT_ARRAY=new Int32Array([]),ut.SYMBOL_TABLE=Int32Array.from([66142,66170,66206,66236,66290,66292,66350,66382,66396,66454,66470,66476,66594,66600,66614,66626,66628,66632,66640,66654,66662,66668,66682,66690,66718,66720,66748,66758,66776,66798,66802,66804,66820,66824,66832,66846,66848,66876,66880,66936,66950,66956,66968,66992,67006,67022,67036,67042,67044,67048,67062,67118,67150,67164,67214,67228,67256,67294,67322,67350,67366,67372,67398,67404,67416,67438,67474,67476,67490,67492,67496,67510,67618,67624,67650,67656,67664,67678,67686,67692,67706,67714,67716,67728,67742,67744,67772,67782,67788,67800,67822,67826,67828,67842,67848,67870,67872,67900,67904,67960,67974,67992,68016,68030,68046,68060,68066,68068,68072,68086,68104,68112,68126,68128,68156,68160,68216,68336,68358,68364,68376,68400,68414,68448,68476,68494,68508,68536,68546,68548,68552,68560,68574,68582,68588,68654,68686,68700,68706,68708,68712,68726,68750,68764,68792,68802,68804,68808,68816,68830,68838,68844,68858,68878,68892,68920,68976,68990,68994,68996,69e3,69008,69022,69024,69052,69062,69068,69080,69102,69106,69108,69142,69158,69164,69190,69208,69230,69254,69260,69272,69296,69310,69326,69340,69386,69394,69396,69410,69416,69430,69442,69444,69448,69456,69470,69478,69484,69554,69556,69666,69672,69698,69704,69712,69726,69754,69762,69764,69776,69790,69792,69820,69830,69836,69848,69870,69874,69876,69890,69918,69920,69948,69952,70008,70022,70040,70064,70078,70094,70108,70114,70116,70120,70134,70152,70174,70176,70264,70384,70412,70448,70462,70496,70524,70542,70556,70584,70594,70600,70608,70622,70630,70636,70664,70672,70686,70688,70716,70720,70776,70896,71136,71180,71192,71216,71230,71264,71292,71360,71416,71452,71480,71536,71550,71554,71556,71560,71568,71582,71584,71612,71622,71628,71640,71662,71726,71732,71758,71772,71778,71780,71784,71798,71822,71836,71864,71874,71880,71888,71902,71910,71916,71930,71950,71964,71992,72048,72062,72066,72068,72080,72094,72096,72124,72134,72140,72152,72174,72178,72180,72206,72220,72248,72304,72318,72416,72444,72456,72464,72478,72480,72508,72512,72568,72588,72600,72624,72638,72654,72668,72674,72676,72680,72694,72726,72742,72748,72774,72780,72792,72814,72838,72856,72880,72894,72910,72924,72930,72932,72936,72950,72966,72972,72984,73008,73022,73056,73084,73102,73116,73144,73156,73160,73168,73182,73190,73196,73210,73226,73234,73236,73250,73252,73256,73270,73282,73284,73296,73310,73318,73324,73346,73348,73352,73360,73374,73376,73404,73414,73420,73432,73454,73498,73518,73522,73524,73550,73564,73570,73572,73576,73590,73800,73822,73858,73860,73872,73886,73888,73916,73944,73970,73972,73992,74014,74016,74044,74048,74104,74118,74136,74160,74174,74210,74212,74216,74230,74244,74256,74270,74272,74360,74480,74502,74508,74544,74558,74592,74620,74638,74652,74680,74690,74696,74704,74726,74732,74782,74784,74812,74992,75232,75288,75326,75360,75388,75456,75512,75576,75632,75646,75650,75652,75664,75678,75680,75708,75718,75724,75736,75758,75808,75836,75840,75896,76016,76256,76736,76824,76848,76862,76896,76924,76992,77048,77296,77340,77368,77424,77438,77536,77564,77572,77576,77584,77600,77628,77632,77688,77702,77708,77720,77744,77758,77774,77788,77870,77902,77916,77922,77928,77966,77980,78008,78018,78024,78032,78046,78060,78074,78094,78136,78192,78206,78210,78212,78224,78238,78240,78268,78278,78284,78296,78322,78324,78350,78364,78448,78462,78560,78588,78600,78622,78624,78652,78656,78712,78726,78744,78768,78782,78798,78812,78818,78820,78824,78838,78862,78876,78904,78960,78974,79072,79100,79296,79352,79368,79376,79390,79392,79420,79424,79480,79600,79628,79640,79664,79678,79712,79740,79772,79800,79810,79812,79816,79824,79838,79846,79852,79894,79910,79916,79942,79948,79960,79982,79988,80006,80024,80048,80062,80078,80092,80098,80100,80104,80134,80140,80176,80190,80224,80252,80270,80284,80312,80328,80336,80350,80358,80364,80378,80390,80396,80408,80432,80446,80480,80508,80576,80632,80654,80668,80696,80752,80766,80776,80784,80798,80800,80828,80844,80856,80878,80882,80884,80914,80916,80930,80932,80936,80950,80962,80968,80976,80990,80998,81004,81026,81028,81040,81054,81056,81084,81094,81100,81112,81134,81154,81156,81160,81168,81182,81184,81212,81216,81272,81286,81292,81304,81328,81342,81358,81372,81380,81384,81398,81434,81454,81458,81460,81486,81500,81506,81508,81512,81526,81550,81564,81592,81602,81604,81608,81616,81630,81638,81644,81702,81708,81722,81734,81740,81752,81774,81778,81780,82050,82078,82080,82108,82180,82184,82192,82206,82208,82236,82240,82296,82316,82328,82352,82366,82402,82404,82408,82440,82448,82462,82464,82492,82496,82552,82672,82694,82700,82712,82736,82750,82784,82812,82830,82882,82884,82888,82896,82918,82924,82952,82960,82974,82976,83004,83008,83064,83184,83424,83468,83480,83504,83518,83552,83580,83648,83704,83740,83768,83824,83838,83842,83844,83848,83856,83872,83900,83910,83916,83928,83950,83984,84e3,84028,84032,84088,84208,84448,84928,85040,85054,85088,85116,85184,85240,85488,85560,85616,85630,85728,85756,85764,85768,85776,85790,85792,85820,85824,85880,85894,85900,85912,85936,85966,85980,86048,86080,86136,86256,86496,86976,88160,88188,88256,88312,88560,89056,89200,89214,89312,89340,89536,89592,89608,89616,89632,89664,89720,89840,89868,89880,89904,89952,89980,89998,90012,90040,90190,90204,90254,90268,90296,90306,90308,90312,90334,90382,90396,90424,90480,90494,90500,90504,90512,90526,90528,90556,90566,90572,90584,90610,90612,90638,90652,90680,90736,90750,90848,90876,90884,90888,90896,90910,90912,90940,90944,91e3,91014,91020,91032,91056,91070,91086,91100,91106,91108,91112,91126,91150,91164,91192,91248,91262,91360,91388,91584,91640,91664,91678,91680,91708,91712,91768,91888,91928,91952,91966,92e3,92028,92046,92060,92088,92098,92100,92104,92112,92126,92134,92140,92188,92216,92272,92384,92412,92608,92664,93168,93200,93214,93216,93244,93248,93304,93424,93664,93720,93744,93758,93792,93820,93888,93944,93980,94008,94064,94078,94084,94088,94096,94110,94112,94140,94150,94156,94168,94246,94252,94278,94284,94296,94318,94342,94348,94360,94384,94398,94414,94428,94440,94470,94476,94488,94512,94526,94560,94588,94606,94620,94648,94658,94660,94664,94672,94686,94694,94700,94714,94726,94732,94744,94768,94782,94816,94844,94912,94968,94990,95004,95032,95088,95102,95112,95120,95134,95136,95164,95180,95192,95214,95218,95220,95244,95256,95280,95294,95328,95356,95424,95480,95728,95758,95772,95800,95856,95870,95968,95996,96008,96016,96030,96032,96060,96064,96120,96152,96176,96190,96220,96226,96228,96232,96290,96292,96296,96310,96322,96324,96328,96336,96350,96358,96364,96386,96388,96392,96400,96414,96416,96444,96454,96460,96472,96494,96498,96500,96514,96516,96520,96528,96542,96544,96572,96576,96632,96646,96652,96664,96688,96702,96718,96732,96738,96740,96744,96758,96772,96776,96784,96798,96800,96828,96832,96888,97008,97030,97036,97048,97072,97086,97120,97148,97166,97180,97208,97220,97224,97232,97246,97254,97260,97326,97330,97332,97358,97372,97378,97380,97384,97398,97422,97436,97464,97474,97476,97480,97488,97502,97510,97516,97550,97564,97592,97648,97666,97668,97672,97680,97694,97696,97724,97734,97740,97752,97774,97830,97836,97850,97862,97868,97880,97902,97906,97908,97926,97932,97944,97968,97998,98012,98018,98020,98024,98038,98618,98674,98676,98838,98854,98874,98892,98904,98926,98930,98932,98968,99006,99042,99044,99048,99062,99166,99194,99246,99286,99350,99366,99372,99386,99398,99416,99438,99442,99444,99462,99504,99518,99534,99548,99554,99556,99560,99574,99590,99596,99608,99632,99646,99680,99708,99726,99740,99768,99778,99780,99784,99792,99806,99814,99820,99834,99858,99860,99874,99880,99894,99906,99920,99934,99962,99970,99972,99976,99984,99998,1e5,100028,100038,100044,100056,100078,100082,100084,100142,100174,100188,100246,100262,100268,100306,100308,100390,100396,100410,100422,100428,100440,100462,100466,100468,100486,100504,100528,100542,100558,100572,100578,100580,100584,100598,100620,100656,100670,100704,100732,100750,100792,100802,100808,100816,100830,100838,100844,100858,100888,100912,100926,100960,100988,101056,101112,101148,101176,101232,101246,101250,101252,101256,101264,101278,101280,101308,101318,101324,101336,101358,101362,101364,101410,101412,101416,101430,101442,101448,101456,101470,101478,101498,101506,101508,101520,101534,101536,101564,101580,101618,101620,101636,101640,101648,101662,101664,101692,101696,101752,101766,101784,101838,101858,101860,101864,101934,101938,101940,101966,101980,101986,101988,101992,102030,102044,102072,102082,102084,102088,102096,102138,102166,102182,102188,102214,102220,102232,102254,102282,102290,102292,102306,102308,102312,102326,102444,102458,102470,102476,102488,102514,102516,102534,102552,102576,102590,102606,102620,102626,102632,102646,102662,102668,102704,102718,102752,102780,102798,102812,102840,102850,102856,102864,102878,102886,102892,102906,102936,102974,103008,103036,103104,103160,103224,103280,103294,103298,103300,103312,103326,103328,103356,103366,103372,103384,103406,103410,103412,103472,103486,103520,103548,103616,103672,103920,103992,104048,104062,104160,104188,104194,104196,104200,104208,104224,104252,104256,104312,104326,104332,104344,104368,104382,104398,104412,104418,104420,104424,104482,104484,104514,104520,104528,104542,104550,104570,104578,104580,104592,104606,104608,104636,104652,104690,104692,104706,104712,104734,104736,104764,104768,104824,104838,104856,104910,104930,104932,104936,104968,104976,104990,104992,105020,105024,105080,105200,105240,105278,105312,105372,105410,105412,105416,105424,105446,105518,105524,105550,105564,105570,105572,105576,105614,105628,105656,105666,105672,105680,105702,105722,105742,105756,105784,105840,105854,105858,105860,105864,105872,105888,105932,105970,105972,106006,106022,106028,106054,106060,106072,106100,106118,106124,106136,106160,106174,106190,106210,106212,106216,106250,106258,106260,106274,106276,106280,106306,106308,106312,106320,106334,106348,106394,106414,106418,106420,106566,106572,106610,106612,106630,106636,106648,106672,106686,106722,106724,106728,106742,106758,106764,106776,106800,106814,106848,106876,106894,106908,106936,106946,106948,106952,106960,106974,106982,106988,107032,107056,107070,107104,107132,107200,107256,107292,107320,107376,107390,107394,107396,107400,107408,107422,107424,107452,107462,107468,107480,107502,107506,107508,107544,107568,107582,107616,107644,107712,107768,108016,108060,108088,108144,108158,108256,108284,108290,108292,108296,108304,108318,108320,108348,108352,108408,108422,108428,108440,108464,108478,108494,108508,108514,108516,108520,108592,108640,108668,108736,108792,109040,109536,109680,109694,109792,109820,110016,110072,110084,110088,110096,110112,110140,110144,110200,110320,110342,110348,110360,110384,110398,110432,110460,110478,110492,110520,110532,110536,110544,110558,110658,110686,110714,110722,110724,110728,110736,110750,110752,110780,110796,110834,110836,110850,110852,110856,110864,110878,110880,110908,110912,110968,110982,111e3,111054,111074,111076,111080,111108,111112,111120,111134,111136,111164,111168,111224,111344,111372,111422,111456,111516,111554,111556,111560,111568,111590,111632,111646,111648,111676,111680,111736,111856,112096,112152,112224,112252,112320,112440,112514,112516,112520,112528,112542,112544,112588,112686,112718,112732,112782,112796,112824,112834,112836,112840,112848,112870,112890,112910,112924,112952,113008,113022,113026,113028,113032,113040,113054,113056,113100,113138,113140,113166,113180,113208,113264,113278,113376,113404,113416,113424,113440,113468,113472,113560,113614,113634,113636,113640,113686,113702,113708,113734,113740,113752,113778,113780,113798,113804,113816,113840,113854,113870,113890,113892,113896,113926,113932,113944,113968,113982,114016,114044,114076,114114,114116,114120,114128,114150,114170,114194,114196,114210,114212,114216,114242,114244,114248,114256,114270,114278,114306,114308,114312,114320,114334,114336,114364,114380,114420,114458,114478,114482,114484,114510,114524,114530,114532,114536,114842,114866,114868,114970,114994,114996,115042,115044,115048,115062,115130,115226,115250,115252,115278,115292,115298,115300,115304,115318,115342,115394,115396,115400,115408,115422,115430,115436,115450,115478,115494,115514,115526,115532,115570,115572,115738,115758,115762,115764,115790,115804,115810,115812,115816,115830,115854,115868,115896,115906,115912,115920,115934,115942,115948,115962,115996,116024,116080,116094,116098,116100,116104,116112,116126,116128,116156,116166,116172,116184,116206,116210,116212,116246,116262,116268,116282,116294,116300,116312,116334,116338,116340,116358,116364,116376,116400,116414,116430,116444,116450,116452,116456,116498,116500,116514,116520,116534,116546,116548,116552,116560,116574,116582,116588,116602,116654,116694,116714,116762,116782,116786,116788,116814,116828,116834,116836,116840,116854,116878,116892,116920,116930,116936,116944,116958,116966,116972,116986,117006,117048,117104,117118,117122,117124,117136,117150,117152,117180,117190,117196,117208,117230,117234,117236,117304,117360,117374,117472,117500,117506,117508,117512,117520,117536,117564,117568,117624,117638,117644,117656,117680,117694,117710,117724,117730,117732,117736,117750,117782,117798,117804,117818,117830,117848,117874,117876,117894,117936,117950,117966,117986,117988,117992,118022,118028,118040,118064,118078,118112,118140,118172,118210,118212,118216,118224,118238,118246,118266,118306,118312,118338,118352,118366,118374,118394,118402,118404,118408,118416,118430,118432,118460,118476,118514,118516,118574,118578,118580,118606,118620,118626,118628,118632,118678,118694,118700,118730,118738,118740,118830,118834,118836,118862,118876,118882,118884,118888,118902,118926,118940,118968,118978,118980,118984,118992,119006,119014,119020,119034,119068,119096,119152,119166,119170,119172,119176,119184,119198,119200,119228,119238,119244,119256,119278,119282,119284,119324,119352,119408,119422,119520,119548,119554,119556,119560,119568,119582,119584,119612,119616,119672,119686,119692,119704,119728,119742,119758,119772,119778,119780,119784,119798,119920,119934,120032,120060,120256,120312,120324,120328,120336,120352,120384,120440,120560,120582,120588,120600,120624,120638,120672,120700,120718,120732,120760,120770,120772,120776,120784,120798,120806,120812,120870,120876,120890,120902,120908,120920,120946,120948,120966,120972,120984,121008,121022,121038,121058,121060,121064,121078,121100,121112,121136,121150,121184,121212,121244,121282,121284,121288,121296,121318,121338,121356,121368,121392,121406,121440,121468,121536,121592,121656,121730,121732,121736,121744,121758,121760,121804,121842,121844,121890,121922,121924,121928,121936,121950,121958,121978,121986,121988,121992,122e3,122014,122016,122044,122060,122098,122100,122116,122120,122128,122142,122144,122172,122176,122232,122246,122264,122318,122338,122340,122344,122414,122418,122420,122446,122460,122466,122468,122472,122510,122524,122552,122562,122564,122568,122576,122598,122618,122646,122662,122668,122694,122700,122712,122738,122740,122762,122770,122772,122786,122788,122792,123018,123026,123028,123042,123044,123048,123062,123098,123146,123154,123156,123170,123172,123176,123190,123202,123204,123208,123216,123238,123244,123258,123290,123314,123316,123402,123410,123412,123426,123428,123432,123446,123458,123464,123472,123486,123494,123500,123514,123522,123524,123528,123536,123552,123580,123590,123596,123608,123630,123634,123636,123674,123698,123700,123740,123746,123748,123752,123834,123914,123922,123924,123938,123944,123958,123970,123976,123984,123998,124006,124012,124026,124034,124036,124048,124062,124064,124092,124102,124108,124120,124142,124146,124148,124162,124164,124168,124176,124190,124192,124220,124224,124280,124294,124300,124312,124336,124350,124366,124380,124386,124388,124392,124406,124442,124462,124466,124468,124494,124508,124514,124520,124558,124572,124600,124610,124612,124616,124624,124646,124666,124694,124710,124716,124730,124742,124748,124760,124786,124788,124818,124820,124834,124836,124840,124854,124946,124948,124962,124964,124968,124982,124994,124996,125e3,125008,125022,125030,125036,125050,125058,125060,125064,125072,125086,125088,125116,125126,125132,125144,125166,125170,125172,125186,125188,125192,125200,125216,125244,125248,125304,125318,125324,125336,125360,125374,125390,125404,125410,125412,125416,125430,125444,125448,125456,125472,125504,125560,125680,125702,125708,125720,125744,125758,125792,125820,125838,125852,125880,125890,125892,125896,125904,125918,125926,125932,125978,125998,126002,126004,126030,126044,126050,126052,126056,126094,126108,126136,126146,126148,126152,126160,126182,126202,126222,126236,126264,126320,126334,126338,126340,126344,126352,126366,126368,126412,126450,126452,126486,126502,126508,126522,126534,126540,126552,126574,126578,126580,126598,126604,126616,126640,126654,126670,126684,126690,126692,126696,126738,126754,126756,126760,126774,126786,126788,126792,126800,126814,126822,126828,126842,126894,126898,126900,126934,127126,127142,127148,127162,127178,127186,127188,127254,127270,127276,127290,127302,127308,127320,127342,127346,127348,127370,127378,127380,127394,127396,127400,127450,127510,127526,127532,127546,127558,127576,127598,127602,127604,127622,127628,127640,127664,127678,127694,127708,127714,127716,127720,127734,127754,127762,127764,127778,127784,127810,127812,127816,127824,127838,127846,127866,127898,127918,127922,127924,128022,128038,128044,128058,128070,128076,128088,128110,128114,128116,128134,128140,128152,128176,128190,128206,128220,128226,128228,128232,128246,128262,128268,128280,128304,128318,128352,128380,128398,128412,128440,128450,128452,128456,128464,128478,128486,128492,128506,128522,128530,128532,128546,128548,128552,128566,128578,128580,128584,128592,128606,128614,128634,128642,128644,128648,128656,128670,128672,128700,128716,128754,128756,128794,128814,128818,128820,128846,128860,128866,128868,128872,128886,128918,128934,128940,128954,128978,128980,129178,129198,129202,129204,129238,129258,129306,129326,129330,129332,129358,129372,129378,129380,129384,129398,129430,129446,129452,129466,129482,129490,129492,129562,129582,129586,129588,129614,129628,129634,129636,129640,129654,129678,129692,129720,129730,129732,129736,129744,129758,129766,129772,129814,129830,129836,129850,129862,129868,129880,129902,129906,129908,129930,129938,129940,129954,129956,129960,129974,130010]),ut.CODEWORD_TABLE=Int32Array.from([2627,1819,2622,2621,1813,1812,2729,2724,2723,2779,2774,2773,902,896,908,868,865,861,859,2511,873,871,1780,835,2493,825,2491,842,837,844,1764,1762,811,810,809,2483,807,2482,806,2480,815,814,813,812,2484,817,816,1745,1744,1742,1746,2655,2637,2635,2626,2625,2623,2628,1820,2752,2739,2737,2728,2727,2725,2730,2785,2783,2778,2777,2775,2780,787,781,747,739,736,2413,754,752,1719,692,689,681,2371,678,2369,700,697,694,703,1688,1686,642,638,2343,631,2341,627,2338,651,646,643,2345,654,652,1652,1650,1647,1654,601,599,2322,596,2321,594,2319,2317,611,610,608,606,2324,603,2323,615,614,612,1617,1616,1614,1612,616,1619,1618,2575,2538,2536,905,901,898,909,2509,2507,2504,870,867,864,860,2512,875,872,1781,2490,2489,2487,2485,1748,836,834,832,830,2494,827,2492,843,841,839,845,1765,1763,2701,2676,2674,2653,2648,2656,2634,2633,2631,2629,1821,2638,2636,2770,2763,2761,2750,2745,2753,2736,2735,2733,2731,1848,2740,2738,2786,2784,591,588,576,569,566,2296,1590,537,534,526,2276,522,2274,545,542,539,548,1572,1570,481,2245,466,2242,462,2239,492,485,482,2249,496,494,1534,1531,1528,1538,413,2196,406,2191,2188,425,419,2202,415,2199,432,430,427,1472,1467,1464,433,1476,1474,368,367,2160,365,2159,362,2157,2155,2152,378,377,375,2166,372,2165,369,2162,383,381,379,2168,1419,1418,1416,1414,385,1411,384,1423,1422,1420,1424,2461,802,2441,2439,790,786,783,794,2409,2406,2403,750,742,738,2414,756,753,1720,2367,2365,2362,2359,1663,693,691,684,2373,680,2370,702,699,696,704,1690,1687,2337,2336,2334,2332,1624,2329,1622,640,637,2344,634,2342,630,2340,650,648,645,2346,655,653,1653,1651,1649,1655,2612,2597,2595,2571,2568,2565,2576,2534,2529,2526,1787,2540,2537,907,904,900,910,2503,2502,2500,2498,1768,2495,1767,2510,2508,2506,869,866,863,2513,876,874,1782,2720,2713,2711,2697,2694,2691,2702,2672,2670,2664,1828,2678,2675,2647,2646,2644,2642,1823,2639,1822,2654,2652,2650,2657,2771,1855,2765,2762,1850,1849,2751,2749,2747,2754,353,2148,344,342,336,2142,332,2140,345,1375,1373,306,2130,299,2128,295,2125,319,314,311,2132,1354,1352,1349,1356,262,257,2101,253,2096,2093,274,273,267,2107,263,2104,280,278,275,1316,1311,1308,1320,1318,2052,202,2050,2044,2040,219,2063,212,2060,208,2055,224,221,2066,1260,1258,1252,231,1248,229,1266,1264,1261,1268,155,1998,153,1996,1994,1991,1988,165,164,2007,162,2006,159,2003,2e3,172,171,169,2012,166,2010,1186,1184,1182,1179,175,1176,173,1192,1191,1189,1187,176,1194,1193,2313,2307,2305,592,589,2294,2292,2289,578,572,568,2297,580,1591,2272,2267,2264,1547,538,536,529,2278,525,2275,547,544,541,1574,1571,2237,2235,2229,1493,2225,1489,478,2247,470,2244,465,2241,493,488,484,2250,498,495,1536,1533,1530,1539,2187,2186,2184,2182,1432,2179,1430,2176,1427,414,412,2197,409,2195,405,2193,2190,426,424,421,2203,418,2201,431,429,1473,1471,1469,1466,434,1477,1475,2478,2472,2470,2459,2457,2454,2462,803,2437,2432,2429,1726,2443,2440,792,789,785,2401,2399,2393,1702,2389,1699,2411,2408,2405,745,741,2415,758,755,1721,2358,2357,2355,2353,1661,2350,1660,2347,1657,2368,2366,2364,2361,1666,690,687,2374,683,2372,701,698,705,1691,1689,2619,2617,2610,2608,2605,2613,2593,2588,2585,1803,2599,2596,2563,2561,2555,1797,2551,1795,2573,2570,2567,2577,2525,2524,2522,2520,1786,2517,1785,2514,1783,2535,2533,2531,2528,1788,2541,2539,906,903,911,2721,1844,2715,2712,1838,1836,2699,2696,2693,2703,1827,1826,1824,2673,2671,2669,2666,1829,2679,2677,1858,1857,2772,1854,1853,1851,1856,2766,2764,143,1987,139,1986,135,133,131,1984,128,1983,125,1981,138,137,136,1985,1133,1132,1130,112,110,1974,107,1973,104,1971,1969,122,121,119,117,1977,114,1976,124,1115,1114,1112,1110,1117,1116,84,83,1953,81,1952,78,1950,1948,1945,94,93,91,1959,88,1958,85,1955,99,97,95,1961,1086,1085,1083,1081,1078,100,1090,1089,1087,1091,49,47,1917,44,1915,1913,1910,1907,59,1926,56,1925,53,1922,1919,66,64,1931,61,1929,1042,1040,1038,71,1035,70,1032,68,1048,1047,1045,1043,1050,1049,12,10,1869,1867,1864,1861,21,1880,19,1877,1874,1871,28,1888,25,1886,22,1883,982,980,977,974,32,30,991,989,987,984,34,995,994,992,2151,2150,2147,2146,2144,356,355,354,2149,2139,2138,2136,2134,1359,343,341,338,2143,335,2141,348,347,346,1376,1374,2124,2123,2121,2119,1326,2116,1324,310,308,305,2131,302,2129,298,2127,320,318,316,313,2133,322,321,1355,1353,1351,1357,2092,2091,2089,2087,1276,2084,1274,2081,1271,259,2102,256,2100,252,2098,2095,272,269,2108,266,2106,281,279,277,1317,1315,1313,1310,282,1321,1319,2039,2037,2035,2032,1203,2029,1200,1197,207,2053,205,2051,201,2049,2046,2043,220,218,2064,215,2062,211,2059,228,226,223,2069,1259,1257,1254,232,1251,230,1267,1265,1263,2316,2315,2312,2311,2309,2314,2304,2303,2301,2299,1593,2308,2306,590,2288,2287,2285,2283,1578,2280,1577,2295,2293,2291,579,577,574,571,2298,582,581,1592,2263,2262,2260,2258,1545,2255,1544,2252,1541,2273,2271,2269,2266,1550,535,532,2279,528,2277,546,543,549,1575,1573,2224,2222,2220,1486,2217,1485,2214,1482,1479,2238,2236,2234,2231,1496,2228,1492,480,477,2248,473,2246,469,2243,490,487,2251,497,1537,1535,1532,2477,2476,2474,2479,2469,2468,2466,2464,1730,2473,2471,2453,2452,2450,2448,1729,2445,1728,2460,2458,2456,2463,805,804,2428,2427,2425,2423,1725,2420,1724,2417,1722,2438,2436,2434,2431,1727,2444,2442,793,791,788,795,2388,2386,2384,1697,2381,1696,2378,1694,1692,2402,2400,2398,2395,1703,2392,1701,2412,2410,2407,751,748,744,2416,759,757,1807,2620,2618,1806,1805,2611,2609,2607,2614,1802,1801,1799,2594,2592,2590,2587,1804,2600,2598,1794,1793,1791,1789,2564,2562,2560,2557,1798,2554,1796,2574,2572,2569,2578,1847,1846,2722,1843,1842,1840,1845,2716,2714,1835,1834,1832,1830,1839,1837,2700,2698,2695,2704,1817,1811,1810,897,862,1777,829,826,838,1760,1758,808,2481,1741,1740,1738,1743,2624,1818,2726,2776,782,740,737,1715,686,679,695,1682,1680,639,628,2339,647,644,1645,1643,1640,1648,602,600,597,595,2320,593,2318,609,607,604,1611,1610,1608,1606,613,1615,1613,2328,926,924,892,886,899,857,850,2505,1778,824,823,821,819,2488,818,2486,833,831,828,840,1761,1759,2649,2632,2630,2746,2734,2732,2782,2781,570,567,1587,531,527,523,540,1566,1564,476,467,463,2240,486,483,1524,1521,1518,1529,411,403,2192,399,2189,423,416,1462,1457,1454,428,1468,1465,2210,366,363,2158,360,2156,357,2153,376,373,370,2163,1410,1409,1407,1405,382,1402,380,1417,1415,1412,1421,2175,2174,777,774,771,784,732,725,722,2404,743,1716,676,674,668,2363,665,2360,685,1684,1681,626,624,622,2335,620,2333,617,2330,641,635,649,1646,1644,1642,2566,928,925,2530,2527,894,891,888,2501,2499,2496,858,856,854,851,1779,2692,2668,2665,2645,2643,2640,2651,2768,2759,2757,2744,2743,2741,2748,352,1382,340,337,333,1371,1369,307,300,296,2126,315,312,1347,1342,1350,261,258,250,2097,246,2094,271,268,264,1306,1301,1298,276,1312,1309,2115,203,2048,195,2045,191,2041,213,209,2056,1246,1244,1238,225,1234,222,1256,1253,1249,1262,2080,2079,154,1997,150,1995,147,1992,1989,163,160,2004,156,2001,1175,1174,1172,1170,1167,170,1164,167,1185,1183,1180,1177,174,1190,1188,2025,2024,2022,587,586,564,559,556,2290,573,1588,520,518,512,2268,508,2265,530,1568,1565,461,457,2233,450,2230,446,2226,479,471,489,1526,1523,1520,397,395,2185,392,2183,389,2180,2177,410,2194,402,422,1463,1461,1459,1456,1470,2455,799,2433,2430,779,776,773,2397,2394,2390,734,728,724,746,1717,2356,2354,2351,2348,1658,677,675,673,670,667,688,1685,1683,2606,2589,2586,2559,2556,2552,927,2523,2521,2518,2515,1784,2532,895,893,890,2718,2709,2707,2689,2687,2684,2663,2662,2660,2658,1825,2667,2769,1852,2760,2758,142,141,1139,1138,134,132,129,126,1982,1129,1128,1126,1131,113,111,108,105,1972,101,1970,120,118,115,1109,1108,1106,1104,123,1113,1111,82,79,1951,75,1949,72,1946,92,89,86,1956,1077,1076,1074,1072,98,1069,96,1084,1082,1079,1088,1968,1967,48,45,1916,42,1914,39,1911,1908,60,57,54,1923,50,1920,1031,1030,1028,1026,67,1023,65,1020,62,1041,1039,1036,1033,69,1046,1044,1944,1943,1941,11,9,1868,7,1865,1862,1859,20,1878,16,1875,13,1872,970,968,966,963,29,960,26,23,983,981,978,975,33,971,31,990,988,985,1906,1904,1902,993,351,2145,1383,331,330,328,326,2137,323,2135,339,1372,1370,294,293,291,289,2122,286,2120,283,2117,309,303,317,1348,1346,1344,245,244,242,2090,239,2088,236,2085,2082,260,2099,249,270,1307,1305,1303,1300,1314,189,2038,186,2036,183,2033,2030,2026,206,198,2047,194,216,1247,1245,1243,1240,227,1237,1255,2310,2302,2300,2286,2284,2281,565,563,561,558,575,1589,2261,2259,2256,2253,1542,521,519,517,514,2270,511,533,1569,1567,2223,2221,2218,2215,1483,2211,1480,459,456,453,2232,449,474,491,1527,1525,1522,2475,2467,2465,2451,2449,2446,801,800,2426,2424,2421,2418,1723,2435,780,778,775,2387,2385,2382,2379,1695,2375,1693,2396,735,733,730,727,749,1718,2616,2615,2604,2603,2601,2584,2583,2581,2579,1800,2591,2550,2549,2547,2545,1792,2542,1790,2558,929,2719,1841,2710,2708,1833,1831,2690,2688,2686,1815,1809,1808,1774,1756,1754,1737,1736,1734,1739,1816,1711,1676,1674,633,629,1638,1636,1633,1641,598,1605,1604,1602,1600,605,1609,1607,2327,887,853,1775,822,820,1757,1755,1584,524,1560,1558,468,464,1514,1511,1508,1519,408,404,400,1452,1447,1444,417,1458,1455,2208,364,361,358,2154,1401,1400,1398,1396,374,1393,371,1408,1406,1403,1413,2173,2172,772,726,723,1712,672,669,666,682,1678,1675,625,623,621,618,2331,636,632,1639,1637,1635,920,918,884,880,889,849,848,847,846,2497,855,852,1776,2641,2742,2787,1380,334,1367,1365,301,297,1340,1338,1335,1343,255,251,247,1296,1291,1288,265,1302,1299,2113,204,196,192,2042,1232,1230,1224,214,1220,210,1242,1239,1235,1250,2077,2075,151,148,1993,144,1990,1163,1162,1160,1158,1155,161,1152,157,1173,1171,1168,1165,168,1181,1178,2021,2020,2018,2023,585,560,557,1585,516,509,1562,1559,458,447,2227,472,1516,1513,1510,398,396,393,390,2181,386,2178,407,1453,1451,1449,1446,420,1460,2209,769,764,720,712,2391,729,1713,664,663,661,659,2352,656,2349,671,1679,1677,2553,922,919,2519,2516,885,883,881,2685,2661,2659,2767,2756,2755,140,1137,1136,130,127,1125,1124,1122,1127,109,106,102,1103,1102,1100,1098,116,1107,1105,1980,80,76,73,1947,1068,1067,1065,1063,90,1060,87,1075,1073,1070,1080,1966,1965,46,43,40,1912,36,1909,1019,1018,1016,1014,58,1011,55,1008,51,1029,1027,1024,1021,63,1037,1034,1940,1939,1937,1942,8,1866,4,1863,1,1860,956,954,952,949,946,17,14,969,967,964,961,27,957,24,979,976,972,1901,1900,1898,1896,986,1905,1903,350,349,1381,329,327,324,1368,1366,292,290,287,284,2118,304,1341,1339,1337,1345,243,240,237,2086,233,2083,254,1297,1295,1293,1290,1304,2114,190,187,184,2034,180,2031,177,2027,199,1233,1231,1229,1226,217,1223,1241,2078,2076,584,555,554,552,550,2282,562,1586,507,506,504,502,2257,499,2254,515,1563,1561,445,443,441,2219,438,2216,435,2212,460,454,475,1517,1515,1512,2447,798,797,2422,2419,770,768,766,2383,2380,2376,721,719,717,714,731,1714,2602,2582,2580,2548,2546,2543,923,921,2717,2706,2705,2683,2682,2680,1771,1752,1750,1733,1732,1731,1735,1814,1707,1670,1668,1631,1629,1626,1634,1599,1598,1596,1594,1603,1601,2326,1772,1753,1751,1581,1554,1552,1504,1501,1498,1509,1442,1437,1434,401,1448,1445,2206,1392,1391,1389,1387,1384,359,1399,1397,1394,1404,2171,2170,1708,1672,1669,619,1632,1630,1628,1773,1378,1363,1361,1333,1328,1336,1286,1281,1278,248,1292,1289,2111,1218,1216,1210,197,1206,193,1228,1225,1221,1236,2073,2071,1151,1150,1148,1146,152,1143,149,1140,145,1161,1159,1156,1153,158,1169,1166,2017,2016,2014,2019,1582,510,1556,1553,452,448,1506,1500,394,391,387,1443,1441,1439,1436,1450,2207,765,716,713,1709,662,660,657,1673,1671,916,914,879,878,877,882,1135,1134,1121,1120,1118,1123,1097,1096,1094,1092,103,1101,1099,1979,1059,1058,1056,1054,77,1051,74,1066,1064,1061,1071,1964,1963,1007,1006,1004,1002,999,41,996,37,1017,1015,1012,1009,52,1025,1022,1936,1935,1933,1938,942,940,938,935,932,5,2,955,953,950,947,18,943,15,965,962,958,1895,1894,1892,1890,973,1899,1897,1379,325,1364,1362,288,285,1334,1332,1330,241,238,234,1287,1285,1283,1280,1294,2112,188,185,181,178,2028,1219,1217,1215,1212,200,1209,1227,2074,2072,583,553,551,1583,505,503,500,513,1557,1555,444,442,439,436,2213,455,451,1507,1505,1502,796,763,762,760,767,711,710,708,706,2377,718,715,1710,2544,917,915,2681,1627,1597,1595,2325,1769,1749,1747,1499,1438,1435,2204,1390,1388,1385,1395,2169,2167,1704,1665,1662,1625,1623,1620,1770,1329,1282,1279,2109,1214,1207,1222,2068,2065,1149,1147,1144,1141,146,1157,1154,2013,2011,2008,2015,1579,1549,1546,1495,1487,1433,1431,1428,1425,388,1440,2205,1705,658,1667,1664,1119,1095,1093,1978,1057,1055,1052,1062,1962,1960,1005,1003,1e3,997,38,1013,1010,1932,1930,1927,1934,941,939,936,933,6,930,3,951,948,944,1889,1887,1884,1881,959,1893,1891,35,1377,1360,1358,1327,1325,1322,1331,1277,1275,1272,1269,235,1284,2110,1205,1204,1201,1198,182,1195,179,1213,2070,2067,1580,501,1551,1548,440,437,1497,1494,1490,1503,761,709,707,1706,913,912,2198,1386,2164,2161,1621,1766,2103,1208,2058,2054,1145,1142,2005,2002,1999,2009,1488,1429,1426,2200,1698,1659,1656,1975,1053,1957,1954,1001,998,1924,1921,1918,1928,937,934,931,1879,1876,1873,1870,945,1885,1882,1323,1273,1270,2105,1202,1199,1196,1211,2061,2057,1576,1543,1540,1484,1481,1478,1491,1700]);class qi{constructor(t,s){this.bits=t,this.points=s}getBits(){return this.bits}getPoints(){return this.points}}class yt{static detectMultiple(t,s,r){let a=t.getBlackMatrix(),i=yt.detect(r,a);return i.length||(a=a.clone(),a.rotate180(),i=yt.detect(r,a)),new qi(a,i)}static detect(t,s){const r=new Array;let a=0,i=0,o=!1;for(;a<s.getHeight();){const d=yt.findVertices(s,a,i);if(d[0]==null&&d[3]==null){if(!o)break;o=!1,i=0;for(const h of r)h[1]!=null&&(a=Math.trunc(Math.max(a,h[1].getY()))),h[3]!=null&&(a=Math.max(a,Math.trunc(h[3].getY())));a+=yt.ROW_STEP;continue}if(o=!0,r.push(d),!t)break;d[2]!=null?(i=Math.trunc(d[2].getX()),a=Math.trunc(d[2].getY())):(i=Math.trunc(d[4].getX()),a=Math.trunc(d[4].getY()))}return r}static findVertices(t,s,r){const a=t.getHeight(),i=t.getWidth(),o=new Array(8);return yt.copyToResult(o,yt.findRowsWithPattern(t,a,i,s,r,yt.START_PATTERN),yt.INDEXES_START_PATTERN),o[4]!=null&&(r=Math.trunc(o[4].getX()),s=Math.trunc(o[4].getY())),yt.copyToResult(o,yt.findRowsWithPattern(t,a,i,s,r,yt.STOP_PATTERN),yt.INDEXES_STOP_PATTERN),o}static copyToResult(t,s,r){for(let a=0;a<r.length;a++)t[r[a]]=s[a]}static findRowsWithPattern(t,s,r,a,i,o){const d=new Array(4);let h=!1;const m=new Int32Array(o.length);for(;a<s;a+=yt.ROW_STEP){let I=yt.findGuardPattern(t,i,a,r,!1,o,m);if(I!=null){for(;a>0;){const z=yt.findGuardPattern(t,i,--a,r,!1,o,m);if(z!=null)I=z;else{a++;break}}d[0]=new qe(I[0],a),d[1]=new qe(I[1],a),h=!0;break}}let y=a+1;if(h){let I=0,z=Int32Array.from([Math.trunc(d[0].getX()),Math.trunc(d[1].getX())]);for(;y<s;y++){const Y=yt.findGuardPattern(t,z[0],y,r,!1,o,m);if(Y!=null&&Math.abs(z[0]-Y[0])<yt.MAX_PATTERN_DRIFT&&Math.abs(z[1]-Y[1])<yt.MAX_PATTERN_DRIFT)z=Y,I=0;else{if(I>yt.SKIPPED_ROW_COUNT_MAX)break;I++}}y-=I+1,d[2]=new qe(z[0],y),d[3]=new qe(z[1],y)}return y-a<yt.BARCODE_MIN_HEIGHT&&T.fill(d,null),d}static findGuardPattern(t,s,r,a,i,o,d){T.fillWithin(d,0,d.length,0);let h=s,m=0;for(;t.get(h,r)&&h>0&&m++<yt.MAX_PIXEL_DRIFT;)h--;let y=h,I=0,z=o.length;for(let Y=i;y<a;y++)if(t.get(y,r)!==Y)d[I]++;else{if(I===z-1){if(yt.patternMatchVariance(d,o,yt.MAX_INDIVIDUAL_VARIANCE)<yt.MAX_AVG_VARIANCE)return new Int32Array([h,y]);h+=d[0]+d[1],R.arraycopy(d,2,d,0,I-1),d[I-1]=0,d[I]=0,I--}else I++;d[I]=1,Y=!Y}return I===z-1&&yt.patternMatchVariance(d,o,yt.MAX_INDIVIDUAL_VARIANCE)<yt.MAX_AVG_VARIANCE?new Int32Array([h,y-1]):null}static patternMatchVariance(t,s,r){let a=t.length,i=0,o=0;for(let m=0;m<a;m++)i+=t[m],o+=s[m];if(i<o)return 1/0;let d=i/o;r*=d;let h=0;for(let m=0;m<a;m++){let y=t[m],I=s[m]*d,z=y>I?y-I:I-y;if(z>r)return 1/0;h+=z}return h/i}}yt.INDEXES_START_PATTERN=Int32Array.from([0,4,1,5]),yt.INDEXES_STOP_PATTERN=Int32Array.from([6,2,7,3]),yt.MAX_AVG_VARIANCE=.42,yt.MAX_INDIVIDUAL_VARIANCE=.8,yt.START_PATTERN=Int32Array.from([8,1,1,1,1,1,1,3]),yt.STOP_PATTERN=Int32Array.from([7,1,1,3,1,1,1,2,1]),yt.MAX_PIXEL_DRIFT=3,yt.MAX_PATTERN_DRIFT=5,yt.SKIPPED_ROW_COUNT_MAX=25,yt.ROW_STEP=5,yt.BARCODE_MIN_HEIGHT=10;class rs{constructor(t,s){if(s.length===0)throw new p;this.field=t;let r=s.length;if(r>1&&s[0]===0){let a=1;for(;a<r&&s[a]===0;)a++;a===r?this.coefficients=new Int32Array([0]):(this.coefficients=new Int32Array(r-a),R.arraycopy(s,a,this.coefficients,0,this.coefficients.length))}else this.coefficients=s}getCoefficients(){return this.coefficients}getDegree(){return this.coefficients.length-1}isZero(){return this.coefficients[0]===0}getCoefficient(t){return this.coefficients[this.coefficients.length-1-t]}evaluateAt(t){if(t===0)return this.getCoefficient(0);if(t===1){let a=0;for(let i of this.coefficients)a=this.field.add(a,i);return a}let s=this.coefficients[0],r=this.coefficients.length;for(let a=1;a<r;a++)s=this.field.add(this.field.multiply(t,s),this.coefficients[a]);return s}add(t){if(!this.field.equals(t.field))throw new p("ModulusPolys do not have same ModulusGF field");if(this.isZero())return t;if(t.isZero())return this;let s=this.coefficients,r=t.coefficients;if(s.length>r.length){let o=s;s=r,r=o}let a=new Int32Array(r.length),i=r.length-s.length;R.arraycopy(r,0,a,0,i);for(let o=i;o<r.length;o++)a[o]=this.field.add(s[o-i],r[o]);return new rs(this.field,a)}subtract(t){if(!this.field.equals(t.field))throw new p("ModulusPolys do not have same ModulusGF field");return t.isZero()?this:this.add(t.negative())}multiply(t){return t instanceof rs?this.multiplyOther(t):this.multiplyScalar(t)}multiplyOther(t){if(!this.field.equals(t.field))throw new p("ModulusPolys do not have same ModulusGF field");if(this.isZero()||t.isZero())return new rs(this.field,new Int32Array([0]));let s=this.coefficients,r=s.length,a=t.coefficients,i=a.length,o=new Int32Array(r+i-1);for(let d=0;d<r;d++){let h=s[d];for(let m=0;m<i;m++)o[d+m]=this.field.add(o[d+m],this.field.multiply(h,a[m]))}return new rs(this.field,o)}negative(){let t=this.coefficients.length,s=new Int32Array(t);for(let r=0;r<t;r++)s[r]=this.field.subtract(0,this.coefficients[r]);return new rs(this.field,s)}multiplyScalar(t){if(t===0)return new rs(this.field,new Int32Array([0]));if(t===1)return this;let s=this.coefficients.length,r=new Int32Array(s);for(let a=0;a<s;a++)r[a]=this.field.multiply(this.coefficients[a],t);return new rs(this.field,r)}multiplyByMonomial(t,s){if(t<0)throw new p;if(s===0)return new rs(this.field,new Int32Array([0]));let r=this.coefficients.length,a=new Int32Array(r+t);for(let i=0;i<r;i++)a[i]=this.field.multiply(this.coefficients[i],s);return new rs(this.field,a)}toString(){let t=new se;for(let s=this.getDegree();s>=0;s--){let r=this.getCoefficient(s);r!==0&&(r<0?(t.append(" - "),r=-r):t.length()>0&&t.append(" + "),(s===0||r!==1)&&t.append(r),s!==0&&(s===1?t.append("x"):(t.append("x^"),t.append(s))))}return t.toString()}}class Gi{add(t,s){return(t+s)%this.modulus}subtract(t,s){return(this.modulus+t-s)%this.modulus}exp(t){return this.expTable[t]}log(t){if(t===0)throw new p;return this.logTable[t]}inverse(t){if(t===0)throw new je;return this.expTable[this.modulus-this.logTable[t]-1]}multiply(t,s){return t===0||s===0?0:this.expTable[(this.logTable[t]+this.logTable[s])%(this.modulus-1)]}getSize(){return this.modulus}equals(t){return t===this}}class Da extends Gi{constructor(t,s){super(),this.modulus=t,this.expTable=new Int32Array(t),this.logTable=new Int32Array(t);let r=1;for(let a=0;a<t;a++)this.expTable[a]=r,r=r*s%t;for(let a=0;a<t-1;a++)this.logTable[this.expTable[a]]=a;this.zero=new rs(this,new Int32Array([0])),this.one=new rs(this,new Int32Array([1]))}getZero(){return this.zero}getOne(){return this.one}buildMonomial(t,s){if(t<0)throw new p;if(s===0)return this.zero;let r=new Int32Array(t+1);return r[0]=s,new rs(this,r)}}Da.PDF417_GF=new Da(ut.NUMBER_OF_CODEWORDS,3);class un{constructor(){this.field=Da.PDF417_GF}decode(t,s,r){let a=new rs(this.field,t),i=new Int32Array(s),o=!1;for(let ie=s;ie>0;ie--){let ce=a.evaluateAt(this.field.exp(ie));i[s-ie]=ce,ce!==0&&(o=!0)}if(!o)return 0;let d=this.field.getOne();if(r!=null)for(const ie of r){let ce=this.field.exp(t.length-1-ie),Ne=new rs(this.field,new Int32Array([this.field.subtract(0,ce),1]));d=d.multiply(Ne)}let h=new rs(this.field,i),m=this.runEuclideanAlgorithm(this.field.buildMonomial(s,1),h,s),y=m[0],I=m[1],z=this.findErrorLocations(y),Y=this.findErrorMagnitudes(I,y,z);for(let ie=0;ie<z.length;ie++){let ce=t.length-1-this.field.log(z[ie]);if(ce<0)throw P.getChecksumInstance();t[ce]=this.field.subtract(t[ce],Y[ie])}return z.length}runEuclideanAlgorithm(t,s,r){if(t.getDegree()<s.getDegree()){let z=t;t=s,s=z}let a=t,i=s,o=this.field.getZero(),d=this.field.getOne();for(;i.getDegree()>=Math.round(r/2);){let z=a,Y=o;if(a=i,o=d,a.isZero())throw P.getChecksumInstance();i=z;let ie=this.field.getZero(),ce=a.getCoefficient(a.getDegree()),Ne=this.field.inverse(ce);for(;i.getDegree()>=a.getDegree()&&!i.isZero();){let ze=i.getDegree()-a.getDegree(),Ge=this.field.multiply(i.getCoefficient(i.getDegree()),Ne);ie=ie.add(this.field.buildMonomial(ze,Ge)),i=i.subtract(a.multiplyByMonomial(ze,Ge))}d=ie.multiply(o).subtract(Y).negative()}let h=d.getCoefficient(0);if(h===0)throw P.getChecksumInstance();let m=this.field.inverse(h),y=d.multiply(m),I=i.multiply(m);return[y,I]}findErrorLocations(t){let s=t.getDegree(),r=new Int32Array(s),a=0;for(let i=1;i<this.field.getSize()&&a<s;i++)t.evaluateAt(i)===0&&(r[a]=this.field.inverse(i),a++);if(a!==s)throw P.getChecksumInstance();return r}findErrorMagnitudes(t,s,r){let a=s.getDegree(),i=new Int32Array(a);for(let m=1;m<=a;m++)i[a-m]=this.field.multiply(m,s.getCoefficient(m));let o=new rs(this.field,i),d=r.length,h=new Int32Array(d);for(let m=0;m<d;m++){let y=this.field.inverse(r[m]),I=this.field.subtract(0,t.evaluateAt(y)),z=this.field.inverse(o.evaluateAt(y));h[m]=this.field.multiply(I,z)}return h}}class hr{constructor(t,s,r,a,i){t instanceof hr?this.constructor_2(t):this.constructor_1(t,s,r,a,i)}constructor_1(t,s,r,a,i){const o=s==null||r==null,d=a==null||i==null;if(o&&d)throw new G;o?(s=new qe(0,a.getY()),r=new qe(0,i.getY())):d&&(a=new qe(t.getWidth()-1,s.getY()),i=new qe(t.getWidth()-1,r.getY())),this.image=t,this.topLeft=s,this.bottomLeft=r,this.topRight=a,this.bottomRight=i,this.minX=Math.trunc(Math.min(s.getX(),r.getX())),this.maxX=Math.trunc(Math.max(a.getX(),i.getX())),this.minY=Math.trunc(Math.min(s.getY(),a.getY())),this.maxY=Math.trunc(Math.max(r.getY(),i.getY()))}constructor_2(t){this.image=t.image,this.topLeft=t.getTopLeft(),this.bottomLeft=t.getBottomLeft(),this.topRight=t.getTopRight(),this.bottomRight=t.getBottomRight(),this.minX=t.getMinX(),this.maxX=t.getMaxX(),this.minY=t.getMinY(),this.maxY=t.getMaxY()}static merge(t,s){return t==null?s:s==null?t:new hr(t.image,t.topLeft,t.bottomLeft,s.topRight,s.bottomRight)}addMissingRows(t,s,r){let a=this.topLeft,i=this.bottomLeft,o=this.topRight,d=this.bottomRight;if(t>0){let h=r?this.topLeft:this.topRight,m=Math.trunc(h.getY()-t);m<0&&(m=0);let y=new qe(h.getX(),m);r?a=y:o=y}if(s>0){let h=r?this.bottomLeft:this.bottomRight,m=Math.trunc(h.getY()+s);m>=this.image.getHeight()&&(m=this.image.getHeight()-1);let y=new qe(h.getX(),m);r?i=y:d=y}return new hr(this.image,a,i,o,d)}getMinX(){return this.minX}getMaxX(){return this.maxX}getMinY(){return this.minY}getMaxY(){return this.maxY}getTopLeft(){return this.topLeft}getTopRight(){return this.topRight}getBottomLeft(){return this.bottomLeft}getBottomRight(){return this.bottomRight}}class Wi{constructor(t,s,r,a){this.columnCount=t,this.errorCorrectionLevel=a,this.rowCountUpperPart=s,this.rowCountLowerPart=r,this.rowCount=s+r}getColumnCount(){return this.columnCount}getErrorCorrectionLevel(){return this.errorCorrectionLevel}getRowCount(){return this.rowCount}getRowCountUpperPart(){return this.rowCountUpperPart}getRowCountLowerPart(){return this.rowCountLowerPart}}class Or{constructor(){this.buffer=""}static form(t,s){let r=-1;function a(o,d,h,m,y,I){if(o==="%%")return"%";if(s[++r]===void 0)return;o=m?parseInt(m.substr(1)):void 0;let z=y?parseInt(y.substr(1)):void 0,Y;switch(I){case"s":Y=s[r];break;case"c":Y=s[r][0];break;case"f":Y=parseFloat(s[r]).toFixed(o);break;case"p":Y=parseFloat(s[r]).toPrecision(o);break;case"e":Y=parseFloat(s[r]).toExponential(o);break;case"x":Y=parseInt(s[r]).toString(z||16);break;case"d":Y=parseFloat(parseInt(s[r],z||10).toPrecision(o)).toFixed(0);break}Y=typeof Y=="object"?JSON.stringify(Y):(+Y).toString(z);let ie=parseInt(h),ce=h&&h[0]+""=="0"?"0":" ";for(;Y.length<ie;)Y=d!==void 0?Y+ce:ce+Y;return Y}let i=/%(-)?(0?[0-9]+)?([.][0-9]+)?([#][0-9]+)?([scfpexd%])/g;return t.replace(i,a)}format(t,...s){this.buffer+=Or.form(t,s)}toString(){return this.buffer}}class Rr{constructor(t){this.boundingBox=new hr(t),this.codewords=new Array(t.getMaxY()-t.getMinY()+1)}getCodewordNearby(t){let s=this.getCodeword(t);if(s!=null)return s;for(let r=1;r<Rr.MAX_NEARBY_DISTANCE;r++){let a=this.imageRowToCodewordIndex(t)-r;if(a>=0&&(s=this.codewords[a],s!=null)||(a=this.imageRowToCodewordIndex(t)+r,a<this.codewords.length&&(s=this.codewords[a],s!=null)))return s}return null}imageRowToCodewordIndex(t){return t-this.boundingBox.getMinY()}setCodeword(t,s){this.codewords[this.imageRowToCodewordIndex(t)]=s}getCodeword(t){return this.codewords[this.imageRowToCodewordIndex(t)]}getBoundingBox(){return this.boundingBox}getCodewords(){return this.codewords}toString(){const t=new Or;let s=0;for(const r of this.codewords){if(r==null){t.format("%3d:    |   %n",s++);continue}t.format("%3d: %3d|%3d%n",s++,r.getRowNumber(),r.getValue())}return t.toString()}}Rr.MAX_NEARBY_DISTANCE=5;class Lr{constructor(){this.values=new Map}setValue(t){t=Math.trunc(t);let s=this.values.get(t);s==null&&(s=0),s++,this.values.set(t,s)}getValue(){let t=-1,s=new Array;for(const[r,a]of this.values.entries()){const i={getKey:()=>r,getValue:()=>a};i.getValue()>t?(t=i.getValue(),s=[],s.push(i.getKey())):i.getValue()===t&&s.push(i.getKey())}return ut.toIntArray(s)}getConfidence(t){return this.values.get(t)}}class hn extends Rr{constructor(t,s){super(t),this._isLeft=s}setRowNumbers(){for(let t of this.getCodewords())t!=null&&t.setRowNumberAsRowIndicatorColumn()}adjustCompleteIndicatorColumnRowNumbers(t){let s=this.getCodewords();this.setRowNumbers(),this.removeIncorrectCodewords(s,t);let r=this.getBoundingBox(),a=this._isLeft?r.getTopLeft():r.getTopRight(),i=this._isLeft?r.getBottomLeft():r.getBottomRight(),o=this.imageRowToCodewordIndex(Math.trunc(a.getY())),d=this.imageRowToCodewordIndex(Math.trunc(i.getY())),h=-1,m=1,y=0;for(let I=o;I<d;I++){if(s[I]==null)continue;let z=s[I],Y=z.getRowNumber()-h;if(Y===0)y++;else if(Y===1)m=Math.max(m,y),y=1,h=z.getRowNumber();else if(Y<0||z.getRowNumber()>=t.getRowCount()||Y>I)s[I]=null;else{let ie;m>2?ie=(m-2)*Y:ie=Y;let ce=ie>=I;for(let Ne=1;Ne<=ie&&!ce;Ne++)ce=s[I-Ne]!=null;ce?s[I]=null:(h=z.getRowNumber(),y=1)}}}getRowHeights(){let t=this.getBarcodeMetadata();if(t==null)return null;this.adjustIncompleteIndicatorColumnRowNumbers(t);let s=new Int32Array(t.getRowCount());for(let r of this.getCodewords())if(r!=null){let a=r.getRowNumber();if(a>=s.length)continue;s[a]++}return s}adjustIncompleteIndicatorColumnRowNumbers(t){let s=this.getBoundingBox(),r=this._isLeft?s.getTopLeft():s.getTopRight(),a=this._isLeft?s.getBottomLeft():s.getBottomRight(),i=this.imageRowToCodewordIndex(Math.trunc(r.getY())),o=this.imageRowToCodewordIndex(Math.trunc(a.getY())),d=this.getCodewords(),h=-1;for(let m=i;m<o;m++){if(d[m]==null)continue;let y=d[m];y.setRowNumberAsRowIndicatorColumn();let I=y.getRowNumber()-h;I===0||(I===1?h=y.getRowNumber():y.getRowNumber()>=t.getRowCount()?d[m]=null:h=y.getRowNumber())}}getBarcodeMetadata(){let t=this.getCodewords(),s=new Lr,r=new Lr,a=new Lr,i=new Lr;for(let d of t){if(d==null)continue;d.setRowNumberAsRowIndicatorColumn();let h=d.getValue()%30,m=d.getRowNumber();switch(this._isLeft||(m+=2),m%3){case 0:r.setValue(h*3+1);break;case 1:i.setValue(h/3),a.setValue(h%3);break;case 2:s.setValue(h+1);break}}if(s.getValue().length===0||r.getValue().length===0||a.getValue().length===0||i.getValue().length===0||s.getValue()[0]<1||r.getValue()[0]+a.getValue()[0]<ut.MIN_ROWS_IN_BARCODE||r.getValue()[0]+a.getValue()[0]>ut.MAX_ROWS_IN_BARCODE)return null;let o=new Wi(s.getValue()[0],r.getValue()[0],a.getValue()[0],i.getValue()[0]);return this.removeIncorrectCodewords(t,o),o}removeIncorrectCodewords(t,s){for(let r=0;r<t.length;r++){let a=t[r];if(t[r]==null)continue;let i=a.getValue()%30,o=a.getRowNumber();if(o>s.getRowCount()){t[r]=null;continue}switch(this._isLeft||(o+=2),o%3){case 0:i*3+1!==s.getRowCountUpperPart()&&(t[r]=null);break;case 1:(Math.trunc(i/3)!==s.getErrorCorrectionLevel()||i%3!==s.getRowCountLowerPart())&&(t[r]=null);break;case 2:i+1!==s.getColumnCount()&&(t[r]=null);break}}}isLeft(){return this._isLeft}toString(){return"IsLeft: "+this._isLeft+`
`+super.toString()}}class Pr{constructor(t,s){this.ADJUST_ROW_NUMBER_SKIP=2,this.barcodeMetadata=t,this.barcodeColumnCount=t.getColumnCount(),this.boundingBox=s,this.detectionResultColumns=new Array(this.barcodeColumnCount+2)}getDetectionResultColumns(){this.adjustIndicatorColumnRowNumbers(this.detectionResultColumns[0]),this.adjustIndicatorColumnRowNumbers(this.detectionResultColumns[this.barcodeColumnCount+1]);let t=ut.MAX_CODEWORDS_IN_BARCODE,s;do s=t,t=this.adjustRowNumbersAndGetCount();while(t>0&&t<s);return this.detectionResultColumns}adjustIndicatorColumnRowNumbers(t){t!=null&&t.adjustCompleteIndicatorColumnRowNumbers(this.barcodeMetadata)}adjustRowNumbersAndGetCount(){let t=this.adjustRowNumbersByRow();if(t===0)return 0;for(let s=1;s<this.barcodeColumnCount+1;s++){let r=this.detectionResultColumns[s].getCodewords();for(let a=0;a<r.length;a++)r[a]!=null&&(r[a].hasValidRowNumber()||this.adjustRowNumbers(s,a,r))}return t}adjustRowNumbersByRow(){return this.adjustRowNumbersFromBothRI(),this.adjustRowNumbersFromLRI()+this.adjustRowNumbersFromRRI()}adjustRowNumbersFromBothRI(){if(this.detectionResultColumns[0]==null||this.detectionResultColumns[this.barcodeColumnCount+1]==null)return;let t=this.detectionResultColumns[0].getCodewords(),s=this.detectionResultColumns[this.barcodeColumnCount+1].getCodewords();for(let r=0;r<t.length;r++)if(t[r]!=null&&s[r]!=null&&t[r].getRowNumber()===s[r].getRowNumber())for(let a=1;a<=this.barcodeColumnCount;a++){let i=this.detectionResultColumns[a].getCodewords()[r];i!=null&&(i.setRowNumber(t[r].getRowNumber()),i.hasValidRowNumber()||(this.detectionResultColumns[a].getCodewords()[r]=null))}}adjustRowNumbersFromRRI(){if(this.detectionResultColumns[this.barcodeColumnCount+1]==null)return 0;let t=0,s=this.detectionResultColumns[this.barcodeColumnCount+1].getCodewords();for(let r=0;r<s.length;r++){if(s[r]==null)continue;let a=s[r].getRowNumber(),i=0;for(let o=this.barcodeColumnCount+1;o>0&&i<this.ADJUST_ROW_NUMBER_SKIP;o--){let d=this.detectionResultColumns[o].getCodewords()[r];d!=null&&(i=Pr.adjustRowNumberIfValid(a,i,d),d.hasValidRowNumber()||t++)}}return t}adjustRowNumbersFromLRI(){if(this.detectionResultColumns[0]==null)return 0;let t=0,s=this.detectionResultColumns[0].getCodewords();for(let r=0;r<s.length;r++){if(s[r]==null)continue;let a=s[r].getRowNumber(),i=0;for(let o=1;o<this.barcodeColumnCount+1&&i<this.ADJUST_ROW_NUMBER_SKIP;o++){let d=this.detectionResultColumns[o].getCodewords()[r];d!=null&&(i=Pr.adjustRowNumberIfValid(a,i,d),d.hasValidRowNumber()||t++)}}return t}static adjustRowNumberIfValid(t,s,r){return r==null||r.hasValidRowNumber()||(r.isValidRowNumber(t)?(r.setRowNumber(t),s=0):++s),s}adjustRowNumbers(t,s,r){if(!this.detectionResultColumns[t-1])return;let a=r[s],i=this.detectionResultColumns[t-1].getCodewords(),o=i;this.detectionResultColumns[t+1]!=null&&(o=this.detectionResultColumns[t+1].getCodewords());let d=new Array(14);d[2]=i[s],d[3]=o[s],s>0&&(d[0]=r[s-1],d[4]=i[s-1],d[5]=o[s-1]),s>1&&(d[8]=r[s-2],d[10]=i[s-2],d[11]=o[s-2]),s<r.length-1&&(d[1]=r[s+1],d[6]=i[s+1],d[7]=o[s+1]),s<r.length-2&&(d[9]=r[s+2],d[12]=i[s+2],d[13]=o[s+2]);for(let h of d)if(Pr.adjustRowNumber(a,h))return}static adjustRowNumber(t,s){return s==null?!1:s.hasValidRowNumber()&&s.getBucket()===t.getBucket()?(t.setRowNumber(s.getRowNumber()),!0):!1}getBarcodeColumnCount(){return this.barcodeColumnCount}getBarcodeRowCount(){return this.barcodeMetadata.getRowCount()}getBarcodeECLevel(){return this.barcodeMetadata.getErrorCorrectionLevel()}setBoundingBox(t){this.boundingBox=t}getBoundingBox(){return this.boundingBox}setDetectionResultColumn(t,s){this.detectionResultColumns[t]=s}getDetectionResultColumn(t){return this.detectionResultColumns[t]}toString(){let t=this.detectionResultColumns[0];t==null&&(t=this.detectionResultColumns[this.barcodeColumnCount+1]);let s=new Or;for(let r=0;r<t.getCodewords().length;r++){s.format("CW %3d:",r);for(let a=0;a<this.barcodeColumnCount+2;a++){if(this.detectionResultColumns[a]==null){s.format("    |   ");continue}let i=this.detectionResultColumns[a].getCodewords()[r];if(i==null){s.format("    |   ");continue}s.format(" %3d|%3d",i.getRowNumber(),i.getValue())}s.format("%n")}return s.toString()}}class Br{constructor(t,s,r,a){this.rowNumber=Br.BARCODE_ROW_UNKNOWN,this.startX=Math.trunc(t),this.endX=Math.trunc(s),this.bucket=Math.trunc(r),this.value=Math.trunc(a)}hasValidRowNumber(){return this.isValidRowNumber(this.rowNumber)}isValidRowNumber(t){return t!==Br.BARCODE_ROW_UNKNOWN&&this.bucket===t%3*3}setRowNumberAsRowIndicatorColumn(){this.rowNumber=Math.trunc(Math.trunc(this.value/30)*3+Math.trunc(this.bucket/3))}getWidth(){return this.endX-this.startX}getStartX(){return this.startX}getEndX(){return this.endX}getBucket(){return this.bucket}getValue(){return this.value}getRowNumber(){return this.rowNumber}setRowNumber(t){this.rowNumber=t}toString(){return this.rowNumber+"|"+this.value}}Br.BARCODE_ROW_UNKNOWN=-1;class gs{static initialize(){for(let t=0;t<ut.SYMBOL_TABLE.length;t++){let s=ut.SYMBOL_TABLE[t],r=s&1;for(let a=0;a<ut.BARS_IN_MODULE;a++){let i=0;for(;(s&1)===r;)i+=1,s>>=1;r=s&1,gs.RATIOS_TABLE[t]||(gs.RATIOS_TABLE[t]=new Array(ut.BARS_IN_MODULE)),gs.RATIOS_TABLE[t][ut.BARS_IN_MODULE-a-1]=Math.fround(i/ut.MODULES_IN_CODEWORD)}}this.bSymbolTableReady=!0}static getDecodedValue(t){let s=gs.getDecodedCodewordValue(gs.sampleBitCounts(t));return s!==-1?s:gs.getClosestDecodedValue(t)}static sampleBitCounts(t){let s=We.sum(t),r=new Int32Array(ut.BARS_IN_MODULE),a=0,i=0;for(let o=0;o<ut.MODULES_IN_CODEWORD;o++){let d=s/(2*ut.MODULES_IN_CODEWORD)+o*s/ut.MODULES_IN_CODEWORD;i+t[a]<=d&&(i+=t[a],a++),r[a]++}return r}static getDecodedCodewordValue(t){let s=gs.getBitValue(t);return ut.getCodeword(s)===-1?-1:s}static getBitValue(t){let s=0;for(let r=0;r<t.length;r++)for(let a=0;a<t[r];a++)s=s<<1|(r%2===0?1:0);return Math.trunc(s)}static getClosestDecodedValue(t){let s=We.sum(t),r=new Array(ut.BARS_IN_MODULE);if(s>1)for(let o=0;o<r.length;o++)r[o]=Math.fround(t[o]/s);let a=gt.MAX_VALUE,i=-1;this.bSymbolTableReady||gs.initialize();for(let o=0;o<gs.RATIOS_TABLE.length;o++){let d=0,h=gs.RATIOS_TABLE[o];for(let m=0;m<ut.BARS_IN_MODULE;m++){let y=Math.fround(h[m]-r[m]);if(d+=Math.fround(y*y),d>=a)break}d<a&&(a=d,i=ut.SYMBOL_TABLE[o])}return i}}gs.bSymbolTableReady=!1,gs.RATIOS_TABLE=new Array(ut.SYMBOL_TABLE.length).map(A=>new Array(ut.BARS_IN_MODULE));class xn{constructor(){this.segmentCount=-1,this.fileSize=-1,this.timestamp=-1,this.checksum=-1}getSegmentIndex(){return this.segmentIndex}setSegmentIndex(t){this.segmentIndex=t}getFileId(){return this.fileId}setFileId(t){this.fileId=t}getOptionalData(){return this.optionalData}setOptionalData(t){this.optionalData=t}isLastSegment(){return this.lastSegment}setLastSegment(t){this.lastSegment=t}getSegmentCount(){return this.segmentCount}setSegmentCount(t){this.segmentCount=t}getSender(){return this.sender||null}setSender(t){this.sender=t}getAddressee(){return this.addressee||null}setAddressee(t){this.addressee=t}getFileName(){return this.fileName}setFileName(t){this.fileName=t}getFileSize(){return this.fileSize}setFileSize(t){this.fileSize=t}getChecksum(){return this.checksum}setChecksum(t){this.checksum=t}getTimestamp(){return this.timestamp}setTimestamp(t){this.timestamp=t}}class mn{static parseLong(t,s=void 0){return parseInt(t,s)}}class fn extends g{}fn.kind="NullPointerException";class Yi{writeBytes(t){this.writeBytesOffset(t,0,t.length)}writeBytesOffset(t,s,r){if(t==null)throw new fn;if(s<0||s>t.length||r<0||s+r>t.length||s+r<0)throw new j;if(r===0)return;for(let a=0;a<r;a++)this.write(t[s+a])}flush(){}close(){}}class $i extends g{}class Xi extends Yi{constructor(t=32){if(super(),this.count=0,t<0)throw new p("Negative initial size: "+t);this.buf=new Uint8Array(t)}ensureCapacity(t){t-this.buf.length>0&&this.grow(t)}grow(t){let r=this.buf.length<<1;if(r-t<0&&(r=t),r<0){if(t<0)throw new $i;r=F.MAX_VALUE}this.buf=T.copyOfUint8Array(this.buf,r)}write(t){this.ensureCapacity(this.count+1),this.buf[this.count]=t,this.count+=1}writeBytesOffset(t,s,r){if(s<0||s>t.length||r<0||s+r-t.length>0)throw new j;this.ensureCapacity(this.count+r),R.arraycopy(t,s,this.buf,this.count,r),this.count+=r}writeTo(t){t.writeBytesOffset(this.buf,0,this.count)}reset(){this.count=0}toByteArray(){return T.copyOfUint8Array(this.buf,this.count)}size(){return this.count}toString(t){return t?typeof t=="string"?this.toString_string(t):this.toString_number(t):this.toString_void()}toString_void(){return new String(this.buf).toString()}toString_string(t){return new String(this.buf).toString()}toString_number(t){return new String(this.buf).toString()}close(){}}var Mt;(function(A){A[A.ALPHA=0]="ALPHA",A[A.LOWER=1]="LOWER",A[A.MIXED=2]="MIXED",A[A.PUNCT=3]="PUNCT",A[A.ALPHA_SHIFT=4]="ALPHA_SHIFT",A[A.PUNCT_SHIFT=5]="PUNCT_SHIFT"})(Mt||(Mt={}));function gn(){if(typeof window<"u")return window.BigInt||null;if(typeof Vr<"u")return Vr.BigInt||null;if(typeof self<"u")return self.BigInt||null;throw new Error("Can't search globals for BigInt!")}let aa;function Js(A){if(typeof aa>"u"&&(aa=gn()),aa===null)throw new Error("BigInt is not supported!");return aa(A)}function Zi(){let A=[];A[0]=Js(1);let t=Js(900);A[1]=t;for(let s=2;s<16;s++)A[s]=A[s-1]*t;return A}class Me{static decode(t,s){let r=new se(""),a=C.ISO8859_1;r.enableDecoding(a);let i=1,o=t[i++],d=new xn;for(;i<t[0];){switch(o){case Me.TEXT_COMPACTION_MODE_LATCH:i=Me.textCompaction(t,i,r);break;case Me.BYTE_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH_6:i=Me.byteCompaction(o,t,a,i,r);break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:r.append(t[i++]);break;case Me.NUMERIC_COMPACTION_MODE_LATCH:i=Me.numericCompaction(t,i,r);break;case Me.ECI_CHARSET:C.getCharacterSetECIByValue(t[i++]);break;case Me.ECI_GENERAL_PURPOSE:i+=2;break;case Me.ECI_USER_DEFINED:i++;break;case Me.BEGIN_MACRO_PDF417_CONTROL_BLOCK:i=Me.decodeMacroBlock(t,i,d);break;case Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD:case Me.MACRO_PDF417_TERMINATOR:throw new _;default:i--,i=Me.textCompaction(t,i,r);break}if(i<t.length)o=t[i++];else throw _.getFormatInstance()}if(r.length()===0)throw _.getFormatInstance();let h=new ve(null,r.toString(),null,s);return h.setOther(d),h}static decodeMacroBlock(t,s,r){if(s+Me.NUMBER_OF_SEQUENCE_CODEWORDS>t[0])throw _.getFormatInstance();let a=new Int32Array(Me.NUMBER_OF_SEQUENCE_CODEWORDS);for(let d=0;d<Me.NUMBER_OF_SEQUENCE_CODEWORDS;d++,s++)a[d]=t[s];r.setSegmentIndex(F.parseInt(Me.decodeBase900toBase10(a,Me.NUMBER_OF_SEQUENCE_CODEWORDS)));let i=new se;s=Me.textCompaction(t,s,i),r.setFileId(i.toString());let o=-1;for(t[s]===Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD&&(o=s+1);s<t[0];)switch(t[s]){case Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD:switch(s++,t[s]){case Me.MACRO_PDF417_OPTIONAL_FIELD_FILE_NAME:let d=new se;s=Me.textCompaction(t,s+1,d),r.setFileName(d.toString());break;case Me.MACRO_PDF417_OPTIONAL_FIELD_SENDER:let h=new se;s=Me.textCompaction(t,s+1,h),r.setSender(h.toString());break;case Me.MACRO_PDF417_OPTIONAL_FIELD_ADDRESSEE:let m=new se;s=Me.textCompaction(t,s+1,m),r.setAddressee(m.toString());break;case Me.MACRO_PDF417_OPTIONAL_FIELD_SEGMENT_COUNT:let y=new se;s=Me.numericCompaction(t,s+1,y),r.setSegmentCount(F.parseInt(y.toString()));break;case Me.MACRO_PDF417_OPTIONAL_FIELD_TIME_STAMP:let I=new se;s=Me.numericCompaction(t,s+1,I),r.setTimestamp(mn.parseLong(I.toString()));break;case Me.MACRO_PDF417_OPTIONAL_FIELD_CHECKSUM:let z=new se;s=Me.numericCompaction(t,s+1,z),r.setChecksum(F.parseInt(z.toString()));break;case Me.MACRO_PDF417_OPTIONAL_FIELD_FILE_SIZE:let Y=new se;s=Me.numericCompaction(t,s+1,Y),r.setFileSize(mn.parseLong(Y.toString()));break;default:throw _.getFormatInstance()}break;case Me.MACRO_PDF417_TERMINATOR:s++,r.setLastSegment(!0);break;default:throw _.getFormatInstance()}if(o!==-1){let d=s-o;r.isLastSegment()&&d--,r.setOptionalData(T.copyOfRange(t,o,o+d))}return s}static textCompaction(t,s,r){let a=new Int32Array((t[0]-s)*2),i=new Int32Array((t[0]-s)*2),o=0,d=!1;for(;s<t[0]&&!d;){let h=t[s++];if(h<Me.TEXT_COMPACTION_MODE_LATCH)a[o]=h/30,a[o+1]=h%30,o+=2;else switch(h){case Me.TEXT_COMPACTION_MODE_LATCH:a[o++]=Me.TEXT_COMPACTION_MODE_LATCH;break;case Me.BYTE_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH_6:case Me.NUMERIC_COMPACTION_MODE_LATCH:case Me.BEGIN_MACRO_PDF417_CONTROL_BLOCK:case Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD:case Me.MACRO_PDF417_TERMINATOR:s--,d=!0;break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:a[o]=Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE,h=t[s++],i[o]=h,o++;break}}return Me.decodeTextCompaction(a,i,o,r),s}static decodeTextCompaction(t,s,r,a){let i=Mt.ALPHA,o=Mt.ALPHA,d=0;for(;d<r;){let h=t[d],m="";switch(i){case Mt.ALPHA:if(h<26)m=String.fromCharCode(65+h);else switch(h){case 26:m=" ";break;case Me.LL:i=Mt.LOWER;break;case Me.ML:i=Mt.MIXED;break;case Me.PS:o=i,i=Mt.PUNCT_SHIFT;break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:a.append(s[d]);break;case Me.TEXT_COMPACTION_MODE_LATCH:i=Mt.ALPHA;break}break;case Mt.LOWER:if(h<26)m=String.fromCharCode(97+h);else switch(h){case 26:m=" ";break;case Me.AS:o=i,i=Mt.ALPHA_SHIFT;break;case Me.ML:i=Mt.MIXED;break;case Me.PS:o=i,i=Mt.PUNCT_SHIFT;break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:a.append(s[d]);break;case Me.TEXT_COMPACTION_MODE_LATCH:i=Mt.ALPHA;break}break;case Mt.MIXED:if(h<Me.PL)m=Me.MIXED_CHARS[h];else switch(h){case Me.PL:i=Mt.PUNCT;break;case 26:m=" ";break;case Me.LL:i=Mt.LOWER;break;case Me.AL:i=Mt.ALPHA;break;case Me.PS:o=i,i=Mt.PUNCT_SHIFT;break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:a.append(s[d]);break;case Me.TEXT_COMPACTION_MODE_LATCH:i=Mt.ALPHA;break}break;case Mt.PUNCT:if(h<Me.PAL)m=Me.PUNCT_CHARS[h];else switch(h){case Me.PAL:i=Mt.ALPHA;break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:a.append(s[d]);break;case Me.TEXT_COMPACTION_MODE_LATCH:i=Mt.ALPHA;break}break;case Mt.ALPHA_SHIFT:if(i=o,h<26)m=String.fromCharCode(65+h);else switch(h){case 26:m=" ";break;case Me.TEXT_COMPACTION_MODE_LATCH:i=Mt.ALPHA;break}break;case Mt.PUNCT_SHIFT:if(i=o,h<Me.PAL)m=Me.PUNCT_CHARS[h];else switch(h){case Me.PAL:i=Mt.ALPHA;break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:a.append(s[d]);break;case Me.TEXT_COMPACTION_MODE_LATCH:i=Mt.ALPHA;break}break}m!==""&&a.append(m),d++}}static byteCompaction(t,s,r,a,i){let o=new Xi,d=0,h=0,m=!1;switch(t){case Me.BYTE_COMPACTION_MODE_LATCH:let y=new Int32Array(6),I=s[a++];for(;a<s[0]&&!m;)switch(y[d++]=I,h=900*h+I,I=s[a++],I){case Me.TEXT_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH:case Me.NUMERIC_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH_6:case Me.BEGIN_MACRO_PDF417_CONTROL_BLOCK:case Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD:case Me.MACRO_PDF417_TERMINATOR:a--,m=!0;break;default:if(d%5===0&&d>0){for(let z=0;z<6;++z)o.write(Number(Js(h)>>Js(8*(5-z))));h=0,d=0}break}a===s[0]&&I<Me.TEXT_COMPACTION_MODE_LATCH&&(y[d++]=I);for(let z=0;z<d;z++)o.write(y[z]);break;case Me.BYTE_COMPACTION_MODE_LATCH_6:for(;a<s[0]&&!m;){let z=s[a++];if(z<Me.TEXT_COMPACTION_MODE_LATCH)d++,h=900*h+z;else switch(z){case Me.TEXT_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH:case Me.NUMERIC_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH_6:case Me.BEGIN_MACRO_PDF417_CONTROL_BLOCK:case Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD:case Me.MACRO_PDF417_TERMINATOR:a--,m=!0;break}if(d%5===0&&d>0){for(let Y=0;Y<6;++Y)o.write(Number(Js(h)>>Js(8*(5-Y))));h=0,d=0}}break}return i.append(O.decode(o.toByteArray(),r)),a}static numericCompaction(t,s,r){let a=0,i=!1,o=new Int32Array(Me.MAX_NUMERIC_CODEWORDS);for(;s<t[0]&&!i;){let d=t[s++];if(s===t[0]&&(i=!0),d<Me.TEXT_COMPACTION_MODE_LATCH)o[a]=d,a++;else switch(d){case Me.TEXT_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH_6:case Me.BEGIN_MACRO_PDF417_CONTROL_BLOCK:case Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD:case Me.MACRO_PDF417_TERMINATOR:s--,i=!0;break}(a%Me.MAX_NUMERIC_CODEWORDS===0||d===Me.NUMERIC_COMPACTION_MODE_LATCH||i)&&a>0&&(r.append(Me.decodeBase900toBase10(o,a)),a=0)}return s}static decodeBase900toBase10(t,s){let r=Js(0);for(let i=0;i<s;i++)r+=Me.EXP900[s-i-1]*Js(t[i]);let a=r.toString();if(a.charAt(0)!=="1")throw new _;return a.substring(1)}}Me.TEXT_COMPACTION_MODE_LATCH=900,Me.BYTE_COMPACTION_MODE_LATCH=901,Me.NUMERIC_COMPACTION_MODE_LATCH=902,Me.BYTE_COMPACTION_MODE_LATCH_6=924,Me.ECI_USER_DEFINED=925,Me.ECI_GENERAL_PURPOSE=926,Me.ECI_CHARSET=927,Me.BEGIN_MACRO_PDF417_CONTROL_BLOCK=928,Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD=923,Me.MACRO_PDF417_TERMINATOR=922,Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE=913,Me.MAX_NUMERIC_CODEWORDS=15,Me.MACRO_PDF417_OPTIONAL_FIELD_FILE_NAME=0,Me.MACRO_PDF417_OPTIONAL_FIELD_SEGMENT_COUNT=1,Me.MACRO_PDF417_OPTIONAL_FIELD_TIME_STAMP=2,Me.MACRO_PDF417_OPTIONAL_FIELD_SENDER=3,Me.MACRO_PDF417_OPTIONAL_FIELD_ADDRESSEE=4,Me.MACRO_PDF417_OPTIONAL_FIELD_FILE_SIZE=5,Me.MACRO_PDF417_OPTIONAL_FIELD_CHECKSUM=6,Me.PL=25,Me.LL=27,Me.AS=27,Me.ML=28,Me.AL=28,Me.PS=29,Me.PAL=29,Me.PUNCT_CHARS=`;<>@[\\]_\`~!\r	,:
-.$/"|*()?{}'`,Me.MIXED_CHARS="0123456789&\r	,:#-.$/+%*=^",Me.EXP900=gn()?Zi():[],Me.NUMBER_OF_SEQUENCE_CODEWORDS=2;class _t{constructor(){}static decode(t,s,r,a,i,o,d){let h=new hr(t,s,r,a,i),m=null,y=null,I;for(let ie=!0;;ie=!1){if(s!=null&&(m=_t.getRowIndicatorColumn(t,h,s,!0,o,d)),a!=null&&(y=_t.getRowIndicatorColumn(t,h,a,!1,o,d)),I=_t.merge(m,y),I==null)throw G.getNotFoundInstance();let ce=I.getBoundingBox();if(ie&&ce!=null&&(ce.getMinY()<h.getMinY()||ce.getMaxY()>h.getMaxY()))h=ce;else break}I.setBoundingBox(h);let z=I.getBarcodeColumnCount()+1;I.setDetectionResultColumn(0,m),I.setDetectionResultColumn(z,y);let Y=m!=null;for(let ie=1;ie<=z;ie++){let ce=Y?ie:z-ie;if(I.getDetectionResultColumn(ce)!==void 0)continue;let Ne;ce===0||ce===z?Ne=new hn(h,ce===0):Ne=new Rr(h),I.setDetectionResultColumn(ce,Ne);let ze=-1,Ge=ze;for(let Ye=h.getMinY();Ye<=h.getMaxY();Ye++){if(ze=_t.getStartColumn(I,ce,Ye,Y),ze<0||ze>h.getMaxX()){if(Ge===-1)continue;ze=Ge}let Ue=_t.detectCodeword(t,h.getMinX(),h.getMaxX(),Y,ze,Ye,o,d);Ue!=null&&(Ne.setCodeword(Ye,Ue),Ge=ze,o=Math.min(o,Ue.getWidth()),d=Math.max(d,Ue.getWidth()))}}return _t.createDecoderResult(I)}static merge(t,s){if(t==null&&s==null)return null;let r=_t.getBarcodeMetadata(t,s);if(r==null)return null;let a=hr.merge(_t.adjustBoundingBox(t),_t.adjustBoundingBox(s));return new Pr(r,a)}static adjustBoundingBox(t){if(t==null)return null;let s=t.getRowHeights();if(s==null)return null;let r=_t.getMax(s),a=0;for(let d of s)if(a+=r-d,d>0)break;let i=t.getCodewords();for(let d=0;a>0&&i[d]==null;d++)a--;let o=0;for(let d=s.length-1;d>=0&&(o+=r-s[d],!(s[d]>0));d--);for(let d=i.length-1;o>0&&i[d]==null;d--)o--;return t.getBoundingBox().addMissingRows(a,o,t.isLeft())}static getMax(t){let s=-1;for(let r of t)s=Math.max(s,r);return s}static getBarcodeMetadata(t,s){let r;if(t==null||(r=t.getBarcodeMetadata())==null)return s==null?null:s.getBarcodeMetadata();let a;return s==null||(a=s.getBarcodeMetadata())==null?r:r.getColumnCount()!==a.getColumnCount()&&r.getErrorCorrectionLevel()!==a.getErrorCorrectionLevel()&&r.getRowCount()!==a.getRowCount()?null:r}static getRowIndicatorColumn(t,s,r,a,i,o){let d=new hn(s,a);for(let h=0;h<2;h++){let m=h===0?1:-1,y=Math.trunc(Math.trunc(r.getX()));for(let I=Math.trunc(Math.trunc(r.getY()));I<=s.getMaxY()&&I>=s.getMinY();I+=m){let z=_t.detectCodeword(t,0,t.getWidth(),a,y,I,i,o);z!=null&&(d.setCodeword(I,z),a?y=z.getStartX():y=z.getEndX())}}return d}static adjustCodewordCount(t,s){let r=s[0][1],a=r.getValue(),i=t.getBarcodeColumnCount()*t.getBarcodeRowCount()-_t.getNumberOfECCodeWords(t.getBarcodeECLevel());if(a.length===0){if(i<1||i>ut.MAX_CODEWORDS_IN_BARCODE)throw G.getNotFoundInstance();r.setValue(i)}else a[0]!==i&&r.setValue(i)}static createDecoderResult(t){let s=_t.createBarcodeMatrix(t);_t.adjustCodewordCount(t,s);let r=new Array,a=new Int32Array(t.getBarcodeRowCount()*t.getBarcodeColumnCount()),i=[],o=new Array;for(let h=0;h<t.getBarcodeRowCount();h++)for(let m=0;m<t.getBarcodeColumnCount();m++){let y=s[h][m+1].getValue(),I=h*t.getBarcodeColumnCount()+m;y.length===0?r.push(I):y.length===1?a[I]=y[0]:(o.push(I),i.push(y))}let d=new Array(i.length);for(let h=0;h<d.length;h++)d[h]=i[h];return _t.createDecoderResultFromAmbiguousValues(t.getBarcodeECLevel(),a,ut.toIntArray(r),ut.toIntArray(o),d)}static createDecoderResultFromAmbiguousValues(t,s,r,a,i){let o=new Int32Array(a.length),d=100;for(;d-- >0;){for(let h=0;h<o.length;h++)s[a[h]]=i[h][o[h]];try{return _t.decodeCodewords(s,t,r)}catch(h){if(!(h instanceof P))throw h}if(o.length===0)throw P.getChecksumInstance();for(let h=0;h<o.length;h++)if(o[h]<i[h].length-1){o[h]++;break}else if(o[h]=0,h===o.length-1)throw P.getChecksumInstance()}throw P.getChecksumInstance()}static createBarcodeMatrix(t){let s=Array.from({length:t.getBarcodeRowCount()},()=>new Array(t.getBarcodeColumnCount()+2));for(let a=0;a<s.length;a++)for(let i=0;i<s[a].length;i++)s[a][i]=new Lr;let r=0;for(let a of t.getDetectionResultColumns()){if(a!=null){for(let i of a.getCodewords())if(i!=null){let o=i.getRowNumber();if(o>=0){if(o>=s.length)continue;s[o][r].setValue(i.getValue())}}}r++}return s}static isValidBarcodeColumn(t,s){return s>=0&&s<=t.getBarcodeColumnCount()+1}static getStartColumn(t,s,r,a){let i=a?1:-1,o=null;if(_t.isValidBarcodeColumn(t,s-i)&&(o=t.getDetectionResultColumn(s-i).getCodeword(r)),o!=null)return a?o.getEndX():o.getStartX();if(o=t.getDetectionResultColumn(s).getCodewordNearby(r),o!=null)return a?o.getStartX():o.getEndX();if(_t.isValidBarcodeColumn(t,s-i)&&(o=t.getDetectionResultColumn(s-i).getCodewordNearby(r)),o!=null)return a?o.getEndX():o.getStartX();let d=0;for(;_t.isValidBarcodeColumn(t,s-i);){s-=i;for(let h of t.getDetectionResultColumn(s).getCodewords())if(h!=null)return(a?h.getEndX():h.getStartX())+i*d*(h.getEndX()-h.getStartX());d++}return a?t.getBoundingBox().getMinX():t.getBoundingBox().getMaxX()}static detectCodeword(t,s,r,a,i,o,d,h){i=_t.adjustCodewordStartColumn(t,s,r,a,i,o);let m=_t.getModuleBitCount(t,s,r,a,i,o);if(m==null)return null;let y,I=We.sum(m);if(a)y=i+I;else{for(let ie=0;ie<m.length/2;ie++){let ce=m[ie];m[ie]=m[m.length-1-ie],m[m.length-1-ie]=ce}y=i,i=y-I}if(!_t.checkCodewordSkew(I,d,h))return null;let z=gs.getDecodedValue(m),Y=ut.getCodeword(z);return Y===-1?null:new Br(i,y,_t.getCodewordBucketNumber(z),Y)}static getModuleBitCount(t,s,r,a,i,o){let d=i,h=new Int32Array(8),m=0,y=a?1:-1,I=a;for(;(a?d<r:d>=s)&&m<h.length;)t.get(d,o)===I?(h[m]++,d+=y):(m++,I=!I);return m===h.length||d===(a?r:s)&&m===h.length-1?h:null}static getNumberOfECCodeWords(t){return 2<<t}static adjustCodewordStartColumn(t,s,r,a,i,o){let d=i,h=a?-1:1;for(let m=0;m<2;m++){for(;(a?d>=s:d<r)&&a===t.get(d,o);){if(Math.abs(i-d)>_t.CODEWORD_SKEW_SIZE)return i;d+=h}h=-h,a=!a}return d}static checkCodewordSkew(t,s,r){return s-_t.CODEWORD_SKEW_SIZE<=t&&t<=r+_t.CODEWORD_SKEW_SIZE}static decodeCodewords(t,s,r){if(t.length===0)throw _.getFormatInstance();let a=1<<s+1,i=_t.correctErrors(t,r,a);_t.verifyCodewordCount(t,a);let o=Me.decode(t,""+s);return o.setErrorsCorrected(i),o.setErasures(r.length),o}static correctErrors(t,s,r){if(s!=null&&s.length>r/2+_t.MAX_ERRORS||r<0||r>_t.MAX_EC_CODEWORDS)throw P.getChecksumInstance();return _t.errorCorrection.decode(t,r,s)}static verifyCodewordCount(t,s){if(t.length<4)throw _.getFormatInstance();let r=t[0];if(r>t.length)throw _.getFormatInstance();if(r===0)if(s<t.length)t[0]=t.length-s;else throw _.getFormatInstance()}static getBitCountForCodeword(t){let s=new Int32Array(8),r=0,a=s.length-1;for(;!((t&1)!==r&&(r=t&1,a--,a<0));)s[a]++,t>>=1;return s}static getCodewordBucketNumber(t){return t instanceof Int32Array?this.getCodewordBucketNumber_Int32Array(t):this.getCodewordBucketNumber_number(t)}static getCodewordBucketNumber_number(t){return _t.getCodewordBucketNumber(_t.getBitCountForCodeword(t))}static getCodewordBucketNumber_Int32Array(t){return(t[0]-t[2]+t[4]-t[6]+9)%9}static toString(t){let s=new Or;for(let r=0;r<t.length;r++){s.format("Row %2d: ",r);for(let a=0;a<t[r].length;a++){let i=t[r][a];i.getValue().length===0?s.format("        ",null):s.format("%4d(%2d)",i.getValue()[0],i.getConfidence(i.getValue()[0]))}s.format("%n")}return s.toString()}}_t.CODEWORD_SKEW_SIZE=2,_t.MAX_ERRORS=3,_t.MAX_EC_CODEWORDS=512,_t.errorCorrection=new un;class as{decode(t,s=null){let r=as.decode(t,s,!1);if(r==null||r.length===0||r[0]==null)throw G.getNotFoundInstance();return r[0]}decodeMultiple(t,s=null){try{return as.decode(t,s,!0)}catch(r){throw r instanceof _||r instanceof P?G.getNotFoundInstance():r}}static decode(t,s,r){const a=new Array,i=yt.detectMultiple(t,s,r);for(const o of i.getPoints()){const d=_t.decode(i.getBits(),o[4],o[5],o[6],o[7],as.getMinCodewordWidth(o),as.getMaxCodewordWidth(o)),h=new L(d.getText(),d.getRawBytes(),void 0,o,de.PDF_417);h.putMetadata(ge.ERROR_CORRECTION_LEVEL,d.getECLevel());const m=d.getOther();m!=null&&h.putMetadata(ge.PDF417_EXTRA_METADATA,m),a.push(h)}return a.map(o=>o)}static getMaxWidth(t,s){return t==null||s==null?0:Math.trunc(Math.abs(t.getX()-s.getX()))}static getMinWidth(t,s){return t==null||s==null?F.MAX_VALUE:Math.trunc(Math.abs(t.getX()-s.getX()))}static getMaxCodewordWidth(t){return Math.floor(Math.max(Math.max(as.getMaxWidth(t[0],t[4]),as.getMaxWidth(t[6],t[2])*ut.MODULES_IN_CODEWORD/ut.MODULES_IN_STOP_PATTERN),Math.max(as.getMaxWidth(t[1],t[5]),as.getMaxWidth(t[7],t[3])*ut.MODULES_IN_CODEWORD/ut.MODULES_IN_STOP_PATTERN)))}static getMinCodewordWidth(t){return Math.floor(Math.min(Math.min(as.getMinWidth(t[0],t[4]),as.getMinWidth(t[6],t[2])*ut.MODULES_IN_CODEWORD/ut.MODULES_IN_STOP_PATTERN),Math.min(as.getMinWidth(t[1],t[5]),as.getMinWidth(t[7],t[3])*ut.MODULES_IN_CODEWORD/ut.MODULES_IN_STOP_PATTERN)))}reset(){}}class na extends g{}na.kind="ReaderException";class pn{constructor(t,s){this.verbose=t===!0,s&&this.setHints(s)}decode(t,s){return s&&this.setHints(s),this.decodeInternal(t)}decodeWithState(t){return(this.readers===null||this.readers===void 0)&&this.setHints(null),this.decodeInternal(t)}setHints(t){this.hints=t;const s=!u(t)&&t.get(N.TRY_HARDER)===!0,r=u(t)?null:t.get(N.POSSIBLE_FORMATS),a=new Array;if(!u(r)){const i=r.some(o=>o===de.UPC_A||o===de.UPC_E||o===de.EAN_13||o===de.EAN_8||o===de.CODABAR||o===de.CODE_39||o===de.CODE_93||o===de.CODE_128||o===de.ITF||o===de.RSS_14||o===de.RSS_EXPANDED);i&&!s&&a.push(new Ke(t,this.verbose)),r.includes(de.QR_CODE)&&a.push(new Ks),r.includes(de.DATA_MATRIX)&&a.push(new ss),r.includes(de.AZTEC)&&a.push(new _e),r.includes(de.PDF_417)&&a.push(new as),i&&s&&a.push(new Ke(t,this.verbose))}a.length===0&&(s||a.push(new Ke(t,this.verbose)),a.push(new Ks),a.push(new ss),a.push(new _e),a.push(new as),s&&a.push(new Ke(t,this.verbose))),this.readers=a}reset(){if(this.readers!==null)for(const t of this.readers)t.reset()}decodeInternal(t){if(this.readers===null)throw new na("No readers where selected, nothing can be read.");for(const s of this.readers)try{return s.decode(t,this.hints)}catch(r){if(r instanceof na)continue}throw new G("No MultiFormat Readers were able to detect the code.")}}class Qi extends Z{constructor(t=null,s=500){const r=new pn;r.setHints(t),super(r,s)}decodeBitmap(t){return this.reader.decodeWithState(t)}}class Ki extends Z{constructor(t=500){super(new as,t)}}class Ji extends Z{constructor(t=500){super(new Ks,t)}}var ka;(function(A){A[A.ERROR_CORRECTION=0]="ERROR_CORRECTION",A[A.CHARACTER_SET=1]="CHARACTER_SET",A[A.DATA_MATRIX_SHAPE=2]="DATA_MATRIX_SHAPE",A[A.MIN_SIZE=3]="MIN_SIZE",A[A.MAX_SIZE=4]="MAX_SIZE",A[A.MARGIN=5]="MARGIN",A[A.PDF417_COMPACT=6]="PDF417_COMPACT",A[A.PDF417_COMPACTION=7]="PDF417_COMPACTION",A[A.PDF417_DIMENSIONS=8]="PDF417_DIMENSIONS",A[A.AZTEC_LAYERS=9]="AZTEC_LAYERS",A[A.QR_VERSION=10]="QR_VERSION"})(ka||(ka={}));var Qt=ka;class Ma{constructor(t){this.field=t,this.cachedGenerators=[],this.cachedGenerators.push(new we(t,Int32Array.from([1])))}buildGenerator(t){const s=this.cachedGenerators;if(t>=s.length){let r=s[s.length-1];const a=this.field;for(let i=s.length;i<=t;i++){const o=r.multiply(new we(a,Int32Array.from([1,a.exp(i-1+a.getGeneratorBase())])));s.push(o),r=o}}return s[t]}encode(t,s){if(s===0)throw new p("No error correction bytes");const r=t.length-s;if(r<=0)throw new p("No data bytes provided");const a=this.buildGenerator(s),i=new Int32Array(r);R.arraycopy(t,0,i,0,r);let o=new we(this.field,i);o=o.multiplyByMonomial(s,1);const h=o.divide(a)[1].getCoefficients(),m=s-h.length;for(let y=0;y<m;y++)t[r+y]=0;R.arraycopy(h,0,t,r+m,h.length)}}class Wt{constructor(){}static applyMaskPenaltyRule1(t){return Wt.applyMaskPenaltyRule1Internal(t,!0)+Wt.applyMaskPenaltyRule1Internal(t,!1)}static applyMaskPenaltyRule2(t){let s=0;const r=t.getArray(),a=t.getWidth(),i=t.getHeight();for(let o=0;o<i-1;o++){const d=r[o];for(let h=0;h<a-1;h++){const m=d[h];m===d[h+1]&&m===r[o+1][h]&&m===r[o+1][h+1]&&s++}}return Wt.N2*s}static applyMaskPenaltyRule3(t){let s=0;const r=t.getArray(),a=t.getWidth(),i=t.getHeight();for(let o=0;o<i;o++)for(let d=0;d<a;d++){const h=r[o];d+6<a&&h[d]===1&&h[d+1]===0&&h[d+2]===1&&h[d+3]===1&&h[d+4]===1&&h[d+5]===0&&h[d+6]===1&&(Wt.isWhiteHorizontal(h,d-4,d)||Wt.isWhiteHorizontal(h,d+7,d+11))&&s++,o+6<i&&r[o][d]===1&&r[o+1][d]===0&&r[o+2][d]===1&&r[o+3][d]===1&&r[o+4][d]===1&&r[o+5][d]===0&&r[o+6][d]===1&&(Wt.isWhiteVertical(r,d,o-4,o)||Wt.isWhiteVertical(r,d,o+7,o+11))&&s++}return s*Wt.N3}static isWhiteHorizontal(t,s,r){s=Math.max(s,0),r=Math.min(r,t.length);for(let a=s;a<r;a++)if(t[a]===1)return!1;return!0}static isWhiteVertical(t,s,r,a){r=Math.max(r,0),a=Math.min(a,t.length);for(let i=r;i<a;i++)if(t[i][s]===1)return!1;return!0}static applyMaskPenaltyRule4(t){let s=0;const r=t.getArray(),a=t.getWidth(),i=t.getHeight();for(let h=0;h<i;h++){const m=r[h];for(let y=0;y<a;y++)m[y]===1&&s++}const o=t.getHeight()*t.getWidth();return Math.floor(Math.abs(s*2-o)*10/o)*Wt.N4}static getDataMaskBit(t,s,r){let a,i;switch(t){case 0:a=r+s&1;break;case 1:a=r&1;break;case 2:a=s%3;break;case 3:a=(r+s)%3;break;case 4:a=Math.floor(r/2)+Math.floor(s/3)&1;break;case 5:i=r*s,a=(i&1)+i%3;break;case 6:i=r*s,a=(i&1)+i%3&1;break;case 7:i=r*s,a=i%3+(r+s&1)&1;break;default:throw new p("Invalid mask pattern: "+t)}return a===0}static applyMaskPenaltyRule1Internal(t,s){let r=0;const a=s?t.getHeight():t.getWidth(),i=s?t.getWidth():t.getHeight(),o=t.getArray();for(let d=0;d<a;d++){let h=0,m=-1;for(let y=0;y<i;y++){const I=s?o[d][y]:o[y][d];I===m?h++:(h>=5&&(r+=Wt.N1+(h-5)),h=1,m=I)}h>=5&&(r+=Wt.N1+(h-5))}return r}}Wt.N1=3,Wt.N2=3,Wt.N3=40,Wt.N4=10;class ia{constructor(t,s){this.width=t,this.height=s;const r=new Array(s);for(let a=0;a!==s;a++)r[a]=new Uint8Array(t);this.bytes=r}getHeight(){return this.height}getWidth(){return this.width}get(t,s){return this.bytes[s][t]}getArray(){return this.bytes}setNumber(t,s,r){this.bytes[s][t]=r}setBoolean(t,s,r){this.bytes[s][t]=r?1:0}clear(t){for(const s of this.bytes)T.fill(s,t)}equals(t){if(!(t instanceof ia))return!1;const s=t;if(this.width!==s.width||this.height!==s.height)return!1;for(let r=0,a=this.height;r<a;++r){const i=this.bytes[r],o=s.bytes[r];for(let d=0,h=this.width;d<h;++d)if(i[d]!==o[d])return!1}return!0}toString(){const t=new se;for(let s=0,r=this.height;s<r;++s){const a=this.bytes[s];for(let i=0,o=this.width;i<o;++i)switch(a[i]){case 0:t.append(" 0");break;case 1:t.append(" 1");break;default:t.append("  ");break}t.append(`
`)}return t.toString()}}class xr{constructor(){this.maskPattern=-1}getMode(){return this.mode}getECLevel(){return this.ecLevel}getVersion(){return this.version}getMaskPattern(){return this.maskPattern}getMatrix(){return this.matrix}toString(){const t=new se;return t.append(`<<
`),t.append(" mode: "),t.append(this.mode?this.mode.toString():"null"),t.append(`
 ecLevel: `),t.append(this.ecLevel?this.ecLevel.toString():"null"),t.append(`
 version: `),t.append(this.version?this.version.toString():"null"),t.append(`
 maskPattern: `),t.append(this.maskPattern.toString()),this.matrix?(t.append(`
 matrix:
`),t.append(this.matrix.toString())):t.append(`
 matrix: null
`),t.append(`>>
`),t.toString()}setMode(t){this.mode=t}setECLevel(t){this.ecLevel=t}setVersion(t){this.version=t}setMaskPattern(t){this.maskPattern=t}setMatrix(t){this.matrix=t}static isValidMaskPattern(t){return t>=0&&t<xr.NUM_MASK_PATTERNS}}xr.NUM_MASK_PATTERNS=8;class zt extends g{}zt.kind="WriterException";class dt{constructor(){}static clearMatrix(t){t.clear(255)}static buildMatrix(t,s,r,a,i){dt.clearMatrix(i),dt.embedBasicPatterns(r,i),dt.embedTypeInfo(s,a,i),dt.maybeEmbedVersionInfo(r,i),dt.embedDataBits(t,a,i)}static embedBasicPatterns(t,s){dt.embedPositionDetectionPatternsAndSeparators(s),dt.embedDarkDotAtLeftBottomCorner(s),dt.maybeEmbedPositionAdjustmentPatterns(t,s),dt.embedTimingPatterns(s)}static embedTypeInfo(t,s,r){const a=new U;dt.makeTypeInfoBits(t,s,a);for(let i=0,o=a.getSize();i<o;++i){const d=a.get(a.getSize()-1-i),h=dt.TYPE_INFO_COORDINATES[i],m=h[0],y=h[1];if(r.setBoolean(m,y,d),i<8){const I=r.getWidth()-i-1;r.setBoolean(I,8,d)}else{const z=r.getHeight()-7+(i-8);r.setBoolean(8,z,d)}}}static maybeEmbedVersionInfo(t,s){if(t.getVersionNumber()<7)return;const r=new U;dt.makeVersionInfoBits(t,r);let a=6*3-1;for(let i=0;i<6;++i)for(let o=0;o<3;++o){const d=r.get(a);a--,s.setBoolean(i,s.getHeight()-11+o,d),s.setBoolean(s.getHeight()-11+o,i,d)}}static embedDataBits(t,s,r){let a=0,i=-1,o=r.getWidth()-1,d=r.getHeight()-1;for(;o>0;){for(o===6&&(o-=1);d>=0&&d<r.getHeight();){for(let h=0;h<2;++h){const m=o-h;if(!dt.isEmpty(r.get(m,d)))continue;let y;a<t.getSize()?(y=t.get(a),++a):y=!1,s!==255&&Wt.getDataMaskBit(s,m,d)&&(y=!y),r.setBoolean(m,d,y)}d+=i}i=-i,d+=i,o-=2}if(a!==t.getSize())throw new zt("Not all bits consumed: "+a+"/"+t.getSize())}static findMSBSet(t){return 32-F.numberOfLeadingZeros(t)}static calculateBCHCode(t,s){if(s===0)throw new p("0 polynomial");const r=dt.findMSBSet(s);for(t<<=r-1;dt.findMSBSet(t)>=r;)t^=s<<dt.findMSBSet(t)-r;return t}static makeTypeInfoBits(t,s,r){if(!xr.isValidMaskPattern(s))throw new zt("Invalid mask pattern");const a=t.getBits()<<3|s;r.appendBits(a,5);const i=dt.calculateBCHCode(a,dt.TYPE_INFO_POLY);r.appendBits(i,10);const o=new U;if(o.appendBits(dt.TYPE_INFO_MASK_PATTERN,15),r.xor(o),r.getSize()!==15)throw new zt("should not happen but we got: "+r.getSize())}static makeVersionInfoBits(t,s){s.appendBits(t.getVersionNumber(),6);const r=dt.calculateBCHCode(t.getVersionNumber(),dt.VERSION_INFO_POLY);if(s.appendBits(r,12),s.getSize()!==18)throw new zt("should not happen but we got: "+s.getSize())}static isEmpty(t){return t===255}static embedTimingPatterns(t){for(let s=8;s<t.getWidth()-8;++s){const r=(s+1)%2;dt.isEmpty(t.get(s,6))&&t.setNumber(s,6,r),dt.isEmpty(t.get(6,s))&&t.setNumber(6,s,r)}}static embedDarkDotAtLeftBottomCorner(t){if(t.get(8,t.getHeight()-8)===0)throw new zt;t.setNumber(8,t.getHeight()-8,1)}static embedHorizontalSeparationPattern(t,s,r){for(let a=0;a<8;++a){if(!dt.isEmpty(r.get(t+a,s)))throw new zt;r.setNumber(t+a,s,0)}}static embedVerticalSeparationPattern(t,s,r){for(let a=0;a<7;++a){if(!dt.isEmpty(r.get(t,s+a)))throw new zt;r.setNumber(t,s+a,0)}}static embedPositionAdjustmentPattern(t,s,r){for(let a=0;a<5;++a){const i=dt.POSITION_ADJUSTMENT_PATTERN[a];for(let o=0;o<5;++o)r.setNumber(t+o,s+a,i[o])}}static embedPositionDetectionPattern(t,s,r){for(let a=0;a<7;++a){const i=dt.POSITION_DETECTION_PATTERN[a];for(let o=0;o<7;++o)r.setNumber(t+o,s+a,i[o])}}static embedPositionDetectionPatternsAndSeparators(t){const s=dt.POSITION_DETECTION_PATTERN[0].length;dt.embedPositionDetectionPattern(0,0,t),dt.embedPositionDetectionPattern(t.getWidth()-s,0,t),dt.embedPositionDetectionPattern(0,t.getWidth()-s,t);const r=8;dt.embedHorizontalSeparationPattern(0,r-1,t),dt.embedHorizontalSeparationPattern(t.getWidth()-r,r-1,t),dt.embedHorizontalSeparationPattern(0,t.getWidth()-r,t);const a=7;dt.embedVerticalSeparationPattern(a,0,t),dt.embedVerticalSeparationPattern(t.getHeight()-a-1,0,t),dt.embedVerticalSeparationPattern(a,t.getHeight()-a,t)}static maybeEmbedPositionAdjustmentPatterns(t,s){if(t.getVersionNumber()<2)return;const r=t.getVersionNumber()-1,a=dt.POSITION_ADJUSTMENT_PATTERN_COORDINATE_TABLE[r];for(let i=0,o=a.length;i!==o;i++){const d=a[i];if(d>=0)for(let h=0;h!==o;h++){const m=a[h];m>=0&&dt.isEmpty(s.get(m,d))&&dt.embedPositionAdjustmentPattern(m-2,d-2,s)}}}}dt.POSITION_DETECTION_PATTERN=Array.from([Int32Array.from([1,1,1,1,1,1,1]),Int32Array.from([1,0,0,0,0,0,1]),Int32Array.from([1,0,1,1,1,0,1]),Int32Array.from([1,0,1,1,1,0,1]),Int32Array.from([1,0,1,1,1,0,1]),Int32Array.from([1,0,0,0,0,0,1]),Int32Array.from([1,1,1,1,1,1,1])]),dt.POSITION_ADJUSTMENT_PATTERN=Array.from([Int32Array.from([1,1,1,1,1]),Int32Array.from([1,0,0,0,1]),Int32Array.from([1,0,1,0,1]),Int32Array.from([1,0,0,0,1]),Int32Array.from([1,1,1,1,1])]),dt.POSITION_ADJUSTMENT_PATTERN_COORDINATE_TABLE=Array.from([Int32Array.from([-1,-1,-1,-1,-1,-1,-1]),Int32Array.from([6,18,-1,-1,-1,-1,-1]),Int32Array.from([6,22,-1,-1,-1,-1,-1]),Int32Array.from([6,26,-1,-1,-1,-1,-1]),Int32Array.from([6,30,-1,-1,-1,-1,-1]),Int32Array.from([6,34,-1,-1,-1,-1,-1]),Int32Array.from([6,22,38,-1,-1,-1,-1]),Int32Array.from([6,24,42,-1,-1,-1,-1]),Int32Array.from([6,26,46,-1,-1,-1,-1]),Int32Array.from([6,28,50,-1,-1,-1,-1]),Int32Array.from([6,30,54,-1,-1,-1,-1]),Int32Array.from([6,32,58,-1,-1,-1,-1]),Int32Array.from([6,34,62,-1,-1,-1,-1]),Int32Array.from([6,26,46,66,-1,-1,-1]),Int32Array.from([6,26,48,70,-1,-1,-1]),Int32Array.from([6,26,50,74,-1,-1,-1]),Int32Array.from([6,30,54,78,-1,-1,-1]),Int32Array.from([6,30,56,82,-1,-1,-1]),Int32Array.from([6,30,58,86,-1,-1,-1]),Int32Array.from([6,34,62,90,-1,-1,-1]),Int32Array.from([6,28,50,72,94,-1,-1]),Int32Array.from([6,26,50,74,98,-1,-1]),Int32Array.from([6,30,54,78,102,-1,-1]),Int32Array.from([6,28,54,80,106,-1,-1]),Int32Array.from([6,32,58,84,110,-1,-1]),Int32Array.from([6,30,58,86,114,-1,-1]),Int32Array.from([6,34,62,90,118,-1,-1]),Int32Array.from([6,26,50,74,98,122,-1]),Int32Array.from([6,30,54,78,102,126,-1]),Int32Array.from([6,26,52,78,104,130,-1]),Int32Array.from([6,30,56,82,108,134,-1]),Int32Array.from([6,34,60,86,112,138,-1]),Int32Array.from([6,30,58,86,114,142,-1]),Int32Array.from([6,34,62,90,118,146,-1]),Int32Array.from([6,30,54,78,102,126,150]),Int32Array.from([6,24,50,76,102,128,154]),Int32Array.from([6,28,54,80,106,132,158]),Int32Array.from([6,32,58,84,110,136,162]),Int32Array.from([6,26,54,82,110,138,166]),Int32Array.from([6,30,58,86,114,142,170])]),dt.TYPE_INFO_COORDINATES=Array.from([Int32Array.from([8,0]),Int32Array.from([8,1]),Int32Array.from([8,2]),Int32Array.from([8,3]),Int32Array.from([8,4]),Int32Array.from([8,5]),Int32Array.from([8,7]),Int32Array.from([8,8]),Int32Array.from([7,8]),Int32Array.from([5,8]),Int32Array.from([4,8]),Int32Array.from([3,8]),Int32Array.from([2,8]),Int32Array.from([1,8]),Int32Array.from([0,8])]),dt.VERSION_INFO_POLY=7973,dt.TYPE_INFO_POLY=1335,dt.TYPE_INFO_MASK_PATTERN=21522;class eo{constructor(t,s){this.dataBytes=t,this.errorCorrectionBytes=s}getDataBytes(){return this.dataBytes}getErrorCorrectionBytes(){return this.errorCorrectionBytes}}class Bt{constructor(){}static calculateMaskPenalty(t){return Wt.applyMaskPenaltyRule1(t)+Wt.applyMaskPenaltyRule2(t)+Wt.applyMaskPenaltyRule3(t)+Wt.applyMaskPenaltyRule4(t)}static encode(t,s,r=null){let a=Bt.DEFAULT_BYTE_MODE_ENCODING;const i=r!==null&&r.get(Qt.CHARACTER_SET)!==void 0;i&&(a=r.get(Qt.CHARACTER_SET).toString());const o=this.chooseMode(t,a),d=new U;if(o===lt.BYTE&&(i||Bt.DEFAULT_BYTE_MODE_ENCODING!==a)){const Ye=C.getCharacterSetECIByName(a);Ye!==void 0&&this.appendECI(Ye,d)}this.appendModeInfo(o,d);const h=new U;this.appendBytes(t,o,h,a);let m;if(r!==null&&r.get(Qt.QR_VERSION)!==void 0){const Ye=Number.parseInt(r.get(Qt.QR_VERSION).toString(),10);m=it.getVersionForNumber(Ye);const Ue=this.calculateBitsNeeded(o,d,h,m);if(!this.willFit(Ue,m,s))throw new zt("Data too big for requested version")}else m=this.recommendVersion(s,o,d,h);const y=new U;y.appendBitArray(d);const I=o===lt.BYTE?h.getSizeInBytes():t.length;this.appendLengthInfo(I,m,o,y),y.appendBitArray(h);const z=m.getECBlocksForLevel(s),Y=m.getTotalCodewords()-z.getTotalECCodewords();this.terminateBits(Y,y);const ie=this.interleaveWithECBytes(y,m.getTotalCodewords(),Y,z.getNumBlocks()),ce=new xr;ce.setECLevel(s),ce.setMode(o),ce.setVersion(m);const Ne=m.getDimensionForVersion(),ze=new ia(Ne,Ne),Ge=this.chooseMaskPattern(ie,s,m,ze);return ce.setMaskPattern(Ge),dt.buildMatrix(ie,s,m,Ge,ze),ce.setMatrix(ze),ce}static recommendVersion(t,s,r,a){const i=this.calculateBitsNeeded(s,r,a,it.getVersionForNumber(1)),o=this.chooseVersion(i,t),d=this.calculateBitsNeeded(s,r,a,o);return this.chooseVersion(d,t)}static calculateBitsNeeded(t,s,r,a){return s.getSize()+t.getCharacterCountBits(a)+r.getSize()}static getAlphanumericCode(t){return t<Bt.ALPHANUMERIC_TABLE.length?Bt.ALPHANUMERIC_TABLE[t]:-1}static chooseMode(t,s=null){if(C.SJIS.getName()===s&&this.isOnlyDoubleByteKanji(t))return lt.KANJI;let r=!1,a=!1;for(let i=0,o=t.length;i<o;++i){const d=t.charAt(i);if(Bt.isDigit(d))r=!0;else if(this.getAlphanumericCode(d.charCodeAt(0))!==-1)a=!0;else return lt.BYTE}return a?lt.ALPHANUMERIC:r?lt.NUMERIC:lt.BYTE}static isOnlyDoubleByteKanji(t){let s;try{s=O.encode(t,C.SJIS)}catch{return!1}const r=s.length;if(r%2!==0)return!1;for(let a=0;a<r;a+=2){const i=s[a]&255;if((i<129||i>159)&&(i<224||i>235))return!1}return!0}static chooseMaskPattern(t,s,r,a){let i=Number.MAX_SAFE_INTEGER,o=-1;for(let d=0;d<xr.NUM_MASK_PATTERNS;d++){dt.buildMatrix(t,s,r,d,a);let h=this.calculateMaskPenalty(a);h<i&&(i=h,o=d)}return o}static chooseVersion(t,s){for(let r=1;r<=40;r++){const a=it.getVersionForNumber(r);if(Bt.willFit(t,a,s))return a}throw new zt("Data too big")}static willFit(t,s,r){const a=s.getTotalCodewords(),o=s.getECBlocksForLevel(r).getTotalECCodewords(),d=a-o,h=(t+7)/8;return d>=h}static terminateBits(t,s){const r=t*8;if(s.getSize()>r)throw new zt("data bits cannot fit in the QR Code"+s.getSize()+" > "+r);for(let o=0;o<4&&s.getSize()<r;++o)s.appendBit(!1);const a=s.getSize()&7;if(a>0)for(let o=a;o<8;o++)s.appendBit(!1);const i=t-s.getSizeInBytes();for(let o=0;o<i;++o)s.appendBits(o&1?17:236,8);if(s.getSize()!==r)throw new zt("Bits size does not equal capacity")}static getNumDataBytesAndNumECBytesForBlockID(t,s,r,a,i,o){if(a>=r)throw new zt("Block ID too large");const d=t%r,h=r-d,m=Math.floor(t/r),y=m+1,I=Math.floor(s/r),z=I+1,Y=m-I,ie=y-z;if(Y!==ie)throw new zt("EC bytes mismatch");if(r!==h+d)throw new zt("RS blocks mismatch");if(t!==(I+Y)*h+(z+ie)*d)throw new zt("Total bytes mismatch");a<h?(i[0]=I,o[0]=Y):(i[0]=z,o[0]=ie)}static interleaveWithECBytes(t,s,r,a){if(t.getSizeInBytes()!==r)throw new zt("Number of bits and data bytes does not match");let i=0,o=0,d=0;const h=new Array;for(let y=0;y<a;++y){const I=new Int32Array(1),z=new Int32Array(1);Bt.getNumDataBytesAndNumECBytesForBlockID(s,r,a,y,I,z);const Y=I[0],ie=new Uint8Array(Y);t.toBytes(8*i,ie,0,Y);const ce=Bt.generateECBytes(ie,z[0]);h.push(new eo(ie,ce)),o=Math.max(o,Y),d=Math.max(d,ce.length),i+=I[0]}if(r!==i)throw new zt("Data bytes does not match offset");const m=new U;for(let y=0;y<o;++y)for(const I of h){const z=I.getDataBytes();y<z.length&&m.appendBits(z[y],8)}for(let y=0;y<d;++y)for(const I of h){const z=I.getErrorCorrectionBytes();y<z.length&&m.appendBits(z[y],8)}if(s!==m.getSizeInBytes())throw new zt("Interleaving error: "+s+" and "+m.getSizeInBytes()+" differ.");return m}static generateECBytes(t,s){const r=t.length,a=new Int32Array(r+s);for(let o=0;o<r;o++)a[o]=t[o]&255;new Ma(Fe.QR_CODE_FIELD_256).encode(a,s);const i=new Uint8Array(s);for(let o=0;o<s;o++)i[o]=a[r+o];return i}static appendModeInfo(t,s){s.appendBits(t.getBits(),4)}static appendLengthInfo(t,s,r,a){const i=r.getCharacterCountBits(s);if(t>=1<<i)throw new zt(t+" is bigger than "+((1<<i)-1));a.appendBits(t,i)}static appendBytes(t,s,r,a){switch(s){case lt.NUMERIC:Bt.appendNumericBytes(t,r);break;case lt.ALPHANUMERIC:Bt.appendAlphanumericBytes(t,r);break;case lt.BYTE:Bt.append8BitBytes(t,r,a);break;case lt.KANJI:Bt.appendKanjiBytes(t,r);break;default:throw new zt("Invalid mode: "+s)}}static getDigit(t){return t.charCodeAt(0)-48}static isDigit(t){const s=Bt.getDigit(t);return s>=0&&s<=9}static appendNumericBytes(t,s){const r=t.length;let a=0;for(;a<r;){const i=Bt.getDigit(t.charAt(a));if(a+2<r){const o=Bt.getDigit(t.charAt(a+1)),d=Bt.getDigit(t.charAt(a+2));s.appendBits(i*100+o*10+d,10),a+=3}else if(a+1<r){const o=Bt.getDigit(t.charAt(a+1));s.appendBits(i*10+o,7),a+=2}else s.appendBits(i,4),a++}}static appendAlphanumericBytes(t,s){const r=t.length;let a=0;for(;a<r;){const i=Bt.getAlphanumericCode(t.charCodeAt(a));if(i===-1)throw new zt;if(a+1<r){const o=Bt.getAlphanumericCode(t.charCodeAt(a+1));if(o===-1)throw new zt;s.appendBits(i*45+o,11),a+=2}else s.appendBits(i,6),a++}}static append8BitBytes(t,s,r){let a;try{a=O.encode(t,r)}catch(i){throw new zt(i)}for(let i=0,o=a.length;i!==o;i++){const d=a[i];s.appendBits(d,8)}}static appendKanjiBytes(t,s){let r;try{r=O.encode(t,C.SJIS)}catch(i){throw new zt(i)}const a=r.length;for(let i=0;i<a;i+=2){const o=r[i]&255,d=r[i+1]&255,h=o<<8&4294967295|d;let m=-1;if(h>=33088&&h<=40956?m=h-33088:h>=57408&&h<=60351&&(m=h-49472),m===-1)throw new zt("Invalid byte sequence");const y=(m>>8)*192+(m&255);s.appendBits(y,13)}}static appendECI(t,s){s.appendBits(lt.ECI.getBits(),4),s.appendBits(t.getValue(),8)}}Bt.ALPHANUMERIC_TABLE=Int32Array.from([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,36,-1,-1,-1,37,38,-1,-1,-1,-1,39,40,-1,41,42,43,0,1,2,3,4,5,6,7,8,9,44,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,-1,-1,-1,-1,-1]),Bt.DEFAULT_BYTE_MODE_ENCODING=C.UTF8.getName();class mr{write(t,s,r,a=null){if(t.length===0)throw new p("Found empty contents");if(s<0||r<0)throw new p("Requested dimensions are too small: "+s+"x"+r);let i=wt.L,o=mr.QUIET_ZONE_SIZE;a!==null&&(a.get(Qt.ERROR_CORRECTION)!==void 0&&(i=wt.fromString(a.get(Qt.ERROR_CORRECTION).toString())),a.get(Qt.MARGIN)!==void 0&&(o=Number.parseInt(a.get(Qt.MARGIN).toString(),10)));const d=Bt.encode(t,i,a);return this.renderResult(d,s,r,o)}writeToDom(t,s,r,a,i=null){typeof t=="string"&&(t=document.querySelector(t));const o=this.write(s,r,a,i);t&&t.appendChild(o)}renderResult(t,s,r,a){const i=t.getMatrix();if(i===null)throw new rt;const o=i.getWidth(),d=i.getHeight(),h=o+a*2,m=d+a*2,y=Math.max(s,h),I=Math.max(r,m),z=Math.min(Math.floor(y/h),Math.floor(I/m)),Y=Math.floor((y-o*z)/2),ie=Math.floor((I-d*z)/2),ce=this.createSVGElement(y,I);for(let Ne=0,ze=ie;Ne<d;Ne++,ze+=z)for(let Ge=0,Ye=Y;Ge<o;Ge++,Ye+=z)if(i.get(Ge,Ne)===1){const Ue=this.createSvgRectElement(Ye,ze,z,z);ce.appendChild(Ue)}return ce}createSVGElement(t,s){const r=document.createElementNS(mr.SVG_NS,"svg");return r.setAttributeNS(null,"height",t.toString()),r.setAttributeNS(null,"width",s.toString()),r}createSvgRectElement(t,s,r,a){const i=document.createElementNS(mr.SVG_NS,"rect");return i.setAttributeNS(null,"x",t.toString()),i.setAttributeNS(null,"y",s.toString()),i.setAttributeNS(null,"height",r.toString()),i.setAttributeNS(null,"width",a.toString()),i.setAttributeNS(null,"fill","#000000"),i}}mr.QUIET_ZONE_SIZE=4,mr.SVG_NS="http://www.w3.org/2000/svg";class yr{encode(t,s,r,a,i){if(t.length===0)throw new p("Found empty contents");if(s!==de.QR_CODE)throw new p("Can only encode QR_CODE, but got "+s);if(r<0||a<0)throw new p(`Requested dimensions are too small: ${r}x${a}`);let o=wt.L,d=yr.QUIET_ZONE_SIZE;i!==null&&(i.get(Qt.ERROR_CORRECTION)!==void 0&&(o=wt.fromString(i.get(Qt.ERROR_CORRECTION).toString())),i.get(Qt.MARGIN)!==void 0&&(d=Number.parseInt(i.get(Qt.MARGIN).toString(),10)));const h=Bt.encode(t,o,i);return yr.renderResult(h,r,a,d)}static renderResult(t,s,r,a){const i=t.getMatrix();if(i===null)throw new rt;const o=i.getWidth(),d=i.getHeight(),h=o+a*2,m=d+a*2,y=Math.max(s,h),I=Math.max(r,m),z=Math.min(Math.floor(y/h),Math.floor(I/m)),Y=Math.floor((y-o*z)/2),ie=Math.floor((I-d*z)/2),ce=new W(y,I);for(let Ne=0,ze=ie;Ne<d;Ne++,ze+=z)for(let Ge=0,Ye=Y;Ge<o;Ge++,Ye+=z)i.get(Ge,Ne)===1&&ce.setRegion(Ye,ze,z,z);return ce}}yr.QUIET_ZONE_SIZE=4;class to{encode(t,s,r,a,i){let o;switch(s){case de.QR_CODE:o=new yr;break;default:throw new p("No encoder available for format "+s)}return o.encode(t,s,r,a,i)}}class Bs extends ye{constructor(t,s,r,a,i,o,d,h){if(super(o,d),this.yuvData=t,this.dataWidth=s,this.dataHeight=r,this.left=a,this.top=i,a+o>s||i+d>r)throw new p("Crop rectangle does not fit within image data.");h&&this.reverseHorizontal(o,d)}getRow(t,s){if(t<0||t>=this.getHeight())throw new p("Requested row is outside the image: "+t);const r=this.getWidth();(s==null||s.length<r)&&(s=new Uint8ClampedArray(r));const a=(t+this.top)*this.dataWidth+this.left;return R.arraycopy(this.yuvData,a,s,0,r),s}getMatrix(){const t=this.getWidth(),s=this.getHeight();if(t===this.dataWidth&&s===this.dataHeight)return this.yuvData;const r=t*s,a=new Uint8ClampedArray(r);let i=this.top*this.dataWidth+this.left;if(t===this.dataWidth)return R.arraycopy(this.yuvData,i,a,0,r),a;for(let o=0;o<s;o++){const d=o*t;R.arraycopy(this.yuvData,i,a,d,t),i+=this.dataWidth}return a}isCropSupported(){return!0}crop(t,s,r,a){return new Bs(this.yuvData,this.dataWidth,this.dataHeight,this.left+t,this.top+s,r,a,!1)}renderThumbnail(){const t=this.getWidth()/Bs.THUMBNAIL_SCALE_FACTOR,s=this.getHeight()/Bs.THUMBNAIL_SCALE_FACTOR,r=new Int32Array(t*s),a=this.yuvData;let i=this.top*this.dataWidth+this.left;for(let o=0;o<s;o++){const d=o*t;for(let h=0;h<t;h++){const m=a[i+h*Bs.THUMBNAIL_SCALE_FACTOR]&255;r[d+h]=4278190080|m*65793}i+=this.dataWidth*Bs.THUMBNAIL_SCALE_FACTOR}return r}getThumbnailWidth(){return this.getWidth()/Bs.THUMBNAIL_SCALE_FACTOR}getThumbnailHeight(){return this.getHeight()/Bs.THUMBNAIL_SCALE_FACTOR}reverseHorizontal(t,s){const r=this.yuvData;for(let a=0,i=this.top*this.dataWidth+this.left;a<s;a++,i+=this.dataWidth){const o=i+t/2;for(let d=i,h=i+t-1;d<o;d++,h--){const m=r[d];r[d]=r[h],r[h]=m}}}invert(){return new me(this)}}Bs.THUMBNAIL_SCALE_FACTOR=2;class za extends ye{constructor(t,s,r,a,i,o,d){if(super(s,r),this.dataWidth=a,this.dataHeight=i,this.left=o,this.top=d,t.BYTES_PER_ELEMENT===4){const h=s*r,m=new Uint8ClampedArray(h);for(let y=0;y<h;y++){const I=t[y],z=I>>16&255,Y=I>>7&510,ie=I&255;m[y]=(z+Y+ie)/4&255}this.luminances=m}else this.luminances=t;if(a===void 0&&(this.dataWidth=s),i===void 0&&(this.dataHeight=r),o===void 0&&(this.left=0),d===void 0&&(this.top=0),this.left+s>this.dataWidth||this.top+r>this.dataHeight)throw new p("Crop rectangle does not fit within image data.")}getRow(t,s){if(t<0||t>=this.getHeight())throw new p("Requested row is outside the image: "+t);const r=this.getWidth();(s==null||s.length<r)&&(s=new Uint8ClampedArray(r));const a=(t+this.top)*this.dataWidth+this.left;return R.arraycopy(this.luminances,a,s,0,r),s}getMatrix(){const t=this.getWidth(),s=this.getHeight();if(t===this.dataWidth&&s===this.dataHeight)return this.luminances;const r=t*s,a=new Uint8ClampedArray(r);let i=this.top*this.dataWidth+this.left;if(t===this.dataWidth)return R.arraycopy(this.luminances,i,a,0,r),a;for(let o=0;o<s;o++){const d=o*t;R.arraycopy(this.luminances,i,a,d,t),i+=this.dataWidth}return a}isCropSupported(){return!0}crop(t,s,r,a){return new za(this.luminances,r,a,this.dataWidth,this.dataHeight,this.left+t,this.top+s)}invert(){return new me(this)}}class bn extends C{static forName(t){return this.getCharacterSetECIByName(t)}}class Oa{}Oa.ISO_8859_1=C.ISO8859_1;class wn{isCompact(){return this.compact}setCompact(t){this.compact=t}getSize(){return this.size}setSize(t){this.size=t}getLayers(){return this.layers}setLayers(t){this.layers=t}getCodeWords(){return this.codeWords}setCodeWords(t){this.codeWords=t}getMatrix(){return this.matrix}setMatrix(t){this.matrix=t}}class yn{static singletonList(t){return[t]}static min(t,s){return t.sort(s)[0]}}class so{constructor(t){this.previous=t}getPrevious(){return this.previous}}class _r extends so{constructor(t,s,r){super(t),this.value=s,this.bitCount=r}appendTo(t,s){t.appendBits(this.value,this.bitCount)}add(t,s){return new _r(this,t,s)}addBinaryShift(t,s){return console.warn("addBinaryShift on SimpleToken, this simply returns a copy of this token"),new _r(this,t,s)}toString(){let t=this.value&(1<<this.bitCount)-1;return t|=1<<this.bitCount,"<"+F.toBinaryString(t|1<<this.bitCount).substring(1)+">"}}class Ra extends _r{constructor(t,s,r){super(t,0,0),this.binaryShiftStart=s,this.binaryShiftByteCount=r}appendTo(t,s){for(let r=0;r<this.binaryShiftByteCount;r++)(r===0||r===31&&this.binaryShiftByteCount<=62)&&(t.appendBits(31,5),this.binaryShiftByteCount>62?t.appendBits(this.binaryShiftByteCount-31,16):r===0?t.appendBits(Math.min(this.binaryShiftByteCount,31),5):t.appendBits(this.binaryShiftByteCount-31,5)),t.appendBits(s[this.binaryShiftStart+r],8)}addBinaryShift(t,s){return new Ra(this,t,s)}toString(){return"<"+this.binaryShiftStart+"::"+(this.binaryShiftStart+this.binaryShiftByteCount-1)+">"}}function ro(A,t,s){return new Ra(A,t,s)}function Fr(A,t,s){return new _r(A,t,s)}const ao=["UPPER","LOWER","DIGIT","MIXED","PUNCT"],er=0,oa=1,Ds=2,_n=3,Fs=4,no=new _r(null,0,0),La=[Int32Array.from([0,(5<<16)+28,(5<<16)+30,(5<<16)+29,656318]),Int32Array.from([(9<<16)+480+14,0,(5<<16)+30,(5<<16)+29,656318]),Int32Array.from([(4<<16)+14,(9<<16)+448+28,0,(9<<16)+448+29,932798]),Int32Array.from([(5<<16)+29,(5<<16)+28,656318,0,(5<<16)+30]),Int32Array.from([(5<<16)+31,656380,656382,656381,0])];function io(A){for(let t of A)T.fill(t,-1);return A[er][Fs]=0,A[oa][Fs]=0,A[oa][er]=28,A[_n][Fs]=0,A[Ds][Fs]=0,A[Ds][er]=15,A}const vn=io(T.createInt32Array(6,6));class Us{constructor(t,s,r,a){this.token=t,this.mode=s,this.binaryShiftByteCount=r,this.bitCount=a}getMode(){return this.mode}getToken(){return this.token}getBinaryShiftByteCount(){return this.binaryShiftByteCount}getBitCount(){return this.bitCount}latchAndAppend(t,s){let r=this.bitCount,a=this.token;if(t!==this.mode){let o=La[this.mode][t];a=Fr(a,o&65535,o>>16),r+=o>>16}let i=t===Ds?4:5;return a=Fr(a,s,i),new Us(a,t,0,r+i)}shiftAndAppend(t,s){let r=this.token,a=this.mode===Ds?4:5;return r=Fr(r,vn[this.mode][t],a),r=Fr(r,s,5),new Us(r,this.mode,0,this.bitCount+a+5)}addBinaryShiftChar(t){let s=this.token,r=this.mode,a=this.bitCount;if(this.mode===Fs||this.mode===Ds){let d=La[r][er];s=Fr(s,d&65535,d>>16),a+=d>>16,r=er}let i=this.binaryShiftByteCount===0||this.binaryShiftByteCount===31?18:this.binaryShiftByteCount===62?9:8,o=new Us(s,r,this.binaryShiftByteCount+1,a+i);return o.binaryShiftByteCount===2078&&(o=o.endBinaryShift(t+1)),o}endBinaryShift(t){if(this.binaryShiftByteCount===0)return this;let s=this.token;return s=ro(s,t-this.binaryShiftByteCount,this.binaryShiftByteCount),new Us(s,this.mode,0,this.bitCount)}isBetterThanOrEqualTo(t){let s=this.bitCount+(La[this.mode][t.mode]>>16);return this.binaryShiftByteCount<t.binaryShiftByteCount?s+=Us.calculateBinaryShiftCost(t)-Us.calculateBinaryShiftCost(this):this.binaryShiftByteCount>t.binaryShiftByteCount&&t.binaryShiftByteCount>0&&(s+=10),s<=t.bitCount}toBitArray(t){let s=[];for(let a=this.endBinaryShift(t.length).token;a!==null;a=a.getPrevious())s.unshift(a);let r=new U;for(const a of s)a.appendTo(r,t);return r}toString(){return X.format("%s bits=%d bytes=%d",ao[this.mode],this.bitCount,this.binaryShiftByteCount)}static calculateBinaryShiftCost(t){return t.binaryShiftByteCount>62?21:t.binaryShiftByteCount>31?20:t.binaryShiftByteCount>0?10:0}}Us.INITIAL_STATE=new Us(no,er,0,0);function oo(A){const t=X.getCharCode(" "),s=X.getCharCode("."),r=X.getCharCode(",");A[er][t]=1;const a=X.getCharCode("Z"),i=X.getCharCode("A");for(let z=i;z<=a;z++)A[er][z]=z-i+2;A[oa][t]=1;const o=X.getCharCode("z"),d=X.getCharCode("a");for(let z=d;z<=o;z++)A[oa][z]=z-d+2;A[Ds][t]=1;const h=X.getCharCode("9"),m=X.getCharCode("0");for(let z=m;z<=h;z++)A[Ds][z]=z-m+2;A[Ds][r]=12,A[Ds][s]=13;const y=["\0"," ","","","","","","","\x07","\b","	",`
`,"\v","\f","\r","\x1B","","","","","@","\\","^","_","`","|","~",""];for(let z=0;z<y.length;z++)A[_n][X.getCharCode(y[z])]=z;const I=["\0","\r","\0","\0","\0","\0","!","'","#","$","%","&","'","(",")","*","+",",","-",".","/",":",";","<","=",">","?","[","]","{","}"];for(let z=0;z<I.length;z++)X.getCharCode(I[z])>0&&(A[Fs][X.getCharCode(I[z])]=z);return A}const Pa=oo(T.createInt32Array(5,256));class Ur{constructor(t){this.text=t}encode(){const t=X.getCharCode(" "),s=X.getCharCode(`
`);let r=yn.singletonList(Us.INITIAL_STATE);for(let i=0;i<this.text.length;i++){let o,d=i+1<this.text.length?this.text[i+1]:0;switch(this.text[i]){case X.getCharCode("\r"):o=d===s?2:0;break;case X.getCharCode("."):o=d===t?3:0;break;case X.getCharCode(","):o=d===t?4:0;break;case X.getCharCode(":"):o=d===t?5:0;break;default:o=0}o>0?(r=Ur.updateStateListForPair(r,i,o),i++):r=this.updateStateListForChar(r,i)}return yn.min(r,(i,o)=>i.getBitCount()-o.getBitCount()).toBitArray(this.text)}updateStateListForChar(t,s){const r=[];for(let a of t)this.updateStateForChar(a,s,r);return Ur.simplifyStates(r)}updateStateForChar(t,s,r){let a=this.text[s]&255,i=Pa[t.getMode()][a]>0,o=null;for(let d=0;d<=Fs;d++){let h=Pa[d][a];if(h>0){if(o==null&&(o=t.endBinaryShift(s)),!i||d===t.getMode()||d===Ds){const m=o.latchAndAppend(d,h);r.push(m)}if(!i&&vn[t.getMode()][d]>=0){const m=o.shiftAndAppend(d,h);r.push(m)}}}if(t.getBinaryShiftByteCount()>0||Pa[t.getMode()][a]===0){let d=t.addBinaryShiftChar(s);r.push(d)}}static updateStateListForPair(t,s,r){const a=[];for(let i of t)this.updateStateForPair(i,s,r,a);return this.simplifyStates(a)}static updateStateForPair(t,s,r,a){let i=t.endBinaryShift(s);if(a.push(i.latchAndAppend(Fs,r)),t.getMode()!==Fs&&a.push(i.shiftAndAppend(Fs,r)),r===3||r===4){let o=i.latchAndAppend(Ds,16-r).latchAndAppend(Ds,1);a.push(o)}if(t.getBinaryShiftByteCount()>0){let o=t.addBinaryShiftChar(s).addBinaryShiftChar(s+1);a.push(o)}}static simplifyStates(t){let s=[];for(const r of t){let a=!0;for(const i of s){if(i.isBetterThanOrEqualTo(r)){a=!1;break}r.isBetterThanOrEqualTo(i)&&(s=s.filter(o=>o!==i))}a&&s.push(r)}return s}}class At{constructor(){}static encodeBytes(t){return At.encode(t,At.DEFAULT_EC_PERCENT,At.DEFAULT_AZTEC_LAYERS)}static encode(t,s,r){let a=new Ur(t).encode(),i=F.truncDivision(a.getSize()*s,100)+11,o=a.getSize()+i,d,h,m,y,I;if(r!==At.DEFAULT_AZTEC_LAYERS){if(d=r<0,h=Math.abs(r),h>(d?At.MAX_NB_BITS_COMPACT:At.MAX_NB_BITS))throw new p(X.format("Illegal value %s for layers",r));m=At.totalBitsInLayer(h,d),y=At.WORD_SIZE[h];let Ue=m-m%y;if(I=At.stuffBits(a,y),I.getSize()+i>Ue)throw new p("Data to large for user specified layer");if(d&&I.getSize()>y*64)throw new p("Data to large for user specified layer")}else{y=0,I=null;for(let Ue=0;;Ue++){if(Ue>At.MAX_NB_BITS)throw new p("Data too large for an Aztec code");if(d=Ue<=3,h=d?Ue+1:Ue,m=At.totalBitsInLayer(h,d),o>m)continue;(I==null||y!==At.WORD_SIZE[h])&&(y=At.WORD_SIZE[h],I=At.stuffBits(a,y));let Ct=m-m%y;if(!(d&&I.getSize()>y*64)&&I.getSize()+i<=Ct)break}}let z=At.generateCheckWords(I,m,y),Y=I.getSize()/y,ie=At.generateModeMessage(d,h,Y),ce=(d?11:14)+h*4,Ne=new Int32Array(ce),ze;if(d){ze=ce;for(let Ue=0;Ue<Ne.length;Ue++)Ne[Ue]=Ue}else{ze=ce+1+2*F.truncDivision(F.truncDivision(ce,2)-1,15);let Ue=F.truncDivision(ce,2),Ct=F.truncDivision(ze,2);for(let ft=0;ft<Ue;ft++){let ps=ft+F.truncDivision(ft,15);Ne[Ue-ft-1]=Ct-ps-1,Ne[Ue+ft]=Ct+ps+1}}let Ge=new W(ze);for(let Ue=0,Ct=0;Ue<h;Ue++){let ft=(h-Ue)*4+(d?9:12);for(let ps=0;ps<ft;ps++){let zs=ps*2;for(let bs=0;bs<2;bs++)z.get(Ct+zs+bs)&&Ge.set(Ne[Ue*2+bs],Ne[Ue*2+ps]),z.get(Ct+ft*2+zs+bs)&&Ge.set(Ne[Ue*2+ps],Ne[ce-1-Ue*2-bs]),z.get(Ct+ft*4+zs+bs)&&Ge.set(Ne[ce-1-Ue*2-bs],Ne[ce-1-Ue*2-ps]),z.get(Ct+ft*6+zs+bs)&&Ge.set(Ne[ce-1-Ue*2-ps],Ne[Ue*2+bs])}Ct+=ft*8}if(At.drawModeMessage(Ge,d,ze,ie),d)At.drawBullsEye(Ge,F.truncDivision(ze,2),5);else{At.drawBullsEye(Ge,F.truncDivision(ze,2),7);for(let Ue=0,Ct=0;Ue<F.truncDivision(ce,2)-1;Ue+=15,Ct+=16)for(let ft=F.truncDivision(ze,2)&1;ft<ze;ft+=2)Ge.set(F.truncDivision(ze,2)-Ct,ft),Ge.set(F.truncDivision(ze,2)+Ct,ft),Ge.set(ft,F.truncDivision(ze,2)-Ct),Ge.set(ft,F.truncDivision(ze,2)+Ct)}let Ye=new wn;return Ye.setCompact(d),Ye.setSize(ze),Ye.setLayers(h),Ye.setCodeWords(Y),Ye.setMatrix(Ge),Ye}static drawBullsEye(t,s,r){for(let a=0;a<r;a+=2)for(let i=s-a;i<=s+a;i++)t.set(i,s-a),t.set(i,s+a),t.set(s-a,i),t.set(s+a,i);t.set(s-r,s-r),t.set(s-r+1,s-r),t.set(s-r,s-r+1),t.set(s+r,s-r),t.set(s+r,s-r+1),t.set(s+r,s+r-1)}static generateModeMessage(t,s,r){let a=new U;return t?(a.appendBits(s-1,2),a.appendBits(r-1,6),a=At.generateCheckWords(a,28,4)):(a.appendBits(s-1,5),a.appendBits(r-1,11),a=At.generateCheckWords(a,40,4)),a}static drawModeMessage(t,s,r,a){let i=F.truncDivision(r,2);if(s)for(let o=0;o<7;o++){let d=i-3+o;a.get(o)&&t.set(d,i-5),a.get(o+7)&&t.set(i+5,d),a.get(20-o)&&t.set(d,i+5),a.get(27-o)&&t.set(i-5,d)}else for(let o=0;o<10;o++){let d=i-5+o+F.truncDivision(o,5);a.get(o)&&t.set(d,i-7),a.get(o+10)&&t.set(i+7,d),a.get(29-o)&&t.set(d,i+7),a.get(39-o)&&t.set(i-7,d)}}static generateCheckWords(t,s,r){let a=t.getSize()/r,i=new Ma(At.getGF(r)),o=F.truncDivision(s,r),d=At.bitsToWords(t,r,o);i.encode(d,o-a);let h=s%r,m=new U;m.appendBits(0,h);for(const y of Array.from(d))m.appendBits(y,r);return m}static bitsToWords(t,s,r){let a=new Int32Array(r),i,o;for(i=0,o=t.getSize()/s;i<o;i++){let d=0;for(let h=0;h<s;h++)d|=t.get(i*s+h)?1<<s-h-1:0;a[i]=d}return a}static getGF(t){switch(t){case 4:return Fe.AZTEC_PARAM;case 6:return Fe.AZTEC_DATA_6;case 8:return Fe.AZTEC_DATA_8;case 10:return Fe.AZTEC_DATA_10;case 12:return Fe.AZTEC_DATA_12;default:throw new p("Unsupported word size "+t)}}static stuffBits(t,s){let r=new U,a=t.getSize(),i=(1<<s)-2;for(let o=0;o<a;o+=s){let d=0;for(let h=0;h<s;h++)(o+h>=a||t.get(o+h))&&(d|=1<<s-1-h);(d&i)===i?(r.appendBits(d&i,s),o--):d&i?r.appendBits(d,s):(r.appendBits(d|1,s),o--)}return r}static totalBitsInLayer(t,s){return((s?88:112)+16*t)*t}}At.DEFAULT_EC_PERCENT=33,At.DEFAULT_AZTEC_LAYERS=0,At.MAX_NB_BITS=32,At.MAX_NB_BITS_COMPACT=4,At.WORD_SIZE=Int32Array.from([4,6,6,8,8,8,8,8,8,10,10,10,10,10,10,10,10,10,10,10,10,10,10,12,12,12,12,12,12,12,12,12,12]);class la{encode(t,s,r,a){return this.encodeWithHints(t,s,r,a,null)}encodeWithHints(t,s,r,a,i){let o=Oa.ISO_8859_1,d=At.DEFAULT_EC_PERCENT,h=At.DEFAULT_AZTEC_LAYERS;return i!=null&&(i.has(Qt.CHARACTER_SET)&&(o=bn.forName(i.get(Qt.CHARACTER_SET).toString())),i.has(Qt.ERROR_CORRECTION)&&(d=F.parseInt(i.get(Qt.ERROR_CORRECTION).toString())),i.has(Qt.AZTEC_LAYERS)&&(h=F.parseInt(i.get(Qt.AZTEC_LAYERS).toString()))),la.encodeLayers(t,s,r,a,o,d,h)}static encodeLayers(t,s,r,a,i,o,d){if(s!==de.AZTEC)throw new p("Can only encode AZTEC, but got "+s);let h=At.encode(X.getBytes(t,i),o,d);return la.renderResult(h,r,a)}static renderResult(t,s,r){let a=t.getMatrix();if(a==null)throw new rt;let i=a.getWidth(),o=a.getHeight(),d=Math.max(s,i),h=Math.max(r,o),m=Math.min(d/i,h/o),y=(d-i*m)/2,I=(h-o*m)/2,z=new W(d,h);for(let Y=0,ie=I;Y<o;Y++,ie+=m)for(let ce=0,Ne=y;ce<i;ce++,Ne+=m)a.get(ce,Y)&&z.setRegion(Ne,ie,m,m);return z}}c.AbstractExpandedDecoder=Mr,c.ArgumentException=E,c.ArithmeticException=je,c.AztecCode=wn,c.AztecCodeReader=_e,c.AztecCodeWriter=la,c.AztecDecoder=Qe,c.AztecDetector=Ee,c.AztecDetectorResult=H,c.AztecEncoder=At,c.AztecHighLevelEncoder=Ur,c.AztecPoint=le,c.BarcodeFormat=de,c.Binarizer=D,c.BinaryBitmap=k,c.BitArray=U,c.BitMatrix=W,c.BitSource=Gt,c.BrowserAztecCodeReader=J,c.BrowserBarcodeReader=nt,c.BrowserCodeReader=Z,c.BrowserDatamatrixCodeReader=Ws,c.BrowserMultiFormatReader=Qi,c.BrowserPDF417Reader=Ki,c.BrowserQRCodeReader=Ji,c.BrowserQRCodeSvgWriter=mr,c.CharacterSetECI=C,c.ChecksumException=P,c.Code128Reader=$,c.Code39Reader=ue,c.DataMatrixDecodedBitStreamParser=ts,c.DataMatrixReader=ss,c.DecodeHintType=N,c.DecoderResult=ve,c.DefaultGridSampler=Re,c.DetectorResult=De,c.EAN13Reader=It,c.EncodeHintType=Qt,c.Exception=g,c.FormatException=_,c.GenericGF=Fe,c.GenericGFPoly=we,c.GlobalHistogramBinarizer=B,c.GridSampler=he,c.GridSamplerInstance=ee,c.HTMLCanvasElementLuminanceSource=Q,c.HybridBinarizer=ne,c.ITFReader=xe,c.IllegalArgumentException=p,c.IllegalStateException=rt,c.InvertedLuminanceSource=me,c.LuminanceSource=ye,c.MathUtils=We,c.MultiFormatOneDReader=Ke,c.MultiFormatReader=pn,c.MultiFormatWriter=to,c.NotFoundException=G,c.OneDReader=ke,c.PDF417DecodedBitStreamParser=Me,c.PDF417DecoderErrorCorrection=un,c.PDF417Reader=as,c.PDF417ResultMetadata=xn,c.PerspectiveTransform=Ae,c.PlanarYUVLuminanceSource=Bs,c.QRCodeByteMatrix=ia,c.QRCodeDataMask=Is,c.QRCodeDecodedBitStreamParser=Ht,c.QRCodeDecoderErrorCorrectionLevel=wt,c.QRCodeDecoderFormatInformation=Vt,c.QRCodeEncoder=Bt,c.QRCodeEncoderQRCode=xr,c.QRCodeMaskUtil=Wt,c.QRCodeMatrixUtil=dt,c.QRCodeMode=lt,c.QRCodeReader=Ks,c.QRCodeVersion=it,c.QRCodeWriter=yr,c.RGBLuminanceSource=za,c.RSS14Reader=Pe,c.RSSExpandedReader=Be,c.ReaderException=na,c.ReedSolomonDecoder=st,c.ReedSolomonEncoder=Ma,c.ReedSolomonException=Ve,c.Result=L,c.ResultMetadataType=ge,c.ResultPoint=qe,c.StringUtils=X,c.UnsupportedOperationException=K,c.VideoInputDevice=fe,c.WhiteRectangleDetector=ae,c.WriterException=zt,c.ZXingArrays=T,c.ZXingCharset=bn,c.ZXingInteger=F,c.ZXingStandardCharsets=Oa,c.ZXingStringBuilder=se,c.ZXingStringEncoding=O,c.ZXingSystem=R,c.createAbstractExpandedDecoder=sa,Object.defineProperty(c,"__esModule",{value:!0})})})(Qa,Qa.exports);var Ft=Qa.exports;const pc=xo(Ft),bc=Io({__proto__:null,default:pc},[Ft]);var Un=function(){function n(l,c,u){if(this.formatMap=new Map([[tt.QR_CODE,Ft.BarcodeFormat.QR_CODE],[tt.AZTEC,Ft.BarcodeFormat.AZTEC],[tt.CODABAR,Ft.BarcodeFormat.CODABAR],[tt.CODE_39,Ft.BarcodeFormat.CODE_39],[tt.CODE_93,Ft.BarcodeFormat.CODE_93],[tt.CODE_128,Ft.BarcodeFormat.CODE_128],[tt.DATA_MATRIX,Ft.BarcodeFormat.DATA_MATRIX],[tt.MAXICODE,Ft.BarcodeFormat.MAXICODE],[tt.ITF,Ft.BarcodeFormat.ITF],[tt.EAN_13,Ft.BarcodeFormat.EAN_13],[tt.EAN_8,Ft.BarcodeFormat.EAN_8],[tt.PDF_417,Ft.BarcodeFormat.PDF_417],[tt.RSS_14,Ft.BarcodeFormat.RSS_14],[tt.RSS_EXPANDED,Ft.BarcodeFormat.RSS_EXPANDED],[tt.UPC_A,Ft.BarcodeFormat.UPC_A],[tt.UPC_E,Ft.BarcodeFormat.UPC_E],[tt.UPC_EAN_EXTENSION,Ft.BarcodeFormat.UPC_EAN_EXTENSION]]),this.reverseFormatMap=this.createReverseFormatMap(),!bc)throw"Use html5qrcode.min.js without edit, ZXing not found.";this.verbose=c,this.logger=u;var f=this.createZXingFormats(l),x=new Map;x.set(Ft.DecodeHintType.POSSIBLE_FORMATS,f),x.set(Ft.DecodeHintType.TRY_HARDER,!1),this.hints=x}return n.prototype.decodeAsync=function(l){var c=this;return new Promise(function(u,f){try{u(c.decode(l))}catch(x){f(x)}})},n.prototype.decode=function(l){var c=new Ft.MultiFormatReader(this.verbose,this.hints),u=new Ft.HTMLCanvasElementLuminanceSource(l),f=new Ft.BinaryBitmap(new Ft.HybridBinarizer(u)),x=c.decode(f);return{text:x.text,format:Di.create(this.toHtml5QrcodeSupportedFormats(x.format)),debugData:this.createDebugData()}},n.prototype.createReverseFormatMap=function(){var l=new Map;return this.formatMap.forEach(function(c,u,f){l.set(c,u)}),l},n.prototype.toHtml5QrcodeSupportedFormats=function(l){if(!this.reverseFormatMap.has(l))throw"reverseFormatMap doesn't have ".concat(l);return this.reverseFormatMap.get(l)},n.prototype.createZXingFormats=function(l){for(var c=[],u=0,f=l;u<f.length;u++){var x=f[u];this.formatMap.has(x)?c.push(this.formatMap.get(x)):this.logger.logError("".concat(x," is not supported by")+"ZXingHtml5QrcodeShim")}return c},n.prototype.createDebugData=function(){return{decoderName:"zxing-js"}},n}(),wc=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(E){try{g(u.next(E))}catch(p){b(p)}}function S(E){try{g(u.throw(E))}catch(p){b(p)}}function g(E){E.done?x(E.value):f(E.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},yc=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(E){return S([g,E])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(E){g=[6,E],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},Vn=function(){function n(l,c,u){if(this.formatMap=new Map([[tt.QR_CODE,"qr_code"],[tt.AZTEC,"aztec"],[tt.CODABAR,"codabar"],[tt.CODE_39,"code_39"],[tt.CODE_93,"code_93"],[tt.CODE_128,"code_128"],[tt.DATA_MATRIX,"data_matrix"],[tt.ITF,"itf"],[tt.EAN_13,"ean_13"],[tt.EAN_8,"ean_8"],[tt.PDF_417,"pdf417"],[tt.UPC_A,"upc_a"],[tt.UPC_E,"upc_e"]]),this.reverseFormatMap=this.createReverseFormatMap(),!n.isSupported())throw"Use html5qrcode.min.js without edit, Use BarcodeDetectorDelegate only if it isSupported();";this.verbose=c,this.logger=u;var f=this.createBarcodeDetectorFormats(l);if(this.detector=new BarcodeDetector(f),!this.detector)throw"BarcodeDetector detector not supported"}return n.isSupported=function(){if(!("BarcodeDetector"in window))return!1;var l=new BarcodeDetector({formats:["qr_code"]});return typeof l<"u"},n.prototype.decodeAsync=function(l){return wc(this,void 0,void 0,function(){var c,u;return yc(this,function(f){switch(f.label){case 0:return[4,this.detector.detect(l)];case 1:if(c=f.sent(),!c||c.length===0)throw"No barcode or QR code detected.";return u=this.selectLargestBarcode(c),[2,{text:u.rawValue,format:Di.create(this.toHtml5QrcodeSupportedFormats(u.format)),debugData:this.createDebugData()}]}})})},n.prototype.selectLargestBarcode=function(l){for(var c=null,u=0,f=0,x=l;f<x.length;f++){var b=x[f],v=b.boundingBox.width*b.boundingBox.height;v>u&&(u=v,c=b)}if(!c)throw"No largest barcode found";return c},n.prototype.createBarcodeDetectorFormats=function(l){for(var c=[],u=0,f=l;u<f.length;u++){var x=f[u];this.formatMap.has(x)?c.push(this.formatMap.get(x)):this.logger.warn("".concat(x," is not supported by")+"BarcodeDetectorDelegate")}return{formats:c}},n.prototype.toHtml5QrcodeSupportedFormats=function(l){if(!this.reverseFormatMap.has(l))throw"reverseFormatMap doesn't have ".concat(l);return this.reverseFormatMap.get(l)},n.prototype.createReverseFormatMap=function(){var l=new Map;return this.formatMap.forEach(function(c,u,f){l.set(c,u)}),l},n.prototype.createDebugData=function(){return{decoderName:"BarcodeDetector"}},n}(),Hn=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(E){try{g(u.next(E))}catch(p){b(p)}}function S(E){try{g(u.throw(E))}catch(p){b(p)}}function g(E){E.done?x(E.value):f(E.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},qn=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(E){return S([g,E])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(E){g=[6,E],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},_c=function(){function n(l,c,u,f){this.EXECUTIONS_TO_REPORT_PERFORMANCE=100,this.executions=0,this.executionResults=[],this.wasPrimaryDecoderUsedInLastDecode=!1,this.verbose=u,c&&Vn.isSupported()?(this.primaryDecoder=new Vn(l,u,f),this.secondaryDecoder=new Un(l,u,f)):this.primaryDecoder=new Un(l,u,f)}return n.prototype.decodeAsync=function(l){return Hn(this,void 0,void 0,function(){var c;return qn(this,function(u){switch(u.label){case 0:c=performance.now(),u.label=1;case 1:return u.trys.push([1,,3,4]),[4,this.getDecoder().decodeAsync(l)];case 2:return[2,u.sent()];case 3:return this.possiblyLogPerformance(c),[7];case 4:return[2]}})})},n.prototype.decodeRobustlyAsync=function(l){return Hn(this,void 0,void 0,function(){var c,u;return qn(this,function(f){switch(f.label){case 0:c=performance.now(),f.label=1;case 1:return f.trys.push([1,3,4,5]),[4,this.primaryDecoder.decodeAsync(l)];case 2:return[2,f.sent()];case 3:if(u=f.sent(),this.secondaryDecoder)return[2,this.secondaryDecoder.decodeAsync(l)];throw u;case 4:return this.possiblyLogPerformance(c),[7];case 5:return[2]}})})},n.prototype.getDecoder=function(){return this.secondaryDecoder?this.wasPrimaryDecoderUsedInLastDecode===!1?(this.wasPrimaryDecoderUsedInLastDecode=!0,this.primaryDecoder):(this.wasPrimaryDecoderUsedInLastDecode=!1,this.secondaryDecoder):this.primaryDecoder},n.prototype.possiblyLogPerformance=function(l){if(this.verbose){var c=performance.now()-l;this.executionResults.push(c),this.executions++,this.possiblyFlushPerformanceReport()}},n.prototype.possiblyFlushPerformanceReport=function(){if(!(this.executions<this.EXECUTIONS_TO_REPORT_PERFORMANCE)){for(var l=0,c=0,u=this.executionResults;c<u.length;c++){var f=u[c];l+=f}var x=l/this.executionResults.length;console.log("".concat(x," ms for ").concat(this.executionResults.length," last runs.")),this.executions=0,this.executionResults=[]}},n}(),an=function(){var n=function(l,c){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(u,f){u.__proto__=f}||function(u,f){for(var x in f)Object.prototype.hasOwnProperty.call(f,x)&&(u[x]=f[x])},n(l,c)};return function(l,c){if(typeof c!="function"&&c!==null)throw new TypeError("Class extends value "+String(c)+" is not a constructor or null");n(l,c);function u(){this.constructor=l}l.prototype=c===null?Object.create(c):(u.prototype=c.prototype,new u)}}(),ya=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(E){try{g(u.next(E))}catch(p){b(p)}}function S(E){try{g(u.throw(E))}catch(p){b(p)}}function g(E){E.done?x(E.value):f(E.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},_a=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(E){return S([g,E])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(E){g=[6,E],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},Oi=function(){function n(l,c){this.name=l,this.track=c}return n.prototype.isSupported=function(){return this.track.getCapabilities?this.name in this.track.getCapabilities():!1},n.prototype.apply=function(l){var c={};c[this.name]=l;var u={advanced:[c]};return this.track.applyConstraints(u)},n.prototype.value=function(){var l=this.track.getSettings();if(this.name in l){var c=l[this.name];return c}return null},n}(),vc=function(n){an(l,n);function l(c,u){return n.call(this,c,u)||this}return l.prototype.min=function(){return this.getCapabilities().min},l.prototype.max=function(){return this.getCapabilities().max},l.prototype.step=function(){return this.getCapabilities().step},l.prototype.apply=function(c){var u={};u[this.name]=c;var f={advanced:[u]};return this.track.applyConstraints(f)},l.prototype.getCapabilities=function(){this.failIfNotSupported();var c=this.track.getCapabilities(),u=c[this.name];return{min:u.min,max:u.max,step:u.step}},l.prototype.failIfNotSupported=function(){if(!this.isSupported())throw new Error("".concat(this.name," capability not supported"))},l}(Oi),Nc=function(n){an(l,n);function l(c){return n.call(this,"zoom",c)||this}return l}(vc),jc=function(n){an(l,n);function l(c){return n.call(this,"torch",c)||this}return l}(Oi),Cc=function(){function n(l){this.track=l}return n.prototype.zoomFeature=function(){return new Nc(this.track)},n.prototype.torchFeature=function(){return new jc(this.track)},n}(),Ec=function(){function n(l,c,u){this.isClosed=!1,this.parentElement=l,this.mediaStream=c,this.callbacks=u,this.surface=this.createVideoElement(this.parentElement.clientWidth),l.append(this.surface)}return n.prototype.createVideoElement=function(l){var c=document.createElement("video");return c.style.width="".concat(l,"px"),c.style.display="block",c.muted=!0,c.setAttribute("muted","true"),c.playsInline=!0,c},n.prototype.setupSurface=function(){var l=this;this.surface.onabort=function(){throw"RenderedCameraImpl video surface onabort() called"},this.surface.onerror=function(){throw"RenderedCameraImpl video surface onerror() called"};var c=function(){var u=l.surface.clientWidth,f=l.surface.clientHeight;l.callbacks.onRenderSurfaceReady(u,f),l.surface.removeEventListener("playing",c)};this.surface.addEventListener("playing",c),this.surface.srcObject=this.mediaStream,this.surface.play()},n.create=function(l,c,u,f){return ya(this,void 0,void 0,function(){var x,b;return _a(this,function(v){switch(v.label){case 0:return x=new n(l,c,f),u.aspectRatio?(b={aspectRatio:u.aspectRatio},[4,x.getFirstTrackOrFail().applyConstraints(b)]):[3,2];case 1:v.sent(),v.label=2;case 2:return x.setupSurface(),[2,x]}})})},n.prototype.failIfClosed=function(){if(this.isClosed)throw"The RenderedCamera has already been closed."},n.prototype.getFirstTrackOrFail=function(){if(this.failIfClosed(),this.mediaStream.getVideoTracks().length===0)throw"No video tracks found";return this.mediaStream.getVideoTracks()[0]},n.prototype.pause=function(){this.failIfClosed(),this.surface.pause()},n.prototype.resume=function(l){this.failIfClosed();var c=this,u=function(){setTimeout(l,200),c.surface.removeEventListener("playing",u)};this.surface.addEventListener("playing",u),this.surface.play()},n.prototype.isPaused=function(){return this.failIfClosed(),this.surface.paused},n.prototype.getSurface=function(){return this.failIfClosed(),this.surface},n.prototype.getRunningTrackCapabilities=function(){return this.getFirstTrackOrFail().getCapabilities()},n.prototype.getRunningTrackSettings=function(){return this.getFirstTrackOrFail().getSettings()},n.prototype.applyVideoConstraints=function(l){return ya(this,void 0,void 0,function(){return _a(this,function(c){if("aspectRatio"in l)throw"Changing 'aspectRatio' in run-time is not yet supported.";return[2,this.getFirstTrackOrFail().applyConstraints(l)]})})},n.prototype.close=function(){if(this.isClosed)return Promise.resolve();var l=this;return new Promise(function(c,u){var f=l.mediaStream.getVideoTracks(),x=f.length,b=0;l.mediaStream.getVideoTracks().forEach(function(v){l.mediaStream.removeTrack(v),v.stop(),++b,b>=x&&(l.isClosed=!0,l.parentElement.removeChild(l.surface),c())})})},n.prototype.getCapabilities=function(){return new Cc(this.getFirstTrackOrFail())},n}(),Sc=function(){function n(l){this.mediaStream=l}return n.prototype.render=function(l,c,u){return ya(this,void 0,void 0,function(){return _a(this,function(f){return[2,Ec.create(l,this.mediaStream,c,u)]})})},n.create=function(l){return ya(this,void 0,void 0,function(){var c,u;return _a(this,function(f){switch(f.label){case 0:if(!navigator.mediaDevices)throw"navigator.mediaDevices not supported";return c={audio:!1,video:l},[4,navigator.mediaDevices.getUserMedia(c)];case 1:return u=f.sent(),[2,new n(u)]}})})},n}(),Gn=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(E){try{g(u.next(E))}catch(p){b(p)}}function S(E){try{g(u.throw(E))}catch(p){b(p)}}function g(E){E.done?x(E.value):f(E.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},Wn=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(E){return S([g,E])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(E){g=[6,E],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},Ac=function(){function n(){}return n.failIfNotSupported=function(){return Gn(this,void 0,void 0,function(){return Wn(this,function(l){if(!navigator.mediaDevices)throw"navigator.mediaDevices not supported";return[2,new n]})})},n.prototype.create=function(l){return Gn(this,void 0,void 0,function(){return Wn(this,function(c){return[2,Sc.create(l)]})})},n}(),Ic=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(E){try{g(u.next(E))}catch(p){b(p)}}function S(E){try{g(u.throw(E))}catch(p){b(p)}}function g(E){E.done?x(E.value):f(E.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},Tc=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(E){return S([g,E])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(E){g=[6,E],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},Dc=function(){function n(){}return n.retrieve=function(){if(navigator.mediaDevices)return n.getCamerasFromMediaDevices();var l=MediaStreamTrack;return MediaStreamTrack&&l.getSources?n.getCamerasFromMediaStreamTrack():n.rejectWithError()},n.rejectWithError=function(){var l=Er.unableToQuerySupportedDevices();return n.isHttpsOrLocalhost()||(l=Er.insecureContextCameraQueryError()),Promise.reject(l)},n.isHttpsOrLocalhost=function(){if(location.protocol==="https:")return!0;var l=location.host.split(":")[0];return l==="127.0.0.1"||l==="localhost"},n.getCamerasFromMediaDevices=function(){return Ic(this,void 0,void 0,function(){var l,c,u,f,x,b,v;return Tc(this,function(S){switch(S.label){case 0:return l=function(g){for(var E=g.getVideoTracks(),p=0,k=E;p<k.length;p++){var P=k[p];P.enabled=!1,P.stop(),g.removeTrack(P)}},[4,navigator.mediaDevices.getUserMedia({audio:!1,video:!0})];case 1:return c=S.sent(),[4,navigator.mediaDevices.enumerateDevices()];case 2:for(u=S.sent(),f=[],x=0,b=u;x<b.length;x++)v=b[x],v.kind==="videoinput"&&f.push({id:v.deviceId,label:v.label});return l(c),[2,f]}})})},n.getCamerasFromMediaStreamTrack=function(){return new Promise(function(l,c){var u=function(x){for(var b=[],v=0,S=x;v<S.length;v++){var g=S[v];g.kind==="video"&&b.push({id:g.id,label:g.label})}l(b)},f=MediaStreamTrack;f.getSources(u)})},n}(),Yt;(function(n){n[n.UNKNOWN=0]="UNKNOWN",n[n.NOT_STARTED=1]="NOT_STARTED",n[n.SCANNING=2]="SCANNING",n[n.PAUSED=3]="PAUSED"})(Yt||(Yt={}));var kc=function(){function n(){this.state=Yt.NOT_STARTED,this.onGoingTransactionNewState=Yt.UNKNOWN}return n.prototype.directTransition=function(l){this.failIfTransitionOngoing(),this.validateTransition(l),this.state=l},n.prototype.startTransition=function(l){return this.failIfTransitionOngoing(),this.validateTransition(l),this.onGoingTransactionNewState=l,this},n.prototype.execute=function(){if(this.onGoingTransactionNewState===Yt.UNKNOWN)throw"Transaction is already cancelled, cannot execute().";var l=this.onGoingTransactionNewState;this.onGoingTransactionNewState=Yt.UNKNOWN,this.directTransition(l)},n.prototype.cancel=function(){if(this.onGoingTransactionNewState===Yt.UNKNOWN)throw"Transaction is already cancelled, cannot cancel().";this.onGoingTransactionNewState=Yt.UNKNOWN},n.prototype.getState=function(){return this.state},n.prototype.failIfTransitionOngoing=function(){if(this.onGoingTransactionNewState!==Yt.UNKNOWN)throw"Cannot transition to a new state, already under transition"},n.prototype.validateTransition=function(l){switch(this.state){case Yt.UNKNOWN:throw"Transition from unknown is not allowed";case Yt.NOT_STARTED:this.failIfNewStateIs(l,[Yt.PAUSED]);break;case Yt.SCANNING:break;case Yt.PAUSED:break}},n.prototype.failIfNewStateIs=function(l,c){for(var u=0,f=c;u<f.length;u++){var x=f[u];if(l===x)throw"Cannot transition from ".concat(this.state," to ").concat(l)}},n}(),Mc=function(){function n(l){this.stateManager=l}return n.prototype.startTransition=function(l){return this.stateManager.startTransition(l)},n.prototype.directTransition=function(l){this.stateManager.directTransition(l)},n.prototype.getState=function(){return this.stateManager.getState()},n.prototype.canScanFile=function(){return this.stateManager.getState()===Yt.NOT_STARTED},n.prototype.isScanning=function(){return this.stateManager.getState()!==Yt.NOT_STARTED},n.prototype.isStrictlyScanning=function(){return this.stateManager.getState()===Yt.SCANNING},n.prototype.isPaused=function(){return this.stateManager.getState()===Yt.PAUSED},n}(),zc=function(){function n(){}return n.create=function(){return new Mc(new kc)},n}(),Oc=function(){var n=function(l,c){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(u,f){u.__proto__=f}||function(u,f){for(var x in f)Object.prototype.hasOwnProperty.call(f,x)&&(u[x]=f[x])},n(l,c)};return function(l,c){if(typeof c!="function"&&c!==null)throw new TypeError("Class extends value "+String(c)+" is not a constructor or null");n(l,c);function u(){this.constructor=l}l.prototype=c===null?Object.create(c):(u.prototype=c.prototype,new u)}}(),_s=function(n){Oc(l,n);function l(){return n!==null&&n.apply(this,arguments)||this}return l.DEFAULT_WIDTH=300,l.DEFAULT_WIDTH_OFFSET=2,l.FILE_SCAN_MIN_HEIGHT=300,l.FILE_SCAN_HIDDEN_CANVAS_PADDING=100,l.MIN_QR_BOX_SIZE=50,l.SHADED_LEFT=1,l.SHADED_RIGHT=2,l.SHADED_TOP=3,l.SHADED_BOTTOM=4,l.SHADED_REGION_ELEMENT_ID="qr-shaded-region",l.VERBOSE=!1,l.BORDER_SHADER_DEFAULT_COLOR="#ffffff",l.BORDER_SHADER_MATCH_COLOR="rgb(90, 193, 56)",l}(Rs),Rc=function(){function n(l,c){this.logger=c,this.fps=_s.SCAN_DEFAULT_FPS,l?(l.fps&&(this.fps=l.fps),this.disableFlip=l.disableFlip===!0,this.qrbox=l.qrbox,this.aspectRatio=l.aspectRatio,this.videoConstraints=l.videoConstraints):this.disableFlip=_s.DEFAULT_DISABLE_FLIP}return n.prototype.isMediaStreamConstraintsValid=function(){return this.videoConstraints?zi.isMediaStreamConstraintsValid(this.videoConstraints,this.logger):(this.logger.logError("Empty videoConstraints",!0),!1)},n.prototype.isShadedBoxEnabled=function(){return!Vs(this.qrbox)},n.create=function(l,c){return new n(l,c)},n}(),Yn=function(){function n(l,c){if(this.element=null,this.canvasElement=null,this.scannerPausedUiElement=null,this.hasBorderShaders=null,this.borderShaders=null,this.qrMatch=null,this.renderedCamera=null,this.qrRegion=null,this.context=null,this.lastScanImageFile=null,this.isScanning=!1,!document.getElementById(l))throw"HTML Element with id=".concat(l," not found");this.elementId=l,this.verbose=!1;var u;typeof c=="boolean"?this.verbose=c===!0:c&&(u=c,this.verbose=u.verbose===!0,u.experimentalFeatures),this.logger=new Mi(this.verbose),this.qrcode=new _c(this.getSupportedFormats(c),this.getUseBarCodeDetectorIfSupported(u),this.verbose,this.logger),this.foreverScanTimeout,this.shouldScan=!0,this.stateManagerProxy=zc.create()}return n.prototype.start=function(l,c,u,f){var x=this;if(!l)throw"cameraIdOrConfig is required";if(!u||typeof u!="function")throw"qrCodeSuccessCallback is required and should be a function.";var b;f?b=f:b=this.verbose?this.logger.log:function(){};var v=Rc.create(c,this.logger);this.clearElement();var S=!1;v.videoConstraints&&(v.isMediaStreamConstraintsValid()?S=!0:this.logger.logError("'videoConstraints' is not valid 'MediaStreamConstraints, it will be ignored.'",!0));var g=S,E=document.getElementById(this.elementId);E.clientWidth?E.clientWidth:_s.DEFAULT_WIDTH,E.style.position="relative",this.shouldScan=!0,this.element=E;var p=this,k=this.stateManagerProxy.startTransition(Yt.SCANNING);return new Promise(function(P,D){var R=g?v.videoConstraints:p.createVideoConstraints(l);if(!R){k.cancel(),D("videoConstraints should be defined");return}var j={};(!g||v.aspectRatio)&&(j.aspectRatio=v.aspectRatio);var M={onRenderSurfaceReady:function(T,F){p.setupUi(T,F,v),p.isScanning=!0,p.foreverScan(v,u,b)}};Ac.failIfNotSupported().then(function(T){T.create(R).then(function(F){return F.render(x.element,j,M).then(function(U){p.renderedCamera=U,k.execute(),P(null)}).catch(function(U){k.cancel(),D(U)})}).catch(function(F){k.cancel(),D(Er.errorGettingUserMedia(F))})}).catch(function(T){k.cancel(),D(Er.cameraStreamingNotSupported())})})},n.prototype.pause=function(l){if(!this.stateManagerProxy.isStrictlyScanning())throw"Cannot pause, scanner is not scanning.";this.stateManagerProxy.directTransition(Yt.PAUSED),this.showPausedState(),(Vs(l)||l!==!0)&&(l=!1),l&&this.renderedCamera&&this.renderedCamera.pause()},n.prototype.resume=function(){if(!this.stateManagerProxy.isPaused())throw"Cannot result, scanner is not paused.";if(!this.renderedCamera)throw"renderedCamera doesn't exist while trying resume()";var l=this,c=function(){l.stateManagerProxy.directTransition(Yt.SCANNING),l.hidePausedState()};if(!this.renderedCamera.isPaused()){c();return}this.renderedCamera.resume(function(){c()})},n.prototype.getState=function(){return this.stateManagerProxy.getState()},n.prototype.stop=function(){var l=this;if(!this.stateManagerProxy.isScanning())throw"Cannot stop, scanner is not running or paused.";var c=this.stateManagerProxy.startTransition(Yt.NOT_STARTED);this.shouldScan=!1,this.foreverScanTimeout&&clearTimeout(this.foreverScanTimeout);var u=function(){if(l.element){var x=document.getElementById(_s.SHADED_REGION_ELEMENT_ID);x&&l.element.removeChild(x)}},f=this;return this.renderedCamera.close().then(function(){return f.renderedCamera=null,f.element&&(f.element.removeChild(f.canvasElement),f.canvasElement=null),u(),f.qrRegion&&(f.qrRegion=null),f.context&&(f.context=null),c.execute(),f.hidePausedState(),f.isScanning=!1,Promise.resolve()})},n.prototype.scanFile=function(l,c){return this.scanFileV2(l,c).then(function(u){return u.decodedText})},n.prototype.scanFileV2=function(l,c){var u=this;if(!l||!(l instanceof File))throw"imageFile argument is mandatory and should be instance of File. Use 'event.target.files[0]'.";if(Vs(c)&&(c=!0),!this.stateManagerProxy.canScanFile())throw"Cannot start file scan - ongoing camera scan";return new Promise(function(f,x){u.possiblyCloseLastScanImageFile(),u.clearElement(),u.lastScanImageFile=URL.createObjectURL(l);var b=new Image;b.onload=function(){var v=b.width,S=b.height,g=document.getElementById(u.elementId),E=g.clientWidth?g.clientWidth:_s.DEFAULT_WIDTH,p=Math.max(g.clientHeight?g.clientHeight:S,_s.FILE_SCAN_MIN_HEIGHT),k=u.computeCanvasDrawConfig(v,S,E,p);if(c){var P=u.createCanvasElement(E,p,"qr-canvas-visible");P.style.display="inline-block",g.appendChild(P);var D=P.getContext("2d");if(!D)throw"Unable to get 2d context from canvas";D.canvas.width=E,D.canvas.height=p,D.drawImage(b,0,0,v,S,k.x,k.y,k.width,k.height)}var R=_s.FILE_SCAN_HIDDEN_CANVAS_PADDING,j=Math.max(b.width,k.width),M=Math.max(b.height,k.height),T=j+2*R,F=M+2*R,U=u.createCanvasElement(T,F);g.appendChild(U);var te=U.getContext("2d");if(!te)throw"Unable to get 2d context from canvas";te.canvas.width=T,te.canvas.height=F,te.drawImage(b,0,0,v,S,R,R,j,M);try{u.qrcode.decodeRobustlyAsync(U).then(function(N){f(Bn.createFromQrcodeResult(N))}).catch(x)}catch(N){x("QR code parse error, error = ".concat(N))}},b.onerror=x,b.onabort=x,b.onstalled=x,b.onsuspend=x,b.src=URL.createObjectURL(l)})},n.prototype.clear=function(){this.clearElement()},n.getCameras=function(){return Dc.retrieve()},n.prototype.getRunningTrackCapabilities=function(){return this.getRenderedCameraOrFail().getRunningTrackCapabilities()},n.prototype.getRunningTrackSettings=function(){return this.getRenderedCameraOrFail().getRunningTrackSettings()},n.prototype.getRunningTrackCameraCapabilities=function(){return this.getRenderedCameraOrFail().getCapabilities()},n.prototype.applyVideoConstraints=function(l){if(l){if(!zi.isMediaStreamConstraintsValid(l,this.logger))throw"invalid videoConstaints passed, check logs for more details"}else throw"videoConstaints is required argument.";return this.getRenderedCameraOrFail().applyVideoConstraints(l)},n.prototype.getRenderedCameraOrFail=function(){if(this.renderedCamera==null)throw"Scanning is not in running state, call this API only when QR code scanning using camera is in running state.";return this.renderedCamera},n.prototype.getSupportedFormats=function(l){var c=[tt.QR_CODE,tt.AZTEC,tt.CODABAR,tt.CODE_39,tt.CODE_93,tt.CODE_128,tt.DATA_MATRIX,tt.MAXICODE,tt.ITF,tt.EAN_13,tt.EAN_8,tt.PDF_417,tt.RSS_14,tt.RSS_EXPANDED,tt.UPC_A,tt.UPC_E,tt.UPC_EAN_EXTENSION];if(!l||typeof l=="boolean"||!l.formatsToSupport)return c;if(!Array.isArray(l.formatsToSupport))throw"configOrVerbosityFlag.formatsToSupport should be undefined or an array.";if(l.formatsToSupport.length===0)throw"Atleast 1 formatsToSupport is needed.";for(var u=[],f=0,x=l.formatsToSupport;f<x.length;f++){var b=x[f];fc(b)?u.push(b):this.logger.warn("Invalid format: ".concat(b," passed in config, ignoring."))}if(u.length===0)throw"None of formatsToSupport match supported values.";return u},n.prototype.getUseBarCodeDetectorIfSupported=function(l){if(Vs(l))return!0;if(!Vs(l.useBarCodeDetectorIfSupported))return l.useBarCodeDetectorIfSupported!==!1;if(Vs(l.experimentalFeatures))return!0;var c=l.experimentalFeatures;return Vs(c.useBarCodeDetectorIfSupported)?!0:c.useBarCodeDetectorIfSupported!==!1},n.prototype.validateQrboxSize=function(l,c,u){var f=this,x=u.qrbox;this.validateQrboxConfig(x);var b=this.toQrdimensions(l,c,x),v=function(g){if(g<_s.MIN_QR_BOX_SIZE)throw"minimum size of 'config.qrbox' dimension value is"+" ".concat(_s.MIN_QR_BOX_SIZE,"px.")},S=function(g){return g>l&&(f.logger.warn("`qrbox.width` or `qrbox` is larger than the width of the root element. The width will be truncated to the width of root element."),g=l),g};v(b.width),v(b.height),b.width=S(b.width)},n.prototype.validateQrboxConfig=function(l){if(typeof l!="number"&&typeof l!="function"&&(l.width===void 0||l.height===void 0))throw"Invalid instance of QrDimensions passed for 'config.qrbox'. Both 'width' and 'height' should be set."},n.prototype.toQrdimensions=function(l,c,u){if(typeof u=="number")return{width:u,height:u};if(typeof u=="function")try{return u(l,c)}catch(f){throw new Error("qrbox config was passed as a function but it failed with unknown error"+f)}return u},n.prototype.setupUi=function(l,c,u){u.isShadedBoxEnabled()&&this.validateQrboxSize(l,c,u);var f=Vs(u.qrbox)?{width:l,height:c}:u.qrbox;this.validateQrboxConfig(f);var x=this.toQrdimensions(l,c,f);x.height>c&&this.logger.warn("[Html5Qrcode] config.qrbox has height that isgreater than the height of the video stream. Shading will be ignored");var b=u.isShadedBoxEnabled()&&x.height<=c,v={x:0,y:0,width:l,height:c},S=b?this.getShadedRegionBounds(l,c,x):v,g=this.createCanvasElement(S.width,S.height),E={willReadFrequently:!0},p=g.getContext("2d",E);p.canvas.width=S.width,p.canvas.height=S.height,this.element.append(g),b&&this.possiblyInsertShadingElement(this.element,l,c,x),this.createScannerPausedUiElement(this.element),this.qrRegion=S,this.context=p,this.canvasElement=g},n.prototype.createScannerPausedUiElement=function(l){var c=document.createElement("div");c.innerText=Er.scannerPaused(),c.style.display="none",c.style.position="absolute",c.style.top="0px",c.style.zIndex="1",c.style.background="rgba(9, 9, 9, 0.46)",c.style.color="#FFECEC",c.style.textAlign="center",c.style.width="100%",l.appendChild(c),this.scannerPausedUiElement=c},n.prototype.scanContext=function(l,c){var u=this;return this.stateManagerProxy.isPaused()?Promise.resolve(!1):this.qrcode.decodeAsync(this.canvasElement).then(function(f){return l(f.text,Bn.createFromQrcodeResult(f)),u.possiblyUpdateShaders(!0),!0}).catch(function(f){u.possiblyUpdateShaders(!1);var x=Er.codeParseError(f);return c(x,ki.createFrom(x)),!1})},n.prototype.foreverScan=function(l,c,u){var f=this;if(this.shouldScan&&this.renderedCamera){var x=this.renderedCamera.getSurface(),b=x.videoWidth/x.clientWidth,v=x.videoHeight/x.clientHeight;if(!this.qrRegion)throw"qrRegion undefined when localMediaStream is ready.";var S=this.qrRegion.width*b,g=this.qrRegion.height*v,E=this.qrRegion.x*b,p=this.qrRegion.y*v;this.context.drawImage(x,E,p,S,g,0,0,this.qrRegion.width,this.qrRegion.height);var k=function(){f.foreverScanTimeout=setTimeout(function(){f.foreverScan(l,c,u)},f.getTimeoutFps(l.fps))};this.scanContext(c,u).then(function(P){!P&&l.disableFlip!==!0?(f.context.translate(f.context.canvas.width,0),f.context.scale(-1,1),f.scanContext(c,u).finally(function(){k()})):k()}).catch(function(P){f.logger.logError("Error happend while scanning context",P),k()})}},n.prototype.createVideoConstraints=function(l){if(typeof l=="string")return{deviceId:{exact:l}};if(typeof l=="object"){var c="facingMode",u="deviceId",f={user:!0,environment:!0},x="exact",b=function(D){if(D in f)return!0;throw"config has invalid 'facingMode' value = "+"'".concat(D,"'")},v=Object.keys(l);if(v.length!==1)throw"'cameraIdOrConfig' object should have exactly 1 key,"+" if passed as an object, found ".concat(v.length," keys");var S=Object.keys(l)[0];if(S!==c&&S!==u)throw"Only '".concat(c,"' and '").concat(u,"' ")+" are supported for 'cameraIdOrConfig'";if(S===c){var g=l.facingMode;if(typeof g=="string"){if(b(g))return{facingMode:g}}else if(typeof g=="object")if(x in g){if(b(g["".concat(x)]))return{facingMode:{exact:g["".concat(x)]}}}else throw"'facingMode' should be string or object with"+" ".concat(x," as key.");else{var E=typeof g;throw"Invalid type of 'facingMode' = ".concat(E)}}else{var p=l.deviceId;if(typeof p=="string")return{deviceId:p};if(typeof p=="object"){if(x in p)return{deviceId:{exact:p["".concat(x)]}};throw"'deviceId' should be string or object with"+" ".concat(x," as key.")}else{var k=typeof p;throw"Invalid type of 'deviceId' = ".concat(k)}}}var P=typeof l;throw"Invalid type of 'cameraIdOrConfig' = ".concat(P)},n.prototype.computeCanvasDrawConfig=function(l,c,u,f){if(l<=u&&c<=f){var x=(u-l)/2,b=(f-c)/2;return{x,y:b,width:l,height:c}}else{var v=l,S=c;return l>u&&(c=u/l*c,l=u),c>f&&(l=f/c*l,c=f),this.logger.log("Image downsampled from "+"".concat(v,"X").concat(S)+" to ".concat(l,"X").concat(c,".")),this.computeCanvasDrawConfig(l,c,u,f)}},n.prototype.clearElement=function(){if(this.stateManagerProxy.isScanning())throw"Cannot clear while scan is ongoing, close it first.";var l=document.getElementById(this.elementId);l&&(l.innerHTML="")},n.prototype.possiblyUpdateShaders=function(l){this.qrMatch!==l&&(this.hasBorderShaders&&this.borderShaders&&this.borderShaders.length&&this.borderShaders.forEach(function(c){c.style.backgroundColor=l?_s.BORDER_SHADER_MATCH_COLOR:_s.BORDER_SHADER_DEFAULT_COLOR}),this.qrMatch=l)},n.prototype.possiblyCloseLastScanImageFile=function(){this.lastScanImageFile&&(URL.revokeObjectURL(this.lastScanImageFile),this.lastScanImageFile=null)},n.prototype.createCanvasElement=function(l,c,u){var f=l,x=c,b=document.createElement("canvas");return b.style.width="".concat(f,"px"),b.style.height="".concat(x,"px"),b.style.display="none",b.id=Vs(u)?"qr-canvas":u,b},n.prototype.getShadedRegionBounds=function(l,c,u){if(u.width>l||u.height>c)throw"'config.qrbox' dimensions should not be greater than the dimensions of the root HTML element.";return{x:(l-u.width)/2,y:(c-u.height)/2,width:u.width,height:u.height}},n.prototype.possiblyInsertShadingElement=function(l,c,u,f){if(!(c-f.width<1||u-f.height<1)){var x=document.createElement("div");x.style.position="absolute";var b=(c-f.width)/2,v=(u-f.height)/2;if(x.style.borderLeft="".concat(b,"px solid rgba(0, 0, 0, 0.48)"),x.style.borderRight="".concat(b,"px solid rgba(0, 0, 0, 0.48)"),x.style.borderTop="".concat(v,"px solid rgba(0, 0, 0, 0.48)"),x.style.borderBottom="".concat(v,"px solid rgba(0, 0, 0, 0.48)"),x.style.boxSizing="border-box",x.style.top="0px",x.style.bottom="0px",x.style.left="0px",x.style.right="0px",x.id="".concat(_s.SHADED_REGION_ELEMENT_ID),c-f.width<11||u-f.height<11)this.hasBorderShaders=!1;else{var S=5,g=40;this.insertShaderBorders(x,g,S,-S,null,0,!0),this.insertShaderBorders(x,g,S,-S,null,0,!1),this.insertShaderBorders(x,g,S,null,-S,0,!0),this.insertShaderBorders(x,g,S,null,-S,0,!1),this.insertShaderBorders(x,S,g+S,-S,null,-S,!0),this.insertShaderBorders(x,S,g+S,null,-S,-S,!0),this.insertShaderBorders(x,S,g+S,-S,null,-S,!1),this.insertShaderBorders(x,S,g+S,null,-S,-S,!1),this.hasBorderShaders=!0}l.append(x)}},n.prototype.insertShaderBorders=function(l,c,u,f,x,b,v){var S=document.createElement("div");S.style.position="absolute",S.style.backgroundColor=_s.BORDER_SHADER_DEFAULT_COLOR,S.style.width="".concat(c,"px"),S.style.height="".concat(u,"px"),f!==null&&(S.style.top="".concat(f,"px")),x!==null&&(S.style.bottom="".concat(x,"px")),v?S.style.left="".concat(b,"px"):S.style.right="".concat(b,"px"),this.borderShaders||(this.borderShaders=[]),this.borderShaders.push(S),l.appendChild(S)},n.prototype.showPausedState=function(){if(!this.scannerPausedUiElement)throw"[internal error] scanner paused UI element not found";this.scannerPausedUiElement.style.display="block"},n.prototype.hidePausedState=function(){if(!this.scannerPausedUiElement)throw"[internal error] scanner paused UI element not found";this.scannerPausedUiElement.style.display="none"},n.prototype.getTimeoutFps=function(l){return 1e3/l},n}(),nn="data:image/svg+xml;base64,",Lc=nn+"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzNzEuNjQzIDM3MS42NDMiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDM3MS42NDMgMzcxLjY0MyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZD0iTTEwNS4wODQgMzguMjcxaDE2My43Njh2MjBIMTA1LjA4NHoiLz48cGF0aCBkPSJNMzExLjU5NiAxOTAuMTg5Yy03LjQ0MS05LjM0Ny0xOC40MDMtMTYuMjA2LTMyLjc0My0yMC41MjJWMzBjMC0xNi41NDItMTMuNDU4LTMwLTMwLTMwSDEyNS4wODRjLTE2LjU0MiAwLTMwIDEzLjQ1OC0zMCAzMHYxMjAuMTQzaC04LjI5NmMtMTYuNTQyIDAtMzAgMTMuNDU4LTMwIDMwdjEuMzMzYTI5LjgwNCAyOS44MDQgMCAwIDAgNC42MDMgMTUuOTM5Yy03LjM0IDUuNDc0LTEyLjEwMyAxNC4yMjEtMTIuMTAzIDI0LjA2MXYxLjMzM2MwIDkuODQgNC43NjMgMTguNTg3IDEyLjEwMyAyNC4wNjJhMjkuODEgMjkuODEgMCAwIDAtNC42MDMgMTUuOTM4djEuMzMzYzAgMTYuNTQyIDEzLjQ1OCAzMCAzMCAzMGg4LjMyNGMuNDI3IDExLjYzMSA3LjUwMyAyMS41ODcgMTcuNTM0IDI2LjE3Ny45MzEgMTAuNTAzIDQuMDg0IDMwLjE4NyAxNC43NjggNDUuNTM3YTkuOTg4IDkuOTg4IDAgMCAwIDguMjE2IDQuMjg4IDkuOTU4IDkuOTU4IDAgMCAwIDUuNzA0LTEuNzkzYzQuNTMzLTMuMTU1IDUuNjUtOS4zODggMi40OTUtMTMuOTIxLTYuNzk4LTkuNzY3LTkuNjAyLTIyLjYwOC0xMC43Ni0zMS40aDgyLjY4NWMuMjcyLjQxNC41NDUuODE4LjgxNSAxLjIxIDMuMTQyIDQuNTQxIDkuMzcyIDUuNjc5IDEzLjkxMyAyLjUzNCA0LjU0Mi0zLjE0MiA1LjY3Ny05LjM3MSAyLjUzNS0xMy45MTMtMTEuOTE5LTE3LjIyOS04Ljc4Ny0zNS44ODQgOS41ODEtNTcuMDEyIDMuMDY3LTIuNjUyIDEyLjMwNy0xMS43MzIgMTEuMjE3LTI0LjAzMy0uODI4LTkuMzQzLTcuMTA5LTE3LjE5NC0xOC42NjktMjMuMzM3YTkuODU3IDkuODU3IDAgMCAwLTEuMDYxLS40ODZjLS40NjYtLjE4Mi0xMS40MDMtNC41NzktOS43NDEtMTUuNzA2IDEuMDA3LTYuNzM3IDE0Ljc2OC04LjI3MyAyMy43NjYtNy42NjYgMjMuMTU2IDEuNTY5IDM5LjY5OCA3LjgwMyA0Ny44MzYgMTguMDI2IDUuNzUyIDcuMjI1IDcuNjA3IDE2LjYyMyA1LjY3MyAyOC43MzMtLjQxMyAyLjU4NS0uODI0IDUuMjQxLTEuMjQ1IDcuOTU5LTUuNzU2IDM3LjE5NC0xMi45MTkgODMuNDgzLTQ5Ljg3IDExNC42NjEtNC4yMjEgMy41NjEtNC43NTYgOS44Ny0xLjE5NCAxNC4wOTJhOS45OCA5Ljk4IDAgMCAwIDcuNjQ4IDMuNTUxIDkuOTU1IDkuOTU1IDAgMCAwIDYuNDQ0LTIuMzU4YzQyLjY3Mi0zNi4wMDUgNTAuODAyLTg4LjUzMyA1Ni43MzctMTI2Ljg4OC40MTUtMi42ODQuODIxLTUuMzA5IDEuMjI5LTcuODYzIDIuODM0LTE3LjcyMS0uNDU1LTMyLjY0MS05Ljc3Mi00NC4zNDV6bS0yMzIuMzA4IDQyLjYyYy01LjUxNCAwLTEwLTQuNDg2LTEwLTEwdi0xLjMzM2MwLTUuNTE0IDQuNDg2LTEwIDEwLTEwaDE1djIxLjMzM2gtMTV6bS0yLjUtNTIuNjY2YzAtNS41MTQgNC40ODYtMTAgMTAtMTBoNy41djIxLjMzM2gtNy41Yy01LjUxNCAwLTEwLTQuNDg2LTEwLTEwdi0xLjMzM3ptMTcuNSA5My45OTloLTcuNWMtNS41MTQgMC0xMC00LjQ4Ni0xMC0xMHYtMS4zMzNjMC01LjUxNCA0LjQ4Ni0xMCAxMC0xMGg3LjV2MjEuMzMzem0zMC43OTYgMjguODg3Yy01LjUxNCAwLTEwLTQuNDg2LTEwLTEwdi04LjI3MWg5MS40NTdjLS44NTEgNi42NjgtLjQzNyAxMi43ODcuNzMxIDE4LjI3MWgtODIuMTg4em03OS40ODItMTEzLjY5OGMtMy4xMjQgMjAuOTA2IDEyLjQyNyAzMy4xODQgMjEuNjI1IDM3LjA0IDUuNDQxIDIuOTY4IDcuNTUxIDUuNjQ3IDcuNzAxIDcuMTg4LjIxIDIuMTUtMi41NTMgNS42ODQtNC40NzcgNy4yNTEtLjQ4Mi4zNzgtLjkyOS44LTEuMzM1IDEuMjYxLTYuOTg3IDcuOTM2LTExLjk4MiAxNS41Mi0xNS40MzIgMjIuNjg4aC05Ny41NjRWMzBjMC01LjUxNCA0LjQ4Ni0xMCAxMC0xMGgxMjMuNzY5YzUuNTE0IDAgMTAgNC40ODYgMTAgMTB2MTM1LjU3OWMtMy4wMzItLjM4MS02LjE1LS42OTQtOS4zODktLjkxNC0yNS4xNTktMS42OTQtNDIuMzcgNy43NDgtNDQuODk4IDI0LjY2NnoiLz48cGF0aCBkPSJNMTc5LjEyOSA4My4xNjdoLTI0LjA2YTUgNSAwIDAgMC01IDV2MjQuMDYxYTUgNSAwIDAgMCA1IDVoMjQuMDZhNSA1IDAgMCAwIDUtNVY4OC4xNjdhNSA1IDAgMCAwLTUtNXpNMTcyLjYyOSAxNDIuODZoLTEyLjU2VjEzMC44YTUgNSAwIDEgMC0xMCAwdjE3LjA2MWE1IDUgMCAwIDAgNSA1aDE3LjU2YTUgNSAwIDEgMCAwLTEwLjAwMXpNMjE2LjU2OCA4My4xNjdoLTI0LjA2YTUgNSAwIDAgMC01IDV2MjQuMDYxYTUgNSAwIDAgMCA1IDVoMjQuMDZhNSA1IDAgMCAwIDUtNVY4OC4xNjdhNSA1IDAgMCAwLTUtNXptLTUgMjQuMDYxaC0xNC4wNlY5My4xNjdoMTQuMDZ2MTQuMDYxek0yMTEuNjY5IDEyNS45MzZIMTk3LjQxYTUgNSAwIDAgMC01IDV2MTQuMjU3YTUgNSAwIDAgMCA1IDVoMTQuMjU5YTUgNSAwIDAgMCA1LTV2LTE0LjI1N2E1IDUgMCAwIDAtNS01eiIvPjwvc3ZnPg==",Pc=nn+"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1OS4wMTggNTkuMDE4IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1OS4wMTggNTkuMDE4IiB4bWw6c3BhY2U9InByZXNlcnZlIj48cGF0aCBkPSJtNTguNzQxIDU0LjgwOS01Ljk2OS02LjI0NGExMC43NCAxMC43NCAwIDAgMCAyLjgyLTcuMjVjMC01Ljk1My00Ljg0My0xMC43OTYtMTAuNzk2LTEwLjc5NlMzNCAzNS4zNjEgMzQgNDEuMzE0IDM4Ljg0MyA1Mi4xMSA0NC43OTYgNTIuMTFjMi40NDEgMCA0LjY4OC0uODI0IDYuNDk5LTIuMTk2bDYuMDAxIDYuMjc3YS45OTguOTk4IDAgMCAwIDEuNDE0LjAzMiAxIDEgMCAwIDAgLjAzMS0xLjQxNHpNMzYgNDEuMzE0YzAtNC44NSAzLjk0Ni04Ljc5NiA4Ljc5Ni04Ljc5NnM4Ljc5NiAzLjk0NiA4Ljc5NiA4Ljc5Ni0zLjk0NiA4Ljc5Ni04Ljc5NiA4Ljc5NlMzNiA0Ni4xNjQgMzYgNDEuMzE0ek0xMC40MzEgMTYuMDg4YzAgMy4wNyAyLjQ5OCA1LjU2OCA1LjU2OSA1LjU2OHM1LjU2OS0yLjQ5OCA1LjU2OS01LjU2OGMwLTMuMDcxLTIuNDk4LTUuNTY5LTUuNTY5LTUuNTY5cy01LjU2OSAyLjQ5OC01LjU2OSA1LjU2OXptOS4xMzggMGMwIDEuOTY4LTEuNjAyIDMuNTY4LTMuNTY5IDMuNTY4cy0zLjU2OS0xLjYwMS0zLjU2OS0zLjU2OCAxLjYwMi0zLjU2OSAzLjU2OS0zLjU2OSAzLjU2OSAxLjYwMSAzLjU2OSAzLjU2OXoiLz48cGF0aCBkPSJtMzAuODgyIDI4Ljk4NyA5LjE4LTEwLjA1NCAxMS4yNjIgMTAuMzIzYTEgMSAwIDAgMCAxLjM1MS0xLjQ3NWwtMTItMTFhMSAxIDAgMCAwLTEuNDE0LjA2M2wtOS43OTQgMTAuNzI3LTQuNzQzLTQuNzQzYTEuMDAzIDEuMDAzIDAgMCAwLTEuMzY4LS4wNDRMNi4zMzkgMzcuNzY4YTEgMSAwIDEgMCAxLjMyMiAxLjUwMWwxNi4zMTMtMTQuMzYyIDcuMzE5IDcuMzE4YS45OTkuOTk5IDAgMSAwIDEuNDE0LTEuNDE0bC0xLjgyNS0xLjgyNHoiLz48cGF0aCBkPSJNMzAgNDYuNTE4SDJ2LTQyaDU0djI4YTEgMSAwIDEgMCAyIDB2LTI5YTEgMSAwIDAgMC0xLTFIMWExIDEgMCAwIDAtMSAxdjQ0YTEgMSAwIDAgMCAxIDFoMjlhMSAxIDAgMSAwIDAtMnoiLz48L3N2Zz4=",$n=nn+"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NjAgNDYwIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA0NjAgNDYwIiB4bWw6c3BhY2U9InByZXNlcnZlIj48cGF0aCBkPSJNMjMwIDBDMTAyLjk3NSAwIDAgMTAyLjk3NSAwIDIzMHMxMDIuOTc1IDIzMCAyMzAgMjMwIDIzMC0xMDIuOTc0IDIzMC0yMzBTMzU3LjAyNSAwIDIzMCAwem0zOC4zMzMgMzc3LjM2YzAgOC42NzYtNy4wMzQgMTUuNzEtMTUuNzEgMTUuNzFoLTQzLjEwMWMtOC42NzYgMC0xNS43MS03LjAzNC0xNS43MS0xNS43MVYyMDIuNDc3YzAtOC42NzYgNy4wMzMtMTUuNzEgMTUuNzEtMTUuNzFoNDMuMTAxYzguNjc2IDAgMTUuNzEgNy4wMzMgMTUuNzEgMTUuNzFWMzc3LjM2ek0yMzAgMTU3Yy0yMS41MzkgMC0zOS0xNy40NjEtMzktMzlzMTcuNDYxLTM5IDM5LTM5IDM5IDE3LjQ2MSAzOSAzOS0xNy40NjEgMzktMzkgMzl6Ii8+PC9zdmc+",Bc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAQgAAAEIBarqQRAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAE1SURBVDiNfdI7S0NBEAXgLya1otFgpbYSbISAgpXYi6CmiH9KCAiChaVga6OiWPgfRDQ+0itaGVNosXtluWwcuMzePfM4M3sq8lbHBubwg1dc4m1E/J/N4ghDPOIsfk/4xiEao5KX0McFljN4C9d4QTPXuY99jP3DsIoDPGM6BY5i5yI5R7O4q+ImFkJY2DCh3cAH2klyB+9J1xUMMAG7eCh1a+Mr+k48b5diXrFVwwLuS+BJ9MfR7+G0FHOHhTHhnXNWS87VDF4pcnfQK4Ep7XScNLmPTZgURNKKYENYWDpzW1BhscS1WHS8CDgURFJQrWcoF3c13KKbgg1BYQfy8xZWEzTTw1QZbAoKu8FqJnktdu5hcVSHmchiILzzuaDQvjBzV2m8yohCE1jHfPx/xhU+y4G/D75ELlRJsSYAAAAASUVORK5CYII=",Xn=function(){function n(){}return n.createDefault=function(){return{hasPermission:!1,lastUsedCameraId:null}},n}(),Fc=function(){function n(){this.data=Xn.createDefault();var l=localStorage.getItem(n.LOCAL_STORAGE_KEY);l?this.data=JSON.parse(l):this.reset()}return n.prototype.hasCameraPermissions=function(){return this.data.hasPermission},n.prototype.getLastUsedCameraId=function(){return this.data.lastUsedCameraId},n.prototype.setHasPermission=function(l){this.data.hasPermission=l,this.flush()},n.prototype.setLastUsedCameraId=function(l){this.data.lastUsedCameraId=l,this.flush()},n.prototype.resetLastUsedCameraId=function(){this.data.lastUsedCameraId=null,this.flush()},n.prototype.reset=function(){this.data=Xn.createDefault(),this.flush()},n.prototype.flush=function(){localStorage.setItem(n.LOCAL_STORAGE_KEY,JSON.stringify(this.data))},n.LOCAL_STORAGE_KEY="HTML5_QRCODE_DATA",n}(),Uc=function(){function n(){this.infoDiv=document.createElement("div")}return n.prototype.renderInto=function(l){this.infoDiv.style.position="absolute",this.infoDiv.style.top="10px",this.infoDiv.style.right="10px",this.infoDiv.style.zIndex="2",this.infoDiv.style.display="none",this.infoDiv.style.padding="5pt",this.infoDiv.style.border="1px solid #171717",this.infoDiv.style.fontSize="10pt",this.infoDiv.style.background="rgb(0 0 0 / 69%)",this.infoDiv.style.borderRadius="5px",this.infoDiv.style.textAlign="center",this.infoDiv.style.fontWeight="400",this.infoDiv.style.color="white",this.infoDiv.innerText=Fn.poweredBy();var c=document.createElement("a");c.innerText="ScanApp",c.href="https://scanapp.org",c.target="new",c.style.color="white",this.infoDiv.appendChild(c);var u=document.createElement("br"),f=document.createElement("br");this.infoDiv.appendChild(u),this.infoDiv.appendChild(f);var x=document.createElement("a");x.innerText=Fn.reportIssues(),x.href="https://github.com/mebjas/html5-qrcode/issues",x.target="new",x.style.color="white",this.infoDiv.appendChild(x),l.appendChild(this.infoDiv)},n.prototype.show=function(){this.infoDiv.style.display="block"},n.prototype.hide=function(){this.infoDiv.style.display="none"},n}(),Vc=function(){function n(l,c){this.isShowingInfoIcon=!0,this.onTapIn=l,this.onTapOut=c,this.infoIcon=document.createElement("img")}return n.prototype.renderInto=function(l){var c=this;this.infoIcon.alt="Info icon",this.infoIcon.src=$n,this.infoIcon.style.position="absolute",this.infoIcon.style.top="4px",this.infoIcon.style.right="4px",this.infoIcon.style.opacity="0.6",this.infoIcon.style.cursor="pointer",this.infoIcon.style.zIndex="2",this.infoIcon.style.width="16px",this.infoIcon.style.height="16px",this.infoIcon.onmouseover=function(u){return c.onHoverIn()},this.infoIcon.onmouseout=function(u){return c.onHoverOut()},this.infoIcon.onclick=function(u){return c.onClick()},l.appendChild(this.infoIcon)},n.prototype.onHoverIn=function(){this.isShowingInfoIcon&&(this.infoIcon.style.opacity="1")},n.prototype.onHoverOut=function(){this.isShowingInfoIcon&&(this.infoIcon.style.opacity="0.6")},n.prototype.onClick=function(){this.isShowingInfoIcon?(this.isShowingInfoIcon=!1,this.onTapIn(),this.infoIcon.src=Bc,this.infoIcon.style.opacity="1"):(this.isShowingInfoIcon=!0,this.onTapOut(),this.infoIcon.src=$n,this.infoIcon.style.opacity="0.6")},n}(),Hc=function(){function n(){var l=this;this.infoDiv=new Uc,this.infoIcon=new Vc(function(){l.infoDiv.show()},function(){l.infoDiv.hide()})}return n.prototype.renderInto=function(l){this.infoDiv.renderInto(l),this.infoIcon.renderInto(l)},n}(),qc=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(E){try{g(u.next(E))}catch(p){b(p)}}function S(E){try{g(u.throw(E))}catch(p){b(p)}}function g(E){E.done?x(E.value):f(E.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},Gc=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(E){return S([g,E])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(E){g=[6,E],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},Zn=function(){function n(){}return n.hasPermissions=function(){return qc(this,void 0,void 0,function(){var l,c,u,f;return Gc(this,function(x){switch(x.label){case 0:return[4,navigator.mediaDevices.enumerateDevices()];case 1:for(l=x.sent(),c=0,u=l;c<u.length;c++)if(f=u[c],f.kind==="videoinput"&&f.label)return[2,!0];return[2,!1]}})})},n}(),tr=function(){function n(l){this.supportedScanTypes=this.validateAndReturnScanTypes(l)}return n.prototype.getDefaultScanType=function(){return this.supportedScanTypes[0]},n.prototype.hasMoreThanOneScanType=function(){return this.supportedScanTypes.length>1},n.prototype.isCameraScanRequired=function(){for(var l=0,c=this.supportedScanTypes;l<c.length;l++){var u=c[l];if(n.isCameraScanType(u))return!0}return!1},n.isCameraScanType=function(l){return l===lr.SCAN_TYPE_CAMERA},n.isFileScanType=function(l){return l===lr.SCAN_TYPE_FILE},n.prototype.validateAndReturnScanTypes=function(l){if(!l||l.length===0)return Rs.DEFAULT_SUPPORTED_SCAN_TYPE;var c=Rs.DEFAULT_SUPPORTED_SCAN_TYPE.length;if(l.length>c)throw"Max ".concat(c," values expected for ")+"supportedScanTypes";for(var u=0,f=l;u<f.length;u++){var x=f[u];if(!Rs.DEFAULT_SUPPORTED_SCAN_TYPE.includes(x))throw"Unsupported scan type ".concat(x)}return l},n}(),Ns=function(){function n(){}return n.ALL_ELEMENT_CLASS="html5-qrcode-element",n.CAMERA_PERMISSION_BUTTON_ID="html5-qrcode-button-camera-permission",n.CAMERA_START_BUTTON_ID="html5-qrcode-button-camera-start",n.CAMERA_STOP_BUTTON_ID="html5-qrcode-button-camera-stop",n.TORCH_BUTTON_ID="html5-qrcode-button-torch",n.CAMERA_SELECTION_SELECT_ID="html5-qrcode-select-camera",n.FILE_SELECTION_BUTTON_ID="html5-qrcode-button-file-selection",n.ZOOM_SLIDER_ID="html5-qrcode-input-range-zoom",n.SCAN_TYPE_CHANGE_ANCHOR_ID="html5-qrcode-anchor-scan-type-change",n.TORCH_BUTTON_CLASS_TORCH_ON="html5-qrcode-button-torch-on",n.TORCH_BUTTON_CLASS_TORCH_OFF="html5-qrcode-button-torch-off",n}(),$s=function(){function n(){}return n.createElement=function(l,c){var u=document.createElement(l);return u.id=c,u.classList.add(Ns.ALL_ELEMENT_CLASS),l==="button"&&u.setAttribute("type","button"),u},n}(),Ri=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(E){try{g(u.next(E))}catch(p){b(p)}}function S(E){try{g(u.throw(E))}catch(p){b(p)}}function g(E){E.done?x(E.value):f(E.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},Li=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(E){return S([g,E])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(E){g=[6,E],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},Qn=function(){function n(l,c,u){this.isTorchOn=!1,this.torchCapability=l,this.buttonController=c,this.onTorchActionFailureCallback=u}return n.prototype.isTorchEnabled=function(){return this.isTorchOn},n.prototype.flipState=function(){return Ri(this,void 0,void 0,function(){var l,c;return Li(this,function(u){switch(u.label){case 0:this.buttonController.disable(),l=!this.isTorchOn,u.label=1;case 1:return u.trys.push([1,3,,4]),[4,this.torchCapability.apply(l)];case 2:return u.sent(),this.updateUiBasedOnLatestSettings(this.torchCapability.value(),l),[3,4];case 3:return c=u.sent(),this.propagateFailure(l,c),this.buttonController.enable(),[3,4];case 4:return[2]}})})},n.prototype.updateUiBasedOnLatestSettings=function(l,c){l===c?(this.buttonController.setText(c?Dt.torchOffButton():Dt.torchOnButton()),this.isTorchOn=c):this.propagateFailure(c),this.buttonController.enable()},n.prototype.propagateFailure=function(l,c){var u=l?Dt.torchOnFailedMessage():Dt.torchOffFailedMessage();c&&(u+="; Error = "+c),this.onTorchActionFailureCallback(u)},n.prototype.reset=function(){this.isTorchOn=!1},n}(),Wc=function(){function n(l,c){this.onTorchActionFailureCallback=c,this.torchButton=$s.createElement("button",Ns.TORCH_BUTTON_ID),this.torchController=new Qn(l,this,c)}return n.prototype.render=function(l,c){var u=this;this.torchButton.innerText=Dt.torchOnButton(),this.torchButton.style.display=c.display,this.torchButton.style.marginLeft=c.marginLeft;var f=this;this.torchButton.addEventListener("click",function(x){return Ri(u,void 0,void 0,function(){return Li(this,function(b){switch(b.label){case 0:return[4,f.torchController.flipState()];case 1:return b.sent(),f.torchController.isTorchEnabled()?(f.torchButton.classList.remove(Ns.TORCH_BUTTON_CLASS_TORCH_OFF),f.torchButton.classList.add(Ns.TORCH_BUTTON_CLASS_TORCH_ON)):(f.torchButton.classList.remove(Ns.TORCH_BUTTON_CLASS_TORCH_ON),f.torchButton.classList.add(Ns.TORCH_BUTTON_CLASS_TORCH_OFF)),[2]}})})}),l.appendChild(this.torchButton)},n.prototype.updateTorchCapability=function(l){this.torchController=new Qn(l,this,this.onTorchActionFailureCallback)},n.prototype.getTorchButton=function(){return this.torchButton},n.prototype.hide=function(){this.torchButton.style.display="none"},n.prototype.show=function(){this.torchButton.style.display="inline-block"},n.prototype.disable=function(){this.torchButton.disabled=!0},n.prototype.enable=function(){this.torchButton.disabled=!1},n.prototype.setText=function(l){this.torchButton.innerText=l},n.prototype.reset=function(){this.torchButton.innerText=Dt.torchOnButton(),this.torchController.reset()},n.create=function(l,c,u,f){var x=new n(c,f);return x.render(l,u),x},n}(),Yc=function(){function n(l,c,u){this.fileBasedScanRegion=this.createFileBasedScanRegion(),this.fileBasedScanRegion.style.display=c?"block":"none",l.appendChild(this.fileBasedScanRegion);var f=document.createElement("label");f.setAttribute("for",this.getFileScanInputId()),f.style.display="inline-block",this.fileBasedScanRegion.appendChild(f),this.fileSelectionButton=$s.createElement("button",Ns.FILE_SELECTION_BUTTON_ID),this.setInitialValueToButton(),this.fileSelectionButton.addEventListener("click",function(v){f.click()}),f.append(this.fileSelectionButton),this.fileScanInput=$s.createElement("input",this.getFileScanInputId()),this.fileScanInput.type="file",this.fileScanInput.accept="image/*",this.fileScanInput.style.display="none",f.appendChild(this.fileScanInput);var x=this;this.fileScanInput.addEventListener("change",function(v){if(!(v==null||v.target==null)){var S=v.target;if(!(S.files&&S.files.length===0)){var g=S.files,E=g[0],p=E.name;x.setImageNameToButton(p),u(E)}}});var b=this.createDragAndDropMessage();this.fileBasedScanRegion.appendChild(b),this.fileBasedScanRegion.addEventListener("dragenter",function(v){x.fileBasedScanRegion.style.border=x.fileBasedScanRegionActiveBorder(),v.stopPropagation(),v.preventDefault()}),this.fileBasedScanRegion.addEventListener("dragleave",function(v){x.fileBasedScanRegion.style.border=x.fileBasedScanRegionDefaultBorder(),v.stopPropagation(),v.preventDefault()}),this.fileBasedScanRegion.addEventListener("dragover",function(v){x.fileBasedScanRegion.style.border=x.fileBasedScanRegionActiveBorder(),v.stopPropagation(),v.preventDefault()}),this.fileBasedScanRegion.addEventListener("drop",function(v){v.stopPropagation(),v.preventDefault(),x.fileBasedScanRegion.style.border=x.fileBasedScanRegionDefaultBorder();var S=v.dataTransfer;if(S){var g=S.files;if(!g||g.length===0)return;for(var E=!1,p=0;p<g.length;++p){var k=g.item(p);if(k){var P=/image.*/;if(k.type.match(P)){E=!0;var D=k.name;x.setImageNameToButton(D),u(k),b.innerText=Dt.dragAndDropMessage();break}}}E||(b.innerText=Dt.dragAndDropMessageOnlyImages())}})}return n.prototype.hide=function(){this.fileBasedScanRegion.style.display="none",this.fileScanInput.disabled=!0},n.prototype.show=function(){this.fileBasedScanRegion.style.display="block",this.fileScanInput.disabled=!1},n.prototype.isShowing=function(){return this.fileBasedScanRegion.style.display==="block"},n.prototype.resetValue=function(){this.fileScanInput.value="",this.setInitialValueToButton()},n.prototype.createFileBasedScanRegion=function(){var l=document.createElement("div");return l.style.textAlign="center",l.style.margin="auto",l.style.width="80%",l.style.maxWidth="600px",l.style.border=this.fileBasedScanRegionDefaultBorder(),l.style.padding="10px",l.style.marginBottom="10px",l},n.prototype.fileBasedScanRegionDefaultBorder=function(){return"6px dashed #ebebeb"},n.prototype.fileBasedScanRegionActiveBorder=function(){return"6px dashed rgb(153 151 151)"},n.prototype.createDragAndDropMessage=function(){var l=document.createElement("div");return l.innerText=Dt.dragAndDropMessage(),l.style.fontWeight="400",l},n.prototype.setImageNameToButton=function(l){var c=20;if(l.length>c){var u=l.substring(0,8),f=l.length,x=l.substring(f-8,f);l="".concat(u,"....").concat(x)}var b=Dt.fileSelectionChooseAnother()+" - "+l;this.fileSelectionButton.innerText=b},n.prototype.setInitialValueToButton=function(){var l=Dt.fileSelectionChooseImage()+" - "+Dt.fileSelectionNoImageSelected();this.fileSelectionButton.innerText=l},n.prototype.getFileScanInputId=function(){return"html5-qrcode-private-filescan-input"},n.create=function(l,c,u){var f=new n(l,c,u);return f},n}(),$c=function(){function n(l){this.selectElement=$s.createElement("select",Ns.CAMERA_SELECTION_SELECT_ID),this.cameras=l,this.options=[]}return n.prototype.render=function(l){var c=document.createElement("span");c.style.marginRight="10px";var u=this.cameras.length;if(u===0)throw new Error("No cameras found");if(u===1)c.style.display="none";else{var f=Dt.selectCamera();c.innerText="".concat(f," (").concat(this.cameras.length,")  ")}for(var x=1,b=0,v=this.cameras;b<v.length;b++){var S=v[b],g=S.id,E=S.label==null?g:S.label;(!E||E==="")&&(E=[Dt.anonymousCameraPrefix(),x++].join(" "));var p=document.createElement("option");p.value=g,p.innerText=E,this.options.push(p),this.selectElement.appendChild(p)}c.appendChild(this.selectElement),l.appendChild(c)},n.prototype.disable=function(){this.selectElement.disabled=!0},n.prototype.isDisabled=function(){return this.selectElement.disabled===!0},n.prototype.enable=function(){this.selectElement.disabled=!1},n.prototype.getValue=function(){return this.selectElement.value},n.prototype.hasValue=function(l){for(var c=0,u=this.options;c<u.length;c++){var f=u[c];if(f.value===l)return!0}return!1},n.prototype.setValue=function(l){if(!this.hasValue(l))throw new Error("".concat(l," is not present in the camera list."));this.selectElement.value=l},n.prototype.hasSingleItem=function(){return this.cameras.length===1},n.prototype.numCameras=function(){return this.cameras.length},n.create=function(l,c){var u=new n(c);return u.render(l),u},n}(),Xc=function(){function n(){this.onChangeCallback=null,this.zoomElementContainer=document.createElement("div"),this.rangeInput=$s.createElement("input",Ns.ZOOM_SLIDER_ID),this.rangeInput.type="range",this.rangeText=document.createElement("span"),this.rangeInput.min="1",this.rangeInput.max="5",this.rangeInput.value="1",this.rangeInput.step="0.1"}return n.prototype.render=function(l,c){this.zoomElementContainer.style.display=c?"block":"none",this.zoomElementContainer.style.padding="5px 10px",this.zoomElementContainer.style.textAlign="center",l.appendChild(this.zoomElementContainer),this.rangeInput.style.display="inline-block",this.rangeInput.style.width="50%",this.rangeInput.style.height="5px",this.rangeInput.style.background="#d3d3d3",this.rangeInput.style.outline="none",this.rangeInput.style.opacity="0.7";var u=Dt.zoom();this.rangeText.innerText="".concat(this.rangeInput.value,"x ").concat(u),this.rangeText.style.marginRight="10px";var f=this;this.rangeInput.addEventListener("input",function(){return f.onValueChange()}),this.rangeInput.addEventListener("change",function(){return f.onValueChange()}),this.zoomElementContainer.appendChild(this.rangeInput),this.zoomElementContainer.appendChild(this.rangeText)},n.prototype.onValueChange=function(){var l=Dt.zoom();this.rangeText.innerText="".concat(this.rangeInput.value,"x ").concat(l),this.onChangeCallback&&this.onChangeCallback(parseFloat(this.rangeInput.value))},n.prototype.setValues=function(l,c,u,f){this.rangeInput.min=l.toString(),this.rangeInput.max=c.toString(),this.rangeInput.step=f.toString(),this.rangeInput.value=u.toString(),this.onValueChange()},n.prototype.show=function(){this.zoomElementContainer.style.display="block"},n.prototype.hide=function(){this.zoomElementContainer.style.display="none"},n.prototype.setOnCameraZoomValueChangeCallback=function(l){this.onChangeCallback=l},n.prototype.removeOnCameraZoomValueChangeCallback=function(){this.onChangeCallback=null},n.create=function(l,c){var u=new n;return u.render(l,c),u},n}(),vs;(function(n){n[n.STATUS_DEFAULT=0]="STATUS_DEFAULT",n[n.STATUS_SUCCESS=1]="STATUS_SUCCESS",n[n.STATUS_WARNING=2]="STATUS_WARNING",n[n.STATUS_REQUESTING_PERMISSION=3]="STATUS_REQUESTING_PERMISSION"})(vs||(vs={}));function Zc(n){return{fps:n.fps,qrbox:n.qrbox,aspectRatio:n.aspectRatio,disableFlip:n.disableFlip,videoConstraints:n.videoConstraints}}function Qc(n,l){return{formatsToSupport:n.formatsToSupport,useBarCodeDetectorIfSupported:n.useBarCodeDetectorIfSupported,experimentalFeatures:n.experimentalFeatures,verbose:l}}var Kc=function(){function n(l,c,u){if(this.lastMatchFound=null,this.cameraScanImage=null,this.fileScanImage=null,this.fileSelectionUi=null,this.elementId=l,this.config=this.createConfig(c),this.verbose=u===!0,!document.getElementById(l))throw"HTML Element with id=".concat(l," not found");this.scanTypeSelector=new tr(this.config.supportedScanTypes),this.currentScanType=this.scanTypeSelector.getDefaultScanType(),this.sectionSwapAllowed=!0,this.logger=new Mi(this.verbose),this.persistedDataManager=new Fc,c.rememberLastUsedCamera!==!0&&this.persistedDataManager.reset()}return n.prototype.render=function(l,c){var u=this;this.lastMatchFound=null,this.qrCodeSuccessCallback=function(x,b){if(l)l(x,b);else{if(u.lastMatchFound===x)return;u.lastMatchFound=x,u.setHeaderMessage(Dt.lastMatch(x),vs.STATUS_SUCCESS)}},this.qrCodeErrorCallback=function(x,b){c&&c(x,b)};var f=document.getElementById(this.elementId);if(!f)throw"HTML Element with id=".concat(this.elementId," not found");f.innerHTML="",this.createBasicLayout(f),this.html5Qrcode=new Yn(this.getScanRegionId(),Qc(this.config,this.verbose))},n.prototype.pause=function(l){(Vs(l)||l!==!0)&&(l=!1),this.getHtml5QrcodeOrFail().pause(l)},n.prototype.resume=function(){this.getHtml5QrcodeOrFail().resume()},n.prototype.getState=function(){return this.getHtml5QrcodeOrFail().getState()},n.prototype.clear=function(){var l=this,c=function(){var u=document.getElementById(l.elementId);u&&(u.innerHTML="",l.resetBasicLayout(u))};return this.html5Qrcode?new Promise(function(u,f){if(!l.html5Qrcode){u();return}l.html5Qrcode.isScanning?l.html5Qrcode.stop().then(function(x){if(!l.html5Qrcode){u();return}l.html5Qrcode.clear(),c(),u()}).catch(function(x){l.verbose&&l.logger.logError("Unable to stop qrcode scanner",x),f(x)}):(l.html5Qrcode.clear(),c(),u())}):Promise.resolve()},n.prototype.getRunningTrackCapabilities=function(){return this.getHtml5QrcodeOrFail().getRunningTrackCapabilities()},n.prototype.getRunningTrackSettings=function(){return this.getHtml5QrcodeOrFail().getRunningTrackSettings()},n.prototype.applyVideoConstraints=function(l){return this.getHtml5QrcodeOrFail().applyVideoConstraints(l)},n.prototype.getHtml5QrcodeOrFail=function(){if(!this.html5Qrcode)throw"Code scanner not initialized.";return this.html5Qrcode},n.prototype.createConfig=function(l){return l?(l.fps||(l.fps=Rs.SCAN_DEFAULT_FPS),l.rememberLastUsedCamera!==!Rs.DEFAULT_REMEMBER_LAST_CAMERA_USED&&(l.rememberLastUsedCamera=Rs.DEFAULT_REMEMBER_LAST_CAMERA_USED),l.supportedScanTypes||(l.supportedScanTypes=Rs.DEFAULT_SUPPORTED_SCAN_TYPE),l):{fps:Rs.SCAN_DEFAULT_FPS,rememberLastUsedCamera:Rs.DEFAULT_REMEMBER_LAST_CAMERA_USED,supportedScanTypes:Rs.DEFAULT_SUPPORTED_SCAN_TYPE}},n.prototype.createBasicLayout=function(l){l.style.position="relative",l.style.padding="0px",l.style.border="1px solid silver",this.createHeader(l);var c=document.createElement("div"),u=this.getScanRegionId();c.id=u,c.style.width="100%",c.style.minHeight="100px",c.style.textAlign="center",l.appendChild(c),tr.isCameraScanType(this.currentScanType)?this.insertCameraScanImageToScanRegion():this.insertFileScanImageToScanRegion();var f=document.createElement("div"),x=this.getDashboardId();f.id=x,f.style.width="100%",l.appendChild(f),this.setupInitialDashboard(f)},n.prototype.resetBasicLayout=function(l){l.style.border="none"},n.prototype.setupInitialDashboard=function(l){this.createSection(l),this.createSectionControlPanel(),this.scanTypeSelector.hasMoreThanOneScanType()&&this.createSectionSwap()},n.prototype.createHeader=function(l){var c=document.createElement("div");c.style.textAlign="left",c.style.margin="0px",l.appendChild(c);var u=new Hc;u.renderInto(c);var f=document.createElement("div");f.id=this.getHeaderMessageContainerId(),f.style.display="none",f.style.textAlign="center",f.style.fontSize="14px",f.style.padding="2px 10px",f.style.margin="4px",f.style.borderTop="1px solid #f6f6f6",c.appendChild(f)},n.prototype.createSection=function(l){var c=document.createElement("div");c.id=this.getDashboardSectionId(),c.style.width="100%",c.style.padding="10px 0px 10px 0px",c.style.textAlign="left",l.appendChild(c)},n.prototype.createCameraListUi=function(l,c,u){var f=this;f.showHideScanTypeSwapLink(!1),f.setHeaderMessage(Dt.cameraPermissionRequesting());var x=function(){u||f.createPermissionButton(l,c)};Yn.getCameras().then(function(b){f.persistedDataManager.setHasPermission(!0),f.showHideScanTypeSwapLink(!0),f.resetHeaderMessage(),b&&b.length>0?(l.removeChild(c),f.renderCameraSelection(b)):(f.setHeaderMessage(Dt.noCameraFound(),vs.STATUS_WARNING),x())}).catch(function(b){f.persistedDataManager.setHasPermission(!1),u?u.disabled=!1:x(),f.setHeaderMessage(b,vs.STATUS_WARNING),f.showHideScanTypeSwapLink(!0)})},n.prototype.createPermissionButton=function(l,c){var u=this,f=$s.createElement("button",this.getCameraPermissionButtonId());f.innerText=Dt.cameraPermissionTitle(),f.addEventListener("click",function(){f.disabled=!0,u.createCameraListUi(l,c,f)}),c.appendChild(f)},n.prototype.createPermissionsUi=function(l,c){var u=this;if(tr.isCameraScanType(this.currentScanType)&&this.persistedDataManager.hasCameraPermissions()){Zn.hasPermissions().then(function(f){f?u.createCameraListUi(l,c):(u.persistedDataManager.setHasPermission(!1),u.createPermissionButton(l,c))}).catch(function(f){u.persistedDataManager.setHasPermission(!1),u.createPermissionButton(l,c)});return}this.createPermissionButton(l,c)},n.prototype.createSectionControlPanel=function(){var l=document.getElementById(this.getDashboardSectionId()),c=document.createElement("div");l.appendChild(c);var u=document.createElement("div");u.id=this.getDashboardSectionCameraScanRegionId(),u.style.display=tr.isCameraScanType(this.currentScanType)?"block":"none",c.appendChild(u);var f=document.createElement("div");f.style.textAlign="center",u.appendChild(f),this.scanTypeSelector.isCameraScanRequired()&&this.createPermissionsUi(u,f),this.renderFileScanUi(c)},n.prototype.renderFileScanUi=function(l){var c=tr.isFileScanType(this.currentScanType),u=this,f=function(x){if(!u.html5Qrcode)throw"html5Qrcode not defined";tr.isFileScanType(u.currentScanType)&&(u.setHeaderMessage(Dt.loadingImage()),u.html5Qrcode.scanFileV2(x,!0).then(function(b){u.resetHeaderMessage(),u.qrCodeSuccessCallback(b.decodedText,b)}).catch(function(b){u.setHeaderMessage(b,vs.STATUS_WARNING),u.qrCodeErrorCallback(b,ki.createFrom(b))}))};this.fileSelectionUi=Yc.create(l,c,f)},n.prototype.renderCameraSelection=function(l){var c=this,u=this,f=document.getElementById(this.getDashboardSectionCameraScanRegionId());f.style.textAlign="center";var x=Xc.create(f,!1),b=function(R){var j=R.zoomFeature();if(j.isSupported()){x.setOnCameraZoomValueChangeCallback(function(T){j.apply(T)});var M=1;c.config.defaultZoomValueIfSupported&&(M=c.config.defaultZoomValueIfSupported),M=gc(M,j.min(),j.max()),x.setValues(j.min(),j.max(),M,j.step()),x.show()}},v=$c.create(f,l),S=document.createElement("span"),g=$s.createElement("button",Ns.CAMERA_START_BUTTON_ID);g.innerText=Dt.scanButtonStartScanningText(),S.appendChild(g);var E=$s.createElement("button",Ns.CAMERA_STOP_BUTTON_ID);E.innerText=Dt.scanButtonStopScanningText(),E.style.display="none",E.disabled=!0,S.appendChild(E);var p,k=function(R){if(!R.torchFeature().isSupported()){p&&p.hide();return}p?p.updateTorchCapability(R.torchFeature()):p=Wc.create(S,R.torchFeature(),{display:"none",marginLeft:"5px"},function(j){u.setHeaderMessage(j,vs.STATUS_WARNING)}),p.show()};f.appendChild(S);var P=function(R){R||(g.style.display="none"),g.innerText=Dt.scanButtonStartScanningText(),g.style.opacity="1",g.disabled=!1,R&&(g.style.display="inline-block")};if(g.addEventListener("click",function(R){g.innerText=Dt.scanButtonScanningStarting(),v.disable(),g.disabled=!0,g.style.opacity="0.5",c.scanTypeSelector.hasMoreThanOneScanType()&&u.showHideScanTypeSwapLink(!1),u.resetHeaderMessage();var j=v.getValue();u.persistedDataManager.setLastUsedCameraId(j),u.html5Qrcode.start(j,Zc(u.config),u.qrCodeSuccessCallback,u.qrCodeErrorCallback).then(function(M){E.disabled=!1,E.style.display="inline-block",P(!1);var T=u.html5Qrcode.getRunningTrackCameraCapabilities();c.config.showTorchButtonIfSupported===!0&&k(T),c.config.showZoomSliderIfSupported===!0&&b(T)}).catch(function(M){u.showHideScanTypeSwapLink(!0),v.enable(),P(!0),u.setHeaderMessage(M,vs.STATUS_WARNING)})}),v.hasSingleItem()&&g.click(),E.addEventListener("click",function(R){if(!u.html5Qrcode)throw"html5Qrcode not defined";E.disabled=!0,u.html5Qrcode.stop().then(function(j){c.scanTypeSelector.hasMoreThanOneScanType()&&u.showHideScanTypeSwapLink(!0),v.enable(),g.disabled=!1,E.style.display="none",g.style.display="inline-block",p&&(p.reset(),p.hide()),x.removeOnCameraZoomValueChangeCallback(),x.hide(),u.insertCameraScanImageToScanRegion()}).catch(function(j){E.disabled=!1,u.setHeaderMessage(j,vs.STATUS_WARNING)})}),u.persistedDataManager.getLastUsedCameraId()){var D=u.persistedDataManager.getLastUsedCameraId();v.hasValue(D)?(v.setValue(D),g.click()):u.persistedDataManager.resetLastUsedCameraId()}},n.prototype.createSectionSwap=function(){var l=this,c=Dt.textIfCameraScanSelected(),u=Dt.textIfFileScanSelected(),f=document.getElementById(this.getDashboardSectionId()),x=document.createElement("div");x.style.textAlign="center";var b=$s.createElement("span",this.getDashboardSectionSwapLinkId());b.style.textDecoration="underline",b.style.cursor="pointer",b.innerText=tr.isCameraScanType(this.currentScanType)?c:u,b.addEventListener("click",function(){if(!l.sectionSwapAllowed){l.verbose&&l.logger.logError("Section swap called when not allowed");return}l.resetHeaderMessage(),l.fileSelectionUi.resetValue(),l.sectionSwapAllowed=!1,tr.isCameraScanType(l.currentScanType)?(l.clearScanRegion(),l.getCameraScanRegion().style.display="none",l.fileSelectionUi.show(),b.innerText=u,l.currentScanType=lr.SCAN_TYPE_FILE,l.insertFileScanImageToScanRegion()):(l.clearScanRegion(),l.getCameraScanRegion().style.display="block",l.fileSelectionUi.hide(),b.innerText=c,l.currentScanType=lr.SCAN_TYPE_CAMERA,l.insertCameraScanImageToScanRegion(),l.startCameraScanIfPermissionExistsOnSwap()),l.sectionSwapAllowed=!0}),x.appendChild(b),f.appendChild(x)},n.prototype.startCameraScanIfPermissionExistsOnSwap=function(){var l=this,c=this;if(this.persistedDataManager.hasCameraPermissions()){Zn.hasPermissions().then(function(u){if(u){var f=document.getElementById(c.getCameraPermissionButtonId());if(!f)throw l.logger.logError("Permission button not found, fail;"),"Permission button not found";f.click()}else c.persistedDataManager.setHasPermission(!1)}).catch(function(u){c.persistedDataManager.setHasPermission(!1)});return}},n.prototype.resetHeaderMessage=function(){var l=document.getElementById(this.getHeaderMessageContainerId());l.style.display="none"},n.prototype.setHeaderMessage=function(l,c){c||(c=vs.STATUS_DEFAULT);var u=this.getHeaderMessageDiv();switch(u.innerText=l,u.style.display="block",c){case vs.STATUS_SUCCESS:u.style.background="rgba(106, 175, 80, 0.26)",u.style.color="#477735";break;case vs.STATUS_WARNING:u.style.background="rgba(203, 36, 49, 0.14)",u.style.color="#cb2431";break;case vs.STATUS_DEFAULT:default:u.style.background="rgba(0, 0, 0, 0)",u.style.color="rgb(17, 17, 17)";break}},n.prototype.showHideScanTypeSwapLink=function(l){this.scanTypeSelector.hasMoreThanOneScanType()&&(l!==!0&&(l=!1),this.sectionSwapAllowed=l,this.getDashboardSectionSwapLink().style.display=l?"inline-block":"none")},n.prototype.insertCameraScanImageToScanRegion=function(){var l=this,c=document.getElementById(this.getScanRegionId());if(this.cameraScanImage){c.innerHTML="<br>",c.appendChild(this.cameraScanImage);return}this.cameraScanImage=new Image,this.cameraScanImage.onload=function(u){c.innerHTML="<br>",c.appendChild(l.cameraScanImage)},this.cameraScanImage.width=64,this.cameraScanImage.style.opacity="0.8",this.cameraScanImage.src=Lc,this.cameraScanImage.alt=Dt.cameraScanAltText()},n.prototype.insertFileScanImageToScanRegion=function(){var l=this,c=document.getElementById(this.getScanRegionId());if(this.fileScanImage){c.innerHTML="<br>",c.appendChild(this.fileScanImage);return}this.fileScanImage=new Image,this.fileScanImage.onload=function(u){c.innerHTML="<br>",c.appendChild(l.fileScanImage)},this.fileScanImage.width=64,this.fileScanImage.style.opacity="0.8",this.fileScanImage.src=Pc,this.fileScanImage.alt=Dt.fileScanAltText()},n.prototype.clearScanRegion=function(){var l=document.getElementById(this.getScanRegionId());l.innerHTML=""},n.prototype.getDashboardSectionId=function(){return"".concat(this.elementId,"__dashboard_section")},n.prototype.getDashboardSectionCameraScanRegionId=function(){return"".concat(this.elementId,"__dashboard_section_csr")},n.prototype.getDashboardSectionSwapLinkId=function(){return Ns.SCAN_TYPE_CHANGE_ANCHOR_ID},n.prototype.getScanRegionId=function(){return"".concat(this.elementId,"__scan_region")},n.prototype.getDashboardId=function(){return"".concat(this.elementId,"__dashboard")},n.prototype.getHeaderMessageContainerId=function(){return"".concat(this.elementId,"__header_message")},n.prototype.getCameraPermissionButtonId=function(){return Ns.CAMERA_PERMISSION_BUTTON_ID},n.prototype.getCameraScanRegion=function(){return document.getElementById(this.getDashboardSectionCameraScanRegionId())},n.prototype.getDashboardSectionSwapLink=function(){return document.getElementById(this.getDashboardSectionSwapLinkId())},n.prototype.getHeaderMessageDiv=function(){return document.getElementById(this.getHeaderMessageContainerId())},n}();const on=()=>{const[n,l]=w.useState(null),[c,u]=w.useState(!1),[f,x]=w.useState(null),[b,v]=w.useState(null),S=async(k,P)=>{try{const D=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${k}&lon=${P}&zoom=18&addressdetails=1`,{headers:{"User-Agent":"CrewManager-Mobile/1.0"}});if(!D.ok)throw new Error("Servizio geocoding non disponibile");const R=await D.json();return R&&R.display_name?R.display_name:`${k.toFixed(6)}, ${P.toFixed(6)}`}catch(D){return console.error("Errore reverse geocoding:",D),`Lat: ${k.toFixed(6)}, Lng: ${P.toFixed(6)}`}},g=w.useCallback(async(k={})=>{const{requiredAccuracy:P=10,maxRetries:D=3,retryDelay:R=2e3}=k;u(!0),x(null);let j=0,M=null;for(;j<D;){try{const T=await new Promise((U,te)=>{navigator.geolocation.getCurrentPosition(U,te,{enableHighAccuracy:!0,timeout:j===0?15e3:3e4,maximumAge:0})}),F=Math.round(T.coords.accuracy);if(v(F),(!M||F<M.coords.accuracy)&&(M=T),F<=P){console.log(`‚úÖ GPS precisione raggiunta: ${F}m (richiesti ‚â§${P}m)`);break}console.log(`üéØ Tentativo ${j+1}: precisione ${F}m (target ‚â§${P}m)`),j<D-1&&await new Promise(U=>setTimeout(U,R))}catch(T){if(console.error(`‚ùå Errore GPS tentativo ${j+1}:`,T),j===D-1)return x(E(T.code)),u(!1),null}j++}if(M)try{const T=await S(M.coords.latitude,M.coords.longitude),F={latitude:M.coords.latitude,longitude:M.coords.longitude,address:T,accuracy:Math.round(M.coords.accuracy),timestamp:new Date};return l(F),u(!1),console.log(`üìç Posizione finale: ${T} (¬±${F.accuracy}m)`),F}catch(T){return console.error("Errore nel reverse geocoding:",T),x("Errore nel determinare l'indirizzo"),u(!1),null}return x("Impossibile ottenere posizione GPS precisa"),u(!1),null},[]),E=k=>{switch(k){case 1:return"Permesso GPS negato - Attiva GPS nelle impostazioni del telefono";case 2:return"Posizione non disponibile - Controlla che il GPS sia attivo";case 3:return"Timeout GPS - Segnale debole o GPS spento. Vai all'aperto e riprova";default:return"Errore GPS - Controlla che il GPS sia attivo e riprova"}};return{currentLocation:n,isLoading:c,error:f,accuracy:b,getCurrentLocation:g,clearLocation:()=>{l(null),x(null),v(null)}}},ln=()=>{const{user:n}=Pt(),[l,c]=w.useState(null),[u,f]=w.useState([]),[x,b]=w.useState(!0),[v,S]=w.useState("00:00:00"),[g,E]=w.useState({}),p=w.useRef(null),k=w.useRef(null);w.useEffect(()=>(l&&l.isActive?P(l.checkInTime):D(),()=>{D()}),[l==null?void 0:l.id,l==null?void 0:l.isActive]),w.useEffect(()=>(u.length>0?R(u):j(),()=>{j()}),[u.length]);const P=N=>{p.current&&clearInterval(p.current);const _=new Date,[V,C]=N.split(":").map(Number),K=new Date(_.getFullYear(),_.getMonth(),_.getDate(),V,C,0),O=()=>{const se=new Date().getTime()-K.getTime();if(se<0){S("00:00:00");return}const W=Math.floor(se/1e3),G=Math.floor(W/3600),B=Math.floor(W%3600/60),ne=W%60,ye=`${G.toString().padStart(2,"0")}:${B.toString().padStart(2,"0")}:${ne.toString().padStart(2,"0")}`;S(ye)};O(),p.current=setInterval(O,1e3)},D=()=>{p.current&&(clearInterval(p.current),p.current=null),S("00:00:00")},R=N=>{k.current&&clearInterval(k.current);const _=()=>{const V=new Date,C=new Date,K={};N.forEach(O=>{const[X,se]=O.checkInTime.split(":").map(Number),W=new Date(C.getFullYear(),C.getMonth(),C.getDate(),X,se,0),G=V.getTime()-W.getTime();if(G<0){K[O.id]="00:00:00";return}const B=Math.floor(G/1e3),ne=Math.floor(B/3600),ye=Math.floor(B%3600/60),me=B%60;K[O.id]=`${ne.toString().padStart(2,"0")}:${ye.toString().padStart(2,"0")}:${me.toString().padStart(2,"0")}`}),E(K)};_(),k.current=setInterval(_,1e3)},j=()=>{k.current&&(clearInterval(k.current),k.current=null),E({})};w.useEffect(()=>{n!=null&&n.id&&M()},[n==null?void 0:n.id]);const M=async()=>{try{if(b(!0),!Se)return;const N=new Date().toISOString().split("T")[0],_=[],{data:V,error:C}=await Se.from("warehouse_checkins").select("*").eq("crew_id",n==null?void 0:n.id).eq("date",N).in("status",["active","checked_in"]).is("check_out_time",null).maybeSingle();if(!C&&V){const W={id:V.id,type:"warehouse",warehouseId:V.warehouse_id,checkInTime:V.check_in_time,scheduledEndTime:"17:00",shiftName:"Turno Magazzino",hasCompanyMeal:V.company_meal||!1,hasMealVoucher:V.meal_voucher||!1,breakTime:V.break_minutes||0,isActive:!0,tableName:"warehouse_checkins"};_.push(W),c(W)}const{data:K,error:O}=await Se.from("extra_shifts_checkins").select("*").eq("crew_id",n==null?void 0:n.id).eq("date",N).in("status",["active","checked_in"]).is("check_out_time",null).maybeSingle();if(!O&&K){const W={id:K.id,type:"extra",warehouseId:null,checkInTime:K.check_in_time,scheduledEndTime:"17:00",shiftName:"Turno Extra",hasCompanyMeal:K.company_meal||!1,hasMealVoucher:K.meal_voucher||!1,breakTime:K.break_minutes||0,isActive:!0,tableName:"extra_shifts_checkins"};_.push(W),V||c(W)}const{data:X,error:se}=await Se.from("timesheet_entries").select(`
          *,
          crew_events!event_id(title, end_date, location)
        `).eq("crew_id",n==null?void 0:n.id).eq("date",N).eq("status","draft").is("end_time",null).maybeSingle();if(!se&&X){const W=X.crew_events,G={id:X.id,type:"event",eventId:X.event_id,checkInTime:X.start_time,scheduledEndTime:"17:00",shiftName:(W==null?void 0:W.title)||"Evento",hasCompanyMeal:X.company_meal||!1,hasMealVoucher:X.meal_voucher||!1,isActive:!0};_.push(G),V||c(G)}f(_)}catch(N){console.error("Errore caricamento sessioni:",N)}finally{b(!1)}},T=w.useCallback(N=>{const _={...N,isActive:!0};c(_)},[]),F=w.useCallback(N=>{N?(f(_=>_.filter(V=>V.id!==N)),(l==null?void 0:l.id)===N&&(D(),c(null))):(D(),c(null))},[l]),U=async(N,_)=>{if(!l)return console.error("‚ùå Nessuna sessione attiva per check-out"),!1;try{if(!(n!=null&&n.id))return console.error("‚ùå User ID non valido per check-out"),!1;const V=new Date,C=`${V.getHours().toString().padStart(2,"0")}:${V.getMinutes().toString().padStart(2,"0")}`;if(console.log(`üîÑ Tentativo check-out manuale alle ${C} per sessione ${l.id}`),console.log(`üìã Tipo sessione: ${l.type}`),console.log("üìç Checkout location:",N),console.log("üìù Note checkout:",_),l.type==="warehouse"){const K=l.tableName||"warehouse_checkins";console.log(`üíæ Aggiornamento ${K} id=${l.id}`);const{data:O,error:X}=await Se.from(K).select("check_in_time, pausa_pranzo_minuti, break_minutes, warehouse_id").eq("id",l.id).maybeSingle();if(X&&console.error("‚ùå ERRORE nella verifica del record:",X),!O)return console.error(`‚ùå Record NON TROVATO in ${K} con id:`,l.id),!1;let se=!1,W=null;if(N&&O.warehouse_id){const{data:ve}=await Se.from("warehouses").select("latitude, longitude").eq("id",O.warehouse_id).maybeSingle();if(ve!=null&&ve.latitude&&(ve!=null&&ve.longitude)){const Te=te(N.latitude,N.longitude,ve.latitude,ve.longitude);W=Math.round(Te),se=Te>1e3,se&&console.warn("üö® ALERT: Check-out effettuato lontano dal magazzino!",{distance:W})}}const G=O.check_in_time,[B,ne]=G.split(":").map(Number),[ye,me]=C.split(":").map(Number),Q=B*60+ne;let be=ye*60+me-Q;be<0&&(be+=24*60);const Z=be/60,L=O.pausa_pranzo_minuti||O.break_minutes||0,re=(be-L)/60,de={check_out_time:C,status:"completed",total_hours:Math.round(Z*100)/100,net_hours:Math.round(re*100)/100};_&&_.trim()&&(de.notes=_.trim()),N&&(de.checkout_location={latitude:N.latitude,longitude:N.longitude,address:N.address,accuracy:N.accuracy,timestamp:N.timestamp.toISOString()},de.checkout_location_alert=se,de.checkout_distance_from_warehouse=W),console.log("üìù Dati da aggiornare:",de),console.log("üîç Condizione WHERE: id =",l.id),console.log("‚è±Ô∏è Ore calcolate - Totali:",de.total_hours,"Nette:",de.net_hours);const{data:oe,error:ge}=await Se.from(K).update(de).eq("id",l.id).select().maybeSingle();if(ge)return console.error("‚ùå ERRORE UPDATE WAREHOUSE CHECK-OUT:",ge),console.error("‚ùå Dettagli errore:",JSON.stringify(ge,null,2)),console.error("‚ùå Codice errore:",ge.code),console.error("‚ùå Messaggio errore:",ge.message),!1;if(!oe)return console.error("‚ùå Nessun dato restituito dall'update (possibile record non trovato dopo update)"),!1;console.log("‚úÖ Check-out magazzino salvato nel DB:",oe),console.log("‚úÖ Verifica campi aggiornati:"),console.log("   - check_out_time:",oe.check_out_time),console.log("   - status:",oe.status)}else if(l.type==="extra"){const K="extra_shifts_checkins";console.log(`üíæ Aggiornamento ${K} id=${l.id}`);const{data:O,error:X}=await Se.from(K).select("check_in_time, break_minutes").eq("id",l.id).maybeSingle();if(X&&console.error("‚ùå ERRORE nella verifica del record:",X),!O)return console.error(`‚ùå Record NON TROVATO in ${K} con id:`,l.id),!1;const se=O.check_in_time,[W,G]=se.split(":").map(Number),[B,ne]=C.split(":").map(Number),ye=W*60+G;let Q=B*60+ne-ye;Q<0&&(Q+=24*60);const fe=Q/60,be=O.break_minutes||0,Z=(Q-be)/60,L={check_out_time:C,status:"completed",total_hours:Math.round(fe*100)/100,net_hours:Math.round(Z*100)/100};console.log("üìù Dati da aggiornare:",L),console.log("‚è±Ô∏è Ore calcolate - Totali:",L.total_hours,"Nette:",L.net_hours);const{data:re,error:de}=await Se.from(K).update(L).eq("id",l.id).select().maybeSingle();if(de)return console.error("‚ùå ERRORE UPDATE EXTRA CHECK-OUT:",de),console.error("‚ùå Dettagli errore:",JSON.stringify(de,null,2)),!1;if(!re)return console.error("‚ùå Nessun dato restituito dall'update"),!1;console.log("‚úÖ Check-out turno extra salvato nel DB:",re)}else{console.log(`üíæ Aggiornamento timesheet_entries id=${l.id}`);const{data:K,error:O}=await Se.from("timesheet_entries").update({end_time:C,status:"submitted"}).eq("id",l.id).select().single();if(O)return console.error("‚ùå ERRORE UPDATE TIMESHEET CHECK-OUT:",O),console.error("‚ùå Dettagli errore:",JSON.stringify(O,null,2)),!1;console.log("‚úÖ Check-out evento salvato nel DB:",K)}return console.log("‚úÖ Check-out completato con successo nel database"),!0}catch(V){return console.error("‚ùå Errore nel check-out manuale:",V),!1}},te=(N,_,V,C)=>{const O=N*Math.PI/180,X=V*Math.PI/180,se=(V-N)*Math.PI/180,W=(C-_)*Math.PI/180,G=Math.sin(se/2)*Math.sin(se/2)+Math.cos(O)*Math.cos(X)*Math.sin(W/2)*Math.sin(W/2);return 6371e3*(2*Math.atan2(Math.sqrt(G),Math.sqrt(1-G)))};return{currentSession:l,activeSessions:u,elapsedTime:v,elapsedTimes:g,isLoading:x,startSession:T,endSession:F,manualCheckOut:U,loadActiveSession:M}};function fr(n=new Date){const l=n.getFullYear(),c=String(n.getMonth()+1).padStart(2,"0"),u=String(n.getDate()).padStart(2,"0");return`${l}-${c}-${u}`}function da(){return fr(new Date)}function Jc(){const n=new Date;return n.setDate(n.getDate()+1),fr(n)}function rr(n){if(!n)return"";if(/^\d{2}:\d{2}$/.test(n))return n;if(/^\d{2}:\d{2}:\d{2}$/.test(n))return n.substring(0,5);try{const l=new Date(n);if(!isNaN(l.getTime()))return l.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit",hour12:!1,timeZone:"Europe/Rome"})}catch(l){console.error("Errore parsing timestamp:",l)}return""}const ed=()=>{var Be;const{user:n}=Pt(),{showSuccess:l,showError:c,showWarning:u,showInfo:f}=ms(),{currentLocation:x,getCurrentLocation:b,isLoading:v,error:S}=on(),{isOnline:g,addOfflineData:E}=Sa(),{currentSession:p,activeSessions:k,elapsedTime:P,elapsedTimes:D,startSession:R,endSession:j,manualCheckOut:M,loadActiveSession:T}=ln(),[F,U]=w.useState("main"),[te,N]=w.useState([]),[_,V]=w.useState([]),[C,K]=w.useState(null),[O,X]=w.useState(!0),[se,W]=w.useState(null),[G,B]=w.useState(null),[ne,ye]=w.useState(null),[me,Q]=w.useState([]),[fe,be]=w.useState(""),[Z,L]=w.useState(null),[re,de]=w.useState(!1),[oe,ge]=w.useState(!1),[ve,Te]=w.useState(!1),[we,je]=w.useState(null),Fe=w.useRef(null),[Ve,rt]=w.useState(!1),[st,Je]=w.useState(null),[Qe,We]=w.useState(!1),[gt,qe]=w.useState(null),[De,H]=w.useState(null),[ae,he]=w.useState(null),[Ae,Re]=w.useState(!1),[ee,le]=w.useState(null),[Ee,_e]=w.useState(""),[J,ke]=w.useState(""),[$,ue]=w.useState(!1),[xe,pe]=w.useState(""),[Ze,at]=w.useState(!1),[bt,Oe]=w.useState(null),It=w.useCallback(async(Ie,Pe,Ke)=>{try{const{data:nt,error:He}=await Se.from("warehouse_checkins").update({check_out_time:Pe,status:"completed",has_checked_out:!0,notes:`Auto-checkout effettuato alle ${Pe}.  Sessione chiusa automaticamente dopo ${Ke.toFixed(1)} ore di ritardo.`}).eq("id",Ie.id).select().single();if(He)return;p&&p.id===Ie.id&&j(),f("Turno Auto-Completato",`Il tuo turno √® stato automaticamente completato alle ${Pe}. Sessione chiusa per superamento orario.`,8e3)}catch{}},[p,j,f]),ct=w.useCallback(async()=>{var Ie;if(!(!p||p.type!=="warehouse"))try{const Pe=da(),He=new Date().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit",hour12:!1,timeZone:"Europe/Rome"}).replace(":",": "),{data:$e,error:Xe}=await Se.from("warehouse_checkins").select(`
          *,
          crew_template_turni! shift_id(ora_fine_turno)
        `).eq("id",p.id).eq("status","active").is("check_out_time",null).maybeSingle();if(Xe||!$e)return;const ot=((Ie=$e.crew_template_turni)==null?void 0:Ie.ora_fine_turno)||$e.ora_fine_turno||"17:00",St=ds(ot);if(mt(He,St)){const Gt=dr(St,He);await It($e,St,Gt)}}catch{}},[p,n==null?void 0:n.id,It]);w.useEffect(()=>(n!=null&&n.id&&(br(),Es(),kr(),ls(),ws()),()=>{Fe.current&&Fe.current.clear()}),[n==null?void 0:n.id]);const ws=async()=>{if(!(!p||p.type!=="warehouse"))try{const{data:Ie,error:Pe}=await Se.from("warehouse_checkins").select("pausa_cena_inizio, pausa_cena_fine, pausa_cena_start_location, has_taken_break").eq("id",p.id).maybeSingle();if(Pe||!Ie)return;Ie.pausa_cena_inizio&&!Ie.pausa_cena_fine?(We(!0),qe(Ie.pausa_cena_inizio),H(null),he(Ie.pausa_cena_start_location)):Ie.pausa_cena_inizio&&Ie.pausa_cena_fine&&(We(!1),qe(Ie.pausa_cena_inizio),H(Ie.pausa_cena_fine))}catch(Ie){console.error("Errore caricamento stato pausa:",Ie)}};w.useEffect(()=>{(p==null?void 0:p.type)==="warehouse"&&ws()},[p==null?void 0:p.id]),w.useEffect(()=>{if(!p||p.type!=="warehouse")return;b({requiredAccuracy:50,maxRetries:2});const Ie=setInterval(()=>{b({requiredAccuracy:50,maxRetries:1})},3e4);return()=>{clearInterval(Ie)}},[p==null?void 0:p.id,b]),w.useEffect(()=>{if(!(n!=null&&n.id)||!p||p.type!=="warehouse")return;ct();const Ie=setInterval(()=>{ct()},6e4);return()=>{clearInterval(Ie)}},[n==null?void 0:n.id,p==null?void 0:p.id,p==null?void 0:p.type,ct]);const $t=Ie=>{const Pe=new Date,nt=Pe.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit",hour12:!1,timeZone:"Europe/Rome"}).replace(":",":"),He=fr(Pe),$e=Ie.data_turno,Xe=ds(Ie.ora_inizio_turno),ot=ds(Ie.ora_fine_turno);if(He!==$e)return He>$e?{isValid:!1,reason:`Turno del ${new Date($e).toLocaleDateString("it-IT")} gi√† passato`,canCheckIn:!1,canCheckOut:!1,isExpired:!0}:{isValid:!1,reason:`Turno programmato per ${new Date($e).toLocaleDateString("it-IT")}`,canCheckIn:!1,canCheckOut:!1,isExpired:!1};const St=Tt(nt,Xe),Gt=mt(nt,ot);if(St){const jt=hs(Xe,nt),ts=4*60;return jt<=ts?{isValid:!0,reason:`Check-in anticipato consentito (turno inizia alle ${Xe})`,canCheckIn:!0,canCheckOut:!1,isExpired:!1}:{isValid:!1,reason:`Turno inizia alle ${Xe} (tra ${jt} minuti). Check-in disponibile da 4 ore prima. `,canCheckIn:!1,canCheckOut:!1,isExpired:!1}}if(Gt){const jt=dr(ot,nt);return{isValid:!1,reason:`Turno terminato alle ${ot} (${jt.toFixed(1)} ore fa)`,canCheckIn:!1,canCheckOut:!1,isExpired:!0,hoursLate:jt}}return{isValid:!0,reason:`Turno attivo:  ${Xe} - ${ot}`,canCheckIn:!0,canCheckOut:!0,isExpired:!1}},Tt=(Ie,Pe)=>{const[Ke,nt]=Ie.split(": ").map(Number),[He,$e]=Pe.split(":").map(Number);return Ke*60+nt<He*60+$e},mt=(Ie,Pe)=>{const[Ke,nt]=Ie.split(":").map(Number),[He,$e]=Pe.split(":").map(Number);return Ke*60+nt>He*60+$e},hs=(Ie,Pe)=>{const[Ke,nt]=Ie.split(":").map(Number),[He,$e]=Pe.split(":").map(Number);return Ke*60+nt-(He*60+$e)},dr=(Ie,Pe)=>{const[Ke,nt]=Ie.split(":").map(Number),[He,$e]=Pe.split(":").map(Number);return(He*60+$e-(Ke*60+nt))/60},Es=async()=>{try{const{data:Ie,error:Pe}=await Se.from("employee_meal_benefits").select("*").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0).maybeSingle();if(Pe){K({buoni_pasto_enabled:!1,buoni_pasto_value:7.5,pasto_aziendale_cost:12});return}K(Ie?{buoni_pasto_enabled:Ie.buoni_pasto_enabled,buoni_pasto_value:Ie.buoni_pasto_value||7.5,pasto_aziendale_cost:Ie.pasto_aziendale_cost||12}:{buoni_pasto_enabled:!1,buoni_pasto_value:7.5,pasto_aziendale_cost:12})}catch{K({buoni_pasto_enabled:!1,buoni_pasto_value:7.5,pasto_aziendale_cost:12})}},kr=async()=>{var Ie,Pe,Ke;try{const nt=da(),{data:He,error:$e}=await Se.from("warehouse_checkins").select("*").eq("crew_id",n==null?void 0:n.id).eq("date",nt);if(!$e&&He){console.log("üìã Check-in trovati oggi:",He.length),Q(He);const Xe=He.find(ot=>ot.status==="active");if(ye(Xe||null),Xe&&(!p||p.id!==Xe.id)){console.log("üîÑ Ripristino sessione da check-in attivo nel DB");const{data:ot}=await Se.from("crew_assegnazione_turni").select("*, crew_template_turni! turno_id(pausa_pranzo, ora_inizio_turno, ora_fine_turno)").eq("id",Xe.shift_id).maybeSingle(),St=((Ie=ot==null?void 0:ot.crew_template_turni)==null?void 0:Ie.ora_inizio_turno)||(ot==null?void 0:ot.ora_inizio_turno)||"09:00",Gt=((Pe=ot==null?void 0:ot.crew_template_turni)==null?void 0:Pe.ora_fine_turno)||(ot==null?void 0:ot.ora_fine_turno)||"17:00",jt=((Ke=ot==null?void 0:ot.crew_template_turni)==null?void 0:Ke.pausa_pranzo)!==!1;R({id:Xe.id,type:"warehouse",warehouseId:Xe.warehouse_id,checkInTime:Xe.check_in_time,scheduledEndTime:ds(Gt),shiftName:(ot==null?void 0:ot.nome_turno)||"Turno Magazzino",shiftStartTime:St,shiftEndTime:Gt,hasLunchBreak:jt,hasCompanyMeal:Xe.company_meal||!1,hasMealVoucher:Xe.meal_voucher||!1,breakTime:Xe.break_minutes||0})}Hs(He)}}catch{}},Hs=async Ie=>{var Pe;try{const Ke=new Date;for(const nt of Ie){const{data:He}=await Se.from("crew_assegnazione_turni").select("*, crew_template_turni!turno_id(pausa_pranzo)").eq("id",nt.shift_id).maybeSingle();if(nt.status!=="completed"||!((Pe=He==null?void 0:He.crew_template_turni)!=null&&Pe.pausa_pranzo)||nt.has_taken_break||nt.break_auto_applied)continue;const $e=new Date(`${nt.date}T${nt.check_out_time}`);if((Ke.getTime()-$e.getTime())/(1e3*60*60)<8){le(nt),Re(!0);break}}}catch(Ke){console.error("Errore controllo pause mancanti:",Ke)}},br=async()=>{try{X(!0);const Ie=da();console.log("üìÖ Caricamento turni da data:",Ie);const{data:Pe,error:Ke}=await Se.from("crew_assegnazione_turni").select(`
          *,
          crew_template_turni!turno_id(
            id_template,
            nome_template,
            ora_inizio_turno,
            ora_fine_turno,
            pausa_pranzo,
            warehouse_id,
            nome_magazzino,
            warehouses! warehouse_id(
              name,
              address
            )
          )
        `).eq("dipendente_id",n==null?void 0:n.id).gte("data_turno",Ie).order("data_turno",{ascending:!0}).order("ora_inizio_turno",{ascending:!0});if(Ke)N([]);else{const nt=(Pe||[]).map(He=>{var $e,Xe,ot,St,Gt;return{...He,ora_inizio_turno:(($e=He.crew_template_turni)==null?void 0:$e.ora_inizio_turno)||He.ora_inizio_turno,ora_fine_turno:((Xe=He.crew_template_turni)==null?void 0:Xe.ora_fine_turno)||He.ora_fine_turno,nome_magazzino:((ot=He.crew_template_turni)==null?void 0:ot.nome_magazzino)||He.nome_magazzino,warehouse_address:((Gt=(St=He.crew_template_turni)==null?void 0:St.warehouses)==null?void 0:Gt.address)||"Indirizzo non disponibile"}});console.log("‚úÖ Turni magazzino caricati:",nt.length,nt.map(He=>{var $e,Xe;return{nome:He.nome_turno,data:He.data_turno,orario:`${He.ora_inizio_turno}-${He.ora_fine_turno}`,template_orario:`${($e=He.crew_template_turni)==null?void 0:$e.ora_inizio_turno}-${(Xe=He.crew_template_turni)==null?void 0:Xe.ora_fine_turno}`}})),N(nt)}}catch{N([])}finally{X(!1)}},ls=async()=>{try{const{data:Ie,error:Pe}=await Se.from("warehouses").select("*").order("name");if(Pe){V([]);return}V(Ie||[])}catch{V([])}},qs=Ie=>{const Pe=$t(Ie);if(L(Pe),!Pe.isValid||!Pe.canCheckIn){Pe.isExpired?c("Turno Scaduto",`Non puoi fare check-in:  ${Pe.reason}`):u("Turno Non Disponibile",`Check-in non disponibile:  ${Pe.reason}`);return}B(Ie),x?xs(Ie):(u("GPS Richiesto","Attivazione GPS in corso per il check-in magazzino.. ."),b({requiredAccuracy:20,maxRetries:3}).then(()=>{xs(Ie)}))},xs=Ie=>{var Pe;ge((C==null?void 0:C.buoni_pasto_enabled)||!1),((Pe=Ie.crew_template_turni)==null?void 0:Pe.pausa_pranzo)!==!1?U("meal_selection"):(de(!1),et())},et=()=>{U("scanner"),Zs()},Zs=()=>{Te(!0),je(null),setTimeout(()=>{if(!document.getElementById("qr-reader")){je("Elemento scanner non trovato nel DOM");return}try{const Pe={fps:10,qrbox:{width:250,height:250},rememberLastUsedCamera:!0,supportedScanTypes:[0],aspectRatio:1,formatsToSupport:[0],defaultZoomValueIfSupported:2,videoConstraints:{facingMode:"environment",advanced:[{facingMode:"environment"}]},experimentalFeatures:{useBarCodeDetectorIfSupported:!0}},Ke=new Kc("qr-reader",Pe,!1);Ke.render(Mr,cs),Fe.current=Ke}catch(Pe){console.error("Errore inizializzazione scanner:",Pe),je("Errore nell'inizializzazione del scanner QR")}},300)},Mr=Ie=>{W(Ie),be(""),Fe.current&&Fe.current.clear(),Te(!1),U("main"),Gs(Ie)},cs=Ie=>{Ie.includes("NotFoundException")||console.error("QR scan error:",Ie)},Gs=Ie=>{const Pe=_.find(Ke=>Ke.backup_code===Ie);if(!Pe){_.length===0?c("Errore Database","Nessun magazzino caricato dal database!  Verifica connessione e permessi."):c("Codice Backup Non Riconosciuto",`Il codice backup "${Ie}" non corrisponde a nessun magazzino registrato.  Verifica di aver inserito il codice corretto.`);return}ur(Pe)},ur=async(Ie,Pe=!1)=>{var jt,ts,Qs;let Ke=x,nt=!1,He=null;if(!Ke&&!Pe){Je(Ie),rt(!0);return}if(!Ke&&Pe&&(nt=!0,He=S||"GPS non disponibile - Check-in forzato dall'utente",console.warn("‚ö†Ô∏è Check-in magazzino forzato senza GPS:",He)),!G){c("Errore Check-in","Turno non selezionato");return}const $e=$t(G);if(!$e.isValid||!$e.canCheckIn){c("Check-in Non Valido",`Impossibile procedere:  ${$e.reason}`);return}const Xe=new Date,ot=`${Xe.getHours().toString().padStart(2,"0")}:${Xe.getMinutes().toString().padStart(2,"0")}`,St=fr(Xe);if(me.find(vt=>{const ss=vt.date,Ws=G.data_turno.split("T")[0];return vt.shift_id===G.turno_id&&ss===Ws})){c("Check-in Duplicato","Hai gi√† effettuato il check-in per questo turno oggi.  Verifica lo storico dei tuoi check-in.");return}try{const vt=((jt=G.crew_template_turni)==null?void 0:jt.pausa_pranzo)!==!1?60:0;let ss=!1,Ws=null;if(Ke&&!nt){const wt=await sa(Ke.latitude,Ke.longitude,Ie.id,500);Ws=wt.distance,ss=wt.alert,ss&&console.warn("üö® ALERT: Check-in effettuato lontano dal magazzino! ",{distance:Math.round(wt.distance),warehouse:Ie.name})}const As={warehouse_id:Ie.id,crew_id:n==null?void 0:n.id,date:St,check_in_time:ot,status:"active",location:Ke?{latitude:Ke.latitude,longitude:Ke.longitude,address:Ke.address,accuracy:Ke.accuracy,timestamp:Ke.timestamp.toISOString()}:null,forced_checkin:nt,gps_error_reason:He,location_alert:ss,distance_from_warehouse:Ws,shift_id:G.turno_id,break_minutes:vt,company_meal:re,meal_voucher:oe,meal_cost:re?(C==null?void 0:C.pasto_aziendale_cost)||12:0,meal_notes:re?"Pasto aziendale richiesto":oe?"Buono pasto richiesto":null};if(g){const{data:wt,error:Vt}=await Se.from("warehouse_checkins").insert(As).select().single();if(Vt)console.error("‚ùå ERRORE CHECK-IN WAREHOUSE:",Vt),console.error("   - Code:",Vt.code),console.error("   - Message:",Vt.message),console.error("   - Details:",Vt.details),console.error("   - Hint:",Vt.hint),E("checkin",As),u("Check-in Offline",`Errore database: ${Vt.message} - Salvato offline e sar√† sincronizzato`);else{const Ce=ds(G.ora_fine_turno);console.log("‚úÖ CHECK-IN WAREHOUSE SALVATO NEL DB: "),console.log("   - ID check-in:",wt.id),console.log("   - Crew ID:",wt.crew_id),console.log("   - Warehouse ID:",wt.warehouse_id),console.log("   - Check-in time:",wt.check_in_time),console.log("   - Status:",wt.status),R({id:wt.id,type:"warehouse",warehouseId:Ie.id,checkInTime:ot,scheduledEndTime:Ce,shiftName:`Turno ${G.nome_magazzino}`,shiftStartTime:G.ora_inizio_turno,shiftEndTime:G.ora_fine_turno,hasLunchBreak:((ts=G.crew_template_turni)==null?void 0:ts.pausa_pranzo)!==!1,hasCompanyMeal:re,hasMealVoucher:oe,breakTime:vt}),console.log("‚úÖ SESSIONE LOCALE AVVIATA con ID:",wt.id);let q=nt?`‚ö†Ô∏è CHECK-IN FORZATO COMPLETATO!

`:`‚úÖ CHECK-IN COMPLETATO!

`;q+=`üè≠ ${G.nome_magazzino}
`,q+=`‚è∞ Inizio: ${ot}
`,q+=`üïê Fine prevista: ${Ce}
`,q+=nt?`‚ö†Ô∏è Check-in senza GPS (forzato)
`:`üìç Posizione GPS verificata
`,((Qs=G.crew_template_turni)==null?void 0:Qs.pausa_pranzo)!==!1&&(q+=`‚òï Include 1 ora di pausa pranzo
`),re&&(q+=`üçΩÔ∏è Pasto aziendale:  ‚Ç¨${(C==null?void 0:C.pasto_aziendale_cost)||12}
`),oe&&(q+=`üé´ Buono pasto: ‚Ç¨${(C==null?void 0:C.buoni_pasto_value)||7.5}
`),nt?u("Check-in Forzato Completato",q):l("Check-in Completato",q),await T()}}else E("checkin",As),f("Check-in Offline","Check-in salvato offline - Verr√† sincronizzato quando torni online");B(null),de(!1),ge(!1)}catch{c("Errore Check-in","Si √® verificato un errore durante il check-in.  Riprova.")}},wr=async()=>{if(!p||p.type!=="warehouse"){u("Nessuna Sessione","Non c'√® una sessione magazzino attiva da terminare");return}ue(!0)},Ss=async()=>{ue(!1),console.log("üî¥ INIZIO PROCESSO CHECK-OUT MANUALE"),console.log("üìã Sessione corrente:",p),console.log("‚è±Ô∏è Tempo trascorso:",P),console.log("üìù Note checkout:",xe);try{f("Check-out in corso... ","Sto completando il turno magazzino",2e3),console.log("üìû Chiamata a manualCheckOut().. ."),console.log("üìç Passaggio location al checkout:",x);const Ie=await M(x,xe);if(console.log("‚úÖ Risultato manualCheckOut():",Ie),Ie){if(console.log("‚úÖ Check-out salvato nel database, ora termino la sessione locale"),j(),console.log("‚úÖ Sessione locale terminata"),We(!1),qe(null),H(null),he(null),pe(""),l("Check-out Completato",`Turno magazzino terminato con successo!  Tempo totale: ${P}`),console.log("üîÑ Ricaricamento dati dal database..."),await kr(),await br(),console.log("‚úÖ Dati ricaricati"),"caches"in window){const Pe=await caches.keys();for(const Ke of Pe)(Ke.includes("supabase")||Ke.includes("warehouse"))&&await caches.delete(Ke);console.log("üóëÔ∏è Cache pulita")}setTimeout(()=>{window.location.reload()},1e3)}else console.error("‚ùå Check-out FALLITO - success = false"),c("Errore Check-out","Si √® verificato un errore durante il check-out. Riprova.")}catch(Ie){console.error("‚ùå ERRORE CATCH nel check-out:",Ie),c("Errore Sistema","Errore imprevisto durante il check-out magazzino")}},ea=async(Ie=!1)=>{if(console.log("üçΩÔ∏è === INIZIO PAUSA - DEBUG ==="),console.log("Current Session:",p),console.log("Session ID:",p==null?void 0:p.id),console.log("Current Location:",x),console.log("Force without GPS:",Ie),!p||p.type!=="warehouse"){console.error("‚ùå Nessuna sessione warehouse attiva"),c("Errore","Nessuna sessione warehouse attiva");return}if(Qe){console.warn("‚ö†Ô∏è Pausa gi√† in corso"),u("Pausa gi√† iniziata","Hai gi√† iniziato una pausa. Termina prima questa pausa.");return}if(gt&&De){console.warn("‚ö†Ô∏è Pausa gi√† completata"),u("Pausa gi√† effettuata","Hai gi√† effettuato la pausa pranzo per questo turno.");return}let Pe=x,Ke=!1,nt=null;if(!Pe&&!Ie&&(console.warn("‚ö†Ô∏è GPS non disponibile, tentativo riattivazione..."),u("GPS Non Disponibile","Richiesta attivazione GPS..."),await b({requiredAccuracy:20,maxRetries:2}),Pe=x,!Pe)){console.warn("‚ö†Ô∏è GPS ancora non disponibile dopo tentativi, mostro modal forzatura"),Oe("start"),at(!0);return}!Pe&&Ie&&(Ke=!0,nt=S||"GPS non disponibile - Pausa forzata dall'utente",console.warn("‚ö†Ô∏è Inizio pausa forzato senza GPS:",nt));const He=new Date,$e=`${He.getHours().toString().padStart(2,"0")}:${He.getMinutes().toString().padStart(2,"0")}`;console.log("‚è∞ Orario inizio pausa:",$e),console.log("üìç Location da salvare:",Pe),console.log("üîí Forced break:",Ke);try{const Xe={break_start_time:$e,break_start_forced:Ke};Pe&&(Xe.break_start_location={latitude:Pe.latitude,longitude:Pe.longitude,address:Pe.address,accuracy:Pe.accuracy,timestamp:Pe.timestamp.toISOString(),forced:Ke}),Ke&&nt&&(Xe.break_start_gps_error=nt),console.log("üíæ Dati da salvare:",Xe),console.log("üéØ Update su ID:",p.id);const{data:ot,error:St}=await Se.from("warehouse_checkins").update(Xe).eq("id",p.id).select();if(console.log("üì§ Risposta Supabase:",{data:ot,error:St}),St){console.error("‚ùå Errore salvataggio pausa:",St),console.error("Dettagli errore:",JSON.stringify(St,null,2)),c("Errore",`Impossibile salvare inizio pausa: ${St.message}`);return}We(!0),qe($e),he(Pe),Ke?u("Pausa Iniziata (Forzata)",`Inizio pausa registrato alle ${$e} SENZA GPS`):l("Pausa Iniziata",`Inizio pausa registrato alle ${$e} con GPS verificato`)}catch(Xe){console.error("Errore sistema pausa:",Xe),c("Errore Sistema","Errore durante il salvataggio della pausa")}},ta=async(Ie=!1)=>{if(!p||p.type!=="warehouse"){c("Errore","Nessuna sessione warehouse attiva");return}if(!Qe){u("Nessuna pausa attiva","Devi prima iniziare una pausa");return}let Pe=x,Ke=!1,nt=null;if(!Pe&&!Ie&&(u("GPS Non Disponibile","Richiesta attivazione GPS..."),await b({requiredAccuracy:20,maxRetries:2}),Pe=x,!Pe)){Oe("end"),at(!0);return}!Pe&&Ie&&(Ke=!0,nt=S||"GPS non disponibile - Pausa forzata dall'utente",console.warn("‚ö†Ô∏è Fine pausa forzata senza GPS:",nt));const He=new Date,$e=`${He.getHours().toString().padStart(2,"0")}:${He.getMinutes().toString().padStart(2,"0")}`;try{const Xe={break_end_time:$e,has_taken_break:!0,break_registered_late:!1,break_end_forced:Ke};Pe&&(Xe.break_end_location={latitude:Pe.latitude,longitude:Pe.longitude,address:Pe.address,accuracy:Pe.accuracy,timestamp:Pe.timestamp.toISOString(),forced:Ke}),Ke&&nt&&(Xe.break_end_gps_error=nt);const{error:ot}=await Se.from("warehouse_checkins").update(Xe).eq("id",p.id);if(ot){console.error("Errore salvataggio fine pausa:",ot),c("Errore","Impossibile salvare fine pausa");return}const St=fs(gt,$e);await ws(),Ke?u("Pausa Terminata (Forzata)",`Fine pausa registrata alle ${$e} SENZA GPS. Durata: ${St} minuti`):l("Pausa Terminata",`Fine pausa registrata alle ${$e}. Durata: ${St} minuti`)}catch(Xe){console.error("Errore sistema fine pausa:",Xe),c("Errore Sistema","Errore durante il salvataggio della pausa")}},fs=(Ie,Pe)=>{const[Ke,nt]=Ie.split(":").map(Number),[He,$e]=Pe.split(":").map(Number);return He*60+$e-(Ke*60+nt)},es=(Ie,Pe,Ke,nt)=>{const $e=Ie*Math.PI/180,Xe=Ke*Math.PI/180,ot=(Ke-Ie)*Math.PI/180,St=(nt-Pe)*Math.PI/180,Gt=Math.sin(ot/2)*Math.sin(ot/2)+Math.cos($e)*Math.cos(Xe)*Math.sin(St/2)*Math.sin(St/2);return 6371e3*(2*Math.atan2(Math.sqrt(Gt),Math.sqrt(1-Gt)))},Lt=async Ie=>{try{const{data:Pe,error:Ke}=await Se.from("warehouses").select("latitude, longitude, address").eq("id",Ie).maybeSingle();return Ke||!Pe?(console.warn("Coordinate magazzino non trovate:",Ke),null):Pe.latitude&&Pe.longitude?{lat:Pe.latitude,lon:Pe.longitude}:(console.warn("‚ö†Ô∏è Magazzino senza coordinate GPS. Impossibile validare posizione."),null)}catch(Pe){return console.error("Errore recupero coordinate magazzino:",Pe),null}},sa=async(Ie,Pe,Ke,nt=500)=>{const He=await Lt(Ke);if(!He)return{isValid:!0,distance:null,alert:!1};const $e=es(Ie,Pe,He.lat,He.lon),Xe=$e>1e3,ot=$e<=nt;return console.log(`üìç Validazione posizione:
      - Distanza dal magazzino: ${Math.round($e)}m
      - Limite permesso: ${nt}m
      - Validazione: ${ot?"‚úÖ OK":"‚ùå FUORI RANGE"}
      - Alert: ${Xe?"üö® SOSPETTO":"‚úÖ Normale"}`),{isValid:ot,distance:$e,alert:Xe}},Ps=async()=>{if(!ee||!Ee||!J){c("Campi Mancanti","Inserisci sia l'orario di inizio che di fine pausa");return}if(J<=Ee){c("Orario Non Valido","L'orario di fine pausa deve essere dopo l'inizio");return}try{const{error:Ie}=await Se.from("warehouse_checkins").update({break_start_time:Ee,break_end_time:J,has_taken_break:!0,break_registered_late:!0,break_modified_at:new Date().toISOString()}).eq("id",ee.id);if(Ie){c("Errore","Impossibile salvare la pausa");return}const Pe=fs(Ee,J);l("Pausa Registrata",`Pausa pranzo registrata: ${Ee} - ${J} (${Pe} minuti)

Nota: Inserita dopo il check-out`),Re(!1),le(null),_e(""),ke(""),await kr()}catch{c("Errore Sistema","Errore durante il salvataggio della pausa")}},ds=Ie=>Ie?/^\d{2}:\d{2}$/.test(Ie)?Ie:/^\d{2}:\d{2}:\d{2}$/.test(Ie)?Ie.substring(0,5):"09:00":"09:00";return O?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento check-in magazzino..."})]})}):e.jsxs("div",{className:"space-y-6",children:[ne&&ne.status==="active"&&e.jsx("div",{className:"bg-orange-900 rounded-xl p-4 border border-orange-700",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Nt,{className:"h-5 w-5 text-orange-400"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-orange-100",children:"Turno in Corso"}),e.jsxs("p",{className:"text-sm text-orange-200",children:["Check-in attivo dalle ",ne.check_in_time," - ",ne.nome_turno||"Turno Magazzino"]}),e.jsx("p",{className:"text-xs text-orange-300 mt-1",children:"Completa questo turno prima di iniziarne un altro"})]})]})}),k.filter(Ie=>Ie.type==="warehouse").length>0&&e.jsxs("div",{className:"bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl p-6 shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:k.filter(Ie=>Ie.type==="warehouse").length===1?"Sessione Attiva":`Sessioni Attive (${k.filter(Ie=>Ie.type==="warehouse").length})`}),e.jsx("div",{className:"w-3 h-3 bg-purple-300 rounded-full animate-pulse"})]}),e.jsxs("div",{className:"space-y-4",children:[k.filter(Ie=>Ie.type==="warehouse").map((Ie,Pe)=>e.jsxs("div",{className:`${Pe>0?"pt-4 border-t border-white/20":""}`,children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[Ie.type==="warehouse"?e.jsx(Rt,{className:"h-6 w-6 text-white"}):e.jsx(ht,{className:"h-6 w-6 text-white"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-medium text-white",children:Ie.type==="warehouse"?"Turno Magazzino":Ie.shiftName||"Evento"}),k.length>1&&e.jsx("span",{className:"text-xs bg-white/20 px-2 py-1 rounded-full text-white",children:Ie.type==="warehouse"?"üè≠ Magazzino":"üìÖ Evento"})]}),e.jsxs("p",{className:"text-sm text-purple-100",children:["Inizio: ",ds(Ie.checkInTime)," ‚Ä¢ Fine prevista: ",ds(Ie.scheduledEndTime)]}),Ie.type==="warehouse"&&Ie.hasLunchBreak&&e.jsx("p",{className:"text-xs text-purple-200",children:"‚òï Include 1 ora di pausa pranzo"})]})]}),e.jsx("div",{className:"bg-white bg-opacity-20 rounded-lg p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-mono font-bold text-white mb-2",children:D[Ie.id]||"00:00:00"}),e.jsx("div",{className:"text-sm text-purple-100",children:Ie.type==="warehouse"?"Tempo di lavoro (pausa inclusa)":"Tempo trascorso"})]})}),Ie.type==="warehouse"&&(Ie.hasCompanyMeal||Ie.hasMealVoucher)&&e.jsxs("div",{className:"bg-white bg-opacity-10 rounded-lg p-3 mt-3",children:[e.jsxs("h5",{className:"text-white font-medium mb-2 flex items-center space-x-2",children:[e.jsx(Ls,{className:"h-4 w-4"}),e.jsx("span",{children:"Pasti Selezionati"})]}),e.jsxs("div",{className:"space-y-1",children:[Ie.hasCompanyMeal&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-purple-200",children:"Pasto Aziendale:"}),e.jsxs("span",{className:"text-orange-300 font-medium",children:["-‚Ç¨",(C==null?void 0:C.pasto_aziendale_cost)||12]})]}),Ie.hasMealVoucher&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-purple-200",children:"üé´ Buono Pasto:"}),e.jsxs("span",{className:"text-green-300 font-medium",children:["+‚Ç¨",(C==null?void 0:C.buoni_pasto_value)||7.5]})]})]})]})]},Ie.id)),k.filter(Ie=>Ie.type==="warehouse").length>1&&e.jsx("div",{className:"mt-4 p-3 bg-yellow-500/20 rounded-lg",children:e.jsxs("p",{className:"text-white text-sm flex items-center space-x-2",children:[e.jsx(Nt,{className:"h-4 w-4 flex-shrink-0"}),e.jsxs("span",{children:["Stai lavorando su ",k.filter(Ie=>Ie.type==="warehouse").length," turni magazzino contemporaneamente"]})]})})]}),p&&p.type==="warehouse"&&p.hasLunchBreak&&e.jsx("div",{className:"space-y-4 mt-4",children:e.jsxs("div",{className:"bg-white bg-opacity-10 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h5",{className:"text-white font-medium flex items-center space-x-2",children:[e.jsx(Cs,{className:"h-5 w-5"}),e.jsx("span",{children:"Gestione Pausa Pranzo"})]}),e.jsx("div",{className:`flex items-center space-x-1 px-2 py-1 rounded-full text-xs ${v?"bg-yellow-600":x?"bg-green-600":"bg-red-600"}`,children:v?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"}),e.jsx("span",{className:"text-white",children:"GPS..."})]}):x?e.jsxs(e.Fragment,{children:[e.jsx(Ut,{className:"h-3 w-3 text-white"}),e.jsx("span",{className:"text-white",children:"GPS OK"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ut,{className:"h-3 w-3 text-white"}),e.jsx("span",{className:"text-white",children:"NO GPS"})]})})]}),!Qe&&!gt?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>ea(!1),disabled:v,className:"w-full bg-orange-500 hover:bg-orange-600 disabled:bg-gray-600 disabled:cursor-not-allowed text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center space-x-2 transition-colors",children:[e.jsx(Cs,{className:"h-5 w-5"}),e.jsx("span",{children:v?"Verifica GPS...":x?"‚òï INIZIA PAUSA":"‚òï INIZIA PAUSA (GPS richiesto)"})]}),!x&&!v&&e.jsx("div",{className:"mt-2 bg-yellow-900/30 border border-yellow-600 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-200 text-xs text-center",children:"‚ö†Ô∏è GPS non disponibile. Cliccando il pulsante sopra verrai chiesto di attivare il GPS o di forzare la pausa."})})]}):Qe?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-orange-500 bg-opacity-30 border-2 border-orange-400 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-400 rounded-full animate-pulse"}),e.jsx("span",{className:"text-white font-bold",children:"PAUSA IN CORSO"})]}),e.jsxs("p",{className:"text-center text-sm text-orange-100",children:["Iniziata alle ",gt]})]}),e.jsxs("button",{onClick:()=>ta(!1),disabled:v,className:"w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-600 disabled:cursor-not-allowed text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center space-x-2 transition-colors",children:[e.jsx(pt,{className:"h-5 w-5"}),e.jsx("span",{children:v?"Verifica GPS...":x?"‚úÖ TERMINA PAUSA":"‚úÖ TERMINA PAUSA (GPS richiesto)"})]}),!x&&!v&&e.jsx("div",{className:"mt-2 bg-yellow-900/30 border border-yellow-600 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-200 text-xs text-center",children:"‚ö†Ô∏è GPS non disponibile. Cliccando il pulsante sopra verrai chiesto di attivare il GPS o di forzare la pausa."})})]}):e.jsxs("div",{className:"bg-green-500 bg-opacity-20 border border-green-400 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-2",children:[e.jsx(pt,{className:"h-5 w-5 text-green-400"}),e.jsx("span",{className:"text-white font-bold",children:"Pausa Pranzo Effettuata"})]}),gt&&De&&e.jsxs("p",{className:"text-center text-sm text-green-100",children:["Dalle ",gt," alle ",De]})]})]})}),e.jsx("button",{onClick:wr,className:"w-full mt-4 bg-red-600 text-white py-3 px-4 rounded-xl hover:bg-red-700 font-bold text-lg shadow-lg",children:(p==null?void 0:p.type)==="warehouse"?"üõë TERMINA TURNO MAGAZZINO":"üõë TERMINA EVENTO"})]}),F==="main"&&(!p||p.type!=="warehouse")&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:`rounded-xl p-4 border ${x?"bg-green-900 border-green-700":"bg-red-900 border-red-700"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Wr,{className:`h-6 w-6 ${x?"text-green-400":"text-red-400"}`}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-white",children:x?"GPS Attivo":"GPS Richiesto"}),e.jsx("p",{className:"text-sm opacity-75",children:x?`${x.address} (¬±${x.accuracy}m)`:S||"Attivazione GPS necessaria per check-in"})]})]}),!x&&e.jsxs("button",{onClick:()=>b({requiredAccuracy:20,maxRetries:3}),disabled:v,className:"bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 disabled:bg-gray-600 flex items-center space-x-2",children:[v?e.jsx(Ms,{className:"h-4 w-4 animate-spin"}):e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:v?"Rilevamento...":"Attiva GPS"})]})]})}),te.length>0?e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-bold text-white mb-4 flex items-center space-x-2",children:[e.jsx(ma,{className:"h-6 w-6 text-purple-400"}),e.jsxs("span",{children:["Tuoi Turni Magazzino (",te.length,")"]})]}),e.jsx("div",{className:"space-y-3 mb-4",children:te.map(Ie=>{var ss;const Pe=Ie.data_turno.split("T")[0],Ke=Pe===da(),nt=Pe===Jc(),He=new Date(Ie.data_turno),$e=new Date;$e.setHours(0,0,0,0),He.setHours(0,0,0,0);const Xe=He.getTime()-$e.getTime(),ot=Math.ceil(Xe/(1e3*60*60*24));let St="",Gt="";Ke?(St="OGGI",Gt="bg-green-600"):nt?(St="DOMANI",Gt="bg-blue-600"):(St=He.toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"}).toUpperCase(),Gt="bg-gray-600");const jt=me.find(Ws=>{const As=Ws.date,wt=Ie.data_turno.split("T")[0];return Ws.shift_id===Ie.turno_id&&As===wt}),ts=!!jt,Qs=(jt==null?void 0:jt.status)==="active",vt=$t(Ie);return e.jsxs("div",{className:`bg-gray-700 rounded-lg p-4 border-l-4 ${ts?"border-green-500":"border-purple-500"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:`${Gt} text-white px-3 py-1 rounded-full text-xs font-bold`,children:St}),ts&&e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${Qs?"bg-orange-600 text-white":"bg-green-600 text-white"}`,children:Qs?"üî• IN CORSO":"‚úÖ COMPLETATO"})]}),e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx(Rt,{className:"h-5 w-5 text-purple-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-white",children:Ie.nome_turno||`Turno ${Ie.nome_magazzino}`}),e.jsxs("p",{className:"text-xs text-purple-300 font-medium",children:["üìç ",Ie.nome_magazzino]}),e.jsxs("p",{className:"text-sm text-gray-300",children:[ds(Ie.ora_inizio_turno)," - ",ds(Ie.ora_fine_turno)]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-3",children:[e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800",children:((ss=Ie.crew_template_turni)==null?void 0:ss.pausa_pranzo)!==!1?"üçΩÔ∏è Con pausa pranzo":"‚ö° Senza pausa pranzo"}),!vt.isValid&&e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${vt.isExpired?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:vt.isExpired?"‚è∞ Turno scaduto":"‚è≥ Non ancora iniziato"}),vt.isValid&&e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-green-100 text-green-800",children:"Turno attivo"})]}),ts?e.jsx("div",{className:"w-full px-4 py-2 rounded-lg font-medium bg-green-600 text-white text-center",children:Qs?"Turno in Corso":"Turno Completato"}):e.jsx("button",{onClick:()=>qs(Ie),disabled:!Ke||!x||!vt.canCheckIn||ne&&ne.status==="active",className:`w-full px-4 py-2 rounded-lg font-medium ${Ke&&vt.canCheckIn&&x&&(!ne||ne.status!=="active")?"bg-purple-600 text-white hover:bg-purple-700":"bg-gray-600 text-gray-300 cursor-not-allowed"}`,children:Ke?ne&&ne.status==="active"?"Completa turno attivo":x?vt.isExpired?"Turno Scaduto":vt.canCheckIn?"Inizia Check-in":"Non Disponibile":"GPS Richiesto":ot>0?`Inizia tra ${ot} ${ot===1?"giorno":"giorni"}`:"Turno passato"})]},Ie.id)})}),e.jsx("div",{className:"bg-blue-900 border border-blue-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(ht,{className:"h-5 w-5 text-blue-400 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-blue-100",children:"Processo Check-in Magazzino"}),e.jsxs("ol",{className:"text-sm text-blue-200 mt-2 space-y-1 list-decimal list-inside",children:[e.jsx("li",{children:"Verifica orario turno (deve essere attivo)"}),e.jsx("li",{children:"Verifica attivazione GPS"}),e.jsx("li",{children:"Selezione opzioni pasto (se turno con pausa)"}),e.jsx("li",{children:"Scansione QR code magazzino"}),e.jsx("li",{children:"Check-in con timer e auto-checkout programmato"})]})]})]})})]}):e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700 text-center",children:[e.jsx(Rt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Nessun Turno Magazzino Oggi"}),e.jsx("p",{className:"text-gray-300",children:"Non hai turni di magazzino assegnati per oggi."}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Controlla il calendario per i prossimi turni."})]})]}),F==="meal_selection"&&G&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:"Opzioni Pasto"}),e.jsx("button",{onClick:()=>{U("main"),B(null)},className:"bg-gray-700 p-3 rounded-lg hover:bg-gray-600",children:e.jsx(Et,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(Ls,{className:"h-12 w-12 mx-auto mb-2 text-orange-400"}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"Selezione Pasto"}),e.jsxs("p",{className:"text-gray-300 mt-1",children:['Il turno "',G.nome_magazzino,'" include pausa pranzo']})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:`border-2 rounded-xl p-4 cursor-pointer transition-all ${re?"border-orange-500 bg-orange-600":"border-gray-600 bg-gray-700 hover:bg-gray-600"}`,onClick:()=>{de(!re),re||ge(!1)},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center ${re?"bg-white bg-opacity-20":"bg-orange-600"}`,children:e.jsx(Ls,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-white",children:"Pasto Aziendale"}),e.jsx("p",{className:"text-sm text-gray-300",children:"L'azienda anticipa il costo, verr√† detratto dallo stipendio"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-lg font-bold text-orange-300",children:["‚Ç¨",(C==null?void 0:C.pasto_aziendale_cost)||12]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Costo"})]})]})}),e.jsx("div",{className:`border-2 rounded-xl p-4 ${C!=null&&C.buoni_pasto_enabled?"border-green-500 bg-green-600":"border-gray-600 bg-gray-700"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center ${C!=null&&C.buoni_pasto_enabled?"bg-white bg-opacity-20":"bg-gray-600"}`,children:e.jsx(js,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-white",children:"Buono Pasto"}),e.jsx("p",{className:"text-sm text-gray-300",children:C!=null&&C.buoni_pasto_enabled?"‚úÖ Incluso automaticamente nel tuo contratto":"‚ùå Non incluso nel tuo contratto"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:`text-lg font-bold ${C!=null&&C.buoni_pasto_enabled?"text-green-300":"text-gray-500"}`,children:C!=null&&C.buoni_pasto_enabled?`‚Ç¨${(C==null?void 0:C.buoni_pasto_value)||7.5}`:"Non disponibile"}),e.jsx("div",{className:"text-xs text-gray-400",children:C!=null&&C.buoni_pasto_enabled?"Valore":"Benefit"})]})]})})]}),e.jsx("button",{onClick:et,className:"w-full mt-6 bg-blue-600 text-white py-4 px-4 rounded-xl hover:bg-blue-700 font-bold text-lg shadow-lg",children:"‚û°Ô∏è CONTINUA CON QR CODE"})]})]}),F==="scanner"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:"Scanner QR Magazzino"}),e.jsx("button",{onClick:()=>{Fe.current&&Fe.current.clear(),Te(!1),U("main"),B(null)},className:"bg-gray-700 p-3 rounded-lg hover:bg-gray-600",children:e.jsx(Et,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx(ma,{className:"h-12 w-12 mx-auto mb-2 text-purple-400"}),e.jsx("p",{className:"text-white font-medium",children:"Inquadra il QR Code del Magazzino"}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Posiziona il QR code al centro del riquadro"})]}),ve&&e.jsx("div",{id:"qr-reader",className:"w-full max-w-sm mx-auto"}),we&&e.jsx("div",{className:"mt-4 bg-red-900 border border-red-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Nt,{className:"h-4 w-4 text-red-400"}),e.jsx("span",{className:"text-red-200 text-sm",children:we})]})}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-600",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("h4",{className:"text-white font-medium mb-2",children:"Non riesci a scansionare?"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Inserisci manualmente il codice backup del magazzino"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"text",placeholder:"Inserisci codice backup o QR code...",className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400",value:fe,onChange:Ie=>be(Ie.target.value.toUpperCase())}),e.jsx("button",{onClick:()=>{fe.trim()?Gs(fe.trim()):u("Codice Richiesto","Inserisci un codice backup valido prima di procedere")},disabled:!fe.trim(),className:"w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed font-medium",children:"‚úÖ CONFERMA CODICE"})]})]})]}),G&&e.jsxs("div",{className:"bg-blue-900 rounded-xl p-4 border border-blue-700",children:[e.jsx("h4",{className:"font-medium text-blue-100 mb-3",children:"Riepilogo Check-in"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-blue-200",children:"Turno:"}),e.jsxs("span",{className:"text-white font-medium",children:["Turno ",G.nome_magazzino]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-blue-200",children:"Orario:"}),e.jsxs("span",{className:"text-white font-medium",children:[ds(G.ora_inizio_turno)," - ",ds(G.ora_fine_turno)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-blue-200",children:"Pausa pranzo:"}),e.jsx("span",{className:"text-white font-medium",children:((Be=G.crew_template_turni)==null?void 0:Be.pausa_pranzo)!==!1?"1 ora inclusa":"Nessuna pausa"})]}),re&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-blue-200",children:"Pasto aziendale:"}),e.jsxs("span",{className:"text-orange-300 font-medium",children:["‚Ç¨",(C==null?void 0:C.pasto_aziendale_cost)||12]})]}),oe&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-blue-200",children:"Buono pasto:"}),e.jsxs("span",{className:"text-yellow-300 font-medium",children:["‚Ç¨",(C==null?void 0:C.buoni_pasto_value)||7.5]})]}),Z&&e.jsx("div",{className:"border-t border-blue-600 pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[Z.isValid?e.jsx(pt,{className:"h-4 w-4 text-green-400"}):e.jsx(Nt,{className:"h-4 w-4 text-red-400"}),e.jsx("span",{className:`text-sm ${Z.isValid?"text-green-200":"text-red-200"}`,children:Z.reason})]})})]})]}),e.jsx("div",{className:"bg-purple-900 rounded-xl p-4 border border-purple-700",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(oi,{className:"h-5 w-5 text-purple-400 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-purple-100",children:"Scanner QR Magazzino"}),e.jsxs("ul",{className:"text-sm text-purple-200 mt-2 space-y-1",children:[e.jsx("li",{children:"‚Ä¢ Punta la fotocamera verso il QR code del magazzino"}),e.jsx("li",{children:"‚Ä¢ Mantieni il telefono fermo e stabile"}),e.jsx("li",{children:"‚Ä¢ Assicurati che ci sia buona illuminazione"}),e.jsx("li",{children:"‚Ä¢ Il QR code deve essere completamente visibile"}),e.jsx("li",{children:"‚Ä¢ La posizione GPS verr√† verificata automaticamente"})]})]})]})})]}),!g&&e.jsx("div",{className:"bg-orange-900 rounded-xl p-4 border border-orange-700",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Nt,{className:"h-5 w-5 text-orange-400"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-orange-100",children:"Modalit√† Offline"}),e.jsx("p",{className:"text-sm text-orange-200",children:"I check-in magazzino verranno salvati localmente e sincronizzati quando torni online"})]})]})}),Ve&&st&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-6 border border-red-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-red-900 p-3 rounded-full",children:e.jsx(Nt,{className:"h-6 w-6 text-red-400"})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"Check-in Forzato"})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-4",children:[e.jsxs("p",{className:"text-red-300 text-sm mb-2",children:[e.jsx("strong",{children:"Attenzione:"})," Il GPS non √® disponibile o non funziona correttamente."]}),e.jsxs("p",{className:"text-red-200 text-xs",children:["Stai per effettuare un check-in ",e.jsx("strong",{children:"senza posizione GPS"}),'. Questo verr√† registrato come "Check-in Forzato" e sar√† visibile ai supervisori.']})]}),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-3",children:[e.jsx("h4",{className:"text-white font-medium mb-2",children:"Magazzino:"}),e.jsx("p",{className:"text-gray-300 text-sm",children:st.name}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:st.address})]}),S&&e.jsx("div",{className:"bg-gray-700 rounded-lg p-3",children:e.jsxs("p",{className:"text-gray-400 text-xs",children:[e.jsx("strong",{children:"Motivo:"})," ",S]})}),e.jsx("div",{className:"bg-yellow-900/20 border border-yellow-700 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-300 text-xs",children:"‚ÑπÔ∏è Consigliamo di risolvere il problema GPS prima del check-in. Se continui, il sistema registrer√† l'assenza della posizione."})})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>{rt(!1),Je(null)},className:"flex-1 bg-gray-700 text-white py-3 px-4 rounded-lg hover:bg-gray-600 font-medium",children:"Annulla"}),e.jsx("button",{onClick:()=>{st&&(ur(st,!0),rt(!1),Je(null))},className:"flex-1 bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 font-medium",children:"Conferma Check-in Forzato"})]})]})}),Ae&&ee&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-6 border border-orange-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-orange-900 p-3 rounded-full",children:e.jsx(Cs,{className:"h-6 w-6 text-orange-400"})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"Inserisci Pausa Pranzo"})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"bg-orange-900/20 border border-orange-700 rounded-lg p-4",children:[e.jsx("p",{className:"text-orange-300 text-sm mb-2",children:e.jsx("strong",{children:"Pausa Non Registrata"})}),e.jsx("p",{className:"text-orange-200 text-xs",children:"Non hai registrato la pausa pranzo durante il turno. Puoi ancora inserire manualmente gli orari entro 8 ore dal check-out."})]}),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-3",children:[e.jsx("h4",{className:"text-white font-medium mb-2",children:"Turno:"}),e.jsx("p",{className:"text-gray-300 text-sm",children:ee.nome_turno}),e.jsxs("p",{className:"text-gray-400 text-xs mt-1",children:[new Date(ee.date).toLocaleDateString("it-IT")," ‚Ä¢ ",ee.check_in_time," - ",ee.check_out_time]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-white font-medium mb-2",children:"Orario Inizio Pausa"}),e.jsx("input",{type:"time",value:Ee,onChange:Ie=>_e(Ie.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-white font-medium mb-2",children:"Orario Fine Pausa"}),e.jsx("input",{type:"time",value:J,onChange:Ie=>ke(Ie.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white"})]})]}),e.jsx("div",{className:"bg-yellow-900/20 border border-yellow-700 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-300 text-xs",children:'‚ö†Ô∏è La posizione GPS non verr√† registrata per questa pausa. Inserendo gli orari manualmente, la pausa verr√† marcata come "inserita in ritardo".'})}),Ee&&J&&J>Ee&&e.jsx("div",{className:"bg-blue-900/20 border border-blue-700 rounded-lg p-3",children:e.jsxs("p",{className:"text-blue-300 text-sm text-center",children:["Durata pausa: ",e.jsxs("strong",{children:[fs(Ee,J)," minuti"]})]})})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>{Re(!1),le(null),_e(""),ke("")},className:"flex-1 bg-gray-700 text-white py-3 px-4 rounded-lg hover:bg-gray-600 font-medium",children:"Annulla"}),e.jsx("button",{onClick:Ps,disabled:!Ee||!J,className:"flex-1 bg-orange-600 text-white py-3 px-4 rounded-lg hover:bg-orange-700 disabled:bg-gray-600 disabled:cursor-not-allowed font-medium",children:"Salva Pausa"})]})]})}),Ze&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-6 border border-yellow-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-yellow-900 p-3 rounded-full",children:e.jsx(Nt,{className:"h-6 w-6 text-yellow-400"})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"GPS Non Disponibile"})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"bg-yellow-900/20 border border-yellow-700 rounded-lg p-4",children:[e.jsx("p",{className:"text-yellow-200 text-sm mb-2",children:"Il sistema GPS non √® disponibile o non funziona correttamente."}),e.jsx("p",{className:"text-yellow-300 text-xs",children:bt==="start"?"Non √® possibile registrare la posizione di inizio pausa.":"Non √® possibile registrare la posizione di fine pausa."})]}),e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-4",children:[e.jsx("p",{className:"text-red-300 text-sm font-medium mb-2",children:"‚ö†Ô∏è Opzione Forzatura"}),e.jsxs("p",{className:"text-red-200 text-xs mb-3",children:["Puoi procedere senza GPS, ma questa azione verr√† registrata come ",e.jsx("strong",{children:"FORZATA"})," nel sistema e l'azienda verr√† notificata."]}),e.jsx("p",{className:"text-red-300 text-xs",children:"Consigliamo di:"}),e.jsxs("ul",{className:"text-red-200 text-xs list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Verificare che il GPS sia attivato nelle impostazioni"}),e.jsx("li",{children:"Controllare i permessi dell'app"}),e.jsx("li",{children:"Spostarsi in un'area con migliore copertura"})]})]})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>{at(!1),Oe(null)},className:"flex-1 bg-gray-700 text-white py-3 px-4 rounded-lg hover:bg-gray-600 font-medium",children:"Annulla"}),e.jsx("button",{onClick:()=>{at(!1),bt==="start"?ea(!0):ta(!0),Oe(null)},className:"flex-1 bg-yellow-600 text-white py-3 px-4 rounded-lg hover:bg-yellow-700 font-medium",children:"Forza Senza GPS"})]})]})}),$&&p&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-3 overflow-y-auto",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-4 border border-red-500 my-auto max-h-[95vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx("div",{className:"bg-red-900 p-2 rounded-full",children:e.jsx(Nt,{className:"h-5 w-5 text-red-400"})}),e.jsx("h3",{className:"text-lg font-bold text-white",children:"Conferma Check-out"})]}),e.jsxs("div",{className:"space-y-3 mb-4",children:[e.jsx("div",{className:"bg-gray-700 rounded-lg p-3",children:e.jsxs("div",{className:"space-y-1.5 text-sm",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("span",{className:"text-gray-400",children:"Turno:"}),e.jsx("span",{className:"text-white font-medium text-xs text-right ml-2",children:p.shiftName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"Check-in:"}),e.jsx("span",{className:"text-white",children:ds(p.checkInTime)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"Tempo:"}),e.jsx("span",{className:"text-white font-medium",children:P})]}),p.hasLunchBreak&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"Pausa:"}),e.jsx("span",{className:"text-white text-xs",children:Qe?"‚è∏Ô∏è In corso":gt?"‚úÖ Fatta":"‚ö†Ô∏è Non fatta"})]})]})}),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-3",children:[e.jsx("label",{className:"block text-white font-medium mb-1.5 text-sm",children:"Note (facoltative):"}),e.jsx("textarea",{value:xe,onChange:Ie=>pe(Ie.target.value),placeholder:"Aggiungi note...",className:"w-full bg-gray-800 text-white border border-gray-600 rounded-lg p-2 text-sm focus:outline-none focus:border-blue-500 min-h-[60px]",maxLength:500}),e.jsxs("p",{className:"text-gray-400 text-xs mt-1",children:[xe.length,"/500"]})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:()=>{ue(!1),pe("")},className:"flex-1 bg-gray-700 text-white py-2.5 px-3 rounded-lg hover:bg-gray-600 font-medium text-sm",children:"Annulla"}),e.jsx("button",{onClick:Ss,className:"flex-1 bg-red-600 text-white py-2.5 px-3 rounded-lg hover:bg-red-700 font-medium text-sm",children:"Conferma"})]})]})})]})},td=()=>{const{user:n}=Pt(),{showSuccess:l,showError:c,showWarning:u}=ms(),{currentLocation:f,getCurrentLocation:x,isLoading:b,error:v}=on(),{isOnline:S,addOfflineData:g}=Sa(),{currentSession:E,activeSessions:p,elapsedTime:k,elapsedTimes:P,startSession:D,endSession:R,manualCheckOut:j,loadActiveSession:M}=ln(),[T,F]=w.useState([]),[U,te]=w.useState(!0),[N,_]=w.useState(!1),[V,C]=w.useState(null),[K,O]=w.useState(null),[X,se]=w.useState({}),[W,G]=w.useState({});w.useEffect(()=>{n!=null&&n.id&&(ye(),B())},[n==null?void 0:n.id]);const B=async()=>{try{const{data:L,error:re}=await Se.from("employee_meal_benefits").select("*").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0).maybeSingle();re?console.error("‚ùå Errore caricamento benefit dipendente:",re):L&&O(L)}catch(L){console.error("‚ùå Errore generale caricamento benefit:",L)}},ne=L=>{if(!K)return[];const re=[];return L.bonus_diaria&&K.diaria_eventi_enabled&&K.diaria_eventi_value>0&&re.push({name:"Diaria Eventi",value:K.diaria_eventi_value}),L.bonus_trasferta&&K.diaria_trasferta_enabled&&K.diaria_trasferta_value>0&&re.push({name:"Diaria Trasferta",value:K.diaria_trasferta_value}),L.benefits_evento_ids&&L.benefits_evento_ids.length>0&&L.benefits_evento_ids.forEach(de=>{const oe=X[de];oe&&re.push({name:oe.name,value:oe.value})}),re},ye=async()=>{try{te(!0);const L=new Date,re=L.getFullYear(),de=String(L.getMonth()+1).padStart(2,"0"),oe=String(L.getDate()).padStart(2,"0"),ge=`${re}-${de}-${oe}`;console.log("üìÖ Caricamento eventi di oggi e futuri:",ge);const{data:ve,error:Te}=await Se.from("crew_event_assegnazione").select(`
          *,
          event_benefits:benefits_evento_ids
        `).eq("dipendente_freelance_id",n==null?void 0:n.id).gte("giorno_inizio_evento",ge).order("giorno_inizio_evento",{ascending:!0}).order("evento_orario_convocazione",{ascending:!0});if(Te){console.error("‚ùå Errore caricamento eventi:",Te),F([]),te(!1);return}const{data:we,error:je}=await Se.from("timesheet_entries").select("id, event_id, start_time, end_time, status").eq("crew_id",n==null?void 0:n.id).eq("date",ge);je&&console.error("‚ùå Errore caricamento check-in:",je);const Fe=(ve||[]).flatMap(st=>st.benefits_evento_ids||[]).filter((st,Je,Qe)=>st&&Qe.indexOf(st)===Je);let Ve={};if(Fe.length>0){const{data:st,error:Je}=await Se.from("crew_tariffe").select("id, nome_tariffa, importo, categoria").in("id",Fe);!Je&&st&&(Ve=st.reduce((Qe,We)=>(Qe[We.id]={name:We.nome_tariffa,value:parseFloat(We.importo),category:We.categoria},Qe),{}),se(Ve),console.log("‚úÖ Benefit caricati:",Object.keys(Ve).length))}const rt=(ve||[]).map(st=>{const Je=we==null?void 0:we.find(Qe=>Qe.event_id===st.evento_id);return{...st,checkin:Je||void 0}});console.log("‚úÖ Eventi trovati:",rt.length),F(rt)}catch(L){console.error("‚ùå Errore generale caricamento eventi:",L),F([])}finally{te(!1)}};async function me(L,re=!1){var de;try{let oe=f,ge=!1,ve=null;if(!oe&&!re){C(L),_(!0);return}!oe&&re&&(ge=!0,ve=v||"GPS non disponibile - Check-in forzato dall'utente",console.warn("‚ö†Ô∏è Check-in forzato senza GPS:",ve));const Te=new Date;let we="nessuna",je=0;K&&(L.bonus_trasferta&&K.diaria_trasferta_enabled?(we="trasferta",je=K.diaria_trasferta_value):L.bonus_diaria&&K.diaria_eventi_enabled&&(we="evento",je=K.diaria_eventi_value));const Fe=Te.getFullYear(),Ve=String(Te.getMonth()+1).padStart(2,"0"),rt=String(Te.getDate()).padStart(2,"0"),st=`${Fe}-${Ve}-${rt}`,Je=((de=W[L.id])==null?void 0:de.trim())||null;let Qe=Je;ge&&(Qe=Je?`${Je}

[Check-in forzato: ${ve}]`:`Check-in forzato: ${ve}`);const We={crew_id:n==null?void 0:n.id,event_id:L.evento_id,date:st,start_time:Te.toTimeString().split(" ")[0],tracking_type:L.evento_trasferta?"days":"hours",retention_percentage:0,gross_amount:L.tariffa_evento_assegnata||0,net_amount:L.tariffa_evento_assegnata||0,hourly_rate:L.evento_trasferta?null:L.tariffa_evento_assegnata,daily_rate:L.evento_trasferta?L.tariffa_evento_assegnata:null,gps_location:oe?{latitude:oe.latitude,longitude:oe.longitude,accuracy:oe.accuracy,address:oe.address,timestamp:oe.timestamp,forced:ge,error_reason:ve}:null,diaria_type:we,diaria_amount:je,meal_voucher:(K==null?void 0:K.buoni_pasto_enabled)||!1,status:"submitted",notes:Qe};if(S){const{error:gt}=await Se.from("timesheet_entries").insert([We]);if(gt){console.error("‚ùå Errore check-in evento:",gt),c(`Errore durante il check-in: ${gt.message}`);return}}else g("event_checkin",We),u("Check-in salvato offline - verr√† sincronizzato quando tornerai online");ge?u("Check-in forzato completato (senza GPS)"):l(`Check-in completato per ${L.nome_evento}`),_(!1),C(null),await ye(),await M()}catch(oe){console.error("‚ùå Errore durante check-in evento:",oe),c("Errore imprevisto durante il check-in")}}async function Q(L){if(!L.checkin){c("Nessun check-in trovato per questo evento");return}try{const de={end_time:"23:59:00",status:"submitted"};if(S){const{error:ge}=await Se.from("timesheet_entries").update(de).eq("id",L.checkin.id);if(ge){console.error("‚ùå Errore check-out evento:",ge),c(`Errore durante il check-out: ${ge.message}`);return}}else g("event_checkout",{id:L.checkin.id,...de}),u("Check-out salvato offline - verr√† sincronizzato quando tornerai online");const oe=p.find(ge=>{var ve;return ge.id===((ve=L.checkin)==null?void 0:ve.id)});oe&&R(oe.id),l(`Presenza confermata per ${L.nome_evento}`),await ye()}catch(re){console.error("‚ùå Errore durante check-out evento:",re),c("Errore imprevisto durante il check-out")}}const fe=L=>L?/^\d{2}:\d{2}$/.test(L)?L:/^\d{2}:\d{2}:\d{2}$/.test(L)?L.substring(0,5):"09:00":"09:00",be=L=>L.nome_evento.toLowerCase().includes("magazzino")?Rt:L.evento_trasferta?ks:xt,Z=L=>L.nome_evento.toLowerCase().includes("magazzino")?"from-gray-500 to-gray-600":L.evento_trasferta?"from-purple-500 to-pink-500":"from-blue-500 to-cyan-500";return U?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento check-in eventi..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:`rounded-xl p-4 border ${f?"bg-green-900 border-green-700":"bg-red-900 border-red-700"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Wr,{className:`h-6 w-6 ${f?"text-green-400":"text-red-400"}`}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-white",children:f?"GPS Attivo":"GPS Richiesto"}),e.jsx("p",{className:"text-sm opacity-75",children:f?`${f.address} (¬±${f.accuracy}m)`:v||"Attivazione GPS necessaria per check-in eventi"})]})]}),!f&&e.jsxs("button",{onClick:()=>x({requiredAccuracy:20,maxRetries:3}),disabled:b,className:"bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 disabled:bg-gray-600 flex items-center space-x-2",children:[b?e.jsx(Ms,{className:"h-4 w-4 animate-spin"}):e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:b?"Rilevamento...":"Attiva GPS"})]})]})}),p.filter(L=>L.type!=="warehouse").length>0&&e.jsxs("div",{className:"bg-gradient-to-br from-orange-600 to-red-600 rounded-xl p-4 border border-orange-500",children:[e.jsxs("h3",{className:"text-lg font-bold text-white mb-3 flex items-center space-x-2",children:[e.jsx(ht,{className:"h-5 w-5"}),e.jsxs("span",{children:["Sessioni Attive (",p.filter(L=>L.type!=="warehouse").length,")"]})]}),e.jsx("div",{className:"space-y-2",children:p.filter(L=>L.type!=="warehouse").map(L=>e.jsx("div",{className:"bg-black/20 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[L.type==="warehouse"?e.jsx(Rt,{className:"h-5 w-5 text-white"}):e.jsx(xt,{className:"h-5 w-5 text-white"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:L.type==="warehouse"?"Turno Magazzino":L.shiftName||"Evento"}),e.jsxs("p",{className:"text-white/70 text-sm",children:["Check-in: ",L.checkInTime]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold text-white font-mono",children:P[L.id]||"00:00:00"}),e.jsx("p",{className:"text-white/70 text-xs",children:"Tempo trascorso"})]})]})},L.id))}),p.filter(L=>L.type!=="warehouse").length>1&&e.jsx("div",{className:"mt-3 p-2 bg-yellow-500/20 rounded-lg",children:e.jsxs("p",{className:"text-white text-sm flex items-center space-x-2",children:[e.jsx(Nt,{className:"h-4 w-4"}),e.jsxs("span",{children:["Hai ",p.filter(L=>L.type!=="warehouse").length," eventi attivi contemporaneamente"]})]})})]}),T.length>0?e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-bold text-white mb-4 flex items-center space-x-2",children:[e.jsx(Ut,{className:"h-6 w-6 text-blue-400"}),e.jsxs("span",{children:["I Tuoi Eventi (",T.length,")"]})]}),e.jsx("div",{className:"space-y-4",children:T.map(L=>{const re=be(L),de=L.giorno_inizio_evento,oe=new Date,ge=oe.getFullYear(),ve=String(oe.getMonth()+1).padStart(2,"0"),Te=String(oe.getDate()).padStart(2,"0"),we=`${ge}-${ve}-${Te}`,je=new Date(oe);je.setDate(je.getDate()+1);const Fe=je.getFullYear(),Ve=String(je.getMonth()+1).padStart(2,"0"),rt=String(je.getDate()).padStart(2,"0"),st=`${Fe}-${Ve}-${rt}`,Je=de===we,Qe=de===st,We=new Date(de+"T00:00:00");let gt="",qe="";return Je?(gt="OGGI",qe="bg-green-600"):Qe?(gt="DOMANI",qe="bg-blue-600"):(gt=We.toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"}).toUpperCase(),qe="bg-gray-600"),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-4 border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:`${qe} text-white px-3 py-1 rounded-full text-xs font-bold`,children:gt}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium bg-gradient-to-r ${Z(L)} text-white`,children:L.evento_trasferta?"Trasferta":"Evento"})]}),e.jsxs("div",{className:"flex items-start mb-3",children:[e.jsx(re,{className:"h-5 w-5 text-blue-400 mt-1 mr-2"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-white",children:L.nome_evento}),e.jsx("p",{className:"text-sm text-gray-300",children:L.evento_localita}),e.jsx("p",{className:"text-xs text-gray-400",children:L.nome_azienda})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 mb-3",children:[L.evento_orario_convocazione&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ht,{className:"h-4 w-4 text-green-400"}),e.jsxs("span",{className:"text-sm text-white",children:["Convocazione: ",fe(L.evento_orario_convocazione)]})]}),L.evento_indirizzo&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm text-white",children:L.evento_indirizzo})]}),L.tariffa_evento_assegnata&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ga,{className:"h-4 w-4 text-yellow-400"}),e.jsxs("span",{className:"text-sm text-white",children:["Tariffa: ‚Ç¨",L.tariffa_evento_assegnata]})]})]}),(L.link_scheda_tecnica||L.link_mappa_gps)&&e.jsxs("div",{className:"flex gap-2 mb-3",children:[L.link_scheda_tecnica&&e.jsxs("a",{href:L.link_scheda_tecnica,target:"_blank",rel:"noopener noreferrer",className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg flex items-center justify-center space-x-2 transition-colors text-sm",children:[e.jsx(qt,{className:"h-4 w-4"}),e.jsx("span",{children:"SCHEDA LAVORO"})]}),L.link_mappa_gps&&e.jsxs("a",{href:L.link_mappa_gps,target:"_blank",rel:"noopener noreferrer",className:"flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg flex items-center justify-center space-x-2 transition-colors text-sm",children:[e.jsx(Wr,{className:"h-4 w-4"}),e.jsx("span",{children:"MAPPA"})]})]}),(()=>{const De=ne(L);return De.length>0&&e.jsxs("div",{className:"bg-green-900/20 border border-green-700 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(js,{className:"h-4 w-4 text-green-400"}),e.jsx("span",{className:"text-sm font-medium text-green-400",children:"Benefit Attivi per questo Evento"})]}),e.jsx("div",{className:"space-y-1",children:De.map((H,ae)=>e.jsxs("div",{className:"flex items-center justify-between bg-green-800/30 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-green-300",children:H.name}),e.jsxs("span",{className:"text-xs font-bold text-green-200",children:["‚Ç¨",H.value.toFixed(2)]})]},ae))})]})})(),Je?L.checkin?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-green-900/30 border border-green-700 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(pt,{className:"h-5 w-5 text-green-400"}),e.jsx("span",{className:"text-green-400 font-medium",children:"Check-in Effettuato"})]}),e.jsx("span",{className:"text-green-300 text-sm font-bold",children:fe(L.checkin.start_time)})]}),L.checkin.end_time&&e.jsxs("div",{className:"flex items-center justify-between text-sm text-green-300",children:[e.jsx("span",{children:"Check-out:"}),e.jsx("span",{className:"font-bold",children:fe(L.checkin.end_time)})]})]}),!L.checkin.end_time&&e.jsxs("button",{onClick:()=>Q(L),className:"w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 font-medium flex items-center justify-center space-x-2",children:[e.jsx(pt,{className:"h-5 w-5"}),e.jsx("span",{children:"CHECK-OUT EVENTO"})]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Note (opzionale)"}),e.jsx("textarea",{value:W[L.id]||"",onChange:De=>G(H=>({...H,[L.id]:De.target.value})),placeholder:"Aggiungi eventuali note per il check-in...",rows:3,className:"w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsx("button",{onClick:()=>me(L),className:"w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-medium",children:f?"üìç CHECK-IN GPS EVENTO":"‚ö†Ô∏è CHECK-IN SENZA GPS"})]}):e.jsx("div",{className:"w-full bg-gray-600 text-gray-300 py-3 px-4 rounded-lg font-medium text-center cursor-not-allowed",children:"Check-in disponibile il giorno dell'evento"})]},L.id)})})]}):e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700 text-center",children:[e.jsx(xt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Nessun Evento Oggi"}),e.jsx("p",{className:"text-gray-300",children:"Non hai eventi assegnati per oggi."}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Controlla il calendario per le prossime attivit√†."})]})]}),!S&&e.jsx("div",{className:"bg-orange-900 rounded-xl p-4 border border-orange-700",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Nt,{className:"h-5 w-5 text-orange-400"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-orange-100",children:"Modalit√† Offline"}),e.jsx("p",{className:"text-sm text-orange-200",children:"I check-in eventi verranno salvati localmente e sincronizzati quando torni online"})]})]})}),N&&V&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-6 border border-red-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-red-900 p-3 rounded-full",children:e.jsx(Nt,{className:"h-6 w-6 text-red-400"})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"Check-in Forzato"})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-4",children:[e.jsxs("p",{className:"text-red-300 text-sm mb-2",children:[e.jsx("strong",{children:"Attenzione:"})," Il GPS non √® disponibile o non funziona correttamente."]}),e.jsxs("p",{className:"text-red-200 text-xs",children:["Stai per effettuare un check-in ",e.jsx("strong",{children:"senza posizione GPS"}),'. Questo verr√† registrato come "Check-in Forzato" e sar√† visibile ai supervisori. Si consiglia di  ',e.jsx("strong",{children:"abilitare la posizione"})," per evitare l' eventuale annullamento del turno."]})]}),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-3",children:[e.jsx("h4",{className:"text-white font-medium mb-2",children:"Evento:"}),e.jsx("p",{className:"text-gray-300 text-sm",children:V.nome_evento}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:V.evento_localita})]}),v&&e.jsx("div",{className:"bg-gray-700 rounded-lg p-3",children:e.jsxs("p",{className:"text-gray-400 text-xs",children:[e.jsx("strong",{children:"Motivo:"})," ",v]})}),e.jsx("div",{className:"bg-yellow-900/20 border border-yellow-700 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-300 text-xs",children:"‚ÑπÔ∏è Consigliamo di risolvere il problema GPS prima del check-in. Se continui, il sistema registrer√† l'assenza della posizione."})})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>{_(!1),C(null)},className:"flex-1 bg-gray-700 text-white py-3 px-4 rounded-lg hover:bg-gray-600 font-medium",children:"Annulla"}),e.jsx("button",{onClick:()=>V&&me(V,!0),className:"flex-1 bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 font-medium",children:"Conferma Check-in Forzato"})]})]})})]})},Os=50,sd=()=>{const{user:n}=Pt(),{showSuccess:l,showError:c,showWarning:u,showInfo:f}=ms(),{currentLocation:x,getCurrentLocation:b,isLoading:v,error:S}=on(),{isOnline:g,addOfflineData:E}=Sa(),{currentSession:p,elapsedTime:k,elapsedTimes:P,startSession:D,endSession:R,manualCheckOut:j,loadActiveSession:M}=ln(),[T,F]=w.useState(!1),[U,te]=w.useState(!1),[N,_]=w.useState(null),[V,C]=w.useState(null),[K,O]=w.useState(""),[X,se]=w.useState(!1),[W,G]=w.useState(!1),[B,ne]=w.useState(!1),[ye,me]=w.useState(!1),[Q,fe]=w.useState(!1),[be,Z]=w.useState(!1),[L,re]=w.useState(!1),de=$=>$.toString().padStart(2,"0"),oe=()=>{const $=new Date;return`${de($.getHours())}:${de($.getMinutes())}`},ge=($,ue)=>{const[xe,pe]=($||"00:00").split(":").map(Number);let Ze=new Date;if(ue){const at=ue.split("-").map(Number);at.length===3&&(Ze=new Date(at[0],at[1]-1,at[2],0,0,0,0))}return Ze.setHours(xe,pe,0,0),Ze},ve=($,ue,xe)=>{if(!$||!ue)return 0;const pe=ge($,xe);let Ze=ge(ue,xe);return Ze.getTime()<pe.getTime()&&(Ze=new Date(Ze.getTime()+24*60*60*1e3)),Math.round((Ze.getTime()-pe.getTime())/6e4)},Te=($,ue)=>`cs_pending_${$}_${ue}`,we=($,ue)=>{try{localStorage.setItem(Te($,ue),"1")}catch{}},je=($,ue)=>{try{localStorage.removeItem(Te($,ue))}catch{}},Fe=($,ue)=>{if(!$)return!1;try{return!!localStorage.getItem(Te($,ue))}catch{return!1}},Ve=$=>{try{for(let ue=0;ue<localStorage.length;ue++){const xe=localStorage.key(ue)||"";if(xe.startsWith("cs_pending_")&&xe.endsWith(`_${$}`))return!0}return!1}catch{return!1}},rt=w.useCallback(async()=>{try{const{data:$,error:ue}=await Se.from("employee_meal_benefits").select("*").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0).maybeSingle();!ue&&$?(_($),te(!!$.buoni_pasto_enabled)):_({buoni_pasto_enabled:!1,buoni_pasto_value:7.5,pasto_aziendale_cost:12})}catch{_({buoni_pasto_enabled:!1,buoni_pasto_value:7.5,pasto_aziendale_cost:12})}},[n==null?void 0:n.id]),st=w.useCallback(async()=>{if(n!=null&&n.id)try{const $="e6427847-3291-424f-a092-4bec548859cf",{data:ue,error:xe}=await Se.from("crew_assegnazionetariffa").select("tariffe_ids, tariffe_personalizzate, tariffe_overrides").eq("dipendente_id",n.id).eq("attivo",!0).maybeSingle();if(xe||!ue||!ue.tariffe_ids||ue.tariffe_ids.length===0){C(null);return}if(!ue.tariffe_ids.includes($)){C(null);return}const{data:pe,error:Ze}=await Se.from("crew_tariffe").select("id, nome_tariffa, importo").eq("id",$).maybeSingle();if(Ze||!pe){C(null);return}let at=parseFloat(String(pe.importo||0));ue.tariffe_personalizzate&&ue.tariffe_personalizzate[$]?at=parseFloat(String(ue.tariffe_personalizzate[$])):ue.tariffe_overrides&&ue.tariffe_overrides[$]&&(at=parseFloat(String(ue.tariffe_overrides[$]))),at>0?C({tariffa_id:$,importo_orario:at}):C(null)}catch($){console.error("Errore caricamento benefit turno extra:",$),C(null)}},[n==null?void 0:n.id]);w.useEffect(()=>{rt(),st()},[rt,st]),w.useEffect(()=>{let $=!1,ue=!1,xe=0;const pe=async()=>{if(!($||ue)){ue=!0,xe+=1;try{typeof M=="function"&&(await M(),console.debug("ExtraCheckIn: loadActiveSession executed (PWA)"),xe=0)}catch(at){if(console.error("ExtraCheckIn: loadActiveSession failed (PWA)",at),xe<5&&!$){const bt=Math.min(3e4,500*Math.pow(2,xe));setTimeout(()=>{$||pe()},bt)}}finally{ue=!1}}};pe();const Ze=()=>{document.visibilityState==="visible"&&pe()};return document.addEventListener("visibilitychange",Ze),()=>{$=!0,document.removeEventListener("visibilitychange",Ze)}},[]),w.useEffect(()=>{if(p){const $=p,ue=!!($.pausa_pranzo_inizio&&!$.pausa_pranzo_fine),xe=!!$.pausa_pranzo_fine,pe=!!($.pausa_cena_inizio&&!$.pausa_cena_fine),Ze=!!$.pausa_cena_fine,at=Fe($.id,"lunch"),bt=Fe($.id,"dinner");me(ue||at),fe(xe),Z(pe||bt),re(Ze),$.pausa_pranzo_inizio&&je($.id,"lunch"),$.pausa_cena_inizio&&je($.id,"dinner")}else{const $=Ve("lunch"),ue=Ve("dinner");me($),fe(!1),Z(ue),re(!1)}},[p==null?void 0:p.id,p==null?void 0:p.type,p==null?void 0:p.pausa_pranzo_inizio,p==null?void 0:p.pausa_pranzo_fine,p==null?void 0:p.pausa_cena_inizio,p==null?void 0:p.pausa_cena_fine]);const Je=()=>{var $,ue;try{const xe=new Intl.DateTimeFormat("en-GB",{timeZone:"Europe/Rome",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date),pe=(($=xe.find(Oe=>Oe.type==="hour"))==null?void 0:$.value)??"00",Ze=((ue=xe.find(Oe=>Oe.type==="minute"))==null?void 0:ue.value)??"00",at=parseInt(pe,10),bt=parseInt(Ze,10);return{hour:Number.isNaN(at)?0:at,minute:Number.isNaN(bt)?0:bt}}catch{const pe=new Date;return{hour:pe.getHours(),minute:pe.getMinutes()}}},Qe=()=>{const{hour:$,minute:ue}=Je(),xe=$*60+ue,pe=(Ze,at=0)=>Ze*60+at;return xe>=pe(8,0)&&xe<=pe(16,0)?{allowLunch:!0,allowDinner:!1}:xe>=pe(16,1)&&xe<=pe(17,0)?{allowLunch:!0,allowDinner:!0}:xe>=pe(17,1)&&xe<=pe(23,59)?{allowLunch:!1,allowDinner:!0}:{allowLunch:!0,allowDinner:!1}},We=()=>{if(v)return e.jsx("p",{className:"text-xs text-yellow-300",children:"Rilevamento GPS in corso..."});if(x){const $=x.accuracy??null,ue=typeof $=="number"?Math.abs(Math.round($)):null,xe=typeof x.latitude=="number"?x.latitude.toFixed(5):"",pe=typeof x.longitude=="number"?x.longitude.toFixed(5):"",Ze=typeof ue=="number"?ue<=Os:!1;return ue===null||ue>=1e5?e.jsx("p",{className:"text-xs text-red-300",children:"GPS non affidabile ‚Äî precisione troppo bassa"}):ue>=1e3?e.jsxs("p",{className:"text-xs text-yellow-300",children:["Precisione GPS insufficiente (‚âà ",ue,' m). Premi "Aggiorna GPS".']}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:`text-xs ${Ze?"text-green-300":"text-yellow-300"}`,children:["OK ‚Äî ",Ze||ue<1e3?x.address||`${xe}, ${pe}`:"Posizione disponibile"," (¬±",ue,"m)",Ze?"":" ‚Äî precisione migliorabile"]}),!Ze&&e.jsxs("p",{className:"text-xs text-gray-400",children:[`Consiglio: clicca "Aggiorna GPS" finch√© l'accuratezza √® ‚â§ `,Os," m."]})]})}return e.jsx("p",{className:"text-xs text-red-300",children:S||"GPS non disponibile"})},gt=async($=!1)=>{!x&&!$&&(u("GPS Richiesto","Sto tentando di ottenere la posizione GPS per il check-in..."),await b({requiredAccuracy:Os,maxRetries:3}));let ue=x,xe=!1,pe=null;if(!ue&&!$)return u("Nessun GPS","Impossibile ottenere la posizione. Puoi forzare il check-in senza GPS."),!1;!ue&&$&&(xe=!0,pe=S||"GPS non disponibile - Check-in forzato");const Ze=new Date,at=`${Ze.getHours().toString().padStart(2,"0")}:${Ze.getMinutes().toString().padStart(2,"0")}`,bt=fr(Ze),Oe={crew_id:n==null?void 0:n.id,date:bt,check_in_time:at,status:"active",location:ue?{latitude:ue.latitude,longitude:ue.longitude,address:ue.address,accuracy:ue.accuracy,timestamp:ue.timestamp?ue.timestamp.toISOString():new Date().toISOString()}:null,forced_checkin:xe,gps_error_reason:pe,break_minutes:60,company_meal:T,meal_voucher:U,meal_cost:T?(N==null?void 0:N.pasto_aziendale_cost)||12:0,meal_notes:T?"Pasto aziendale richiesto":U?"Buono pasto richiesto":null,notes:"TURNO EXTRA",NoteTurno:K||null,benefit_tariffa_id:(V==null?void 0:V.tariffa_id)||null,benefit_importo_orario:(V==null?void 0:V.importo_orario)||null};try{if(g){console.log("Tentativo check-in con dati:",Oe);const{data:It,error:ct}=await Se.from("extra_shifts_checkins").insert(Oe).select().single();return ct?(console.error("Errore insert extra checkin:",ct),console.error("Dettagli errore:",{message:ct.message,details:ct.details,hint:ct.hint,code:ct.code}),E("checkin",Oe),u("Check-in Offline",`Problema salvataggio sul server: ${ct.message}. Il check-in √® stato salvato offline e verr√† sincronizzato.`),!1):(D({id:It.id,type:"extra",warehouseId:null,checkInTime:at,scheduledEndTime:null,shiftName:"Turno Extra",shiftStartTime:null,shiftEndTime:null,hasLunchBreak:!0,hasCompanyMeal:T,hasMealVoucher:U,breakTime:60,tableName:"extra_shifts_checkins"}),ne(!0),l("Check-in Extra",`Check-in extra registrato alle ${at}`),xe&&u("Attenzione GPS","Consigliamo di risolvere il problema GPS prima del check-in. Se continui, il sistema registrer√† l'assenza della posizione.",8e3),typeof M=="function"&&await M(),!0)}else return E("checkin",Oe),ne(!0),f("Check-in Offline","Check-in extra salvato offline - verr√† sincronizzato quando torni online"),!0}catch(It){return console.error("Errore durante check-in extra:",It),c("Errore","Si √® verificato un errore durante il check-in extra. Riprova."),!1}},qe=()=>{se(!0)},De=async()=>{se(!1),await gt(!0)},H=async($=!1)=>{try{f("Check-out in corso...","Sto completando il turno extra",1500);let ue=x;if(!$&&(await b({requiredAccuracy:Os,maxRetries:2}),ue=x,!ue)){u("Nessun GPS","Non √® stata acquisita una posizione valida. Puoi riprovare ad aggiornare GPS o forzare il checkout.");return}if(!await j(ue)){c("Errore Check-out","Si √® verificato un errore durante il check-out. Riprova.");return}try{if(p&&p.id){let pe=null;if(ue&&(pe={latitude:ue.latitude,longitude:ue.longitude,address:ue.address,accuracy:ue.accuracy,timestamp:ue.timestamp?ue.timestamp.toISOString():new Date().toISOString()}),g){const{error:Ze}=await Se.from("extra_shifts_checkins").update({NoteTurno:K||null,checkout_location:pe}).eq("id",p.id);Ze&&(console.error("Errore salvataggio checkout extra:",Ze),E("checkout_notes",{id:p.id,NoteTurno:K,checkout_location:pe}))}else E("checkout_notes",{id:p.id,NoteTurno:K,checkout_location:pe})}}catch(pe){console.error("Errore salvataggio NoteTurno/checkout_location:",pe)}R(),O(""),ne(!1),me(!1),fe(!1),Z(!1),re(!1),l("Check-out Completato",`Turno extra terminato. Tempo totale: ${k}`),typeof M=="function"&&await M()}catch(ue){console.error("Errore conferma check-out extra:",ue),c("Errore Sistema","Errore imprevisto durante il check-out extra")}},ae=async()=>{const $=x==null?void 0:x.accuracy,ue=!!x,xe=typeof $=="number"?$<=Os:!1;if(!ue||!xe){G(!0);return}await H(!1)},he=async()=>{G(!1),await b({requiredAccuracy:Os,maxRetries:3}),x?await H(!1):G(!0)},Ae=async()=>{G(!1),await H(!0),u("Attenzione GPS","Hai terminato il turno senza posizione finale. Il checkout viene registrato senza coordinate.",8e3)},Re=async($=!1)=>{if(!p||p.type!=="extra"){c("Errore","Nessuna sessione attiva per avviare la pausa");return}const{allowLunch:ue}=Qe();if(!ue){u("Pausa Pranzo","La pausa pranzo non √® disponibile in questa fascia oraria");return}if(ye||Q){u("Pausa","La pausa pranzo √® gi√† attiva o completata");return}let xe=x;if(!xe&&!$&&(u("GPS Non Disponibile","Richiesta attivazione GPS per registrare la pausa..."),await b({requiredAccuracy:Os,maxRetries:2}),xe=x,!xe)){u("Nessun GPS","Impossibile ottenere la posizione. Puoi forzare la pausa senza GPS.");return}const pe=oe(),Ze={pausa_pranzo_inizio:pe,break_start_time:pe};xe&&(Ze.break_start_location={latitude:xe.latitude,longitude:xe.longitude,address:xe.address,accuracy:xe.accuracy,timestamp:xe.timestamp?xe.timestamp.toISOString():new Date().toISOString()});const{error:at}=await Se.from("extra_shifts_checkins").update(Ze).eq("id",p.id);if(at){console.error("Errore salvataggio inizio pausa pranzo:",at),c("Errore","Impossibile salvare inizio pausa pranzo");return}we(p.id,"lunch"),me(!0),fe(!1),l("Pausa Iniziata",`Pausa pranzo iniziata alle ${pe}`),typeof M=="function"&&await M()},ee=async($=!1)=>{if(!p||p.type!=="extra"){c("Errore","Nessuna sessione attiva per terminare la pausa");return}if(!ye){u("Pausa","La pausa pranzo non risulta avviata");return}let ue=x;if(!ue&&!$&&(u("GPS Non Disponibile","Richiesta attivazione GPS per registrare la fine pausa..."),await b({requiredAccuracy:Os,maxRetries:2}),ue=x,!ue)){u("Nessun GPS","Impossibile ottenere la posizione. Puoi forzare la fine pausa senza GPS.");return}const xe=oe(),pe=p,Ze=(pe==null?void 0:pe.date)||fr(new Date),at=ve((pe==null?void 0:pe.pausa_pranzo_inizio)||(pe==null?void 0:pe.break_start_time)||"",xe,Ze),bt={pausa_pranzo_fine:xe,pausa_pranzo_minuti:at,has_taken_break:!0,break_end_time:xe};ue&&(bt.break_end_location={latitude:ue.latitude,longitude:ue.longitude,address:ue.address,accuracy:ue.accuracy,timestamp:ue.timestamp?ue.timestamp.toISOString():new Date().toISOString()});const Oe=(pe==null?void 0:pe.pausa_cena_minuti)&&Number(pe.pausa_cena_minuti)||0;bt.pausa_totale_minuti=(at||0)+Oe;const{error:It}=await Se.from("extra_shifts_checkins").update(bt).eq("id",p.id);if(It){console.error("Errore salvataggio fine pausa pranzo:",It),c("Errore","Impossibile salvare fine pausa pranzo");return}je(p.id,"lunch"),me(!1),fe(!0),Z(!1),re(!1),l("Pausa Terminata",`Fine pausa pranzo registrata alle ${xe} (${at} minuti)`),typeof M=="function"&&await M()},le=async($=!1)=>{if(!p||p.type!=="extra"){c("Errore","Nessuna sessione attiva per avviare la pausa cena");return}const{allowDinner:ue}=Qe();if(!(ue||Q)){u("Pausa Cena","La pausa cena non √® disponibile in questa fascia oraria");return}if(be||L){u("Pausa Cena","La pausa cena √® gi√† attiva o completata");return}let pe=x;if(!pe&&!$&&(u("GPS Non Disponibile","Richiesta attivazione GPS per registrare la pausa..."),await b({requiredAccuracy:Os,maxRetries:2}),pe=x,!pe)){u("Nessun GPS","Impossibile ottenere la posizione. Puoi forzare la pausa senza GPS.");return}const Ze=oe(),at={pausa_cena_inizio:Ze};pe&&(at.pausa_cena_start_location={latitude:pe.latitude,longitude:pe.longitude,address:pe.address,accuracy:pe.accuracy,timestamp:pe.timestamp?pe.timestamp.toISOString():new Date().toISOString()});const{error:bt}=await Se.from("extra_shifts_checkins").update(at).eq("id",p.id);if(bt){console.error("Errore salvataggio inizio pausa cena:",bt),c("Errore","Impossibile salvare inizio pausa cena");return}we(p.id,"dinner"),Z(!0),re(!1),l("Pausa Cena Iniziata",`Pausa cena iniziata alle ${Ze}`),typeof M=="function"&&await M()},Ee=async($=!1)=>{if(!p||p.type!=="extra"){c("Errore","Nessuna sessione attiva per terminare la pausa cena");return}if(!be){u("Pausa Cena","La pausa cena non risulta avviata");return}let ue=x;if(!ue&&!$&&(u("GPS Non Disponibile","Richiesta attivazione GPS per registrare la fine pausa..."),await b({requiredAccuracy:Os,maxRetries:2}),ue=x,!ue)){u("Nessun GPS","Impossibile ottenere la posizione. Puoi forzare la fine pausa senza GPS.");return}const xe=oe(),pe=p,Ze=(pe==null?void 0:pe.date)||fr(new Date),at=ve((pe==null?void 0:pe.pausa_cena_inizio)||"",xe,Ze),Oe=((pe==null?void 0:pe.pausa_pranzo_minuti)&&Number(pe.pausa_pranzo_minuti)||0)+(at||0),It={pausa_cena_fine:xe,pausa_cena_minuti:at,pausa_totale_minuti:Oe};ue&&(It.pausa_cena_end_location={latitude:ue.latitude,longitude:ue.longitude,address:ue.address,accuracy:ue.accuracy,timestamp:ue.timestamp?ue.timestamp.toISOString():new Date().toISOString()});const{error:ct}=await Se.from("extra_shifts_checkins").update(It).eq("id",p.id);if(ct){console.error("Errore salvataggio fine pausa cena:",ct),c("Errore","Impossibile salvare fine pausa cena");return}je(p.id,"dinner"),Z(!1),re(!0),l("Pausa Cena Terminata",`Fine pausa cena registrata alle ${xe} (${at} minuti)`),typeof M=="function"&&await M()},{allowLunch:_e,allowDinner:J}=Qe(),ke=J||Q;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:"Turno Extra"}),e.jsx("p",{className:"text-sm text-gray-300",children:"Registra qui un turno extra non programmato. Questo flusso usa solo GPS (nessun QR). I turni extra verranno registrati senza riferimento a un magazzino."}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm text-gray-200 font-medium",children:"Stato GPS"}),We()]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>b({requiredAccuracy:Os,maxRetries:3}),className:"bg-gray-700 px-3 py-1 rounded-lg text-xs",disabled:v,children:"Aggiorna GPS"}),e.jsx("button",{onClick:()=>b({requiredAccuracy:10,maxRetries:5}),className:"bg-gray-700 px-3 py-1 rounded-lg text-xs",title:"Tentativo avanzato (maggior tempo/priorit√†)",disabled:v,children:"Migliora posizione"})]})]}),e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsx("label",{className:"block text-sm text-gray-300",children:"Note turno (opzionali)"}),e.jsx("textarea",{value:K,onChange:$=>O($.target.value),placeholder:"Annota eventuali note sul turno...",className:"w-full min-h-[80px] bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Queste note verranno salvate nella colonna NoteTurno al check-out."})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:T,onChange:()=>{F(!T),T||te(!1)}}),e.jsx("span",{className:"text-sm text-gray-300",children:"Pasto aziendale"})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:U,onChange:()=>{te(!U),U||F(!1)}}),e.jsx("span",{className:"text-sm text-gray-300",children:"Buono pasto"})]})]})}),e.jsxs("div",{className:"mt-4 flex space-x-2",children:[e.jsx("button",{onClick:()=>gt(!1),className:`flex-1 ${B||p?"bg-gray-600 cursor-not-allowed":"bg-green-600 hover:bg-green-700"} text-white py-2 px-3 rounded-lg`,disabled:!!(B||p),children:"‚úÖ Effettua Check-in Extra"}),e.jsx("button",{onClick:qe,className:`flex-1 ${B||p?"bg-gray-600 cursor-not-allowed":"bg-yellow-600 hover:bg-yellow-700"} text-white py-2 px-3 rounded-lg`,disabled:!!(B||p),children:"‚ö†Ô∏è Forza Check-in (Senza GPS)"})]})]}),X&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-6 border border-red-600",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-red-900 p-3 rounded-full",children:e.jsx(Nt,{className:"h-6 w-6 text-red-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:"Conferma Check-in Forzato"}),e.jsxs("p",{className:"text-red-200 text-xs mt-2",children:["Stai per effettuare un check-in ",e.jsx("strong",{children:"senza posizione GPS"}),'. Questo verr√† registrato come "Check-in Forzato" e sar√† visibile ai supervisori. Si consiglia di  ',e.jsx("strong",{children:"abilitare la posizione"})," per evitare l' eventuale annullamento del turno."]})]})]}),e.jsx("button",{onClick:()=>se(!1),className:"text-gray-400 hover:text-gray-200",children:e.jsx(Et,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"mt-6 flex space-x-3",children:[e.jsx("button",{onClick:()=>se(!1),className:"flex-1 bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-600",children:"Annulla"}),e.jsx("button",{onClick:De,className:"flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700",children:"Conferma Forza Check-in"})]}),e.jsx("div",{className:"mt-4 text-xs text-yellow-200",children:"Consigliamo di risolvere il problema GPS prima del check-in. Se continui, il sistema registrer√† l'assenza della posizione."})]})}),W&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-6 border border-red-600",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-red-900 p-3 rounded-full",children:e.jsx(Nt,{className:"h-6 w-6 text-red-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:"Conferma Terminazione Turno"}),e.jsx("p",{className:"text-red-200 text-xs mt-2",children:"Prima di terminare il turno, abilita la posizione per registrare la posizione finale."})]})]}),e.jsx("button",{onClick:()=>G(!1),className:"text-gray-400 hover:text-gray-200",children:e.jsx(Et,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("p",{className:"text-red-200 text-xs",children:["Stai per effettuare un check-out ",e.jsx("strong",{children:"senza posizione GPS"}),". Questo verr√† registrato senza coordinate finali e potrebbe essere visibile ai supervisori."]})}),e.jsxs("div",{className:"mt-6 flex space-x-3",children:[e.jsx("button",{onClick:he,className:"flex-1 bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-600",children:"Riprova GPS e termina turno"}),e.jsx("button",{onClick:Ae,className:"flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700",children:"Conferma senza posizione"})]})]})}),p&&p.type==="extra"&&e.jsxs("div",{className:"bg-purple-900 rounded-xl p-4 border border-purple-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-white font-medium",children:"Sessione Attiva ‚Äî Turno Extra"}),e.jsx("div",{className:"text-white font-mono",children:p&&p.id?P[p.id]||k||"00:00:00":k||"00:00:00"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-purple-200",children:"Gestione pause (Pranzo ‚Üí Cena)"}),e.jsxs("div",{className:"mt-2 flex space-x-2",children:[!ye&&!Q&&e.jsx("button",{onClick:()=>Re(!1),className:`flex-1 ${_e?"bg-orange-500 hover:bg-orange-600 text-white":"bg-gray-700 text-gray-300 opacity-60 cursor-not-allowed"} py-2 rounded-lg`,disabled:!_e,title:_e?"Inizia Pausa Pranzo":"Pausa pranzo non disponibile in questa fascia oraria",children:"Inizia Pausa Pranzo"}),ye&&e.jsx("button",{onClick:()=>ee(!1),className:"flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg",children:"Termina Pausa Pranzo"}),Q&&e.jsx("button",{disabled:!0,className:"flex-1 bg-gray-700 text-gray-300 py-2 rounded-lg opacity-60 cursor-not-allowed",children:"Pausa Pranzo Completata"}),!be&&!L&&e.jsx("button",{onClick:()=>le(!1),className:`flex-1 ${ke?"bg-orange-700 hover:bg-orange-800 text-white":"bg-gray-700 text-gray-300 opacity-60 cursor-not-allowed"} py-2 rounded-lg`,disabled:!ke,title:ke?"Inizia Pausa Cena":J?"Pausa cena non disponibile":"Pausa cena disponibile solo in orari consentiti o dopo la pausa pranzo",children:"Inizia Pausa Cena"}),be&&e.jsx("button",{onClick:()=>Ee(!1),className:"flex-1 bg-green-700 hover:bg-green-800 text-white py-2 rounded-lg",children:"Termina Pausa Cena"}),L&&e.jsx("button",{disabled:!0,className:"flex-1 bg-gray-700 text-gray-300 py-2 rounded-lg opacity-60 cursor-not-allowed",children:"Pausa Cena Completata"})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-300",children:[ye&&e.jsx("div",{children:"Pausa pranzo iniziata"}),Q&&!be&&e.jsx("div",{children:"Pausa pranzo completata"}),be&&e.jsx("div",{children:"Pausa cena iniziata"}),L&&e.jsx("div",{children:"Pausa cena completata"})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-purple-200",children:"Fine turno"}),e.jsx("div",{className:"mt-2 flex space-x-2",children:e.jsx("button",{onClick:ae,className:"flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg",children:"üõë Termina Turno Extra"})})]})]})]}),!g&&e.jsx("div",{className:"bg-orange-900 rounded-xl p-3 border border-orange-700",children:e.jsx("p",{className:"text-orange-100 text-sm",children:"Sei offline: i check-in verranno salvati localmente e sincronizzati quando torni online."})})]})},rd=()=>{const[n,l]=w.useState("warehouse");return e.jsx("div",{className:"min-h-screen bg-gray-900 text-white",children:e.jsxs("div",{className:"p-4 pb-20 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Check-in Mobile"}),e.jsx("p",{className:"text-gray-300",children:"Scegli il tipo di check-in"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-gray-300",children:new Date().toLocaleDateString("it-IT")}),e.jsx("div",{className:"text-xs text-gray-400",children:new Date().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-2 border border-gray-700",children:e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("button",{onClick:()=>l("warehouse"),className:`flex items-center justify-center space-x-2 py-3 px-4 rounded-lg transition-all ${n==="warehouse"?"bg-purple-600 text-white shadow-lg":"text-gray-400 hover:text-white hover:bg-gray-700"}`,children:[e.jsx(ma,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Turni"})]}),e.jsxs("button",{onClick:()=>l("event"),className:`flex items-center justify-center space-x-2 py-3 px-4 rounded-lg transition-all ${n==="event"?"bg-blue-600 text-white shadow-lg":"text-gray-400 hover:text-white hover:bg-gray-700"}`,children:[e.jsx(Ut,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Eventi"})]}),e.jsxs("button",{onClick:()=>l("extra"),className:`flex items-center justify-center space-x-2 py-3 px-4 rounded-lg transition-all ${n==="extra"?"bg-green-600 text-white shadow-lg":"text-gray-400 hover:text-white hover:bg-gray-700"}`,children:[e.jsx(xt,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Turni extra"})]})]})}),e.jsx("div",{className:"space-y-6",children:n==="warehouse"?e.jsx(ed,{}):n==="event"?e.jsx(td,{}):e.jsx(sd,{})}),e.jsx(Jr,{})]})})},ad=()=>{const{user:n}=Pt(),[l,c]=w.useState({permission:"default",isSupported:!1,isServiceWorkerReady:!1,subscription:null}),[u,f]=w.useState(!1),[x,b]=w.useState(null);w.useEffect(()=>{(async()=>{const M="Notification"in window&&"serviceWorker"in navigator&&"PushManager"in window,T=Notification.permission;let F=!1,U=null;if(M&&"serviceWorker"in navigator)try{const te=await navigator.serviceWorker.ready;F=!!te,te&&te.pushManager&&(U=await te.pushManager.getSubscription())}catch(te){console.error("Errore nel controllo service worker:",te)}c({permission:T,isSupported:M,isServiceWorkerReady:F,subscription:U}),console.log("üîî Stato notifiche iniziale:",{isSupported:M,permission:T,isServiceWorkerReady:F,hasSubscription:!!U})})()},[]);const v=w.useCallback(async()=>{if(!l.isSupported)return b("Notifiche non supportate su questo dispositivo"),!1;if(l.permission==="granted")return!0;f(!0),b(null);try{const j=await Notification.requestPermission();return c(M=>({...M,permission:j})),j==="granted"?await S():(b("Permessi notifiche negati"),!1)}catch(j){return console.error("Errore richiesta permessi:",j),b("Errore nella richiesta permessi notifiche"),!1}finally{f(!1)}},[l.isSupported,l.permission]),S=w.useCallback(async()=>{if(!l.isServiceWorkerReady)return b("Service Worker non pronto"),!1;try{const T=await(await navigator.serviceWorker.ready).pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:nd("BEl62iUYgUivxIkv69yViEuiBIa6iMjyr3PJQYjdKFOqKxsr8CxaVkMpBGFGlqOlZHgAhyNcHGpWWBJB1bFfLUo")});c(F=>({...F,subscription:T}));try{await g(T)}catch(F){console.warn("Impossibile salvare la subscription sul server:",F)}return console.log("‚úÖ Sottoscrizione push creata:",T),!0}catch(j){return console.error("Errore sottoscrizione push:",j),b("Errore nella sottoscrizione alle notifiche"),!1}},[l.isServiceWorkerReady,n==null?void 0:n.id]),g=async j=>{try{const M=j&&typeof j.toJSON=="function"?j.toJSON():j,T=M==null?void 0:M.endpoint,F=(M==null?void 0:M.keys)||(M&&M.getKey?{p256dh:M.getKey("p256dh")?btoa(String.fromCharCode(...new Uint8Array(M.getKey("p256dh")))):null,auth:M.getKey("auth")?btoa(String.fromCharCode(...new Uint8Array(M.getKey("auth")))):null}:null);if(!T)return console.warn("savePushSubscription: endpoint mancante nella subscription"),!1;const U={user_id:(n==null?void 0:n.id)||null,endpoint:T,keys:F,subscription:M,platform:navigator.userAgent.includes("Android")?"android":"web",user_agent:navigator.userAgent,is_pwa:window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches||!1,status:"active",last_seen:new Date().toISOString(),created_at:new Date().toISOString()},{data:te,error:N}=await Se.from("push_subscriptions").select("id").match({endpoint:T,user_id:n==null?void 0:n.id}).limit(1);if(N&&console.warn("Attenzione: errore durante la ricerca subscription esistente:",N),te&&te.length>0){const _=te[0].id,{error:V}=await Se.from("push_subscriptions").update({subscription:U.subscription,keys:U.keys,user_agent:U.user_agent,is_pwa:U.is_pwa,status:"active",last_seen:U.last_seen}).eq("id",_);return V?(console.error("Errore aggiornamento subscription su DB:",V),!1):(console.log("üíæ Subscription aggiornata su DB (id):",_),!0)}else{const{data:_,error:V}=await Se.from("push_subscriptions").insert([U]);return V?(console.error("Errore inserimento subscription su DB:",V),!1):(console.log("üíæ Subscription inserita su DB:",_),!0)}}catch(M){return console.error("Errore savePushSubscription:",M),!1}},E=w.useCallback(j=>{if(l.permission!=="granted"){console.warn("Permessi notifiche non concessi");return}const M={body:j.body,icon:j.icon||"/pwa-192x192.png",badge:j.badge||"/pwa-192x192.png",tag:j.tag||"crew-notification",requireInteraction:j.requireInteraction||!1,silent:j.silent||!1,vibrate:j.vibrate||[200,100,200],data:{url:j.url||"/",timestamp:Date.now()}};if("serviceWorker"in navigator){navigator.serviceWorker.ready.then(T=>{if(T&&typeof T.showNotification=="function")return T.showNotification(j.title,M);throw new Error("registration.showNotification non disponibile")}).catch(T=>{console.warn("showNotification via SW fallita, uso Notification API come fallback",T);try{const F=new Notification(j.title,M);F.onclick=()=>{window.focus(),j.url&&(window.location.href=j.url),F.close()},setTimeout(()=>F.close(),1e4)}catch(F){console.error("Errore fallback Notification API:",F)}});return}try{const T=new Notification(j.title,M);T.onclick=()=>{window.focus(),j.url&&(window.location.href=j.url),T.close()},setTimeout(()=>T.close(),1e4)}catch(T){console.error("Errore nel mostrare la notifica localmente:",T)}},[l.permission]),p=w.useCallback(()=>{if(!(n!=null&&n.id))return;console.log("üëÇ Sottoscrizione notifiche database per user:",n.id);const j=Se.channel("user-notifications-"+n.id).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifiche",filter:`id_utente=eq.${n.id}`},M=>{console.log("üì¨ Nuova notifica ricevuta:",M);const T=M.new;E({title:T.titolo||"Notifica",body:T.messaggio||"",tag:`notifica-${T.id}`,url:T.url_azione||"/",requireInteraction:T.tipo==="urgente",vibrate:[200,100,200]})}).subscribe();return()=>{Se.removeChannel(j)}},[n==null?void 0:n.id,E]),k=w.useCallback(()=>{E({title:"üß™ Test Notifica",body:"Questa √® una notifica di test",tag:"test-notification",requireInteraction:!1,vibrate:[200,100,200]})},[E]),P=w.useCallback((j,M)=>{E({title:"‚è∞ Promemoria Turno",body:`Il tuo turno "${j}" inizia alle ${M}`,tag:"shift-reminder",url:"/checkin",requireInteraction:!0,vibrate:[300,100,300]})},[E]),D=w.useCallback(j=>{E({title:"üìç Check-in Richiesto",body:`Non dimenticare di fare check-in presso ${j}`,tag:"checkin-reminder",url:"/checkin",requireInteraction:!0,vibrate:[200,100,200]})},[E]),R=w.useCallback(j=>{E({title:"‚è±Ô∏è Straordinari Rilevati",body:`Hai lavorato ${j.toFixed(1)} ore di straordinario oggi`,tag:"overtime-alert",url:"/timesheet",requireInteraction:!1,vibrate:[100,50,100]})},[E]);return w.useEffect(()=>{let j;return n!=null&&n.id&&l.permission==="granted"&&(j=p()),()=>{j&&j()}},[n==null?void 0:n.id,l.permission,p]),{permission:l.permission,isSupported:l.isSupported,isServiceWorkerReady:l.isServiceWorkerReady,subscription:l.subscription,isLoading:u,error:x,requestPermission:v,subscribeToPush:S,sendLocalNotification:E,sendTestNotification:k,sendShiftReminder:P,sendCheckInReminder:D,sendOvertimeAlert:R,subscribeToNotifications:p}};function nd(n){const l="=".repeat((4-n.length%4)%4),c=(n+l).replace(/-/g,"+").replace(/_/g,"/"),u=window.atob(c),f=new Uint8Array(u.length);for(let x=0;x<u.length;++x)f[x]=u.charCodeAt(x);return f}function id(){const{user:n}=Pt(),[l,c]=w.useState([]),[u,f]=w.useState(!0),x=S=>S.titolo_corso||S.corso_titolo||S.corso_nome||S.corso&&(S.corso.titolo||S.corso.nome)||null,b=(S=[])=>S.map(g=>({...g,courseTitle:x(g)||"Corso da confermare"})),v=w.useCallback(async S=>{if(!S){c([]),f(!1);return}f(!0);try{const{data:g,error:E}=await Se.from("crew_assegnazionecorsi").select("*, corso:corso_id(id, titolo, nome)").eq("persona_id",S).eq("stato_invito","invitato").order("data_invito",{ascending:!1});E?(console.error("Errore caricamento crew_assegnazionecorsi (pending):",E),c([])):c(b(g||[]))}catch(g){console.error("Eccezione loadPending course assignments:",g),c([])}finally{f(!1)}},[]);return w.useEffect(()=>{if(!(n!=null&&n.id)){c([]),f(!1);return}v(n.id);const S=Se.channel(`course-notifs-${n.id}`).on("postgres_changes",{event:"*",schema:"public",table:"crew_assegnazionecorsi",filter:`persona_id=eq.${n.id}`},g=>{try{const E=g.event;if(E==="INSERT"){const p=g.new;if(p.stato_invito==="invitato"){const k=b([p])[0];c(P=>P.find(D=>String(D.id)===String(k.id))?P:[k,...P])}}else if(E==="UPDATE"){const p=g.new,k=b([p])[0];c(P=>{const D=P.find(R=>String(R.id)===String(k.id));return p.stato_invito==="invitato"?D?P.map(R=>String(R.id)===String(k.id)?k:R):[k,...P]:P.filter(R=>String(R.id)!==String(k.id))})}else if(E==="DELETE"){const p=g.old;c(k=>k.filter(P=>String(P.id)!==String(p.id)))}}catch(E){console.warn("Errore gestione realtime crew_assegnazionecorsi payload",E),v(n.id)}}).subscribe();return()=>{Se.removeChannel(S)}},[n==null?void 0:n.id,v]),{pendingCourses:l,count:l.length,loading:u,reload:()=>v(n==null?void 0:n.id)}}function od({className:n,onClick:l}){const{pendingCourses:c,count:u,loading:f}=id();return f||u===0?null:e.jsx("button",{onClick:()=>l&&l(),className:`absolute -top-1 -right-1 bg-transparent ${n||""}`,"aria-label":`${u} corso${u>1?"i":""} da confermare`,type:"button",children:e.jsx("span",{className:"inline-flex items-center justify-center bg-red-500 text-white text-[10px] font-semibold rounded-full h-5 w-5",children:u>9?"9+":u})})}const ld=()=>{var me;const{user:n,logout:l}=Pt(),{permission:c}=ad(),{showSuccess:u,showError:f,showWarning:x}=ms(),[b,v]=w.useState(null),[S,g]=w.useState([]),[E,p]=w.useState(!0),[k,P]=w.useState(!0),[D,R]=w.useState(!0),[j,M]=w.useState(!0),[T,F]=w.useState(!1),[U,te]=w.useState(!1);w.useEffect(()=>{n!=null&&n.id&&(N(),_())},[n==null?void 0:n.id]);const N=async()=>{try{p(!0);const{data:Q,error:fe}=await Se.from("registration_requests").select(`
          *,
          regaziendasoftware!parent_company_id(
            id,
            ragione_sociale,
            email,
            telefono,
            indirizzo
          )
        `).eq("auth_user_id",n==null?void 0:n.id).single();if(fe){console.error("Errore nel caricamento profilo:",fe);return}v(Q)}catch(Q){console.error("Errore nel caricamento profilo utente:",Q)}finally{p(!1)}},_=async()=>{try{P(!0),console.log("üéÅ Caricamento benefit dipendente per user:",n==null?void 0:n.id);const{data:Q,error:fe}=await Se.from("crew_assegnazionetariffa").select("tariffe_ids, tariffe_personalizzate").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0);if(fe){console.error("‚ùå Errore caricamento assegnazioni tariffe:",fe),g([]);return}console.log("üìã Assegnazioni tariffe trovate:",(Q==null?void 0:Q.length)||0);const be=[];let Z={};if(Q==null||Q.forEach(L=>{L.tariffe_ids&&L.tariffe_ids.length>0&&be.push(...L.tariffe_ids),L.tariffe_personalizzate&&(Z={...Z,...L.tariffe_personalizzate})}),console.log("üîç ID tariffe da caricare:",be),console.log("üí∞ Tariffe personalizzate:",Z),be.length>0){const L=[...new Set(be)],{data:re,error:de}=await Se.from("crew_tariffe").select("*").in("id",L).eq("attivo",!0).order("categoria",{ascending:!0});if(de){console.error("‚ùå Errore caricamento dettagli tariffe:",de),g([]);return}console.log("‚úÖ Benefit caricati:",(re==null?void 0:re.length)||0);const oe=(re||[]).map(ge=>{const ve=Z[ge.id],Te=ve!==void 0?ve:ge.importo;return console.log(`üíµ Benefit "${ge.nome_tariffa}": personalizzato=${ve}, standard=${ge.importo}, finale=${Te}`),{id:ge.id,nome_tariffa:ge.nome_tariffa,categoria:ge.categoria,tipo_calcolo:ge.tipo_calcolo,importo:Te,descrizione:ge.descrizione,attivo:ge.attivo}});g(oe)}else console.log("‚ö†Ô∏è Nessuna tariffa assegnata al dipendente"),g([]);await K()}catch(Q){console.error("‚ùå Errore generale caricamento benefit:",Q),g([])}finally{P(!1)}},[V,C]=w.useState(null),K=async()=>{try{console.log("üçΩÔ∏è Caricamento benefit pasti per dipendente:",n==null?void 0:n.id);const{data:Q,error:fe}=await Se.from("employee_meal_benefits").select("*").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0).maybeSingle();if(fe){console.error("‚ùå Errore caricamento benefit pasti:",fe),C(null);return}Q?(console.log("‚úÖ Benefit pasti caricati:",Q),C(Q)):(console.log("‚ö†Ô∏è Nessun benefit pasti configurato per questo dipendente"),C(null))}catch(Q){console.error("‚ùå Errore generale caricamento benefit pasti:",Q),C(null)}},O=Q=>({indennita_trasferta:"Indennit√† Trasferta",bonus_responsabile:"Bonus Responsabile",bonus_autista:"Bonus Autista",straordinario_festivo:"Straordinario Festivo",straordinario_notturno:"Straordinario Notturno",straordinario_trasferta:"Straordinario Trasferta",rimborso_chilometrico:"Rimborso Chilometrico",stipendio_base:"Stipendio Base",bonus_guida_automezzo:"Bonus Guida Automezzo",indennita_reperibilita:"Indennit√† Reperibilit√†",altro:"Altro"})[Q]||Q,X=(V==null?void 0:V.buoni_pasto_enabled)||!1;V!=null&&V.pasto_aziendale_enabled;const se=[{id:"notifications",label:"Notifiche Push",description:"Ricevi notifiche per turni e aggiornamenti",value:D,onChange:R},{id:"autoSync",label:"Sincronizzazione Automatica",description:"Sincronizza dati quando connesso",value:j,onChange:M},{id:"offlineMode",label:"Modalit√† Offline",description:"Salva dati localmente quando offline",value:T,onChange:F}],W=async()=>{try{x("Logout in corso..."),await l(),u("Logout effettuato con successo!"),window.location.href="/"}catch(Q){console.error("Errore durante il logout:",Q),u("Sessione terminata localmente"),setTimeout(()=>{window.location.href="/"},1e3)}};if(E)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento profilo..."})]})});if(!b)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("p",{className:"text-lg",children:"Errore nel caricamento del profilo"}),e.jsx("button",{onClick:()=>N(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg",children:"Riprova"})]})});const B=(b.full_name||b.company_name||"").split(" "),ne=B[0]||"Nome",ye=B.slice(1).join(" ")||"Cognome";return e.jsx("div",{className:"min-h-screen bg-gray-900 text-white",children:e.jsxs("div",{className:"p-4 pb-20 space-y-6",children:[e.jsx("div",{className:"bg-gradient-to-br from-blue-600 to-cyan-600 rounded-2xl p-6 shadow-xl",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center",children:e.jsx(Xr,{className:"h-8 w-8 text-white"})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold text-white",children:[ne," ",ye]}),e.jsx("p",{className:"text-blue-100",children:((me=b.regaziendasoftware)==null?void 0:me.ragione_sociale)||"Azienda"}),e.jsx("p",{className:"text-sm text-blue-200",children:"Dipendente"})]})]})}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4 flex items-center space-x-2",children:[e.jsx(js,{className:"h-5 w-5 text-purple-400"}),e.jsx("span",{children:"I Miei Benefit Contrattuali"})]}),k?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-300",children:"Caricamento benefit..."})]}):S.length===0?e.jsxs("div",{className:"text-center py-6 text-gray-400",children:[e.jsx(js,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsx("p",{children:"Nessun benefit assegnato"}),e.jsx("p",{className:"text-sm mt-1",children:"Contatta l'azienda per informazioni sui benefit"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-600 to-red-600 rounded-lg p-4 mb-4",children:[e.jsxs("h4",{className:"font-bold text-white mb-2 flex items-center space-x-2",children:[e.jsx(Ls,{className:"h-5 w-5"}),e.jsx("span",{children:"Benefit Pasti"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:`p-3 rounded-lg ${X?"bg-green-900 border border-green-700":"bg-red-900 border border-red-700"}`,children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[X?e.jsx(pt,{className:"h-4 w-4 text-green-400"}):e.jsx(Et,{className:"h-4 w-4 text-red-400"}),e.jsx("span",{className:"text-white text-sm font-medium",children:"Buoni Pasto"})]}),e.jsx("p",{className:"text-xs text-gray-300 mt-1",children:X?`‚Ç¨${(V==null?void 0:V.buoni_pasto_value)||"7.50"} per turno`:"Non incluso"})]}),e.jsxs("div",{className:"p-3 rounded-lg bg-blue-900 border border-blue-700",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(pt,{className:"h-4 w-4 text-blue-400"}),e.jsx("span",{className:"text-white text-sm font-medium",children:"Pasto Aziendale"})]}),e.jsxs("p",{className:"text-xs text-gray-300 mt-1",children:["Costo: ‚Ç¨",(V==null?void 0:V.pasto_aziendale_cost)||"12.00"]})]})]}),V&&(V.diaria_eventi_enabled||V.diaria_trasferta_enabled)&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-orange-500",children:[e.jsx("h5",{className:"text-white font-medium mb-2",children:"Diarie"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[V.diaria_eventi_enabled&&e.jsxs("div",{className:"p-2 rounded bg-green-900 border border-green-700",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(pt,{className:"h-3 w-3 text-green-400"}),e.jsx("span",{className:"text-white text-xs font-medium",children:"Diaria Eventi"})]}),e.jsxs("p",{className:"text-xs text-green-300",children:["‚Ç¨",V.diaria_eventi_value||"25.00"]})]}),V.diaria_trasferta_enabled&&e.jsxs("div",{className:"p-2 rounded bg-green-900 border border-green-700",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(pt,{className:"h-3 w-3 text-green-400"}),e.jsx("span",{className:"text-white text-xs font-medium",children:"Diaria Trasferta"})]}),e.jsxs("p",{className:"text-xs text-green-300",children:["‚Ç¨",V.diaria_trasferta_value||"35.00"]})]})]})]})]}),e.jsx("div",{className:"space-y-2",children:S.map(Q=>e.jsx("div",{className:"bg-gray-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center space-x-3",children:e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-white",children:Q.nome_tariffa}),e.jsx("p",{className:"text-xs text-gray-400",children:O(Q.categoria)}),Q.descrizione&&e.jsx("p",{className:"text-xs text-gray-300 mt-1",children:Q.descrizione})]})}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-lg font-bold text-green-400",children:Q.tipo_calcolo==="percentuale"?`${Q.importo}%`:`‚Ç¨${Q.importo}`}),e.jsx("div",{className:"text-xs text-gray-400",children:Q.tipo_calcolo==="orario"?"/ora":Q.tipo_calcolo==="giornaliero"?"/giorno":Q.tipo_calcolo==="fisso"?"fisso":Q.tipo_calcolo==="percentuale"?"percentuale":""})]})]})},Q.id))}),e.jsx("div",{className:"bg-blue-900 border border-blue-700 rounded-lg p-3 mt-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(js,{className:"h-4 w-4 text-blue-400"}),e.jsxs("span",{className:"text-blue-200 text-sm",children:[e.jsx("strong",{children:"Totale benefit attivi:"})," ",S.length]})]})})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Informazioni Contatto"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(fa,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.email}),e.jsx("p",{className:"text-xs text-gray-400",children:"Email aziendale"})]})]}),b.phone&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Wa,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.phone}),e.jsx("p",{className:"text-xs text-gray-400",children:"Telefono personale"})]})]})]})]}),b.regaziendasoftware&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"La Mia Azienda"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Rt,{className:"h-5 w-5 text-blue-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.regaziendasoftware.ragione_sociale}),e.jsx("p",{className:"text-xs text-gray-400",children:"Ragione sociale"})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(fa,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.regaziendasoftware.email}),e.jsx("p",{className:"text-xs text-gray-400",children:"Email aziendale"})]})]}),b.regaziendasoftware.telefono&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Wa,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.regaziendasoftware.telefono}),e.jsx("p",{className:"text-xs text-gray-400",children:"Telefono aziendale"})]})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Impostazioni App"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white font-medium",children:"Notifiche Push"}),e.jsx("p",{className:"text-sm text-gray-400",children:c==="granted"?"Abilitate":c==="denied"?"Bloccate":"Non configurate"})]}),e.jsx("button",{onClick:()=>te(!U),className:"bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm",children:"Gestisci"})]}),c==="denied"&&e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-red-400 text-sm font-medium mb-2",children:"Notifiche Bloccate dal Browser"}),e.jsx("p",{className:"text-red-300 text-xs mb-3",children:"Le notifiche sono state bloccate. Per ricevere aggiornamenti importanti su turni, note spese e straordinari, devi sbloccarle manualmente."}),e.jsxs("div",{className:"bg-red-950/50 rounded p-2 text-xs text-red-200 space-y-1",children:[e.jsx("p",{className:"font-medium",children:"Come sbloccare:"}),e.jsx("p",{children:"1. Tocca l'icona del lucchetto nella barra del browser"}),e.jsx("p",{children:'2. Trova "Notifiche" nelle impostazioni'}),e.jsx("p",{children:'3. Cambia da "Bloccato" a "Consenti"'}),e.jsx("p",{children:"4. Ricarica la pagina"})]})]}),c==="granted"&&e.jsxs("div",{className:"bg-green-900/20 border border-green-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-green-400 text-sm font-medium mb-2",children:"Notifiche Attive"}),e.jsx("p",{className:"text-green-300 text-xs",children:"Riceverai notifiche per:"}),e.jsxs("ul",{className:"text-green-200 text-xs mt-2 space-y-1 ml-4",children:[e.jsx("li",{children:"‚Ä¢ Nuovi turni assegnati"}),e.jsx("li",{children:"‚Ä¢ Modifiche ai turni"}),e.jsx("li",{children:"‚Ä¢ Approvazione note spese"}),e.jsx("li",{children:"‚Ä¢ Richieste straordinari"}),e.jsx("li",{children:"‚Ä¢ Messaggi importanti"})]})]}),c==="default"&&e.jsxs("div",{className:"bg-yellow-900/20 border border-yellow-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-yellow-400 text-sm font-medium mb-2",children:"Configura le Notifiche"}),e.jsx("p",{className:"text-yellow-300 text-xs mb-2",children:'Clicca su "Gestisci" per attivare le notifiche e rimanere aggiornato su turni e approvazioni.'})]})]}),se.map(Q=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white font-medium",children:Q.label}),e.jsx("p",{className:"text-sm text-gray-400",children:Q.description})]}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Q.value,onChange:fe=>Q.onChange(fe.target.checked),className:"sr-only peer"}),e.jsx("div",{className:"w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"})]})]},Q.id))]})]}),U&&e.jsx(od,{}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Informazioni App"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Versione"}),e.jsx("span",{className:"text-white font-medium",children:"1.0.8"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Ultimo Aggiornamento"}),e.jsx("span",{className:"text-white font-medium",children:"Gennaio 2025"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Modalit√†"}),e.jsx("span",{className:"text-blue-400 font-medium",children:"Mobile"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Connessione"}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(li,{className:"h-4 w-4 text-green-400"}),e.jsx("span",{className:"text-green-400 font-medium",children:"Online"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Tipo Utente"}),e.jsx("span",{className:"text-purple-400 font-medium",children:"Dipendente"})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Informazioni Lavorative"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"ID Dipendente"}),e.jsx("span",{className:"text-white font-medium",children:b.id.slice(0,8)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Data Registrazione"}),e.jsx("span",{className:"text-white font-medium",children:new Date(b.created_at).toLocaleDateString("it-IT")})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Status"}),e.jsx("span",{className:`text-sm px-2 py-1 rounded-full ${b.status==="approved"?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"}`,children:b.status==="approved"?"Approvato":"In Attesa"})]})]})]}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("button",{onClick:W,className:"w-full bg-red-600 text-white py-4 px-4 rounded-xl hover:bg-red-700 font-bold text-lg shadow-lg flex items-center justify-center space-x-3",children:[e.jsx(va,{className:"h-6 w-6"}),e.jsx("span",{children:"ESCI DALL'APP"})]})}),e.jsx(Jr,{})]})})},cd=({report:n,onRectify:l})=>{const{assignment:c,timesheet:u,benefitBreakdown:f}=n,x=j=>{if(!j)return"Non specificato";if(/^\d{2}:\d{2}$/.test(j))return j;if(/^\d{2}:\d{2}:\d{2}$/.test(j))return j.substring(0,5);try{const M=new Date(j);if(!isNaN(M.getTime()))return M.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})}catch(M){console.error("Errore parsing timestamp:",M)}return j},b=j=>{switch(j){case"evento":return"Diaria Eventi";case"trasferta":return"Diaria Trasferta";default:return null}},v=(u==null?void 0:u.rectified_start_time)||(u==null?void 0:u.start_time),S=(u==null?void 0:u.rectified_end_time)||(u==null?void 0:u.end_time),g=u&&v&&S,E=f&&f.length>0?f.reduce((j,M)=>M.applied?j+M.amount:j,0):0,p=(u==null?void 0:u.total_benefits)||E,k=p>0||f&&f.some(j=>j.applied),P=c.bonus_previsti&&c.bonus_previsti>0,D=c.benefits_evento_nomi&&c.benefits_evento_nomi.length>0,R=!g&&!k&&(P||D||c.bonus_trasferta||c.bonus_diaria);return e.jsxs("div",{className:"bg-gray-700 rounded-xl p-4 border border-gray-600",children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx("h4",{className:"font-bold text-white",children:c.nome_evento}),(u==null?void 0:u.is_rectified)&&e.jsx("span",{className:"bg-orange-600 text-white text-xs px-2 py-0.5 rounded font-semibold",children:"Rettificato"})]}),e.jsx("p",{className:"text-sm text-blue-400",children:c.nome_azienda}),e.jsxs("p",{className:"text-xs text-gray-400",children:[new Date(c.giorno_inizio_evento).toLocaleDateString("it-IT"),c.giorno_inizio_evento!==c.giorno_fine_evento&&e.jsxs(e.Fragment,{children:[" - ",new Date(c.giorno_fine_evento).toLocaleDateString("it-IT")]})]})]})}),c.evento_orario_convocazione&&e.jsx("div",{className:"bg-green-900 bg-opacity-30 border-2 border-green-600 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(ht,{className:"h-5 w-5 text-green-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-green-200",children:"Orario Convocazione"}),e.jsx("div",{className:"text-xl font-bold text-green-400",children:x(c.evento_orario_convocazione)})]})]})}),(u==null?void 0:u.convocation_start_time)&&(u==null?void 0:u.convocation_end_time)&&e.jsxs("div",{className:"bg-cyan-900 bg-opacity-30 border border-cyan-600 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ht,{className:"h-4 w-4 text-cyan-400"}),e.jsx("h5",{className:"text-sm font-medium text-cyan-400",children:"Orari Convocazione"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Inizio:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(u.convocation_start_time)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Fine:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(u.convocation_end_time)})]})]})]}),g?e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 mb-3 border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ht,{className:"h-4 w-4 text-blue-400"}),e.jsx("h5",{className:"text-sm font-medium text-blue-400",children:"Orari Effettivi"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs mb-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Check-in:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(v)}),(u==null?void 0:u.is_rectified)&&(u==null?void 0:u.original_start_time)&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",x(u.original_start_time)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Check-out:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(S)}),(u==null?void 0:u.is_rectified)&&(u==null?void 0:u.original_end_time)&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",x(u.original_end_time)]}),(u==null?void 0:u.is_rectified)&&!u.original_end_time&&(u==null?void 0:u.rectified_end_time)&&e.jsxs("div",{className:"text-xs text-green-400 mt-1 flex items-center space-x-1",children:[e.jsx(pt,{className:"h-3 w-3"}),e.jsx("span",{children:"Aggiunto via rettifica"})]})]})]}),(u==null?void 0:u.total_hours)&&e.jsx("div",{className:"border-t border-gray-700 pt-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-gray-400",children:"Ore Totali:"}),e.jsxs("span",{className:"text-sm font-bold text-blue-400",children:[u.total_hours,"h"]})]})})]}):e.jsx("div",{className:"bg-gray-800 rounded-lg p-3 mb-3 border-l-4 border-gray-600",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-xs text-gray-400",children:u?"Turno in corso - Check-out non effettuato":"Nessun check-in registrato"})]})}),k&&e.jsxs("div",{className:"bg-green-900 bg-opacity-20 border border-green-700 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(js,{className:"h-4 w-4 text-green-400"}),e.jsx("h5",{className:"text-sm font-medium text-green-400",children:g?"Benefit Ricevuti":"Benefit Assegnati"})]}),e.jsxs("div",{className:"space-y-2",children:[(u==null?void 0:u.meal_voucher)&&(u==null?void 0:u.meal_voucher_amount)&&u.meal_voucher_amount>0&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{className:"h-4 w-4 text-yellow-400"}),e.jsx("span",{className:"text-sm text-gray-200",children:"Buono Pasto"})]}),e.jsxs("span",{className:"text-sm font-bold text-yellow-400",children:["‚Ç¨",u.meal_voucher_amount.toFixed(2)]})]}),(u==null?void 0:u.company_meal)&&(u==null?void 0:u.company_meal_cost)&&u.company_meal_cost>0&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{className:"h-4 w-4 text-orange-400"}),e.jsx("span",{className:"text-sm text-gray-200",children:"Pasto Aziendale"})]}),e.jsxs("span",{className:"text-sm font-bold text-orange-400",children:["‚Ç¨",u.company_meal_cost.toFixed(2)]})]}),(u==null?void 0:u.diaria_type)&&u.diaria_type!=="nessuna"&&(u==null?void 0:u.diaria_amount)&&u.diaria_amount>0&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ks,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-gray-200",children:b(u.diaria_type)})]}),e.jsxs("span",{className:"text-sm font-bold text-purple-400",children:["‚Ç¨",u.diaria_amount.toFixed(2)]})]}),f&&f.length>0&&f.map((j,M)=>{if(!j.applied)return null;const T=N=>{switch(N==null?void 0:N.toLowerCase()){case"trasferta":return ks;case"benefit":return js;case"rimborso":return Na;default:return Ar}},F=N=>{switch(N==null?void 0:N.toLowerCase()){case"trasferta":return"text-purple-400";case"benefit":return"text-green-400";case"rimborso":return"text-cyan-400";default:return"text-yellow-400"}},U=T(j.category),te=F(j.category);return e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(U,{className:`h-4 w-4 ${te}`}),e.jsx("span",{className:"text-sm text-gray-200",children:j.name})]}),e.jsxs("span",{className:`text-sm font-bold ${te}`,children:["‚Ç¨",j.amount.toFixed(2)]})]},M)}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-900 bg-opacity-30 border border-blue-700 rounded px-3 py-2 mt-3",children:[e.jsx("span",{className:"text-sm font-bold text-white",children:"Totale Benefit:"}),e.jsxs("span",{className:"text-lg font-bold text-blue-400",children:["‚Ç¨",p.toFixed(2)]})]})]})]}),R&&e.jsxs("div",{className:"bg-blue-900 bg-opacity-20 border border-blue-600 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(Ar,{className:"h-4 w-4 text-blue-400"}),e.jsx("h5",{className:"text-sm font-medium text-blue-400",children:"Bonus/Benefit Previsti"})]}),e.jsxs("div",{className:"space-y-1 text-xs",children:[c.tariffa_evento_assegnata&&e.jsxs("div",{className:"flex items-center justify-between text-gray-200",children:[e.jsx("span",{children:"Tariffa Base:"}),e.jsxs("span",{className:"font-semibold",children:["‚Ç¨",c.tariffa_evento_assegnata.toFixed(2)]})]}),P&&e.jsxs("div",{className:"flex items-center justify-between text-yellow-300",children:[e.jsx("span",{children:"Bonus Fisso:"}),e.jsxs("span",{className:"font-semibold",children:["‚Ç¨",c.bonus_previsti.toFixed(2)]})]}),c.bonus_trasferta&&e.jsx("div",{className:"flex items-center text-purple-300",children:e.jsx("span",{children:"Bonus Trasferta Previsto"})}),c.bonus_diaria&&e.jsx("div",{className:"flex items-center text-purple-300",children:e.jsx("span",{children:"Diaria Prevista"})}),D&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-blue-800",children:[e.jsx("div",{className:"text-blue-200 mb-1",children:"Altri benefit previsti:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:c.benefits_evento_nomi.map((j,M)=>e.jsx("span",{className:"bg-blue-800 text-blue-200 px-2 py-0.5 rounded text-xs",children:j},M))})]}),e.jsx("div",{className:"mt-2 pt-2 border-t border-blue-800 text-blue-200 text-center",children:"üí° Gli importi effettivi verranno calcolati al check-out"})]})]}),(u==null?void 0:u.is_rectified)&&u.rectification_notes&&e.jsx("div",{className:"bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-orange-200 mb-1",children:"Nota di Rettifica:"}),e.jsx("div",{className:"text-xs text-orange-300",children:u.rectification_notes})]})]})}),e.jsxs("div",{className:"space-y-2 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm text-white",children:c.evento_localita})]}),c.evento_trasferta&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ks,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-purple-300",children:"Evento con Trasferta"})]})]}),e.jsxs("button",{onClick:l,className:"w-full flex items-center justify-center space-x-2 px-4 py-2 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700 transition-colors border border-orange-500",children:[e.jsx(ci,{className:"h-4 w-4"}),e.jsx("span",{children:"RETTIFICA ORARIO"})]}),!g&&u&&e.jsx("div",{className:"mt-2 text-xs text-center text-gray-400",children:"I benefit verranno calcolati al check-out"})]})},dd=({event:n,existingTimesheet:l,onClose:c,onSuccess:u})=>{const{user:f}=Pt(),[x,b]=w.useState((l==null?void 0:l.start_time)||""),[v,S]=w.useState((l==null?void 0:l.end_time)||""),[g,E]=w.useState(""),[p,k]=w.useState(!1),[P,D]=w.useState(null),j=((T,F)=>{if(!T||!F)return 0;const[U,te]=T.split(":").map(Number),[N,_]=F.split(":").map(Number),V=U*60+te,K=N*60+_-V;return Math.max(0,K/60)})(x,v),M=async T=>{if(T.preventDefault(),!x||!v){D("Inserisci sia orario di check-in che di check-out");return}if(j<=0){D("L'orario di check-out deve essere successivo al check-in");return}if(!g||g.trim().length===0){D("La motivazione della rettifica √® obbligatoria");return}k(!0),D(null);try{if(l){const F={original_start_time:l.start_time,original_end_time:l.end_time,rectified_start_time:x,rectified_end_time:v,start_time:x,end_time:v,total_hours:j,is_rectified:!0,rectified_by:f==null?void 0:f.id,rectified_at:new Date().toISOString(),rectification_notes:g.trim()},{error:U}=await Se.from("timesheet_entries").update(F).eq("id",l.id);if(U)throw U}else{const F={crew_id:f==null?void 0:f.id,event_id:n.evento_id,date:n.giorno_inizio_evento,start_time:x,end_time:v,rectified_start_time:x,rectified_end_time:v,total_hours:j,status:"submitted",tracking_type:"hours",is_rectified:!0,rectified_by:f==null?void 0:f.id,rectified_at:new Date().toISOString(),rectification_notes:g.trim(),retention_percentage:0,gross_amount:0,net_amount:0},{error:U}=await Se.from("timesheet_entries").insert([F]);if(U)throw U}u(),c()}catch(F){console.error("Errore salvataggio rettifica:",F),D(F.message||"Errore durante il salvataggio")}finally{k(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl w-full max-w-md border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Rettifica Orario"}),e.jsx("p",{className:"text-sm text-gray-400",children:n.nome_evento})]}),e.jsx("button",{onClick:c,className:"text-gray-400 hover:text-white",children:e.jsx(Et,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:M,className:"p-4 space-y-4",children:[e.jsxs("div",{className:"bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3 flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-5 w-5 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsx("div",{className:"text-sm text-orange-200",children:"Questa operazione registra un orario rettificato manualmente. Verr√† segnalato come rettifica nel sistema."})]}),P&&e.jsx("div",{className:"bg-red-900 bg-opacity-30 border border-red-700 rounded-lg p-3 text-sm text-red-200",children:P}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Orario Check-in"}),e.jsxs("div",{className:"relative",children:[e.jsx(ht,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"time",value:x,onChange:T=>b(T.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Orario Check-out"}),e.jsxs("div",{className:"relative",children:[e.jsx(ht,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"time",value:v,onChange:T=>S(T.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]})]}),x&&v&&e.jsx("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-3",children:e.jsxs("div",{className:"text-sm text-blue-200",children:[e.jsx("span",{className:"font-medium",children:"Ore totali:"})," ",j.toFixed(2),"h"]})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Motivazione Rettifica ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("textarea",{value:g,onChange:T=>E(T.target.value),rows:3,className:"w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",placeholder:"Spiega il motivo della rettifica (es: dimenticato check-in, errore nell'orario, ecc...)",required:!0})]}),e.jsxs("div",{className:"flex space-x-3 pt-4",children:[e.jsx("button",{type:"button",onClick:c,className:"flex-1 py-2 px-4 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors",children:"Annulla"}),e.jsx("button",{type:"submit",disabled:p||!x||!v||!g.trim(),className:"flex-1 py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:p?"Salvataggio...":l?"Aggiorna":"Salva"})]})]})]})})},ud=({selectedMonth:n,selectedYear:l})=>{const{user:c}=Pt(),[u,f]=w.useState([]),[x,b]=w.useState([]),[v,S]=w.useState(""),[g,E]=w.useState("all"),[p,k]=w.useState([]),[P,D]=w.useState(!0),[R,j]=w.useState(null),[M,T]=w.useState(!1),[F,U]=w.useState(null),te=C=>String(C).padStart(2,"0"),N=C=>`${C.getFullYear()}-${te(C.getMonth()+1)}-${te(C.getDate())}`,_=C=>{if(!C)return new Date(NaN);const K=C.split("-").map(O=>parseInt(O,10));return K.length!==3?new Date(C):new Date(K[0],K[1]-1,K[2])};w.useEffect(()=>{c!=null&&c.id&&V()},[c==null?void 0:c.id,n,l]),w.useEffect(()=>{let C=[...u];v&&(C=C.filter(K=>K.assignment.giorno_inizio_evento<=v&&K.assignment.giorno_fine_evento>=v)),g!=="all"&&(C=C.filter(K=>K.assignment.nome_evento===g)),b(C)},[u,v,g]);const V=async()=>{try{D(!0),j(null);const C=new Date(l,n,1),K=new Date(l,n+1,0),O=N(C),X=N(K),{data:se,error:W}=await Se.from("crew_event_assegnazione").select("*").eq("dipendente_freelance_id",c==null?void 0:c.id).gte("giorno_inizio_evento",O).lte("giorno_inizio_evento",X).order("giorno_inizio_evento",{ascending:!0});if(W)throw W;const{data:G,error:B}=await Se.from("crew_assegnazionetariffa").select("tariffe_ids, tariffe_personalizzate").eq("dipendente_id",c==null?void 0:c.id).eq("attivo",!0);if(B)throw B;const ne={},ye={};if(G&&G.length>0){const L=[];if(G.forEach(re=>{re.tariffe_ids&&re.tariffe_ids.length>0&&L.push(...re.tariffe_ids),re.tariffe_personalizzate&&Object.assign(ye,re.tariffe_personalizzate)}),L.length>0){const{data:re,error:de}=await Se.from("crew_tariffe").select("*").in("id",L).eq("attivo",!0);if(de)throw de;re==null||re.forEach(oe=>{const ge=ye[oe.id];ne[oe.id]={id:oe.id,nome_tariffa:oe.nome_tariffa,categoria:oe.categoria,tipo_calcolo:oe.tipo_calcolo,importo:ge!==void 0?ge:oe.importo,attivo:oe.attivo}})}}const{data:me,error:Q}=await Se.from("timesheet_entries").select(`
          id,
          crew_id,
          event_id,
          date,
          start_time,
          end_time,
          total_hours,
          status,
          meal_voucher,
          meal_voucher_amount,
          company_meal,
          company_meal_cost,
          diaria_type,
          diaria_amount,
          other_benefits_amount,
          total_benefits,
          benefits_breakdown,
          is_rectified,
          rectification_notes,
          rectified_by,
          rectified_at,
          original_start_time,
          original_end_time,
          rectified_start_time,
          rectified_end_time,
          convocation_start_time,
          convocation_end_time
        `).eq("crew_id",c==null?void 0:c.id).gte("date",O).lte("date",X);if(Q)throw Q;const fe={};me==null||me.forEach(L=>{fe[L.event_id]=L});const be=[];for(const L of se||[]){const re=fe[L.evento_id],de=[],oe=[];let ge=0;if(re&&re.benefits_breakdown&&re.benefits_breakdown.length>0)re.benefits_breakdown.forEach(we=>{de.push({id:we.id,nome_tariffa:we.nome_tariffa,categoria:"benefit",importo:we.importo,applied:!0}),ge+=we.importo,oe.push({name:we.nome_tariffa,amount:we.importo,category:"benefit",applied:!0})});else{if(L.benefits_storicizzati&&L.benefits_storicizzati.length>0?L.benefits_storicizzati.forEach(we=>{de.push({id:we.id,nome_tariffa:we.nome_tariffa,categoria:"benefit",importo:we.importo,applied:!0}),ge+=we.importo,oe.push({name:we.nome_tariffa,amount:we.importo,category:"benefit",applied:!0})}):L.benefits_evento_ids&&L.benefits_evento_ids.length>0&&L.benefits_evento_ids.forEach(we=>{const je=ne[we];je?(de.push({id:je.id,nome_tariffa:je.nome_tariffa,categoria:je.categoria,importo:je.importo,applied:!0}),ge+=je.importo,oe.push({name:je.nome_tariffa,amount:je.importo,category:je.categoria,applied:!0})):oe.push({name:`Benefit ID: ${we}`,amount:0,category:"non_disponibile",applied:!1,reason:"Benefit non presente nel contratto del dipendente"})}),L.bonus_trasferta&&L.evento_trasferta){const we=Object.values(ne).find(je=>je.categoria==="indennita_trasferta"||je.nome_tariffa.toLowerCase().includes("trasferta"));we&&!de.find(je=>je.id===we.id)&&(de.push({id:we.id,nome_tariffa:we.nome_tariffa,categoria:we.categoria,importo:we.importo,applied:!0}),ge+=we.importo)}L.bonus_previsti&&L.bonus_previsti>0&&(ge+=L.bonus_previsti,oe.push({name:"Bonus Evento Fisso",amount:L.bonus_previsti,category:"bonus_evento",applied:!0}))}const Te=(L.tariffa_evento_assegnata||0)+ge;be.push({assignment:L,timesheet:re?{id:re.id,start_time:re.start_time,end_time:re.end_time,status:re.status,total_hours:re.total_hours,meal_voucher:re.meal_voucher,meal_voucher_amount:re.meal_voucher_amount,company_meal:re.company_meal,company_meal_cost:re.company_meal_cost,diaria_type:re.diaria_type,diaria_amount:re.diaria_amount,other_benefits_amount:re.other_benefits_amount,total_benefits:re.total_benefits,is_rectified:re.is_rectified,rectification_notes:re.rectification_notes,original_start_time:re.original_start_time,original_end_time:re.original_end_time,rectified_start_time:re.rectified_start_time,rectified_end_time:re.rectified_end_time,convocation_start_time:re.convocation_start_time,convocation_end_time:re.convocation_end_time}:void 0,applicableBenefits:de,totalBenefitsAmount:ge,totalEventAmount:Te,benefitBreakdown:oe})}f(be);const Z=new Set;be.forEach(L=>{L.assignment.nome_evento&&Z.add(L.assignment.nome_evento)}),k(Array.from(Z).sort())}catch(C){console.error("Errore caricamento eventi:",C),j(C instanceof Error?C.message:"Errore sconosciuto")}finally{D(!1)}};return P?e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"Caricamento eventi..."})]})}):R?e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"text-center py-8 text-red-400",children:[e.jsx(Zt,{className:"h-12 w-12 mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Errore nel caricamento"}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:R}),e.jsx("button",{onClick:()=>V(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Riprova"})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Dettaglio Eventi (",x.length,u.length!==x.length?` di ${u.length}`:"",")"]}),e.jsxs("div",{className:"mb-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Giorno Specifico:"}),e.jsx("input",{type:"date",value:v,onChange:C=>S(C.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",placeholder:"Seleziona un giorno..."}),v&&e.jsx("button",{onClick:()=>S(""),className:"mt-2 text-xs text-blue-400 hover:text-blue-300",children:"Rimuovi filtro data"})]}),p.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Nome Evento:"}),e.jsxs("select",{value:g,onChange:C=>E(C.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",children:[e.jsx("option",{value:"all",children:"Tutti gli Eventi"}),p.map((C,K)=>e.jsx("option",{value:C,children:C},K))]})]}),(v||g!=="all")&&e.jsxs("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-2 text-xs text-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(xt,{className:"h-3 w-3"}),e.jsx("span",{className:"font-semibold",children:"Filtri attivi:"})]}),e.jsxs("div",{className:"mt-1 space-y-1",children:[v&&(()=>{const C=_(v);return e.jsxs("div",{children:["Data: ",isNaN(C.getTime())?v:C.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"})]})})(),g!=="all"&&e.jsxs("div",{children:["Evento: ",g]})]})]})]}),x.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(xt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsxs("p",{children:["Nessun evento ",v||g!=="all"?"trovato con i filtri selezionati":"nel periodo selezionato"]}),e.jsx("p",{className:"text-sm mt-1",children:v||g!=="all"?"Prova a modificare i filtri":"Seleziona un mese diverso o attendi nuove assegnazioni"})]}):e.jsx("div",{className:"space-y-4",children:x.map(C=>e.jsx(cd,{report:{...C,benefitBreakdown:C.benefitBreakdown},onRectify:()=>{U(C),T(!0)}},C.assignment.id))})]}),M&&F&&e.jsx(dd,{event:{id:F.assignment.id,evento_id:F.assignment.evento_id,nome_evento:F.assignment.nome_evento,giorno_inizio_evento:F.assignment.giorno_inizio_evento,giorno_fine_evento:F.assignment.giorno_fine_evento},existingTimesheet:F.timesheet,onClose:()=>{T(!1),U(null)},onSuccess:()=>{V()}})]})},Pi=({shift:n,onUpdate:l,tableName:c})=>{const{user:u}=Pt(),{showSuccess:f,showError:x}=ms(),[b,v]=w.useState(!1),[S,g]=w.useState(""),[E,p]=w.useState(""),[k,P]=w.useState(""),[D,R]=w.useState(""),[j,M]=w.useState(""),[T,F]=w.useState(""),[U,te]=w.useState(""),[N,_]=w.useState(!1),[V,C]=w.useState(null),[K,O]=w.useState(!1),[X,se]=w.useState(!1),[W,G]=w.useState(!0),[B,ne]=w.useState(null),ye=(L,re,de,oe,ge,ve)=>{if(!L||!re)return 0;const[Te,we]=L.split(":").map(Number),[je,Fe]=re.split(":").map(Number),Ve=Te*60+we;let st=(je*60+Fe-Ve)/60;if(de&&oe){const[Je,Qe]=de.split(":").map(Number),[We,gt]=oe.split(":").map(Number),qe=Je*60+Qe,H=(We*60+gt-qe)/60;H>0&&(st-=H)}if(ge&&ve){const[Je,Qe]=ge.split(":").map(Number),[We,gt]=ve.split(":").map(Number),qe=Je*60+Qe,H=(We*60+gt-qe)/60;H>0&&(st-=H)}return st},me=c?c==="extra_shifts_checkins":!n.turno_id||n.turno_id===""||n.nome_turno==="TURNO EXTRA";w.useEffect(()=>{const L=async()=>{try{if(me){const{data:re,error:de}=await Se.from("extra_shifts_checkins").select("*").eq("id",n.id).maybeSingle();if(de)throw de;if(re){ne(re);const oe=re.rectified_check_in_time||re.check_in_time,ge=re.rectified_check_out_time||re.check_out_time,ve=re.rectified_break_start||re.break_start_time,Te=re.rectified_break_end||re.break_end_time,we=re.rectified_pausa_cena_inizio||re.pausa_cena_inizio,je=re.rectified_pausa_cena_fine||re.pausa_cena_fine;g(rr(oe)),p(rr(ge)),P(ve||""),R(Te||""),M(we||""),F(je||""),te(re.rectification_note||"")}}else{const{data:re,error:de}=await Se.from("warehouse_checkins_enriched").select("*").eq("id",n.id).maybeSingle();if(de)throw de;if(re){ne(re);const oe=re.rectified_check_in_time||re.check_in_time,ge=re.rectified_check_out_time||re.check_out_time,ve=re.rectified_break_start||re.break_start_time||re.break_start,Te=re.rectified_break_end||re.break_end_time||re.break_end,we=re.rectified_pausa_cena_inizio||re.pausa_cena_inizio,je=re.rectified_pausa_cena_fine||re.pausa_cena_fine;g(rr(oe)),p(rr(ge)),P(ve||""),R(Te||""),M(we||""),F(je||""),te(re.rectification_note||"")}}}catch(re){console.error("Errore caricamento dati turno:",re)}};b&&n.id&&L()},[b,n.id,me]),w.useEffect(()=>{G(!0)},[]),w.useEffect(()=>{if(S&&E){const L=ye(S,E,k,D,j,T),re=n.ore_previste||8;L>re?O(!0):(O(!1),se(!1))}},[S,E,k,D,j,T,n.ore_previste]);const Q=async()=>{if(console.log("üîç Inizio salvataggio rettifica..."),console.log("üìù Dati da salvare:",{editedCheckIn:S,editedCheckOut:E,breakStart:k,breakEnd:D,breakCenaStart:j,breakCenaEnd:T,rectificationNote:U,requestOvertime:X,shiftId:n.id}),!S||!E){C("Inserisci orari validi");return}if(!U||U.trim().length<10){C("La nota di rettifica √® obbligatoria (minimo 10 caratteri)");return}if(k&&!D||!k&&D){C("Specifica sia l'inizio che la fine della pausa pranzo");return}if(k&&D){const[re,de]=k.split(":").map(Number),[oe,ge]=D.split(":").map(Number);if(oe*60+ge<=re*60+de){C("La fine della pausa pranzo deve essere dopo l'inizio");return}}if(j&&!T||!j&&T){C("Specifica sia l'inizio che la fine della pausa cena");return}if(j&&T){const[re,de]=j.split(":").map(Number),[oe,ge]=T.split(":").map(Number);if(oe*60+ge<=re*60+de){C("La fine della pausa cena deve essere dopo l'inizio");return}}const L=ye(S,E,k,D,j,T);if(L<=0){C("Le pause non possono coprire tutto il tempo di lavoro. Le ore effettive devono essere maggiori di zero.");return}_(!0),C(null);try{const re=new Date().toISOString(),de={rectified_check_in_time:S,rectified_check_out_time:E,rectified_break_start:k||null,rectified_break_end:D||null,rectified_pausa_pranzo:!!(k&&D),rectified_pausa_pranzo_inizio:k||null,rectified_pausa_pranzo_fine:D||null,rectified_pausa_cena_inizio:j||null,rectified_pausa_cena_fine:T||null,rectified_total_hours:L,rectification_note:U.trim(),rectified_by:u==null?void 0:u.id,rectified_at:re,overtime_requested:X,total_hours:L,status:"completed"};(!n.check_out_turno||n.status!=="completed")&&(de.check_out_time=E);const oe=me?"extra_shifts_checkins":"warehouse_checkins";console.log("üíæ Invio update a Supabase:",{tableName:oe,shiftId:n.id,updateData:de});const{error:ge}=await Se.from(oe).update(de).eq("id",n.id);if(console.log("‚úÖ Risposta Supabase:",{error:ge}),ge)throw console.error("‚ùå Errore Supabase:",ge),ge;f("Rettifica salvata con successo!"),v(!1),l()}catch(re){console.error("‚ùå Errore aggiornamento turno:",re);const de=re.message||"Errore nel salvataggio delle modifiche";C(de),x(de)}finally{_(!1)}},fe=()=>{var L,re;g(((L=n.check_in_turno)==null?void 0:L.substring(0,5))||""),p(((re=n.check_out_turno)==null?void 0:re.substring(0,5))||""),P(""),R(""),M(""),F(""),te(""),se(!1),O(!1),C(null),v(!1)};if(!b)return e.jsxs("button",{onClick:()=>v(!0),className:"w-full mt-2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center space-x-2",children:[e.jsx(ir,{className:"h-4 w-4"}),e.jsx("span",{children:"Rettifica Orari Turno"})]});const Z=(()=>{const L=B&&B.notes||n.notes||"",re=B&&B.warehouse_name||n.warehouse_name||n.nome_turno||"",de=B&&B.noteturno||n.noteturno||"";if(typeof L=="string"&&L.toLowerCase().includes("turno extra"))return{label:"TURNO EXTRA",isExtra:!0,subtitle:""};const oe=[];return re&&oe.push(re),de&&oe.push(de),{label:"TURNO MAGAZZINO",isExtra:!1,subtitle:oe.join(" ‚Ä¢ ")}})();return e.jsxs("div",{className:"mt-3 bg-gray-800 border border-gray-600 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-sm font-semibold text-white mb-3 flex items-center space-x-2",children:[e.jsx(ir,{className:"h-4 w-4"}),e.jsx("span",{children:"Rettifica Orari"})]}),e.jsx("div",{className:"mb-3",children:Z.isExtra?e.jsx("div",{className:"inline-flex items-center px-3 py-1 rounded-full bg-indigo-700 text-white text-xs font-semibold",children:"TURNO EXTRA"}):e.jsxs("div",{className:"inline-flex flex-col px-3 py-2 rounded-lg bg-gray-700 text-white text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Turno di Magazzino"}),Z.subtitle?e.jsx("span",{className:"text-xs text-gray-300 mt-1",children:Z.subtitle}):null]})}),(!n.original_check_out||n.status!=="completed")&&e.jsx("div",{className:"mb-4 bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Nt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-orange-200 mb-1",children:"Turno Ancora Aperto"}),e.jsx("div",{className:"text-xs text-orange-300",children:"Il checkout non √® stato effettuato. Compilando questa rettifica il turno verr√† automaticamente chiuso."})]})]})}),n.original_check_in&&e.jsxs("div",{className:"mb-4 bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-2",children:"Dati Originali Registrati:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-300",children:"Check-in:"}),e.jsx("div",{className:"text-white font-semibold",children:rr(n.original_check_in)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-300",children:"Check-out:"}),e.jsx("div",{className:"text-white font-semibold",children:n.original_check_out?e.jsxs(e.Fragment,{children:[rr(n.original_check_out),n.auto_checkout&&e.jsx("span",{className:"ml-1 text-xs bg-purple-800 text-purple-200 px-1 py-0.5 rounded",children:"AUTO"})]}):e.jsx("span",{className:"text-orange-400 italic",children:"Non effettuato"})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-blue-300",children:"Pausa Pranzo:"}),e.jsx("span",{className:"ml-2 text-white font-semibold",children:n.original_pausa_pranzo?"S√¨ ‚úì":"No ‚úó"})]})]})]}),V&&e.jsxs("div",{className:"mb-3 bg-red-900 border border-red-700 rounded-lg p-2 flex items-start space-x-2",children:[e.jsx(Nt,{className:"h-4 w-4 text-red-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"text-xs text-red-200",children:V})]}),e.jsxs("div",{className:"space-y-3 mb-3",children:[e.jsxs("div",{className:"bg-green-900 bg-opacity-20 border border-green-700 rounded-lg p-3 mb-3",children:[e.jsx("div",{className:"text-xs font-semibold text-green-200 mb-3",children:"Nuovi Orari Rettificati:"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-1",children:["Orario Entrata ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"time",value:S,onChange:L=>g(L.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-1",children:["Orario Uscita ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"time",value:E,onChange:L=>p(L.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"})]})]})]}),e.jsxs("div",{className:"border-t border-gray-600 pt-3 mt-3",children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-2 flex items-center space-x-2",children:[e.jsx(Cs,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{children:"Pausa Pranzo (opzionale):"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Inizio Pausa"}),e.jsx("input",{type:"time",value:k,onChange:L=>P(L.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Fine Pausa"}),e.jsx("input",{type:"time",value:D,onChange:L=>R(L.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"‚ÑπÔ∏è Lascia vuoto se non hai effettuato pausa pranzo"})]}),e.jsxs("div",{className:"border-t border-gray-600 pt-3 mt-3",children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-2 flex items-center space-x-2",children:[e.jsx(Cs,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{children:"Pausa Cena (opzionale):"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Inizio Pausa"}),e.jsx("input",{type:"time",value:j,onChange:L=>M(L.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Fine Pausa"}),e.jsx("input",{type:"time",value:T,onChange:L=>F(L.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"‚ÑπÔ∏è Lascia vuoto se non hai effettuato pausa cena"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-1",children:["Nota Rettifica ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("textarea",{value:U,onChange:L=>te(L.target.value),placeholder:"Specifica il motivo della rettifica (obbligatorio, min 10 caratteri)...",rows:3,className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[U.length,"/10 caratteri minimi"]})]}),S&&E&&e.jsxs("div",{className:"space-y-2",children:[K&&W&&e.jsx("div",{className:"bg-orange-900 border border-orange-700 rounded p-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Nt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-xs font-semibold text-orange-200 mb-2",children:["Le ore superano il turno previsto (",n.ore_previste||8,"h)"]}),e.jsxs("label",{className:"flex items-center space-x-2 text-xs text-orange-300",children:[e.jsx("input",{type:"checkbox",checked:X,onChange:L=>se(L.target.checked),className:"rounded border-orange-600 bg-orange-800 text-orange-500 focus:ring-orange-500"}),e.jsx("span",{children:"Richiedi straordinari per le ore eccedenti"})]})]})]})}),e.jsxs("div",{className:"bg-blue-900 border border-blue-700 rounded p-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs mb-1",children:[e.jsx("span",{className:"text-blue-200",children:"Nuove ore totali:"}),e.jsxs("span",{className:"font-bold text-blue-100 text-lg",children:[ye(S,E,k,D,j,T).toFixed(2),"h"]})]}),k&&D||j&&T?e.jsxs("div",{className:"text-xs text-blue-300 mt-1 space-y-0.5",children:[k&&D&&e.jsxs("div",{children:["Pausa pranzo: ",k," - ",D]}),j&&T&&e.jsxs("div",{children:["Pausa cena: ",j," - ",T]})]}):null]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("button",{type:"button",onClick:()=>se(!X),disabled:!W,className:`w-full py-3 rounded-lg font-semibold transition-all ${W?X?"bg-orange-600 text-white hover:bg-orange-700":"bg-gray-700 text-gray-300 hover:bg-gray-600 border border-gray-600":"bg-gray-800 text-gray-500 border border-gray-700 cursor-not-allowed"}`,children:W?X?e.jsxs("span",{className:"flex items-center justify-center space-x-2",children:[e.jsx(Nt,{className:"h-4 w-4"}),e.jsx("span",{children:"Straordinari Richiesti"})]}):e.jsx("span",{children:"Richiedi Straordinari"}):e.jsx("span",{children:"Straordinari Non Previsti nel Contratto"})}),!W&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 text-center",children:"Il tuo contratto non prevede il pagamento degli straordinari"})]})]}),e.jsxs("div",{className:"flex space-x-2 mt-4",children:[e.jsxs("button",{onClick:fe,disabled:N,className:"flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-500 disabled:opacity-50 flex items-center justify-center space-x-1",children:[e.jsx(Et,{className:"h-4 w-4"}),e.jsx("span",{children:"Annulla"})]}),e.jsx("button",{onClick:Q,disabled:N,className:"flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 flex items-center justify-center space-x-1",children:N?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Salvataggio..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Gr,{className:"h-4 w-4"}),e.jsx("span",{children:"Salva"})]})})]})]})},hd=({selectedMonth:n,selectedYear:l})=>{var N;const{user:c}=Pt(),[u,f]=w.useState([]),[x,b]=w.useState([]),[v,S]=w.useState([]),[g,E]=w.useState(""),[p,k]=w.useState("all"),[P,D]=w.useState(!0),[R,j]=w.useState(null),M=_=>String(_).padStart(2,"0"),T=_=>`${_.getFullYear()}-${M(_.getMonth()+1)}-${M(_.getDate())}`,F=_=>{if(!_)return new Date(NaN);const V=_.split("-").map(C=>parseInt(C,10));return V.length!==3?new Date(_):new Date(V[0],V[1]-1,V[2])};w.useEffect(()=>{c!=null&&c.id&&U()},[c==null?void 0:c.id,n,l]),w.useEffect(()=>{let _=[...u];g&&(_=_.filter(V=>V.giorno_turno===g)),p!=="all"&&(_=_.filter(V=>V.warehouse_id===p)),S(_)},[u,g,p]);const U=async()=>{try{D(!0),j(null);const _=new Date(l,n,1),V=new Date(l,n+1,0),C=T(_),K=T(V),{data:O,error:X}=await Se.from("warehouse_checkins").select("*").eq("crew_id",c==null?void 0:c.id).gte("date",C).lte("date",K).order("date",{ascending:!1});if(X)throw X;const se=(O||[]).map(B=>{const ne=B.rectified_check_in_time||B.check_in_time,ye=B.rectified_check_out_time||B.check_out_time,me=B.effective_ore_lavorate_minuti?B.effective_ore_lavorate_minuti/60:B.rectified_total_hours||parseFloat(B.total_hours)||0,Q=B.rectified_pausa_pranzo!==null?B.rectified_pausa_pranzo:B.pausa_pranzo||!1;return{id:B.id,turno_id:B.turno_id||"",warehouse_id:B.warehouse_id||"",warehouse_name:"Turno Magazzino",notes:B.notes||"",noteturno:"",giorno_turno:B.date,nome_turno:"Turno Magazzino",check_in_turno:ne,check_out_turno:ye,conteggio_ore:me,buoni_pasto_assegnato:B.meal_voucher||!1,pasto_aziendale_usufruito:B.company_meal||!1,ore_straordinario:parseFloat(B.overtime_hours)||0,ore_previste:8,pausa_pranzo:Q,pausa_cena:!!(B.pausa_cena_inizio&&B.pausa_cena_fine),pausa_pranzo_inizio:B.pausa_pranzo_inizio||B.break_start_time,pausa_pranzo_fine:B.pausa_pranzo_fine||B.break_end_time,pausa_pranzo_minuti:B.pausa_pranzo_minuti||B.break_minutes,pausa_cena_inizio:B.pausa_cena_inizio,pausa_cena_fine:B.pausa_cena_fine,pausa_cena_minuti:B.pausa_cena_minuti,pausa_totale_minuti:B.pausa_totale_minuti||B.break_minutes,status:B.status,is_rectified:!!B.rectified_at,rectification_note:B.rectification_note||null,original_check_in:B.check_in_time,original_check_out:B.check_out_time,original_pausa_pranzo:B.pausa_pranzo||!1,rectified_check_in:B.rectified_check_in_time,rectified_check_out:B.rectified_check_out_time,rectified_pausa_pranzo:B.rectified_pausa_pranzo,rectified_pausa_pranzo_inizio:B.rectified_pausa_pranzo_inizio,rectified_pausa_pranzo_fine:B.rectified_pausa_pranzo_fine,rectified_pausa_cena_inizio:B.rectified_pausa_cena_inizio,rectified_pausa_cena_fine:B.rectified_pausa_cena_fine,effective_pausa_pranzo_inizio:B.effective_pausa_pranzo_inizio,effective_pausa_pranzo_fine:B.effective_pausa_pranzo_fine,effective_pausa_pranzo_minuti:B.effective_pausa_pranzo_minuti,effective_pausa_cena_inizio:B.effective_pausa_cena_inizio,effective_pausa_cena_fine:B.effective_pausa_cena_fine,effective_pausa_cena_minuti:B.effective_pausa_cena_minuti,effective_pausa_totale_minuti:B.effective_pausa_totale_minuti,effective_ore_lavorate_minuti:B.effective_ore_lavorate_minuti,auto_checkout:B.auto_checkout||!1}});f(se);const{data:W,error:G}=await Se.from("warehouse_checkins_enriched").select("warehouse_id, warehouse_name").eq("crew_id",c==null?void 0:c.id).not("warehouse_id","is",null);if(!G&&W){const B=new Map;W.forEach((ye,me)=>{const Q=ye.warehouse_id,fe=ye.warehouse_name||`Magazzino ${me+1}`;Q&&!B.has(Q)&&B.set(Q,fe)});const ne=Array.from(B.entries()).map(([ye,me])=>({id:ye,name:me}));b(ne)}}catch(_){console.error("Errore caricamento turni magazzino:",_),j(_ instanceof Error?_.message:"Errore sconosciuto")}finally{D(!1)}},te=_=>_&&rr(_)||"Non specificato";return P?e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"Caricamento turni magazzino..."})]})}):R?e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"text-center py-8 text-red-400",children:[e.jsx(Zt,{className:"h-12 w-12 mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Errore nel caricamento"}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:R}),e.jsx("button",{onClick:()=>U(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Riprova"})]})}):e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Turni Magazzino (",v.length,u.length!==v.length?` di ${u.length}`:"",")"]}),e.jsxs("div",{className:"mb-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Giorno Specifico:"}),e.jsx("input",{type:"date",value:g,onChange:_=>E(_.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",placeholder:"Seleziona un giorno..."}),g&&e.jsx("button",{onClick:()=>E(""),className:"mt-2 text-xs text-blue-400 hover:text-blue-300",children:"Rimuovi filtro data"})]}),x.length>1&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Magazzino:"}),e.jsxs("select",{value:p,onChange:_=>k(_.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",children:[e.jsx("option",{value:"all",children:"Tutti i Magazzini"}),x.map(_=>e.jsx("option",{value:_.id,children:_.name},_.id))]})]}),(g||p!=="all")&&e.jsxs("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-2 text-xs text-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ga,{className:"h-3 w-3"}),e.jsx("span",{className:"font-semibold",children:"Filtri attivi:"})]}),e.jsxs("div",{className:"mt-1 space-y-1",children:[g&&e.jsxs("div",{children:["Data: ",F(g).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"})]}),p!=="all"&&e.jsxs("div",{children:["Magazzino: ",(N=x.find(_=>_.id===p))==null?void 0:N.name]})]})]})]}),v.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Rt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsxs("p",{children:["Nessun turno magazzino ",g||p!=="all"?"trovato con i filtri selezionati":"nel periodo selezionato"]}),e.jsx("p",{className:"text-sm mt-1",children:g||p!=="all"?"Prova a modificare i filtri":"I turni appariranno qui"})]}):e.jsx("div",{className:"space-y-3",children:v.map(_=>{const V=_.check_out_turno||_.rectified_check_out,C=_.status!=="completed"||!V;return e.jsxs("div",{className:"bg-gray-700 rounded-lg p-4 border border-gray-600",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h4",{className:"font-bold text-white",children:_.nome_turno||"Turno Magazzino"}),_.is_rectified&&e.jsx("span",{className:"bg-orange-600 text-white text-xs px-2 py-0.5 rounded font-semibold",children:"Rettificato"})]}),e.jsx("p",{className:"text-sm text-gray-400",children:F(_.giorno_turno).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})})]}),e.jsx("div",{className:"text-right",children:C?e.jsx("div",{className:"text-sm text-orange-400 font-semibold",children:"In corso"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-lg font-bold text-blue-400",children:[_.effective_ore_lavorate_minuti?Math.floor(_.effective_ore_lavorate_minuti/60):_.conteggio_ore,"h"]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Ore Lavorate"})]})})]}),e.jsx("div",{className:"bg-gray-800 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[e.jsx(ht,{className:"h-3 w-3 text-green-400"}),e.jsx("span",{className:"text-gray-400 font-medium",children:"Check-in:"})]}),e.jsx("div",{className:"text-white font-semibold",children:te(_.check_in_turno)||"--:--"}),_.is_rectified&&_.original_check_in&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",te(_.original_check_in)]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[e.jsx(ht,{className:"h-3 w-3 text-red-400"}),e.jsx("span",{className:"text-gray-400 font-medium",children:"Check-out:"})]}),C?e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-orange-400 font-semibold",children:"In corso"}),_.is_rectified&&_.rectified_check_out&&e.jsxs("div",{className:"text-green-400 text-xs mt-1 flex items-center space-x-1",children:[e.jsx(pt,{className:"h-3 w-3"}),e.jsxs("span",{children:["Chiuso via rettifica: ",te(_.rectified_check_out)]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-white font-semibold flex items-center space-x-1 flex-wrap",children:[e.jsx("span",{children:te(_.check_out_turno)||"--:--"}),_.auto_checkout&&e.jsx("span",{className:"text-xs bg-purple-900 text-purple-200 px-1 py-0.5 rounded",title:"Checkout automatico",children:"AUTO"}),_.is_rectified&&_.rectified_check_out&&!_.original_check_out&&e.jsx("span",{className:"text-xs bg-green-900 text-green-200 px-1 py-0.5 rounded",title:"Chiuso via rettifica",children:"RETTIFICA"})]}),_.is_rectified&&_.original_check_out&&_.rectified_check_out&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",te(_.original_check_out),_.auto_checkout&&e.jsx("span",{className:"ml-1",children:"(AUTO)"})]}),_.is_rectified&&!_.original_check_out&&_.rectified_check_out&&e.jsx("div",{className:"text-gray-500 text-xs mt-1 italic",children:"(Non era stato effettuato)"})]})]})]})}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 mb-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm text-gray-300",children:"Pausa Pranzo:"})]}),e.jsxs("div",{className:"text-right",children:[_.pausa_pranzo?e.jsxs("div",{children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"S√¨"}),(()=>{const K=_.effective_pausa_pranzo_inizio||_.rectified_pausa_pranzo_inizio||_.pausa_pranzo_inizio,O=_.effective_pausa_pranzo_fine||_.rectified_pausa_pranzo_fine||_.pausa_pranzo_fine,X=_.effective_pausa_pranzo_minuti;return K&&O&&X?e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[K.substring(0,5)," - ",O.substring(0,5)," (",X," min)"]}):null})()]}):e.jsx("span",{className:"text-gray-500",children:"No"}),_.is_rectified&&_.original_pausa_pranzo!==_.pausa_pranzo&&e.jsxs("div",{className:"text-xs text-gray-500 line-through mt-1",children:["Era: ",_.original_pausa_pranzo?"S√¨":"No"]})]})]}),(_.pausa_cena||_.rectified_pausa_cena_inizio||_.pausa_cena_inizio)&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-700",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ls,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-gray-300",children:"Pausa Cena:"})]}),e.jsxs("div",{className:"text-right",children:[_.pausa_cena||_.rectified_pausa_cena_inizio||_.pausa_cena_inizio?e.jsxs("div",{children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"S√¨"}),(()=>{const K=_.effective_pausa_cena_inizio||_.rectified_pausa_cena_inizio||_.pausa_cena_inizio,O=_.effective_pausa_cena_fine||_.rectified_pausa_cena_fine||_.pausa_cena_fine,X=_.effective_pausa_cena_minuti;return K&&O&&X?e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[K.substring(0,5)," - ",O.substring(0,5)," (",X," min)"]}):null})()]}):e.jsx("span",{className:"text-gray-500",children:"No"}),_.is_rectified&&_.rectified_pausa_cena_inizio&&!_.pausa_cena_inizio&&e.jsx("div",{className:"text-xs text-gray-500 line-through mt-1",children:"Era: No"})]})]}),_.effective_pausa_totale_minuti>0&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-700",children:[e.jsx("span",{className:"text-xs text-gray-400",children:"Totale Pause:"}),e.jsxs("span",{className:"text-xs text-gray-300 font-semibold",children:[_.effective_pausa_totale_minuti," minuti"]})]}),_.effective_ore_lavorate_minuti>0&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-700",children:[e.jsx("span",{className:"text-xs text-gray-400",children:"Ore Effettive:"}),e.jsxs("span",{className:"text-xs text-green-400 font-semibold",children:[Math.floor(_.effective_ore_lavorate_minuti/60),"h ",_.effective_ore_lavorate_minuti%60,"min"]})]})]}),(_.notes||_.noteturno)&&e.jsx("div",{className:"bg-blue-900 bg-opacity-20 border border-blue-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(qt,{className:"h-4 w-4 text-blue-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-1",children:"Note:"}),e.jsx("div",{className:"text-xs text-blue-100",children:_.notes||_.noteturno})]})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs mb-2",children:[_.buoni_pasto_assegnato&&e.jsxs("span",{className:"bg-yellow-900 text-yellow-200 px-2 py-1 rounded flex items-center space-x-1",children:[e.jsx(js,{className:"h-3 w-3"}),e.jsx("span",{children:"Buono Pasto"})]}),_.pasto_aziendale_usufruito&&e.jsxs("span",{className:"bg-orange-900 text-orange-200 px-2 py-1 rounded flex items-center space-x-1",children:[e.jsx(Ls,{className:"h-3 w-3"}),e.jsx("span",{children:"Pasto Aziendale"})]})]}),_.is_rectified&&_.rectification_note&&e.jsx("div",{className:"bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-orange-200 mb-1",children:"Nota di Rettifica:"}),e.jsx("div",{className:"text-xs text-orange-300",children:_.rectification_note})]})]})}),e.jsx(Pi,{shift:_,onUpdate:U,tableName:"warehouse_checkins"})]},_.id)})})]})},xd=n=>{const l=Math.floor(n/60),c=n%60;return{hours:l,minutes:c}},Sr=n=>{const{hours:l,minutes:c}=xd(n);return`${l}h ${c}min`},md=(n,l=480,c)=>{const u=n-l;if(u<=0)return 0;const f=u/60*c;return Math.round(f*100)/100},fd=(n,l=480,c)=>{const u=n-l,f=md(n,l,c);return{actualWorkedMinutes:n,actualWorkedFormatted:Sr(n),expectedWarehouseMinutes:l,expectedWarehouseFormatted:Sr(l),extraMinutes:Math.max(0,u),extraMinutesFormatted:u>0?Sr(u):"0h 0min",hourlyRate:c,benefit:f,hasBenefit:u>0}},gd=({selectedMonth:n,selectedYear:l})=>{const{user:c}=Pt(),[u,f]=w.useState([]),[x,b]=w.useState([]),[v,S]=w.useState(""),[g,E]=w.useState("all"),[p,k]=w.useState([]),[P,D]=w.useState(!0),[R,j]=w.useState(null),M=N=>String(N).padStart(2,"0"),T=N=>`${N.getFullYear()}-${M(N.getMonth()+1)}-${M(N.getDate())}`,F=N=>{if(!N)return new Date(NaN);const _=N.split("-").map(V=>parseInt(V,10));return _.length!==3?new Date(N):new Date(_[0],_[1]-1,_[2])};w.useEffect(()=>{c!=null&&c.id&&U()},[c==null?void 0:c.id,n,l]),w.useEffect(()=>{let N=[...u];v&&(N=N.filter(_=>_.giorno_turno===v)),g!=="all"&&(N=N.filter(_=>(_.notes||"").includes(g))),b(N)},[u,v,g]);const U=async()=>{try{D(!0),j(null);const N=new Date(l,n,1),_=new Date(l,n+1,0),V=T(N),C=T(_),{data:K,error:O}=await Se.from("extra_shifts_checkins").select("*").eq("crew_id",c==null?void 0:c.id).gte("date",V).lte("date",C).order("date",{ascending:!1});if(O)throw O;const X=(K||[]).map(W=>{const G=W.rectified_check_in_time||W.check_in_time,B=W.rectified_check_out_time||W.check_out_time,ne=W.rectified_pausa_pranzo!==null?W.rectified_pausa_pranzo:W.has_taken_break||!1;return{id:W.id,turno_id:"",warehouse_id:"",warehouse_name:"TURNO EXTRA",notes:W.notes||"",noteturno:W.NoteTurno||"",giorno_turno:W.date,nome_turno:"TURNO EXTRA",check_in_turno:G,check_out_turno:B,conteggio_ore:W.effective_ore_lavorate_minuti||0,buoni_pasto_assegnato:W.meal_voucher||!1,pasto_aziendale_usufruito:W.company_meal||!1,ore_straordinario:0,ore_previste:480,pausa_pranzo:ne,pausa_cena:!!(W.pausa_cena_inizio&&W.pausa_cena_fine),pausa_pranzo_inizio:W.pausa_pranzo_inizio||W.break_start_time,pausa_pranzo_fine:W.pausa_pranzo_fine||W.break_end_time,pausa_pranzo_minuti:W.pausa_pranzo_minuti||W.break_minutes,pausa_cena_inizio:W.pausa_cena_inizio,pausa_cena_fine:W.pausa_cena_fine,pausa_cena_minuti:W.pausa_cena_minuti,pausa_totale_minuti:W.pausa_totale_minuti,status:W.status,is_rectified:!!W.rectified_at,rectification_note:W.rectification_note||null,original_check_in:W.check_in_time,original_check_out:W.check_out_time,original_pausa_pranzo:W.has_taken_break||!1,rectified_check_in:W.rectified_check_in_time,rectified_check_out:W.rectified_check_out_time,rectified_pausa_pranzo:W.rectified_pausa_pranzo,rectified_pausa_pranzo_inizio:W.rectified_pausa_pranzo_inizio,rectified_pausa_pranzo_fine:W.rectified_pausa_pranzo_fine,rectified_pausa_cena_inizio:W.rectified_pausa_cena_inizio,rectified_pausa_cena_fine:W.rectified_pausa_cena_fine,effective_pausa_pranzo_inizio:W.effective_pausa_pranzo_inizio,effective_pausa_pranzo_fine:W.effective_pausa_pranzo_fine,effective_pausa_pranzo_minuti:W.effective_pausa_pranzo_minuti,effective_pausa_cena_inizio:W.effective_pausa_cena_inizio,effective_pausa_cena_fine:W.effective_pausa_cena_fine,effective_pausa_cena_minuti:W.effective_pausa_cena_minuti,effective_pausa_totale_minuti:W.effective_pausa_totale_minuti,effective_ore_lavorate_minuti:W.effective_ore_lavorate_minuti,auto_checkout:!1,benefit_tariffa_id:W.benefit_tariffa_id,benefit_importo_orario:W.benefit_importo_orario?parseFloat(W.benefit_importo_orario):void 0}});f(X);const se=new Set;X.forEach(W=>{W.notes&&se.add(W.notes)}),k(Array.from(se).sort())}catch(N){console.error("Errore caricamento turni extra:",N),j(N instanceof Error?N.message:"Errore sconosciuto")}finally{D(!1)}},te=N=>N&&rr(N)||"Non specificato";return P?e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"Caricamento turni extra..."})]})}):R?e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"text-center py-8 text-red-400",children:[e.jsx(Zt,{className:"h-12 w-12 mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Errore nel caricamento"}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:R}),e.jsx("button",{onClick:()=>U(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Riprova"})]})}):e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Turni Extra (",x.length,u.length!==x.length?` di ${u.length}`:"",")"]}),e.jsxs("div",{className:"mb-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Giorno Specifico:"}),e.jsx("input",{type:"date",value:v,onChange:N=>S(N.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",placeholder:"Seleziona un giorno..."}),v&&e.jsx("button",{onClick:()=>S(""),className:"mt-2 text-xs text-blue-400 hover:text-blue-300",children:"Rimuovi filtro data"})]}),p.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Nome Turno:"}),e.jsxs("select",{value:g,onChange:N=>E(N.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",children:[e.jsx("option",{value:"all",children:"Tutti i Turni"}),p.map((N,_)=>e.jsx("option",{value:N,children:N||"Senza nome"},_))]})]}),(v||g!=="all")&&e.jsxs("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-2 text-xs text-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ga,{className:"h-3 w-3"}),e.jsx("span",{className:"font-semibold",children:"Filtri attivi:"})]}),e.jsxs("div",{className:"mt-1 space-y-1",children:[v&&e.jsxs("div",{children:["Data: ",F(v).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"})]}),g!=="all"&&e.jsxs("div",{children:["Turno: ",g]})]})]})]}),x.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Ar,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsxs("p",{children:["Nessun turno extra ",v?"trovato con il filtro selezionato":"nel periodo selezionato"]}),e.jsx("p",{className:"text-sm mt-1",children:v?"Prova a modificare il filtro":"I turni extra appariranno qui"})]}):e.jsx("div",{className:"space-y-3",children:x.map(N=>{const _=N.check_out_turno||N.rectified_check_out,V=N.status!=="completed"||!_;return e.jsxs("div",{className:"bg-gradient-to-r from-blue-900 to-blue-800 rounded-lg p-4 border border-blue-600",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ar,{className:"h-5 w-5 text-blue-300"}),e.jsx("h4",{className:"font-bold text-white",children:"TURNO EXTRA"}),N.is_rectified&&e.jsx("span",{className:"bg-blue-600 text-white text-xs px-2 py-0.5 rounded font-semibold",children:"Rettificato"})]}),e.jsx("p",{className:"text-sm text-blue-200",children:F(N.giorno_turno).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})})]}),e.jsx("div",{className:"text-right",children:V?e.jsx("div",{className:"text-sm text-blue-300 font-semibold",children:"In corso"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-lg font-bold text-blue-300",children:N.effective_ore_lavorate_minuti?Sr(N.effective_ore_lavorate_minuti):"0h 0min"}),e.jsx("div",{className:"text-xs text-blue-200",children:"Ore Lavorate"})]})})]}),e.jsx("div",{className:"bg-gray-900 bg-opacity-40 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[e.jsx(ht,{className:"h-3 w-3 text-green-400"}),e.jsx("span",{className:"text-blue-200 font-medium",children:"Check-in:"})]}),e.jsx("div",{className:"text-white font-semibold",children:te(N.check_in_turno)||"--:--"}),N.is_rectified&&N.original_check_in&&e.jsxs("div",{className:"text-blue-300 line-through text-xs mt-1",children:["Era: ",te(N.original_check_in)]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[e.jsx(ht,{className:"h-3 w-3 text-red-400"}),e.jsx("span",{className:"text-blue-200 font-medium",children:"Check-out:"})]}),V?e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-blue-300 font-semibold",children:"In corso"}),N.is_rectified&&N.rectified_check_out&&e.jsxs("div",{className:"text-green-400 text-xs mt-1 flex items-center space-x-1",children:[e.jsx(pt,{className:"h-3 w-3"}),e.jsxs("span",{children:["Chiuso via rettifica: ",te(N.rectified_check_out)]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-white font-semibold flex items-center space-x-1 flex-wrap",children:[e.jsx("span",{children:te(N.check_out_turno)||"--:--"}),N.auto_checkout&&e.jsx("span",{className:"text-xs bg-purple-900 text-purple-200 px-1 py-0.5 rounded",title:"Checkout automatico",children:"AUTO"}),N.is_rectified&&N.rectified_check_out&&!N.original_check_out&&e.jsx("span",{className:"text-xs bg-green-900 text-green-200 px-1 py-0.5 rounded",title:"Chiuso via rettifica",children:"RETTIFICA"})]}),N.is_rectified&&N.original_check_out&&N.rectified_check_out&&e.jsxs("div",{className:"text-blue-300 line-through text-xs mt-1",children:["Era: ",te(N.original_check_out),N.auto_checkout&&e.jsx("span",{className:"ml-1",children:"(AUTO)"})]}),N.is_rectified&&!N.original_check_out&&N.rectified_check_out&&e.jsx("div",{className:"text-blue-300 text-xs mt-1 italic",children:"(Non era stato effettuato)"})]})]})]})}),e.jsxs("div",{className:"bg-gray-900 bg-opacity-40 rounded-lg p-3 mb-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm text-blue-200",children:"Pausa Pranzo:"})]}),e.jsxs("div",{className:"text-right",children:[N.pausa_pranzo?e.jsxs("div",{children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"S√¨"}),(()=>{const C=N.effective_pausa_pranzo_inizio||N.rectified_pausa_pranzo_inizio||N.pausa_pranzo_inizio,K=N.effective_pausa_pranzo_fine||N.rectified_pausa_pranzo_fine||N.pausa_pranzo_fine,O=N.effective_pausa_pranzo_minuti;return C&&K&&O?e.jsxs("div",{className:"text-xs text-blue-200 mt-0.5",children:[C.substring(0,5)," - ",K.substring(0,5)," (",O," min)"]}):null})()]}):e.jsx("span",{className:"text-blue-300",children:"No"}),N.is_rectified&&N.original_pausa_pranzo!==N.pausa_pranzo&&e.jsxs("div",{className:"text-xs text-blue-300 line-through mt-1",children:["Era: ",N.original_pausa_pranzo?"S√¨":"No"]})]})]}),(N.pausa_cena||N.rectified_pausa_cena_inizio||N.pausa_cena_inizio)&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-blue-700",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ls,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-blue-200",children:"Pausa Cena:"})]}),e.jsxs("div",{className:"text-right",children:[N.pausa_cena||N.rectified_pausa_cena_inizio||N.pausa_cena_inizio?e.jsxs("div",{children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"S√¨"}),(()=>{const C=N.effective_pausa_cena_inizio||N.rectified_pausa_cena_inizio||N.pausa_cena_inizio,K=N.effective_pausa_cena_fine||N.rectified_pausa_cena_fine||N.pausa_cena_fine,O=N.effective_pausa_cena_minuti;return C&&K&&O?e.jsxs("div",{className:"text-xs text-blue-200 mt-0.5",children:[C.substring(0,5)," - ",K.substring(0,5)," (",O," min)"]}):null})()]}):e.jsx("span",{className:"text-blue-300",children:"No"}),N.is_rectified&&N.rectified_pausa_cena_inizio&&!N.pausa_cena_inizio&&e.jsx("div",{className:"text-xs text-blue-300 line-through mt-1",children:"Era: No"})]})]}),N.effective_pausa_totale_minuti>0&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-blue-700",children:[e.jsx("span",{className:"text-xs text-blue-200",children:"Totale Pause:"}),e.jsx("span",{className:"text-xs text-white font-semibold",children:Sr(N.effective_pausa_totale_minuti)})]}),N.effective_ore_lavorate_minuti>0&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-blue-700",children:[e.jsx("span",{className:"text-xs text-blue-200",children:"Ore Effettive:"}),e.jsx("span",{className:"text-xs text-green-400 font-semibold",children:Sr(N.effective_ore_lavorate_minuti)})]})]}),N.benefit_tariffa_id&&N.benefit_importo_orario&&N.effective_ore_lavorate_minuti>0&&_&&(()=>{const C=fd(N.effective_ore_lavorate_minuti,N.ore_previste||480,N.benefit_importo_orario);return C.hasBenefit?e.jsx("div",{className:"bg-gradient-to-r from-green-900 to-green-800 rounded-lg p-3 mb-3 border border-green-600",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Na,{className:"h-5 w-5 text-green-300 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-bold text-green-200 mb-2",children:"Benefit Turno Extra"}),e.jsxs("div",{className:"space-y-1 text-xs text-green-100",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Ore Extra Lavorate:"}),e.jsx("span",{className:"font-semibold",children:C.actualWorkedFormatted})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Ore Magazzino Previste:"}),e.jsx("span",{className:"font-semibold",children:C.expectedWarehouseFormatted})]}),e.jsxs("div",{className:"flex justify-between pt-1 border-t border-green-700",children:[e.jsx("span",{children:"Ore da Conteggiare:"}),e.jsx("span",{className:"font-semibold text-green-300",children:C.extraMinutesFormatted})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Tariffa Oraria:"}),e.jsxs("span",{className:"font-semibold",children:["‚Ç¨",C.hourlyRate.toFixed(2),"/ora"]})]}),e.jsxs("div",{className:"flex justify-between pt-2 border-t border-green-700",children:[e.jsx("span",{className:"text-base font-bold",children:"Importo Benefit:"}),e.jsxs("span",{className:"text-base font-bold text-green-300",children:["‚Ç¨",C.benefit.toFixed(2)]})]})]})]})]})}):null})(),(N.noteturno||N.notes)&&e.jsx("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(qt,{className:"h-4 w-4 text-blue-300 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-1",children:"Note Dipendente:"}),e.jsx("div",{className:"text-xs text-blue-100",children:N.noteturno||N.notes})]})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs mb-2",children:[N.buoni_pasto_assegnato&&e.jsxs("span",{className:"bg-yellow-600 text-white px-2 py-1 rounded flex items-center space-x-1",children:[e.jsx(js,{className:"h-3 w-3"}),e.jsx("span",{children:"Buono Pasto"})]}),N.pasto_aziendale_usufruito&&e.jsxs("span",{className:"bg-blue-600 text-white px-2 py-1 rounded flex items-center space-x-1",children:[e.jsx(Ls,{className:"h-3 w-3"}),e.jsx("span",{children:"Pasto Aziendale"})]})]}),N.is_rectified&&N.rectification_note&&e.jsx("div",{className:"bg-blue-900 bg-opacity-50 border border-blue-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-blue-300 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-1",children:"Nota di Rettifica:"}),e.jsx("div",{className:"text-xs text-blue-100",children:N.rectification_note})]})]})}),e.jsx(Pi,{shift:N,onUpdate:U,tableName:"extra_shifts_checkins"})]},N.id)})})]})},pd=()=>{var N;const{user:n}=Pt(),[l,c]=w.useState(null),[u,f]=w.useState(new Date().getMonth()),[x,b]=w.useState(new Date().getFullYear()),[v,S]=w.useState(!0),[g,E]=w.useState(null),[p,k]=w.useState(null),[P,D]=w.useState("events"),R=_=>String(_).padStart(2,"0"),j=_=>`${_.getFullYear()}-${R(_.getMonth()+1)}-${R(_.getDate())}`,M=_=>{if(!_)return new Date(NaN);const V=_.split("-").map(C=>parseInt(C,10));return V.length!==3?new Date(_):new Date(V[0],V[1]-1,V[2])};w.useEffect(()=>{n!=null&&n.id&&T()},[n==null?void 0:n.id,u,x]);const T=async()=>{try{S(!0),k(null);const{data:_,error:V}=await Se.from("registration_requests").select(`
          *,
          regaziendasoftware!parent_company_id(ragione_sociale)
        `).eq("auth_user_id",n==null?void 0:n.id).single();if(V||!_){console.error("Errore caricamento profilo:",V),k("Errore nel caricamento del profilo utente");return}E(_);const C=new Date(x,u,1),K=new Date(x,u+1,0),O=j(C),X=j(K),{data:se}=await Se.from("crew_event_assegnazione").select("evento_id, evento_trasferta, nome_evento, giorno_inizio_evento, giorno_fine_evento").eq("dipendente_freelance_id",n==null?void 0:n.id).gte("giorno_inizio_evento",O).lte("giorno_inizio_evento",X),{data:W}=await Se.from("timesheet_entries").select("event_id, status, start_time").eq("crew_id",n==null?void 0:n.id).gte("date",O).lte("date",X),G=new Set((W||[]).filter(de=>de.start_time&&(de.status==="active"||de.status==="completed"||de.status==="submitted")).map(de=>de.event_id)),B={warehouse:0,event:0,event_travel:0},ne=[];(se||[]).forEach(de=>{var oe;if(G.has(de.evento_id)){(oe=de.nome_evento)!=null&&oe.toLowerCase().includes("magazzino")?B.warehouse++:de.evento_trasferta?B.event_travel++:B.event++;const ge=M(de.giorno_inizio_evento),ve=M(de.giorno_fine_evento),Te=new Date(ge);for(;Te<=ve;)ne.push(j(Te)),Te.setDate(Te.getDate()+1)}});const{data:ye}=await Se.from("warehouse_checkins").select("id, date, status, check_out_time, overtime_hours").eq("crew_id",n==null?void 0:n.id).gte("date",O).lte("date",X),{data:me}=await Se.from("extra_shifts_checkins").select("id, date, status, check_out_time, overtime_hours").eq("crew_id",n==null?void 0:n.id).gte("date",O).lte("date",X),Q=(ye||[]).filter(de=>de.status==="completed"&&de.check_out_time),fe=(me||[]).filter(de=>de.status==="completed"&&de.check_out_time);B.warehouse+=Q.length;let be=0;[...Q,...fe].forEach(de=>{be+=parseFloat(de.overtime_hours)||0,ne.push(de.date)});const{data:Z}=await Se.from("expenses").select("id").eq("crew_id",n==null?void 0:n.id).gte("expense_date",O).lte("expense_date",X),L=new Set(ne),re={month:new Date(x,u).toLocaleDateString("it-IT",{month:"long"}),year:x,totalEvents:((se==null?void 0:se.length)||0)+Q.length+fe.length,totalDays:L.size,totalShifts:Q.length+fe.length,eventsByType:B,expensesCount:(Z==null?void 0:Z.length)||0,overtimeHours:be,vacationRequested:_.vacation_days_used||0,vacationRemaining:(_.vacation_days_total||0)-(_.vacation_days_used||0),leaveRequested:_.leave_days_used||0,leaveRemaining:(_.leave_days_total||0)-(_.leave_days_used||0)};c(re)}catch(_){console.error("Errore caricamento riepilogo mensile:",_),k(`Errore nel caricamento del riepilogo: ${_ instanceof Error?_.message:"Errore sconosciuto"}`)}finally{S(!1)}},F=()=>{var V;if(!l)return;const _={dipendente:(g==null?void 0:g.full_name)||"Dipendente",azienda:((V=g==null?void 0:g.regaziendasoftware)==null?void 0:V.ragione_sociale)||"Azienda",periodo:`${l.month} ${l.year}`,eventi:l.totalEvents};console.log("Download report:",_),alert(`Report ${l.month} ${l.year} generato!`)},U=()=>{u===0?(f(11),b(x-1)):f(u-1)},te=()=>{u===11?(f(0),b(x+1)):f(u+1)};return v?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento riepilogo..."})]})}):p?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(Zt,{className:"h-16 w-16 mx-auto mb-4 text-red-400"}),e.jsx("p",{className:"text-lg text-red-400",children:"Errore nel caricamento"}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:p}),e.jsx("button",{onClick:()=>T(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Riprova"})]})}):e.jsx("div",{className:"min-h-screen bg-gray-900 text-white",children:e.jsxs("div",{className:"p-4 pb-20 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Report Mensile"}),e.jsx("p",{className:"text-gray-300",children:(g==null?void 0:g.full_name)||"Dipendente"}),e.jsx("p",{className:"text-sm text-blue-400",children:((N=g==null?void 0:g.regaziendasoftware)==null?void 0:N.ragione_sociale)||"La Mia Azienda"})]}),e.jsx("button",{onClick:F,disabled:!l,className:"bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-600",children:e.jsx(cr,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("button",{onClick:U,className:"flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors",children:[e.jsx(Zr,{className:"h-5 w-5"}),e.jsx("span",{children:"Precedente"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-white capitalize",children:new Date(x,u).toLocaleDateString("it-IT",{month:"long"})}),e.jsx("div",{className:"text-sm text-gray-400",children:x})]}),e.jsxs("button",{onClick:te,className:"flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors",children:[e.jsx("span",{children:"Successivo"}),e.jsx(Qr,{className:"h-5 w-5"})]})]})}),e.jsx("div",{className:"bg-gray-800 rounded-xl border border-gray-700 overflow-hidden",children:e.jsxs("div",{className:"grid grid-cols-3",children:[e.jsxs("button",{onClick:()=>D("events"),className:`flex items-center justify-center space-x-2 py-4 px-2 transition-all ${P==="events"?"bg-blue-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:[e.jsx(xt,{className:"h-5 w-5"}),e.jsx("span",{className:"font-semibold text-sm",children:"Eventi"})]}),e.jsxs("button",{onClick:()=>D("warehouse"),className:`flex items-center justify-center space-x-2 py-4 px-2 transition-all ${P==="warehouse"?"bg-blue-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:[e.jsx(Rt,{className:"h-5 w-5"}),e.jsx("span",{className:"font-semibold text-sm",children:"Turni"})]}),e.jsxs("button",{onClick:()=>D("extra"),className:`flex items-center justify-center space-x-2 py-4 px-2 transition-all ${P==="extra"?"bg-blue-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:[e.jsx(ks,{className:"h-5 w-5"}),e.jsx("span",{className:"font-semibold text-sm",children:"Extra"})]})]})}),l&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Riepilogo ",l.month," ",l.year]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(Rt,{className:"h-5 w-5 mx-auto mb-1 text-gray-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:l.eventsByType.warehouse}),e.jsx("div",{className:"text-xs text-gray-400",children:"Turni Magazzino"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(xt,{className:"h-5 w-5 mx-auto mb-1 text-blue-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:l.eventsByType.event}),e.jsx("div",{className:"text-xs text-gray-400",children:"Eventi"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(ks,{className:"h-5 w-5 mx-auto mb-1 text-orange-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:l.eventsByType.event_travel}),e.jsx("div",{className:"text-xs text-gray-400",children:"Trasferte"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(xt,{className:"h-5 w-5 mx-auto mb-1 text-blue-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:l.totalDays}),e.jsx("div",{className:"text-xs text-gray-400",children:"Giorni"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(di,{className:"h-5 w-5 mx-auto mb-1 text-yellow-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:l.expensesCount}),e.jsx("div",{className:"text-xs text-gray-400",children:"Note Spese"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(ht,{className:"h-5 w-5 mx-auto mb-1 text-green-400"}),e.jsxs("div",{className:"text-lg font-bold text-white",children:[l.overtimeHours.toFixed(1),"h"]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Straordinari"})]})]})]}),P==="events"&&e.jsx(ud,{selectedMonth:u,selectedYear:x}),P==="warehouse"&&e.jsx(hd,{selectedMonth:u,selectedYear:x}),P==="extra"&&e.jsx(gd,{selectedMonth:u,selectedYear:x}),!l&&!v&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700 text-center",children:[e.jsx(qt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Nessun Dato Disponibile"}),e.jsx("p",{className:"text-gray-300",children:"Non ci sono eventi per il periodo selezionato."}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Prova a selezionare un mese diverso o attendi nuove assegnazioni."})]}),e.jsx(Jr,{})]})})},bd=()=>{const{user:n}=Pt(),{showSuccess:l,showError:c}=ms(),[u,f]=w.useState(!0),[x,b]=w.useState(!1),[v,S]=w.useState({request_type:"vacation",start_date:"",end_date:"",start_time:"",end_time:"",reason:""}),[g,E]=w.useState([]),[p,k]=w.useState(!1);w.useEffect(()=>{if(!(n!=null&&n.id)){f(!1);return}(async()=>(f(!0),await P(),f(!1)))()},[n==null?void 0:n.id]);async function P(){try{const{data:N,error:_}=await Se.from("crew_richiesteferie_permessi").select("*").eq("dipendente_id",n==null?void 0:n.id).order("created_at",{ascending:!1}).limit(1e3);if(_){console.warn("Errore loadVacationRequests:",_),E([]);return}E(N||[])}catch(N){console.error("Errore loadVacationRequests:",N),E([])}}async function D(){try{const{data:N}=await Se.from("crew_members").select("company_id").eq("id",n==null?void 0:n.id).maybeSingle();if(N!=null&&N.company_id)return String(N.company_id);const{data:_}=await Se.from("registration_requests").select("parent_company_id").eq("auth_user_id",n==null?void 0:n.id).maybeSingle();if(_!=null&&_.parent_company_id)return String(_.parent_company_id);const{data:V}=await Se.from("users").select("email").eq("id",n==null?void 0:n.id).maybeSingle(),C=(V==null?void 0:V.email)??null;if(C){const{data:K}=await Se.from("registration_requests").select("parent_company_id").ilike("email",C).limit(1).maybeSingle();if(K!=null&&K.parent_company_id)return String(K.parent_company_id)}return null}catch(N){return console.error("resolveCompanyId error:",N),null}}function R(N,_){if(!N||!_)return 0;const V=new Date(N),C=new Date(_),K=Math.floor((C.getTime()-V.getTime())/(1e3*60*60*24))+1;return K>0?K:0}function j(N,_){if(!N||!_)return 0;const[V,C]=N.split(":").map(Number),[K,O]=_.split(":").map(Number),X=V*60+C,W=K*60+O-X;return W>0?Number((W/60).toFixed(2)):0}async function M(){if(!v.start_date){c("Inserisci la data di inizio");return}if(v.request_type==="vacation"&&!v.end_date){c("Inserisci la data di fine per le ferie");return}if(v.request_type==="vacation"&&new Date(v.end_date)<new Date(v.start_date)){c("La data di fine deve essere successiva alla data di inizio");return}if(v.request_type==="leave"){if(!v.start_time||!v.end_time){c("Inserisci orario di inizio e fine per il permesso");return}if(v.start_time>=v.end_time){c("L'orario di fine deve essere successivo all'orario di inizio");return}}b(!0);try{const N=await D();if(!N){c("Azienda non trovata per il tuo profilo. Contatta l'amministratore."),b(!1);return}const _={azienda_id:N,dipendente_id:n==null?void 0:n.id,tipo_richiesta:v.request_type==="vacation"?"ferie":"permesso",data_inizio:v.start_date,motivo:v.reason||null,stato:"in_attesa"};v.request_type==="vacation"?(_.data_fine=v.end_date,_.giorni_richiesti=R(v.start_date,v.end_date)):(_.data_fine=v.start_date,_.orario_inizio=v.start_time,_.orario_fine=v.end_time,_.ore_richieste=j(v.start_time,v.end_time),_.giorni_richiesti=0);const{error:V}=await Se.from("crew_richiesteferie_permessi").insert(_);if(V)throw V;l("Richiesta inviata"),S({request_type:"vacation",start_date:"",end_date:"",start_time:"",end_time:"",reason:""}),await P()}catch(N){console.error("Errore handleVacationSubmit:",N),c((N==null?void 0:N.message)||"Errore invio richiesta")}finally{b(!1)}}function T(N){const _=N.stato??N.status??N.state??N.stato_richiesta??null;if(!_)return"in_attesa";const V=String(_).toLowerCase();return V.includes("approv")||V==="approved"||V==="accepted"?"approved":V.includes("rifiut")||V==="rejected"||V==="refused"?"rejected":V.includes("in_attesa")||V.includes("pending")||V.includes("in attesa")?"pending":V}function F(N){const _=T(N);return _==="approved"?{label:"Approvata",className:"bg-green-100 text-green-800"}:_==="rejected"?{label:"Rifiutata",className:"bg-red-100 text-red-800"}:{label:"In attesa",className:"bg-yellow-100 text-yellow-800"}}function U(N){if(!N)return"-";try{return new Date(N).toLocaleDateString("it-IT")}catch{return N}}async function te(){k(!0);try{await P(),l("Aggiornato")}catch(N){console.error("refresh error",N),c("Errore aggiornamento")}finally{k(!1)}}return e.jsxs("div",{className:"bg-gray-900 p-4 rounded-lg border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Ferie e Permessi"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Invia richieste e controlla lo stato"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:te,className:"p-2 rounded bg-gray-800 hover:bg-gray-700 text-gray-200",title:"Aggiorna",children:e.jsx(Ms,{})})})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4",children:[e.jsx("button",{onClick:()=>S({...v,request_type:"vacation"}),className:`w-full text-left py-3 px-3 rounded ${v.request_type==="vacation"?"bg-blue-600 text-white":"bg-gray-800 text-gray-200"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(xt,{className:"h-5 w-5 flex-shrink-0"}),e.jsxs("div",{className:"leading-snug",children:[e.jsx("div",{className:"text-sm font-medium whitespace-normal break-words",children:"Ferie"}),e.jsx("div",{className:"text-xs text-gray-300",children:"Giorni interi"})]})]})}),e.jsx("button",{onClick:()=>S({...v,request_type:"leave"}),className:`w-full text-left py-3 px-3 rounded ${v.request_type==="leave"?"bg-blue-600 text-white":"bg-gray-800 text-gray-200"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ht,{className:"h-5 w-5 flex-shrink-0"}),e.jsxs("div",{className:"leading-snug",children:[e.jsx("div",{className:"text-sm font-medium whitespace-normal break-words",children:"Permesso"}),e.jsx("div",{className:"text-xs text-gray-300",children:"Ore / Mezze giornate"})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Data Inizio *"}),e.jsx("input",{type:"date",value:v.start_date,onChange:N=>S({...v,start_date:N.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:v.request_type==="vacation"?"Data Fine *":"Data *"}),e.jsx("input",{type:"date",value:v.request_type==="vacation"?v.end_date:v.start_date,onChange:N=>S({...v,end_date:v.request_type==="vacation"?N.target.value:v.end_date,start_date:v.request_type==="leave"?N.target.value:v.start_date}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2"})]})]}),v.request_type==="leave"&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Ora Inizio *"}),e.jsx("input",{type:"time",value:v.start_time,onChange:N=>S({...v,start_time:N.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Ora Fine *"}),e.jsx("input",{type:"time",value:v.end_time,onChange:N=>S({...v,end_time:N.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2",required:!0})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Motivo (opzionale)"}),e.jsx("textarea",{value:v.reason,onChange:N=>S({...v,reason:N.target.value}),rows:3,className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2",placeholder:v.request_type==="leave"?"Es: visita medica, commissione personale...":"Es: motivi personali, vacanza..."})]}),e.jsx("div",{className:"flex space-x-3 mb-6",children:e.jsx("button",{onClick:M,disabled:x,className:"flex-1 py-3 rounded bg-blue-600 text-white",children:x?"Invio...":"Invia Richiesta"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Richieste Inviate"}),e.jsx("div",{className:"space-y-3",children:g.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"Nessuna richiesta inviata"}):g.map(N=>{const _=N;T(N);const{label:V,className:C}=F(N),K=N.rejection_reason??N.rifiuto??N.motivo_rifiuto??(_==null?void 0:_.rejection_reason)??null,O=N.approved_by??(_==null?void 0:_.approved_by)??null,X=N.approved_at??(_==null?void 0:_.approved_at)??null,se=N.tipo_richiesta??(_==null?void 0:_.tipo_richiesta)??"Ferie/Permesso",W=se.toLowerCase().includes("permess"),G=(_==null?void 0:_.orario_inizio)??null,B=(_==null?void 0:_.orario_fine)??null,ne=(_==null?void 0:_.ore_richieste)??null;return e.jsx("div",{className:"bg-gray-800 p-3 rounded border border-gray-700",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-white capitalize",children:se}),e.jsxs("div",{className:"text-sm text-gray-300",children:[U(N.data_inizio??(_==null?void 0:_.data_inizio)??(_==null?void 0:_.start_date)??null),!W&&(N.data_fine||_!=null&&_.data_fine)?` ‚Äî ${U(N.data_fine??(_==null?void 0:_.data_fine)??(_==null?void 0:_.end_date)??null)}`:"",!W&&N.giorni_richiesti?` ‚Ä¢ ${N.giorni_richiesti} giorno/i`:"",W&&G&&B&&e.jsxs("span",{children:[" ‚Ä¢ ",G.substring(0,5)," - ",B.substring(0,5)]}),W&&ne&&e.jsxs("span",{children:[" ‚Ä¢ ",ne," ore"]})]}),N.motivo&&e.jsxs("div",{className:"text-sm text-gray-300 mt-2",children:["Motivo: ",N.motivo]}),K&&e.jsxs("div",{className:"text-sm text-red-300 mt-2",children:["Motivo rifiuto: ",K]}),O&&e.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["Approvata da: ",O," ",X?`‚Ä¢ ${U(X)}`:""]})]}),e.jsx("div",{className:"text-right ml-2",children:e.jsx("div",{className:`text-xs px-2 py-1 rounded-full ${C}`,children:V})})]})},N.id)})})]})]})},wd=[{value:"vitto",label:"Vitto"},{value:"alloggio",label:"Alloggio"},{value:"trasporto",label:"Trasporto"},{value:"materiali",label:"Materiali"},{value:"comunicazioni",label:"Comunicazioni"},{value:"altro",label:"Altro"}],yd=()=>{const{user:n}=Pt(),{showSuccess:l,showError:c}=ms(),[u,f]=w.useState([]),[x,b]=w.useState(!1),[v,S]=w.useState(!1),[g,E]=w.useState(!1),[p,k]=w.useState(null),P=w.useRef(null),D=w.useRef(null),[R,j]=w.useState({selectedSourceId:"",category:"vitto",amount:"",description:"",expenseDate:new Date().toISOString().slice(0,10),paymentMethod:"electronic",receiptFile:null,allowStandalone:!1}),[M,T]=w.useState([]);w.useEffect(()=>{n!=null&&n.id&&(F(),U().catch(O=>{console.warn("loadAvailableEvents initial failed",O)}))},[n==null?void 0:n.id]);async function F(){if(n!=null&&n.id)try{const{data:O,error:X}=await Se.from("expenses").select(`
          id,
          category,
          description,
          amount,
          event_id,
          event_title,
          warehouse_checkin_id,
          warehouse_name,
          warehouse_shift_id,
          warehouse_shift_name,
          company_id,
          company_name,
          expense_date,
          status,
          submitted_at
        `).eq("crew_id",n.id).order("expense_date",{ascending:!1}).limit(6);if(X){console.warn("loadRecentExpenses error",X),T([]);return}T(O||[])}catch(O){console.error("loadRecentExpenses",O),T([])}}async function U(){if(!(n!=null&&n.id))return f([]),b(!0),[];const O=[];try{const{data:se}=await Se.from("registration_requests").select("id").eq("auth_user_id",n.id).maybeSingle();se&&se.id&&O.push(String(se.id))}catch{}O.push(n.id);const X=[];for(const se of Array.from(new Set(O)))try{const{data:W}=await Se.from("timesheet_entries").select("id, event_id, date, start_time").eq("crew_id",se).order("start_time",{ascending:!1}).limit(500),{data:G}=await Se.from("warehouse_checkins").select("id, warehouse_id, shift_id, date, check_in_time").eq("crew_id",se).order("check_in_time",{ascending:!1}).limit(500),B=Array.from(new Set((W||[]).map(Q=>Q.event_id).filter(Boolean))),ne=Array.from(new Set((G||[]).map(Q=>Q.warehouse_id).filter(Boolean))),ye={};if(B.length>0)try{const{data:Q}=await Se.from("crew_events").select("*").in("id",B);(Q||[]).forEach(fe=>ye[String(fe.id)]=fe)}catch{}const me={};if(ne.length>0)try{const{data:Q}=await Se.from("warehouses").select("*").in("id",ne);(Q||[]).forEach(fe=>me[String(fe.id)]=fe)}catch{}(W||[]).forEach(Q=>{const fe=ye[String(Q.event_id)]||{},be=fe.title??fe.name??fe.event_title??"Evento";X.push({sourceId:String(Q.id),refEventId:Q.event_id??null,refShiftId:null,title:be,date:Q.date??Q.start_time??null,location:fe.location??fe.address??null,type:"event"})}),(G||[]).forEach(Q=>{const fe=me[String(Q.warehouse_id)]||{},be=fe.title??fe.name??fe.warehouse_name??"Magazzino";X.push({sourceId:String(Q.id),refEventId:null,refShiftId:Q.shift_id??null,title:be,date:Q.date??Q.check_in_time??null,location:fe.address??fe.warehouse_address??null,type:"warehouse"})})}catch(W){console.warn("partial loadAvailableEvents fail for",se,W)}return X.sort((se,W)=>{const G=se.date?new Date(se.date).getTime():0;return(W.date?new Date(W.date).getTime():0)-G}),f(X),b(X.length===0),X}function te(O){if(j({...R,receiptFile:O}),!O){k(null);return}if(!O.type.startsWith("image/")){k(null);return}const X=new FileReader;X.onload=se=>{var W;return k(String(((W=se.target)==null?void 0:W.result)||null))},X.readAsDataURL(O)}async function N(O){try{const X=O.name.split(".").pop()??"jpg",se=`${n==null?void 0:n.id}/receipts/${Date.now()}.${X}`,{data:W,error:G}=await Se.storage.from("receipts").upload(se,O,{cacheControl:"3600",upsert:!1});if(G)return console.warn("upload error",G),null;try{const{data:B}=Se.storage.from("receipts").getPublicUrl(W.path);return(B==null?void 0:B.publicURL)??(B==null?void 0:B.publicUrl)??null}catch(B){return console.warn("getPublicUrl failed",B),null}}catch(X){return console.error("uploadReceipt",X),null}}async function _(O,X=!1){E(!0);try{const se=parseFloat(R.amount);let W=null;if(R.receiptFile){const fe=await N(R.receiptFile);fe&&(W=fe)}let G=null;try{const{data:fe}=await Se.from("crew_members").select("company_id").eq("id",n.id).maybeSingle();G=(fe==null?void 0:fe.company_id)??null}catch{}const B=O&&O.type==="warehouse"?O.sourceId:null,ne=O&&O.type==="event"?O.refEventId:null,ye=R.description??"",me={crew_id:n.id,event_id:ne,warehouse_shift_id:null,warehouse_checkin_id:B,expense_date:R.expenseDate,category:R.category,amount:se,description:R.description,notes:ye,receipt_url:W,status:"pending",company_id:G};(X||R.allowStandalone)&&(me.event_id=null,me.warehouse_shift_id=null,me.warehouse_checkin_id=null),console.debug("NoteSpese: inserting expense payload",{selected:O,basePayload:me});const Q=await Se.from("expenses").insert(me);if(Q.error){console.error("expenses insert error",Q.error),c(Q.error.message??"Errore invio nota spesa");return}l("Nota spesa inviata"),S(!1),j({selectedSourceId:"",category:"vitto",amount:"",description:"",expenseDate:new Date().toISOString().slice(0,10),paymentMethod:"electronic",receiptFile:null,allowStandalone:!1}),k(null),await F()}catch(se){console.error("doInsert error",se),c((se==null?void 0:se.message)||"Errore invio nota spesa")}finally{E(!1)}}async function V(){try{if(!(n!=null&&n.id)){c("Utente non autenticato");return}if(await U().catch(()=>{}),!R.allowStandalone&&!R.selectedSourceId){c('Seleziona un evento o turno oppure abilita "Nota non collegata"');return}if(!R.description||!R.amount){c("Compila descrizione e importo");return}const O=parseFloat(R.amount);if(isNaN(O)||O<=0){c("Inserisci un importo valido");return}const X=u.find(se=>se.sourceId===R.selectedSourceId)??null;if(R.selectedSourceId&&!X){c("Evento/turno non valido");return}await _(X,!1)}catch(O){console.error("handleSubmit unexpected",O),c((O==null?void 0:O.message)||"Errore invio nota spesa")}}const C=O=>{const X=se=>se!=null&&String(se).trim()!=="";return X(O.event_title)?O.event_title:X(O.warehouse_shift_name)?O.warehouse_shift_name+(X(O.warehouse_name)?" ‚Ä¢ "+O.warehouse_name:""):X(O.warehouse_name)?O.warehouse_name:X(O.company_name)?O.company_name:X(O.event_id)?String(O.event_id):X(O.warehouse_checkin_id)?String(O.warehouse_checkin_id):""},K=O=>{try{return O?new Date(O).toLocaleDateString("it-IT"):"-"}catch{return String(O)}};return e.jsxs("div",{className:"bg-gray-900 p-4 rounded border border-gray-700",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Note Spese"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Invia le tue spese associate a eventi/turni"})]}),e.jsx("div",{className:"w-full sm:w-auto",children:e.jsxs("button",{onClick:()=>{S(!0),U().catch(()=>{})},className:"w-full sm:w-auto py-3 px-4 rounded bg-green-600 text-white text-sm font-medium",children:[e.jsx(qt,{className:"inline mr-2"})," Nuova Nota Spesa"]})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm text-gray-300 mb-2",children:"Note spese recenti"}),M.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"Nessuna nota spesa recente"}):e.jsx("div",{className:"space-y-3",children:M.map(O=>e.jsxs("div",{className:"bg-gray-800 p-3 rounded border border-gray-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-white truncate",children:O.category}),e.jsx("div",{className:"text-sm text-gray-300 truncate",children:O.description}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[C(O)," ‚Ä¢ ",K(O.expense_date)]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-green-400 font-semibold",children:["‚Ç¨",Number(O.amount||0).toFixed(2)]}),e.jsx("div",{className:`text-xs mt-1 ${O.status==="approved"?"text-green-300":O.status==="rejected"?"text-red-300":"text-yellow-300"}`,children:O.status==="approved"?"Approvata":O.status==="rejected"?"Rifiutata":"In attesa"})]})]},O.id))})]}),v&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4",children:e.jsxs("div",{className:"w-full h-full sm:h-auto max-w-full sm:max-w-lg bg-gray-900 rounded-none sm:rounded p-4 sm:p-6 overflow-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Nuova Nota Spesa"}),e.jsx("button",{onClick:()=>{S(!1),k(null)},className:"text-gray-400",children:e.jsx(Et,{})})]}),x&&e.jsx("div",{className:"mb-3 p-2 rounded bg-yellow-900/20 border border-yellow-700 text-yellow-200 text-sm",children:'Nessun evento/turno trovato per il tuo account. Puoi comunque compilare la nota spesa abilitando "Nota non collegata".'}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Turno / Evento"}),e.jsxs("select",{value:R.selectedSourceId,onChange:O=>j({...R,selectedSourceId:O.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:u.length===0?"Nessun evento disponibile":"Seleziona evento/turno"}),u.map(O=>e.jsxs("option",{value:O.sourceId,children:[O.type==="warehouse"?"[MAG] ":"[EV] ",O.title," ‚Äî ",O.date?new Date(O.date).toLocaleDateString("it-IT"):"-"]},O.sourceId))]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("input",{id:"standalone",type:"checkbox",checked:R.allowStandalone,onChange:O=>j({...R,allowStandalone:O.target.checked}),className:"h-4 w-4"}),e.jsx("label",{htmlFor:"standalone",className:"text-sm text-gray-300",children:"Nota non collegata (crea nota senza evento)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Categoria"}),e.jsx("select",{value:R.category,onChange:O=>j({...R,category:O.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm",children:wd.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Importo (‚Ç¨)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:R.amount,onChange:O=>j({...R,amount:O.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Data Spesa"}),e.jsx("input",{type:"date",value:R.expenseDate,onChange:O=>j({...R,expenseDate:O.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Descrizione"}),e.jsx("textarea",{value:R.description,onChange:O=>j({...R,description:O.target.value}),rows:3,className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Metodo di pagamento"}),e.jsxs("select",{value:R.paymentMethod,onChange:O=>j({...R,paymentMethod:O.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm",children:[e.jsx("option",{value:"electronic",children:"Pagamento Elettronico"}),e.jsx("option",{value:"cash",children:"Contanti"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Scontrino (opzionale)"}),e.jsxs("div",{className:"mt-1 flex gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>{var O;return(O=D.current)==null?void 0:O.click()},className:"flex-1 bg-gray-800 border border-gray-700 rounded py-2 text-gray-200 text-sm",children:[e.jsx(oi,{className:"inline mr-2"})," Scatta"]}),e.jsxs("button",{type:"button",onClick:()=>{var O;return(O=P.current)==null?void 0:O.click()},className:"flex-1 bg-gray-800 border border-gray-700 rounded py-2 text-gray-200 text-sm",children:[e.jsx(ai,{className:"inline mr-2"})," Carica"]}),e.jsx("input",{ref:D,type:"file",accept:"image/*",capture:"environment",onChange:O=>{var X;return te(((X=O.target.files)==null?void 0:X[0])??null)},className:"hidden"}),e.jsx("input",{ref:P,type:"file",accept:"image/*,application/pdf",onChange:O=>{var X;return te(((X=O.target.files)==null?void 0:X[0])??null)},className:"hidden"})]})]}),p&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("img",{src:p,alt:"Anteprima",className:"w-full h-40 object-cover rounded"}),e.jsx("div",{className:"mt-2 text-right",children:e.jsx("button",{onClick:()=>te(null),className:"text-sm text-red-400",children:"Rimuovi immagine"})})]}),e.jsxs("div",{className:"sm:col-span-2 flex flex-col sm:flex-row gap-3 mt-3",children:[e.jsx("button",{onClick:V,disabled:g,className:"w-full sm:w-auto flex-1 py-3 rounded bg-green-600 text-white text-sm",children:g?"Invio...":"Invia Nota Spesa"}),e.jsx("button",{onClick:()=>S(!1),className:"w-full sm:w-auto px-4 py-3 rounded border border-gray-700 text-sm",children:"Annulla"})]})]})]})})]})};function _d(n){return Math.floor(n/30)*30}function Kn(n){const l=Math.round(n*60);return _d(l)/60}function sr(n){const l=Math.floor(n/60),c=n%60;return l===0&&c===0?"0min":l===0?`${c}min`:c===0?`${l}h`:`${l}h ${c}min`}function Ys(n){return Math.round(n*60)}const vd=()=>{const{user:n}=Pt(),{showSuccess:l,showError:c}=ms(),[u,f]=w.useState(!0),[x,b]=w.useState(!1),[v,S]=w.useState(null),[g,E]=w.useState([]),[p,k]=w.useState(null),[P,D]=w.useState(!1),[R,j]=w.useState(0),[M,T]=w.useState(0),[F,U]=w.useState(""),[te,N]=w.useState(!1);w.useEffect(()=>{if(!(n!=null&&n.id)){f(!1);return}(async()=>{f(!0);try{await Promise.all([_(),K()])}catch(W){console.error("init straordinari error",W)}finally{f(!1)}})()},[n==null?void 0:n.id]);async function _(){try{const{data:W}=await Se.from("crew_assegnazionetariffa").select("tariffe_ids").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0);if(W&&W.length>0){const G=[];if(W.forEach(B=>{B.tariffe_ids&&B.tariffe_ids.length>0&&G.push(...B.tariffe_ids)}),G.length>0){const{data:B}=await Se.from("crew_tariffe").select("tipo_calcolo, categoria").in("id",G).eq("attivo",!0);if(B&&B.length>0&&B.some(ye=>{var me,Q;return((me=ye.tipo_calcolo)==null?void 0:me.includes("straordinario"))||((Q=ye.categoria)==null?void 0:Q.includes("straordinario"))}))return S(!0),!0}}}catch(W){console.error("Error checking overtime authorization via tariffe",W)}try{const{data:W}=await Se.from("crew_members").select("benefit_straordinari").eq("id",n==null?void 0:n.id).maybeSingle();if(W&&W.benefit_straordinari)return S(!0),!0}catch{}try{const{data:W}=await Se.from("registration_requests").select("benefit_straordinari").eq("auth_user_id",n==null?void 0:n.id).maybeSingle();if(W&&W.benefit_straordinari)return S(!0),!0}catch{}return S(!1),!1}function V(W){if(!W)return null;const G=new Date(W);return isNaN(G.getTime())?null:G}function C(W,G){const B=V(W),ne=V(G);if(!B||!ne)return null;const ye=ne.getTime()-B.getTime();return Math.round(ye/(1e3*60*60)*100)/100}async function K(){if(!(n!=null&&n.id))return[];const W=[];try{const{data:G}=await Se.from("warehouse_checkins").select(`
          id,
          date,
          check_in_time,
          check_out_time,
          net_hours,
          overtime_hours,
          "oraro in eccesso",
          shift_id,
          assegnazione_id,
          notes
        `).eq("crew_id",n.id).eq("requisito_straordinari",!0).order("date",{ascending:!1}).limit(100);for(const B of G||[])try{let ne=0;if(B.overtime_hours)ne=Number(B.overtime_hours);else if(B["oraro in eccesso"]){const Q=B["oraro in eccesso"].match(/(\d+):(\d+):(\d+)/);if(Q){const fe=parseInt(Q[1],10),be=parseInt(Q[2],10);ne=fe+be/60}}const ye=Kn(ne);if(ye>0){const me=B.net_hours?Number(B.net_hours):null,Q=me?Math.round((me-ne)*100)/100:8;W.push({source:"warehouse",assignment_id:B.assegnazione_id||B.shift_id||B.id,refShiftId:B.shift_id||B.id,date:B.date,title:`Turno Magazzino ${B.date}`,scheduledHours:Q,workedHours:me||Q+ne,excessHours:Math.round(ne*100)/100,requestableHours:Math.round(ye*100)/100,raw:B})}}catch(ne){console.warn("Error processing overtime shift",B,ne);continue}}catch(G){console.warn("Failed to load warehouse overtime shifts",G)}try{const{data:G}=await Se.from("timesheet_entries").select("id, event_id, start_time, end_time, date").eq("crew_id",n.id).order("date",{ascending:!1}).limit(500);if(G)for(const B of G)try{const ne=C(B.start_time,B.end_time);if(!ne||!B.event_id)continue;const{data:ye}=await Se.from("crew_events").select("*").eq("id",B.event_id).maybeSingle();let me=null;ye&&(ye.durata_ore?me=Number(ye.durata_ore):ye.duration_hours?me=Number(ye.duration_hours):ye.start_time&&ye.end_time&&(me=C(ye.start_time,ye.end_time))),me||(me=8);const Q=Math.round(Math.max(0,ne-me)*100)/100,fe=Kn(Q);fe>0&&W.push({source:"event",assignment_id:B.id,refEventId:B.event_id,date:B.date??null,title:ye&&(ye.title||ye.name)||`Evento ${B.event_id}`,scheduledHours:me,workedHours:Math.round(ne*100)/100,excessHours:Q,requestableHours:Math.round(fe*100)/100,raw:{timesheet:B,event:ye}})}catch{}}catch(G){console.warn("timesheet_entries load failed",G)}return W.sort((G,B)=>{if(B.requestableHours!==G.requestableHours)return B.requestableHours-G.requestableHours;const ne=G.date?new Date(G.date).getTime():0;return(B.date?new Date(B.date).getTime():0)-ne}),E(W),W}async function O(W){if(!(n!=null&&n.id)){c("Utente non autenticato");return}const G=R*60+M;if(G<=0){c("Inserisci almeno 30 minuti di straordinario");return}if(G%30!==0){c("Le ore straordinarie devono essere richieste con tagli di 30 minuti");return}if(W){const ne=Ys(W.requestableHours);if(G>ne){const ye=sr(ne);c(`Puoi richiedere al massimo ${ye} per questo turno`);return}}if(!v){c("Non sei autorizzato agli straordinari");return}const B=G/60;N(!0);try{const ne={crewid:n.id,ore_straordinario:B,note:F||null,status:"in_attesa"};W&&(W.source==="warehouse"&&W.refShiftId&&(ne.turno_id=W.refShiftId),W.source==="event"&&W.refEventId&&(ne.event_id=W.refEventId));const{error:ye}=await Se.from("richieste_straordinari_v2").insert(ne);if(ye)throw console.error("Insert to richieste_straordinari_v2 failed",ye),ye;l("Richiesta straordinario inviata"),k(null),D(!1),j(0),T(0),U(""),await K()}catch(ne){console.error("handleRequestSubmit",ne),c((ne==null?void 0:ne.message)||"Errore invio richiesta straordinario")}finally{N(!1)}}async function X(){b(!0);try{await Promise.all([_(),K()]),l("Aggiornato")}catch(W){console.error("refresh straordinari error",W),c("Errore aggiornamento")}finally{b(!1)}}const se=W=>{if(k(W??null),W){const G=Ys(W.requestableHours),B=Math.floor(G/60),ne=G%60;j(B),T(ne)}else j(0),T(0)};return e.jsxs("div",{className:"bg-gray-900 p-4 rounded border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Richieste Straordinari"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Richiedi straordinario se autorizzato e se hai lavorato oltre le ore assegnate"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:X,className:"p-2 rounded bg-gray-800 hover:bg-gray-700",title:"Aggiorna",children:e.jsx(Ms,{})})})]}),e.jsx("div",{className:"mb-4",children:v===null?e.jsx("div",{className:"text-sm text-gray-400",children:"Verifica autorizzazione..."}):v===!1?e.jsx("div",{className:"text-sm text-red-300",children:"Non risulti autorizzato agli straordinari dal tuo contratto."}):e.jsx("div",{className:"text-sm text-green-300",children:"Sei autorizzato agli straordinari."})}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Turni con ore eccedenti"}),u?e.jsx("div",{className:"text-sm text-gray-400",children:"Caricamento..."}):g.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"Nessun turno con ore eccedenti rilevato."}):e.jsx("div",{className:"space-y-3",children:g.map(W=>e.jsxs("div",{className:"bg-gray-800 p-3 rounded border border-gray-700 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:W.title}),e.jsx("div",{className:"text-sm text-gray-300",children:W.date?new Date(W.date).toLocaleDateString("it-IT"):"-"}),e.jsxs("div",{className:"text-sm text-gray-300 mt-2",children:["Previsto: ",sr(Ys(W.scheduledHours))," ‚Ä¢ Lavorato: ",sr(Ys(W.workedHours))]}),e.jsxs("div",{className:"text-sm font-semibold text-yellow-400 mt-1",children:["Richiedibili: ",sr(Ys(W.requestableHours)),W.excessHours!==W.requestableHours&&e.jsxs("span",{className:"text-xs text-gray-400 ml-1",children:["(su ",sr(Ys(W.excessHours))," effettivi)"]})]})]}),e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx("button",{onClick:()=>se(W),className:"py-2 px-3 rounded bg-yellow-600 text-black mb-2",children:"Richiedi"}),e.jsxs("div",{className:"text-xs text-gray-400",children:["Fonte: ",W.source==="warehouse"?"Magazzino":"Evento"]})]})]},W.assignment_id))})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Richiesta manuale"}),e.jsx("p",{className:"text-sm text-gray-400 mb-2",children:"Se non vedi il turno ma sei autorizzato, puoi creare una richiesta manuale (ammessa solo se autorizzato)."}),e.jsx("div",{className:"flex gap-3",children:e.jsx("button",{onClick:()=>{D(!0),se(void 0)},className:"py-2 px-3 rounded bg-blue-600 text-white",children:"Crea richiesta manuale"})})]}),(p!==null||P)&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4",children:e.jsxs("div",{className:"w-full max-w-lg bg-gray-900 rounded p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:P?"Richiesta Straordinario (manuale)":`Richiesta per ${p==null?void 0:p.title}`}),e.jsx("button",{onClick:()=>{k(null),D(!1),j(0),T(0),U("")},className:"text-gray-400",children:"Chiudi"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[!P&&p&&e.jsxs("div",{className:"bg-yellow-900/20 border border-yellow-600/30 rounded p-3 mb-2",children:[e.jsxs("div",{className:"text-sm text-yellow-400 font-semibold",children:["Massimo richiedibile: ",sr(Ys(p.requestableHours))]}),p.excessHours!==p.requestableHours&&e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["Ore effettive: ",sr(Ys(p.excessHours))," (arrotondato a multipli di 30 min)"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300 mb-2 block",children:"Ore e minuti da richiedere (tagli di 30 minuti)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-400 mb-1 block",children:"Ore"}),e.jsx("input",{type:"number",min:"0",max:p?Math.floor(Ys(p.requestableHours)/60):24,value:R,onChange:W=>j(parseInt(W.target.value)||0),className:"w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-center text-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-400 mb-1 block",children:"Minuti"}),e.jsxs("select",{value:M,onChange:W=>T(parseInt(W.target.value)),className:"w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-center text-lg",children:[e.jsx("option",{value:"0",children:"00"}),e.jsx("option",{value:"30",children:"30"})]})]})]}),e.jsxs("div",{className:"text-xs text-gray-400 mt-2 text-center",children:["Totale: ",sr(R*60+M)]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Note"}),e.jsx("textarea",{value:F,onChange:W=>U(W.target.value),rows:3,placeholder:"Descrivi il motivo della richiesta...",className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-2 py-2"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>O(p??void 0),disabled:te,className:"flex-1 py-3 rounded bg-yellow-600 text-black",children:te?"Invio...":"Invia richiesta"}),e.jsx("button",{onClick:()=>{k(null),D(!1)},className:"px-4 py-3 rounded border border-gray-700",children:"Annulla"})]})]})]})})]})},ua=n=>n?new Date(n).toLocaleDateString("it-IT"):"-",Nd=()=>{const{user:n}=Pt(),{showError:l}=ms(),[c,u]=w.useState(!0),[f,x]=w.useState([]),[b,v]=w.useState(""),[S,g]=w.useState(""),[E,p]=w.useState("");w.useEffect(()=>{if(!(n!=null&&n.id)){u(!1);return}k().catch(T=>{console.error("loadAll error",T),l("Errore caricamento riepilogo")})},[n==null?void 0:n.id]);async function k(){u(!0);try{const[T,F,U]=await Promise.all([P().catch(N=>(console.warn("loadVacations failed",N),[])),D().catch(N=>(console.warn("loadExpenses failed",N),[])),R().catch(N=>(console.warn("loadStraordinari failed (maybe table missing)",N),[]))]),te=[...T,...F,...U].sort((N,_)=>{const V=N.dateForFilter?new Date(N.dateForFilter).getTime():0;return(_.dateForFilter?new Date(_.dateForFilter).getTime():0)-V});x(te)}finally{u(!1)}}async function P(){if(!(n!=null&&n.id))return[];const T=[];try{const{data:F,error:U}=await Se.from("crew_richiesteferie_permessi").select("*").eq("dipendente_id",n.id).order("created_at",{ascending:!1}).limit(1e3);if(U)throw U;return(F||[]).forEach(te=>{T.push({id:String(te.id),kind:"vacation",title:te.tipo_richiesta??"Ferie/Permesso",start_date:te.data_inizio??te.start_date??null,end_date:te.data_fine??te.end_date??null,days:te.giorni_richiesti??null,status:te.stato??null,raw:te,dateForFilter:te.data_inizio??te.start_date??te.created_at??null})}),T}catch(F){throw console.error("loadVacations error",F),F}}async function D(){if(!(n!=null&&n.id))return[];const T=[];try{const{data:F,error:U}=await Se.from("expenses").select("*").eq("crew_id",n.id).order("expense_date",{ascending:!1}).limit(1e3);if(U)throw U;return(F||[]).forEach(te=>{T.push({id:String(te.id),kind:"expense",title:te.category??"Spesa",amount:Number(te.amount??0),expense_date:te.expense_date??null,status:te.status??null,raw:te,dateForFilter:te.expense_date??te.submitted_at??null})}),T}catch(F){throw console.error("loadExpenses error",F),F}}async function R(){if(!(n!=null&&n.id))return[];const T=["crew_richieste_straordinari","crew_straordinari","straordinari"];for(const F of T)try{const{data:U,error:te}=await Se.from(F).select("*").eq("dipendente_id",n.id).limit(1e3);if(te){console.warn(`loadStraordinari: table ${F} query error`,te);continue}if(!U)continue;return U.map(N=>({id:String(N.id),kind:"straordinario",title:N.tipo??N.title??"Straordinario",date:N.data??N.date??N.created_at??null,hours:N.ore??N.hours??null,status:N.stato??N.status??null,raw:N,dateForFilter:N.data??N.date??N.created_at??null}))}catch(U){console.warn(`loadStraordinari: table ${F} fetch failed`,U);continue}return[]}function j(T){var F,U,te,N,_,V,C,K;if(b&&(!T.dateForFilter||new Date(T.dateForFilter)<new Date(b)))return!1;if(S){if(!T.dateForFilter)return!1;const O=new Date(T.dateForFilter),X=new Date(S);if(X.setHours(23,59,59,999),O>X)return!1}if(E){const O=E.toLowerCase(),X=[];if(T.kind==="vacation"?X.push(T.title,String(((F=T.raw)==null?void 0:F.motivo)??""),String(((U=T.raw)==null?void 0:U.azienda_id)??""),String(((te=T.raw)==null?void 0:te.event_title)??"")):T.kind==="expense"?X.push(T.title,String(((N=T.raw)==null?void 0:N.description)??""),String(((_=T.raw)==null?void 0:_.notes)??""),String(((V=T.raw)==null?void 0:V.company_name)??"")):X.push(T.title,String(((C=T.raw)==null?void 0:C.motivo)??""),String(((K=T.raw)==null?void 0:K.description)??"")),!X.filter(Boolean).join(" ").toLowerCase().includes(O))return!1}return!0}const M=f.filter(j);return e.jsxs("div",{className:"bg-gray-900 p-4 rounded border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Riepilogo Richieste"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Visualizza tutte le tue richieste: ferie, note spese e straordinari"})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("button",{title:"Aggiorna",onClick:()=>k().catch(T=>console.error(T)),className:"p-2 rounded bg-gray-800 hover:bg-gray-700",children:e.jsx(Ms,{})})})]}),e.jsxs("div",{className:"bg-gray-800 p-3 rounded mb-4 grid grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Da"}),e.jsx("input",{type:"date",value:b,onChange:T=>v(T.target.value),className:"mt-1 w-full bg-gray-900 border border-gray-700 rounded px-2 py-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"A"}),e.jsx("input",{type:"date",value:S,onChange:T=>g(T.target.value),className:"mt-1 w-full bg-gray-900 border border-gray-700 rounded px-2 py-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Cerca"}),e.jsx("input",{type:"text",placeholder:"Evento, descrizione...",value:E,onChange:T=>p(T.target.value),className:"mt-1 w-full bg-gray-900 border border-gray-700 rounded px-2 py-1"})]})]}),e.jsx("div",{children:c?e.jsx("div",{className:"text-sm text-gray-400",children:"Caricamento..."}):M.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"Nessuna richiesta trovata"}):e.jsx("div",{className:"space-y-3",children:M.map(T=>{var F,U,te;return e.jsxs("div",{className:"bg-gray-800 p-3 rounded border border-gray-700 flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-sm px-2 py-1 rounded-full bg-gray-700 text-gray-200 font-medium",children:T.kind.toUpperCase()}),e.jsx("div",{className:"font-medium text-white",children:T.title})]}),T.kind==="vacation"&&e.jsxs("div",{className:"text-sm text-gray-300 mt-2",children:[ua(T.start_date),T.end_date?` ‚Äî ${ua(T.end_date)}`:""," ",T.days?` ‚Ä¢ ${T.days} giorno/i`:"",(F=T.raw)!=null&&F.motivo?e.jsxs("div",{className:"mt-1",children:["Motivo: ",String(T.raw.motivo)]}):null]}),T.kind==="expense"&&e.jsxs("div",{className:"text-sm text-gray-300 mt-2",children:[T.amount!==void 0?e.jsxs(e.Fragment,{children:["‚Ç¨",Number(T.amount).toFixed(2)," ‚Ä¢ "]}):null,ua(T.expense_date)," ‚Ä¢ ",String(((U=T.raw)==null?void 0:U.description)??"")]}),T.kind==="straordinario"&&e.jsxs("div",{className:"text-sm text-gray-300 mt-2",children:[ua(T.date)," ",T.hours?`‚Ä¢ ${T.hours}h`:null,(te=T.raw)!=null&&te.motivo?e.jsxs("div",{className:"mt-1",children:["Motivo: ",String(T.raw.motivo)]}):null]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:`text-xs px-2 py-1 rounded-full ${T.status==="approved"?"bg-green-100 text-green-800":T.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:T.status==="approved"?"Approvato":T.status==="rejected"?"Rifiutato":T.status??"In attesa"}),e.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["ID: ",T.id]})]})]},`${T.kind}_${T.id}`)})})})]})},Jn=[{key:"ferie",label:"Ferie",Icon:xt},{key:"spese",label:"Spese",Icon:qt},{key:"straordinari",label:"Ore",Icon:ht},{key:"riepilogo",label:"Riepilogo",Icon:po}],jd=()=>{const[n,l]=w.useState("ferie");return w.useEffect(()=>{window.scrollTo({top:0,behavior:"smooth"})},[n]),e.jsxs("div",{className:"min-h-screen bg-neutral-950 text-gray-100",children:[e.jsxs("header",{className:"sticky top-0 z-40 bg-gray-900/95 backdrop-blur-sm border-b border-gray-800",children:[e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-3 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg md:text-2xl font-semibold leading-tight",children:"Richieste"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-400 mt-0.5",children:"Gestisci ferie, note spese, straordinari e riepiloghi"})]}),e.jsx("div",{className:"hidden md:flex items-center space-x-2",children:e.jsx("div",{className:"text-sm text-gray-400",children:" "})})]}),e.jsx("nav",{className:"overflow-x-auto no-scrollbar",children:e.jsx("div",{className:"max-w-4xl mx-auto px-2 py-2 flex items-center space-x-2",children:Jn.map(c=>{const u=n===c.key;return e.jsxs("button",{onClick:()=>l(c.key),className:`flex-shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium transition-all ${u?"bg-gradient-to-r from-blue-600 to-cyan-500 text-white shadow":"bg-gray-800 text-gray-200"}`,"aria-pressed":u,children:[e.jsx(c.Icon,{className:"h-4 w-4"}),e.jsx("span",{className:"whitespace-nowrap",children:c.label})]},c.key)})})})]}),e.jsx("main",{className:"pb-28 md:pb-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 md:px-6 pt-4 space-y-6",children:[n==="ferie"&&e.jsx("section",{children:e.jsx(bd,{})}),n==="spese"&&e.jsx("section",{children:e.jsx(yd,{})}),n==="straordinari"&&e.jsx("section",{children:e.jsx(vd,{})}),n==="riepilogo"&&e.jsx("section",{children:e.jsx(Nd,{})})]})}),e.jsx("nav",{className:"fixed bottom-0 left-0 right-0 z-50 md:hidden bg-gray-900 border-t border-gray-800",children:e.jsx("div",{className:"max-w-4xl mx-auto px-2",children:e.jsx("div",{className:"flex justify-between items-center",children:Jn.map(c=>{const u=n===c.key;return e.jsxs("button",{onClick:()=>l(c.key),className:`w-full py-3 flex flex-col items-center text-xs ${u?"text-white":"text-gray-400"} focus:outline-none`,"aria-pressed":u,children:[e.jsx(c.Icon,{className:"h-5 w-5"}),e.jsx("span",{className:"mt-1",children:c.label})]},c.key)})})})})]})},Cd="https://idewdhvmcyhpgvpmkefd.supabase.co",Ed="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkZXdkaHZtY3locGd2cG1rZWZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU1ODgxNDMsImV4cCI6MjA1MTE2NDE0M30.RAIBKUjHAbx_a5_KUvs-Loc2hNd6SU6etOEczz4-moQ";let qa=null;function Sd(){return qa||(qa=ei(Cd,Ed,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,flowType:"pkce",storageKey:"company-app-auth",storage:window.localStorage}})),qa}const Le=Sd(),Bi=w.createContext(void 0),Ad=({children:n})=>{const[l,c]=w.useState(null),[u,f]=w.useState(null),[x,b]=w.useState(!0);w.useEffect(()=>{Le.auth.getSession().then(({data:{session:p}})=>{c((p==null?void 0:p.user)??null),p!=null&&p.user?v(p.user.id):b(!1)});const{data:{subscription:E}}=Le.auth.onAuthStateChange((p,k)=>{c((k==null?void 0:k.user)??null),k!=null&&k.user?v(k.user.id):(f(null),b(!1))});return()=>E.unsubscribe()},[]);const v=async E=>{try{const{data:p,error:k}=await Le.from("registration_requests").select("parent_company_id").eq("auth_user_id",E).maybeSingle();if(!k&&p&&p.parent_company_id)throw console.error("‚ùå L'utente √® un dipendente, non un'azienda"),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("EMPLOYEE_LOGIN");const{data:P,error:D}=await Le.from("regaziendasoftware").select("*").eq("auth_user_id",E).maybeSingle();if(D)throw D;if(!P)throw setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("Accesso non autorizzato. Solo aziende possono accedere.");const{data:R,error:j}=await Le.from("azienda_software").select("data_scadenza, stato").eq("auth_user_id",E).eq("software_codice","app_crew_azienda").maybeSingle();if(!j&&R){if(R.stato!=="attivo")throw console.error("‚ùå Abbonamento non attivo. Stato:",R.stato),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("SUBSCRIPTION_INACTIVE");if(R.data_scadenza){const M=new Date(R.data_scadenza),T=new Date;if(T.setHours(0,0,0,0),M.setHours(0,0,0,0),T>M)throw console.error("‚ùå Abbonamento scaduto il:",M.toLocaleDateString()),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("SUBSCRIPTION_EXPIRED")}}if(P.password_scadenza){const M=new Date(P.password_scadenza);if(new Date>M)throw console.error("‚ùå Password scaduta:",M),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("PASSWORD_EXPIRED")}console.log("‚úÖ Azienda verificata:",P.ragione_sociale),f(P)}catch(p){throw console.error("Error loading company profile:",p),f(null),p}finally{b(!1)}},S=async(E,p)=>{try{console.log("üîë Tentativo login azienda per:",E);const{data:k,error:P}=await Le.auth.signInWithPassword({email:E,password:p});if(P)throw console.error("‚ùå Errore autenticazione:",P.message),P;if(!k.user)throw new Error("Dati utente non validi");console.log("‚úÖ Login Supabase riuscito per:",k.user.email);const{data:D,error:R}=await Le.from("registration_requests").select("parent_company_id").eq("auth_user_id",k.user.id).maybeSingle();if(!R&&D&&D.parent_company_id)throw console.error("‚ùå L'utente √® un dipendente, non un'azienda"),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("EMPLOYEE_LOGIN");const{data:j,error:M}=await Le.from("regaziendasoftware").select("*").eq("auth_user_id",k.user.id).maybeSingle();if(M)throw M;if(!j)throw console.error("‚ùå Profilo azienda non trovato"),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("Accesso non autorizzato. Solo aziende possono accedere.");const{data:T,error:F}=await Le.from("azienda_software").select("data_scadenza, stato").eq("auth_user_id",k.user.id).eq("software_codice","app_crew_azienda").maybeSingle();if(!F&&T){if(T.stato!=="attivo")throw console.error("‚ùå Abbonamento non attivo. Stato:",T.stato),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("SUBSCRIPTION_INACTIVE");if(T.data_scadenza){const U=new Date(T.data_scadenza),te=new Date;if(te.setHours(0,0,0,0),U.setHours(0,0,0,0),te>U)throw console.error("‚ùå Abbonamento scaduto il:",U.toLocaleDateString()),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("SUBSCRIPTION_EXPIRED")}}if(j.password_scadenza){const U=new Date(j.password_scadenza);if(new Date>U)throw console.error("‚ùå Password scaduta:",U),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("PASSWORD_EXPIRED")}console.log("‚úÖ Azienda verificata:",j.ragione_sociale)}catch(k){throw console.error("Login error:",k),k}},g=async()=>{try{const{error:E}=await Le.auth.signOut();if(E)throw E;f(null)}catch(E){throw console.error("Errore durante il logout:",E),f(null),c(null),E}};return e.jsx(Bi.Provider,{value:{user:l,companyProfile:u,loading:x,signIn:S,signOut:g},children:n})},us=()=>{const n=w.useContext(Bi);if(n===void 0)throw new Error("useCompanyAuth must be used within a CompanyAuthProvider");return n},Fi=w.createContext(void 0),Id=({children:n})=>{const[l,c]=w.useState([]),u=w.useCallback((g,E)=>{const p=Math.random().toString(36).substring(7);c(k=>[...k,{id:p,message:g,type:E}]),setTimeout(()=>f(p),5e3)},[]),f=w.useCallback(g=>{c(E=>E.filter(p=>p.id!==g))},[]),x=w.useCallback(g=>{u(g,"success")},[u]),b=w.useCallback(g=>{u(g,"error")},[u]),v=w.useCallback(g=>{u(g,"info")},[u]),S=w.useCallback(g=>{u(g,"warning")},[u]);return e.jsx(Fi.Provider,{value:{toasts:l,addToast:u,removeToast:f,showSuccess:x,showError:b,showInfo:v,showWarning:S},children:n})},Tr=()=>{const n=w.useContext(Fi);if(n===void 0)throw new Error("useToast must be used within a ToastProvider");return n},Dr=Tr,Td=({toast:n,onRemove:l})=>{w.useEffect(()=>{const x=setTimeout(()=>{l(n.id)},n.duration||5e3);return()=>clearTimeout(x)},[n.id,n.duration,l]);const c=()=>{switch(n.type){case"success":return e.jsx(pt,{className:"h-7 w-7 text-green-500"});case"error":return e.jsx(Ka,{className:"h-7 w-7 text-red-500"});case"warning":return e.jsx(Zt,{className:"h-7 w-7 text-yellow-500"});case"info":return e.jsx(xa,{className:"h-7 w-7 text-blue-500"});default:return e.jsx(xa,{className:"h-7 w-7 text-blue-500"})}},u=()=>{switch(n.type){case"success":return"bg-white border-green-300 shadow-green-100";case"error":return"bg-white border-red-300 shadow-red-100";case"warning":return"bg-white border-yellow-300 shadow-yellow-100";case"info":return"bg-white border-blue-300 shadow-blue-100";default:return"bg-white border-blue-300 shadow-blue-100"}},f=()=>{switch(n.type){case"success":return"text-green-700";case"error":return"text-red-700";case"warning":return"text-yellow-700";case"info":return"text-blue-700";default:return"text-blue-700"}};return e.jsx("div",{className:`min-w-96 max-w-lg w-full border-2 rounded-xl shadow-2xl pointer-events-auto ${u()} mx-auto transform transition-all duration-300 ease-out`,children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0",children:c()}),e.jsxs("div",{className:"ml-4 w-0 flex-1",children:[e.jsx("p",{className:`text-lg font-semibold ${f()} leading-tight`,children:n.title}),n.message&&e.jsx("p",{className:`mt-3 text-base ${f()} opacity-90 leading-relaxed`,children:n.message})]}),e.jsx("div",{className:"ml-4 flex-shrink-0 flex",children:e.jsxs("button",{className:`rounded-full inline-flex ${f()} hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 p-2 transition-all duration-200 hover:bg-white hover:bg-opacity-20`,onClick:()=>l(n.id),children:[e.jsx("span",{className:"sr-only",children:"Chiudi"}),e.jsx(Et,{className:"h-5 w-5"})]})})]})})})},Dd=({toasts:n,onRemoveToast:l})=>e.jsx("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 space-y-4 pointer-events-none",children:n.map(c=>e.jsx("div",{className:"transform transition-all duration-300 ease-in-out pointer-events-auto",children:e.jsx(Td,{toast:c,onRemove:l})},c.id))}),kd=()=>{const[n,l]=w.useState(""),[c,u]=w.useState(""),[f,x]=w.useState(!1),[b,v]=w.useState("1.0.0"),[S,g]=w.useState("Dicembre 2025"),{signIn:E}=us(),{addToast:p}=Tr(),k=D=>{const R=new Date(D),M=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][R.getMonth()],T=R.getFullYear();return`${M} ${T}`};w.useEffect(()=>{(async()=>{try{const{data:R,error:j}=await Le.from("software_versions").select("current_version, release_date").eq("software_code","app_crew_azienda").eq("is_active",!0).order("release_date",{ascending:!1}).limit(1).maybeSingle();R&&!j&&(v(R.current_version),g(k(R.release_date)))}catch(R){console.error("Errore caricamento versione:",R)}})()},[]);const P=async D=>{D.preventDefault(),x(!0);try{await E(n,c),p("Accesso effettuato con successo","success")}catch(R){console.error("Errore login azienda:",R);let j="Errore durante l'accesso";R.message==="EMPLOYEE_LOGIN"?j="Accesso negato. Sei un dipendente, usa l'App Dipendenti per accedere.":R.message==="SUBSCRIPTION_EXPIRED"?j="Abbonamento scaduto. Contatta l'amministratore per rinnovare.":R.message==="SUBSCRIPTION_INACTIVE"?j="Abbonamento non attivo. Contatta l'amministratore.":R.message==="PASSWORD_EXPIRED"?j="Password scaduta. Contatta l'amministratore per reimpostarla.":R.message&&(j=R.message),p(j,"error")}finally{x(!1)}};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-cyan-100 flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white rounded-2xl shadow-xl p-8",children:[e.jsxs(Ei,{to:"/",className:"inline-flex items-center text-sm text-gray-600 hover:text-blue-600 mb-6 transition-colors",children:[e.jsx(bo,{className:"w-4 h-4 mr-1"}),"Torna al login dipendenti"]}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-full mb-4",children:e.jsx(Rt,{className:"w-8 h-8 text-white"})}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Crew Manager"}),e.jsx("p",{className:"text-gray-600",children:"Pannello Azienda"})]}),e.jsxs("form",{onSubmit:P,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-2",children:"Email Aziendale"}),e.jsxs("div",{className:"relative",children:[e.jsx(fa,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{id:"email",type:"email",value:n,onChange:D=>l(D.target.value),required:!0,className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"azienda@esempio.it"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-2",children:"Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(ri,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{id:"password",type:"password",value:c,onChange:D=>u(D.target.value),required:!0,className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"})]})]}),e.jsx("button",{type:"submit",disabled:f,className:"w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-colors",children:f?"Accesso in corso...":e.jsxs(e.Fragment,{children:[e.jsx(ti,{className:"w-5 h-5"}),"Accedi"]})})]}),e.jsx("div",{className:"mt-6 text-center text-sm text-gray-600",children:e.jsx("p",{children:"Solo per aziende registrate"})}),e.jsxs("div",{className:"mt-6 pt-4 border-t border-gray-200 text-center",children:[e.jsxs("p",{className:"text-xs text-gray-500",children:["Versione ",b," - ",S]}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"¬© 2025 ControlStage - Crew Manager Azienda"})]})]})})},Md=()=>{const[n,l]=w.useState({currentVersion:null,latestVersion:null,releaseNotes:null,hasUpdate:!1,isLoading:!1,isUpdating:!1,error:null}),[c,u]=w.useState(0),f=5*60*1e3,x=w.useCallback(()=>{const k=new URLSearchParams(window.location.search).get("_v");return k?(localStorage.setItem("app_crew_azienda_version",k),k):localStorage.getItem("app_crew_azienda_version")},[]),b=w.useCallback(()=>new URLSearchParams(window.location.search).get("_updated")==="true",[]),v=w.useCallback(async()=>{try{console.log("üîç Controllo versione da database per software_code: app_crew_azienda");const{data:p,error:k}=await Le.from("software_versions").select("*").eq("software_code","app_crew_azienda").eq("is_active",!0).order("release_date",{ascending:!1}).limit(1).maybeSingle();return k?(console.error("‚ùå Errore caricamento versione da database:",k),await S()):p?(console.log("‚úÖ Versione caricata da database:",p.current_version),{version:p.current_version,buildTimestamp:p.release_date,features:Array.isArray(p.features)?p.features:[],releaseNotes:p.release_notes||"",description:p.description||""}):(console.warn("‚ö†Ô∏è Nessuna versione attiva trovata nel database per app_crew_azienda"),await S())}catch(p){return console.error("‚ùå Errore generale nel controllo versione database:",p),await S()}},[]),S=w.useCallback(async()=>{try{console.log("üìÑ Fallback: caricamento versione da file statico");const p=Date.now(),k=await fetch(`/version.json?_t=${p}`,{method:"GET",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}});if(!k.ok)throw new Error(`HTTP ${k.status}: ${k.statusText}`);const P=await k.json();return console.log("‚úÖ Versione caricata da file statico:",P.version),P}catch(p){return console.error("‚ùå Errore nel fetch versione da file:",p),null}},[]),g=w.useCallback(async(p=!1)=>{const k=Date.now();if(!p&&k-c<f||n.isLoading||n.isUpdating)return!1;l(P=>({...P,isLoading:!0,error:null})),u(k);try{const P=x(),D=await v();if(!D)return l(j=>({...j,isLoading:!1,error:"Impossibile verificare aggiornamenti"})),!1;const R=P!==D.version;return l(j=>({...j,currentVersion:P,latestVersion:D.version,releaseNotes:D.releaseNotes||null,hasUpdate:R,isLoading:!1,error:null})),console.log("üîç Controllo versione:",{current:P,latest:D.version,hasUpdate:R,buildTime:D.buildTimestamp}),R}catch(P){return console.error("Errore nel controllo versioni:",P),l(D=>({...D,isLoading:!1,error:"Errore controllo versioni"})),!1}},[x,v,c,n.isLoading,n.isUpdating,f]),E=w.useCallback(async()=>{if(!(n.isUpdating||!n.hasUpdate)){l(p=>({...p,isUpdating:!0}));try{if(console.log("üîÑ Applicazione aggiornamento..."),"caches"in window){const P=await caches.keys();await Promise.all(P.map(D=>caches.delete(D))),console.log("üóëÔ∏è Cache cancellate:",P.length)}n.latestVersion&&(localStorage.setItem("app_crew_azienda_version",n.latestVersion),localStorage.setItem("app_crew_azienda_last_update",new Date().toISOString()));const p=Date.now(),k=new URL(window.location.href);k.searchParams.set("_v",n.latestVersion||""),k.searchParams.set("_t",p.toString()),k.searchParams.set("_updated","true"),console.log("üöÄ Reindirizzamento a:",k.toString()),window.location.href=k.toString()}catch(p){console.error("Errore nell'applicazione aggiornamento:",p),l(k=>({...k,isUpdating:!1,error:"Errore durante aggiornamento"}))}}},[n.isUpdating,n.hasUpdate,n.latestVersion]);return w.useEffect(()=>{(async()=>{let P=x();if(P)l(D=>({...D,currentVersion:P}));else{const D=await v();D&&(P=D.version,localStorage.setItem("app_crew_azienda_version",P),l(R=>({...R,currentVersion:P,latestVersion:P,hasUpdate:!1})))}})(),b()||(async()=>(await new Promise(D=>setTimeout(D,2e3)),await g(!1)))();const k=()=>{g(!1)};return window.addEventListener("focus",k),()=>{window.removeEventListener("focus",k)}},[g,x,b,v]),{...n,checkForUpdates:p=>g(p||!1),applyUpdate:E}},zd=({currentVersion:n,hasUpdate:l,isLoading:c,isUpdating:u,onCheckUpdate:f})=>{const x=()=>u?e.jsx(Ms,{className:"h-4 w-4 animate-spin text-blue-500"}):c?e.jsx(Ms,{className:"h-4 w-4 animate-spin text-gray-500"}):l?e.jsx(cr,{className:"h-4 w-4 text-orange-500"}):e.jsx(pt,{className:"h-4 w-4 text-green-500"}),b=()=>u?"Aggiornamento...":c?"Controllo...":l?"Aggiornamento disponibile":"Aggiornato",v=()=>u?"text-blue-600":c?"text-gray-500":l?"text-orange-600":"text-green-600",S=`Versione ${n||"Sconosciuta"} - ${b()}`;return e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:f,disabled:c||u,className:`sm:hidden inline-flex items-center space-x-1 px-2 py-1 rounded-md transition-colors text-xs
          ${l?"bg-orange-100 hover:bg-orange-200 text-orange-800":"bg-gray-100 hover:bg-gray-200 text-gray-700"}
          disabled:opacity-50 disabled:cursor-not-allowed`,title:S,"aria-label":S,type:"button",children:[x(),e.jsxs("span",{className:"font-medium text-[11px]",children:["v",n||"?"]})]}),e.jsxs("button",{onClick:f,disabled:c||u,className:`hidden sm:flex items-center space-x-1.5 px-2 py-1 rounded-md transition-colors ${l?"bg-orange-100 hover:bg-orange-200 text-orange-800":"bg-gray-100 hover:bg-gray-200 text-gray-700"} disabled:opacity-50 disabled:cursor-not-allowed`,title:S,type:"button",children:[e.jsx("div",{className:"scale-75",children:x()}),e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"text-[10px] font-medium leading-tight",children:["v",n||"?"]}),e.jsx("div",{className:`text-[9px] leading-tight ${v()}`,children:b()})]})]})]})},Od=()=>{const{signOut:n,user:l}=us(),[c,u]=kt.useState(!1),{showSuccess:f,showInfo:x}=Tr(),{currentVersion:b,hasUpdate:v,isLoading:S,isUpdating:g,checkForUpdates:E,applyUpdate:p}=Md(),k=async()=>{v?(x("Aggiornamento in corso..."),await p()):await E(!0)?x("Aggiornamento disponibile! Clicca nuovamente per aggiornare."):f("Stai usando la versione piu recente!")},P=async()=>{try{await n(),f("Logout effettuato con successo")}catch(D){console.error("Errore logout:",D)}};return e.jsx("header",{className:"sticky top-0 z-40 bg-gray-800 border-b border-gray-700 shadow-lg",children:e.jsx("div",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 bg-blue-600 rounded-lg",children:e.jsx(Rt,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-white",children:"CREW MANAGER"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Pannello Azienda"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(zd,{currentVersion:b,hasUpdate:v,isLoading:S,isUpdating:g,onCheckUpdate:k}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>u(!c),className:"p-2 text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(Ja,{className:"w-6 h-6"})}),c&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>u(!1)}),e.jsxs("div",{className:"absolute right-0 mt-2 w-56 bg-gray-800 rounded-lg shadow-xl border border-gray-700 z-50",children:[e.jsxs("div",{className:"p-4 border-b border-gray-700",children:[e.jsx("p",{className:"text-sm text-gray-400",children:"Accesso come:"}),e.jsx("p",{className:"text-sm font-medium text-white truncate",children:l==null?void 0:l.email})]}),e.jsx("div",{className:"p-2",children:e.jsxs("button",{onClick:P,className:"w-full flex items-center space-x-2 px-3 py-2 text-red-400 hover:bg-gray-700 rounded-lg transition-colors",children:[e.jsx(va,{className:"w-5 h-5"}),e.jsx("span",{children:"Esci"})]})})]})]})]})]})]})})})},Rd=({activeTab:n,onTabChange:l})=>{const c=[{id:"dashboard",label:"Home",icon:ii,description:"Dashboard principale"},{id:"checkin",label:"Check-In",icon:wo,description:"Monitor presenze"},{id:"events",label:"Eventi",icon:os,description:"Assegna crew agli eventi"},{id:"courses",label:"Corsi",icon:ui,description:"Gestione corsi"},{id:"shifts",label:"Turni",icon:ht,description:"Gestione turni"},{id:"calendar",label:"Calendario",icon:xt,description:"I miei eventi"},{id:"expenses",label:"Richieste",icon:qt,description:"Richieste e Rimborsi"},{id:"talk",label:"Talk",icon:yo,description:"Talk"},{id:"profile",label:"Profilo",icon:Xr,description:"Il mio profilo"}];return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        @keyframes pulse-red {
          0%, 100% {
            background-color: rgb(220, 38, 38);
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
          }
          50% {
            background-color: rgb(185, 28, 28);
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.8);
          }
        }
        .animate-pulse-red {
          animation: pulse-red 1s ease-in-out infinite;
        }
      `}),e.jsx("nav",{className:"fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 z-50 shadow-lg pb-safe",children:e.jsxs("div",{className:"relative max-w-screen-lg mx-auto",children:[e.jsx("div",{className:"flex items-center gap-2 px-2 py-2 overflow-x-auto scrollbar-hide snap-x snap-mandatory",style:{scrollbarWidth:"none",msOverflowStyle:"none",WebkitOverflowScrolling:"touch"},children:c.map(u=>{const f=u.icon,x=n===u.id,b=u.id==="talk";return e.jsxs("button",{onClick:()=>l(u.id),className:`flex flex-col items-center space-y-0.5 px-4 py-1.5 rounded-lg transition-all duration-200 flex-shrink-0 w-[85px] snap-center ${b?"animate-pulse-red text-white shadow-lg":x?"bg-blue-600 text-white shadow-lg transform scale-105":"text-gray-400 hover:text-white hover:bg-gray-700"}`,title:u.description,children:[e.jsx(f,{className:`h-5 w-5 flex-shrink-0 ${x||b?"text-white":""}`}),e.jsx("span",{className:`text-[10px] font-medium leading-tight text-center ${x||b?"text-white":""}`,children:u.label}),x&&!b&&e.jsx("div",{className:"w-1 h-1 bg-cyan-400 rounded-full"})]},u.id)})}),e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-4 bg-gradient-to-r from-gray-800 to-transparent pointer-events-none"}),e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-4 bg-gradient-to-l from-gray-800 to-transparent pointer-events-none"})]})})]})},Ld=()=>{const{companyProfile:n}=us(),[l,c]=w.useState({totalEmployees:0,activeShifts:0,pendingRequests:0,pendingExpenses:0}),[u,f]=w.useState(!0);w.useEffect(()=>{n!=null&&n.id&&x()},[n==null?void 0:n.id]);const x=async()=>{if(n!=null&&n.id)try{f(!0);const b=new Date,v=b.getMonth(),S=b.getFullYear(),g=new Date(S,v,1).toISOString().split("T")[0],E=new Date(S,v+1,0).toISOString().split("T")[0],[p,k,P,D]=await Promise.all([Le.from("crew_members").select("id",{count:"exact",head:!0}).eq("company_id",n.id),Le.from("crew_assegnazione_turni").select("id",{count:"exact",head:!0}).eq("azienda_id",n.id).gte("data_turno",g).lte("data_turno",E),Le.from("crew_richiesteferie_permessi").select("id",{count:"exact",head:!0}).eq("azienda_id",n.id).eq("stato","in_attesa"),Le.from("crew_note_spese").select("id",{count:"exact",head:!0}).eq("azienda_id",n.id).eq("stato","in_attesa")]),R=p.count||0,j=k.count||0,M=P.count||0,T=D.count||0;console.log("Dashboard Stats:",{companyId:n.id,totalEmployees:R,activeShifts:j,pendingRequests:M,pendingExpenses:T}),c({totalEmployees:R,activeShifts:j,pendingRequests:M,pendingExpenses:T})}catch(b){console.error("Errore caricamento dashboard:",b)}finally{f(!1)}};return u?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"})}):e.jsxs("div",{className:"space-y-4 pb-20",children:[e.jsxs("div",{className:"bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl p-6 text-white",children:[e.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Dashboard Azienda"}),e.jsx("p",{className:"text-blue-100",children:n==null?void 0:n.ragione_sociale})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-blue-500/20 rounded-lg",children:e.jsx(os,{className:"h-5 w-5 text-blue-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:l.totalEmployees}),e.jsx("p",{className:"text-sm text-gray-400",children:"Dipendenti"})]})]})}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-green-500/20 rounded-lg",children:e.jsx(xt,{className:"h-5 w-5 text-green-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:l.activeShifts}),e.jsx("p",{className:"text-sm text-gray-400",children:"Turni mese"})]})]})}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-yellow-500/20 rounded-lg",children:e.jsx(Nt,{className:"h-5 w-5 text-yellow-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:l.pendingRequests}),e.jsx("p",{className:"text-sm text-gray-400",children:"Richieste"})]})]})}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-orange-500/20 rounded-lg",children:e.jsx(qt,{className:"h-5 w-5 text-orange-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:l.pendingExpenses}),e.jsx("p",{className:"text-sm text-gray-400",children:"Note spese"})]})]})})]}),(l.pendingRequests>0||l.pendingExpenses>0)&&e.jsx("div",{className:"bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Nt,{className:"h-5 w-5 text-yellow-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-yellow-200 mb-1",children:"Azioni in sospeso"}),e.jsxs("ul",{className:"text-sm text-yellow-100 space-y-1",children:[l.pendingRequests>0&&e.jsxs("li",{children:["‚Ä¢ ",l.pendingRequests," ",l.pendingRequests===1?"richiesta":"richieste"," ferie/permessi da approvare"]}),l.pendingExpenses>0&&e.jsxs("li",{children:["‚Ä¢ ",l.pendingExpenses," ",l.pendingExpenses===1?"nota spese":"note spese"," da approvare"]})]})]})]})}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"font-semibold text-white mb-3",children:"Accesso Rapido"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("button",{className:"p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-left transition-colors",children:[e.jsx(os,{className:"h-5 w-5 text-blue-400 mb-1"}),e.jsx("p",{className:"text-sm font-medium text-white",children:"Dipendenti"})]}),e.jsxs("button",{className:"p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-left transition-colors",children:[e.jsx(xt,{className:"h-5 w-5 text-green-400 mb-1"}),e.jsx("p",{className:"text-sm font-medium text-white",children:"Calendario"})]}),e.jsxs("button",{className:"p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-left transition-colors",children:[e.jsx(qt,{className:"h-5 w-5 text-orange-400 mb-1"}),e.jsx("p",{className:"text-sm font-medium text-white",children:"Richieste"})]}),e.jsxs("button",{className:"p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-left transition-colors",children:[e.jsx(Na,{className:"h-5 w-5 text-purple-400 mb-1"}),e.jsx("p",{className:"text-sm font-medium text-white",children:"Report"})]})]})]})]})},cn=()=>e.jsxs("div",{className:"text-center text-gray-500 text-xs",children:[e.jsx("p",{children:"¬© 2025 ControlStage - Crew Manager Azienda V. 1.0.0"}),e.jsx("p",{children:"Tutti i diritti riservati - Software realizzato da ControlStage"})]}),Pd=()=>{const{companyProfile:n}=us(),{showError:l}=Dr(),[c,u]=w.useState(new Date),[f,x]=w.useState([]),[b,v]=w.useState([]),[S,g]=w.useState(!0),[E,p]=w.useState(null),[k,P]=w.useState(!1),[D,R]=w.useState("month");w.useEffect(()=>{n!=null&&n.id&&(M(),T())},[n==null?void 0:n.id]);const j=be=>{if(!be)return"bg-blue-500";const Z=["bg-blue-500","bg-green-500","bg-purple-500","bg-pink-500","bg-indigo-500","bg-red-500","bg-orange-500","bg-teal-500","bg-cyan-500","bg-emerald-500"];let L=0;for(let de=0;de<be.length;de++)L=be.charCodeAt(de)+((L<<5)-L);const re=Math.abs(L)%Z.length;return Z[re]},M=async()=>{if(n!=null&&n.id){g(!0);try{const be=[],{data:Z,error:L}=await Le.from("crew_events").select(`
          id,
          title,
          description,
          type,
          start_date,
          end_date,
          location,
          address,
          call_time,
          required_crew,
          event_group_code
        `).eq("company_id",n.id).order("start_date",{ascending:!0});L&&console.error("Errore caricamento eventi:",L);let re={};if(Z&&Z.length>0){const ve=Z.map(we=>we.id),{data:Te}=await Le.from("crew_event_assegnazione").select("evento_id").in("evento_id",ve);Te&&Te.forEach(we=>{re[we.evento_id]=(re[we.evento_id]||0)+1})}if(Z)for(const ve of Z){const Te=re[ve.id]||0,we=j(ve.event_group_code);be.push({id:ve.id,title:ve.title,description:ve.description||void 0,type:"event",date:ve.start_date,endDate:ve.end_date||ve.start_date,startTime:ve.call_time?ve.call_time.substring(0,5):"09:00",endTime:"18:00",location:ve.location||"Non specificato",address:ve.address||void 0,callTime:ve.call_time?ve.call_time.substring(0,5):void 0,companyName:(n==null?void 0:n.ragione_sociale)||"",assignedCrewCount:Te,requiredCrewCount:ve.required_crew||0,eventGroupCode:ve.event_group_code||void 0,color:we,raw:ve})}const{data:de,error:oe}=await Le.from("crew_corsi").select(`
          id,
          titolo,
          descrizione,
          data_corso,
          ora_inizio,
          ora_fine,
          luogo,
          istruttore,
          categoria,
          obbligatorio,
          max_partecipanti
        `).eq("azienda_id",n.id).order("data_corso",{ascending:!0});oe&&console.error("Errore caricamento corsi:",oe);let ge={};if(de&&de.length>0){const ve=de.map(we=>we.id),{data:Te}=await Le.from("crew_assegnazionecorsi").select("corso_id").in("corso_id",ve);Te&&Te.forEach(we=>{ge[we.corso_id]=(ge[we.corso_id]||0)+1})}if(de)for(const ve of de){const Te=ge[ve.id]||0;be.push({id:ve.id,title:ve.titolo,description:ve.descrizione||void 0,type:"course",date:ve.data_corso,endDate:ve.data_corso,startTime:ve.ora_inizio?ve.ora_inizio.substring(0,5):"09:00",endTime:ve.ora_fine?ve.ora_fine.substring(0,5):"17:00",location:ve.luogo,address:void 0,callTime:void 0,companyName:(n==null?void 0:n.ragione_sociale)||"",assignedCrewCount:Te,requiredCrewCount:ve.max_partecipanti||0,eventGroupCode:void 0,color:"bg-yellow-500",raw:ve})}x(be),console.log("üìÖ Eventi totali caricati:",be.length,{eventi:(Z==null?void 0:Z.length)||0,corsi:(de==null?void 0:de.length)||0})}catch(be){console.error("Errore nel caricamento eventi:",be),l("Errore","Impossibile caricare gli eventi"),x([])}finally{g(!1)}}},T=async()=>{if(n!=null&&n.id)try{const{data:be,error:Z}=await Le.from("crew_richiesteferie_permessi").select(`
          id,
          dipendente_id,
          tipo_richiesta,
          data_inizio,
          data_fine,
          motivo,
          dipendente_nome
        `).eq("stato","approvata").eq("azienda_id",n.id);if(Z)throw Z;const L=(be||[]).map(re=>({id:re.id,crewId:re.dipendente_id,crewName:re.dipendente_nome||"N/D",type:re.tipo_richiesta,startDate:re.data_inizio,endDate:re.data_fine,reason:re.motivo}));v(L),console.log("üìÖ Assenze caricate:",L.length)}catch(be){console.error("Errore nel caricamento assenze:",be)}},F=be=>{const Z=be.getFullYear(),L=String(be.getMonth()+1).padStart(2,"0"),re=String(be.getDate()).padStart(2,"0");return`${Z}-${L}-${re}`},U=()=>{u(new Date(c.getFullYear(),c.getMonth()-1,1))},te=()=>{u(new Date(c.getFullYear(),c.getMonth()+1,1))},N=()=>u(new Date),_=be=>{const Z=F(be);return b.filter(L=>Z>=L.startDate&&Z<=L.endDate)},V=be=>{const Z=be.getFullYear(),L=be.getMonth(),re=new Date(Z,L,1),oe=new Date(Z,L+1,0).getDate(),ge=[],ve=(re.getDay()+6)%7;for(let we=0;we<ve;we++){const je=new Date(Z,L,1-(ve-we));ge.push({date:je,isCurrentMonth:!1,isToday:!1,events:C(je),absences:_(je)})}for(let we=1;we<=oe;we++){const je=new Date(Z,L,we),Fe=C(je),Ve=_(je);ge.push({date:je,isCurrentMonth:!0,isToday:F(je)===F(new Date),events:Fe,absences:Ve})}const Te=42-ge.length;for(let we=1;we<=Te;we++){const je=new Date(Z,L+1,we);ge.push({date:je,isCurrentMonth:!1,isToday:!1,events:C(je),absences:_(je)})}return ge},C=be=>{const Z=F(be);return f.filter(L=>{const re=L.date,de=L.endDate||L.date;return Z>=re&&Z<=de}).sort((L,re)=>(L.startTime||"").localeCompare(re.startTime||""))},K=be=>{p(be),P(!0)},O=()=>{const be=c.getFullYear(),Z=c.getMonth(),L=new Date(be,Z,1),re=new Date(be,Z+1,0),de=F(L),oe=F(re),ve=f.filter(Ve=>Ve.date<=oe&&(Ve.endDate||Ve.date)>=de).sort((Ve,rt)=>Ve.date!==rt.date?Ve.date.localeCompare(rt.date):(Ve.startTime||"").localeCompare(rt.startTime||"")).reduce((Ve,rt)=>{const st=rt.date;return Ve[st]||(Ve[st]=[]),Ve[st].push(rt),Ve},{}),Te=b.filter(Ve=>Ve.startDate<=oe&&Ve.endDate>=de),we={};Te.forEach(Ve=>{const rt=new Date(Ve.startDate),st=new Date(Ve.endDate);for(let Je=new Date(rt);Je<=st;Je.setDate(Je.getDate()+1))if(Je.getMonth()===Z&&Je.getFullYear()===be){const Qe=F(Je);we[Qe]||(we[Qe]=[]),we[Qe].push(Ve)}});const je=new Set([...Object.keys(ve),...Object.keys(we)]),Fe=Array.from(je).sort();return e.jsx("div",{className:"space-y-4",children:Fe.length===0?e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 p-8 text-center",children:[e.jsx(xt,{className:"h-16 w-16 mx-auto mb-4 text-gray-600"}),e.jsx("p",{className:"text-base text-gray-400",children:"Nessun evento in questo mese"})]}):Fe.map(Ve=>{const rt=new Date(Ve+"T12:00:00"),st=F(rt)===F(new Date),Je=ve[Ve]||[],Qe=we[Ve]||[];return e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 overflow-hidden",children:[e.jsx("div",{className:`p-4 border-b border-gray-700 ${st?"bg-blue-600":"bg-gray-750"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-bold text-white",children:rt.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})}),st&&e.jsx("div",{className:"text-sm text-blue-100 mt-1",children:"Oggi"})]}),e.jsxs("div",{className:"text-sm text-gray-300 font-medium",children:[Je.length>0&&`${Je.length} ${Je.length===1?"evento":"eventi"}`,Je.length>0&&Qe.length>0&&" ‚Ä¢ ",Qe.length>0&&`${Qe.length} ${Qe.length===1?"assenza":"assenze"}`]})]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[Qe.length>0&&e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(Nt,{className:"h-4 w-4 text-red-400"}),e.jsx("h4",{className:"text-sm font-bold text-red-300",children:"Dipendenti Assenti"})]}),e.jsx("div",{className:"space-y-2",children:Qe.map(We=>{const gt=qe=>{switch(qe){case"ferie":return"Ferie";case"permesso":return"Permesso";case"malattia":return"Malattia";case"infortunio":return"Infortunio";default:return qe}};return e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-white",children:We.crewName}),e.jsx("span",{className:"text-xs px-2 py-1 rounded bg-red-600 text-white font-medium",children:gt(We.type)})]},We.id)})})]}),Je.map(We=>e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700 hover:border-gray-600 transition-colors cursor-pointer",onClick:()=>K(Ve),children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("span",{className:`inline-block px-3 py-1 text-xs font-semibold text-white rounded-full ${We.color}`,children:We.type==="course"?"Corso":"Evento"}),We.assignedCrewCount!==void 0&&We.requiredCrewCount!==void 0&&e.jsxs("span",{className:"inline-flex items-center text-xs text-gray-300 font-medium",children:[e.jsx(os,{className:"h-3.5 w-3.5 mr-1"}),We.assignedCrewCount,"/",We.requiredCrewCount]})]}),e.jsx("h4",{className:"text-base font-bold text-white mb-1",children:We.title})]})}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-300",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ht,{className:"h-4 w-4 flex-shrink-0 text-gray-400"}),e.jsxs("span",{children:[We.startTime," - ",We.endTime,We.callTime&&e.jsxs("span",{className:"text-gray-400 ml-2",children:["(Convocazione:  ",We.callTime,")"]})]})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 flex-shrink-0 text-gray-400 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:We.location}),We.address&&e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:We.address})]})]}),We.description&&e.jsx("div",{className:"mt-2 p-2 bg-gray-800 rounded text-xs text-gray-400 border border-gray-700",children:We.description})]})]},We.id))]})]},Ve)})})},X=c.getMonth(),se=c.getFullYear(),W=f.filter(be=>{const Z=new Date(be.date);return Z.getMonth()===X&&Z.getFullYear()===se&&be.type==="event"}).length,G=f.filter(be=>{const Z=new Date(be.date);return Z.getMonth()===X&&Z.getFullYear()===se&&be.type==="course"}).length,B=new Date(se,X,1),ne=new Date(se,X+1,0),ye=F(B),me=F(ne),Q=b.filter(be=>be.startDate<=me&&be.endDate>=ye).length;if(S)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento calendario..."})]})});const fe=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white",children:[e.jsxs("div",{className:"p-4 pb-20 space-y-4",children:[e.jsxs("div",{className:"flex flex-col space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Calendario Aziendale"}),e.jsx("p",{className:"text-gray-300",children:(n==null?void 0:n.nome_azienda)||"Azienda"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:U,className:"p-2 hover:bg-gray-800 rounded",children:e.jsx(Zr,{className:"h-5 w-5"})}),e.jsx("button",{onClick:N,className:"px-3 py-1 bg-gray-800 rounded text-sm",children:"Oggi"}),e.jsx("button",{onClick:te,className:"p-2 hover:bg-gray-800 rounded",children:e.jsx(Qr,{className:"h-5 w-5"})})]})]}),e.jsx("div",{className:"flex justify-center px-2",children:e.jsxs("div",{className:"inline-flex items-center gap-1.5",children:[e.jsx("button",{onClick:()=>R("month"),className:`px-2. 5 py-2 rounded-lg font-medium text-sm transition-colors ${D==="month"?"bg-gray-700 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"}`,children:"Mensile"}),e.jsx("button",{onClick:()=>R("agenda"),className:`px-2.5 py-2 rounded-lg font-medium text-sm transition-colors ${D==="agenda"?"bg-green-600 text-white":"bg-green-700 text-white hover:bg-green-600"}`,children:"Agenda"})]})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700 text-center",children:[e.jsx(xt,{className:"h-6 w-6 mx-auto mb-2 text-blue-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:W}),e.jsx("div",{className:"text-xs text-gray-400",children:"Eventi"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700 text-center",children:[e.jsx(Rt,{className:"h-6 w-6 mx-auto mb-2 text-yellow-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:G}),e.jsx("div",{className:"text-xs text-gray-400",children:"Corsi"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700 text-center",children:[e.jsx(Nt,{className:"h-6 w-6 mx-auto mb-2 text-red-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:Q}),e.jsx("div",{className:"text-xs text-gray-400",children:"Assenze"})]})]}),D==="month"&&e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[e.jsxs("h2",{className:"text-lg font-semibold text-white",children:[fe[c.getMonth()]," ",c.getFullYear()]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Vista Mensile"})]}),e.jsxs("div",{className:"p-3",children:[e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["Lun","Mar","Mer","Gio","Ven","Sab","Dom"].map(be=>e.jsx("div",{className:"p-2 text-center text-sm font-semibold text-gray-300",children:be},be))}),e.jsx("div",{className:"grid grid-cols-7 gap-1.5",children:V(c).map((be,Z)=>{let L="min-h-[85px] p-1. 5 rounded-lg border border-gray-700 cursor-pointer transition-colors relative ";return be.isCurrentMonth?be.isToday?L+="bg-blue-600 text-white shadow-lg ":L+="bg-gray-750 hover:bg-gray-700 ":L+="bg-gray-800 text-gray-500 ",e.jsxs("div",{className:L,onClick:()=>K(F(be.date)),children:[e.jsxs("div",{className:"flex items-start justify-between mb-1",children:[e.jsx("div",{className:"text-sm font-semibold",children:be.date.getDate()}),be.absences.length>0&&e.jsx("div",{className:"h-2 w-2 rounded-full bg-red-500 shadow-lg mt-0.5",title:`${be.absences.length} assenze approvate`})]}),e.jsxs("div",{className:"space-y-0.5",children:[be.events.slice(0,2).map(re=>e.jsx("div",{className:`text-[10px] leading-tight px-1 py-0.5 rounded text-white truncate font-medium ${re.color}`,title:re.title,children:re.title},re.id)),be.events.length>2&&e.jsxs("div",{className:"text-[10px] text-gray-300 px-1 font-medium",children:["+",be.events.length-2]})]})]},Z)})})]})]}),D==="agenda"&&O(),e.jsx(cn,{})]}),k&&E&&e.jsx(Bd,{date:E,events:C(new Date(E+"T12:00:00")),absences:_(new Date(E+"T12:00:00")),onClose:()=>P(!1)})]})},Bd=({date:n,events:l,absences:c,onClose:u})=>{const f=b=>new Date(b+"T12:00:00").toLocaleDateString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),x=b=>{switch(b){case"ferie":return"Ferie";case"permesso":return"Permesso";case"malattia":return"Malattia";case"infortunio":return"Infortunio";default:return b}};return e.jsx("div",{className:"fixed inset-0 bg-gray-900 bg-opacity-95 z-[9999] flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-3xl max-h-[90vh] overflow-y-auto p-5 space-y-6 bg-gray-800 rounded-xl border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-white",children:["Eventi del ",f(n)]}),e.jsx("button",{onClick:u,className:"bg-gray-700 hover:bg-gray-600 p-2.5 rounded-lg transition-colors",children:e.jsx(Et,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"space-y-4",children:[c.length>0&&e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(Nt,{className:"h-5 w-5 text-red-400"}),e.jsxs("h3",{className:"text-base font-bold text-red-300",children:["Dipendenti Assenti (",c.length,")"]})]}),e.jsx("div",{className:"space-y-2",children:c.map(b=>e.jsxs("div",{className:"bg-gray-900/50 rounded-lg p-3 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("div",{className:"font-semibold text-white",children:b.crewName}),e.jsx("div",{className:"text-xs px-2 py-1 rounded bg-red-600 text-white font-medium",children:x(b.type)})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:["Dal ",new Date(b.startDate+"T12:00:00").toLocaleDateString("it-IT")," al"," ",new Date(b.endDate+"T12:00:00").toLocaleDateString("it-IT")]}),b.reason&&e.jsx("div",{className:"text-sm text-gray-300 mt-2",children:b.reason})]},b.id))})]}),l.length===0&&c.length===0&&e.jsxs("div",{className:"text-center py-10 text-gray-400",children:[e.jsx(xt,{className:"h-12 w-12 mx-auto mb-3 text-gray-600"}),e.jsx("p",{className:"text-base",children:"Nessun evento o assenza in questa data"})]}),l.map(b=>e.jsx("div",{className:"bg-gray-900 rounded-xl p-5 border border-gray-700",children:e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("h4",{className:"text-lg font-bold text-white",children:b.title}),e.jsx("span",{className:`inline-flex px-2.5 py-1 text-sm font-semibold rounded-full ${b.color} text-white`,children:b.type==="course"?"Corso":"Evento"})]}),e.jsxs("div",{className:"text-sm text-gray-300 space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{children:b.location})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ht,{className:"h-4 w-4 flex-shrink-0"}),e.jsxs("span",{children:[b.startTime," - ",b.endTime,b.callTime&&` (Convocazione: ${b.callTime})`]})]}),b.address&&e.jsx("div",{className:"text-sm text-gray-400 break-words mt-2",children:b.address}),b.description&&e.jsx("div",{className:"text-sm text-gray-400 break-words mt-2",children:b.description})]}),b.assignedCrewCount!==void 0&&b.requiredCrewCount!==void 0&&e.jsxs("div",{className:"mt-3 flex items-center space-x-2 text-sm",children:[e.jsx(os,{className:"h-4 w-4 text-gray-400"}),e.jsxs("span",{className:"text-gray-300",children:["Assegnati: ",b.assignedCrewCount," / ",b.requiredCrewCount]})]})]})})},b.id))]})]})})},Fd=()=>{const{user:n,signOut:l}=us(),c="default",{showSuccess:u,showError:f,showWarning:x}=Dr(),[b,v]=w.useState(null),[S,g]=w.useState(!0),[E,p]=w.useState(!0),[k,P]=w.useState(!0),[D,R]=w.useState(!1),[j,M]=w.useState(!1);w.useEffect(()=>{n!=null&&n.id&&T()},[n==null?void 0:n.id]);const T=async()=>{try{g(!0);const{data:N,error:_}=await Le.from("regaziendasoftware").select("*").eq("auth_user_id",n==null?void 0:n.id).single();if(_){console.error("Errore nel caricamento profilo aziendale:",_);return}v(N)}catch(N){console.error("Errore nel caricamento profilo aziendale:",N)}finally{g(!1)}},F=[{id:"notifications",label:"Notifiche Push",description:"Ricevi notifiche per turni e aggiornamenti",value:E,onChange:p},{id:"autoSync",label:"Sincronizzazione Automatica",description:"Sincronizza dati quando connesso",value:k,onChange:P},{id:"offlineMode",label:"Modalit√† Offline",description:"Salva dati localmente quando offline",value:D,onChange:R}],U=async()=>{try{x("Logout in corso..."),await l(),u("Logout effettuato con successo!"),window.location.href="/"}catch(N){console.error("Errore durante il logout:",N),u("Sessione terminata localmente"),setTimeout(()=>{window.location.href="/"},1e3)}};if(S)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento profilo..."})]})});if(!b)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("p",{className:"text-lg",children:"Errore nel caricamento del profilo"}),e.jsx("button",{onClick:()=>T(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg",children:"Riprova"})]})});const te=b.ragione_sociale||"Azienda";return e.jsx("div",{className:"min-h-screen bg-gray-900 text-white",children:e.jsxs("div",{className:"p-4 pb-20 space-y-6",children:[e.jsx("div",{className:"bg-gradient-to-br from-blue-600 to-cyan-600 rounded-2xl p-6 shadow-xl",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center",children:e.jsx(Rt,{className:"h-8 w-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:te}),e.jsx("p",{className:"text-blue-100",children:b.citta||"Italia"}),e.jsx("p",{className:"text-sm text-blue-200",children:b.partita_iva?`P.IVA: ${b.partita_iva}`:"Azienda"})]})]})}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Informazioni Aziendali"}),e.jsxs("div",{className:"space-y-4",children:[b.email&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(fa,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.email}),e.jsx("p",{className:"text-xs text-gray-400",children:"Email aziendale"})]})]}),b.telefono&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Wa,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.telefono}),e.jsx("p",{className:"text-xs text-gray-400",children:"Telefono aziendale"})]})]}),b.partita_iva&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Rt,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.partita_iva}),e.jsx("p",{className:"text-xs text-gray-400",children:"Partita IVA"})]})]}),b.codice_fiscale&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Rt,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.codice_fiscale}),e.jsx("p",{className:"text-xs text-gray-400",children:"Codice Fiscale"})]})]}),b.indirizzo&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ut,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-white font-medium",children:[b.indirizzo,b.cap&&`, ${b.cap}`,b.citta&&` - ${b.citta}`,b.provincia&&` (${b.provincia})`]}),e.jsx("p",{className:"text-xs text-gray-400",children:"Indirizzo completo"})]})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Impostazioni App"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white font-medium",children:"Notifiche Push"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Non configurate"})]}),e.jsx("button",{onClick:()=>M(!j),className:"bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm",children:"Gestisci"})]}),c==="denied",c==="granted",e.jsxs("div",{className:"bg-yellow-900/20 border border-yellow-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-yellow-400 text-sm font-medium mb-2",children:"Configura le Notifiche"}),e.jsx("p",{className:"text-yellow-300 text-xs mb-2",children:'Clicca su "Gestisci" per attivare le notifiche e rimanere aggiornato su turni e approvazioni.'})]})]}),F.map(N=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white font-medium",children:N.label}),e.jsx("p",{className:"text-sm text-gray-400",children:N.description})]}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:N.value,onChange:_=>N.onChange(_.target.checked),className:"sr-only peer"}),e.jsx("div",{className:"w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"})]})]},N.id))]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Informazioni App"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Versione"}),e.jsx("span",{className:"text-white font-medium",children:"1.0.8"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Ultimo Aggiornamento"}),e.jsx("span",{className:"text-white font-medium",children:"Gennaio 2025"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Modalit√†"}),e.jsx("span",{className:"text-blue-400 font-medium",children:"Mobile"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Connessione"}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(li,{className:"h-4 w-4 text-green-400"}),e.jsx("span",{className:"text-green-400 font-medium",children:"Online"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Tipo Utente"}),e.jsx("span",{className:"text-blue-400 font-medium",children:"Azienda"})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Stato Account"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Stato"}),e.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-medium ${b.attivo?"bg-green-900 text-green-300":"bg-red-900 text-red-300"}`,children:b.attivo?"Attivo":"Disattivato"})]}),b.created_at&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Registrazione"}),e.jsx("span",{className:"text-white font-medium",children:new Date(b.created_at).toLocaleDateString("it-IT")})]}),b.ultimo_accesso&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Ultimo Accesso"}),e.jsx("span",{className:"text-white font-medium",children:new Date(b.ultimo_accesso).toLocaleDateString("it-IT")})]})]})]}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("button",{onClick:U,className:"w-full bg-red-600 text-white py-4 px-4 rounded-xl hover:bg-red-700 font-bold text-lg shadow-lg flex items-center justify-center space-x-3",children:[e.jsx(va,{className:"h-6 w-6"}),e.jsx("span",{children:"ESCI DALL'APP"})]})}),e.jsx(cn,{})]})})},jr=n=>{if(!n)return"";if(/^\d{2}:\d{2}$/.test(n))return n;if(/^\d{2}:\d{2}:\d{2}$/.test(n))return n.substring(0,5);try{const l=new Date(n);if(!isNaN(l.getTime()))return l.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit",hour12:!1})}catch(l){console.error("Errore parsing timestamp:",l)}return""},Ud=({shift:n,onUpdate:l})=>{const{user:c}=us(),{showSuccess:u,showError:f}=Dr(),[x,b]=w.useState(!1),[v,S]=w.useState(""),[g,E]=w.useState(""),[p,k]=w.useState(""),[P,D]=w.useState(""),[R,j]=w.useState(""),[M,T]=w.useState(!1),[F,U]=w.useState(null),[te,N]=w.useState(!1),[_,V]=w.useState(!1),[C,K]=w.useState(!0),[O,X]=w.useState(null),se=(me,Q,fe,be)=>{if(!me||!Q)return 0;const[Z,L]=me.split(":").map(Number),[re,de]=Q.split(":").map(Number),oe=Z*60+L;let ve=(re*60+de-oe)/60;if(fe&&be){const[Te,we]=fe.split(":").map(Number),[je,Fe]=be.split(":").map(Number),Ve=Te*60+we,st=(je*60+Fe-Ve)/60;st>0&&(ve-=st)}return ve},W=!n.turno_id||n.turno_id===""||n.nome_turno==="TURNO EXTRA";w.useEffect(()=>{const me=async()=>{try{if(W){const{data:Q,error:fe}=await Le.from("extra_shifts_checkins").select("*").eq("id",n.id).maybeSingle();if(fe)throw fe;if(Q){X(Q);const be=Q.rectified_check_in_time||Q.check_in_time,Z=Q.rectified_check_out_time||Q.check_out_time,L=Q.rectified_break_start||Q.break_start_time,re=Q.rectified_break_end||Q.break_end_time;S(jr(be)),E(jr(Z)),k(L||""),D(re||""),j(Q.rectification_note||"")}}else{const{data:Q,error:fe}=await Le.from("warehouse_checkins_enriched").select("*").eq("id",n.id).maybeSingle();if(fe)throw fe;if(Q){X(Q);const be=Q.rectified_check_in_time||Q.check_in_time,Z=Q.rectified_check_out_time||Q.check_out_time,L=Q.rectified_break_start||Q.break_start_time||Q.break_start,re=Q.rectified_break_end||Q.break_end_time||Q.break_end;S(jr(be)),E(jr(Z)),k(L||""),D(re||""),j(Q.rectification_note||"")}}}catch(Q){console.error("Errore caricamento dati turno:",Q)}};x&&n.id&&me()},[x,n.id,W]),w.useEffect(()=>{K(!0)},[]),w.useEffect(()=>{if(v&&g){const me=se(v,g,p,P),Q=n.ore_previste||8;me>Q?N(!0):(N(!1),V(!1))}},[v,g,p,P,n.ore_previste]);const G=async()=>{if(console.log("üîç Inizio salvataggio rettifica (azienda)..."),console.log("üìù Dati da salvare:",{editedCheckIn:v,editedCheckOut:g,breakStart:p,breakEnd:P,rectificationNote:R,requestOvertime:_,shiftId:n.id}),!v||!g){U("Inserisci orari validi");return}if(!R||R.trim().length<10){U("La nota di rettifica √® obbligatoria (minimo 10 caratteri)");return}if(p&&!P||!p&&P){U("Specifica sia l'inizio che la fine della pausa pranzo");return}if(p&&P){const[Q,fe]=p.split(":").map(Number),[be,Z]=P.split(":").map(Number);if(be*60+Z<=Q*60+fe){U("La fine della pausa deve essere dopo l'inizio");return}}const me=se(v,g,p,P);if(me<=0){U("Le pause non possono coprire tutto il tempo di lavoro. Le ore effettive devono essere maggiori di zero.");return}T(!0),U(null);try{const Q=new Date().toISOString(),fe={rectified_check_in_time:v,rectified_check_out_time:g,rectified_break_start:p||null,rectified_break_end:P||null,rectified_pausa_pranzo:!!(p&&P),rectified_total_hours:me,rectification_note:R.trim(),rectified_by:c==null?void 0:c.id,rectified_at:Q,overtime_requested:_,total_hours:me,status:"completed"};(!n.check_out_turno||n.status!=="completed")&&(fe.check_out_time=g);const be=W?"extra_shifts_checkins":"warehouse_checkins";console.log("üíæ Invio update a Supabase (azienda):",{tableName:be,shiftId:n.id,updateData:fe});const{error:Z}=await Le.from(be).update(fe).eq("id",n.id);if(console.log("‚úÖ Risposta Supabase (azienda):",{error:Z}),Z)throw console.error("‚ùå Errore Supabase:",Z),Z;u("Rettifica salvata con successo!"),b(!1),l()}catch(Q){console.error("‚ùå Errore aggiornamento turno:",Q);const fe=Q.message||"Errore nel salvataggio delle modifiche";U(fe),f(fe)}finally{T(!1)}},B=()=>{var me,Q;S(((me=n.check_in_turno)==null?void 0:me.substring(0,5))||""),E(((Q=n.check_out_turno)==null?void 0:Q.substring(0,5))||""),k(""),D(""),j(""),V(!1),N(!1),U(null),b(!1)};if(!x)return e.jsxs("button",{onClick:()=>b(!0),className:"w-full mt-2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center space-x-2",children:[e.jsx(ir,{className:"h-4 w-4"}),e.jsx("span",{children:"Rettifica Orari Turno"})]});const ye=(()=>{const me=O&&O.notes||n.notes||"",Q=O&&O.warehouse_name||n.warehouse_name||n.nome_turno||"",fe=O&&O.noteturno||n.noteturno||"";if(typeof me=="string"&&me.toLowerCase().includes("turno extra"))return{label:"TURNO EXTRA",isExtra:!0,subtitle:""};const be=[];return Q&&be.push(Q),fe&&be.push(fe),{label:"TURNO MAGAZZINO",isExtra:!1,subtitle:be.join(" ‚Ä¢ ")}})();return e.jsxs("div",{className:"mt-3 bg-gray-800 border border-gray-600 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-sm font-semibold text-white mb-3 flex items-center space-x-2",children:[e.jsx(ir,{className:"h-4 w-4"}),e.jsx("span",{children:"Rettifica Orari"})]}),e.jsx("div",{className:"mb-3",children:ye.isExtra?e.jsx("div",{className:"inline-flex items-center px-3 py-1 rounded-full bg-indigo-700 text-white text-xs font-semibold",children:"TURNO EXTRA"}):e.jsxs("div",{className:"inline-flex flex-col px-3 py-2 rounded-lg bg-gray-700 text-white text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Turno di Magazzino"}),ye.subtitle?e.jsx("span",{className:"text-xs text-gray-300 mt-1",children:ye.subtitle}):null]})}),(!n.original_check_out||n.status!=="completed")&&e.jsx("div",{className:"mb-4 bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Nt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-orange-200 mb-1",children:"Turno Ancora Aperto"}),e.jsx("div",{className:"text-xs text-orange-300",children:"Il checkout non √® stato effettuato. Compilando questa rettifica il turno verr√† automaticamente chiuso."})]})]})}),n.original_check_in&&e.jsxs("div",{className:"mb-4 bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-2",children:"Dati Originali Registrati:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-300",children:"Check-in:"}),e.jsx("div",{className:"text-white font-semibold",children:jr(n.original_check_in)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-300",children:"Check-out:"}),e.jsx("div",{className:"text-white font-semibold",children:n.original_check_out?e.jsxs(e.Fragment,{children:[jr(n.original_check_out),n.auto_checkout&&e.jsx("span",{className:"ml-1 text-xs bg-purple-800 text-purple-200 px-1 py-0.5 rounded",children:"AUTO"})]}):e.jsx("span",{className:"text-orange-400 italic",children:"Non effettuato"})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-blue-300",children:"Pausa Pranzo:"}),e.jsx("span",{className:"ml-2 text-white font-semibold",children:n.original_pausa_pranzo?"S√¨ ‚úì":"No ‚úó"})]})]})]}),F&&e.jsxs("div",{className:"mb-3 bg-red-900 border border-red-700 rounded-lg p-2 flex items-start space-x-2",children:[e.jsx(Nt,{className:"h-4 w-4 text-red-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"text-xs text-red-200",children:F})]}),e.jsxs("div",{className:"space-y-3 mb-3",children:[e.jsxs("div",{className:"bg-green-900 bg-opacity-20 border border-green-700 rounded-lg p-3 mb-3",children:[e.jsx("div",{className:"text-xs font-semibold text-green-200 mb-3",children:"Nuovi Orari Rettificati:"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-1",children:["Orario Entrata ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"time",value:v,onChange:me=>S(me.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-1",children:["Orario Uscita ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"time",value:g,onChange:me=>E(me.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"})]})]})]}),e.jsxs("div",{className:"border-t border-gray-600 pt-3 mt-3",children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-2 flex items-center space-x-2",children:[e.jsx(Cs,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{children:"Pausa Pranzo (opzionale):"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Inizio Pausa"}),e.jsx("input",{type:"time",value:p,onChange:me=>k(me.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Fine Pausa"}),e.jsx("input",{type:"time",value:P,onChange:me=>D(me.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"Lascia vuoto se non hai effettuato pausa pranzo"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-1",children:["Nota Rettifica ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("textarea",{value:R,onChange:me=>j(me.target.value),placeholder:"Specifica il motivo della rettifica (obbligatorio, min 10 caratteri)...",rows:3,className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[R.length,"/10 caratteri minimi"]})]}),v&&g&&e.jsxs("div",{className:"space-y-2",children:[te&&C&&e.jsx("div",{className:"bg-orange-900 border border-orange-700 rounded p-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Nt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-xs font-semibold text-orange-200 mb-2",children:["Le ore superano il turno previsto (",n.ore_previste||8,"h)"]}),e.jsxs("label",{className:"flex items-center space-x-2 text-xs text-orange-300",children:[e.jsx("input",{type:"checkbox",checked:_,onChange:me=>V(me.target.checked),className:"rounded border-orange-600 bg-orange-800 text-orange-500 focus:ring-orange-500"}),e.jsx("span",{children:"Richiedi straordinari per le ore eccedenti"})]})]})]})}),e.jsxs("div",{className:"bg-blue-900 border border-blue-700 rounded p-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs mb-1",children:[e.jsx("span",{className:"text-blue-200",children:"Nuove ore totali:"}),e.jsxs("span",{className:"font-bold text-blue-100 text-lg",children:[se(v,g,p,P).toFixed(2),"h"]})]}),p&&P&&e.jsxs("div",{className:"text-xs text-blue-300 mt-1",children:["(Include pausa: ",p," - ",P,")"]})]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("button",{type:"button",onClick:()=>V(!_),disabled:!C,className:`w-full py-3 rounded-lg font-semibold transition-all ${C?_?"bg-orange-600 text-white hover:bg-orange-700":"bg-gray-700 text-gray-300 hover:bg-gray-600 border border-gray-600":"bg-gray-800 text-gray-500 border border-gray-700 cursor-not-allowed"}`,children:C?_?e.jsxs("span",{className:"flex items-center justify-center space-x-2",children:[e.jsx(Nt,{className:"h-4 w-4"}),e.jsx("span",{children:"Straordinari Richiesti"})]}):e.jsx("span",{children:"Richiedi Straordinari"}):e.jsx("span",{children:"Straordinari Non Previsti nel Contratto"})}),!C&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 text-center",children:"Il tuo contratto non prevede il pagamento degli straordinari"})]})]}),e.jsxs("div",{className:"flex space-x-2 mt-4",children:[e.jsxs("button",{onClick:B,disabled:M,className:"flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-500 disabled:opacity-50 flex items-center justify-center space-x-1",children:[e.jsx(Et,{className:"h-4 w-4"}),e.jsx("span",{children:"Annulla"})]}),e.jsx("button",{onClick:G,disabled:M,className:"flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 flex items-center justify-center space-x-1",children:M?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Salvataggio..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Gr,{className:"h-4 w-4"}),e.jsx("span",{children:"Salva"})]})})]})]})},Vd=({event:n,existingTimesheet:l,onClose:c,onSuccess:u})=>{const{user:f}=us(),[x,b]=w.useState((l==null?void 0:l.start_time)||""),[v,S]=w.useState((l==null?void 0:l.end_time)||""),[g,E]=w.useState(""),[p,k]=w.useState(!1),[P,D]=w.useState(null),j=((T,F)=>{if(!T||!F)return 0;const[U,te]=T.split(":").map(Number),[N,_]=F.split(":").map(Number),V=U*60+te,K=N*60+_-V;return Math.max(0,K/60)})(x,v),M=async T=>{if(T.preventDefault(),!x||!v){D("Inserisci sia orario di check-in che di check-out");return}if(j<=0){D("L'orario di check-out deve essere successivo al check-in");return}if(!g||g.trim().length===0){D("La motivazione della rettifica √® obbligatoria");return}k(!0),D(null);try{if(l){const F={original_start_time:l.start_time,original_end_time:l.end_time,rectified_start_time:x,rectified_end_time:v,start_time:x,end_time:v,total_hours:j,is_rectified:!0,rectified_by:f==null?void 0:f.id,rectified_at:new Date().toISOString(),rectification_notes:g.trim()},{error:U}=await Le.from("timesheet_entries").update(F).eq("id",l.id);if(U)throw U}else{const F={crew_id:f==null?void 0:f.id,event_id:n.evento_id,date:n.giorno_inizio_evento,start_time:x,end_time:v,rectified_start_time:x,rectified_end_time:v,total_hours:j,status:"submitted",tracking_type:"hours",is_rectified:!0,rectified_by:f==null?void 0:f.id,rectified_at:new Date().toISOString(),rectification_notes:g.trim(),retention_percentage:0,gross_amount:0,net_amount:0},{error:U}=await Le.from("timesheet_entries").insert([F]);if(U)throw U}u(),c()}catch(F){console.error("Errore salvataggio rettifica:",F),D(F.message||"Errore durante il salvataggio")}finally{k(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl w-full max-w-md border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Rettifica Orario"}),e.jsx("p",{className:"text-sm text-gray-400",children:n.nome_evento})]}),e.jsx("button",{onClick:c,className:"text-gray-400 hover:text-white",children:e.jsx(Et,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:M,className:"p-4 space-y-4",children:[e.jsxs("div",{className:"bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3 flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-5 w-5 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsx("div",{className:"text-sm text-orange-200",children:"Questa operazione registra un orario rettificato manualmente. Verr√† segnalato come rettifica nel sistema."})]}),P&&e.jsx("div",{className:"bg-red-900 bg-opacity-30 border border-red-700 rounded-lg p-3 text-sm text-red-200",children:P}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Orario Check-in"}),e.jsxs("div",{className:"relative",children:[e.jsx(ht,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"time",value:x,onChange:T=>b(T.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Orario Check-out"}),e.jsxs("div",{className:"relative",children:[e.jsx(ht,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"time",value:v,onChange:T=>S(T.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]})]}),x&&v&&e.jsx("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-3",children:e.jsxs("div",{className:"text-sm text-blue-200",children:[e.jsx("span",{className:"font-medium",children:"Ore totali:"})," ",j.toFixed(2),"h"]})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Motivazione Rettifica ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("textarea",{value:g,onChange:T=>E(T.target.value),rows:3,className:"w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",placeholder:"Spiega il motivo della rettifica (es: dimenticato check-in, errore nell'orario, ecc...)",required:!0})]}),e.jsxs("div",{className:"flex space-x-3 pt-4",children:[e.jsx("button",{type:"button",onClick:c,className:"flex-1 py-2 px-4 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors",children:"Annulla"}),e.jsx("button",{type:"submit",disabled:p||!x||!v||!g.trim(),className:"flex-1 py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:p?"Salvataggio...":l?"Aggiorna":"Salva"})]})]})]})})},Hd=({report:n,onRectify:l})=>{const{assignment:c,timesheet:u,benefitBreakdown:f}=n,x=R=>{if(!R)return"Non specificato";if(/^\d{2}:\d{2}$/.test(R))return R;if(/^\d{2}:\d{2}:\d{2}$/.test(R))return R.substring(0,5);try{const j=new Date(R);if(!isNaN(j.getTime()))return j.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})}catch(j){console.error("Errore parsing timestamp:",j)}return R},b=R=>{switch(R){case"evento":return"Diaria Eventi";case"trasferta":return"Diaria Trasferta";default:return null}},v=(u==null?void 0:u.rectified_start_time)||(u==null?void 0:u.start_time),S=(u==null?void 0:u.rectified_end_time)||(u==null?void 0:u.end_time),g=u&&v&&S,E=(u==null?void 0:u.total_benefits)||0,p=E>0,k=c.bonus_previsti&&c.bonus_previsti>0,P=c.benefits_evento_nomi&&c.benefits_evento_nomi.length>0,D=!g&&(k||P||c.bonus_trasferta||c.bonus_diaria);return e.jsxs("div",{className:"bg-gray-700 rounded-xl p-4 border border-gray-600",children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx("h4",{className:"font-bold text-white",children:c.nome_evento}),(u==null?void 0:u.is_rectified)&&e.jsx("span",{className:"bg-orange-600 text-white text-xs px-2 py-0.5 rounded font-semibold",children:"Rettificato"})]}),e.jsx("p",{className:"text-sm text-blue-400",children:c.nome_azienda}),e.jsxs("p",{className:"text-xs text-gray-400",children:[new Date(c.giorno_inizio_evento).toLocaleDateString("it-IT"),c.giorno_inizio_evento!==c.giorno_fine_evento&&e.jsxs(e.Fragment,{children:[" - ",new Date(c.giorno_fine_evento).toLocaleDateString("it-IT")]})]})]})}),c.evento_orario_convocazione&&e.jsx("div",{className:"bg-green-900 bg-opacity-30 border-2 border-green-600 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(ht,{className:"h-5 w-5 text-green-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-green-200",children:"Orario Convocazione"}),e.jsx("div",{className:"text-xl font-bold text-green-400",children:x(c.evento_orario_convocazione)})]})]})}),(u==null?void 0:u.convocation_start_time)&&(u==null?void 0:u.convocation_end_time)&&e.jsxs("div",{className:"bg-cyan-900 bg-opacity-30 border border-cyan-600 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ht,{className:"h-4 w-4 text-cyan-400"}),e.jsx("h5",{className:"text-sm font-medium text-cyan-400",children:"Orari Convocazione"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Inizio:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(u.convocation_start_time)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Fine:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(u.convocation_end_time)})]})]})]}),g?e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 mb-3 border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ht,{className:"h-4 w-4 text-blue-400"}),e.jsx("h5",{className:"text-sm font-medium text-blue-400",children:"Orari Effettivi"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs mb-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Check-in:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(v)}),u.is_rectified&&u.original_start_time&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",x(u.original_start_time)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Check-out:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(S)}),u.is_rectified&&u.original_end_time&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",x(u.original_end_time)]}),u.is_rectified&&!u.original_end_time&&u.rectified_end_time&&e.jsxs("div",{className:"text-xs text-green-400 mt-1 flex items-center space-x-1",children:[e.jsx(pt,{className:"h-3 w-3"}),e.jsx("span",{children:"Aggiunto via rettifica"})]})]})]}),u.total_hours&&e.jsx("div",{className:"border-t border-gray-700 pt-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-gray-400",children:"Ore Totali:"}),e.jsxs("span",{className:"text-sm font-bold text-blue-400",children:[u.total_hours,"h"]})]})})]}):e.jsx("div",{className:"bg-gray-800 rounded-lg p-3 mb-3 border-l-4 border-gray-600",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-xs text-gray-400",children:u?"Turno in corso - Check-out non effettuato":"Nessun check-in registrato"})]})}),p&&g&&e.jsxs("div",{className:"bg-green-900 bg-opacity-20 border border-green-700 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(js,{className:"h-4 w-4 text-green-400"}),e.jsx("h5",{className:"text-sm font-medium text-green-400",children:"Benefit Ricevuti"})]}),e.jsxs("div",{className:"space-y-2",children:[u.meal_voucher&&u.meal_voucher_amount&&u.meal_voucher_amount>0&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{className:"h-4 w-4 text-yellow-400"}),e.jsx("span",{className:"text-sm text-gray-200",children:"Buono Pasto"})]}),e.jsxs("span",{className:"text-sm font-bold text-yellow-400",children:["‚Ç¨",u.meal_voucher_amount.toFixed(2)]})]}),u.company_meal&&u.company_meal_cost&&u.company_meal_cost>0&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{className:"h-4 w-4 text-orange-400"}),e.jsx("span",{className:"text-sm text-gray-200",children:"Pasto Aziendale"})]}),e.jsxs("span",{className:"text-sm font-bold text-orange-400",children:["‚Ç¨",u.company_meal_cost.toFixed(2)]})]}),u.diaria_type&&u.diaria_type!=="nessuna"&&u.diaria_amount&&u.diaria_amount>0&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ks,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-gray-200",children:b(u.diaria_type)})]}),e.jsxs("span",{className:"text-sm font-bold text-purple-400",children:["‚Ç¨",u.diaria_amount.toFixed(2)]})]}),f&&f.length>0&&f.map((R,j)=>{if(!R.applied)return null;const M=te=>{switch(te==null?void 0:te.toLowerCase()){case"trasferta":return ks;case"benefit":return js;case"rimborso":return Na;default:return Ar}},T=te=>{switch(te==null?void 0:te.toLowerCase()){case"trasferta":return"text-purple-400";case"benefit":return"text-green-400";case"rimborso":return"text-cyan-400";default:return"text-yellow-400"}},F=M(R.category),U=T(R.category);return e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(F,{className:`h-4 w-4 ${U}`}),e.jsx("span",{className:"text-sm text-gray-200",children:R.name})]}),e.jsxs("span",{className:`text-sm font-bold ${U}`,children:["‚Ç¨",R.amount.toFixed(2)]})]},j)}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-900 bg-opacity-30 border border-blue-700 rounded px-3 py-2 mt-3",children:[e.jsx("span",{className:"text-sm font-bold text-white",children:"Totale Benefit:"}),e.jsxs("span",{className:"text-lg font-bold text-blue-400",children:["‚Ç¨",E.toFixed(2)]})]})]})]}),D&&e.jsxs("div",{className:"bg-blue-900 bg-opacity-20 border border-blue-600 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(Ar,{className:"h-4 w-4 text-blue-400"}),e.jsx("h5",{className:"text-sm font-medium text-blue-400",children:"Bonus/Benefit Previsti"})]}),e.jsxs("div",{className:"space-y-1 text-xs",children:[c.tariffa_evento_assegnata&&e.jsxs("div",{className:"flex items-center justify-between text-gray-200",children:[e.jsx("span",{children:"Tariffa Base:"}),e.jsxs("span",{className:"font-semibold",children:["‚Ç¨",c.tariffa_evento_assegnata.toFixed(2)]})]}),k&&e.jsxs("div",{className:"flex items-center justify-between text-yellow-300",children:[e.jsx("span",{children:"Bonus Fisso:"}),e.jsxs("span",{className:"font-semibold",children:["‚Ç¨",c.bonus_previsti.toFixed(2)]})]}),c.bonus_trasferta&&e.jsx("div",{className:"flex items-center text-purple-300",children:e.jsx("span",{children:"Bonus Trasferta Previsto"})}),c.bonus_diaria&&e.jsx("div",{className:"flex items-center text-purple-300",children:e.jsx("span",{children:"Diaria Prevista"})}),P&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-blue-800",children:[e.jsx("div",{className:"text-blue-200 mb-1",children:"Altri benefit previsti:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:c.benefits_evento_nomi.map((R,j)=>e.jsx("span",{className:"bg-blue-800 text-blue-200 px-2 py-0.5 rounded text-xs",children:R},j))})]}),e.jsx("div",{className:"mt-2 pt-2 border-t border-blue-800 text-blue-200 text-center",children:"Gli importi effettivi verranno calcolati al check-out"})]})]}),(u==null?void 0:u.is_rectified)&&u.rectification_notes&&e.jsx("div",{className:"bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-orange-200 mb-1",children:"Nota di Rettifica:"}),e.jsx("div",{className:"text-xs text-orange-300",children:u.rectification_notes})]})]})}),e.jsxs("div",{className:"space-y-2 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm text-white",children:c.evento_localita})]}),c.evento_trasferta&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ks,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-purple-300",children:"Evento con Trasferta"})]})]}),e.jsxs("button",{onClick:l,className:"w-full flex items-center justify-center space-x-2 px-4 py-2 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700 transition-colors border border-orange-500",children:[e.jsx(ci,{className:"h-4 w-4"}),e.jsx("span",{children:"RETTIFICA ORARIO"})]}),!g&&u&&e.jsx("div",{className:"mt-2 text-xs text-center text-gray-400",children:"I benefit verranno calcolati al check-out"})]})},qd=()=>{var fe,be;const{user:n}=us(),[l,c]=w.useState([]),[u,f]=w.useState(null),[x,b]=w.useState(new Date().getMonth()),[v,S]=w.useState(new Date().getFullYear()),[g,E]=w.useState(!0),[p,k]=w.useState(null),[P,D]=w.useState(null),[R,j]=w.useState([]),[M,T]=w.useState([]),[F,U]=w.useState(!1),[te,N]=w.useState(null),[_,V]=w.useState("events"),[C,K]=w.useState(""),[O,X]=w.useState("all"),[se,W]=w.useState([]),G=Z=>String(Z).padStart(2,"0"),B=Z=>`${Z.getFullYear()}-${G(Z.getMonth()+1)}-${G(Z.getDate())}`,ne=Z=>{if(!Z)return new Date(NaN);const L=Z.split("-").map(re=>parseInt(re,10));return L.length!==3?new Date(Z):new Date(L[0],L[1]-1,L[2])};w.useEffect(()=>{n!=null&&n.id&&ye()},[n==null?void 0:n.id,x,v]),w.useEffect(()=>{(async()=>{if(n!=null&&n.id)try{const{data:L,error:re}=await Le.from("warehouse_checkins_enriched").select("warehouse_id, warehouse_name").eq("crew_id",n.id).not("warehouse_id","is",null);if(re)throw re;const de=new Map;(L||[]).forEach((ge,ve)=>{const Te=ge.warehouse_id,we=ge.warehouse_name||`Magazzino ${ve+1}`;Te&&!de.has(Te)&&de.set(Te,we)});const oe=Array.from(de.entries()).map(([ge,ve])=>({id:ge,name:ve}));W(oe)}catch(L){console.error("Errore caricamento magazzini:",L)}})()},[n==null?void 0:n.id]),w.useEffect(()=>{let Z=[...R];C&&(Z=Z.filter(L=>L.giorno_turno===C)),O!=="all"&&(Z=Z.filter(L=>L.warehouse_id===O)),T(Z)},[R,C,O]);const ye=async()=>{try{E(!0),D(null),console.log("üìä Caricamento report per user:",n==null?void 0:n.id),console.log("üìÖ Periodo:",{month:x+1,year:v});const{data:Z,error:L}=await Le.from("registration_requests").select(`
          *,
          regaziendasoftware!parent_company_id(ragione_sociale)
        `).eq("auth_user_id",n==null?void 0:n.id).single();if(L||!Z){console.error("‚ùå Errore caricamento profilo:",L),D("Errore nel caricamento del profilo utente");return}k(Z),console.log("‚úÖ Profilo caricato:",Z.full_name);const re=new Date(v,x,1),de=new Date(v,x+1,0),oe=B(re),ge=B(de);console.log("‚è± Intervallo locale usato per query:",{startDate:oe,endDate:ge});const{data:ve,error:Te}=await Le.from("crew_event_assegnazione").select("*").eq("dipendente_freelance_id",n==null?void 0:n.id).gte("giorno_inizio_evento",oe).lte("giorno_inizio_evento",ge).order("giorno_inizio_evento",{ascending:!0});if(Te){console.error("‚ùå Errore caricamento eventi mese:",Te),D("Errore nel caricamento degli eventi del mese");return}console.log("üìÖ Eventi del mese trovati:",(ve==null?void 0:ve.length)||0);const{data:we,error:je}=await Le.from("crew_assegnazionetariffa").select("tariffe_ids").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0);if(je){console.error("‚ùå Errore caricamento tariffe dipendente:",je),D("Errore nel caricamento delle tariffe del dipendente");return}console.log("üí∞ Assegnazioni tariffe trovate:",(we==null?void 0:we.length)||0);const Fe={};if(we&&we.length>0){const pe=[];if(we.forEach(Ze=>{Ze.tariffe_ids&&Ze.tariffe_ids.length>0&&pe.push(...Ze.tariffe_ids)}),console.log("üîç ID tariffe da caricare:",pe),pe.length>0){const{data:Ze,error:at}=await Le.from("crew_tariffe").select("*").in("id",pe).eq("attivo",!0);if(at){console.error("‚ùå Errore caricamento dettagli tariffe:",at),D("Errore nel caricamento dei dettagli delle tariffe");return}console.log("‚úÖ Tariffe caricate:",(Ze==null?void 0:Ze.length)||0),Ze==null||Ze.forEach(bt=>{Fe[bt.id]={id:bt.id,nome_tariffa:bt.nome_tariffa,categoria:bt.categoria,tipo_calcolo:bt.tipo_calcolo,importo:bt.importo,attivo:bt.attivo}})}}console.log("üí∞ Benefit dipendente disponibili:",Object.keys(Fe).length);const{data:Ve,error:rt}=await Le.from("timesheet_entries").select(`
          id,
          crew_id,
          event_id,
          date,
          start_time,
          end_time,
          total_hours,
          status,
          meal_voucher,
          meal_voucher_amount,
          company_meal,
          company_meal_cost,
          diaria_type,
          diaria_amount,
          other_benefits_amount,
          total_benefits,
          is_rectified,
          rectification_notes,
          rectified_by,
          rectified_at,
          original_start_time,
          original_end_time,
          rectified_start_time,
          rectified_end_time,
          convocation_start_time,
          convocation_end_time
        `).eq("crew_id",n==null?void 0:n.id).gte("date",oe).lte("date",ge);rt&&console.error("‚ùå Errore caricamento timesheet:",rt),console.log("üìã Timesheet entries trovati:",(Ve==null?void 0:Ve.length)||0);const st={};Ve==null||Ve.forEach(pe=>{st[pe.event_id]=pe});let Je=[];const Qe=[];let We=0,gt=0,qe=0;const De={warehouse:0,event:0,event_travel:0},H={},ae=[];for(const pe of ve||[]){console.log(`
üé≠ CALCOLO REPORT EVENTO: "${pe.nome_evento}"`);const Ze=[],at=[];let bt=0;if(pe.benefits_evento_ids&&pe.benefits_evento_ids.length>0&&pe.benefits_evento_ids.forEach(Tt=>{const mt=Fe[Tt];mt?(Ze.push({id:mt.id,nome_tariffa:mt.nome_tariffa,categoria:mt.categoria,importo:mt.importo,applied:!0}),bt+=mt.importo,H[mt.categoria]||(H[mt.categoria]={count:0,amount:0}),H[mt.categoria].count++,H[mt.categoria].amount+=mt.importo,at.push({name:mt.nome_tariffa,amount:mt.importo,category:mt.categoria,applied:!0}),console.log(`‚úÖ BENEFIT APPLICATO: ${mt.nome_tariffa} = ‚Ç¨${mt.importo}`)):(at.push({name:`Benefit ID: ${Tt}`,amount:0,category:"non_disponibile",applied:!1,reason:"Benefit non presente nel contratto del dipendente"}),console.log(`‚ùå BENEFIT NON APPLICABILE: ID ${Tt}`))}),pe.bonus_trasferta&&pe.evento_trasferta){const Tt=Object.values(Fe).find(mt=>mt.categoria==="indennita_trasferta"||mt.nome_tariffa.toLowerCase().includes("trasferta"));Tt&&!Ze.find(mt=>mt.id===Tt.id)&&(Ze.push({id:Tt.id,nome_tariffa:Tt.nome_tariffa,categoria:Tt.categoria,importo:Tt.importo,applied:!0}),bt+=Tt.importo,H[Tt.categoria]||(H[Tt.categoria]={count:0,amount:0}),H[Tt.categoria].count++,H[Tt.categoria].amount+=Tt.importo,console.log(`‚úÖ BONUS TRASFERTA: ${Tt.nome_tariffa} = ‚Ç¨${Tt.importo}`))}pe.bonus_previsti&&pe.bonus_previsti>0&&(bt+=pe.bonus_previsti,at.push({name:"Bonus Evento Fisso",amount:pe.bonus_previsti,category:"bonus_evento",applied:!0}),console.log(`‚úÖ BONUS FISSO EVENTO: ‚Ç¨${pe.bonus_previsti}`));const Oe=pe.tariffa_evento_assegnata||0,It=Oe+bt;We+=Oe,gt+=bt;const ct=st[pe.evento_id],ws=ct&&ct.start_time;if(ws&&(ct.status==="active"||ct.status==="completed"||ct.status==="submitted")){pe.nome_evento.toLowerCase().includes("magazzino")?De.warehouse++:pe.evento_trasferta?(console.log("‚úàÔ∏è EVENTO TRASFERTA TROVATO:",{nome:pe.nome_evento,evento_trasferta:pe.evento_trasferta,hasCheckedIn:ws,status:ct==null?void 0:ct.status,id:pe.id}),De.event_travel++):De.event++;const Tt=ne(pe.giorno_inizio_evento),mt=ne(pe.giorno_fine_evento),hs=new Date(Tt);for(;hs<=mt;)ae.push(B(hs)),hs.setDate(hs.getDate()+1)}Qe.push({assignment:pe,timesheet:ct?{id:ct.id,start_time:ct.start_time,end_time:ct.end_time,status:ct.status,total_hours:ct.total_hours,meal_voucher:ct.meal_voucher,meal_voucher_amount:ct.meal_voucher_amount,company_meal:ct.company_meal,company_meal_cost:ct.company_meal_cost,diaria_type:ct.diaria_type,diaria_amount:ct.diaria_amount,other_benefits_amount:ct.other_benefits_amount,total_benefits:ct.total_benefits,is_rectified:ct.is_rectified,rectification_notes:ct.rectification_notes,original_start_time:ct.original_start_time,original_end_time:ct.original_end_time,rectified_start_time:ct.rectified_start_time,rectified_end_time:ct.rectified_end_time,convocation_start_time:ct.convocation_start_time,convocation_end_time:ct.convocation_end_time}:void 0,applicableBenefits:Ze,totalBenefitsAmount:bt,totalEventAmount:It,benefitBreakdown:at}),console.log(`üí∞ TOTALE EVENTO "${pe.nome_evento}": ‚Ç¨${It} (base: ‚Ç¨${Oe} + benefit: ‚Ç¨${bt})`)}c(Qe);const{data:he,error:Ae}=await Le.from("warehouse_checkins_enriched").select("*").eq("crew_id",n==null?void 0:n.id).gte("date",oe).lte("date",ge).order("date",{ascending:!1}),{data:Re,error:ee}=await Le.from("extra_shifts_checkins").select("*").eq("crew_id",n==null?void 0:n.id).gte("date",oe).lte("date",ge).order("date",{ascending:!1});if(Ae?console.error("‚ùå Errore caricamento turni (enriched):",Ae):console.log("‚úÖ Turni trovati (enriched):",(he==null?void 0:he.length)||0),ee?console.error("‚ùå Errore caricamento turni extra:",ee):console.log("‚úÖ Turni extra trovati:",(Re==null?void 0:Re.length)||0),!Ae||!ee){const pe=(he||[]).map(Oe=>{const It=Oe.rectified_check_in_time||Oe.check_in_time,ct=Oe.rectified_check_out_time||Oe.check_out_time,ws=Oe.rectified_total_hours||parseFloat(Oe.total_hours)||0,$t=Oe.rectified_pausa_pranzo!==null?Oe.rectified_pausa_pranzo:Oe.pausa_pranzo||!1,Tt=Oe.notes||Oe.noteturno||"",hs=typeof Tt=="string"&&Tt.toLowerCase().includes("turno extra")?"TURNO EXTRA":Oe.warehouse_name||Oe.noteturno||"Turno Magazzino";return{id:Oe.id,turno_id:Oe.shift_id||"",warehouse_id:Oe.warehouse_id||"",warehouse_name:Oe.warehouse_name||"",notes:Oe.notes||"",noteturno:Oe.noteturno||"",giorno_turno:Oe.date,nome_turno:hs,check_in_turno:It,check_out_turno:ct,conteggio_ore:ws,buoni_pasto_assegnato:Oe.meal_voucher||!1,pasto_aziendale_usufruito:Oe.company_meal||!1,ore_straordinario:parseFloat(Oe.overtime_hours)||0,ore_previste:8,pausa_pranzo:$t,pausa_cena:!1,pausa_pranzo_inizio:Oe.pausa_pranzo_inizio||Oe.break_start_time,pausa_pranzo_fine:Oe.pausa_pranzo_fine||Oe.break_end_time,pausa_pranzo_minuti:Oe.pausa_pranzo_minuti||Oe.break_minutes,pausa_cena_inizio:void 0,pausa_cena_fine:void 0,pausa_cena_minuti:void 0,pausa_totale_minuti:Oe.pausa_totale_minuti||Oe.break_minutes,status:Oe.status,is_rectified:!!Oe.rectified_at,rectification_note:Oe.rectification_note||null,original_check_in:Oe.check_in_time,original_check_out:Oe.check_out_time,original_pausa_pranzo:Oe.pausa_pranzo||!1,rectified_check_in:Oe.rectified_check_in_time,rectified_check_out:Oe.rectified_check_out_time,rectified_pausa_pranzo:Oe.rectified_pausa_pranzo,auto_checkout:Oe.auto_checkout||!1}}),Ze=(Re||[]).map(Oe=>{const It=Oe.rectified_check_in_time||Oe.check_in_time,ct=Oe.rectified_check_out_time||Oe.check_out_time,ws=Oe.rectified_total_hours||parseFloat(Oe.total_hours)||0,$t=Oe.rectified_pausa_pranzo!==null?Oe.rectified_pausa_pranzo:Oe.has_taken_break||!1;return{id:Oe.id,turno_id:"",warehouse_id:"",warehouse_name:"",notes:Oe.notes||"",noteturno:Oe.NoteTurno||"",giorno_turno:Oe.date,nome_turno:"TURNO EXTRA",check_in_turno:It,check_out_turno:ct,conteggio_ore:ws,buoni_pasto_assegnato:Oe.meal_voucher||!1,pasto_aziendale_usufruito:Oe.company_meal||!1,ore_straordinario:parseFloat(Oe.overtime_hours)||0,ore_previste:8,pausa_pranzo:$t,pausa_cena:!!(Oe.pausa_cena_inizio&&Oe.pausa_cena_fine),pausa_pranzo_inizio:Oe.pausa_pranzo_inizio||Oe.break_start_time,pausa_pranzo_fine:Oe.pausa_pranzo_fine||Oe.break_end_time,pausa_pranzo_minuti:Oe.pausa_pranzo_minuti||Oe.break_minutes,pausa_cena_inizio:Oe.pausa_cena_inizio,pausa_cena_fine:Oe.pausa_cena_fine,pausa_cena_minuti:Oe.pausa_cena_minuti,pausa_totale_minuti:Oe.pausa_totale_minuti,status:Oe.status,is_rectified:!!Oe.rectified_at,rectification_note:Oe.rectification_note||null,original_check_in:Oe.check_in_time,original_check_out:Oe.check_out_time,original_pausa_pranzo:Oe.has_taken_break||!1,rectified_check_in:Oe.rectified_check_in_time,rectified_check_out:Oe.rectified_check_out_time,rectified_pausa_pranzo:Oe.rectified_pausa_pranzo,auto_checkout:!1}}),at=[...pe,...Ze].sort((Oe,It)=>new Date(It.giorno_turno).getTime()-new Date(Oe.giorno_turno).getTime());j(at),Je=at.filter(Oe=>Oe.status==="completed"&&Oe.check_out_turno),console.log("üìã Turni totali:",at.length),console.log("üìã Turni completati:",Je.length);const bt=Je.length;De.warehouse+=bt,Je.forEach(Oe=>{qe+=Oe.ore_straordinario||0,ae.push(Oe.giorno_turno)}),console.log(`üìÖ Turni magazzino completati: ${Je.length}`)}let le=0;try{const{data:pe,error:Ze}=await Le.from("expenses").select("id").eq("crew_id",n==null?void 0:n.id).gte("expense_date",oe).lte("expense_date",ge);if(Ze)throw Ze;le=(pe==null?void 0:pe.length)||0}catch(pe){console.error("‚ùå Errore caricamento note spese:",pe)}let Ee=0,_e=0,J=0,ke=0;p&&(Ee=p.vacation_days_used||0,_e=(p.vacation_days_total||0)-Ee,J=p.leave_days_used||0,ke=(p.leave_days_total||0)-J);const ue=new Set(ae).size;console.log(`üìÖ Giorni lavorati unici totali: ${ue} (da ${ae.length} date totali)`);const xe={month:new Date(v,x).toLocaleDateString("it-IT",{month:"long"}),year:v,totalEvents:Qe.length+Je.length,totalDays:ue,totalShifts:Je.length,eventsByType:De,expensesCount:le,overtimeHours:qe,vacationRequested:Ee,vacationRemaining:_e,leaveRequested:J,leaveRemaining:ke};f(xe),console.log("üìä REPORT MENSILE COMPLETO:",xe),console.log("üì¶ Turni magazzino conteggiati:",De.warehouse),console.log("‚úàÔ∏è EVENTI TRASFERTA CONTEGGIATI:",De.event_travel),console.log("üìÖ EVENTI STANDARD CONTEGGIATI:",De.event)}catch(Z){console.error("‚ùå Errore generale caricamento report:",Z),D(`Errore nel caricamento del report: ${Z instanceof Error?Z.message:"Errore sconosciuto"}`)}finally{E(!1)}},me=Z=>{if(!Z)return"Non specificato";if(/^\d{2}:\d{2}$/.test(Z))return Z;if(/^\d{2}:\d{2}:\d{2}$/.test(Z))return Z.substring(0,5);try{const L=new Date(Z);if(!isNaN(L.getTime()))return L.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})}catch(L){console.error("Errore parsing timestamp:",L)}return Z},Q=()=>{var L;if(!u)return;const Z={dipendente:(p==null?void 0:p.full_name)||"Dipendente",azienda:((L=p==null?void 0:p.regaziendasoftware)==null?void 0:L.ragione_sociale)||"Azienda",periodo:`${u.month} ${u.year}`,eventi:l.length,importoTotale:u.totalAmount,benefitTotali:u.benefitsAmount};console.log("üìÑ Download report:",Z),alert(`üìÑ Report ${u.month} ${u.year} generato!`)};return g?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Generazione report..."})]})}):P?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(Zt,{className:"h-16 w-16 mx-auto mb-4 text-red-400"}),e.jsx("p",{className:"text-lg text-red-400",children:"Errore nel caricamento"}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:P}),e.jsx("button",{onClick:()=>ye(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Riprova"})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white",children:[e.jsxs("div",{className:"p-4 pb-20 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Report Mensile"}),e.jsx("p",{className:"text-gray-300",children:(p==null?void 0:p.full_name)||"Dipendente"}),e.jsx("p",{className:"text-sm text-blue-400",children:((fe=p==null?void 0:p.regaziendasoftware)==null?void 0:fe.ragione_sociale)||"La Mia Azienda"})]}),e.jsx("button",{onClick:Q,disabled:!u,className:"bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-600",children:e.jsx(cr,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(ga,{className:"h-5 w-5 text-gray-400"}),e.jsx("select",{value:x,onChange:Z=>b(Number(Z.target.value)),className:"bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white",children:Array.from({length:12},(Z,L)=>e.jsx("option",{value:L,children:new Date(2024,L).toLocaleDateString("it-IT",{month:"long"})},L))}),e.jsxs("select",{value:v,onChange:Z=>S(Number(Z.target.value)),className:"bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white",children:[e.jsx("option",{value:2024,children:"2024"}),e.jsx("option",{value:2025,children:"2025"})]})]})}),e.jsx("div",{className:"bg-gray-800 rounded-xl border border-gray-700 overflow-hidden",children:e.jsxs("div",{className:"grid grid-cols-2",children:[e.jsxs("button",{onClick:()=>V("events"),className:`flex items-center justify-center space-x-2 py-4 px-4 transition-all ${_==="events"?"bg-blue-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:[e.jsx(xt,{className:"h-5 w-5"}),e.jsx("span",{className:"font-semibold",children:"Eventi"}),l.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full ${_==="events"?"bg-blue-500":"bg-gray-600"}`,children:l.length})]}),e.jsxs("button",{onClick:()=>V("warehouse"),className:`flex items-center justify-center space-x-2 py-4 px-4 transition-all ${_==="warehouse"?"bg-blue-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:[e.jsx(Rt,{className:"h-5 w-5"}),e.jsx("span",{className:"font-semibold",children:"Turni"}),R.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full ${_==="warehouse"?"bg-blue-500":"bg-gray-600"}`,children:R.length})]})]})}),u&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Riepilogo ",u.month," ",u.year]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(Rt,{className:"h-5 w-5 mx-auto mb-1 text-gray-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:u.eventsByType.warehouse}),e.jsx("div",{className:"text-xs text-gray-400",children:"Turni Magazzino"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(xt,{className:"h-5 w-5 mx-auto mb-1 text-blue-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:u.eventsByType.event}),e.jsx("div",{className:"text-xs text-gray-400",children:"Eventi"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(ks,{className:"h-5 w-5 mx-auto mb-1 text-orange-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:u.eventsByType.event_travel}),e.jsx("div",{className:"text-xs text-gray-400",children:"Trasferte"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(xt,{className:"h-5 w-5 mx-auto mb-1 text-blue-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:u.totalDays}),e.jsx("div",{className:"text-xs text-gray-400",children:"Giorni"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(di,{className:"h-5 w-5 mx-auto mb-1 text-yellow-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:u.expensesCount}),e.jsx("div",{className:"text-xs text-gray-400",children:"Note Spese"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(ht,{className:"h-5 w-5 mx-auto mb-1 text-green-400"}),e.jsxs("div",{className:"text-lg font-bold text-white",children:[u.overtimeHours.toFixed(1),"h"]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Straordinari"})]})]})]}),_==="events"&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Dettaglio Eventi (",l.length,")"]}),l.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(xt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsx("p",{children:"Nessun evento nel periodo selezionato"}),e.jsx("p",{className:"text-sm mt-1",children:"Seleziona un mese diverso o attendi nuove assegnazioni"})]}):e.jsx("div",{className:"space-y-4",children:l.map(Z=>e.jsx(Hd,{report:{...Z,benefitBreakdown:Z.benefitBreakdown},onRectify:()=>{N(Z),U(!0)}},Z.assignment.id))})]}),_==="warehouse"&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Turni Magazzino (",M.length,R.length!==M.length?` di ${R.length}`:"",")"]}),e.jsxs("div",{className:"mb-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Giorno Specifico:"}),e.jsx("input",{type:"date",value:C,onChange:Z=>K(Z.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",placeholder:"Seleziona un giorno..."}),C&&e.jsx("button",{onClick:()=>K(""),className:"mt-2 text-xs text-blue-400 hover:text-blue-300",children:"Rimuovi filtro data"})]}),se.length>1&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Magazzino:"}),e.jsxs("select",{value:O,onChange:Z=>X(Z.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",children:[e.jsx("option",{value:"all",children:"Tutti i Magazzini"}),se.map(Z=>e.jsx("option",{value:Z.id,children:Z.name},Z.id))]})]}),(C||O!=="all")&&e.jsxs("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-2 text-xs text-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ga,{className:"h-3 w-3"}),e.jsx("span",{className:"font-semibold",children:"Filtri attivi:"})]}),e.jsxs("div",{className:"mt-1 space-y-1",children:[C&&e.jsxs("div",{children:["Data: ",ne(C).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"})]}),O!=="all"&&e.jsxs("div",{children:["Magazzino: ",(be=se.find(Z=>Z.id===O))==null?void 0:be.name]})]})]})]}),M.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Rt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsxs("p",{children:["Nessun turno ",C||O!=="all"?"trovato con i filtri selezionati":"nel periodo selezionato"]}),e.jsx("p",{className:"text-sm mt-1",children:C||O!=="all"?"Prova a modificare i filtri":"I turni appariranno qui"})]}):e.jsx("div",{className:"space-y-3",children:M.map(Z=>{const L=Z.check_out_turno||Z.rectified_check_out,re=Z.status!=="completed"||!L;return e.jsxs("div",{className:"bg-gray-700 rounded-lg p-4 border border-gray-600",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h4",{className:"font-bold text-white",children:Z.nome_turno||"Turno Magazzino"}),Z.is_rectified&&e.jsx("span",{className:"bg-orange-600 text-white text-xs px-2 py-0.5 rounded font-semibold",children:"Rettificato"})]}),e.jsx("p",{className:"text-sm text-gray-400",children:ne(Z.giorno_turno).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})})]}),e.jsx("div",{className:"text-right",children:re?e.jsx("div",{className:"text-sm text-orange-400 font-semibold",children:"In corso"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-lg font-bold text-blue-400",children:[Z.conteggio_ore,"h"]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Ore Lavorate"})]})})]}),e.jsx("div",{className:"bg-gray-800 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[e.jsx(ht,{className:"h-3 w-3 text-green-400"}),e.jsx("span",{className:"text-gray-400 font-medium",children:"Check-in:"})]}),e.jsx("div",{className:"text-white font-semibold",children:me(Z.check_in_turno)||"--:--"}),Z.is_rectified&&Z.original_check_in&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",me(Z.original_check_in)]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[e.jsx(ht,{className:"h-3 w-3 text-red-400"}),e.jsx("span",{className:"text-gray-400 font-medium",children:"Check-out:"})]}),re?e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-orange-400 font-semibold",children:"In corso"}),Z.is_rectified&&Z.rectified_check_out&&e.jsxs("div",{className:"text-green-400 text-xs mt-1 flex items-center space-x-1",children:[e.jsx(pt,{className:"h-3 w-3"}),e.jsxs("span",{children:["Chiuso via rettifica: ",me(Z.rectified_check_out)]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-white font-semibold flex items-center space-x-1 flex-wrap",children:[e.jsx("span",{children:me(Z.check_out_turno)||"--:--"}),Z.auto_checkout&&e.jsx("span",{className:"text-xs bg-purple-900 text-purple-200 px-1 py-0.5 rounded",title:"Checkout automatico",children:"AUTO"}),Z.is_rectified&&Z.rectified_check_out&&!Z.original_check_out&&e.jsx("span",{className:"text-xs bg-green-900 text-green-200 px-1 py-0.5 rounded",title:"Chiuso via rettifica",children:"RETTIFICA"})]}),Z.is_rectified&&Z.original_check_out&&Z.rectified_check_out&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",me(Z.original_check_out),Z.auto_checkout&&e.jsx("span",{className:"ml-1",children:"(AUTO)"})]}),Z.is_rectified&&!Z.original_check_out&&Z.rectified_check_out&&e.jsx("div",{className:"text-gray-500 text-xs mt-1 italic",children:"(Non era stato effettuato)"})]})]})]})}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 mb-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm text-gray-300",children:"Pausa Pranzo:"})]}),e.jsxs("div",{className:"text-right",children:[Z.pausa_pranzo?e.jsxs("div",{children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"S√¨"}),Z.pausa_pranzo_inizio&&Z.pausa_pranzo_fine&&e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[Z.pausa_pranzo_inizio," - ",Z.pausa_pranzo_fine,Z.pausa_pranzo_minuti&&` (${Z.pausa_pranzo_minuti} min)`]})]}):e.jsx("span",{className:"text-gray-500",children:"No"}),Z.is_rectified&&Z.original_pausa_pranzo!==Z.pausa_pranzo&&e.jsxs("div",{className:"text-xs text-gray-500 line-through mt-1",children:["Era: ",Z.original_pausa_pranzo?"S√¨":"No"]})]})]}),Z.pausa_cena&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-700",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ls,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-gray-300",children:"Pausa Cena:"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"S√¨"}),Z.pausa_cena_inizio&&Z.pausa_cena_fine&&e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[Z.pausa_cena_inizio," - ",Z.pausa_cena_fine,Z.pausa_cena_minuti&&` (${Z.pausa_cena_minuti} min)`]})]})]}),Z.pausa_totale_minuti&&Z.pausa_totale_minuti>0&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-700",children:[e.jsx("span",{className:"text-xs text-gray-400",children:"Pausa Totale:"}),e.jsxs("span",{className:"text-xs text-gray-300 font-semibold",children:[Z.pausa_totale_minuti," minuti"]})]})]}),(Z.notes||Z.noteturno)&&e.jsx("div",{className:"bg-blue-900 bg-opacity-20 border border-blue-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(qt,{className:"h-4 w-4 text-blue-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-1",children:"Note:"}),e.jsx("div",{className:"text-xs text-blue-100",children:Z.notes||Z.noteturno})]})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs mb-2",children:[Z.buoni_pasto_assegnato&&e.jsxs("span",{className:"bg-yellow-900 text-yellow-200 px-2 py-1 rounded flex items-center space-x-1",children:[e.jsx(js,{className:"h-3 w-3"}),e.jsx("span",{children:"Buono Pasto"})]}),Z.pasto_aziendale_usufruito&&e.jsxs("span",{className:"bg-orange-900 text-orange-200 px-2 py-1 rounded flex items-center space-x-1",children:[e.jsx(Ls,{className:"h-3 w-3"}),e.jsx("span",{children:"Pasto Aziendale"})]})]}),Z.is_rectified&&Z.rectification_note&&e.jsx("div",{className:"bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-orange-200 mb-1",children:"Nota di Rettifica:"}),e.jsx("div",{className:"text-xs text-orange-300",children:Z.rectification_note})]})]})}),e.jsx(Ud,{shift:Z,onUpdate:ye})]},Z.id)})})]}),!u&&!g&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700 text-center",children:[e.jsx(qt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Nessun Dato Disponibile"}),e.jsx("p",{className:"text-gray-300",children:"Non ci sono eventi per il periodo selezionato."}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Prova a selezionare un mese diverso o attendi nuove assegnazioni."})]}),e.jsx(cn,{})]}),F&&te&&e.jsx(Vd,{event:{id:te.assignment.id,evento_id:te.assignment.evento_id,nome_evento:te.assignment.nome_evento,giorno_inizio_evento:te.assignment.giorno_inizio_evento,giorno_fine_evento:te.assignment.giorno_fine_evento},existingTimesheet:te.timesheet,onClose:()=>{U(!1),N(null)},onSuccess:()=>{ye()}})]})},Gd=({isOpen:n,title:l,message:c,onConfirm:u,onCancel:f,confirmText:x="Conferma",cancelText:b="Annulla",type:v="warning"})=>{if(!n)return null;const S={danger:"bg-red-600 hover:bg-red-700",success:"bg-green-600 hover:bg-green-700",warning:"bg-yellow-600 hover:bg-yellow-700"}[v];return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:e.jsxs("div",{className:"bg-gray-900 rounded-xl border border-gray-800 p-6 max-w-md w-full",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:l}),e.jsx("p",{className:"text-gray-300 mb-6",children:c}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:u,className:`flex-1 px-4 py-2 ${S} text-white rounded-lg font-medium`,children:x}),e.jsx("button",{onClick:f,className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium",children:b})]})]})})},Wd=({isOpen:n,dipendenteNome:l,onConfirm:c,onCancel:u})=>{const[f,x]=w.useState("");return n?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:e.jsxs("div",{className:"bg-gray-900 rounded-xl border border-gray-800 p-6 max-w-md w-full",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Rifiuta richiesta"}),e.jsxs("p",{className:"text-gray-300 mb-4",children:["Inserisci il motivo del rifiuto per ",l,":"]}),e.jsx("textarea",{value:f,onChange:b=>x(b.target.value),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-red-500 focus:border-transparent mb-4",rows:3,placeholder:"Motivo del rifiuto..."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{c(f),x("")},className:"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium",children:"Rifiuta"}),e.jsx("button",{onClick:()=>{u(),x("")},className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium",children:"Annulla"})]})]})}):null},Yd=()=>{const{companyProfile:n}=us(),{showSuccess:l,showError:c}=Dr(),[u,f]=w.useState("ferie"),[x,b]=w.useState("pending"),[v,S]=w.useState([]),[g,E]=w.useState([]),[p,k]=w.useState([]),[P,D]=w.useState([]),[R,j]=w.useState([]),[M,T]=w.useState(!1),[F,U]=w.useState(!1),[te,N]=w.useState(!1),[_,V]=w.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}}),[C,K]=w.useState({isOpen:!1,requestId:"",dipendenteNome:""}),[O,X]=w.useState({dipendente_id:"",tipo:"ferie",data_inizio:"",data_fine:"",orario_inizio:"",orario_fine:"",certificato_medico:"",note:""}),[se,W]=w.useState({id:"",dipendente_id:"",tipo:"ferie",data_inizio:"",data_fine:"",orario_inizio:"",orario_fine:"",certificato_medico:"",note:""});w.useEffect(()=>{n!=null&&n.id&&(G(),B())},[n==null?void 0:n.id,x]);const G=async()=>{if(n!=null&&n.id)try{const{data:oe,error:ge}=await Le.from("registration_requests").select("id, full_name, email").eq("parent_company_id",n.id).eq("status","approved").in("tipologia_registrazione",["dipendente","freelance"]).order("full_name",{ascending:!0});if(ge)throw ge;S(oe||[])}catch(oe){console.error("Errore caricamento dipendenti:",oe)}},B=async()=>{if(n!=null&&n.id){T(!0);try{const oe=x==="pending"?"in_attesa":"approvata",[ge,ve]=await Promise.all([Le.from("crew_richiesteferie_permessi").select("*").eq("azienda_id",n.id).eq("stato",oe).order("created_at",{ascending:!1}),Le.from("crew_malattia_infortunio").select("*").eq("azienda_id",n.id).order("created_at",{ascending:!1})]);if(ge.data){const Te=ge.data.filter(je=>je.tipo_richiesta==="ferie").map(je=>({id:je.id,dipendente_id:je.dipendente_id,dipendente_nome:je.dipendente_nome||"N/D",tipo:"ferie",data_inizio:je.data_inizio,data_fine:je.data_fine,giorni_richiesti:je.giorni_richiesti||0,note:je.note,stato:je.stato,created_at:je.created_at})),we=ge.data.filter(je=>je.tipo_richiesta==="permesso").map(je=>({id:je.id,dipendente_id:je.dipendente_id,dipendente_nome:je.dipendente_nome||"N/D",tipo:"permessi",data_inizio:je.data_inizio,data_fine:je.data_fine,ore_richieste:je.ore_richieste||0,orario_inizio:je.orario_inizio,orario_fine:je.orario_fine,note:je.note,stato:je.stato,created_at:je.created_at}));E(Te),k(we)}if(ve.data){const Te=ve.data.filter(je=>je.tipo==="malattia").map(je=>({id:je.id,dipendente_id:je.dipendente_id,dipendente_nome:je.dipendente_nome||"N/D",tipo:"malattia",data_inizio:je.data_inizio,data_fine:je.data_fine,giorni_totali:je.giorni_totali||0,certificato_medico:je.certificato_medico,note:je.note,created_at:je.created_at})),we=ve.data.filter(je=>je.tipo==="infortunio").map(je=>({id:je.id,dipendente_id:je.dipendente_id,dipendente_nome:je.dipendente_nome||"N/D",tipo:"infortunio",data_inizio:je.data_inizio,data_fine:je.data_fine,giorni_totali:je.giorni_totali||0,certificato_medico:je.certificato_medico,note:je.note,created_at:je.created_at}));D(Te),j(we)}}catch(oe){console.error("Errore caricamento richieste:",oe),c("Impossibile caricare le richieste")}finally{T(!1)}}},ne=async oe=>{try{const{error:ge}=await Le.from("crew_richiesteferie_permessi").update({stato:"approvata",approvato_da:n==null?void 0:n.auth_user_id,approvato_il:new Date().toISOString()}).eq("id",oe);if(ge)throw ge;l("Richiesta approvata con successo"),B()}catch(ge){console.error("Errore approvazione:",ge),c(ge.message||"Errore durante l'approvazione")}},ye=async(oe,ge)=>{try{const{error:ve}=await Le.from("crew_richiesteferie_permessi").update({stato:"rifiutata",approvato_da:n==null?void 0:n.auth_user_id,approvato_il:new Date().toISOString(),motivo_rifiuto:ge||"Nessun motivo specificato"}).eq("id",oe);if(ve)throw ve;l("Richiesta rifiutata"),B()}catch(ve){console.error("Errore rifiuto:",ve),c(ve.message||"Errore durante il rifiuto")}},me=async(oe,ge)=>{try{if(ge==="ferie"||ge==="permessi"){const{error:ve}=await Le.from("crew_richiesteferie_permessi").delete().eq("id",oe);if(ve)throw ve}else{const{error:ve}=await Le.from("crew_malattia_infortunio").delete().eq("id",oe);if(ve)throw ve}l("Elemento eliminato con successo"),B()}catch(ve){console.error("Errore eliminazione:",ve),c(ve.message||"Errore durante l'eliminazione")}},Q=oe=>{if(u==="malattia"||u==="infortunio"){const ve=oe;W({id:ve.id,dipendente_id:ve.dipendente_id,tipo:u,data_inizio:ve.data_inizio,data_fine:ve.data_fine,orario_inizio:"",orario_fine:"",certificato_medico:ve.certificato_medico||"",note:ve.note||""})}else{const ve=oe;W({id:ve.id,dipendente_id:ve.dipendente_id,tipo:u,data_inizio:ve.data_inizio,data_fine:ve.data_fine,orario_inizio:ve.orario_inizio||"",orario_fine:ve.orario_fine||"",certificato_medico:"",note:ve.note||""})}N(!0)},fe=async oe=>{if(oe.preventDefault(),!(n!=null&&n.id)||!se.dipendente_id){c("Seleziona un dipendente");return}try{if(se.tipo==="ferie"||se.tipo==="permessi"){let ge=0,ve=0,Te=se.data_fine;if(se.tipo==="permessi"){const[je,Fe]=se.orario_inizio.split(":").map(Number),[Ve,rt]=se.orario_fine.split(":").map(Number),st=je*60+Fe;ve=(Ve*60+rt-st)/60,Te=se.data_inizio}else{const je=new Date(se.data_inizio),Fe=new Date(se.data_fine),Ve=Math.abs(Fe.getTime()-je.getTime());ge=Math.ceil(Ve/(1e3*60*60*24))+1}const{error:we}=await Le.from("crew_richiesteferie_permessi").update({data_inizio:se.data_inizio,data_fine:Te,giorni_richiesti:ge,ore_richieste:ve,orario_inizio:se.tipo==="permessi"?se.orario_inizio:null,orario_fine:se.tipo==="permessi"?se.orario_fine:null,note:se.note||null}).eq("id",se.id);if(we)throw we;l(`${se.tipo==="ferie"?"Ferie":"Permesso"} modificato con successo`)}else if(se.tipo==="malattia"||se.tipo==="infortunio"){const ge=new Date(se.data_inizio),ve=new Date(se.data_fine),Te=Math.abs(ve.getTime()-ge.getTime()),we=Math.ceil(Te/(1e3*60*60*24))+1,{error:je}=await Le.from("crew_malattia_infortunio").update({data_inizio:se.data_inizio,data_fine:se.data_fine,giorni_totali:we,certificato_medico:se.certificato_medico||null,note:se.note||null}).eq("id",se.id);if(je)throw je;l(`${se.tipo==="malattia"?"Malattia":"Infortunio"} modificato con successo`)}N(!1),B()}catch(ge){console.error("Errore modifica:",ge),c(ge.message||"Errore durante la modifica")}},be=async oe=>{if(oe.preventDefault(),!(n!=null&&n.id)||!O.dipendente_id){c("Seleziona un dipendente");return}if(!O.data_inizio){c("Inserisci la data");return}if(O.tipo==="permessi"&&(!O.orario_inizio||!O.orario_fine)){c("Inserisci gli orari per il permesso");return}if(O.tipo!=="permessi"&&!O.data_fine){c("Inserisci la data fine");return}try{const ge=v.find(ve=>ve.id===O.dipendente_id);if(O.tipo==="ferie"||O.tipo==="permessi"){let ve=0,Te=0,we=O.data_fine;if(O.tipo==="permessi"){const[Ve,rt]=O.orario_inizio.split(":").map(Number),[st,Je]=O.orario_fine.split(":").map(Number),Qe=Ve*60+rt;Te=(st*60+Je-Qe)/60,we=O.data_inizio}else{const Ve=new Date(O.data_inizio),rt=new Date(O.data_fine),st=Math.abs(rt.getTime()-Ve.getTime());ve=Math.ceil(st/(1e3*60*60*24))+1}const je=O.tipo==="permessi"?"permesso":"ferie",{error:Fe}=await Le.from("crew_richiesteferie_permessi").insert({azienda_id:n.id,dipendente_id:O.dipendente_id,dipendente_nome:(ge==null?void 0:ge.full_name)||"",tipo_richiesta:je,data_inizio:O.data_inizio,data_fine:we,giorni_richiesti:ve,ore_richieste:Te,orario_inizio:O.tipo==="permessi"?O.orario_inizio:null,orario_fine:O.tipo==="permessi"?O.orario_fine:null,note:O.note||null,stato:"approvata",approvato_da:n.auth_user_id,approvato_il:new Date().toISOString()});if(Fe)throw Fe;l(`${O.tipo==="ferie"?"Ferie":"Permesso"} inserito con successo`)}else if(O.tipo==="malattia"||O.tipo==="infortunio"){const ve=new Date(O.data_inizio),Te=new Date(O.data_fine),we=Math.abs(Te.getTime()-ve.getTime()),je=Math.ceil(we/(1e3*60*60*24))+1,{error:Fe}=await Le.from("crew_malattia_infortunio").insert({azienda_id:n.id,dipendente_id:O.dipendente_id,dipendente_nome:(ge==null?void 0:ge.full_name)||"",tipo:O.tipo,data_inizio:O.data_inizio,data_fine:O.data_fine,giorni_totali:je,certificato_medico:O.certificato_medico||null,note:O.note||null});if(Fe)throw Fe;l(`${O.tipo==="malattia"?"Malattia":"Infortunio"} inserito con successo`)}U(!1),X({dipendente_id:"",tipo:"ferie",data_inizio:"",data_fine:"",orario_inizio:"",orario_fine:"",certificato_medico:"",note:""}),B()}catch(ge){console.error("Errore inserimento:",ge),c(ge.message||"Errore nell'inserimento")}},Z=()=>{switch(u){case"ferie":return g;case"permessi":return p;case"malattia":return P;case"infortunio":return R;default:return[]}},L=oe=>{var je;const ge=u==="malattia"||u==="infortunio",ve=oe,Te=oe,we=x==="pending"&&(u==="ferie"||u==="permessi");return e.jsxs("div",{className:"bg-gray-900 rounded-xl border border-gray-800 p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[ge?e.jsx(Ba,{className:"w-5 h-5 text-red-500"}):e.jsx(xt,{className:"w-5 h-5 text-blue-500"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-white",children:oe.dipendente_nome}),e.jsx("p",{className:"text-xs text-gray-400",children:new Date(oe.created_at).toLocaleDateString("it-IT",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})})]})]}),we&&e.jsx(ht,{className:"w-5 h-5 text-yellow-500"})]}),e.jsx("div",{className:"space-y-2 mb-4",children:u==="permessi"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Giorno:"}),e.jsx("span",{className:"text-white font-medium",children:new Date(Te.data_inizio).toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"})})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Orario:"}),e.jsxs("span",{className:"text-white font-medium",children:[Te.orario_inizio," - ",Te.orario_fine]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Ore:"}),e.jsxs("span",{className:"text-white font-medium",children:[((je=Te.ore_richieste)==null?void 0:je.toFixed(1))||0," h"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Dal:"}),e.jsx("span",{className:"text-white font-medium",children:new Date(oe.data_inizio).toLocaleDateString("it-IT",{day:"numeric",month:"short",year:"numeric"})})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Al:"}),e.jsx("span",{className:"text-white font-medium",children:new Date(oe.data_fine).toLocaleDateString("it-IT",{day:"numeric",month:"short",year:"numeric"})})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Giorni:"}),e.jsxs("span",{className:"text-white font-medium",children:[ge?ve.giorni_totali:Te.giorni_richiesti," giorni"]})]})]})}),ge&&ve.certificato_medico&&e.jsx("div",{className:"mb-4",children:e.jsxs("a",{href:ve.certificato_medico,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 bg-blue-900 text-blue-300 rounded-lg hover:bg-blue-800 text-sm",children:[e.jsx(qt,{className:"w-4 h-4"}),"Certificato"]})}),oe.note&&e.jsxs("div",{className:"mb-4 p-3 bg-gray-800 rounded-lg",children:[e.jsx("span",{className:"text-xs font-medium text-gray-400",children:"Note:"}),e.jsx("p",{className:"text-sm text-gray-300 mt-1",children:oe.note})]}),e.jsx("div",{className:"flex gap-2",children:we?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{V({isOpen:!0,title:"Approva richiesta",message:`Confermi di voler approvare la richiesta di ${oe.dipendente_nome}?`,onConfirm:()=>{ne(oe.id),V({..._,isOpen:!1})},type:"success"})},className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center justify-center gap-2 text-sm font-medium",children:[e.jsx(qr,{className:"w-4 h-4"}),"Approva"]}),e.jsxs("button",{onClick:()=>{K({isOpen:!0,requestId:oe.id,dipendenteNome:oe.dipendente_nome})},className:"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg flex items-center justify-center gap-2 text-sm font-medium",children:[e.jsx(Et,{className:"w-4 h-4"}),"Rifiuta"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>Q(oe),className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center gap-2 text-sm font-medium",children:[e.jsx(_o,{className:"w-4 h-4"}),"Modifica"]}),e.jsxs("button",{onClick:()=>{V({isOpen:!0,title:"Elimina elemento",message:`Confermi di voler eliminare questo elemento per ${oe.dipendente_nome}?`,onConfirm:()=>{me(oe.id,u),V({..._,isOpen:!1})},type:"danger"})},className:"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg flex items-center justify-center gap-2 text-sm font-medium",children:[e.jsx(Xs,{className:"w-4 h-4"}),"Elimina"]})]})})]},oe.id)};if(!(n!=null&&n.id))return e.jsx("div",{className:"min-h-screen bg-neutral-950 flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Nt,{className:"w-12 h-12 text-red-500 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-400",children:"Impossibile identificare l'azienda"})]})});const re=Z(),de=[{id:"ferie",label:"Ferie",count:g.length,icon:xt},{id:"permessi",label:"Permessi",count:p.length,icon:ht},{id:"malattia",label:"Malattia",count:P.length,icon:Ba},{id:"infortunio",label:"Infortunio",count:R.length,icon:Ba}];return e.jsxs("div",{className:"min-h-screen bg-neutral-950 text-white pb-20",children:[e.jsxs("header",{className:"sticky top-0 z-40 bg-gray-900/95 backdrop-blur-sm border-b border-gray-800",children:[e.jsxs("div",{className:"px-4 py-4",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Gestione Richieste"}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Gestisci ferie, permessi e assenze"})]}),e.jsx("div",{className:"px-4 pb-3 flex gap-2 overflow-x-auto",children:de.map(oe=>{const ge=oe.icon;return e.jsxs("button",{onClick:()=>f(oe.id),className:`flex items-center gap-2 px-4 py-2 rounded-lg whitespace-nowrap transition-colors ${u===oe.id?"bg-gradient-to-r from-blue-600 to-cyan-500 text-white":"bg-gray-800 text-gray-400 hover:text-white"}`,children:[e.jsx(ge,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:oe.label}),oe.count>0&&e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-bold ${u===oe.id?"bg-white text-blue-600":"bg-gray-700 text-gray-300"}`,children:oe.count})]},oe.id)})}),e.jsxs("div",{className:"px-4 pb-3 flex gap-2",children:[e.jsx("button",{onClick:()=>b("pending"),className:`flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${x==="pending"?"bg-yellow-600 text-white":"bg-gray-800 text-gray-400 hover:text-white"}`,children:"In attesa"}),e.jsx("button",{onClick:()=>b("approved"),className:`flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${x==="approved"?"bg-green-600 text-white":"bg-gray-800 text-gray-400 hover:text-white"}`,children:"Approvate"})]})]}),e.jsxs("main",{className:"px-4 py-6",children:[e.jsxs("button",{onClick:()=>{X({...O,tipo:u}),U(!0)},className:"w-full mb-4 px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-500 text-white rounded-lg hover:from-green-700 hover:to-emerald-600 flex items-center justify-center gap-2 font-medium",children:[e.jsx(pa,{className:"w-5 h-5"}),"Inserisci ",u]}),M?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):re.length===0?e.jsxs("div",{className:"bg-gray-900 rounded-xl border border-gray-800 p-12 text-center",children:[e.jsx(xt,{className:"w-16 h-16 mx-auto mb-4 text-gray-600"}),e.jsx("p",{className:"text-gray-400 text-lg",children:"Nessun elemento trovato"}),e.jsxs("p",{className:"text-gray-500 text-sm mt-2",children:["Non ci sono ",x==="pending"?"richieste in attesa":"elementi approvati"," per ",u]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("h2",{className:"text-lg font-semibold",children:[x==="pending"?"In attesa":"Approvate"," (",re.length,")"]})}),re.map(oe=>L(oe))]})]}),F&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 overflow-y-auto",children:e.jsxs("div",{className:"bg-gray-900 rounded-xl border border-gray-800 p-6 max-w-md w-full my-8",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Inserisci ",u]}),e.jsxs("form",{onSubmit:be,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Dipendente ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:O.dipendente_id,onChange:oe=>X({...O,dipendente_id:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0,children:[e.jsx("option",{value:"",children:"Seleziona dipendente"}),v.map(oe=>e.jsx("option",{value:oe.id,children:oe.full_name},oe.id))]})]}),u==="permessi"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Giorno ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:O.data_inizio,onChange:oe=>X({...O,data_inizio:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Dalle ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"time",value:O.orario_inizio,onChange:oe=>X({...O,orario_inizio:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Alle ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"time",value:O.orario_fine,onChange:oe=>X({...O,orario_fine:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]})]})]}):e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Dal ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:O.data_inizio,onChange:oe=>X({...O,data_inizio:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Al ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:O.data_fine,onChange:oe=>X({...O,data_fine:oe.target.value}),min:O.data_inizio,className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]})]}),(u==="malattia"||u==="infortunio")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Link Certificato Medico"}),e.jsx("input",{type:"url",value:O.certificato_medico,onChange:oe=>X({...O,certificato_medico:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",placeholder:"https://..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Note"}),e.jsx("textarea",{value:O.note,onChange:oe=>X({...O,note:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",rows:3,placeholder:"Note aggiuntive..."})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium",children:"Conferma"}),e.jsx("button",{type:"button",onClick:()=>{U(!1),X({dipendente_id:"",tipo:"ferie",data_inizio:"",data_fine:"",orario_inizio:"",orario_fine:"",certificato_medico:"",note:""})},className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium",children:"Annulla"})]})]})]})}),te&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 overflow-y-auto",children:e.jsxs("div",{className:"bg-gray-900 rounded-xl border border-gray-800 p-6 max-w-md w-full my-8",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Modifica ",u]}),e.jsxs("form",{onSubmit:fe,className:"space-y-4",children:[se.tipo==="permessi"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Giorno ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:se.data_inizio,onChange:oe=>W({...se,data_inizio:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Dalle ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"time",value:se.orario_inizio,onChange:oe=>W({...se,orario_inizio:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Alle ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"time",value:se.orario_fine,onChange:oe=>W({...se,orario_fine:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]})]})]}):e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Dal ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:se.data_inizio,onChange:oe=>W({...se,data_inizio:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Al ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:se.data_fine,onChange:oe=>W({...se,data_fine:oe.target.value}),min:se.data_inizio,className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]})]}),(se.tipo==="malattia"||se.tipo==="infortunio")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Link Certificato Medico"}),e.jsx("input",{type:"url",value:se.certificato_medico,onChange:oe=>W({...se,certificato_medico:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",placeholder:"https://..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Note"}),e.jsx("textarea",{value:se.note,onChange:oe=>W({...se,note:oe.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",rows:3,placeholder:"Note aggiuntive..."})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium",children:"Salva Modifiche"}),e.jsx("button",{type:"button",onClick:()=>N(!1),className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium",children:"Annulla"})]})]})]})}),e.jsx(Gd,{isOpen:_.isOpen,title:_.title,message:_.message,onConfirm:_.onConfirm,onCancel:()=>V({..._,isOpen:!1}),type:_.type}),e.jsx(Wd,{isOpen:C.isOpen,dipendenteNome:C.dipendenteNome,onConfirm:oe=>{ye(C.requestId,oe),K({isOpen:!1,requestId:"",dipendenteNome:""})},onCancel:()=>K({isOpen:!1,requestId:"",dipendenteNome:""})})]})},$d=()=>{const{companyProfile:n}=us(),[l,c]=w.useState("list"),[u,f]=w.useState([]),[x,b]=w.useState([]),[v,S]=w.useState(null),[g,E]=w.useState([]),[p,k]=w.useState([]),[P,D]=w.useState(!0),[R,j]=w.useState(null),[M,T]=w.useState(null),[F,U]=w.useState({}),[te,N]=w.useState({title:"",description:"",type:"event",start_date:"",end_date:"",location:"",address:"",required_crew:1,link_scheda_tecnica:"",link_mappa_gps:""}),[_,V]=w.useState([]),[C,K]=w.useState(new Map),[O,X]=w.useState([]),[se,W]=w.useState(null),[G,B]=w.useState(""),[ne,ye]=w.useState(null),[me,Q]=w.useState({title:"",type:"event",start_date:"",end_date:"",location:"",visibility:"public",benefits_evento_ids:[]});w.useEffect(()=>{n!=null&&n.id&&fe()},[n]);const fe=async()=>{try{D(!0),j(null);const[H,ae,he,Ae]=await Promise.all([Le.from("crew_events_temp").select("*").eq("company_id",n.id).order("created_at",{ascending:!1}),Le.from("crew_events").select("*").eq("company_id",n.id).gte("end_date",new Date().toISOString().split("T")[0]).order("start_date",{ascending:!0}),Le.from("registration_requests").select("id, full_name, email, tipologia_registrazione, company_name").eq("parent_company_id",n.id).eq("status","approved").in("tipologia_registrazione",["dipendente","freelance"]).order("full_name",{ascending:!0}),Le.from("crew_tariffe").select("id, nome_tariffa, importo, tipo_calcolo, categoria").eq("azienda_id",n.id).eq("attivo",!0)]);if(H.error)throw H.error;if(ae.error)throw ae.error;if(he.error)throw he.error;const Re=he.data||[],le=(await Promise.all(Re.map(async Ee=>{const{data:_e}=await Le.from("crew_ruoli").select("visibile_in_eventi").eq("dipendente_id",Ee.id).eq("azienda_id",n.id).eq("attivo",!0).maybeSingle();return{...Ee,visibile_in_eventi:(_e==null?void 0:_e.visibile_in_eventi)??!0}}))).filter(Ee=>Ee.visibile_in_eventi);if(f(H.data||[]),b(ae.data||[]),E(le),!Ae.error&&Ae.data){const Ee=Ae.data.map(_e=>({id:_e.id,nome:_e.nome_tariffa,importo:parseFloat(_e.importo)||0,categoria:_e.categoria||"altro"}));k(Ee)}}catch(H){console.error("Errore caricamento dati:",H),j(H.message)}finally{D(!1)}},be=(H,ae)=>{const he=[],Ae=new Date(H),Re=new Date(ae);let ee=1;for(let le=new Date(Ae);le<=Re;le.setDate(le.getDate()+1))he.push({giorno:ee,nome:ee===1?"Giorno 1":`Giorno ${ee}`,data:le.toISOString().split("T")[0],orario_convocazione:"09:00",tariffe_abilitate:[],bonus_previsti:0}),ee++;return he},Z=(H,ae)=>{N(he=>{const Ae={...he,[H]:ae};if(Ae.start_date&&Ae.end_date){const Re=be(Ae.start_date,Ae.end_date);V(Re)}return Ae})},L=(H,ae,he)=>{V(Ae=>{const Re=[...Ae];return Re[H]={...Re[H],[ae]:he},Re})},re=(H,ae)=>{console.log("Toggle tariffa:",{dayIndex:H,tariffaId:ae}),V(he=>{const Ae=[...he],Re=Ae[H].tariffe_abilitate;return Re.includes(ae)?(Ae[H].tariffe_abilitate=Re.filter(ee=>ee!==ae),console.log("Rimossa tariffa:",ae)):(Ae[H].tariffe_abilitate=[...Re,ae],console.log("Aggiunta tariffa:",ae)),console.log("Tariffe aggiornate per giorno",H,":",Ae[H].tariffe_abilitate),Ae})},de=async()=>{try{if(!te.title||!te.start_date||!te.end_date){j("Compila tutti i campi obbligatori");return}D(!0),j(null);const ae={id_gruppo_evento:se||`evt-${Date.now()}`,company_id:n.id,...te,giorni_config:_,status:"draft",required_crew_per_day:_.reduce((he,Ae)=>(he[Ae.data]=te.required_crew,he),{})};if(se){const{error:he}=await Le.from("crew_events_temp").update(ae).eq("id_gruppo_evento",se);if(he)throw he;T("Bozza aggiornata con successo!")}else{const{error:he}=await Le.from("crew_events_temp").insert(ae);if(he)throw he;T("Bozza salvata con successo!")}await fe(),We(),c("list"),setTimeout(()=>T(null),3e3)}catch(H){console.error("Errore salvataggio bozza:",H),j(H.message)}finally{D(!1)}},oe=async H=>{try{D(!0),j(null);const ae=H.giorni_config.length>1,he=H.giorni_config.length,Ae=[];for(const le of H.giorni_config){const Ee={company_id:H.company_id,title:ae?`${H.title} - ${le.nome}`:H.title,description:H.description,type:H.type,start_date:le.data,end_date:le.data,location:H.location,address:H.address,call_time:le.orario_convocazione,event_group_code:H.id_gruppo_evento,is_multi_day_event:!1,parent_event_id:null,day_number:1,total_days:1,day_name:le.nome,benefits_evento_ids:le.tariffe_abilitate.filter(_e=>_e!=="diaria_eventi"&&_e!=="diaria_trasferta"),diaria_abilitata:le.tariffe_abilitate.includes("diaria_eventi")||le.tariffe_abilitate.includes("diaria_trasferta"),diaria_tipo:le.tariffe_abilitate.includes("diaria_eventi")?"evento":le.tariffe_abilitate.includes("diaria_trasferta")?"trasferta":null,buoni_pasto_evento:!1,status:"published",is_confirmed:!0,link_scheda_tecnica:H.link_scheda_tecnica,link_mappa_gps:H.link_mappa_gps};Ae.push(Ee)}const{error:Re}=await Le.from("crew_events").insert(Ae);if(Re)throw Re;const{error:ee}=await Le.from("crew_events_temp").delete().eq("id_gruppo_evento",H.id_gruppo_evento);if(ee)throw ee;T(`Evento confermato! Creati ${Ae.length} giorni.`),await fe(),setTimeout(()=>T(null),3e3)}catch(ae){console.error("Errore conferma evento:",ae),j(ae.message)}finally{D(!1)}},ge=async H=>{if(confirm("Sei sicuro di voler eliminare questa bozza?"))try{D(!0);const{error:ae}=await Le.from("crew_events_temp").delete().eq("id_gruppo_evento",H);if(ae)throw ae;T("Bozza eliminata"),await fe(),setTimeout(()=>T(null),2e3)}catch(ae){j(ae.message)}finally{D(!1)}},ve=H=>{N({title:H.title,description:H.description,type:H.type,start_date:H.start_date,end_date:H.end_date,location:H.location,address:H.address,required_crew:H.required_crew,link_scheda_tecnica:H.link_scheda_tecnica||"",link_mappa_gps:H.link_mappa_gps||""}),V(H.giorni_config),W(H.id_gruppo_evento),c("create")},Te=async H=>{if(confirm("Sei sicuro di voler eliminare questo evento? Verranno eliminate anche tutte le assegnazioni crew associate."))try{D(!0);const he=x.filter(ee=>(ee.event_group_code||ee.id)===H).map(ee=>ee.id),{error:Ae}=await Le.from("crew_event_assegnazione").delete().in("evento_id",he);if(Ae)throw Ae;const{error:Re}=await Le.from("crew_events").delete().in("id",he);if(Re)throw Re;T("Evento eliminato con successo!"),await fe(),setTimeout(()=>T(null),3e3)}catch(ae){console.error("Errore eliminazione evento:",ae),j(ae.message)}finally{D(!1)}},we=H=>{const ae=x.filter(Ae=>(Ae.event_group_code||Ae.id)===H),he=ae[0];ye(he),Q({title:he.title.split(" - ")[0],type:he.type||"event",start_date:he.start_date,end_date:ae.length>1?ae[ae.length-1].end_date:he.end_date,location:he.location||"",visibility:he.visibility||"public",benefits_evento_ids:he.benefits_evento_ids||[]}),c("edit")},je=async()=>{try{if(!ne)return;D(!0),j(null);const H=ne.event_group_code||ne.id,ae=x.filter(he=>(he.event_group_code||he.id)===H);for(const he of ae){const Ae={type:me.type,location:me.location,visibility:me.visibility,benefits_evento_ids:me.benefits_evento_ids,updated_at:new Date().toISOString()};if(ae.length===1)Ae.title=me.title,Ae.start_date=me.start_date,Ae.end_date=me.end_date;else{const ee=me.title.split(" - ")[0];Ae.title=`${ee} - ${he.day_name}`}const{error:Re}=await Le.from("crew_events").update(Ae).eq("id",he.id);if(Re)throw Re}T("Evento aggiornato con successo!"),await fe(),ye(null),c("list"),setTimeout(()=>T(null),3e3)}catch(H){console.error("Errore aggiornamento evento:",H),j(H.message)}finally{D(!1)}},Fe=async(H,ae)=>{var he,Ae,Re;try{const[ee,le,Ee]=await Promise.all([Le.from("crew_assegnazionetariffa").select("tariffe_ids, tariffe_personalizzate").eq("dipendente_id",H).eq("azienda_id",n.id).eq("attivo",!0).maybeSingle(),Le.from("crew_tariffe").select("id, nome_tariffa, importo, categoria").eq("azienda_id",n.id).eq("attivo",!0),Le.from("employee_meal_benefits").select("*").eq("dipendente_id",H).eq("azienda_id",n.id).eq("attivo",!0).maybeSingle()]),J=(((he=ee.data)==null?void 0:he.tariffe_ids)||[]).filter(ue=>ae.includes(ue)),ke=((Ae=ee.data)==null?void 0:Ae.tariffe_personalizzate)||{},$=[];for(const ue of J){const xe=(Re=le.data)==null?void 0:Re.find(pe=>pe.id===ue);if(xe){const pe=ke[ue];$.push({id:xe.id,nome:xe.nome_tariffa,importo:pe!==void 0?pe:xe.importo,categoria:xe.categoria})}}return{tariffe_ids:J,tariffe_disponibili:$,meal_benefits:Ee.data}}catch(ee){return console.error("Errore caricamento benefits:",ee),{tariffe_ids:[],tariffe_disponibili:[],meal_benefits:null}}},Ve=async H=>{S(H),c("assign");try{D(!0);const{data:ae,error:he}=await Le.from("crew_event_assegnazione").select("*").eq("evento_id",H.id);if(he){console.error("Errore caricamento assegnazioni:",he),K(new Map),X([]);return}const Ae=new Map,Re=[],ee=new Set((ae==null?void 0:ae.map($=>$.dipendente_freelance_id))||[]),Ee=g.filter($=>!ee.has($.id)).map($=>Le.from("crew_richiesteferie_permessi").select("id, tipo_richiesta").eq("dipendente_id",$.id).eq("status","approved").lte("data_inizio",H.end_date).gte("data_fine",H.start_date).then(ue=>({crew:$,conflicts:ue.data||[]}))),_e=await Promise.all(Ee),J=(ae||[]).map(async $=>{const ue=g.find(Ze=>Ze.id===$.dipendente_freelance_id);if(!ue)return null;let xe=[];if($.benefits_storicizzati&&Array.isArray($.benefits_storicizzati))xe=$.benefits_storicizzati;else{const Ze=(H==null?void 0:H.benefits_evento_ids)||[];xe=(await Fe(ue.id,Ze)).tariffe_disponibili}const pe={crew_id:ue.id,tariffe_ids:$.benefits_evento_ids||[],tariffe_disponibili:xe,diaria_enabled:$.diaria_abilitata||!1,diaria_tipo:$.diaria_tipo||void 0,buoni_pasto_enabled:$.buoni_pasto_abilitati||!1,note:$.note_assegnazione||"",orario_convocazione:$.orario_convocazione||H.call_time||"",is_existing:!0};return{crew:ue,assignment:pe}}),ke=await Promise.all(J);for(const $ of ke)$&&(Ae.set($.crew.id,$.assignment),Re.push({crew:$.crew,status:"assigned",assignment:$.assignment}));for(const{crew:$,conflicts:ue}of _e)ue.length>0?Re.push({crew:$,status:"unavailable",reason:ue.map(xe=>xe.tipo_richiesta).join(", ")}):Re.push({crew:$,status:"available"});K(Ae),X(Re)}catch(ae){console.error("Errore:",ae),K(new Map),X([])}finally{D(!1)}},rt=async H=>{const ae=O.find(ee=>ee.crew.id===H);if(!ae)return;if(ae.status==="unavailable"){j(`${ae.crew.full_name} non √® disponibile: ${ae.reason}`);return}const he=new Map(C),Ae=[...O],Re=Ae.findIndex(ee=>ee.crew.id===H);if(ae.status==="assigned")he.delete(H),Ae[Re]={...Ae[Re],status:"available",assignment:void 0};else{const ee=v,le=(ee==null?void 0:ee.benefits_evento_ids)||[],Ee=await Fe(H,le),_e={crew_id:H,tariffe_ids:Ee.tariffe_ids,tariffe_disponibili:Ee.tariffe_disponibili,diaria_enabled:!1,buoni_pasto_enabled:!1,note:"",orario_convocazione:"",is_existing:!1};he.set(H,_e),Ae[Re]={...Ae[Re],status:"assigned",assignment:_e}}K(he),X(Ae),j(null)},st=(H,ae,he)=>{const Ae=new Map(C),Re=Ae.get(H);if(Re){const ee={...Re,[ae]:he};Ae.set(H,ee),K(Ae);const le=O.map(Ee=>Ee.crew.id===H&&Ee.status==="assigned"?{...Ee,assignment:ee}:Ee);X(le)}},Je=(H,ae,he)=>{const Ae=new Map(C),Re=Ae.get(H);if(Re){const ee=Re.tariffe_disponibili.map(_e=>_e.id===ae?{..._e,importo:he}:_e),le={...Re,tariffe_disponibili:ee};Ae.set(H,le),K(Ae);const Ee=O.map(_e=>_e.crew.id===H&&_e.status==="assigned"?{..._e,assignment:le}:_e);X(Ee)}},Qe=async()=>{try{D(!0),j(null);const H=v;if(!H)return;if(await Le.from("crew_event_assegnazione").delete().eq("evento_id",H.id),C.size===0){T("Assegnazioni aggiornate con successo!"),c("list"),S(null),X([]),setTimeout(()=>T(null),3e3);return}const he=(await Promise.all(Array.from(C).map(async([Re,ee])=>{const le=g.find(xe=>xe.id===Re);if(!le)return null;const Ee=ee.tariffe_disponibili.map(xe=>({id:xe.id,nome:xe.nome,importo:xe.importo,categoria:xe.categoria})),_e=H.diaria_abilitata&&H.diaria_tipo==="evento",J=H.diaria_abilitata&&H.diaria_tipo==="trasferta",ke=[],$=new Date(H.start_date),ue=new Date(H.end_date);for(let xe=new Date($);xe<=ue;xe.setDate(xe.getDate()+1))ke.push(xe.toISOString().split("T")[0]);return{azienda_id:n.id,nome_azienda:n.name||"",dipendente_freelance_id:Re,nome_dipendente_freelance:le.full_name,evento_id:H.id,nome_evento:H.title,giorno_inizio_evento:H.start_date,giorno_fine_evento:H.end_date,evento_localita:H.location,evento_orario_convocazione:H.call_time,orario_convocazione:ee.orario_convocazione||null,bonus_diaria:_e,bonus_trasferta:J,note_assegnazione:ee.note,benefits_evento_ids:ee.tariffe_ids,benefits_storicizzati:Ee.length>0?Ee:null,giorni_assegnati:ke,link_scheda_tecnica:H.link_scheda_tecnica,link_mappa_gps:H.link_mappa_gps}}))).filter(Re=>Re!==null),{error:Ae}=await Le.from("crew_event_assegnazione").insert(he);if(Ae)throw Ae;T(`${he.length} membri assegnati con successo!`),c("list"),S(null),K(new Map),X([]),setTimeout(()=>T(null),3e3)}catch(H){console.error("Errore salvataggio assegnazioni:",H),j(H.message)}finally{D(!1)}},We=()=>{N({title:"",description:"",type:"event",start_date:"",end_date:"",location:"",address:"",required_crew:1,link_scheda_tecnica:"",link_mappa_gps:""}),V([]),W(null)},gt=H=>{U(ae=>({...ae,[H]:!ae[H]}))};if(P&&l==="list")return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"Caricamento..."})]})});if(l==="create")return e.jsxs("div",{className:"space-y-6 p-4 pb-24",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:se?"Modifica Evento":"Nuovo Evento"}),e.jsx("button",{onClick:()=>{We(),c("list")},className:"text-gray-400 hover:text-white",children:e.jsx(Et,{className:"h-6 w-6"})})]}),R&&e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(Nt,{className:"h-5 w-5 text-red-500 flex-shrink-0"}),e.jsx("p",{className:"text-red-400 text-sm",children:R})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Titolo *"}),e.jsx("input",{type:"text",value:te.title,onChange:H=>N(ae=>({...ae,title:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"Nome evento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Descrizione"}),e.jsx("textarea",{value:te.description,onChange:H=>N(ae=>({...ae,description:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white h-24 resize-none",placeholder:"Descrizione evento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Tipo"}),e.jsxs("select",{value:te.type,onChange:H=>N(ae=>({...ae,type:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",children:[e.jsx("option",{value:"event",children:"Evento"}),e.jsx("option",{value:"event_travel",children:"Trasferta"}),e.jsx("option",{value:"training",children:"Formazione"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Data Inizio *"}),e.jsx("input",{type:"date",value:te.start_date,onChange:H=>Z("start_date",H.target.value),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Data Fine *"}),e.jsx("input",{type:"date",value:te.end_date,onChange:H=>Z("end_date",H.target.value),min:te.start_date,className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Localit√†"}),e.jsx("input",{type:"text",value:te.location,onChange:H=>N(ae=>({...ae,location:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"Citt√†"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Indirizzo"}),e.jsx("input",{type:"text",value:te.address,onChange:H=>N(ae=>({...ae,address:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"Via, numero civico"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Crew Richiesta"}),e.jsx("input",{type:"number",min:"1",value:te.required_crew,onChange:H=>N(ae=>({...ae,required_crew:parseInt(H.target.value)||1})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-white mb-2",children:[e.jsx(qt,{className:"h-4 w-4 inline mr-1"}),"Link Scheda Tecnica"]}),e.jsx("input",{type:"url",value:te.link_scheda_tecnica,onChange:H=>N(ae=>({...ae,link_scheda_tecnica:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"https://..."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-white mb-2",children:[e.jsx(Wr,{className:"h-4 w-4 inline mr-1"}),"Link Mappa GPS"]}),e.jsx("input",{type:"url",value:te.link_mappa_gps,onChange:H=>N(ae=>({...ae,link_mappa_gps:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"https://maps.google.com/..."})]}),_.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white",children:["Configurazione Giorni (",_.length,")"]}),_.map((H,ae)=>e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("button",{onClick:()=>gt(`day-${ae}`),className:"w-full flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold",children:H.giorno}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"font-medium text-white",children:H.nome}),e.jsx("p",{className:"text-sm text-gray-400",children:new Date(H.data).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})})]})]}),F[`day-${ae}`]?e.jsx(vo,{className:"h-5 w-5 text-gray-400"}):e.jsx(No,{className:"h-5 w-5 text-gray-400"})]}),F[`day-${ae}`]&&e.jsxs("div",{className:"space-y-4 pt-3 border-t border-gray-700",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-2",children:"Nome Giorno"}),e.jsx("input",{type:"text",value:H.nome,onChange:he=>L(ae,"nome",he.target.value),className:"w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm text-gray-400 mb-2",children:[e.jsx(ht,{className:"h-4 w-4 inline mr-1"}),"Orario Convocazione"]}),e.jsx("input",{type:"time",value:H.orario_convocazione,onChange:he=>L(ae,"orario_convocazione",he.target.value),className:"w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-2",children:"Tariffe Abilitate"}),e.jsxs("div",{className:"space-y-2",children:[p.map(he=>e.jsxs("label",{className:"flex items-start gap-3 bg-gray-900 rounded-lg p-3 cursor-pointer hover:bg-gray-800 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:H.tariffe_abilitate.includes(he.id),onChange:()=>re(ae,he.id),className:"w-5 h-5 rounded border-2 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer mt-0.5 accent-blue-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white text-sm",children:he.nome}),e.jsxs("p",{className:"text-gray-500 text-xs",children:[he.categoria," - ‚Ç¨",he.importo]})]})]},he.id)),e.jsxs("label",{className:"flex items-start gap-3 bg-gray-900 rounded-lg p-3 cursor-pointer hover:bg-gray-800 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:H.tariffe_abilitate.includes("diaria_eventi"),onChange:()=>re(ae,"diaria_eventi"),className:"w-5 h-5 rounded border-2 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer mt-0.5 accent-blue-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white text-sm",children:"Diaria Eventi"}),e.jsx("p",{className:"text-gray-500 text-xs",children:"Benefit speciale"})]})]}),e.jsxs("label",{className:"flex items-start gap-3 bg-gray-900 rounded-lg p-3 cursor-pointer hover:bg-gray-800 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:H.tariffe_abilitate.includes("diaria_trasferta"),onChange:()=>re(ae,"diaria_trasferta"),className:"w-5 h-5 rounded border-2 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer mt-0.5 accent-blue-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white text-sm",children:"Diaria Trasferta"}),e.jsx("p",{className:"text-gray-500 text-xs",children:"Benefit speciale"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-2",children:"Bonus Previsti (‚Ç¨)"}),e.jsx("input",{type:"number",step:"0.01",value:H.bonus_previsti,onChange:he=>L(ae,"bonus_previsti",parseFloat(he.target.value)||0),className:"w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white"})]})]})]},ae))]}),e.jsx("button",{onClick:de,disabled:P||!te.title||!te.start_date||!te.end_date,className:"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 text-white py-4 rounded-lg font-medium text-lg flex items-center justify-center gap-2",children:P?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),"Salvataggio..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Gr,{className:"h-5 w-5"}),se?"Aggiorna Bozza":"Salva Bozza"]})})]})]});if(l==="assign"&&v){const H=v;return e.jsxs("div",{className:"space-y-6 p-4 pb-24",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Assegna Crew"}),e.jsx("button",{onClick:()=>{c("list"),S(null)},className:"text-gray-400 hover:text-white",children:e.jsx(Et,{className:"h-6 w-6"})})]}),R&&e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(Nt,{className:"h-5 w-5 text-red-500 flex-shrink-0"}),e.jsx("p",{className:"text-red-400 text-sm",children:R})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsx("h3",{className:"font-semibold text-white mb-2",children:H.title}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xt,{className:"h-4 w-4"}),e.jsx("span",{children:new Date(H.start_date).toLocaleDateString("it-IT")})]}),H.call_time&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ht,{className:"h-4 w-4"}),e.jsxs("span",{children:["Convocazione: ",H.call_time]})]}),H.location&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:H.location})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-white mb-3 flex items-center gap-2",children:[e.jsx(os,{className:"h-5 w-5"}),"Crew (",C.size," assegnati)"]}),P&&O.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 space-y-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"}),e.jsx("p",{className:"text-gray-400 text-center",children:"Caricamento lista crew in corso..."})]}):e.jsx("div",{className:"space-y-2",children:O.map(({crew:ae,status:he,reason:Ae,assignment:Re})=>{const ee=he==="assigned",le=he==="unavailable";return e.jsxs("div",{className:"rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:()=>rt(ae.id),disabled:le,className:`w-full flex items-center justify-between p-4 transition-colors ${ee?"bg-green-700 hover:bg-green-800":le?"bg-red-900/30 cursor-not-allowed":"bg-gray-800 hover:bg-gray-700"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${ee?"bg-white":le?"bg-red-700":"bg-gray-700"}`,children:ee?e.jsx(pt,{className:"h-5 w-5 text-green-700"}):le?e.jsx(Et,{className:"h-5 w-5 text-white"}):e.jsx(os,{className:"h-5 w-5 text-gray-400"})}),e.jsxs("div",{className:"text-left flex-1",children:[e.jsx("p",{className:"font-medium text-white",children:ae.full_name}),e.jsxs("p",{className:`text-sm ${ee?"text-green-200 font-semibold":le?"text-red-300":"text-gray-400"}`,children:[ee&&"ASSEGNATO",he==="available"&&"DISPONIBILE",le&&`NON DISPONIBILE: ${Ae}`]})]})]}),ee&&e.jsx(jo,{className:"h-5 w-5 text-white flex-shrink-0"})]}),ee&&Re&&e.jsxs("div",{className:"border-t border-green-600 p-4 space-y-4 bg-green-800",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm text-green-200 mb-2",children:[e.jsx(ht,{className:"h-4 w-4 inline mr-1"}),"Orario di Convocazione"]}),e.jsx("input",{type:"time",value:Re.orario_convocazione||"",onChange:Ee=>st(ae.id,"orario_convocazione",Ee.target.value),className:"w-full bg-green-900 border border-green-700 rounded-lg px-3 py-2 text-white"})]}),Re.tariffe_disponibili&&Re.tariffe_disponibili.length>0&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm text-green-200 mb-2",children:[e.jsx(Ga,{className:"h-4 w-4 inline mr-1"}),"Benefit Assegnati (Modifica Prezzo)"]}),e.jsx("div",{className:"space-y-2",children:Re.tariffe_disponibili.map(Ee=>e.jsxs("div",{className:"bg-green-900 border border-green-700 rounded-lg px-3 py-2",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-white text-sm font-medium",children:Ee.nome}),e.jsx("span",{className:"text-xs text-green-300",children:Ee.categoria})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-green-200 text-sm",children:"‚Ç¨"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:Ee.importo,onChange:_e=>{const J=parseFloat(_e.target.value)||0;Je(ae.id,Ee.id,J)},className:"flex-1 bg-gray-900 border border-green-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:ring-2 focus:ring-green-500",style:{colorScheme:"dark"}})]})]},Ee.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-green-200 mb-2",children:"Note"}),e.jsx("textarea",{value:Re.note,onChange:Ee=>st(ae.id,"note",Ee.target.value),className:"w-full bg-green-900 border border-green-700 rounded-lg px-3 py-2 text-white h-20 resize-none",placeholder:"Note aggiuntive..."})]})]})]},ae.id)})})]}),C.size>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-blue-900/30 border border-blue-700 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ga,{className:"h-5 w-5 text-blue-400"}),e.jsx("span",{className:"text-blue-200 font-medium",children:"Preview Costi Benefit"})]}),e.jsxs("span",{className:"text-2xl font-bold text-blue-400",children:["‚Ç¨ ",Array.from(C.values()).reduce((ae,he)=>ae+he.tariffe_disponibili.reduce((Ae,Re)=>Ae+Re.importo,0),0).toFixed(2)]})]}),e.jsxs("p",{className:"text-xs text-blue-300 mt-2",children:["Totale benefit per ",C.size," crew member",C.size!==1?"s":""]})]}),e.jsx("button",{onClick:Qe,disabled:P,className:"w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-700 text-white py-4 rounded-lg font-medium text-lg flex items-center justify-center gap-2",children:P?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),"Salvataggio..."]}):e.jsxs(e.Fragment,{children:[e.jsx(pt,{className:"h-5 w-5"}),"Conferma Assegnazioni (",C.size,")"]})})]})]})}const De=x.filter(H=>{var ee;if(!G)return!0;const ae=G.toLowerCase(),he=H.title.toLowerCase().includes(ae),Ae=H.start_date.includes(G)||H.end_date.includes(G),Re=(ee=H.location)==null?void 0:ee.toLowerCase().includes(ae);return he||Ae||Re}).reduce((H,ae)=>{const he=ae.event_group_code||ae.id;return H[he]||(H[he]=[]),H[he].push(ae),H},{});return l==="edit"&&ne?e.jsxs("div",{className:"space-y-6 p-4 pb-24",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Modifica Evento"}),e.jsx("button",{onClick:()=>{ye(null),c("list")},className:"text-gray-400 hover:text-white",children:e.jsx(Et,{className:"h-6 w-6"})})]}),R&&e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(Nt,{className:"h-5 w-5 text-red-500 flex-shrink-0"}),e.jsx("p",{className:"text-red-400 text-sm",children:R})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Titolo *"}),e.jsx("input",{type:"text",value:me.title,onChange:H=>Q(ae=>({...ae,title:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"Nome evento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Tipo *"}),e.jsxs("select",{value:me.type,onChange:H=>Q(ae=>({...ae,type:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",children:[e.jsx("option",{value:"event",children:"Evento"}),e.jsx("option",{value:"transfer",children:"Trasferta"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Data Inizio *"}),e.jsx("input",{type:"date",value:me.start_date,onChange:H=>Q(ae=>({...ae,start_date:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Data Fine *"}),e.jsx("input",{type:"date",value:me.end_date,onChange:H=>Q(ae=>({...ae,end_date:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Localit√†"}),e.jsx("input",{type:"text",value:me.location,onChange:H=>Q(ae=>({...ae,location:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"Localit√† evento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Visibilit√† *"}),e.jsxs("select",{value:me.visibility,onChange:H=>Q(ae=>({...ae,visibility:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",children:[e.jsx("option",{value:"public",children:"Pubblico (Dipendenti e Freelance)"}),e.jsx("option",{value:"private",children:"Privato (Solo Dipendenti)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-3",children:"Benefits Disponibili"}),e.jsx("div",{className:"space-y-2",children:p.map(H=>{const ae=me.benefits_evento_ids.includes(H.id);return e.jsxs("div",{onClick:()=>{Q(he=>({...he,benefits_evento_ids:ae?he.benefits_evento_ids.filter(Ae=>Ae!==H.id):[...he.benefits_evento_ids,H.id]}))},className:`flex items-center justify-between p-4 rounded-lg cursor-pointer transition-all ${ae?"bg-green-600 hover:bg-green-700":"bg-gray-800 hover:bg-gray-700"}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white font-medium",children:H.nome}),e.jsxs("p",{className:`text-sm ${ae?"text-green-100":"text-gray-400"}`,children:[H.importo.toFixed(2),"‚Ç¨"]})]}),e.jsx("div",{className:`relative inline-flex h-7 w-12 items-center rounded-full transition-colors ${ae?"bg-green-400":"bg-gray-600"}`,children:e.jsx("span",{className:`inline-block h-5 w-5 transform rounded-full bg-white transition-transform ${ae?"translate-x-6":"translate-x-1"}`})})]},H.id)})})]})]}),e.jsxs("div",{className:"flex gap-3 pt-6",children:[e.jsx("button",{onClick:()=>{ye(null),c("list")},className:"flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-medium",children:"Annulla"}),e.jsx("button",{onClick:je,disabled:P,className:"flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 text-white py-3 rounded-lg font-medium flex items-center justify-center gap-2",children:P?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),"Salvataggio..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Gr,{className:"h-5 w-5"}),"Salva Modifiche"]})})]})]}):e.jsxs("div",{className:"space-y-6 p-4 pb-24",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:"Gestione Eventi"}),e.jsxs("button",{onClick:()=>c("create"),className:"bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg flex items-center gap-2",children:[e.jsx(pa,{className:"h-5 w-5"}),e.jsx("span",{children:"Nuovo"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(tn,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"text",value:G,onChange:H=>B(H.target.value),placeholder:"Cerca per nome, data o localit√†...",className:"w-full bg-gray-800 border border-gray-700 rounded-lg pl-12 pr-4 py-3 text-white placeholder-gray-400"}),G&&e.jsx("button",{onClick:()=>B(""),className:"absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white",children:e.jsx(Et,{className:"h-5 w-5"})})]}),R&&e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(Nt,{className:"h-5 w-5 text-red-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-red-500 font-medium",children:"Errore"}),e.jsx("p",{className:"text-red-400 text-sm mt-1",children:R})]})]}),M&&e.jsxs("div",{className:"bg-green-500/10 border border-green-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(pt,{className:"h-5 w-5 text-green-500 flex-shrink-0"}),e.jsx("p",{className:"text-green-500 font-medium",children:M})]}),u.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-3 flex items-center gap-2",children:[e.jsx(ir,{className:"h-5 w-5"}),"Bozze (",u.length,")"]}),e.jsx("div",{className:"space-y-3",children:u.map(H=>e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-yellow-500/30",children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-semibold text-white",children:H.title}),e.jsx("span",{className:"px-2 py-1 text-xs rounded-full bg-yellow-500/20 text-yellow-400",children:"BOZZA"})]}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xt,{className:"h-4 w-4"}),e.jsxs("span",{children:[new Date(H.start_date).toLocaleDateString("it-IT")," - ",new Date(H.end_date).toLocaleDateString("it-IT")]})]}),H.location&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:H.location})]}),e.jsxs("p",{className:"text-xs text-gray-500",children:[H.giorni_config.length," giorn",H.giorni_config.length===1?"o":"i"," configurati"]})]})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>ve(H),className:"bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg",children:e.jsx(ir,{className:"h-4 w-4"})}),e.jsxs("button",{onClick:()=>oe(H),className:"flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2",children:[e.jsx(pt,{className:"h-4 w-4"}),"Conferma"]}),e.jsx("button",{onClick:()=>ge(H.id_gruppo_evento),className:"bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg",children:e.jsx(Xs,{className:"h-4 w-4"})})]})]},H.id_gruppo_evento))})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-3 flex items-center gap-2",children:[e.jsx(pt,{className:"h-5 w-5"}),"Eventi Confermati (",Object.keys(De).length,")"]}),Object.keys(De).length===0?e.jsxs("div",{className:"bg-gray-800 rounded-lg p-8 text-center",children:[e.jsx(xt,{className:"h-12 w-12 text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-400",children:"Nessun evento confermato"})]}):e.jsx("div",{className:"space-y-3",children:Object.entries(De).map(([H,ae])=>{const he=ae.length>1,Ae=ae[0];return e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-white mb-1",children:he?Ae.title.split(" - ")[0]:Ae.title}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xt,{className:"h-4 w-4"}),e.jsxs("span",{children:[new Date(Ae.start_date).toLocaleDateString("it-IT"),he&&` - ${new Date(ae[ae.length-1].end_date).toLocaleDateString("it-IT")}`]})]}),Ae.location&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:Ae.location})]}),he&&e.jsxs("p",{className:"text-xs text-blue-400",children:[ae.length," giorni"]})]})]})}),he?e.jsx("div",{className:"space-y-2 mb-3",children:ae.map(Re=>e.jsxs("button",{onClick:()=>Ve(Re),className:"w-full bg-gray-900 hover:bg-gray-850 border border-gray-700 rounded-lg p-3 text-left flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold",children:Re.day_number}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white text-sm font-medium",children:Re.day_name}),e.jsxs("p",{className:"text-gray-400 text-xs",children:[new Date(Re.start_date).toLocaleDateString("it-IT")," - ",Re.call_time]})]})]}),e.jsx(os,{className:"h-5 w-5 text-gray-400"})]},Re.id))}):e.jsxs("button",{onClick:()=>Ve(Ae),className:"w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 mb-2",children:[e.jsx(os,{className:"h-4 w-4"}),"Assegna Crew"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>we(H),className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2",children:[e.jsx(ir,{className:"h-4 w-4"}),"Modifica"]}),e.jsxs("button",{onClick:()=>Te(H),className:"flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2",children:[e.jsx(Xs,{className:"h-4 w-4"}),"Elimina"]})]})]},H)})})]})]})},Xd=()=>{const{companyProfile:n}=us(),[l,c]=w.useState([]),[u,f]=w.useState(!0),x=()=>{const D=new Date;return new Date(D.toLocaleString("en-US",{timeZone:"Europe/Rome"})).toISOString().split("T")[0]},[b,v]=w.useState(x()),[S,g]=w.useState("all"),E=async()=>{if(n!=null&&n.id)try{f(!0),console.log("[CompanyCheckInMonitor] Caricamento turni per data:",b),console.log("[CompanyCheckInMonitor] Data italiana corrente:",x());const D=[],R=[],j=[],{data:M,error:T}=await Le.from("crew_assegnazione_turni").select("*").eq("azienda_id",n.id).eq("data_turno",b);if(!T&&M){const _=M.map(K=>K.turno_id),{data:V}=await Le.from("warehouse_checkins").select("*").eq("date",b).in("crew_id",M.map(K=>K.dipendente_id)),C=new Map;V==null||V.forEach(K=>{C.set(K.crew_id,K)}),M.forEach(K=>{const O=C.get(K.dipendente_id),X=new Date,se=new Date(`${b}T${K.ora_inizio_turno}`),W=X>se&&!O;let G="not_started";O!=null&&O.check_out_time?G="checked_out":O!=null&&O.check_in_time?G="checked_in":W&&(G="late"),D.push({type:"warehouse",id:K.id,employee_id:K.dipendente_id,employee_name:K.dipendente_nome,warehouse_name:K.nome_magazzino,shift_date:K.data_turno,start_time:K.ora_inizio_turno,end_time:K.ora_fine_turno,checkin_time:O==null?void 0:O.check_in_time,checkout_time:O==null?void 0:O.check_out_time,status:G,location:O==null?void 0:O.location})})}const{data:F,error:U}=await Le.from("crew_event_assegnazione").select("*").eq("azienda_id",n.id).lte("giorno_inizio_evento",b).gte("giorno_fine_evento",b);if(!U&&F){const{data:_}=await Le.from("timesheet_entries").select("*").eq("date",b).in("crew_id",F.map(C=>C.dipendente_freelance_id)),V=new Map;_==null||_.forEach(C=>{V.has(C.crew_id)||V.set(C.crew_id,[]),V.get(C.crew_id).push(C)}),F.forEach(C=>{const O=(V.get(C.dipendente_freelance_id)||[]).find(se=>se.date===b);let X="not_started";O&&(O.end_time?X="checked_out":O.start_time&&(X="checked_in")),R.push({type:"event",id:C.id,employee_id:C.dipendente_freelance_id,employee_name:C.nome_dipendente_freelance,event_name:C.nome_evento,event_location:C.evento_localita||"Non specificato",shift_date:b,convocation_time:C.orario_convocazione||C.evento_orario_convocazione,checkin_time:O==null?void 0:O.start_time,checkout_time:O==null?void 0:O.end_time,status:X})})}const{data:te,error:N}=await Le.from("extra_shifts_checkins").select(`
          *,
          crew_members (
            full_name,
            first_name,
            last_name,
            company_name
          )
        `).eq("date",b);!N&&te&&(console.log("[CompanyCheckInMonitor] Extra checkins trovati:",te.length),console.log("[CompanyCheckInMonitor] Ragione sociale azienda:",n.ragione_sociale),te.forEach(_=>{var C,K,O,X,se,W;if(console.log("[CompanyCheckInMonitor] Checkin:",{id:_.id,crew_id:_.crew_id,company_name:(C=_.crew_members)==null?void 0:C.company_name,matches:((K=_.crew_members)==null?void 0:K.company_name)===n.ragione_sociale}),((O=_.crew_members)==null?void 0:O.company_name)!==n.ragione_sociale)return;const V=((X=_.crew_members)==null?void 0:X.full_name)||`${((se=_.crew_members)==null?void 0:se.first_name)||""} ${((W=_.crew_members)==null?void 0:W.last_name)||""}`.trim()||"Nome non disponibile";j.push({type:"extra",id:_.id,employee_id:_.crew_id,employee_name:V,shift_date:_.date,checkin_time:_.check_in_time,checkout_time:_.check_out_time,status:_.check_out_time?"checked_out":"checked_in",warehouse_name:"Turno Extra"})}),console.log("[CompanyCheckInMonitor] Extra shifts aggiunti:",j.length)),c([...D,...R,...j])}catch(D){console.error("Errore caricamento turni:",D)}finally{f(!1)}};w.useEffect(()=>{E();const D=Le.channel("warehouse_checkins_changes").on("postgres_changes",{event:"*",schema:"public",table:"warehouse_checkins"},()=>{E()}).subscribe(),R=Le.channel("timesheet_entries_changes").on("postgres_changes",{event:"*",schema:"public",table:"timesheet_entries"},()=>{E()}).subscribe(),j=Le.channel("extra_shifts_checkins_changes").on("postgres_changes",{event:"*",schema:"public",table:"extra_shifts_checkins"},()=>{E()}).subscribe();return()=>{Le.removeChannel(D),Le.removeChannel(R),Le.removeChannel(j)}},[n==null?void 0:n.id,b]);const p=D=>{switch(D){case"checked_in":return e.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 bg-green-900/30 text-green-400 rounded-lg text-xs font-medium",children:[e.jsx(pt,{className:"w-3 h-3"}),"Presente"]});case"checked_out":return e.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 bg-blue-900/30 text-blue-400 rounded-lg text-xs font-medium",children:[e.jsx(pt,{className:"w-3 h-3"}),"Concluso"]});case"late":return e.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 bg-orange-900/30 text-orange-400 rounded-lg text-xs font-medium",children:[e.jsx(Nt,{className:"w-3 h-3"}),"In Ritardo"]});case"not_started":return e.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 bg-gray-700 text-gray-400 rounded-lg text-xs font-medium",children:[e.jsx(ht,{className:"w-3 h-3"}),"Non Iniziato"]});case"absent":return e.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 bg-red-900/30 text-red-400 rounded-lg text-xs font-medium",children:[e.jsx(Ka,{className:"w-3 h-3"}),"Assente"]});default:return null}},k=l.filter(D=>S==="all"?!0:D.status===S),P={total:l.length,checked_in:l.filter(D=>D.status==="checked_in").length,checked_out:l.filter(D=>D.status==="checked_out").length,late:l.filter(D=>D.status==="late").length,not_started:l.filter(D=>D.status==="not_started").length};return u?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white pb-20",children:[e.jsxs("div",{className:"bg-gradient-to-br from-blue-900 to-gray-900 p-6 border-b border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Check-In Monitor"}),e.jsx("p",{className:"text-gray-300 text-sm mt-1",children:"Monitoraggio presenze in tempo reale"})]}),e.jsx("button",{onClick:E,className:"p-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors",title:"Aggiorna",children:e.jsx(Ms,{className:"w-5 h-5"})})]}),e.jsx("input",{type:"date",value:b,onChange:D=>v(D.target.value),className:"w-full px-4 py-2 bg-gray-800 text-white border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2 mt-4",children:[e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:P.total}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"Totale"})]}),e.jsxs("div",{className:"bg-green-900/30 rounded-lg p-3 text-center border border-green-700/30",children:[e.jsx("div",{className:"text-2xl font-bold text-green-400",children:P.checked_in}),e.jsx("div",{className:"text-xs text-green-300 mt-1",children:"Presenti"})]}),e.jsxs("div",{className:"bg-blue-900/30 rounded-lg p-3 text-center border border-blue-700/30",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-400",children:P.checked_out}),e.jsx("div",{className:"text-xs text-blue-300 mt-1",children:"Conclusi"})]}),e.jsxs("div",{className:"bg-orange-900/30 rounded-lg p-3 text-center border border-orange-700/30",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-400",children:P.late}),e.jsx("div",{className:"text-xs text-orange-300 mt-1",children:"Ritardo"})]})]}),e.jsx("div",{className:"flex gap-2 mt-4 overflow-x-auto pb-2",children:[{id:"all",label:"Tutti"},{id:"checked_in",label:"Presenti"},{id:"checked_out",label:"Conclusi"},{id:"late",label:"Ritardo"},{id:"not_started",label:"Non iniziati"}].map(D=>e.jsx("button",{onClick:()=>g(D.id),className:`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${S===D.id?"bg-blue-600 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"}`,children:D.label},D.id))})]}),e.jsx("div",{className:"p-4 space-y-3",children:k.length===0?e.jsxs("div",{className:"bg-gray-800 rounded-lg p-8 text-center",children:[e.jsx(os,{className:"w-12 h-12 text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-400",children:"Nessun turno trovato per questa data"})]}):k.map(D=>e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-gray-600 transition-colors",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center",children:e.jsx(Xr,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-white",children:(D.type==="extra",D.employee_name)}),e.jsxs("p",{className:"text-sm text-gray-400",children:[D.type==="warehouse"&&D.warehouse_name,D.type==="event"&&D.event_name,D.type==="extra"&&D.warehouse_name]})]})]}),p(D.status)]}),e.jsxs("div",{className:"space-y-2",children:[D.type==="warehouse"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ht,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{className:"text-gray-300",children:["Orario: ",D.start_time," - ",D.end_time]})]}),D.checkin_time&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pt,{className:"w-4 h-4 text-green-400"}),e.jsxs("span",{className:"text-gray-300",children:["Check-in: ",D.checkin_time]})]}),D.checkout_time&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pt,{className:"w-4 h-4 text-blue-400"}),e.jsxs("span",{className:"text-gray-300",children:["Check-out: ",D.checkout_time]})]})]}),D.type==="event"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ut,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"text-gray-300",children:D.event_location})]}),D.convocation_time&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ht,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{className:"text-gray-300",children:["Convocazione: ",D.convocation_time]})]}),D.checkin_time&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pt,{className:"w-4 h-4 text-green-400"}),e.jsxs("span",{className:"text-gray-300",children:["Inizio: ",D.checkin_time]})]}),D.checkout_time&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pt,{className:"w-4 h-4 text-blue-400"}),e.jsxs("span",{className:"text-gray-300",children:["Fine: ",D.checkout_time]})]})]}),D.type==="extra"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Nt,{className:"w-4 h-4 text-yellow-400"}),e.jsx("span",{className:"text-yellow-300 font-medium",children:"Turno straordinario"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pt,{className:"w-4 h-4 text-green-400"}),e.jsxs("span",{className:"text-gray-300",children:["Check-in: ",D.checkin_time]})]}),D.checkout_time&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pt,{className:"w-4 h-4 text-blue-400"}),e.jsxs("span",{className:"text-gray-300",children:["Check-out: ",D.checkout_time]})]})]})]})]},`${D.type}-${D.id}`))})]})};function Zd(){const{companyProfile:n}=us(),{showSuccess:l,showError:c,showWarning:u}=Dr(),[f,x]=w.useState([]),[b,v]=w.useState([]),[S,g]=w.useState([]),[E,p]=w.useState(null),[k,P]=w.useState("individual"),[D,R]=w.useState("text"),[j,M]=w.useState(""),[T,F]=w.useState(null),[U,te]=w.useState(!1),[N,_]=w.useState(!1),[V,C]=w.useState([]),[K,O]=w.useState(!1),[X,se]=w.useState(!0),[W,G]=w.useState(null),[B,ne]=w.useState([]),[ye,me]=w.useState(!1),[Q,fe]=w.useState(0),[be,Z]=w.useState(null),L=w.useRef(null),re=w.useRef(null),de=w.useRef(null),oe=w.useRef([]),ge=w.useRef(null);w.useEffect(()=>{n&&(ve(),st())},[n]),w.useEffect(()=>()=>{ge.current&&clearInterval(ge.current),de.current&&de.current.state!=="inactive"&&de.current.stop()},[]),w.useEffect(()=>{k==="event"&&n&&Te()},[k,n]),w.useEffect(()=>{k==="warehouse"&&n&&we()},[k,n]),w.useEffect(()=>{E&&(k==="event"||k==="warehouse")?je():k==="extra"?Fe():k==="individual"?Ve():ne([])},[E,k]);const ve=async()=>{try{se(!0);const{data:ee,error:le}=await Le.from("crew_members").select("id, first_name, last_name, email, full_name").eq("company_id",n==null?void 0:n.id).order("full_name",{ascending:!0});if(le)throw le;x(ee||[])}catch(ee){console.error("Errore caricamento dipendenti:",ee)}finally{se(!1)}},Te=async()=>{try{const ee=new Date().toISOString().split("T")[0],{data:le,error:Ee}=await Le.from("crew_event_assegnazione").select(`
          evento_id,
          nome_evento,
          giorno_inizio_evento,
          dipendente_freelance_id
        `).eq("azienda_id",n==null?void 0:n.id).lte("giorno_inizio_evento",ee).gte("giorno_fine_evento",ee);if(Ee)throw Ee;const _e=new Map;(le||[]).forEach(J=>{_e.has(J.evento_id)||_e.set(J.evento_id,{id:J.evento_id,nome_evento:J.nome_evento,giorno_inizio_evento:J.giorno_inizio_evento,assigned_count:0});const ke=_e.get(J.evento_id);ke.assigned_count++}),v(Array.from(_e.values()))}catch(ee){console.error("Errore caricamento eventi:",ee),v([])}},we=async()=>{try{const ee=new Date().toISOString().split("T")[0],{data:le,error:Ee}=await Le.from("crew_assegnazione_turni").select("turno_id, nome_magazzino, data_turno, dipendente_id").eq("azienda_id",n==null?void 0:n.id).eq("data_turno",ee);if(Ee)throw Ee;const _e=new Map;(le||[]).forEach(J=>{const ke=`${J.turno_id}|${J.data_turno}`;_e.has(ke)||_e.set(ke,{id:ke,turno_id:J.turno_id,nome_magazzino:J.nome_magazzino,data_turno:J.data_turno,assigned_count:0});const $=_e.get(ke);$.assigned_count++}),g(Array.from(_e.values()))}catch(ee){console.error("Errore caricamento turni:",ee),g([])}},je=async()=>{try{let ee=[],le=new Map;if(k==="event"&&E){const{data:J}=await Le.from("crew_event_assegnazione").select("dipendente_freelance_id, nome_dipendente_freelance").eq("evento_id",E);(J||[]).forEach(ke=>{ee.push(ke.dipendente_freelance_id),le.set(ke.dipendente_freelance_id,ke.nome_dipendente_freelance)})}else if(k==="warehouse"&&E){const J=E.split("|"),ke=J[0],$=J[1],{data:ue}=await Le.from("crew_assegnazione_turni").select("dipendente_id, dipendente_nome").eq("turno_id",ke).eq("data_turno",$);(ue||[]).forEach(xe=>{ee.push(xe.dipendente_id),le.set(xe.dipendente_id,xe.dipendente_nome)})}const _e=[...new Set(ee)].map(J=>({id:J,name:le.get(J)||"Nome non disponibile",selected:!0}));ne(_e)}catch(ee){console.error("Errore caricamento dipendenti selezionabili:",ee),ne([])}},Fe=async()=>{try{const ee=new Date().toISOString().split("T")[0],{data:le}=await Le.from("extra_shifts_checkins").select(`
          crew_id,
          crew_members!crew_id (
            full_name,
            first_name,
            last_name
          )
        `).eq("date",ee),Ee=new Map;(le||[]).forEach(J=>{var $,ue,xe;const ke=(($=J.crew_members)==null?void 0:$.full_name)||`${((ue=J.crew_members)==null?void 0:ue.first_name)||""} ${((xe=J.crew_members)==null?void 0:xe.last_name)||""}`.trim()||"Nome non disponibile";Ee.set(J.crew_id,ke)});const _e=Array.from(Ee.entries()).map(([J,ke])=>({id:J,name:ke,selected:!0}));ne(_e)}catch(ee){console.error("Errore caricamento dipendenti extra:",ee),ne([])}},Ve=()=>{const ee=f.map(le=>({id:le.id,name:le.full_name||`${le.first_name} ${le.last_name}`,selected:!1}));ne(ee)},rt=ee=>{ne(le=>le.map(Ee=>Ee.id===ee?{...Ee,selected:!Ee.selected}:Ee))},st=async()=>{try{const{data:ee,error:le}=await Le.from("company_talks").select("*").eq("sender_company_id",n==null?void 0:n.id).order("created_at",{ascending:!1}).limit(100);if(le)throw le;if(!ee||ee.length===0){C([]);return}const Ee=[...new Set(ee.map(ke=>ke.recipient_id).filter(Boolean))];let _e={};if(Ee.length>0){const{data:ke}=await Le.from("crew_members").select("id, full_name, first_name, last_name").in("id",Ee);_e=(ke||[]).reduce(($,ue)=>($[ue.id]=ue.full_name||`${ue.first_name} ${ue.last_name}`,$),{})}const J=ee.map(ke=>({...ke,recipient_name:ke.recipient_id?_e[ke.recipient_id]||"Dipendente":"Tutti i dipendenti"}));C(J)}catch(ee){console.error("Errore caricamento messaggi inviati:",ee)}},Je=async()=>{try{const ee=await navigator.mediaDevices.getUserMedia({audio:!0}),le=MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":"audio/mp4",Ee=new MediaRecorder(ee,{mimeType:le});oe.current=[],Ee.ondataavailable=_e=>{_e.data.size>0&&oe.current.push(_e.data)},Ee.onstop=()=>{const _e=new Blob(oe.current,{type:le});_e.size>10*1024*1024?(c("Registrazione troppo lunga! Massimo 10MB"),Z(null)):Z(_e),ee.getTracks().forEach(J=>J.stop()),ge.current&&clearInterval(ge.current)},Ee.start(),de.current=Ee,me(!0),fe(0),R("audio"),F(null),ge.current=setInterval(()=>{fe(_e=>_e+1)},1e3)}catch(ee){console.error("Errore accesso microfono:",ee),c("Impossibile accedere al microfono. Verifica i permessi.")}},Qe=()=>{de.current&&de.current.state!=="inactive"&&(de.current.stop(),me(!1))},We=()=>{de.current&&de.current.state!=="inactive"&&de.current.stop(),ge.current&&clearInterval(ge.current),me(!1),fe(0),Z(null),oe.current=[]},gt=ee=>{const le=Math.floor(ee/60),Ee=ee%60;return`${le}:${Ee.toString().padStart(2,"0")}`},qe=(ee,le)=>{var J;const Ee=(J=ee.target.files)==null?void 0:J[0];if(!Ee)return;const _e=le==="file"?20*1024*1024:10*1024*1024;if(Ee.size>_e){c(`File troppo grande! Massimo ${le==="file"?"20":"10"}MB`);return}F(Ee),R(le),Z(null)},De=async ee=>{try{const le=ee.name.split(".").pop(),Ee=`${Date.now()}_${Math.random().toString(36).substring(7)}.${le}`,_e=`${n==null?void 0:n.id}/${Ee}`,{error:J}=await Le.storage.from("company-talks").upload(_e,ee);if(J)throw J;const{data:{publicUrl:ke}}=Le.storage.from("company-talks").getPublicUrl(_e);return ke}catch(le){throw console.error("Errore upload file:",le),le}},H=async()=>k==="individual"?B.filter(ee=>ee.selected).map(ee=>ee.id):k==="all"?f.map(ee=>ee.id):k==="event"||k==="warehouse"||k==="extra"?B.filter(ee=>ee.selected).map(ee=>ee.id):[],ae=async()=>{if(!n){c("Profilo azienda non trovato");return}if(D==="text"&&!j.trim()){u("Inserisci un messaggio");return}if(D==="audio"&&!T&&!be){u("Registra o seleziona un file audio");return}if((D==="image"||D==="file")&&!T){u("Seleziona un file");return}try{_(!0);const ee=await H();if(ee.length===0){u("Nessun destinatario selezionato"),_(!1);return}let le=null,Ee=null,_e=null;if(T)le=await De(T),Ee=T.name,_e=T.size;else if(be&&D==="audio"){const $=new File([be],`recording_${Date.now()}.${be.type.includes("webm")?"webm":"mp4"}`,{type:be.type});le=await De($),Ee=$.name,_e=$.size}const J=ee.map($=>({sender_company_id:n.id,recipient_id:$,sender_name:n.ragione_sociale||"Azienda",message_type:D,message_text:D==="text"?j:null,file_url:le,file_name:Ee,file_size:_e,is_urgent:U})),{error:ke}=await Le.from("company_talks").insert(J);if(ke)throw console.error("Errore inserimento DB:",ke),ke;l(`Messaggio inviato a ${ee.length} ${ee.length===1?"dipendente":"dipendenti"}!`),M(""),F(null),Z(null),fe(0),R("text"),te(!1),p(null),P("individual"),ne([]),st()}catch(ee){console.error("Errore invio messaggio:",ee),c(`Errore durante l'invio del messaggio: ${ee.message||"Errore sconosciuto"}`)}finally{_(!1)}},he=async ee=>{try{const{error:le}=await Le.from("company_talks").delete().eq("id",ee).eq("sender_company_id",n==null?void 0:n.id);if(le)throw le;C(Ee=>Ee.filter(_e=>_e.id!==ee)),G(null),l("Messaggio eliminato")}catch(le){console.error("Errore eliminazione:",le),c("Errore durante l'eliminazione")}},Ae=ee=>new Date(ee).toLocaleString("it-IT",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}),Re=ee=>{switch(ee){case"audio":return e.jsx(Cr,{className:"w-4 h-4"});case"image":return e.jsx(Hr,{className:"w-4 h-4"});case"file":return e.jsx(qt,{className:"w-4 h-4"});default:return e.jsx(nr,{className:"w-4 h-4"})}};return X?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Nn,{className:"w-8 h-8 animate-spin text-blue-600"})}):e.jsxs("div",{className:"min-h-screen flex flex-col bg-gray-900",children:[e.jsx("div",{className:"bg-gray-800 border-b border-gray-700 p-4",children:e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Invia Messaggio ai Dipendenti"}),e.jsx("button",{onClick:()=>O(!K),className:"px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm",children:K?"Nuovo Messaggio":"Cronologia"})]})}),K?e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Messaggi Inviati"}),V.length===0?e.jsxs("div",{className:"text-center text-gray-400 py-8",children:[e.jsx(nr,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"Nessun messaggio inviato"})]}):e.jsx("div",{className:"space-y-3",children:V.map(ee=>e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 bg-blue-900/30 rounded-lg text-blue-400",children:Re(ee.message_type)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-white",children:ee.recipient_name}),e.jsx("p",{className:"text-xs text-gray-400",children:Ae(ee.created_at)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[ee.is_urgent&&e.jsx("span",{className:"flex items-center gap-1 text-xs text-red-400",children:e.jsx(Nt,{className:"w-3 h-3"})}),ee.is_read&&e.jsx(pt,{className:"w-4 h-4 text-green-400"}),e.jsx("button",{onClick:()=>G(ee.id),className:"p-1 hover:bg-red-900/30 rounded text-red-400",children:e.jsx(Xs,{className:"w-4 h-4"})})]})]}),ee.message_type==="text"&&ee.message_text&&e.jsx("p",{className:"text-sm text-gray-300 line-clamp-2",children:ee.message_text}),ee.message_type!=="text"&&ee.file_name&&e.jsx("p",{className:"text-sm text-gray-400",children:ee.file_name})]},ee.id))})]}):e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsxs("div",{className:"max-w-2xl mx-auto space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Tipo Destinatari"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-2 mb-3",children:[e.jsx("button",{onClick:()=>{P("individual"),p("individual"),ne([])},className:`p-2 rounded-lg border-2 text-sm ${k==="individual"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 text-gray-400 hover:border-gray-600"}`,children:"Seleziona"}),e.jsx("button",{onClick:()=>{P("all"),p("all"),ne([])},className:`p-2 rounded-lg border-2 text-sm ${k==="all"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 text-gray-400 hover:border-gray-600"}`,children:"Tutti"}),e.jsx("button",{onClick:()=>{P("event"),p(null),ne([])},className:`p-2 rounded-lg border-2 text-sm ${k==="event"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 text-gray-400 hover:border-gray-600"}`,children:"Evento"}),e.jsx("button",{onClick:()=>{P("warehouse"),p(null),ne([])},className:`p-2 rounded-lg border-2 text-sm ${k==="warehouse"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 text-gray-400 hover:border-gray-600"}`,children:"Magazzino"}),e.jsx("button",{onClick:()=>{P("extra"),p("extra"),Fe()},className:`p-2 rounded-lg border-2 text-sm ${k==="extra"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 text-gray-400 hover:border-gray-600"}`,children:"Extra Oggi"})]}),k==="individual"&&B.length===0&&e.jsx("div",{className:"p-3 bg-gray-800 border border-gray-700 rounded-lg",children:e.jsx("p",{className:"text-sm text-gray-400 text-center",children:"Caricamento dipendenti..."})}),k==="event"&&e.jsx(e.Fragment,{children:e.jsxs("select",{value:E||"",onChange:ee=>p(ee.target.value||null),className:"w-full px-3 py-2 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:b.length===0?"Nessun evento oggi":"Seleziona evento"}),b.map(ee=>e.jsxs("option",{value:ee.id,children:[ee.nome_evento," (",ee.assigned_count," ",ee.assigned_count===1?"dipendente":"dipendenti",")"]},ee.id))]})}),k==="warehouse"&&e.jsx(e.Fragment,{children:e.jsxs("select",{value:E||"",onChange:ee=>p(ee.target.value||null),className:"w-full px-3 py-2 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:S.length===0?"Nessun turno oggi":"Seleziona turno magazzino"}),S.map(ee=>e.jsxs("option",{value:ee.id,children:[ee.nome_magazzino," (",ee.assigned_count," ",ee.assigned_count===1?"dipendente":"dipendenti",")"]},ee.id))]})}),k==="all"&&e.jsx("div",{className:"p-3 bg-blue-900/30 border border-blue-700 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-300",children:["Il messaggio verr√† inviato a tutti i ",f.length," dipendenti"]})}),B.length>0&&e.jsxs("div",{className:"mt-3 p-3 bg-gray-800 border border-gray-700 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h4",{className:"text-sm font-medium text-white flex items-center gap-2",children:[e.jsx(Co,{className:"w-4 h-4"}),"Destinatari (",B.filter(ee=>ee.selected).length,"/",B.length,")"]}),e.jsx("button",{onClick:()=>ne(ee=>ee.map(le=>({...le,selected:!ee.every(Ee=>Ee.selected)}))),className:"text-xs text-blue-400 hover:text-blue-300",children:B.every(ee=>ee.selected)?"Deseleziona tutti":"Seleziona tutti"})]}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:B.map(ee=>e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-700 rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:ee.selected,onChange:()=>rt(ee.id),className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm text-gray-300",children:ee.name})]},ee.id))})]}),k==="extra"&&B.length===0&&e.jsx("div",{className:"p-3 bg-purple-900/30 border border-purple-700 rounded-lg",children:e.jsx("p",{className:"text-sm text-purple-300",children:"Nessun dipendente ha effettuato check-in extra oggi"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Tipo di Messaggio"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsxs("button",{onClick:()=>{R("text"),F(null)},className:`p-3 rounded-lg border-2 transition-all ${D==="text"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 hover:border-gray-600 text-gray-400"}`,children:[e.jsx(nr,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Testo"})]}),e.jsxs("button",{onClick:()=>{R("audio"),F(null),!ye&&!be&&Je()},className:`p-3 rounded-lg border-2 transition-all ${D==="audio"||ye?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 hover:border-gray-600 text-gray-400"}`,children:[e.jsx(Cr,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Vocale"})]}),e.jsxs("button",{onClick:()=>{var ee;return(ee=L.current)==null?void 0:ee.click()},className:`p-3 rounded-lg border-2 transition-all ${D==="image"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 hover:border-gray-600 text-gray-400"}`,children:[e.jsx(Hr,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Immagine"})]}),e.jsxs("button",{onClick:()=>{var ee;R("file"),(ee=L.current)==null||ee.click()},className:`p-3 rounded-lg border-2 transition-all ${D==="file"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 hover:border-gray-600 text-gray-400"}`,children:[e.jsx(qt,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"File"})]})]}),e.jsx("input",{ref:L,type:"file",accept:"image/*",onChange:ee=>qe(ee,"image"),className:"hidden"}),e.jsx("input",{ref:re,type:"file",accept:"audio/*",onChange:ee=>qe(ee,"audio"),className:"hidden"})]}),ye?e.jsx("div",{className:"p-6 bg-red-900/30 border-2 border-red-600 rounded-lg",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-3 mb-4",children:[e.jsx("div",{className:"w-4 h-4 bg-red-500 rounded-full animate-pulse"}),e.jsx("p",{className:"text-2xl font-bold text-white",children:gt(Q)})]}),e.jsx("p",{className:"text-sm text-red-200 mb-4",children:"Registrazione in corso..."}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsx("button",{onClick:We,className:"px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors",children:"Annulla"}),e.jsxs("button",{onClick:Qe,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(Eo,{className:"w-4 h-4 fill-current"}),"Ferma"]})]})]})}):D==="text"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Messaggio"}),e.jsx("textarea",{value:j,onChange:ee=>M(ee.target.value),placeholder:"Scrivi il tuo messaggio...",rows:6,className:"w-full px-3 py-2 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-500"})]}):D==="audio"&&be?e.jsxs("div",{className:"p-4 bg-gray-800 rounded-lg border border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Cr,{className:"w-8 h-8 text-blue-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-white",children:"Messaggio vocale"}),e.jsxs("p",{className:"text-sm text-gray-400",children:["Durata: ",gt(Q)," | ",(be.size/1024/1024).toFixed(2)," MB"]}),e.jsx("audio",{controls:!0,src:URL.createObjectURL(be),className:"w-full mt-2"})]}),e.jsx("button",{onClick:()=>{Z(null),fe(0)},className:"p-1 hover:bg-gray-700 rounded",children:e.jsx(Et,{className:"w-5 h-5 text-gray-300"})})]}),e.jsx("button",{onClick:Je,className:"w-full mt-3 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm",children:"Registra di nuovo"})]}):T&&e.jsx("div",{className:"p-4 bg-gray-800 rounded-lg border border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-3",children:[D==="audio"&&e.jsx(Cr,{className:"w-8 h-8 text-blue-400"}),D==="image"&&e.jsx(Hr,{className:"w-8 h-8 text-blue-400"}),D==="file"&&e.jsx(qt,{className:"w-8 h-8 text-blue-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-white",children:T.name}),e.jsxs("p",{className:"text-sm text-gray-400",children:[(T.size/1024/1024).toFixed(2)," MB"]})]}),e.jsx("button",{onClick:()=>F(null),className:"ml-auto p-1 hover:bg-gray-700 rounded",children:e.jsx(Et,{className:"w-5 h-5 text-gray-300"})})]})}),e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-amber-900/30 border border-amber-700 rounded-lg",children:[e.jsx("input",{type:"checkbox",id:"urgent",checked:U,onChange:ee=>te(ee.target.checked),className:"w-4 h-4 text-blue-600"}),e.jsxs("label",{htmlFor:"urgent",className:"text-sm text-amber-300 flex items-center gap-2",children:[e.jsx(Nt,{className:"w-4 h-4"}),"Messaggio urgente (invia notifica push immediata)"]})]}),e.jsx("button",{onClick:ae,disabled:N||ye||(D==="text"?!j.trim():D==="audio"?!be:!T)||k!=="all"&&B.filter(ee=>ee.selected).length===0,className:"w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-700 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2",children:N?e.jsxs(e.Fragment,{children:[e.jsx(Nn,{className:"w-5 h-5 animate-spin"}),"Invio in corso..."]}):e.jsxs(e.Fragment,{children:[e.jsx(So,{className:"w-5 h-5"}),"Invia Messaggio"]})})]})}),W&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-sm w-full border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Conferma Eliminazione"}),e.jsx("p",{className:"text-gray-300 mb-6",children:"Sei sicuro di voler eliminare questo messaggio?"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>G(null),className:"flex-1 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors",children:"Annulla"}),e.jsx("button",{onClick:()=>he(W),className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Elimina"})]})]})})]})}const Qd=({isOpen:n,onClose:l,date:c,crewMembers:u,shifts:f,selectedTemplate:x,onAddShift:b})=>{const[v,S]=w.useState(""),[g,E]=w.useState([]),[p,k]=w.useState({}),[P,D]=w.useState(!1);w.useEffect(()=>{n&&c&&u.length>0&&R()},[n,c,u]);const R=async()=>{D(!0);const N={};for(const _ of u){const V=await j(_.id,c);N[_.id]=V}k(N),D(!1)},j=async(N,_)=>{var V,C;try{const{data:K,error:O}=await Le.from("crew_ferie").select("*").eq("dipendente_id",N).eq("stato","approvata").lte("data_inizio",_).gte("data_fine",_).maybeSingle();if(K&&!O)return{isUnavailable:!0,reason:"Ferie",tipo:"ferie",details:`Dal ${new Date(K.data_inizio).toLocaleDateString("it-IT")} al ${new Date(K.data_fine).toLocaleDateString("it-IT")}`};const{data:X,error:se}=await Le.from("crew_richieste_permessi").select("*").eq("dipendente_id",N).eq("stato","approvata").eq("data",_);if(X&&X.length>0&&!se){const B=X[0];return{isUnavailable:!0,reason:"Permesso",tipo:"permessi",details:`${(V=B.ora_inizio)==null?void 0:V.slice(0,5)} - ${(C=B.ora_fine)==null?void 0:C.slice(0,5)}`}}const{data:W,error:G}=await Le.from("crew_richiesteferie_permessi").select("*").eq("dipendente_id",N).eq("stato","approvata").lte("data_inizio",_).gte("data_fine",_);if(W&&W.length>0&&!G){const B=W[0];let ne="ferie",ye="Assente";return B.tipo_richiesta==="ferie"?(ne="ferie",ye="Ferie"):B.tipo_richiesta==="permesso"||B.tipo_richiesta==="permessi"?(ne="permessi",ye="Permesso"):B.tipo_richiesta==="malattia"?(ne="malattia",ye="Malattia"):B.tipo_richiesta==="infortunio"&&(ne="infortunio",ye="Infortunio"),{isUnavailable:!0,reason:ye,tipo:ne,details:B.data_fine?`Dal ${new Date(B.data_inizio).toLocaleDateString("it-IT")} al ${new Date(B.data_fine).toLocaleDateString("it-IT")}`:new Date(B.data_inizio).toLocaleDateString("it-IT")}}return{isUnavailable:!1,reason:"",tipo:null}}catch(K){return console.error("Errore verifica disponibilit√†:",K),{isUnavailable:!1,reason:"",tipo:null}}},M=()=>{S(""),E([]),l()},T=N=>{const _=g.find(V=>V.id===N);E(_?g.filter(V=>V.id!==N):[...g,{id:N,ora_inizio:(x==null?void 0:x.ora_inizio_turno)||"09:00:00",ora_fine:(x==null?void 0:x.ora_fine_turno)||"18:00:00"}])},F=(N,_,V)=>{E(g.map(C=>C.id===N?{...C,[_]:V}:C))},U=()=>{g.forEach(N=>{b(N.id,{ora_inizio:N.ora_inizio,ora_fine:N.ora_fine})}),M()};if(!n)return null;const te=u.filter(N=>v?(N.full_name||`${N.first_name} ${N.last_name}`).toLowerCase().includes(v.toLowerCase()):!0);return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-end sm:items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 rounded-t-2xl sm:rounded-2xl w-full sm:max-w-3xl max-h-[90vh] overflow-y-auto border border-gray-700",children:[e.jsxs("div",{className:"sticky top-0 bg-gray-800 border-b border-gray-700 px-6 py-4 flex items-center justify-between z-10",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"Aggiungi Dipendenti al Turno"}),e.jsx("button",{onClick:M,className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(Et,{className:"w-5 h-5 text-gray-300"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Data"}),e.jsx("div",{className:"text-white font-semibold",children:new Date(c+"T00:00:00").toLocaleDateString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]}),x&&e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-2",children:"Turno Template"}),e.jsx("div",{className:"text-white font-semibold",children:x.nome_template}),e.jsxs("div",{className:"text-sm text-gray-400 mt-2",children:[x.ora_inizio_turno.slice(0,5)," -"," ",x.ora_fine_turno.slice(0,5)]}),e.jsx("div",{className:"text-sm text-gray-400 mt-1",children:x.nome_magazzino})]}),e.jsxs("div",{className:"bg-gray-900 rounded-lg border border-gray-700",children:[e.jsx("div",{className:"p-4 border-b border-gray-700",children:e.jsxs("div",{className:"relative",children:[e.jsx(tn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Cerca dipendente...",value:v,onChange:N=>S(N.target.value),className:"w-full pl-10 pr-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"})]})}),e.jsx("div",{className:"p-4 space-y-2 max-h-[400px] overflow-y-auto",children:P?e.jsx("div",{className:"text-center py-8 text-gray-400",children:"Verifica disponibilit√† dipendenti..."}):te.map(N=>{const _=f.some(X=>X.dipendente_id===N.id&&X.data_turno===c),V=p[N.id],C=g.some(X=>X.id===N.id),K=g.find(X=>X.id===N.id),O=_||(V==null?void 0:V.isUnavailable);return e.jsxs("div",{className:`rounded-lg border transition-colors ${O?"bg-gray-800 border-gray-700 opacity-60":C?"bg-blue-900 border-blue-600":"bg-gray-800 border-gray-600 hover:border-blue-500"}`,children:[e.jsxs("div",{className:`p-4 flex items-center gap-3 ${O?"cursor-not-allowed":"cursor-pointer"}`,onClick:()=>!O&&T(N.id),children:[e.jsx("input",{type:"checkbox",checked:C,disabled:O,onChange:()=>{},className:"w-5 h-5 rounded border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-white",children:N.full_name||`${N.first_name} ${N.last_name}`}),_&&e.jsx("div",{className:"text-xs text-yellow-400 mt-1",children:"Gi√† assegnato a questo turno"}),(V==null?void 0:V.isUnavailable)&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-red-400 mt-1",children:[e.jsx(Zt,{className:"w-3 h-3"}),e.jsxs("span",{children:[V.reason,V.details&&` - ${V.details}`]})]})]})]}),C&&K&&e.jsx("div",{className:"px-4 pb-4 pt-2 border-t border-gray-700",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Ora Inizio"}),e.jsx("input",{type:"time",value:K.ora_inizio.slice(0,5),onChange:X=>F(N.id,"ora_inizio",X.target.value+":00"),className:"w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Ora Fine"}),e.jsx("input",{type:"time",value:K.ora_fine.slice(0,5),onChange:X=>F(N.id,"ora_fine",X.target.value+":00"),className:"w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]})})]},N.id)})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:M,className:"flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors",children:"Annulla"}),e.jsxs("button",{onClick:U,disabled:g.length===0,className:"flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:["Aggiungi ",g.length>0&&`(${g.length})`]})]})]})]})})},Kd=()=>{const{companyProfile:n}=us(),{addToast:l}=Tr(),[c,u]=w.useState([]),[f,x]=w.useState([]),[b,v]=w.useState([]),[S,g]=w.useState(!0),[E,p]=w.useState(me(new Date)),[k,P]=w.useState(null),[D,R]=w.useState(null),[j,M]=w.useState(!1),[T,F]=w.useState(""),[U,te]=w.useState(!1),[N,_]=w.useState(""),[V,C]=w.useState(!1),[K,O]=w.useState([]),[X,se]=w.useState(!1),[W,G]=w.useState(null),[B,ne]=w.useState(!1),ye=w.useRef(null);function me(J){const ke=new Date(J),$=ke.getDay(),ue=ke.getDate()-$+($===0?-6:1);return new Date(ke.setDate(ue))}function Q(J){const ke=[];for(let $=0;$<7;$++){const ue=new Date(J);ue.setDate(J.getDate()+$),ke.push(ue)}return ke}function fe(J){return J.toISOString().split("T")[0]}function be(J){return J.toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"})}const Z=Q(E);w.useEffect(()=>{n&&L()},[n]),w.useEffect(()=>{n&&T&&oe()},[n,E,T]);const L=async()=>{await Promise.all([re(),de()])},re=async()=>{if(n)try{const{data:J,error:ke}=await Le.from("crew_members").select("id, first_name, last_name, full_name").eq("company_id",n.id).order("full_name");if(ke)throw ke;x(J||[])}catch(J){console.error("Errore caricamento dipendenti:",J)}},de=async()=>{if(n)try{const{data:J,error:ke}=await Le.from("crew_template_turni").select("id_template, nome_template, ora_inizio_turno, ora_fine_turno, warehouse_id, nome_magazzino, indirizzo_magazzino").eq("company_id",n.id).order("nome_template");if(ke)throw ke;v(J||[]),J&&J.length>0&&!T&&F(J[0].id_template)}catch(J){console.error("Errore caricamento template:",J)}},oe=async()=>{if(!(!n||!T)){g(!0);try{const J=new Date(E);J.setDate(E.getDate()+6);const{data:ke,error:$}=await Le.from("crew_assegnazione_turni").select("*").eq("azienda_id",n.id).eq("turno_id",T).gte("data_turno",fe(E)).lte("data_turno",fe(J)).order("ora_inizio_turno",{ascending:!0});if($)throw $;u(ke||[])}catch(J){l(J.message||"Errore nel caricamento turni","error")}finally{g(!1)}}},ge=()=>{const J=new Date(E);J.setDate(E.getDate()-7),p(J)},ve=()=>{const J=new Date(E);J.setDate(E.getDate()+7),p(J)},Te=()=>{p(me(new Date))},we=J=>{const ke=fe(J);return c.filter($=>$.data_turno===ke)},je=(J,ke)=>{P({shift:J,sourceDate:ke})},Fe=J=>{J.preventDefault()},Ve=async J=>{if(k){if(k.sourceDate===J){P(null);return}try{const{error:ke}=await Le.from("crew_assegnazione_turni").update({data_turno:J}).eq("id",k.shift.id);if(ke)throw ke;l("Turno spostato con successo","success"),oe()}catch(ke){l(ke.message||"Errore nello spostamento del turno","error")}finally{P(null)}}},rt=J=>{V?Qe(J.id):(R(J),M(!0))},st=J=>{ye.current=setTimeout(()=>{C(!0),O([J.id]),l("Modalit√† selezione multipla attivata","success")},500)},Je=()=>{ye.current&&(clearTimeout(ye.current),ye.current=null)},Qe=J=>{O(ke=>ke.includes(J)?ke.filter($=>$!==J):[...ke,J])},We=()=>{C(!1),O([])},gt=async J=>{if(!V||K.length===0||!n)return;const ke=c.filter($=>K.includes($.id));try{const $=ke.map(xe=>({dipendente_id:xe.dipendente_id,dipendente_nome:xe.dipendente_nome,turno_id:xe.turno_id,nome_turno:xe.nome_turno,ora_inizio_turno:xe.ora_inizio_turno,ora_fine_turno:xe.ora_fine_turno,nome_magazzino:xe.nome_magazzino,indirizzo_magazzino:xe.indirizzo_magazzino,warehouse_id:xe.warehouse_id,data_turno:J,azienda_id:xe.azienda_id,nome_azienda:xe.nome_azienda})),{error:ue}=await Le.from("crew_assegnazione_turni").insert($);if(ue)throw ue;l(`${$.length} turni copiati con successo`,"success"),We(),oe()}catch($){l($.message||"Errore nella copia dei turni","error")}},qe=J=>{V?gt(J):Ee(J)},De=async J=>{if(D)try{const{error:ke}=await Le.from("crew_assegnazione_turni").update(J).eq("id",D.id);if(ke)throw ke;l("Turno aggiornato con successo","success"),M(!1),R(null),oe()}catch(ke){l(ke.message||"Errore nell'aggiornamento del turno","error")}},H=J=>{G(J),se(!0)},ae=async()=>{if(W)try{const{error:J}=await Le.from("crew_assegnazione_turni").delete().eq("id",W);if(J)throw J;l("Turno eliminato con successo","success"),M(!1),R(null),oe()}catch(J){l(J.message||"Errore nell'eliminazione del turno","error")}finally{se(!1),G(null)}},he=()=>{se(!1),G(null)},Ae=()=>{if(K.length===0){l("Nessun turno selezionato","error");return}ne(!0)},Re=async()=>{if(K.length!==0)try{const{error:J}=await Le.from("crew_assegnazione_turni").delete().in("id",K);if(J)throw J;l(`${K.length} turni eliminati con successo`,"success"),We(),oe()}catch(J){l(J.message||"Errore nell'eliminazione dei turni","error")}finally{ne(!1)}},ee=()=>{ne(!1)},le=async(J,ke)=>{if(!n||!T||!N)return;const $=f.find(xe=>xe.id===J),ue=b.find(xe=>xe.id_template===T);if(!$||!ue){l("Dipendente o turno non valido","error");return}try{const xe={dipendente_id:J,dipendente_nome:$.full_name||`${$.first_name} ${$.last_name}`,turno_id:T,nome_turno:ue.nome_template,ora_inizio_turno:(ke==null?void 0:ke.ora_inizio)||ue.ora_inizio_turno,ora_fine_turno:(ke==null?void 0:ke.ora_fine)||ue.ora_fine_turno,nome_magazzino:ue.nome_magazzino,indirizzo_magazzino:ue.indirizzo_magazzino,warehouse_id:ue.warehouse_id,data_turno:N,azienda_id:n.id,nome_azienda:n.company_name||""},{error:pe}=await Le.from("crew_assegnazione_turni").insert(xe);if(pe)throw pe;l("Dipendente aggiunto al turno","success"),te(!1),_(""),oe()}catch(xe){l(xe.message||"Errore nell'aggiunta del dipendente","error")}},Ee=J=>{_(J),te(!0)};if(S)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"})});const _e=b.find(J=>J.id_template===T);return e.jsxs("div",{className:"space-y-4 pb-20",children:[V&&e.jsxs("div",{className:"bg-green-600 rounded-xl border border-green-500 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(jn,{className:"w-5 h-5 text-white"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-white font-semibold",children:"Modalit√† Selezione Attiva"}),e.jsxs("div",{className:"text-green-100 text-sm",children:[K.length," turno",K.length!==1?"i":""," selezionato",K.length!==1?"i":""]})]})]}),e.jsx("button",{onClick:We,className:"p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors",children:e.jsx(Et,{className:"w-5 h-5 text-white"})})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:Ae,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:[e.jsx(Xs,{className:"w-4 h-4"}),e.jsx("span",{children:"Elimina Selezionati"})]})})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 p-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Seleziona Template Turno"}),e.jsx("select",{value:T,onChange:J=>F(J.target.value),className:"w-full bg-gray-900 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500",disabled:V,children:b.map(J=>e.jsxs("option",{value:J.id_template,children:[J.nome_template," - ",J.nome_magazzino," (",J.ora_inizio_turno.slice(0,5)," - ",J.ora_fine_turno.slice(0,5),")"]},J.id_template))})]}),_e&&e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ut,{className:"w-4 h-4 text-blue-400"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-white font-medium",children:_e.nome_magazzino}),_e.indirizzo_magazzino&&e.jsx("span",{className:"text-gray-400 ml-2",children:_e.indirizzo_magazzino})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm mt-2",children:[e.jsx(ht,{className:"w-4 h-4 text-blue-400"}),e.jsxs("span",{className:"text-gray-300",children:[_e.ora_inizio_turno.slice(0,5)," - ",_e.ora_fine_turno.slice(0,5)]})]})]}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-gray-800 rounded-xl border border-gray-700",children:[e.jsx("button",{onClick:ge,disabled:V,className:`p-2 rounded-lg transition-colors ${V?"opacity-50 cursor-not-allowed":"hover:bg-gray-700"}`,children:e.jsx(Zr,{className:"w-5 h-5 text-gray-300"})}),e.jsxs("div",{className:"text-center",children:[e.jsxs("button",{onClick:Te,disabled:V,className:`text-lg font-semibold text-white transition-colors ${V?"cursor-not-allowed":"hover:text-blue-400"}`,children:[be(Z[0])," - ",be(Z[6])]}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:V?"Clicca su altri dipendenti o su un giorno":"Tocca per oggi"})]}),e.jsx("button",{onClick:ve,disabled:V,className:`p-2 rounded-lg transition-colors ${V?"opacity-50 cursor-not-allowed":"hover:bg-gray-700"}`,children:e.jsx(Qr,{className:"w-5 h-5 text-gray-300"})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-7 gap-2 md:gap-1",children:Z.map((J,ke)=>{const $=fe(J),ue=we(J),xe=fe(new Date)===$;return e.jsxs("div",{className:`min-h-[100px] md:min-h-[120px] rounded-lg border ${xe?"border-blue-500 bg-blue-900/20":"border-gray-700 bg-gray-800"}`,onDragOver:Fe,onDrop:()=>Ve($),children:[e.jsxs("div",{className:`text-center py-2 md:py-2 border-b ${xe?"border-blue-500":"border-gray-700"}`,children:[e.jsx("div",{className:"text-sm md:text-xs text-gray-400 uppercase font-medium md:font-normal",children:J.toLocaleDateString("it-IT",{weekday:window.innerWidth<768?"long":"short"})}),e.jsxs("div",{className:`text-base md:text-sm font-semibold ${xe?"text-blue-400":"text-white"}`,children:[J.getDate()," ",window.innerWidth<768&&J.toLocaleDateString("it-IT",{month:"short"})]})]}),e.jsxs("div",{className:"p-2 md:p-1 space-y-1.5 md:space-y-1",children:[ue.map(pe=>{const Ze=K.includes(pe.id);return e.jsxs("div",{draggable:!V,onDragStart:()=>!V&&je(pe,$),onClick:()=>rt(pe),onTouchStart:()=>st(pe),onTouchEnd:Je,onMouseDown:()=>st(pe),onMouseUp:Je,onMouseLeave:Je,className:`rounded p-2 md:p-1.5 text-white text-sm md:text-xs transition-all ${Ze?"bg-green-600 border-2 border-green-400 shadow-lg":"bg-blue-600 hover:bg-blue-700 border-2 border-transparent"} ${V?"cursor-pointer":"cursor-move"}`,title:`${pe.dipendente_nome}
${pe.nome_magazzino}
${pe.ora_inizio_turno.slice(0,5)} - ${pe.ora_fine_turno.slice(0,5)}`,children:[e.jsx("div",{className:"font-medium truncate",children:pe.dipendente_nome}),e.jsxs("div",{className:"flex items-center gap-1 text-blue-200 mt-0.5",children:[e.jsx(ht,{className:"w-3 h-3 md:w-2.5 md:h-2.5"}),e.jsxs("span",{className:"truncate",children:[pe.ora_inizio_turno.slice(0,5),"-",pe.ora_fine_turno.slice(0,5)]})]}),e.jsx("div",{className:"block md:hidden text-xs text-blue-100 mt-1 truncate",children:pe.nome_magazzino})]},pe.id)}),e.jsx("button",{onClick:()=>qe($),className:`w-full rounded p-2 md:p-1.5 text-sm md:text-xs transition-colors flex items-center justify-center gap-1 ${V?"bg-green-600 hover:bg-green-700 text-white font-semibold":"bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white"}`,children:V?e.jsxs(e.Fragment,{children:[e.jsx(jn,{className:"w-4 h-4 md:w-3 md:h-3"}),e.jsx("span",{children:"Incolla qui"})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-xl md:text-lg leading-none",children:"+"}),e.jsx("span",{children:"Aggiungi"})]})})]})]},ke)})}),j&&D&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-end sm:items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 rounded-t-2xl sm:rounded-2xl w-full sm:max-w-md max-h-[80vh] overflow-y-auto border border-gray-700",children:[e.jsx("div",{className:"sticky top-0 bg-gray-800 border-b border-gray-700 px-6 py-4",children:e.jsx("h3",{className:"text-xl font-bold text-white",children:"Modifica Turno"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-2",children:"Dipendente"}),e.jsx("div",{className:"text-white font-semibold",children:D.dipendente_nome})]}),e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-2",children:"Data"}),e.jsx("input",{type:"date",value:D.data_turno,onChange:J=>R({...D,data_turno:J.target.value}),className:"w-full bg-gray-800 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500"})]}),e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-2",children:"Template Turno"}),e.jsx("select",{value:D.turno_id,onChange:J=>{const ke=b.find($=>$.id_template===J.target.value);ke&&R({...D,turno_id:J.target.value,nome_turno:ke.nome_template,ora_inizio_turno:ke.ora_inizio_turno,ora_fine_turno:ke.ora_fine_turno,nome_magazzino:ke.nome_magazzino,indirizzo_magazzino:ke.indirizzo_magazzino,warehouse_id:ke.warehouse_id})},className:"w-full bg-gray-800 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500",children:b.map(J=>e.jsxs("option",{value:J.id_template,children:[J.nome_template," - ",J.nome_magazzino," (",J.ora_inizio_turno.slice(0,5)," - ",J.ora_fine_turno.slice(0,5),")"]},J.id_template))})]}),e.jsx("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Ut,{className:"w-4 h-4 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-white font-medium",children:D.nome_magazzino}),D.indirizzo_magazzino&&e.jsx("div",{className:"text-sm text-gray-400 mt-1",children:D.indirizzo_magazzino})]})]})}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:()=>H(D.id),className:"flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Elimina"}),e.jsx("button",{onClick:()=>De(D),className:"flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors",children:"Salva"})]}),e.jsx("button",{onClick:()=>{M(!1),R(null)},className:"w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors",children:"Annulla"})]})]})}),e.jsx(Qd,{isOpen:U,onClose:()=>{te(!1),_("")},date:N,crewMembers:f,shifts:c,selectedTemplate:_e,onAddShift:le}),X&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-xl max-w-md w-full shadow-2xl",children:e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-red-100 rounded-full mx-auto mb-4",children:e.jsx(Xs,{className:"w-6 h-6 text-red-600"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 text-center mb-2",children:"Elimina Turno"}),e.jsx("p",{className:"text-gray-600 text-center mb-6",children:"Sei sicuro di voler eliminare questo turno? Questa azione non pu√≤ essere annullata."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:he,className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors",children:"Annulla"}),e.jsx("button",{onClick:ae,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Elimina"})]})]})})}),B&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-xl max-w-md w-full shadow-2xl",children:e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-red-100 rounded-full mx-auto mb-4",children:e.jsx(Xs,{className:"w-6 h-6 text-red-600"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 text-center mb-2",children:"Elimina Turni Selezionati"}),e.jsxs("p",{className:"text-gray-600 text-center mb-6",children:["Sei sicuro di voler eliminare ",K.length," turno",K.length!==1?"i":"","? Questa azione non pu√≤ essere annullata."]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:ee,className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors",children:"Annulla"}),e.jsx("button",{onClick:Re,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Elimina Tutto"})]})]})})})]})},Jd=()=>{const{companyProfile:n}=us(),{addToast:l}=Tr(),[c,u]=w.useState([]),[f,x]=w.useState(!0),[b,v]=w.useState(""),[S,g]=w.useState("all"),[E,p]=w.useState("all"),[k,P]=w.useState(!1),[D,R]=w.useState(!1),[j,M]=w.useState(!1),[T,F]=w.useState(null),[U,te]=w.useState(!1),[N,_]=w.useState(null),[V,C]=w.useState([]),[K,O]=w.useState(new Set),[X,se]=w.useState([]),[W,G]=w.useState(!1),B=[{value:"tecnico",label:"Tecnico"},{value:"sicurezza",label:"Sicurezza"},{value:"gestionale",label:"Gestionale"},{value:"comunicazione",label:"Comunicazione"},{value:"altro",label:"Altro"}],ne=[{value:"bozza",label:"Bozza",color:"gray"},{value:"pubblicato",label:"Pubblicato",color:"blue"},{value:"confermato",label:"Confermato",color:"green"},{value:"completato",label:"Completato",color:"emerald"},{value:"annullato",label:"Annullato",color:"red"}];w.useEffect(()=>{ye()},[n]);const ye=async()=>{if(n)try{x(!0);const{data:Te,error:we}=await Le.from("crew_corsi").select(`
          *,
          partecipanti_count:crew_assegnazionecorsi(count)
        `).eq("azienda_id",n.id).order("data_corso",{ascending:!1});if(we)throw we;const je=(Te==null?void 0:Te.map(Fe=>{var Ve,rt;return{...Fe,partecipanti_count:((rt=(Ve=Fe.partecipanti_count)==null?void 0:Ve[0])==null?void 0:rt.count)||0}}))||[];u(je)}catch(Te){l(Te.message||"Errore nel caricamento corsi","error")}finally{x(!1)}},me=c.filter(Te=>{var Ve;const we=Te.titolo.toLowerCase().includes(b.toLowerCase())||((Ve=Te.descrizione)==null?void 0:Ve.toLowerCase().includes(b.toLowerCase()))||Te.luogo.toLowerCase().includes(b.toLowerCase()),je=S==="all"||Te.categoria===S,Fe=E==="all"||Te.stato===E;return we&&je&&Fe}),Q=()=>{F(null),te(!1),P(!0)},fe=Te=>{F(Te),te(!0),P(!0)},be=async Te=>{if(confirm("Sei sicuro di voler eliminare questo corso?"))try{const{error:we}=await Le.from("crew_corsi").delete().eq("id",Te);if(we)throw we;l("Corso eliminato con successo","success"),ye()}catch(we){l(we.message||"Errore durante l'eliminazione","error")}},Z=Te=>{F(Te),R(!0)},L=async Te=>{_(Te),O(new Set);try{const[we,je]=await Promise.all([Le.from("registration_requests").select("id, full_name, email, tipologia_registrazione").eq("parent_company_id",n.id).eq("status","approved").in("tipologia_registrazione",["dipendente","freelance"]).order("full_name",{ascending:!0}),Le.from("crew_assegnazionecorsi").select("persona_id").eq("corso_id",Te.id)]);if(we.error)throw we.error;if(je.error)throw je.error;C(we.data||[]),se(je.data||[])}catch(we){l(we.message||"Errore caricamento dipendenti","error")}},re=Te=>{F(Te),M(!0)},de=async()=>{if(T)try{const{error:Te}=await Le.from("crew_corsi").update({stato:"confermato",confermato:!0,updated_at:new Date().toISOString()}).eq("id",T.id);if(Te)throw Te;l("Corso confermato con successo","success"),M(!1),F(null),ye()}catch(Te){l(Te.message||"Errore durante la conferma","error")}},oe=Te=>{const we=new Set(K);if(we.has(Te))we.delete(Te);else{const je=X.map(Ve=>Ve.persona_id),Fe=((N==null?void 0:N.max_partecipanti)||0)-je.length;if(we.size>=Fe){l(`Massimo ${N==null?void 0:N.max_partecipanti} partecipanti raggiunto`,"error");return}we.add(Te)}O(we)},ge=async()=>{if(!N||K.size===0){l("Seleziona almeno un dipendente","error");return}try{G(!0);const Te=Array.from(K).map(je=>{const Fe=V.find(rt=>rt.id===je),Ve=new Date().toISOString();return{azienda_id:n.id,corso_id:N.id,corso_titolo:N.titolo,persona_id:je,persona_nome:Fe==null?void 0:Fe.full_name,persona_tipo:(Fe==null?void 0:Fe.tipologia_registrazione)||"dipendente",persona_email:Fe==null?void 0:Fe.email,stato_invito:"confermato",data_invito:Ve,data_conferma:Ve}}),{error:we}=await Le.from("crew_assegnazionecorsi").insert(Te);if(we)throw we;l(`${K.size} partecipanti assegnati con successo`,"success"),_(null),O(new Set),C([]),se([]),ye()}catch(Te){l(Te.message||"Errore durante l'assegnazione","error")}finally{G(!1)}},ve=Te=>{const we=ne.find(je=>je.value===Te);return(we==null?void 0:we.color)||"gray"};if(f)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"})});if(N){const Te=X.map(je=>je.persona_id),we=N.max_partecipanti-Te.length;return e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white p-4 space-y-4 pb-24",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Assegna Partecipanti"}),e.jsx("button",{onClick:()=>{_(null),O(new Set),C([]),se([])},className:"text-gray-400 hover:text-white",children:e.jsx(Et,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsx("h3",{className:"font-semibold text-white mb-2",children:N.titolo}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xt,{className:"h-4 w-4"}),e.jsx("span",{children:new Date(N.data_corso).toLocaleDateString("it-IT")})]}),N.luogo&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:N.luogo})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(os,{className:"h-4 w-4"}),e.jsxs("span",{children:[Te.length+K.size," / ",N.max_partecipanti," partecipanti",Te.length>0&&e.jsxs("span",{className:"text-green-400 ml-1",children:["(",Te.length," gi√† assegnati)"]})]})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-white mb-3",children:["Seleziona Dipendenti (",K.size," / ",we," disponibili)"]}),V.length===0?e.jsxs("div",{className:"bg-gray-800 rounded-lg p-8 text-center",children:[e.jsx(os,{className:"w-12 h-12 text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-400",children:"Nessun dipendente disponibile"})]}):e.jsx("div",{className:"space-y-2",children:V.map(je=>{const Fe=K.has(je.id),Ve=Te.includes(je.id);return e.jsxs("button",{onClick:()=>!Ve&&oe(je.id),disabled:Ve,className:`w-full flex items-center justify-between p-4 rounded-lg border-2 transition-all ${Ve?"bg-green-600/30 border-green-500 cursor-not-allowed":Fe?"bg-blue-500/20 border-blue-500":"bg-gray-800 border-gray-700 hover:bg-gray-750"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${Ve?"bg-green-500":Fe?"bg-blue-500":"bg-gray-700"}`,children:Ve||Fe?e.jsx(qr,{className:"h-6 w-6 text-white"}):e.jsx(os,{className:"h-5 w-5 text-gray-400"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:`font-semibold ${Ve?"text-green-300":"text-white"}`,children:je.full_name}),e.jsx("p",{className:`text-sm ${Ve?"text-green-400 font-medium":"text-gray-400"} capitalize`,children:Ve?"Gi√† assegnato":je.tipologia_registrazione})]})]}),Ve&&e.jsx("span",{className:"text-sm text-green-300 font-bold bg-green-500/20 px-3 py-1 rounded-full",children:"ASSEGNATO"})]},je.id)})})]}),K.size>0&&e.jsx("button",{onClick:ge,disabled:W,className:"w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-700 text-white py-4 rounded-lg font-medium text-lg flex items-center justify-center gap-2",children:W?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),e.jsx("span",{children:"Salvataggio..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(qr,{className:"h-5 w-5"}),e.jsxs("span",{children:["Conferma Assegnazioni (",K.size,")"]})]})})]})}return e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white p-4 space-y-4",children:[e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Gestione Corsi"}),e.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"Organizza e monitora i corsi di formazione"})]})}),e.jsxs("button",{onClick:Q,className:"w-full flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors shadow-lg",children:[e.jsx(pa,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"Nuovo Corso"})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(tn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Cerca corsi...",value:b,onChange:Te=>v(Te.target.value),className:"w-full pl-10 pr-4 py-2.5 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Categoria"}),e.jsxs("select",{value:S,onChange:Te=>g(Te.target.value),className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"Tutte"}),B.map(Te=>e.jsx("option",{value:Te.value,children:Te.label},Te.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Stato"}),e.jsxs("select",{value:E,onChange:Te=>p(Te.target.value),className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"Tutti"}),ne.map(Te=>e.jsx("option",{value:Te.value,children:Te.label},Te.value))]})]})]})]}),me.length===0?e.jsxs("div",{className:"bg-gray-800 rounded-lg p-12 text-center",children:[e.jsx(ui,{className:"w-16 h-16 text-gray-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"Nessun corso trovato"}),e.jsx("p",{className:"text-gray-400 mb-6",children:b||S!=="all"||E!=="all"?"Prova a modificare i filtri di ricerca":"Inizia creando il tuo primo corso di formazione"}),!b&&S==="all"&&E==="all"&&e.jsxs("button",{onClick:Q,className:"inline-flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(pa,{className:"w-5 h-5"}),e.jsx("span",{children:"Crea Primo Corso"})]})]}):e.jsx("div",{className:"space-y-3",children:me.map(Te=>e.jsx(eu,{course:Te,onEdit:fe,onDelete:be,onViewDetails:Z,onAssignParticipants:L,onConfirm:re,getStatusColor:ve},Te.id))}),k&&e.jsx(tu,{course:T,isEdit:U,onClose:()=>{P(!1),F(null),te(!1)},onSuccess:()=>{P(!1),F(null),te(!1),ye()},categories:B,statusOptions:ne}),D&&T&&e.jsx(su,{course:T,onClose:()=>{R(!1),F(null)}}),j&&T&&e.jsx("div",{className:"fixed top-16 left-0 right-0 bottom-0 z-30 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg border border-gray-700 w-full max-w-md p-6 space-y-4 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-green-600/20 flex items-center justify-center",children:e.jsx(qr,{className:"w-6 h-6 text-green-500"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Conferma Corso"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Questa azione render√† il corso visibile"})]})]}),e.jsxs("div",{className:"bg-gray-900/50 rounded-lg p-4 space-y-2",children:[e.jsx("p",{className:"text-white font-medium",children:T.titolo}),e.jsxs("p",{className:"text-sm text-gray-400",children:["Il corso passer√† allo stato ",e.jsx("span",{className:"text-green-400 font-medium",children:'"Confermato"'})," e sar√† visibile a tutti i dipendenti assegnati."]})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>{M(!1),F(null)},className:"flex-1 px-4 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium",children:"Annulla"}),e.jsx("button",{onClick:de,className:"flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium",children:"Conferma"})]})]})})]})},eu=({course:n,onEdit:l,onDelete:c,onViewDetails:u,onAssignParticipants:f,onConfirm:x,getStatusColor:b})=>{const v=b(n.stato),S={gray:"bg-gray-700 text-gray-300",blue:"bg-blue-900/50 text-blue-300",yellow:"bg-yellow-900/50 text-yellow-300",green:"bg-green-900/50 text-green-300",red:"bg-red-900/50 text-red-300"},g=E=>new Date(E).toLocaleDateString("it-IT",{day:"2-digit",month:"long",year:"numeric"});return e.jsx("div",{className:"bg-gray-800 rounded-lg border border-gray-700 overflow-hidden",children:e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{className:"flex items-start justify-between gap-2",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-lg text-white mb-1 truncate",children:n.titolo}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`inline-block px-2 py-0.5 text-xs font-medium rounded ${S[v]}`,children:n.stato.replace("_"," ").toUpperCase()}),n.obbligatorio&&e.jsx("span",{className:"bg-red-900/50 text-red-300 text-xs px-2 py-0.5 rounded font-medium",children:"OBBLIGATORIO"})]})]})}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-300",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xt,{className:"w-4 h-4 text-gray-500 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:g(n.data_corso)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ht,{className:"w-4 h-4 text-gray-500 flex-shrink-0"}),e.jsxs("span",{children:[n.ora_inizio," - ",n.ora_fine]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"w-4 h-4 text-gray-500 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:n.luogo})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(os,{className:"w-4 h-4 text-gray-500 flex-shrink-0"}),e.jsxs("span",{children:[n.partecipanti_count||0," / ",n.max_partecipanti," partecipanti"]})]})]}),n.descrizione&&e.jsx("p",{className:"text-sm text-gray-400 line-clamp-2",children:n.descrizione}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 pt-3 border-t border-gray-700",children:[n.stato==="bozza"&&e.jsxs("button",{onClick:()=>x(n),className:"col-span-2 flex items-center justify-center gap-2 px-3 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",children:[e.jsx(qr,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Conferma Corso"})]}),e.jsxs("button",{onClick:()=>u(n),className:"flex items-center justify-center gap-2 px-3 py-2 bg-gray-700 text-gray-200 rounded-lg hover:bg-gray-600 transition-colors",children:[e.jsx(en,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Dettagli"})]}),e.jsxs("button",{onClick:()=>f(n),className:"flex items-center justify-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(Ao,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Assegna"})]}),e.jsxs("button",{onClick:()=>l(n),className:"flex items-center justify-center gap-2 px-3 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors",children:[e.jsx(ir,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Modifica"})]}),e.jsxs("button",{onClick:()=>c(n.id),className:"flex items-center justify-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:[e.jsx(Xs,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Elimina"})]})]})]})})},tu=({course:n,isEdit:l,onClose:c,onSuccess:u,categories:f,statusOptions:x})=>{const{companyProfile:b}=us(),{addToast:v}=Tr(),[S,g]=w.useState(!1),[E,p]=w.useState({titolo:(n==null?void 0:n.titolo)||"",descrizione:(n==null?void 0:n.descrizione)||"",data_corso:(n==null?void 0:n.data_corso)||"",ora_inizio:(n==null?void 0:n.ora_inizio)||"09:00",ora_fine:(n==null?void 0:n.ora_fine)||"17:00",luogo:(n==null?void 0:n.luogo)||"",istruttore:(n==null?void 0:n.istruttore)||"",categoria:(n==null?void 0:n.categoria)||"tecnico",obbligatorio:(n==null?void 0:n.obbligatorio)||!1,max_partecipanti:(n==null?void 0:n.max_partecipanti)||20,visibilita:(n==null?void 0:n.visibilita)||"pubblico",stato:(n==null?void 0:n.stato)||"bozza",confermato:(n==null?void 0:n.confermato)||!1,note:(n==null?void 0:n.note)||""}),k=async P=>{if(P&&P.preventDefault(),!!b){if(!E.titolo||!E.data_corso||!E.luogo){v("Compila tutti i campi obbligatori","error");return}try{if(g(!0),l&&n){const{error:D}=await Le.from("crew_corsi").update({...E,updated_at:new Date().toISOString()}).eq("id",n.id);if(D)throw D;v("Corso aggiornato con successo","success")}else{const{error:D}=await Le.from("crew_corsi").insert({...E,azienda_id:b.id});if(D)throw D;v("Corso creato con successo","success")}u()}catch(D){v(D.message||"Errore durante il salvataggio","error")}finally{g(!1)}}};return e.jsx("div",{className:"fixed top-16 left-0 right-0 bottom-0 bg-black/95 z-30 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-gray-900 w-full max-w-2xl rounded-lg shadow-xl flex flex-col max-h-[85vh]",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-800",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:l?"Modifica Corso":"Nuovo Corso"}),e.jsx("button",{onClick:c,className:"p-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(Et,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:k,className:"flex-1 overflow-y-auto p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Titolo Corso *"}),e.jsx("input",{type:"text",value:E.titolo,onChange:P=>p({...E,titolo:P.target.value}),className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",placeholder:"Es: Corso Sicurezza Base",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Descrizione"}),e.jsx("textarea",{value:E.descrizione,onChange:P=>p({...E,descrizione:P.target.value}),rows:2,className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm",placeholder:"Descrizione del corso..."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Data Corso *"}),e.jsx("input",{type:"date",value:E.data_corso,onChange:P=>p({...E,data_corso:P.target.value}),className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Categoria *"}),e.jsx("select",{value:E.categoria,onChange:P=>p({...E,categoria:P.target.value}),className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",children:f.map(P=>e.jsx("option",{value:P.value,children:P.label},P.value))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Ora Inizio *"}),e.jsx("input",{type:"time",value:E.ora_inizio,onChange:P=>p({...E,ora_inizio:P.target.value}),className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Ora Fine *"}),e.jsx("input",{type:"time",value:E.ora_fine,onChange:P=>p({...E,ora_fine:P.target.value}),className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Luogo *"}),e.jsx("input",{type:"text",value:E.luogo,onChange:P=>p({...E,luogo:P.target.value}),placeholder:"Es: Sede Centrale, Aula 1",className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Istruttore"}),e.jsx("input",{type:"text",value:E.istruttore,onChange:P=>p({...E,istruttore:P.target.value}),placeholder:"Nome dell'istruttore",className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Max Partecipanti"}),e.jsx("input",{type:"number",value:E.max_partecipanti,onChange:P=>p({...E,max_partecipanti:parseInt(P.target.value)}),min:"1",className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Stato"}),e.jsx("select",{value:E.stato,onChange:P=>p({...E,stato:P.target.value}),className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",children:x.map(P=>e.jsx("option",{value:P.value,children:P.label},P.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center gap-2 bg-gray-800 p-3 rounded-lg cursor-pointer hover:bg-gray-750 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:E.obbligatorio,onChange:P=>p({...E,obbligatorio:P.target.checked}),className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-200",children:"Corso Obbligatorio"})]}),e.jsxs("label",{className:"flex items-center gap-2 bg-gray-800 p-3 rounded-lg cursor-pointer hover:bg-gray-750 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:E.confermato,onChange:P=>p({...E,confermato:P.target.checked}),className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-200",children:"Confermato"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Note"}),e.jsx("textarea",{value:E.note,onChange:P=>p({...E,note:P.target.value}),rows:2,className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm",placeholder:"Note aggiuntive..."})]})]}),e.jsxs("div",{className:"border-t border-gray-800 p-4 flex gap-3",children:[e.jsx("button",{type:"button",onClick:c,className:"flex-1 px-4 py-2.5 text-white bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors font-medium text-sm",children:"Annulla"}),e.jsx("button",{type:"submit",disabled:S,onClick:k,className:"flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 font-medium text-sm",children:S?"Salvataggio...":l?"Aggiorna":"Crea Corso"})]})]})})},su=({course:n,onClose:l})=>{const[c,u]=w.useState([]),[f,x]=w.useState(!0);w.useEffect(()=>{b()},[]);const b=async()=>{try{const{data:S,error:g}=await Le.from("crew_assegnazionecorsi").select("*").eq("corso_id",n.id).order("persona_nome");if(g)throw g;u(S||[])}catch(S){console.error("Error loading assignments:",S)}finally{x(!1)}},v=S=>new Date(S).toLocaleDateString("it-IT",{day:"2-digit",month:"long",year:"numeric"});return e.jsx("div",{className:"fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-gray-900 w-full max-w-2xl rounded-lg shadow-xl flex flex-col max-h-[90vh]",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-800",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:n.titolo}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:n.categoria})]}),e.jsx("button",{onClick:l,className:"p-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(Et,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 space-y-2",children:[e.jsx("h3",{className:"font-semibold text-white text-sm",children:"Informazioni Corso"}),e.jsxs("div",{className:"space-y-1.5 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xt,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-gray-300",children:v(n.data_corso)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ht,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),e.jsxs("span",{className:"text-gray-300",children:[n.ora_inizio," - ",n.ora_fine]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-gray-300",children:n.luogo})]}),n.istruttore&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(os,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),e.jsxs("span",{className:"text-gray-300",children:["Istruttore: ",n.istruttore]})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 space-y-2",children:[e.jsx("h3",{className:"font-semibold text-white text-sm",children:"Dettagli"}),e.jsxs("div",{className:"space-y-1 text-xs text-gray-300",children:[e.jsxs("div",{children:["Stato: ",e.jsx("span",{className:"font-medium text-white",children:n.stato})]}),e.jsxs("div",{children:["Max Partecipanti: ",e.jsx("span",{className:"font-medium text-white",children:n.max_partecipanti})]}),e.jsxs("div",{children:["Obbligatorio: ",e.jsx("span",{className:"font-medium text-white",children:n.obbligatorio?"S√¨":"No"})]}),e.jsxs("div",{children:["Confermato: ",e.jsx("span",{className:"font-medium text-white",children:n.confermato?"S√¨":"No"})]})]})]}),n.descrizione&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3",children:[e.jsx("h3",{className:"font-semibold text-white text-sm mb-1.5",children:"Descrizione"}),e.jsx("p",{className:"text-xs text-gray-300",children:n.descrizione})]}),n.note&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3",children:[e.jsx("h3",{className:"font-semibold text-white text-sm mb-1.5",children:"Note"}),e.jsx("p",{className:"text-xs text-gray-300",children:n.note})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3",children:[e.jsxs("h3",{className:"font-semibold text-white text-sm mb-2",children:["Partecipanti (",c.length,")"]}),f?e.jsx("div",{className:"text-center py-6",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mx-auto"})}):c.length===0?e.jsxs("div",{className:"text-center py-6",children:[e.jsx(os,{className:"w-10 h-10 text-gray-600 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"Nessun partecipante assegnato"})]}):e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:c.map(S=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-700 rounded-lg",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-white truncate",children:S.persona_nome}),e.jsx("div",{className:"text-xs text-gray-400 truncate",children:S.persona_email})]}),e.jsx("span",{className:`px-2 py-0.5 text-xs rounded flex-shrink-0 ml-2 ${S.stato_invito==="confermato"?"bg-green-900/50 text-green-300":S.stato_invito==="rifiutato"?"bg-red-900/50 text-red-300":"bg-yellow-900/50 text-yellow-300"}`,children:S.stato_invito})]},S.id))})]})]}),e.jsx("div",{className:"border-t border-gray-800 p-4",children:e.jsx("button",{onClick:l,className:"w-full px-4 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium text-sm",children:"Chiudi"})})]})})},ru=()=>{const{user:n,loading:l}=us(),{toasts:c,removeToast:u}=Dr(),[f,x]=kt.useState("dashboard");if(l)return e.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"})});if(!n)return e.jsx(kd,{});const b=()=>{switch(f){case"checkin":return e.jsx(Xd,{});case"events":return e.jsx($d,{});case"courses":return e.jsx(Jd,{});case"shifts":return e.jsx("div",{className:"p-4",children:e.jsx(Kd,{})});case"calendar":return e.jsx(Pd,{});case"expenses":return e.jsx(Yd,{});case"report":return e.jsx(qd,{});case"talk":return e.jsx(Zd,{});case"profile":return e.jsx(Fd,{});default:return e.jsx(Ld,{onNavigate:x})}};return e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white flex flex-col",children:[e.jsx(Od,{}),e.jsx("div",{className:"flex-1 flex flex-col pb-20",children:e.jsx("main",{className:"flex-1 p-0 overflow-y-auto",children:b()})}),e.jsx(Rd,{activeTab:f,onTabChange:x}),e.jsx(Dd,{toasts:c,onRemoveToast:u})]})},au=()=>e.jsx(Id,{children:e.jsx(Ad,{children:e.jsx(ru,{})})}),nu=()=>{const{user:n,loading:l,isFirstAccess:c}=Pt(),{toasts:u,removeToast:f,showInfo:x}=ms(),{currentVersion:b,latestVersion:v,releaseNotes:S,hasUpdate:g,isLoading:E,isUpdating:p,checkForUpdates:k,applyUpdate:P}=$l(),[D,R]=kt.useState("dashboard"),[j,M]=kt.useState(!1),[T,F]=kt.useState(!0),[U,te]=kt.useState(!1);kt.useEffect(()=>{c&&n&&M(!0)},[c,n]),kt.useEffect(()=>{g&&!U&&(te(!0),x("Aggiornamento Disponibile",`Nuova versione ${v} disponibile. Tocca per aggiornare.`,1e4))},[g,U,v,x]);const N=async()=>{te(!1),x("Aggiornamento in corso...","L'app si riavvier√† automaticamente",3e3),await P()},_=()=>{te(!1),x("Aggiornamento rimandato","Puoi aggiornare in qualsiasi momento dal menu",5e3)},V=async()=>{await k(!0)?te(!0):x("App Aggiornata","Stai gi√† usando l'ultima versione disponibile",3e3)};if(T&&!n)return e.jsx("div",{className:"min-h-screen",children:e.jsx(Xl,{onEnter:()=>F(!1)})});if(l)return e.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"})});if(!n)return e.jsx("div",{className:"min-h-screen bg-gray-100",children:e.jsx(kn,{children:e.jsxs(Cl,{children:[e.jsx(ha,{path:"/register",element:e.jsx(tc,{})}),e.jsx(ha,{path:"/azienda/*",element:e.jsx(au,{})}),e.jsx(ha,{path:"*",element:e.jsx(Zl,{})})]})})});const C=()=>{switch(D){case"calendar":return e.jsx(xc,{});case"checkin":return e.jsx(rd,{});case"expenses":return e.jsx(jd,{});case"talk":return e.jsx(Ti,{});case"report":return e.jsx(pd,{});case"profile":return e.jsx(ld,{});default:return e.jsx(hc,{onNavigate:R})}};return e.jsxs(kn,{children:[e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white flex flex-col",children:[e.jsx(nc,{currentVersion:b,hasUpdate:g,isVersionLoading:E,isUpdating:p,onCheckUpdate:V}),e.jsx("div",{className:"flex-1 flex flex-col pb-20",children:e.jsx("main",{className:"flex-1 p-0 overflow-y-auto",children:C()})}),e.jsx(ic,{activeTab:D,onTabChange:R})]}),e.jsx(Wl,{toasts:u,onRemoveToast:f}),U&&g&&e.jsx(Yl,{currentVersion:b,latestVersion:v,releaseNotes:S,isUpdating:p,onUpdate:N,onDismiss:_}),j&&e.jsx(sc,{isOpen:j,onClose:()=>M(!1)})]})},iu=()=>e.jsx(Ul,{children:e.jsx(ql,{children:e.jsx(Hl,{children:e.jsx(nu,{})})})});if("serviceWorker"in navigator){const n=window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches,l=window.navigator.standalone===!0;n||l?(console.log("üì± App gi√† installata come PWA"),document.body.classList.add("pwa-installed")):(console.log("üì± App in modalit√† browser"),document.body.classList.add("pwa-browser"))}mi(document.getElementById("root")).render(e.jsx(w.StrictMode,{children:e.jsx(iu,{})}));
