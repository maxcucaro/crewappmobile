import{r as w,a as uo,R as ho,b as Tt,c as Yr,d as xo}from"./react-vendor-BPcwhftq.js";import{c as ri}from"./supabase-vendor-BVx-vNnC.js";import{X as jt,I as pa,A as Zt,a as sn,C as ft,S as rn,R as Ds,D as hr,U as ls,b as mo,c as fo,d as ct,e as ut,F as Ht,L as ai,E as ni,f as an,B as zt,g as ea,h as ii,i as Zr,M as Ks,j as wt,T as Js,k as $r,l as Ir,V as go,m as oi,n as li,o as Ea,p as Ut,H as ci,Q as ba,G as Ss,q as Bs,r as ta,s as sa,P as Ts,N as Qr,t as As,u as di,v as Xa,w as wa,x as Za,W as ui,y as kr,z as hi,J as Sa,K as cr,O as ya,Y as xi,Z as po,_ as bo,$ as wo,a0 as mi,a1 as yo,a2 as Va,a3 as _a,a4 as Xr,a5 as _o,a6 as vo,a7 as No,a8 as jo,a9 as nn,aa as En,ab as Co,ac as Eo,ad as So,ae as Sn,af as Ao}from"./ui-vendor-JIt2ANjw.js";function Io(n,l){for(var c=0;c<l.length;c++){const u=l[c];if(typeof u!="string"&&!Array.isArray(u)){for(const f in u)if(f!=="default"&&!(f in n)){const x=Object.getOwnPropertyDescriptor(u,f);x&&Object.defineProperty(n,f,x.get?x:{enumerable:!0,get:()=>u[f]})}}}return Object.freeze(Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}))}(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const f of document.querySelectorAll('link[rel="modulepreload"]'))u(f);new MutationObserver(f=>{for(const x of f)if(x.type==="childList")for(const b of x.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&u(b)}).observe(document,{childList:!0,subtree:!0});function c(f){const x={};return f.integrity&&(x.integrity=f.integrity),f.referrerPolicy&&(x.referrerPolicy=f.referrerPolicy),f.crossOrigin==="use-credentials"?x.credentials="include":f.crossOrigin==="anonymous"?x.credentials="omit":x.credentials="same-origin",x}function u(f){if(f.ep)return;f.ep=!0;const x=c(f);fetch(f.href,x)}})();var fi={exports:{}},Aa={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var To=w,Do=Symbol.for("react.element"),ko=Symbol.for("react.fragment"),Mo=Object.prototype.hasOwnProperty,zo=To.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Oo={key:!0,ref:!0,__self:!0,__source:!0};function gi(n,l,c){var u,f={},x=null,b=null;c!==void 0&&(x=""+c),l.key!==void 0&&(x=""+l.key),l.ref!==void 0&&(b=l.ref);for(u in l)Mo.call(l,u)&&!Oo.hasOwnProperty(u)&&(f[u]=l[u]);if(n&&n.defaultProps)for(u in l=n.defaultProps,l)f[u]===void 0&&(f[u]=l[u]);return{$$typeof:Do,type:n,key:x,ref:b,props:f,_owner:zo.current}}Aa.Fragment=ko;Aa.jsx=gi;Aa.jsxs=gi;fi.exports=Aa;var e=fi.exports,pi,An=uo;pi=An.createRoot,An.hydrateRoot;/**
 * @remix-run/router v1.23.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Kr(){return Kr=Object.assign?Object.assign.bind():function(n){for(var l=1;l<arguments.length;l++){var c=arguments[l];for(var u in c)Object.prototype.hasOwnProperty.call(c,u)&&(n[u]=c[u])}return n},Kr.apply(this,arguments)}var lr;(function(n){n.Pop="POP",n.Push="PUSH",n.Replace="REPLACE"})(lr||(lr={}));const In="popstate";function Ro(n){n===void 0&&(n={});function l(u,f){let{pathname:x,search:b,hash:v}=u.location;return Qa("",{pathname:x,search:b,hash:v},f.state&&f.state.usr||null,f.state&&f.state.key||"default")}function c(u,f){return typeof f=="string"?f:va(f)}return Po(l,c,null,n)}function Xt(n,l){if(n===!1||n===null||typeof n>"u")throw new Error(l)}function bi(n,l){if(!n){typeof console<"u"&&console.warn(l);try{throw new Error(l)}catch{}}}function Lo(){return Math.random().toString(36).substr(2,8)}function Tn(n,l){return{usr:n.state,key:n.key,idx:l}}function Qa(n,l,c,u){return c===void 0&&(c=null),Kr({pathname:typeof n=="string"?n:n.pathname,search:"",hash:""},typeof l=="string"?Mr(l):l,{state:c,key:l&&l.key||u||Lo()})}function va(n){let{pathname:l="/",search:c="",hash:u=""}=n;return c&&c!=="?"&&(l+=c.charAt(0)==="?"?c:"?"+c),u&&u!=="#"&&(l+=u.charAt(0)==="#"?u:"#"+u),l}function Mr(n){let l={};if(n){let c=n.indexOf("#");c>=0&&(l.hash=n.substr(c),n=n.substr(0,c));let u=n.indexOf("?");u>=0&&(l.search=n.substr(u),n=n.substr(0,u)),n&&(l.pathname=n)}return l}function Po(n,l,c,u){u===void 0&&(u={});let{window:f=document.defaultView,v5Compat:x=!1}=u,b=f.history,v=lr.Pop,S=null,g=j();g==null&&(g=0,b.replaceState(Kr({},b.state,{idx:g}),""));function j(){return(b.state||{idx:null}).idx}function p(){v=lr.Pop;let C=j(),D=C==null?null:C-g;g=C,S&&S({action:v,location:R.location,delta:D})}function M(C,D){v=lr.Push;let E=Qa(R.location,C,D);g=j()+1;let U=Tn(E,g),q=R.createHref(E);try{b.pushState(U,"",q)}catch(J){if(J instanceof DOMException&&J.name==="DataCloneError")throw J;f.location.assign(q)}x&&S&&S({action:v,location:R.location,delta:1})}function B(C,D){v=lr.Replace;let E=Qa(R.location,C,D);g=j();let U=Tn(E,g),q=R.createHref(E);b.replaceState(U,"",q),x&&S&&S({action:v,location:R.location,delta:0})}function k(C){let D=f.location.origin!=="null"?f.location.origin:f.location.href,E=typeof C=="string"?C:va(C);return E=E.replace(/ $/,"%20"),Xt(D,"No window.location.(origin|href) available to create URL for href: "+E),new URL(E,D)}let R={get action(){return v},get location(){return n(f,b)},listen(C){if(S)throw new Error("A history only accepts one active listener");return f.addEventListener(In,p),S=C,()=>{f.removeEventListener(In,p),S=null}},createHref(C){return l(f,C)},createURL:k,encodeLocation(C){let D=k(C);return{pathname:D.pathname,search:D.search,hash:D.hash}},push:M,replace:B,go(C){return b.go(C)}};return R}var Dn;(function(n){n.data="data",n.deferred="deferred",n.redirect="redirect",n.error="error"})(Dn||(Dn={}));function Bo(n,l,c){return c===void 0&&(c="/"),Fo(n,l,c,!1)}function Fo(n,l,c,u){let f=typeof l=="string"?Mr(l):l,x=on(f.pathname||"/",c);if(x==null)return null;let b=wi(n);Uo(b);let v=null;for(let S=0;v==null&&S<b.length;++S){let g=Ko(x);v=Zo(b[S],g,u)}return v}function wi(n,l,c,u){l===void 0&&(l=[]),c===void 0&&(c=[]),u===void 0&&(u="");let f=(x,b,v)=>{let S={relativePath:v===void 0?x.path||"":v,caseSensitive:x.caseSensitive===!0,childrenIndex:b,route:x};S.relativePath.startsWith("/")&&(Xt(S.relativePath.startsWith(u),'Absolute route path "'+S.relativePath+'" nested under path '+('"'+u+'" is not valid. An absolute child route path ')+"must start with the combined path of all its parent routes."),S.relativePath=S.relativePath.slice(u.length));let g=dr([u,S.relativePath]),j=c.concat(S);x.children&&x.children.length>0&&(Xt(x.index!==!0,"Index routes must not have child routes. Please remove "+('all child routes from route path "'+g+'".')),wi(x.children,l,j,g)),!(x.path==null&&!x.index)&&l.push({path:g,score:$o(g,x.index),routesMeta:j})};return n.forEach((x,b)=>{var v;if(x.path===""||!((v=x.path)!=null&&v.includes("?")))f(x,b);else for(let S of yi(x.path))f(x,b,S)}),l}function yi(n){let l=n.split("/");if(l.length===0)return[];let[c,...u]=l,f=c.endsWith("?"),x=c.replace(/\?$/,"");if(u.length===0)return f?[x,""]:[x];let b=yi(u.join("/")),v=[];return v.push(...b.map(S=>S===""?x:[x,S].join("/"))),f&&v.push(...b),v.map(S=>n.startsWith("/")&&S===""?"/":S)}function Uo(n){n.sort((l,c)=>l.score!==c.score?c.score-l.score:Xo(l.routesMeta.map(u=>u.childrenIndex),c.routesMeta.map(u=>u.childrenIndex)))}const Vo=/^:[\w-]+$/,qo=3,Ho=2,Go=1,Wo=10,Yo=-2,kn=n=>n==="*";function $o(n,l){let c=n.split("/"),u=c.length;return c.some(kn)&&(u+=Yo),l&&(u+=Ho),c.filter(f=>!kn(f)).reduce((f,x)=>f+(Vo.test(x)?qo:x===""?Go:Wo),u)}function Xo(n,l){return n.length===l.length&&n.slice(0,-1).every((u,f)=>u===l[f])?n[n.length-1]-l[l.length-1]:0}function Zo(n,l,c){let{routesMeta:u}=n,f={},x="/",b=[];for(let v=0;v<u.length;++v){let S=u[v],g=v===u.length-1,j=x==="/"?l:l.slice(x.length)||"/",p=Mn({path:S.relativePath,caseSensitive:S.caseSensitive,end:g},j),M=S.route;if(!p&&g&&c&&!u[u.length-1].route.index&&(p=Mn({path:S.relativePath,caseSensitive:S.caseSensitive,end:!1},j)),!p)return null;Object.assign(f,p.params),b.push({params:f,pathname:dr([x,p.pathname]),pathnameBase:sl(dr([x,p.pathnameBase])),route:M}),p.pathnameBase!=="/"&&(x=dr([x,p.pathnameBase]))}return b}function Mn(n,l){typeof n=="string"&&(n={path:n,caseSensitive:!1,end:!0});let[c,u]=Qo(n.path,n.caseSensitive,n.end),f=l.match(c);if(!f)return null;let x=f[0],b=x.replace(/(.)\/+$/,"$1"),v=f.slice(1);return{params:u.reduce((g,j,p)=>{let{paramName:M,isOptional:B}=j;if(M==="*"){let R=v[p]||"";b=x.slice(0,x.length-R.length).replace(/(.)\/+$/,"$1")}const k=v[p];return B&&!k?g[M]=void 0:g[M]=(k||"").replace(/%2F/g,"/"),g},{}),pathname:x,pathnameBase:b,pattern:n}}function Qo(n,l,c){l===void 0&&(l=!1),c===void 0&&(c=!0),bi(n==="*"||!n.endsWith("*")||n.endsWith("/*"),'Route path "'+n+'" will be treated as if it were '+('"'+n.replace(/\*$/,"/*")+'" because the `*` character must ')+"always follow a `/` in the pattern. To get rid of this warning, "+('please change the route path to "'+n.replace(/\*$/,"/*")+'".'));let u=[],f="^"+n.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(b,v,S)=>(u.push({paramName:v,isOptional:S!=null}),S?"/?([^\\/]+)?":"/([^\\/]+)"));return n.endsWith("*")?(u.push({paramName:"*"}),f+=n==="*"||n==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):c?f+="\\/*$":n!==""&&n!=="/"&&(f+="(?:(?=\\/|$))"),[new RegExp(f,l?void 0:"i"),u]}function Ko(n){try{return n.split("/").map(l=>decodeURIComponent(l).replace(/\//g,"%2F")).join("/")}catch(l){return bi(!1,'The URL path "'+n+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent '+("encoding ("+l+").")),n}}function on(n,l){if(l==="/")return n;if(!n.toLowerCase().startsWith(l.toLowerCase()))return null;let c=l.endsWith("/")?l.length-1:l.length,u=n.charAt(c);return u&&u!=="/"?null:n.slice(c)||"/"}function Jo(n,l){l===void 0&&(l="/");let{pathname:c,search:u="",hash:f=""}=typeof n=="string"?Mr(n):n;return{pathname:c?c.startsWith("/")?c:el(c,l):l,search:rl(u),hash:al(f)}}function el(n,l){let c=l.replace(/\/+$/,"").split("/");return n.split("/").forEach(f=>{f===".."?c.length>1&&c.pop():f!=="."&&c.push(f)}),c.length>1?c.join("/"):"/"}function qa(n,l,c,u){return"Cannot include a '"+n+"' character in a manually specified "+("`to."+l+"` field ["+JSON.stringify(u)+"].  Please separate it out to the ")+("`to."+c+"` field. Alternatively you may provide the full path as ")+'a string in <Link to="..."> and the router will parse it for you.'}function tl(n){return n.filter((l,c)=>c===0||l.route.path&&l.route.path.length>0)}function _i(n,l){let c=tl(n);return l?c.map((u,f)=>f===c.length-1?u.pathname:u.pathnameBase):c.map(u=>u.pathnameBase)}function vi(n,l,c,u){u===void 0&&(u=!1);let f;typeof n=="string"?f=Mr(n):(f=Kr({},n),Xt(!f.pathname||!f.pathname.includes("?"),qa("?","pathname","search",f)),Xt(!f.pathname||!f.pathname.includes("#"),qa("#","pathname","hash",f)),Xt(!f.search||!f.search.includes("#"),qa("#","search","hash",f)));let x=n===""||f.pathname==="",b=x?"/":f.pathname,v;if(b==null)v=c;else{let p=l.length-1;if(!u&&b.startsWith("..")){let M=b.split("/");for(;M[0]==="..";)M.shift(),p-=1;f.pathname=M.join("/")}v=p>=0?l[p]:"/"}let S=Jo(f,v),g=b&&b!=="/"&&b.endsWith("/"),j=(x||b===".")&&c.endsWith("/");return!S.pathname.endsWith("/")&&(g||j)&&(S.pathname+="/"),S}const dr=n=>n.join("/").replace(/\/\/+/g,"/"),sl=n=>n.replace(/\/+$/,"").replace(/^\/*/,"/"),rl=n=>!n||n==="?"?"":n.startsWith("?")?n:"?"+n,al=n=>!n||n==="#"?"":n.startsWith("#")?n:"#"+n;function nl(n){return n!=null&&typeof n.status=="number"&&typeof n.statusText=="string"&&typeof n.internal=="boolean"&&"data"in n}const Ni=["post","put","patch","delete"];new Set(Ni);const il=["get",...Ni];new Set(il);/**
 * React Router v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Jr(){return Jr=Object.assign?Object.assign.bind():function(n){for(var l=1;l<arguments.length;l++){var c=arguments[l];for(var u in c)Object.prototype.hasOwnProperty.call(c,u)&&(n[u]=c[u])}return n},Jr.apply(this,arguments)}const ln=w.createContext(null),ol=w.createContext(null),yr=w.createContext(null),Ia=w.createContext(null),_r=w.createContext({outlet:null,matches:[],isDataRoute:!1}),ji=w.createContext(null);function ll(n,l){let{relative:c}=l===void 0?{}:l;ra()||Xt(!1);let{basename:u,navigator:f}=w.useContext(yr),{hash:x,pathname:b,search:v}=Ei(n,{relative:c}),S=b;return u!=="/"&&(S=b==="/"?u:dr([u,b])),f.createHref({pathname:S,search:v,hash:x})}function ra(){return w.useContext(Ia)!=null}function Ta(){return ra()||Xt(!1),w.useContext(Ia).location}function Ci(n){w.useContext(yr).static||w.useLayoutEffect(n)}function cl(){let{isDataRoute:n}=w.useContext(_r);return n?vl():dl()}function dl(){ra()||Xt(!1);let n=w.useContext(ln),{basename:l,future:c,navigator:u}=w.useContext(yr),{matches:f}=w.useContext(_r),{pathname:x}=Ta(),b=JSON.stringify(_i(f,c.v7_relativeSplatPath)),v=w.useRef(!1);return Ci(()=>{v.current=!0}),w.useCallback(function(g,j){if(j===void 0&&(j={}),!v.current)return;if(typeof g=="number"){u.go(g);return}let p=vi(g,JSON.parse(b),x,j.relative==="path");n==null&&l!=="/"&&(p.pathname=p.pathname==="/"?l:dr([l,p.pathname])),(j.replace?u.replace:u.push)(p,j.state,j)},[l,u,b,x,n])}function Ei(n,l){let{relative:c}=l===void 0?{}:l,{future:u}=w.useContext(yr),{matches:f}=w.useContext(_r),{pathname:x}=Ta(),b=JSON.stringify(_i(f,u.v7_relativeSplatPath));return w.useMemo(()=>vi(n,JSON.parse(b),x,c==="path"),[n,b,x,c])}function ul(n,l){return hl(n,l)}function hl(n,l,c,u){ra()||Xt(!1);let{navigator:f}=w.useContext(yr),{matches:x}=w.useContext(_r),b=x[x.length-1],v=b?b.params:{};b&&b.pathname;let S=b?b.pathnameBase:"/";b&&b.route;let g=Ta(),j;if(l){var p;let C=typeof l=="string"?Mr(l):l;S==="/"||(p=C.pathname)!=null&&p.startsWith(S)||Xt(!1),j=C}else j=g;let M=j.pathname||"/",B=M;if(S!=="/"){let C=S.replace(/^\//,"").split("/");B="/"+M.replace(/^\//,"").split("/").slice(C.length).join("/")}let k=Bo(n,{pathname:B}),R=pl(k&&k.map(C=>Object.assign({},C,{params:Object.assign({},v,C.params),pathname:dr([S,f.encodeLocation?f.encodeLocation(C.pathname).pathname:C.pathname]),pathnameBase:C.pathnameBase==="/"?S:dr([S,f.encodeLocation?f.encodeLocation(C.pathnameBase).pathname:C.pathnameBase])})),x,c,u);return l&&R?w.createElement(Ia.Provider,{value:{location:Jr({pathname:"/",search:"",hash:"",state:null,key:"default"},j),navigationType:lr.Pop}},R):R}function xl(){let n=_l(),l=nl(n)?n.status+" "+n.statusText:n instanceof Error?n.message:JSON.stringify(n),c=n instanceof Error?n.stack:null,f={padding:"0.5rem",backgroundColor:"rgba(200,200,200, 0.5)"};return w.createElement(w.Fragment,null,w.createElement("h2",null,"Unexpected Application Error!"),w.createElement("h3",{style:{fontStyle:"italic"}},l),c?w.createElement("pre",{style:f},c):null,null)}const ml=w.createElement(xl,null);class fl extends w.Component{constructor(l){super(l),this.state={location:l.location,revalidation:l.revalidation,error:l.error}}static getDerivedStateFromError(l){return{error:l}}static getDerivedStateFromProps(l,c){return c.location!==l.location||c.revalidation!=="idle"&&l.revalidation==="idle"?{error:l.error,location:l.location,revalidation:l.revalidation}:{error:l.error!==void 0?l.error:c.error,location:c.location,revalidation:l.revalidation||c.revalidation}}componentDidCatch(l,c){console.error("React Router caught the following error during render",l,c)}render(){return this.state.error!==void 0?w.createElement(_r.Provider,{value:this.props.routeContext},w.createElement(ji.Provider,{value:this.state.error,children:this.props.component})):this.props.children}}function gl(n){let{routeContext:l,match:c,children:u}=n,f=w.useContext(ln);return f&&f.static&&f.staticContext&&(c.route.errorElement||c.route.ErrorBoundary)&&(f.staticContext._deepestRenderedBoundaryId=c.route.id),w.createElement(_r.Provider,{value:l},u)}function pl(n,l,c,u){var f;if(l===void 0&&(l=[]),c===void 0&&(c=null),u===void 0&&(u=null),n==null){var x;if(!c)return null;if(c.errors)n=c.matches;else if((x=u)!=null&&x.v7_partialHydration&&l.length===0&&!c.initialized&&c.matches.length>0)n=c.matches;else return null}let b=n,v=(f=c)==null?void 0:f.errors;if(v!=null){let j=b.findIndex(p=>p.route.id&&(v==null?void 0:v[p.route.id])!==void 0);j>=0||Xt(!1),b=b.slice(0,Math.min(b.length,j+1))}let S=!1,g=-1;if(c&&u&&u.v7_partialHydration)for(let j=0;j<b.length;j++){let p=b[j];if((p.route.HydrateFallback||p.route.hydrateFallbackElement)&&(g=j),p.route.id){let{loaderData:M,errors:B}=c,k=p.route.loader&&M[p.route.id]===void 0&&(!B||B[p.route.id]===void 0);if(p.route.lazy||k){S=!0,g>=0?b=b.slice(0,g+1):b=[b[0]];break}}}return b.reduceRight((j,p,M)=>{let B,k=!1,R=null,C=null;c&&(B=v&&p.route.id?v[p.route.id]:void 0,R=p.route.errorElement||ml,S&&(g<0&&M===0?(k=!0,C=null):g===M&&(k=!0,C=p.route.hydrateFallbackElement||null)));let D=l.concat(b.slice(0,M+1)),E=()=>{let U;return B?U=R:k?U=C:p.route.Component?U=w.createElement(p.route.Component,null):p.route.element?U=p.route.element:U=j,w.createElement(gl,{match:p,routeContext:{outlet:j,matches:D,isDataRoute:c!=null},children:U})};return c&&(p.route.ErrorBoundary||p.route.errorElement||M===0)?w.createElement(fl,{location:c.location,revalidation:c.revalidation,component:R,error:B,children:E(),routeContext:{outlet:null,matches:D,isDataRoute:!0}}):E()},null)}var Si=function(n){return n.UseBlocker="useBlocker",n.UseRevalidator="useRevalidator",n.UseNavigateStable="useNavigate",n}(Si||{}),Na=function(n){return n.UseBlocker="useBlocker",n.UseLoaderData="useLoaderData",n.UseActionData="useActionData",n.UseRouteError="useRouteError",n.UseNavigation="useNavigation",n.UseRouteLoaderData="useRouteLoaderData",n.UseMatches="useMatches",n.UseRevalidator="useRevalidator",n.UseNavigateStable="useNavigate",n.UseRouteId="useRouteId",n}(Na||{});function bl(n){let l=w.useContext(ln);return l||Xt(!1),l}function wl(n){let l=w.useContext(ol);return l||Xt(!1),l}function yl(n){let l=w.useContext(_r);return l||Xt(!1),l}function Ai(n){let l=yl(),c=l.matches[l.matches.length-1];return c.route.id||Xt(!1),c.route.id}function _l(){var n;let l=w.useContext(ji),c=wl(Na.UseRouteError),u=Ai(Na.UseRouteError);return l!==void 0?l:(n=c.errors)==null?void 0:n[u]}function vl(){let{router:n}=bl(Si.UseNavigateStable),l=Ai(Na.UseNavigateStable),c=w.useRef(!1);return Ci(()=>{c.current=!0}),w.useCallback(function(f,x){x===void 0&&(x={}),c.current&&(typeof f=="number"?n.navigate(f):n.navigate(f,Jr({fromRouteId:l},x)))},[n,l])}function Nl(n,l){n==null||n.v7_startTransition,n==null||n.v7_relativeSplatPath}function ga(n){Xt(!1)}function jl(n){let{basename:l="/",children:c=null,location:u,navigationType:f=lr.Pop,navigator:x,static:b=!1,future:v}=n;ra()&&Xt(!1);let S=l.replace(/^\/*/,"/"),g=w.useMemo(()=>({basename:S,navigator:x,static:b,future:Jr({v7_relativeSplatPath:!1},v)}),[S,v,x,b]);typeof u=="string"&&(u=Mr(u));let{pathname:j="/",search:p="",hash:M="",state:B=null,key:k="default"}=u,R=w.useMemo(()=>{let C=on(j,S);return C==null?null:{location:{pathname:C,search:p,hash:M,state:B,key:k},navigationType:f}},[S,j,p,M,B,k,f]);return R==null?null:w.createElement(yr.Provider,{value:g},w.createElement(Ia.Provider,{children:c,value:R}))}function Cl(n){let{children:l,location:c}=n;return ul(Ka(l),c)}new Promise(()=>{});function Ka(n,l){l===void 0&&(l=[]);let c=[];return w.Children.forEach(n,(u,f)=>{if(!w.isValidElement(u))return;let x=[...l,f];if(u.type===w.Fragment){c.push.apply(c,Ka(u.props.children,x));return}u.type!==ga&&Xt(!1),!u.props.index||!u.props.children||Xt(!1);let b={id:u.props.id||x.join("-"),caseSensitive:u.props.caseSensitive,element:u.props.element,Component:u.props.Component,index:u.props.index,path:u.props.path,loader:u.props.loader,action:u.props.action,errorElement:u.props.errorElement,ErrorBoundary:u.props.ErrorBoundary,hasErrorBoundary:u.props.ErrorBoundary!=null||u.props.errorElement!=null,shouldRevalidate:u.props.shouldRevalidate,handle:u.props.handle,lazy:u.props.lazy};u.props.children&&(b.children=Ka(u.props.children,x)),c.push(b)}),c}/**
 * React Router DOM v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Ja(){return Ja=Object.assign?Object.assign.bind():function(n){for(var l=1;l<arguments.length;l++){var c=arguments[l];for(var u in c)Object.prototype.hasOwnProperty.call(c,u)&&(n[u]=c[u])}return n},Ja.apply(this,arguments)}function El(n,l){if(n==null)return{};var c={},u=Object.keys(n),f,x;for(x=0;x<u.length;x++)f=u[x],!(l.indexOf(f)>=0)&&(c[f]=n[f]);return c}function Sl(n){return!!(n.metaKey||n.altKey||n.ctrlKey||n.shiftKey)}function Al(n,l){return n.button===0&&(!l||l==="_self")&&!Sl(n)}const Il=["onClick","relative","reloadDocument","replace","state","target","to","preventScrollReset","viewTransition"],Tl="6";try{window.__reactRouterVersion=Tl}catch{}const Dl="startTransition",zn=ho[Dl];function On(n){let{basename:l,children:c,future:u,window:f}=n,x=w.useRef();x.current==null&&(x.current=Ro({window:f,v5Compat:!0}));let b=x.current,[v,S]=w.useState({action:b.action,location:b.location}),{v7_startTransition:g}=u||{},j=w.useCallback(p=>{g&&zn?zn(()=>S(p)):S(p)},[S,g]);return w.useLayoutEffect(()=>b.listen(j),[b,j]),w.useEffect(()=>Nl(u),[u]),w.createElement(jl,{basename:l,children:c,location:v.location,navigationType:v.action,navigator:b,future:u})}const kl=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u",Ml=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,Ii=w.forwardRef(function(l,c){let{onClick:u,relative:f,reloadDocument:x,replace:b,state:v,target:S,to:g,preventScrollReset:j,viewTransition:p}=l,M=El(l,Il),{basename:B}=w.useContext(yr),k,R=!1;if(typeof g=="string"&&Ml.test(g)&&(k=g,kl))try{let U=new URL(window.location.href),q=g.startsWith("//")?new URL(U.protocol+g):new URL(g),J=on(q.pathname,B);q.origin===U.origin&&J!=null?g=J+q.search+q.hash:R=!0}catch{}let C=ll(g,{relative:f}),D=zl(g,{replace:b,state:v,target:S,preventScrollReset:j,relative:f,viewTransition:p});function E(U){u&&u(U),U.defaultPrevented||D(U)}return w.createElement("a",Ja({},M,{href:k||C,onClick:R||x?u:E,ref:c,target:S}))});var Rn;(function(n){n.UseScrollRestoration="useScrollRestoration",n.UseSubmit="useSubmit",n.UseSubmitFetcher="useSubmitFetcher",n.UseFetcher="useFetcher",n.useViewTransitionState="useViewTransitionState"})(Rn||(Rn={}));var Ln;(function(n){n.UseFetcher="useFetcher",n.UseFetchers="useFetchers",n.UseScrollRestoration="useScrollRestoration"})(Ln||(Ln={}));function zl(n,l){let{target:c,replace:u,state:f,preventScrollReset:x,relative:b,viewTransition:v}=l===void 0?{}:l,S=cl(),g=Ta(),j=Ei(n,{relative:b});return w.useCallback(p=>{if(Al(p,c)){p.preventDefault();let M=u!==void 0?u:va(g)===va(j);S(n,{replace:M,state:f,preventScrollReset:x,relative:b,viewTransition:v})}},[g,S,j,u,f,c,n,x,b,v])}const Ol="https://idewdhvmcyhpgvpmkefd.supabase.co",Rl="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkZXdkaHZtY3locGd2cG1rZWZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU1ODgxNDMsImV4cCI6MjA1MTE2NDE0M30.RAIBKUjHAbx_a5_KUvs-Loc2hNd6SU6etOEczz4-moQ";let Ha=null;function Ll(){return Ha||(Ha=ri(Ol,Rl,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,flowType:"pkce",storageKey:"crew-mobile-auth",storage:window.localStorage}}),console.log("Supabase client initialized")),Ha}const je=Ll();async function Pl(){const{error:n}=await je.auth.signOut();if(n)throw n}async function Bl(){const{data:{user:n}}=await je.auth.getUser();return n}const Ga="crewmanager_auth_user",Wa="crewmanager_auth_timestamp",Fl=24,Ti=w.createContext(void 0),Ul=({children:n})=>{const[l,c]=w.useState(null),[u,f]=w.useState(!0),[x,b]=w.useState(!1);w.useEffect(()=>{v()},[]);const v=async()=>{try{const C=g();if(C){console.log("üîÑ Ripristino sessione salvata per:",C.email),c(C),b(C.isFirstAccess||!1),f(!1);return}await p()}catch(C){console.error("Errore nell'inizializzazione auth:",C),f(!1)}},S=C=>{try{const D={user:C,timestamp:new Date().getTime()};localStorage.setItem(Ga,JSON.stringify(D)),localStorage.setItem(Wa,D.timestamp.toString()),console.log("üíæ Sessione salvata nel localStorage per:",C.email)}catch(D){console.error("Errore nel salvataggio sessione:",D)}},g=()=>{try{const C=localStorage.getItem(Ga),D=localStorage.getItem(Wa);if(!C||!D)return null;const E=parseInt(D);if((new Date().getTime()-E)/(1e3*60*60)>Fl)return console.log("‚è∞ Sessione scaduta, rimuovo dal localStorage"),j(),null;const J=JSON.parse(C);return console.log("üì± Sessione caricata dal localStorage:",J.user.email),J.user}catch(C){return console.error("Errore nel caricamento sessione:",C),j(),null}},j=()=>{try{localStorage.removeItem(Ga),localStorage.removeItem(Wa),console.log("üóëÔ∏è Sessione rimossa dal localStorage")}catch(C){console.error("Errore nella rimozione sessione:",C)}},p=async()=>{try{const C=await Bl();if(C){console.log("üîç Controllo utente corrente:",C.id,C.email);const{data:D,error:E}=await je.from("registration_requests").select("*, parent_company_id, software_codice, tipologia_registrazione").eq("auth_user_id",C.id).maybeSingle();if(!E&&D)if(D.parent_company_id&&!D.is_suspended){console.log("‚úÖ Trovato come crew:",D.full_name||D.company_name);const U=D.primo_accesso||!1;b(U);const q={id:C.id,email:D.email,role:"crew",displayName:D.full_name||D.company_name||D.email,isFirstAccess:U};c(q),S(q),f(!1);return}else console.log("‚ùå Utente non √® un dipendente valido o √® sospeso"),await je.auth.signOut(),c(null);else console.log("‚ùå Crew member non trovato"),c(null)}}catch(C){console.error("Error checking user:",C)}finally{f(!1)}},R={user:l,loading:u,isFirstAccess:x,login:async(C,D,E="company")=>{try{console.log("üîë Tentativo login con Supabase Auth per:",C,"Password length:",D.length);const{data:U,error:q}=await je.auth.signInWithPassword({email:C,password:D});if(q)throw console.error("‚ùå Errore autenticazione Supabase:",q.message,"Code:",q.status),new Error("Email o password non corretti");const J=U.user;if(!J)throw new Error("Dati utente non validi");console.log("‚úÖ Login Supabase riuscito per:",J.email);const{data:N,error:_}=await je.from("registration_requests").select("*, parent_company_id, software_codice, tipologia_registrazione").eq("auth_user_id",J.id).maybeSingle();if(_||!N)throw console.error("‚ùå Utente NON trovato in registration_requests"),await je.auth.signOut(),new Error("Accesso negato. Questa app √® riservata ai dipendenti.");if(!N.parent_company_id)throw console.error("‚ùå L'utente √® un'azienda, non un dipendente"),await je.auth.signOut(),new Error("Accesso negato. Le aziende devono usare l'App Azienda.");if(N.is_suspended)throw console.error("‚ùå Account sospeso"),await je.auth.signOut(),new Error("Account sospeso. Contatta l'amministratore.");console.log("‚úÖ Dipendente verificato:",N.full_name||N.company_name);const L=N.primo_accesso||!1;b(L);const I={id:J.id,email:N.email,role:"crew",displayName:N.full_name||N.company_name||N.email,isFirstAccess:L};c(I),S(I)}catch(U){throw console.error("Login error:",U),U}},logout:async()=>{try{await Pl(),j(),c(null),b(!1)}catch(C){throw console.error("Logout error:",C),j(),c(null),b(!1),C}},updatePassword:async C=>{try{const{error:D}=await je.auth.updateUser({password:C});if(D)throw console.error("Errore aggiornamento password Supabase Auth:",D),D;if(console.log("‚úÖ Password aggiornata in Supabase Auth"),l){const{error:E}=await je.from("registration_requests").update({primo_accesso:!1,password_definitiva:C,temp_password:null,updated_at:new Date().toISOString()}).eq("auth_user_id",l.id);if(E)throw E;console.log("‚úÖ Password sincronizzata in registration_requests"),b(!1);const U={...l,isFirstAccess:!1};c(U),S(U)}return!0}catch(D){return console.error("Password update error:",D),!1}}};return e.jsx(Ti.Provider,{value:R,children:n})},Pt=()=>{const n=w.useContext(Ti);if(n===void 0)throw new Error("useAuth must be used within an AuthProvider");return n},Vl=w.createContext(void 0),ql=({children:n})=>{Pt();const[l,c]=w.useState([{crewId:"crew-1",isPublicProfile:!0,hiddenFromCompanies:["company-2"],hiddenFields:{"company-2":["hourlyRate","phone"],"company-3":["hourlyRate","experience","phone","address"]}},{crewId:"crew-2",isPublicProfile:!0,hiddenFromCompanies:[],hiddenFields:{}},{crewId:"crew-3",isPublicProfile:!1,hiddenFromCompanies:["company-1","company-2"],hiddenFields:{"company-1":["hourlyRate","phone","address","availability"],"company-2":["hourlyRate","experience","phone","address","skills","bio"]}}]),[u,f]=w.useState([{userId:"crew-1",userType:"crew",busyDates:[{date:"2025-03-15",eventId:"event-1",companyId:"company-1",type:"freelance_assignment",title:"Fiera Milano",isVisible:!0},{date:"2025-03-20",type:"personal_busy",title:"Impegno Personale",isVisible:!1}],sharedWith:[]},{userId:"crew-2",userType:"crew",busyDates:[{date:"2025-03-12",eventId:"event-2",companyId:"company-1",type:"company_event",title:"Inventario Magazzino",isVisible:!0}],sharedWith:["company-1"]}]),x=C=>{c(D=>[...D,C])},b=(C,D)=>{c(E=>E.map(U=>U.crewId===C?{...U,...D}:U))},v=(C,D,E=[])=>{c(U=>U.map(q=>{if(q.crewId===C){const J=q.hiddenFromCompanies.includes(D)?q.hiddenFromCompanies:[...q.hiddenFromCompanies,D],N={...q.hiddenFields,[D]:E.length>0?E:["hourlyRate","phone"]};return{...q,hiddenFromCompanies:J,hiddenFields:N}}return q})),R(C,"privacy_update",{action:"hidden_from_company",companyId:D,hiddenFields:E})},S=(C,D)=>{c(E=>E.map(U=>{if(U.crewId===C){const q=U.hiddenFromCompanies.filter(N=>N!==D),J={...U.hiddenFields};return delete J[D],{...U,hiddenFromCompanies:q,hiddenFields:J}}return U})),R(C,"privacy_update",{action:"unhidden_from_company",companyId:D})},g=C=>l.filter(D=>D.isPublicProfile&&!D.hiddenFromCompanies.includes(C)).map(D=>D.crewId),j=(C,D)=>{const E=l.find(U=>U.crewId===C);return E?E.isPublicProfile&&!E.hiddenFromCompanies.includes(D):!0},p=(C,D)=>{const E=l.find(U=>U.crewId===C);return E?E.hiddenFields[D]||[]:[]},M=(C,D,E,U)=>{f(q=>q.map(J=>{if(J.userId===C){const N={date:D,eventId:E,companyId:U,type:"freelance_assignment",title:`Evento ${E}`,isVisible:!0};return{...J,busyDates:[...J.busyDates,N]}}return J})),R(C,"calendar_sync",{eventDate:D,eventId:E,companyId:U,message:"Il tuo calendario √® stato aggiornato con un nuovo evento"})},B=C=>{const D=u.find(E=>E.userId===C);return D?D.busyDates.map(E=>E.date):[]},k=(C,D)=>!B(C).includes(D),R=(C,D,E)=>{console.log("üìß Privacy Notification:",{to:C,type:D,data:E,timestamp:new Date})};return e.jsx(Vl.Provider,{value:{crewPrivacySettings:l,addCrewPrivacy:x,updateCrewPrivacy:b,hideFromCompany:v,unhideFromCompany:S,getVisibleCrewForCompany:g,isCrewVisibleToCompany:j,getHiddenFieldsForCompany:p,calendarSyncs:u,syncCrewCalendar:M,getCrewBusyDates:B,isCrewAvailableOnDate:k,sendPrivacyNotification:R},children:n})},Di=()=>{const[n,l]=w.useState([]),c=w.useCallback(S=>{const g=Math.random().toString(36).substr(2,9),j={...S,id:g,duration:S.duration||5e3};l(p=>[...p,j])},[]),u=w.useCallback(S=>{l(g=>g.filter(j=>j.id!==S))},[]),f=w.useCallback((S,g,j)=>{c({type:"success",title:S,message:g,duration:j})},[c]),x=w.useCallback((S,g,j)=>{c({type:"error",title:S,message:g,duration:j})},[c]),b=w.useCallback((S,g,j)=>{c({type:"warning",title:S,message:g,duration:j})},[c]),v=w.useCallback((S,g,j)=>{c({type:"info",title:S,message:g,duration:j})},[c]);return{toasts:n,addToast:c,removeToast:u,showSuccess:f,showError:x,showWarning:b,showInfo:v}},ki=w.createContext(void 0),Hl=({children:n})=>{const l=Di();return e.jsx(ki.Provider,{value:l,children:n})},us=()=>{const n=w.useContext(ki);if(n===void 0)throw new Error("useToastContext must be used within a ToastProvider");return n},Gl=({toast:n,onRemove:l})=>{w.useEffect(()=>{const x=setTimeout(()=>{l(n.id)},n.duration||5e3);return()=>clearTimeout(x)},[n.id,n.duration,l]);const c=()=>{switch(n.type){case"success":return e.jsx(ft,{className:"h-7 w-7 text-green-500"});case"error":return e.jsx(sn,{className:"h-7 w-7 text-red-500"});case"warning":return e.jsx(Zt,{className:"h-7 w-7 text-yellow-500"});case"info":return e.jsx(pa,{className:"h-7 w-7 text-blue-500"});default:return e.jsx(pa,{className:"h-7 w-7 text-blue-500"})}},u=()=>{switch(n.type){case"success":return"bg-white border-green-300 shadow-green-100";case"error":return"bg-white border-red-300 shadow-red-100";case"warning":return"bg-white border-yellow-300 shadow-yellow-100";case"info":return"bg-white border-blue-300 shadow-blue-100";default:return"bg-white border-blue-300 shadow-blue-100"}},f=()=>{switch(n.type){case"success":return"text-green-700";case"error":return"text-red-700";case"warning":return"text-yellow-700";case"info":return"text-blue-700";default:return"text-blue-700"}};return e.jsx("div",{className:`min-w-96 max-w-lg w-full border-2 rounded-xl shadow-2xl pointer-events-auto ${u()} mx-auto transform transition-all duration-300 ease-out`,children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0",children:c()}),e.jsxs("div",{className:"ml-4 w-0 flex-1",children:[e.jsx("p",{className:`text-lg font-semibold ${f()} leading-tight`,children:n.title}),n.message&&e.jsx("p",{className:`mt-3 text-base ${f()} opacity-90 leading-relaxed`,children:n.message})]}),e.jsx("div",{className:"ml-4 flex-shrink-0 flex",children:e.jsxs("button",{className:`rounded-full inline-flex ${f()} hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 p-2 transition-all duration-200 hover:bg-white hover:bg-opacity-20`,onClick:()=>l(n.id),children:[e.jsx("span",{className:"sr-only",children:"Chiudi"}),e.jsx(jt,{className:"h-5 w-5"})]})})]})})})},Wl=({toasts:n,onRemoveToast:l})=>e.jsx("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 space-y-4 pointer-events-none",children:n.map(c=>e.jsx("div",{className:"transform transition-all duration-300 ease-in-out pointer-events-auto",children:e.jsx(Gl,{toast:c,onRemove:l})},c.id))}),Yl=({currentVersion:n,latestVersion:l,releaseNotes:c,isUpdating:u,onUpdate:f,onDismiss:x})=>e.jsx("div",{className:"fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center p-4",children:e.jsx("div",{className:"bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg",children:e.jsx(rn,{className:"h-8 w-8 text-white"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"Aggiornamento Disponibile"}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Versione Attuale:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:n||"Sconosciuta"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Nuova Versione:"}),e.jsx("span",{className:"text-sm font-bold text-blue-600",children:l})]})]}),c?e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4 mb-6 text-left",children:[e.jsx("h4",{className:"text-sm font-semibold text-blue-900 mb-2",children:"Novit√†:"}),e.jsx("p",{className:"text-blue-800 text-sm leading-relaxed whitespace-pre-line",children:c})]}):e.jsx("p",{className:"text-gray-600 text-sm mb-6 leading-relaxed",children:"√à disponibile una nuova versione dell'app con miglioramenti e correzioni. L'aggiornamento richiede solo pochi secondi."}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:f,disabled:u,className:"w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center space-x-2",children:u?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{children:"Aggiornamento in corso..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(hr,{className:"h-5 w-5"}),e.jsx("span",{children:"Aggiorna Ora"})]})}),!u&&e.jsx("button",{onClick:x,className:"w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-4 rounded-xl transition-colors duration-200",children:"Pi√π Tardi"})]}),u&&e.jsx("div",{className:"mt-4 bg-blue-50 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ft,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-sm text-blue-800",children:"Pulizia cache e download nuova versione..."})]})})]})})}),$l=()=>{const[n,l]=w.useState({currentVersion:null,latestVersion:null,releaseNotes:null,hasUpdate:!1,isLoading:!1,isUpdating:!1,error:null}),[c,u]=w.useState(0),f=5*60*1e3,x=w.useCallback(()=>{const M=new URLSearchParams(window.location.search).get("_v");return M?(localStorage.setItem("crew_app_version",M),M):localStorage.getItem("crew_app_version")},[]),b=w.useCallback(()=>new URLSearchParams(window.location.search).get("_updated")==="true",[]),v=w.useCallback(async()=>{try{console.log("üîç Controllo versione da database per software_code: crew_mobile");const{data:p,error:M}=await je.from("software_versions").select("*").eq("software_code","crew_mobile").eq("is_active",!0).order("release_date",{ascending:!1}).limit(1).maybeSingle();return M?(console.error("‚ùå Errore caricamento versione da database:",M),await S()):p?(console.log("‚úÖ Versione caricata da database:",p.current_version),{version:p.current_version,buildTimestamp:p.release_date,features:Array.isArray(p.features)?p.features:[],releaseNotes:p.release_notes||"",description:p.description||""}):(console.warn("‚ö†Ô∏è Nessuna versione attiva trovata nel database per crew_mobile"),await S())}catch(p){return console.error("‚ùå Errore generale nel controllo versione database:",p),await S()}},[]),S=w.useCallback(async()=>{try{console.log("üìÑ Fallback: caricamento versione da file statico");const p=Date.now(),M=await fetch(`/version.json?_t=${p}`,{method:"GET",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}});if(!M.ok)throw new Error(`HTTP ${M.status}: ${M.statusText}`);const B=await M.json();return console.log("‚úÖ Versione caricata da file statico:",B.version),B}catch(p){return console.error("‚ùå Errore nel fetch versione da file:",p),null}},[]),g=w.useCallback(async(p=!1)=>{const M=Date.now();if(!p&&M-c<f||n.isLoading||n.isUpdating)return!1;l(B=>({...B,isLoading:!0,error:null})),u(M);try{const B=x(),k=await v();if(!k)return l(C=>({...C,isLoading:!1,error:"Impossibile verificare aggiornamenti"})),!1;const R=B!==k.version;return l(C=>({...C,currentVersion:B,latestVersion:k.version,releaseNotes:k.releaseNotes||null,hasUpdate:R,isLoading:!1,error:null})),console.log("üîç Controllo versione:",{current:B,latest:k.version,hasUpdate:R,buildTime:k.buildTimestamp}),R}catch(B){return console.error("Errore nel controllo versioni:",B),l(k=>({...k,isLoading:!1,error:"Errore controllo versioni"})),!1}},[x,v,c,n.isLoading,n.isUpdating,f]),j=w.useCallback(async()=>{if(!(n.isUpdating||!n.hasUpdate)){l(p=>({...p,isUpdating:!0}));try{if(console.log("üîÑ Applicazione aggiornamento..."),"caches"in window){const B=await caches.keys();await Promise.all(B.map(k=>caches.delete(k))),console.log("üóëÔ∏è Cache cancellate:",B.length)}n.latestVersion&&(localStorage.setItem("crew_app_version",n.latestVersion),localStorage.setItem("crew_app_last_update",new Date().toISOString()));const p=Date.now(),M=new URL(window.location.href);M.searchParams.set("_v",n.latestVersion||""),M.searchParams.set("_t",p.toString()),M.searchParams.set("_updated","true"),console.log("üöÄ Reindirizzamento a:",M.toString()),window.location.href=M.toString()}catch(p){console.error("Errore nell'applicazione aggiornamento:",p),l(M=>({...M,isUpdating:!1,error:"Errore durante aggiornamento"}))}}},[n.isUpdating,n.hasUpdate,n.latestVersion]);return w.useEffect(()=>{(async()=>{let B=x();if(B)l(k=>({...k,currentVersion:B}));else{const k=await v();k&&(B=k.version,localStorage.setItem("crew_app_version",B),l(R=>({...R,currentVersion:B,latestVersion:B,hasUpdate:!1})))}})(),b()||(async()=>(await new Promise(k=>setTimeout(k,2e3)),await g(!1)))();const M=()=>{g(!1)};return window.addEventListener("focus",M),()=>{window.removeEventListener("focus",M)}},[g,x,b,v]),{...n,checkForUpdates:p=>g(p||!1),applyUpdate:j}},Xl=({onEnter:n})=>{const[l,c]=w.useState(!1),[u,f]=w.useState(0),[x,b]=w.useState(!1),[v,S]=w.useState("1.8.4"),[g,j]=w.useState("Dicembre 2025"),p=R=>{const C=new Date(R),E=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][C.getMonth()],U=C.getFullYear();return`${E} ${U}`};w.useEffect(()=>{(async()=>{try{const{data:q,error:J}=await je.from("software_versions").select("current_version, release_date").eq("software_code","crew_mobile").eq("is_active",!0).order("release_date",{ascending:!1}).limit(1).maybeSingle();q&&!J&&(S(q.current_version),j(p(q.release_date)))}catch(q){console.error("Errore caricamento versione:",q)}})(),c(!0);const C=setInterval(()=>{f(q=>(q+1)%3)},4e3),D=()=>{window.deferredPrompt&&(console.log("üì± Install prompt disponibile"),b(!0))};D();const E=setInterval(D,1e3);setTimeout(()=>{clearInterval(E)},1e4);const U=()=>{b(!0)};return window.addEventListener("beforeinstallprompt",U),()=>{clearInterval(C),clearInterval(E),window.removeEventListener("beforeinstallprompt",U)}},[]);const M=async()=>{const R=window.deferredPrompt;if(!R){console.log("‚ùå Prompt installazione non disponibile"),B();return}console.log("üì± Avvio installazione PWA"),R.prompt();const{outcome:C}=await R.userChoice;C==="accepted"?(console.log("PWA installata con successo"),b(!1)):console.log("Installazione rifiutata dall'utente"),window.deferredPrompt=null},B=()=>{const R=/iPad|iPhone|iPod/.test(navigator.userAgent),C=/Android/.test(navigator.userAgent);let D="";R?D=`
        <strong>üì± Su iPhone/iPad:</strong><br>
        1. Tocca il pulsante "Condividi" (‚¨ÜÔ∏è)<br>
        2. Scorri e tocca "Aggiungi alla schermata Home"<br>
        3. Conferma il nome dell'app<br>
        4. L'icona apparir√† sulla home screen
      `:C?D=`
        <strong>üì± Su Android:</strong><br>
        1. Tocca i 3 puntini (‚ãÆ) in alto a destra<br>
        2. Seleziona "Aggiungi alla schermata Home"<br>
        3. Conferma il nome dell'app<br>
        4. L'icona apparir√† sulla home screen
      `:D=`
        <strong>üíª Su Desktop:</strong><br>
        1. Cerca l'icona "Installa" nella barra degli indirizzi<br>
        2. Clicca su "Installa"<br>
        3. L'app si aprir√† in una finestra dedicata
      `;const E=document.createElement("div");E.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    `,E.innerHTML=`
      <div style="background: white; border-radius: 16px; padding: 24px; max-width: 400px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 16px;">üì±</div>
        <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 16px; color: #1f2937;">Come Installare CrewApp</h3>
        <div style="color: #6b7280; margin-bottom: 20px; font-size: 14px; text-align: left; line-height: 1.6;">
          ${D}
        </div>
        <button id="close-manual" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%;">
          Ho Capito
        </button>
      </div>
    `,document.body.appendChild(E);const U=E.querySelector("#close-manual");U==null||U.addEventListener("click",()=>{E.remove()}),E.addEventListener("click",q=>{q.target===E&&E.remove()})},k=[{icon:ct,title:"Timesheet Digitale",description:"Registra le tue ore di lavoro con precisione GPS e approvazione automatica",color:"from-blue-500 to-cyan-500"},{icon:ut,title:"Calendario Aziendale",description:"Visualizza eventi, turni magazzino e gestisci le tue disponibilit√†",color:"from-purple-500 to-pink-500"},{icon:Ht,title:"Documenti Digitali",description:"Accedi a buste paga, contratti e certificazioni in formato digitale",color:"from-green-500 to-emerald-500"}];return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-600 via-blue-700 to-blue-800 relative overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("div",{className:"absolute top-2 left-2 sm:top-4 sm:left-4 md:top-10 md:left-10 w-16 h-16 sm:w-24 sm:h-24 md:w-48 md:h-48 bg-white rounded-full opacity-5 animate-pulse"}),e.jsx("div",{className:"absolute bottom-2 right-2 sm:bottom-4 sm:right-4 md:bottom-10 md:right-10 w-12 h-12 sm:w-16 sm:h-16 md:w-32 md:h-32 bg-cyan-300 rounded-full opacity-10 animate-bounce",style:{animationDuration:"3s"}}),e.jsx("div",{className:"absolute top-1/3 left-1/4 w-8 h-8 sm:w-12 sm:h-12 md:w-24 md:h-24 bg-blue-300 rounded-full opacity-15 animate-ping",style:{animationDuration:"4s"}})]}),e.jsxs("div",{className:"relative z-10 flex-1 flex flex-col min-h-screen",children:[e.jsx("header",{className:"p-3 sm:p-4 md:p-6 lg:p-8 flex-shrink-0",children:e.jsxs("div",{className:`text-center transform transition-all duration-1000 ${l?"translate-y-0 opacity-100":"-translate-y-10 opacity-0"}`,children:[e.jsx("h1",{className:"text-lg sm:text-xl md:text-2xl lg:text-3xl xl:text-4xl font-bold text-white mb-1 sm:mb-2",children:"ControlStage"}),e.jsx("p",{className:"text-blue-100 text-xs sm:text-sm md:text-base lg:text-lg",children:"Professional Event Management Solutions"})]})}),e.jsx("main",{className:"flex-1 flex items-center justify-center px-3 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 md:py-8",children:e.jsxs("div",{className:"max-w-xs sm:max-w-md md:max-w-2xl lg:max-w-4xl xl:max-w-6xl mx-auto text-center w-full",children:[e.jsx("div",{className:`transform transition-all duration-1000 delay-300 ${l?"translate-y-0 opacity-100 scale-100":"translate-y-10 opacity-0 scale-95"}`,children:e.jsxs("div",{className:"bg-white bg-opacity-95 backdrop-blur-sm rounded-lg sm:rounded-xl md:rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 lg:p-10 mb-4 sm:mb-6 md:mb-8",children:[e.jsx("div",{className:"flex justify-center mb-3 sm:mb-4 md:mb-6 lg:mb-8",children:e.jsx("div",{className:"w-12 h-12 sm:w-16 sm:h-16 md:w-20 md:h-20 lg:w-24 lg:h-24 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg sm:rounded-xl md:rounded-2xl flex items-center justify-center shadow-lg",children:e.jsx(ls,{className:"h-6 w-6 sm:h-8 sm:w-8 md:h-10 md:w-10 lg:h-12 lg:w-12 text-white"})})}),e.jsxs("h2",{className:"text-lg sm:text-xl md:text-2xl lg:text-3xl xl:text-4xl font-bold mb-2 sm:mb-3 md:mb-4",children:[e.jsx("span",{className:"text-gray-800",children:"CREW MOBILE "}),e.jsx("span",{className:"text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-600 italic font-extrabold tracking-wider transform -skew-x-12 inline-block text-lg sm:text-xl md:text-2xl lg:text-3xl xl:text-4xl",children:"APP"})]}),e.jsxs("p",{className:"text-gray-600 text-xs sm:text-sm md:text-base lg:text-lg leading-relaxed mb-3 sm:mb-4 md:mb-6 lg:mb-8 max-w-xs sm:max-w-md md:max-w-2xl lg:max-w-4xl mx-auto px-2 sm:px-4",children:["Piattaforma digitale per il personale operativo.",e.jsx("br",{}),"Gestisci autonomamente orari, eventi, ferie, note spese e check-in/out."]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-center space-y-1 sm:space-y-0 sm:space-x-3 md:space-x-4 mb-3 sm:mb-4 md:mb-6 lg:mb-8",children:[e.jsxs("span",{className:"bg-blue-600 text-white px-3 sm:px-4 md:px-5 py-1 sm:py-2 rounded-full font-semibold text-xs sm:text-sm md:text-base",children:["Versione ",v]}),e.jsx("span",{className:"text-gray-500 text-xs sm:text-sm md:text-base",children:g})]}),e.jsxs("button",{onClick:n,className:"group bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-2 sm:py-3 md:py-4 px-4 sm:px-6 md:px-8 lg:px-10 rounded-lg sm:rounded-xl md:rounded-2xl text-sm sm:text-base md:text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-2xl flex items-center justify-center space-x-2 mx-auto w-full sm:w-auto",children:[e.jsx("span",{children:"Accedi al Portale Staff"}),e.jsx(mo,{className:"h-4 w-4 sm:h-5 sm:w-5 md:h-6 md:w-6 group-hover:translate-x-1 transition-transform"})]}),x&&e.jsxs("button",{onClick:M,className:"group bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-2 sm:py-3 md:py-4 px-4 sm:px-6 md:px-8 lg:px-10 rounded-lg sm:rounded-xl md:rounded-2xl text-sm sm:text-base md:text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-2xl flex items-center justify-center space-x-2 mx-auto mt-3 sm:mt-4 w-full sm:w-auto",children:[e.jsx(hr,{className:"h-4 w-4 sm:h-5 sm:w-5 md:h-6 md:w-6"}),e.jsx("span",{children:"üì± Installa App sul Telefono"})]})]})}),e.jsxs("div",{className:`transform transition-all duration-1000 delay-500 ${l?"translate-y-0 opacity-100":"translate-y-10 opacity-0"}`,children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 sm:gap-4 md:gap-6 lg:gap-8",children:k.map((R,C)=>{const D=R.icon,E=C===u;return e.jsx("div",{className:`transform transition-all duration-700 w-full ${E?"scale-102 sm:scale-105 md:scale-110 -translate-y-1 sm:-translate-y-2 md:-translate-y-3":"scale-100 translate-y-0 opacity-90"}`,children:e.jsxs("div",{className:"bg-white bg-opacity-90 backdrop-blur-sm rounded-lg sm:rounded-xl md:rounded-2xl p-3 sm:p-4 md:p-6 lg:p-8 shadow-xl hover:shadow-2xl transition-all duration-300 h-full",children:[e.jsx("div",{className:`w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 lg:w-16 lg:h-16 bg-gradient-to-r ${R.color} rounded-md sm:rounded-lg md:rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 md:mb-4 lg:mb-6 shadow-lg`,children:e.jsx(D,{className:"h-4 w-4 sm:h-5 sm:w-5 md:h-6 md:w-6 lg:h-8 lg:w-8 text-white"})}),e.jsx("h3",{className:"text-sm sm:text-base md:text-lg lg:text-xl font-bold text-gray-800 mb-1 sm:mb-2 md:mb-3",children:R.title}),e.jsx("p",{className:"text-xs sm:text-sm md:text-base text-gray-600 leading-relaxed",children:R.description})]})},C)})}),e.jsx("div",{className:"flex justify-center space-x-2 mt-4 sm:mt-6 md:mt-8",children:k.map((R,C)=>e.jsx("button",{onClick:()=>f(C),className:`w-2 h-2 sm:w-3 sm:h-3 md:w-4 md:h-4 rounded-full transition-all duration-300 ${C===u?"bg-white scale-110 sm:scale-125 md:scale-150 shadow-lg":"bg-white bg-opacity-50 hover:bg-opacity-75"}`},C))})]})]})}),e.jsx("footer",{className:"p-3 sm:p-4 md:p-6 lg:p-8 flex-shrink-0 mt-auto",children:e.jsxs("div",{className:`text-center transform transition-all duration-1000 delay-700 ${l?"translate-y-0 opacity-100":"translate-y-5 opacity-0"}`,children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-center space-y-1 sm:space-y-0 sm:space-x-3 md:space-x-4 lg:space-x-6 text-blue-100 text-xs sm:text-sm mb-2 sm:mb-3 md:mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"}),e.jsx("span",{children:"Sistema Operativo"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(fo,{className:"h-3 w-3 sm:h-4 sm:w-4"}),e.jsx("span",{children:"Sicuro e Protetto"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ft,{className:"h-3 w-3 sm:h-4 sm:w-4"}),e.jsx("span",{children:"Sempre Aggiornato"})]})]}),e.jsxs("p",{className:"text-blue-200 text-xs sm:text-sm px-2 sm:px-4 md:px-6",children:["¬© 2025 ControlStage - Crew App Mobile V. ",v," - ",g,". Tutti i diritti riservati."]})]})})]}),e.jsx("style",{children:`
        @keyframes float {
          0%, 100% { transform: translateY(0px); }
          50% { transform: translateY(-20px); }
        }

        .animate-float {
          animation: float 6s ease-in-out infinite;
        }

        @media (max-width: 640px) {
          .animate-blob {
            animation-duration: 10s;
          }
        }

        @media (min-width: 1024px) {
          .animate-float {
            animation-duration: 8s;
          }
        }
      `})]})},Zl=()=>{const{login:n}=Pt(),[l,c]=w.useState(""),[u,f]=w.useState(""),[x,b]=w.useState("company"),[v,S]=w.useState(!1),[g,j]=w.useState(!1),[p,M]=w.useState(""),B=async k=>{k.preventDefault(),j(!0),M("");try{await n(l,u,"crew")}catch(R){console.error("Login error:",R),M(R instanceof Error?R.message:"Errore durante il login")}finally{j(!1)}};return e.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"max-w-md w-full space-y-8",children:[e.jsxs("div",{children:[e.jsx(ai,{className:"mx-auto h-12 w-12 text-blue-600"}),e.jsx("h2",{className:"mt-6 text-3xl font-extrabold text-gray-900 text-center",children:"Accedi a CREW MOBILE APP"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600 text-center",children:"App Mobile per Dipendenti"})]}),e.jsxs("form",{className:"mt-8 space-y-6",onSubmit:B,children:[p&&e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center",children:[e.jsx(Zt,{className:"h-5 w-5 mr-2"}),e.jsx("p",{children:p})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700",children:"Email"}),e.jsx("input",{id:"email",name:"email",type:"email",autoComplete:"email",required:!0,value:l,onChange:k=>c(k.target.value),className:"mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm",placeholder:"Inserisci la tua email"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700",children:"Password"}),e.jsxs("div",{className:"mt-1 relative",children:[e.jsx("input",{id:"password",name:"password",type:v?"text":"password",autoComplete:"current-password",required:!0,value:u,onChange:k=>f(k.target.value),className:"appearance-none relative block w-full px-3 py-2 pr-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm",placeholder:x==="crew"?"Password temporanea o definitiva":"Password aziendale"}),e.jsx("button",{type:"button",onClick:()=>S(!v),className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:v?e.jsx(ni,{className:"h-5 w-5 text-gray-400"}):e.jsx(an,{className:"h-5 w-5 text-gray-400"})})]})]})]}),e.jsx("div",{children:e.jsx("button",{type:"submit",disabled:g,className:"group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:g?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Accesso in corso..."]}):"üì± Accedi all'App Mobile"})}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-sm text-gray-600",children:["Non hai un account?"," ",e.jsx("span",{className:"font-medium text-gray-400 cursor-not-allowed",children:"Registrati qui (Non disponibile)"})]})})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[e.jsx(Ii,{to:"/azienda",className:"group relative w-full flex justify-center py-3 px-4 border-2 border-green-600 text-sm font-medium rounded-md text-green-600 bg-white hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors",children:e.jsxs("span",{className:"flex items-center",children:[e.jsx("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})}),"Accesso Azienda"]})}),e.jsx("p",{className:"mt-2 text-xs text-center text-gray-500",children:"Area riservata alle aziende per gestione turni e dipendenti"})]}),e.jsx("div",{className:"text-center pt-4 border-t border-gray-200",children:e.jsx("p",{className:"text-xs text-gray-500",children:"¬© 2025 ControlStage. Tutti i diritti riservati. Software V.1.0.9"})})]})})};let ma;const Ql=new Uint8Array(16);function Kl(){if(!ma&&(ma=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ma))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ma(Ql)}const os=[];for(let n=0;n<256;++n)os.push((n+256).toString(16).slice(1));function Jl(n,l=0){return os[n[l+0]]+os[n[l+1]]+os[n[l+2]]+os[n[l+3]]+"-"+os[n[l+4]]+os[n[l+5]]+"-"+os[n[l+6]]+os[n[l+7]]+"-"+os[n[l+8]]+os[n[l+9]]+"-"+os[n[l+10]]+os[n[l+11]]+os[n[l+12]]+os[n[l+13]]+os[n[l+14]]+os[n[l+15]]}const ec=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Pn={randomUUID:ec};function Bn(n,l,c){if(Pn.randomUUID&&!l&&!n)return Pn.randomUUID();n=n||{};const u=n.random||(n.rng||Kl)();return u[6]=u[6]&15|64,u[8]=u[8]&63|128,Jl(u)}const tc=()=>{const[n,l]=w.useState("azienda"),[c,u]=w.useState(1),[f,x]=w.useState(!1),[b,v]=w.useState(!1),[S,g]=w.useState(null),[j,p]=w.useState({nome_azienda:"",email:"",telefono:"",partita_iva:"",indirizzo:"",persona_contatto:"",email_contatto:"",telefono_contatto:"",sito_web:"",piano:"base",messaggio:""}),[M,B]=w.useState({nome:"",cognome:"",email:"",telefono:"",indirizzo:"",tipo_profilo:"freelance",anni_esperienza:0,tariffa_oraria:"",competenze:[],biografia:"",messaggio:""}),k=["Audio","Luci","Video","Regia","Streaming","Montaggio","Allestimenti","Logistica","Coordinamento","Sicurezza","Elettricista","Carpentiere","Grafica","Fotografia"],R=N=>{const{name:_,value:L}=N.target;p(I=>({...I,[_]:L}))},C=N=>{const{name:_,value:L}=N.target;B(I=>({...I,[_]:L}))},D=N=>{B(_=>{const L=[..._.competenze];return L.includes(N)?{..._,competenze:L.filter(I=>I!==N)}:{..._,competenze:[...L,N]}})},E=()=>{if(n==="azienda"){if(!j.nome_azienda||!j.email||!j.partita_iva)return g("Compila tutti i campi obbligatori (Nome azienda, Email, Partita IVA)"),!1}else if(!M.nome||!M.cognome||!M.email)return g("Compila tutti i campi obbligatori (Nome, Cognome, Email)"),!1;return g(null),!0},U=()=>{E()&&u(2)},q=()=>{u(1)},J=async N=>{N.preventDefault(),x(!0),g(null);try{if(n==="azienda"){const{error:_}=await je.from("registration_requests").insert({id:Bn(),company_name:j.nome_azienda,email:j.email,phone:j.telefono,plan_type:j.piano,message:j.messaggio,status:"pending"});if(_)throw _}else{const{error:_}=await je.from("registration_requests").insert({id:Bn(),company_name:`${M.nome} ${M.cognome}`,email:M.email,phone:M.telefono,plan_type:"base",message:M.messaggio,status:"pending"});if(_)throw _}v(!0)}catch(_){console.error("Error during registration:",_),g("Si √® verificato un errore durante la registrazione. Riprova pi√π tardi.")}finally{x(!1)}};return b?e.jsx("div",{className:"bg-white p-8 rounded-lg shadow-md max-w-md mx-auto",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(ft,{className:"h-8 w-8 text-green-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Registrazione Inviata!"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"La tua richiesta di registrazione √® stata inviata con successo. Un amministratore la esaminer√† a breve. Riceverai un'email quando la tua richiesta sar√† stata approvata."}),e.jsx("button",{onClick:()=>window.location.href="/",className:"w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700",children:"Torna alla Home"})]})}):e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Registrazione"}),e.jsx("p",{className:"text-gray-600",children:"Crea un nuovo account per accedere alla piattaforma"})]}),S&&e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 flex items-center",children:[e.jsx(Zt,{className:"h-5 w-5 mr-2"}),e.jsx("p",{children:S})]}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("button",{type:"button",onClick:()=>l("azienda"),className:`flex-1 py-3 px-4 rounded-lg flex items-center justify-center space-x-2 ${n==="azienda"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(zt,{className:"h-5 w-5"}),e.jsx("span",{children:"Azienda"})]}),e.jsxs("button",{type:"button",onClick:()=>l("tecnico"),className:`flex-1 py-3 px-4 rounded-lg flex items-center justify-center space-x-2 ${n==="tecnico"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(ea,{className:"h-5 w-5"}),e.jsx("span",{children:"Tecnico"})]})]})}),e.jsxs("form",{onSubmit:J,children:[c===1&&e.jsxs("div",{className:"space-y-6",children:[n==="azienda"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"nome_azienda",className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome Azienda *"}),e.jsx("input",{id:"nome_azienda",name:"nome_azienda",type:"text",value:j.nome_azienda,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email *"}),e.jsx("input",{id:"email",name:"email",type:"email",value:j.email,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"telefono",className:"block text-sm font-medium text-gray-700 mb-1",children:"Telefono"}),e.jsx("input",{id:"telefono",name:"telefono",type:"tel",value:j.telefono,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"partita_iva",className:"block text-sm font-medium text-gray-700 mb-1",children:"Partita IVA *"}),e.jsx("input",{id:"partita_iva",name:"partita_iva",type:"text",value:j.partita_iva,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"indirizzo",className:"block text-sm font-medium text-gray-700 mb-1",children:"Indirizzo"}),e.jsx("input",{id:"indirizzo",name:"indirizzo",type:"text",value:j.indirizzo,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"nome",className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome *"}),e.jsx("input",{id:"nome",name:"nome",type:"text",value:M.nome,onChange:C,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"cognome",className:"block text-sm font-medium text-gray-700 mb-1",children:"Cognome *"}),e.jsx("input",{id:"cognome",name:"cognome",type:"text",value:M.cognome,onChange:C,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email *"}),e.jsx("input",{id:"email",name:"email",type:"email",value:M.email,onChange:C,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"telefono",className:"block text-sm font-medium text-gray-700 mb-1",children:"Telefono"}),e.jsx("input",{id:"telefono",name:"telefono",type:"tel",value:M.telefono,onChange:C,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"indirizzo",className:"block text-sm font-medium text-gray-700 mb-1",children:"Indirizzo"}),e.jsx("input",{id:"indirizzo",name:"indirizzo",type:"text",value:M.indirizzo,onChange:C,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tipo_profilo",className:"block text-sm font-medium text-gray-700 mb-1",children:"Tipo Profilo *"}),e.jsxs("select",{id:"tipo_profilo",name:"tipo_profilo",value:M.tipo_profilo,onChange:C,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"freelance",children:"Freelance"}),e.jsx("option",{value:"dipendente",children:"Dipendente"})]})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"button",onClick:U,className:"bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700",children:"Avanti"})})]}),c===2&&e.jsxs("div",{className:"space-y-6",children:[n==="azienda"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"persona_contatto",className:"block text-sm font-medium text-gray-700 mb-1",children:"Persona di Contatto"}),e.jsx("input",{id:"persona_contatto",name:"persona_contatto",type:"text",value:j.persona_contatto,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email_contatto",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email di Contatto"}),e.jsx("input",{id:"email_contatto",name:"email_contatto",type:"email",value:j.email_contatto,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"telefono_contatto",className:"block text-sm font-medium text-gray-700 mb-1",children:"Telefono di Contatto"}),e.jsx("input",{id:"telefono_contatto",name:"telefono_contatto",type:"tel",value:j.telefono_contatto,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"sito_web",className:"block text-sm font-medium text-gray-700 mb-1",children:"Sito Web"}),e.jsx("input",{id:"sito_web",name:"sito_web",type:"url",value:j.sito_web,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"https://www.example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"piano",className:"block text-sm font-medium text-gray-700 mb-1",children:"Piano"}),e.jsxs("select",{id:"piano",name:"piano",value:j.piano,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"base",children:"Base"}),e.jsx("option",{value:"professional",children:"Professional"}),e.jsx("option",{value:"enterprise",children:"Enterprise"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"messaggio",className:"block text-sm font-medium text-gray-700 mb-1",children:"Messaggio (opzionale)"}),e.jsx("textarea",{id:"messaggio",name:"messaggio",value:j.messaggio,onChange:R,rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"Informazioni aggiuntive o richieste particolari..."})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"anni_esperienza",className:"block text-sm font-medium text-gray-700 mb-1",children:"Anni di Esperienza"}),e.jsx("input",{id:"anni_esperienza",name:"anni_esperienza",type:"number",min:"0",value:M.anni_esperienza,onChange:C,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tariffa_oraria",className:"block text-sm font-medium text-gray-700 mb-1",children:"Tariffa Oraria (‚Ç¨)"}),e.jsx("input",{id:"tariffa_oraria",name:"tariffa_oraria",type:"number",min:"0",step:"0.01",value:M.tariffa_oraria,onChange:C,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Competenze"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:k.map(N=>e.jsx("button",{type:"button",onClick:()=>D(N),className:`px-3 py-1 rounded-full text-sm ${M.competenze.includes(N)?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:N},N))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"biografia",className:"block text-sm font-medium text-gray-700 mb-1",children:"Biografia"}),e.jsx("textarea",{id:"biografia",name:"biografia",value:M.biografia,onChange:C,rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"Breve descrizione della tua esperienza e specializzazioni..."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"messaggio",className:"block text-sm font-medium text-gray-700 mb-1",children:"Messaggio (opzionale)"}),e.jsx("textarea",{id:"messaggio",name:"messaggio",value:M.messaggio,onChange:C,rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"Informazioni aggiuntive o richieste particolari..."})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("button",{type:"button",onClick:q,className:"bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400",children:"Indietro"}),e.jsx("button",{type:"submit",disabled:f,className:"bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:bg-blue-400",children:f?"Invio in corso...":"Invia Richiesta"})]})]})]}),e.jsxs("div",{className:"mt-8 pt-6 border-t border-gray-200 text-center",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Hai gi√† un account?"," ",e.jsx("a",{href:"/",className:"text-blue-600 hover:text-blue-800",children:"Accedi"})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"¬© 2025 ControlStage - Crew App Mobile V. 1.0.1"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Tutti i diritti riservati - Software realizzato da ControlStage"})]})]})]})},sc=({isOpen:n,onClose:l})=>{const{updatePassword:c}=Pt(),{showSuccess:u,showError:f}=us(),[x,b]=w.useState(""),[v,S]=w.useState(""),[g,j]=w.useState(!1),[p,M]=w.useState(!1),[B,k]=w.useState(""),R=async C=>{if(C.preventDefault(),k(""),x.length<6){k("La password deve essere di almeno 6 caratteri");return}if(x!==v){k("Le password non coincidono");return}M(!0),await c(x)?(u("Password Aggiornata","La tua password √® stata modificata con successo!"),l()):(f("Errore","Si √® verificato un errore durante l'aggiornamento della password"),k("Errore nell'aggiornamento della password")),M(!1)};return n?e.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50",children:e.jsx("div",{className:"relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white",children:e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center space-x-2",children:[e.jsx(ii,{className:"h-5 w-5"}),e.jsx("span",{children:"Cambia Password"})]}),e.jsx("button",{onClick:l,className:"text-gray-400 hover:text-gray-600",children:e.jsx(jt,{className:"h-6 w-6"})})]}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4",children:e.jsxs("p",{className:"text-sm text-yellow-800",children:[e.jsx("strong",{children:"Primo accesso rilevato!"}),e.jsx("br",{}),"Per motivi di sicurezza, devi cambiare la password temporanea."]})}),e.jsxs("form",{onSubmit:R,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nuova Password"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:g?"text":"password",value:x,onChange:C=>b(C.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 pr-10",placeholder:"Inserisci la nuova password",required:!0,minLength:6}),e.jsx("button",{type:"button",onClick:()=>j(!g),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500",children:g?e.jsx(ni,{className:"h-4 w-4"}):e.jsx(an,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Conferma Password"}),e.jsx("input",{type:g?"text":"password",value:v,onChange:C=>S(C.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"Conferma la nuova password",required:!0,minLength:6})]}),B&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg text-sm",children:B}),e.jsx("div",{className:"flex justify-end space-x-2 mt-6",children:e.jsxs("button",{type:"submit",disabled:p,className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center space-x-2",children:[p?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsx(Zr,{className:"h-4 w-4"}),e.jsx("span",{children:p?"Salvando...":"Salva Password"})]})})]})]})})}):null},Da=()=>{const[n,l]=w.useState(navigator.onLine),[c,u]=w.useState([]),[f,x]=w.useState(!1);w.useEffect(()=>{const M=()=>{l(!0),g()},B=()=>{l(!1)};return window.addEventListener("online",M),window.addEventListener("offline",B),b(),()=>{window.removeEventListener("online",M),window.removeEventListener("offline",B)}},[]);const b=()=>{try{const M=localStorage.getItem("crew_app_offline_data");if(M){const B=JSON.parse(M);u(B)}}catch(M){console.error("Errore nel caricamento dati offline:",M)}},v=M=>{try{localStorage.setItem("crew_app_offline_data",JSON.stringify(M)),u(M)}catch(B){console.error("Errore nel salvataggio dati offline:",B)}},S=w.useCallback((M,B)=>{const k={id:Date.now().toString(),type:M,data:B,timestamp:new Date().toISOString()},R=[...c,k];v(R),n&&g()},[c,n]),g=async()=>{if(c.length===0||f)return;x(!0);const M=[];try{for(const k of c)try{await j(k),M.push(k.id)}catch(R){console.error(`Errore sync item ${k.id}:`,R)}const B=c.filter(k=>!M.includes(k.id));v(B),M.length>0&&console.log(`‚úÖ Sincronizzati ${M.length} elementi offline`)}catch(B){console.error("Errore nella sincronizzazione:",B)}finally{x(!1)}},j=async M=>{switch(M.type){case"checkin":await je.from("warehouse_checkins").insert(M.data);break;case"checkout":await je.from("warehouse_checkins").update(M.data.updates).eq("id",M.data.id);break;case"expense":await je.from("expenses").insert(M.data);break;case"timesheet":M.data.id?await je.from("timesheet_entries").update(M.data.updates).eq("id",M.data.id):await je.from("timesheet_entries").insert(M.data);break}},p=()=>{localStorage.removeItem("crew_app_offline_data"),u([])};return{isOnline:n,pendingSync:c.length,isSyncing:f,addOfflineData:S,syncPendingData:g,clearPendingData:p}},rc=({currentVersion:n,hasUpdate:l,isLoading:c,isUpdating:u,onCheckUpdate:f})=>{const x=()=>u?e.jsx(Ds,{className:"h-4 w-4 animate-spin text-blue-500"}):c?e.jsx(Ds,{className:"h-4 w-4 animate-spin text-gray-500"}):l?e.jsx(hr,{className:"h-4 w-4 text-orange-500"}):e.jsx(ft,{className:"h-4 w-4 text-green-500"}),b=()=>u?"Aggiornamento...":c?"Controllo...":l?"Aggiornamento disponibile":"Aggiornato",v=()=>u?"text-blue-600":c?"text-gray-500":l?"text-orange-600":"text-green-600",S=`Versione ${n||"Sconosciuta"} - ${b()}`;return e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:f,disabled:c||u,className:`sm:hidden inline-flex items-center space-x-1 px-2 py-1 rounded-md transition-colors text-xs
          ${l?"bg-orange-100 hover:bg-orange-200 text-orange-800":"bg-gray-100 hover:bg-gray-200 text-gray-700"}
          disabled:opacity-50 disabled:cursor-not-allowed`,title:S,"aria-label":S,type:"button",children:[x(),e.jsxs("span",{className:"font-medium text-[11px]",children:["v",n||"?"]})]}),e.jsxs("button",{onClick:f,disabled:c||u,className:`hidden sm:flex items-center space-x-1.5 px-2 py-1 rounded-md transition-colors ${l?"bg-orange-100 hover:bg-orange-200 text-orange-800":"bg-gray-100 hover:bg-gray-200 text-gray-700"} disabled:opacity-50 disabled:cursor-not-allowed`,title:S,type:"button",children:[e.jsx("div",{className:"scale-75",children:x()}),e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"text-[10px] font-medium leading-tight",children:["v",n||"?"]}),e.jsx("div",{className:`text-[9px] leading-tight ${v()}`,children:b()})]})]})]})};function Mi({openTalkId:n,onClose:l}){const{user:c}=Pt(),{showToast:u}=Di(),[f,x]=w.useState([]),[b,v]=w.useState(!0),[S,g]=w.useState(null),[j,p]=w.useState(!1),M=w.useRef(null);w.useEffect(()=>{c&&(k(),R())},[c,j]),w.useEffect(()=>{if(n&&f.length>0){const I=f.find(K=>K.id===n);I&&N(I)}},[n,f]);const B=async I=>{if(!I)return null;try{const O=new URL(I).pathname.match(/\/storage\/v1\/object\/public\/company-talks\/(.+)$/);if(!O||!O[1])return console.error("Impossibile estrarre il percorso dal file URL:",I),I;const W=O[1],{data:se,error:G}=await je.storage.from("company-talks").createSignedUrl(W,3600);return G?(console.error("Errore creazione signed URL:",G),I):se.signedUrl}catch(K){return console.error("Errore nel parsing dell'URL:",K),I}},k=async()=>{try{v(!0);let I=je.from("company_talks").select(`
          *,
          regaziendasoftware!sender_company_id (
            ragione_sociale
          )
        `).eq("recipient_id",c==null?void 0:c.id).order("created_at",{ascending:!1});j&&(I=I.eq("is_read",!1));const{data:K,error:O}=await I;if(O)throw O;const W=await Promise.all((K||[]).map(async se=>{var $;const G=await B(se.file_url);return{...se,company_name:(($=se.regaziendasoftware)==null?void 0:$.ragione_sociale)||"Azienda",file_url:G}}));x(W)}catch(I){console.error("Errore caricamento messaggi:",I),u("Errore nel caricamento dei messaggi","error")}finally{v(!1)}},R=()=>{const I=je.channel("company_talks_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"company_talks",filter:`recipient_id=eq.${c==null?void 0:c.id}`},K=>{k(),u("Nuovo messaggio ricevuto!","success")}).subscribe();return()=>{je.removeChannel(I)}},C=async I=>{try{const{error:K}=await je.rpc("mark_talk_as_read",{talk_id:I});if(K)throw K;x(O=>O.map(W=>W.id===I?{...W,is_read:!0,read_at:new Date().toISOString()}:W))}catch(K){console.error("Errore aggiornamento messaggio:",K)}},D=async I=>{if(confirm("Eliminare questo messaggio?"))try{const{error:K}=await je.from("company_talks").delete().eq("id",I).eq("recipient_id",c==null?void 0:c.id);if(K)throw K;x(O=>O.filter(W=>W.id!==I)),g(null),u("Messaggio eliminato","success")}catch(K){console.error("Errore eliminazione messaggio:",K),u("Errore durante l'eliminazione","error")}},E=async(I,K)=>{try{const{data:O,error:W}=await je.storage.from("company-talks").download(I.split("/").pop()||"");if(W)throw W;const se=URL.createObjectURL(O),G=document.createElement("a");G.href=se,G.download=K,document.body.appendChild(G),G.click(),document.body.removeChild(G),URL.revokeObjectURL(se),u("File scaricato","success")}catch(O){console.error("Errore download file:",O),u("Errore durante il download","error")}},U=I=>{switch(I){case"text":return e.jsx(Ks,{className:"w-5 h-5"});case"audio":return e.jsx(Ir,{className:"w-5 h-5"});case"image":return e.jsx($r,{className:"w-5 h-5"});case"file":return e.jsx(Ht,{className:"w-5 h-5"});default:return e.jsx(Ks,{className:"w-5 h-5"})}},q=I=>I?I<1024?`${I} B`:I<1048576?`${(I/1024).toFixed(1)} KB`:`${(I/1048576).toFixed(1)} MB`:"",J=I=>{const K=new Date(I),O=new Date,W=O.getTime()-K.getTime(),se=Math.floor(W/6e4),G=Math.floor(W/36e5),$=Math.floor(W/864e5);return se<1?"Ora":se<60?`${se}m fa`:G<24?`${G}h fa`:$<7?`${$}g fa`:K.toLocaleDateString("it-IT",{day:"numeric",month:"short",year:K.getFullYear()!==O.getFullYear()?"numeric":void 0})},N=I=>{g(I),I.is_read||C(I.id)},_=I=>{switch(I.message_type){case"text":return e.jsx("p",{className:"text-sm text-gray-300 line-clamp-2",children:I.message_text});case"audio":return e.jsxs("p",{className:"text-sm text-gray-400 flex items-center gap-2",children:[e.jsx(Ir,{className:"w-4 h-4"}),"Messaggio vocale"]});case"image":return e.jsxs("p",{className:"text-sm text-gray-400 flex items-center gap-2",children:[e.jsx($r,{className:"w-4 h-4"}),"Immagine"]});case"file":return e.jsxs("p",{className:"text-sm text-gray-400 flex items-center gap-2",children:[e.jsx(Ht,{className:"w-4 h-4"}),I.file_name]});default:return null}},L=I=>{switch(I.message_type){case"text":return e.jsx("div",{className:"prose prose-sm max-w-none",children:e.jsx("p",{className:"text-gray-200 whitespace-pre-wrap",children:I.message_text})});case"audio":return e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(go,{className:"w-6 h-6 text-blue-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-white",children:"Messaggio vocale"}),I.file_size&&e.jsx("p",{className:"text-sm text-gray-400",children:q(I.file_size)})]})]}),I.file_url&&e.jsx("audio",{ref:M,controls:!0,preload:"metadata",className:"w-full",src:I.file_url})]});case"image":return e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[I.file_url&&e.jsx("img",{src:I.file_url,alt:I.file_name||"Immagine",className:"w-full rounded-lg"}),I.file_name&&e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:I.file_name})]});case"file":return e.jsx("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ht,{className:"w-8 h-8 text-gray-300"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-white",children:I.file_name}),I.file_size&&e.jsx("p",{className:"text-sm text-gray-400",children:q(I.file_size)})]})]}),I.file_url&&e.jsx("button",{onClick:()=>E(I.file_url,I.file_name),className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(hr,{className:"w-5 h-5 text-blue-400"})})]})});default:return null}};return b?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"min-h-screen bg-gray-900 flex flex-col",children:[e.jsxs("div",{className:"bg-gray-800 border-b border-gray-700 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Messaggi Azienda"}),l&&e.jsx("button",{onClick:l,className:"p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(jt,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:()=>p(!j),className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${j?"bg-blue-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"}`,children:j?"Tutti":"Non letti"})})]}),f.filter(I=>!I.is_read).length>0&&e.jsx("div",{className:"bg-blue-900/30 border border-blue-700 rounded-lg p-3",children:e.jsxs("p",{className:"text-sm text-blue-200",children:[f.filter(I=>!I.is_read).length," messaggi non letti"]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:f.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx(Ks,{className:"w-16 h-16 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Nessun messaggio"}),e.jsx("p",{className:"text-sm",children:"I messaggi dall'azienda appariranno qui"})]}):e.jsx("div",{className:"divide-y divide-gray-700",children:f.map(I=>e.jsx("div",{onClick:()=>N(I),className:`p-4 cursor-pointer transition-colors ${I.is_read?"hover:bg-gray-800":"bg-blue-900/20 hover:bg-blue-900/30"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${I.is_urgent?"bg-red-900/30 text-red-400":"bg-gray-700 text-gray-300"}`,children:U(I.message_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1",children:[e.jsx("p",{className:"font-semibold text-white",children:I.company_name||I.sender_name}),I.is_urgent&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-red-400 font-medium",children:[e.jsx(wt,{className:"w-3 h-3"}),"Urgente"]})]}),_(I),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx("p",{className:"text-xs text-gray-400",children:J(I.created_at)}),I.is_read&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-green-400",children:[e.jsx(ft,{className:"w-3 h-3"}),"Letto"]})]})]})]})},I.id))})}),S&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-gray-700",children:[e.jsxs("div",{className:"sticky top-0 bg-gray-800 border-b border-gray-700 p-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:S.company_name||S.sender_name}),e.jsx("p",{className:"text-sm text-gray-400",children:J(S.created_at)})]}),e.jsx("button",{onClick:()=>g(null),className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(jt,{className:"w-5 h-5 text-gray-300"})})]}),e.jsxs("div",{className:"p-4",children:[S.is_urgent&&e.jsxs("div",{className:"bg-red-900/30 border border-red-700 rounded-lg p-3 mb-4 flex items-center gap-2",children:[e.jsx(wt,{className:"w-5 h-5 text-red-400"}),e.jsx("p",{className:"text-sm text-red-300 font-medium",children:"Messaggio urgente"})]}),L(S),S.expires_at&&e.jsx("div",{className:"mt-4 p-3 bg-amber-900/30 border border-amber-700 rounded-lg",children:e.jsxs("p",{className:"text-sm text-amber-300",children:["Questo messaggio verr√† eliminato automaticamente il"," ",new Date(S.expires_at).toLocaleDateString("it-IT")]})})]}),e.jsxs("div",{className:"sticky bottom-0 bg-gray-800 border-t border-gray-700 p-4 flex gap-2",children:[e.jsxs("button",{onClick:()=>D(S.id),className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center gap-2",children:[e.jsx(Js,{className:"w-4 h-4"}),"Elimina"]}),e.jsx("button",{onClick:()=>g(null),className:"flex-1 px-4 py-2 bg-gray-700 text-gray-200 rounded-lg hover:bg-gray-600 transition-colors",children:"Chiudi"})]})]})})]})}const ac=({userId:n,onClose:l,onOpenCompanyTalk:c})=>{var L,I,K,O,W,se,G,$;const[u,f]=Tt.useState([]),[x,b]=Tt.useState(!0),[v,S]=Tt.useState([]),[g,j]=Tt.useState(!0),[p,M]=Tt.useState([]),[B,k]=Tt.useState(!0),{showSuccess:R,showError:C}=us(),[D,E]=Tt.useState(null),[U,q]=Tt.useState(!1);Tt.useEffect(()=>{n&&(async()=>{b(!0);try{const{data:re,error:_e}=await je.from("notifiche").select("*").eq("id_utente",n).neq("stato","eliminata").order("created_at",{ascending:!1}).limit(10);!_e&&re?f(re):_e&&console.error("Errore caricamento notifiche:",_e)}catch(re){console.error("Eccezione loadNotifications:",re)}finally{b(!1)}})()},[n]),Tt.useEffect(()=>{n&&(async()=>{k(!0);try{const{data:re,error:_e}=await je.from("company_talks").select(`
            *,
            regaziendasoftware!sender_company_id (
              ragione_sociale
            )
          `).eq("recipient_id",n).eq("is_read",!1).order("created_at",{ascending:!1}).limit(10);if(!_e&&re){const ge=re.map(X=>{var pe;return{...X,company_name:((pe=X.regaziendasoftware)==null?void 0:pe.ragione_sociale)||"Azienda"}});M(ge)}else _e&&console.error("Errore caricamento messaggi azienda:",_e)}catch(re){console.error("Eccezione loadCompanyTalks:",re)}finally{k(!1)}})()},[n]);const J=Tt.useCallback(async()=>{j(!0);try{const{data:F,error:re}=await je.from("crew_assegnazionecorsi").select(`
          *,
          corso:corso_id(
            id,
            titolo,
            titolo_corso,
            descrizione,
            note,
            luogo,
            ora_inizio,
            ora_fine,
            istruttore,
            istruttore_nome,
            categoria,
            obbligatorio
          )
        `).eq("persona_id",n).eq("stato_invito","invitato").order("data_invito",{ascending:!1});if(!re&&F&&F.length>0){const Q=F.map(V=>{const de=V.corso||{},ae=V.titolo_corso||V.corso_titolo||de.titolo||de.titolo_corso||de.nome||`Corso ${V.corso_id||V.id||""}`;return{...V,course:de,courseTitle:ae}});S(Q),j(!1);return}const{data:_e,error:ge}=await je.from("crew_assegnazionecorsi").select("*").eq("persona_id",n).eq("stato_invito","invitato").order("data_invito",{ascending:!1});if(ge){console.error("Errore fetch assignments fallback:",ge),S([]),j(!1);return}if(!_e||_e.length===0){S([]),j(!1);return}const X=Array.from(new Set(_e.map(Q=>Q.corso_id).filter(Boolean)));let pe={};if(X.length>0){const{data:Q,error:V}=await je.from("corsi").select("id, titolo, titolo_corso, descrizione, note, luogo, ora_inizio, ora_fine, istruttore, istruttore_nome, categoria, obbligatorio").in("id",X);V?(console.error("Errore fetch corsi fallback:",V),pe={}):pe=(Q||[]).reduce((de,ae)=>(de[ae.id]=ae,de),{})}const me=_e.map(Q=>{const V=Q.corso||(Q.corso_id?pe[Q.corso_id]:null)||{},de=Q.titolo_corso||Q.corso_titolo||V.titolo||V.titolo_corso||V.nome||`Corso ${Q.corso_id||Q.id||""}`;return{...Q,course:V,courseTitle:de}});S(me)}catch(F){console.error("Eccezione loadPendingCourses (robust):",F),S([])}finally{j(!1)}},[n]);Tt.useEffect(()=>{if(!n){S([]),j(!1);return}J();const F=je.channel(`course-notifs-${n}`).on("postgres_changes",{event:"*",schema:"public",table:"crew_assegnazionecorsi",filter:`persona_id=eq.${n}`},()=>{J()}).subscribe();return()=>{je.removeChannel(F)}},[n,J]);const N=F=>{if(!F)return"";try{return new Date(F).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}catch{return F}},_=F=>{if(!F)return"";try{return new Date(F).toLocaleDateString("it-IT")}catch{return F}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-40 sm:hidden",onClick:l}),e.jsxs("div",{className:"fixed top-20 left-2 right-2 sm:absolute sm:top-full sm:right-0 sm:left-auto sm:mt-2 sm:w-96 bg-gray-800 rounded-lg shadow-2xl border border-gray-700 z-50",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Notifiche"}),e.jsx("button",{onClick:l,className:"text-gray-400 hover:text-white p-1",children:e.jsx(jt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"max-h-[60vh] overflow-y-auto",children:[B?e.jsx("div",{className:"p-8 text-center text-gray-400",children:"Caricamento messaggi..."}):p&&p.length>0?e.jsxs("div",{className:"divide-y divide-gray-700",children:[e.jsxs("div",{className:"px-4 py-2 bg-cyan-900/20 border-b border-gray-700 flex items-center justify-between",children:[e.jsxs("h4",{className:"text-sm font-medium text-cyan-300",children:["Messaggi Azienda (",p.length,")"]}),e.jsx("button",{onClick:F=>{F.stopPropagation(),l(),setTimeout(()=>{setShowCompanyTalk(!0),setSelectedTalkId(null)},100)},className:"text-xs text-cyan-400 hover:text-cyan-300 font-medium underline",children:"Vedi tutti"})]}),p.map(F=>e.jsx("div",{className:"p-4 hover:bg-gray-750 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-semibold text-white",children:F.company_name||F.sender_name}),F.is_urgent&&e.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-red-600 text-white rounded",children:"Urgente"})]}),F.message_type==="text"&&F.message_text&&e.jsx("p",{className:"text-sm text-gray-300 line-clamp-2 mt-1",children:F.message_text}),F.message_type==="audio"&&e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"üé§ Messaggio vocale"}),F.message_type==="image"&&e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"üñºÔ∏è Immagine"}),F.message_type==="file"&&e.jsxs("p",{className:"text-sm text-gray-400 mt-1",children:["üìÑ ",F.file_name||"File allegato"]}),e.jsxs("div",{className:"flex items-center space-x-2 mt-2 text-xs text-gray-400",children:[e.jsx(ct,{className:"h-3 w-3"}),e.jsx("span",{children:new Date(F.created_at).toLocaleString("it-IT")})]})]}),e.jsx("div",{className:"ml-2 flex flex-col items-end space-y-2",children:e.jsx("button",{onClick:re=>{re.stopPropagation(),l(),setTimeout(()=>{c(F.id)},100)},className:"bg-cyan-600 text-white px-3 py-1 rounded text-xs hover:bg-cyan-700",children:"Leggi"})})]})},F.id))]}):null,g?e.jsx("div",{className:"p-8 text-center text-gray-400",children:"Caricamento corsi..."}):v&&v.length>0?e.jsxs("div",{className:"divide-y divide-gray-700",children:[e.jsx("div",{className:"px-4 py-2 bg-yellow-900/20 border-b border-gray-700",children:e.jsxs("h4",{className:"text-sm font-medium text-yellow-300",children:["Corsi da confermare (",v.length,")"]})}),v.map(F=>{const re=F.course||{},_e=F.courseTitle||re.titolo||re.titolo_corso||"Corso",ge=F.data_partecipazione||F.data_invito||re.data||"",X=F.ora_inizio||re.ora_inizio||"",pe=F.luogo||re.luogo||"";return e.jsx("div",{className:"p-4 hover:bg-gray-750 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-white",children:_e}),ge&&e.jsx("p",{className:"text-sm text-gray-300 mt-1",children:_(ge)}),X&&e.jsxs("div",{className:"flex items-center space-x-2 mt-2 text-xs text-gray-400",children:[e.jsx(ct,{className:"h-3 w-3"}),e.jsx("span",{children:X})]}),pe&&e.jsxs("div",{className:"flex items-center space-x-2 mt-1 text-xs text-gray-400",children:[e.jsx(Ut,{className:"h-3 w-3"}),e.jsx("span",{children:pe})]})]}),e.jsx("div",{className:"ml-2 flex flex-col items-end space-y-2",children:e.jsx("button",{onClick:()=>E(F),className:"bg-cyan-600 text-white px-3 py-1 rounded text-xs hover:bg-cyan-700",children:"Dettaglio"})})]})},F.id)})]}):null,!B&&p.length===0&&e.jsx("div",{className:"px-4 py-3 bg-cyan-900/20 border-b border-gray-700",children:e.jsxs("button",{onClick:F=>{F.stopPropagation(),l(),setTimeout(()=>{c(null)},100)},className:"w-full text-sm text-cyan-400 hover:text-cyan-300 font-medium flex items-center justify-center gap-2",children:[e.jsx(Ks,{className:"w-4 h-4"}),"Vedi Messaggi Azienda"]})}),(u.length>0||v&&v.length>0||p&&p.length>0)&&e.jsx("div",{className:"px-4 py-2 border-b border-gray-700",children:e.jsx("h4",{className:"text-xs font-medium text-gray-400 uppercase",children:"Altre notifiche"})}),x?e.jsx("div",{className:"p-8 text-center text-gray-400",children:"Caricamento..."}):u.length===0?v&&v.length>0||p&&p.length>0?null:e.jsx("div",{className:"p-8 text-center text-gray-400",children:"Nessuna notifica"}):e.jsx("div",{className:"divide-y divide-gray-700",children:u.map(F=>{const re=X=>{const pe=new Date(X),Q=new Date().getTime()-pe.getTime(),V=Math.floor(Q/6e4),de=Math.floor(V/60),ae=Math.floor(de/24);return V<1?"Ora":V<60?`${V} min fa`:de<24?`${de}h fa`:ae<7?`${ae}g fa`:pe.toLocaleDateString("it-IT")},_e=async X=>{try{await je.rpc("mark_notification_read",{p_notifica_id:X,p_user_id:n}),f(pe=>pe.map(me=>me.id===X?{...me,stato:"letta"}:me))}catch(pe){console.error("Errore markAsRead:",pe),C&&C("Errore durante l'operazione")}},ge=async X=>{try{await je.rpc("delete_notification",{p_notifica_id:X,p_user_id:n}),f(pe=>pe.filter(me=>me.id!==X))}catch(pe){console.error("Errore deleteNotification:",pe),C&&C("Errore durante l'eliminazione")}};return e.jsxs("div",{className:`p-4 hover:bg-gray-750 transition-colors ${F.stato==="non_letta"?"bg-gray-750":""}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:`font-semibold ${F.stato==="non_letta"?"text-cyan-400":"text-white"}`,children:F.titolo}),e.jsx("p",{className:"text-sm text-gray-300 mt-1",children:F.messaggio}),e.jsxs("div",{className:"flex items-center space-x-2 mt-2 text-xs text-gray-400",children:[e.jsx(ct,{className:"h-3 w-3"}),e.jsx("span",{children:re(F.created_at)})]})]}),e.jsx("button",{onClick:()=>ge(F.id),className:"text-gray-500 hover:text-red-400 ml-2",children:e.jsx(jt,{className:"h-4 w-4"})})]}),F.stato==="non_letta"&&e.jsx("button",{onClick:()=>_e(F.id),className:"mt-2 text-xs text-cyan-400 hover:text-cyan-300",children:"Segna come letta"})]},F.id)})})]}),D&&e.jsx("div",{className:"fixed inset-0 z-[10000] flex items-center justify-center bg-black/50 p-4",children:e.jsxs("div",{className:"w-full max-w-2xl bg-gray-900 rounded-lg shadow-lg border border-gray-700 overflow-auto max-h-[90vh]",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400",children:N(D.data_partecipazione||D.data_invito)}),e.jsx("h3",{className:"text-lg font-semibold text-white",children:D.courseTitle||((L=D.course)==null?void 0:L.titolo)||"Corso"})]}),e.jsx("button",{onClick:()=>E(null),className:"text-gray-400 hover:text-white p-1",children:e.jsx(jt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"p-4 space-y-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 text-xs",children:"Titolo"}),e.jsx("div",{className:"text-white font-medium",children:D.courseTitle||((I=D.course)==null?void 0:I.titolo)||"‚Äî"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 text-xs",children:"Descrizione"}),e.jsx("div",{className:"text-gray-300",children:((K=D.course)==null?void 0:K.descrizione)||D.note||"‚Äî"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 text-xs",children:"Inizio"}),e.jsx("div",{className:"text-white",children:D.ora_inizio||((O=D.course)==null?void 0:O.ora_inizio)||"‚Äî"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 text-xs",children:"Fine"}),e.jsx("div",{className:"text-white",children:D.ora_fine||((W=D.course)==null?void 0:W.ora_fine)||"‚Äî"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 text-xs",children:"Luogo"}),e.jsx("div",{className:"text-white",children:D.luogo||((se=D.course)==null?void 0:se.luogo)||"‚Äî"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 text-xs",children:"Istruttore"}),e.jsx("div",{className:"text-white",children:((G=D.course)==null?void 0:G.istruttore_nome)||(($=D.course)==null?void 0:$.istruttore)||"‚Äî"})]})]})]}),e.jsx("div",{className:"flex items-center justify-end gap-2 p-4 border-t border-gray-700",children:D.stato_invito==="confermato"?e.jsx("button",{disabled:!0,className:"bg-green-700 text-white px-3 py-1 rounded text-sm opacity-80",children:"Partecipazione confermata"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:async()=>{q(!0);try{const{error:F}=await je.from("crew_assegnazionecorsi").update({stato_invito:"confermato",data_conferma:new Date().toISOString()}).eq("id",D.id);if(F){console.error("Errore conferma dal modal:",F),C&&C("Errore durante la conferma: "+(F.message||"Riprova")),q(!1);return}R&&R("Partecipazione confermata"),E(null),await J()}catch(F){console.error("Eccezione conferma dal modal:",F),C&&C((F==null?void 0:F.message)||"Errore durante la conferma")}finally{q(!1)}},disabled:U,className:"bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 disabled:opacity-60",children:U?"Confermo...":"Conferma partecipazione"}),e.jsx("button",{onClick:async()=>{q(!0);try{const{error:F}=await je.from("crew_assegnazionecorsi").update({stato_invito:"rifiutato"}).eq("id",D.id);if(F){console.error("Errore annulla dal modal:",F),C&&C("Errore durante l'annullamento: "+(F.message||"Riprova")),q(!1);return}R&&R("Partecipazione annullata"),E(null),await J()}catch(F){console.error("Eccezione annulla dal modal:",F),C&&C((F==null?void 0:F.message)||"Errore durante l'operazione")}finally{q(!1)}},disabled:U,className:"bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 disabled:opacity-60",children:"Annulla Partecipazione"})]})})]})})]})]})},nc=({currentVersion:n,hasUpdate:l,isVersionLoading:c,isUpdating:u,onCheckUpdate:f})=>{const{user:x,logout:b}=Pt(),{isOnline:v,pendingSync:S,isSyncing:g,syncPendingData:j}=Da(),{showSuccess:p,showError:M,showWarning:B}=us(),[k,R]=Tt.useState(navigator.onLine),[C,D]=Tt.useState(null),[E,U]=Tt.useState(!1),[q,J]=Tt.useState(0),[N,_]=Tt.useState(!1),[L,I]=Tt.useState(!1),[K,O]=Tt.useState(null);Tt.useEffect(()=>{const se=()=>R(!0),G=()=>R(!1);window.addEventListener("online",se),window.addEventListener("offline",G);const $=()=>{window.deferredPrompt&&U(!0)};$();const F=setInterval($,2e3),re=()=>{U(!0)};return window.addEventListener("beforeinstallprompt",re),"getBattery"in navigator&&navigator.getBattery().then(_e=>{D(Math.round(_e.level*100)),_e.addEventListener("levelchange",()=>{D(Math.round(_e.level*100))})}),()=>{window.removeEventListener("online",se),window.removeEventListener("offline",G),window.removeEventListener("beforeinstallprompt",re),clearInterval(F)}},[]),Tt.useEffect(()=>{if(!(x!=null&&x.id))return;const se=async()=>{const{count:F,error:re}=await je.from("notifiche").select("*",{count:"exact",head:!0}).eq("id_utente",x.id).eq("stato","non_letta"),{count:_e,error:ge}=await je.from("company_talks").select("*",{count:"exact",head:!0}).eq("recipient_id",x.id).eq("is_read",!1),X=(F||0)+(_e||0);!re&&!ge&&J(X)};se();const G=je.channel(`notifiche-count-${x.id}`).on("postgres_changes",{event:"*",schema:"public",table:"notifiche",filter:`id_utente=eq.${x.id}`},()=>{se()}).subscribe(),$=je.channel(`talks-count-${x.id}`).on("postgres_changes",{event:"*",schema:"public",table:"company_talks",filter:`recipient_id=eq.${x.id}`},()=>{se()}).subscribe();return()=>{je.removeChannel(G),je.removeChannel($)}},[x==null?void 0:x.id]);const W=async()=>{const se=window.deferredPrompt;if(!se){console.log("üì± Prompt installazione non disponibile");return}console.log("üì± Avvio installazione..."),se.prompt();const{outcome:G}=await se.userChoice;G==="accepted"&&(console.log("PWA installata con successo"),U(!1)),window.deferredPrompt=null};return e.jsxs("header",{className:"bg-gray-800 border-b border-gray-700 p-4 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center shadow-lg",children:e.jsx(rn,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-lg font-bold text-white",children:["CREW MOBILE ",e.jsx("span",{className:"text-cyan-400 italic font-extrabold tracking-wider transform -skew-x-12 inline-block text-base",children:"APP"})]}),e.jsx("p",{className:"text-xs text-gray-300",children:(x==null?void 0:x.displayName)||(x==null?void 0:x.email)})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(rc,{currentVersion:n,hasUpdate:l,isLoading:c,isUpdating:u,onCheckUpdate:f}),S>0&&e.jsxs("button",{onClick:j,disabled:!v||g,className:`flex items-center space-x-1 px-2 py-1 rounded-lg text-xs ${g?"bg-blue-600 text-white":v?"bg-orange-600 text-white hover:bg-orange-700":"bg-gray-600 text-gray-300"}`,children:[g?e.jsx(Ds,{className:"h-3 w-3 animate-spin"}):e.jsx(oi,{className:"h-3 w-3"}),e.jsx("span",{children:S})]}),E&&e.jsx("button",{onClick:W,className:"bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 flex items-center space-x-1",title:"Installa App",children:e.jsx(hr,{className:"h-4 w-4"})}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>_(!N),className:"relative p-3 text-gray-400 hover:text-cyan-400 hover:bg-gray-700 rounded-lg transition-colors active:scale-95 touch-manipulation",title:"Notifiche",type:"button",children:[e.jsx(li,{className:"h-6 w-6"}),q>0&&e.jsx("span",{className:"absolute top-1 right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center animate-pulse",children:q>9?"9+":q})]}),N&&e.jsx(ac,{userId:(x==null?void 0:x.id)||"",onClose:()=>_(!1),onOpenCompanyTalk:se=>{O(se),I(!0)}})]}),e.jsx("button",{onClick:async se=>{se.preventDefault(),se.stopPropagation();try{B("Logout in corso..."),await b(),p("Logout effettuato con successo!"),window.location.href="/"}catch(G){console.error("Errore durante il logout:",G),p("Sessione terminata localmente"),setTimeout(()=>{window.location.href="/"},1e3)}},className:"p-3 text-gray-400 hover:text-red-400 hover:bg-gray-700 rounded-lg transition-colors active:scale-95 touch-manipulation",title:"Logout",type:"button",children:e.jsx(Ea,{className:"h-6 w-6"})})]})]}),!v&&e.jsx("div",{className:"mt-2 bg-red-600 text-white text-center py-2 rounded-lg",children:e.jsx("div",{className:"flex items-center justify-center space-x-2",children:e.jsxs("span",{className:"text-sm font-medium",children:["Modalit√† Offline - Dati salvati localmente",S>0&&` (${S} in attesa)`]})})}),L&&e.jsx("div",{className:"fixed inset-0 z-[9999] bg-gray-900",children:e.jsx(Mi,{openTalkId:K,onClose:()=>{I(!1),O(null)}})})]})},ic=({activeTab:n,onTabChange:l})=>{const c=[{id:"dashboard",label:"Home",icon:ci,description:"Dashboard principale"},{id:"calendar",label:"Calendario",icon:ut,description:"I miei eventi"},{id:"checkin",label:"Check-in",icon:ba,description:"QR Code e GPS"},{id:"expenses",label:"Richieste",icon:Ht,description:"Richieste e Rimborsi"},{id:"talk",label:"Messaggi",icon:Ks,description:"Messaggi azienda"},{id:"report",label:"Report",icon:ct,description:"Report mensile"},{id:"profile",label:"Profilo",icon:ea,description:"Il mio profilo"}];return e.jsx("nav",{className:"fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 z-50 shadow-lg pb-safe",children:e.jsxs("div",{className:"relative max-w-screen-lg mx-auto",children:[e.jsx("div",{className:"flex items-center gap-2 px-2 py-2 overflow-x-auto scrollbar-hide snap-x snap-mandatory",style:{scrollbarWidth:"none",msOverflowStyle:"none",WebkitOverflowScrolling:"touch"},children:c.map(u=>{const f=u.icon,x=n===u.id;return e.jsxs("button",{onClick:()=>l(u.id),className:`flex flex-col items-center space-y-0.5 px-4 py-1.5 rounded-lg transition-all duration-200 flex-shrink-0 w-[85px] snap-center ${x?"bg-blue-600 text-white shadow-lg transform scale-105":"text-gray-400 hover:text-white hover:bg-gray-700"}`,title:u.description,children:[e.jsx(f,{className:`h-5 w-5 flex-shrink-0 ${x?"text-white":""}`}),e.jsx("span",{className:`text-[10px] font-medium leading-tight text-center ${x?"text-white":""}`,children:u.label}),x&&e.jsx("div",{className:"w-1 h-1 bg-cyan-400 rounded-full"})]},u.id)})}),e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-4 bg-gradient-to-r from-gray-800 to-transparent pointer-events-none"}),e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-4 bg-gradient-to-l from-gray-800 to-transparent pointer-events-none"})]})})},oc=()=>{const[n,l]=w.useState("1.0.0"),[c,u]=w.useState(!0);return w.useEffect(()=>{(async()=>{try{const{data:x,error:b}=await je.from("software_versions").select("current_version").eq("software_code","crew_mobile").eq("is_active",!0).maybeSingle();if(b){console.error("Error fetching version:",b);return}x!=null&&x.current_version&&l(x.current_version)}catch(x){console.error("Error fetching version:",x)}finally{u(!1)}})()},[]),{version:n,loading:c}},aa=()=>{const{version:n}=oc();return e.jsxs("div",{className:"text-center text-gray-500 text-xs",children:[e.jsxs("p",{children:["¬© 2025 ControlStage - Crew App Mobile V. ",n]}),e.jsx("p",{children:"Tutti i diritti riservati - Software realizzato da ControlStage"})]})},lc=({userProfile:n})=>{var c;const l=((c=n==null?void 0:n.regaziendasoftware)==null?void 0:c.ragione_sociale)||(n==null?void 0:n.company_name_cached)||"Caricamento azienda...";return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Dashboard"}),e.jsx("p",{className:"text-gray-300",children:(n==null?void 0:n.full_name)||(n==null?void 0:n.company_name)||"Dipendente"}),e.jsx("p",{className:"text-sm text-blue-400",children:l})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-gray-300",children:new Date().toLocaleDateString("it-IT")}),e.jsx("div",{className:"text-xs text-gray-400",children:new Date().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})]})},cc=({monthlyStats:n,onNavigate:l})=>e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("button",{onClick:()=>l==null?void 0:l("checkin"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-purple-500 transition-all cursor-pointer",children:[e.jsx(zt,{className:"h-6 w-6 mx-auto mb-2 text-purple-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.turniOggi}),e.jsx("div",{className:"text-xs text-gray-400",children:"Turni Oggi"})]}),e.jsxs("button",{onClick:()=>l==null?void 0:l("calendar"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-purple-500 transition-all cursor-pointer",children:[e.jsx(zt,{className:"h-6 w-6 mx-auto mb-2 text-purple-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.turniTotaliMese}),e.jsx("div",{className:"text-xs text-gray-400",children:"Turni Mese"})]}),e.jsxs("button",{onClick:()=>l==null?void 0:l("report"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-green-500 transition-all cursor-pointer",children:[e.jsx(ft,{className:"h-6 w-6 mx-auto mb-2 text-green-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.turniCompletati}),e.jsx("div",{className:"text-xs text-gray-400",children:"Turni Completati"})]}),e.jsxs("button",{onClick:()=>l==null?void 0:l("checkin"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-blue-500 transition-all cursor-pointer",children:[e.jsx(ut,{className:"h-6 w-6 mx-auto mb-2 text-blue-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.eventiOggi}),e.jsx("div",{className:"text-xs text-gray-400",children:"Eventi Oggi"})]}),e.jsxs("button",{onClick:()=>l==null?void 0:l("calendar"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-blue-500 transition-all cursor-pointer",children:[e.jsx(ut,{className:"h-6 w-6 mx-auto mb-2 text-blue-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.eventiTotaliMese}),e.jsx("div",{className:"text-xs text-gray-400",children:"Eventi Mese"})]}),e.jsxs("button",{onClick:()=>l==null?void 0:l("report"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-green-500 transition-all cursor-pointer",children:[e.jsx(ft,{className:"h-6 w-6 mx-auto mb-2 text-green-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.eventiCompletati}),e.jsx("div",{className:"text-xs text-gray-400",children:"Eventi Completati"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center",children:[e.jsx(Ss,{className:"h-6 w-6 mx-auto mb-2 text-yellow-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.buoniPastoAssegnati}),e.jsx("div",{className:"text-xs text-gray-400",children:"Buoni Pasto"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center",children:[e.jsx(Bs,{className:"h-6 w-6 mx-auto mb-2 text-orange-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.pastiAziendaliUsufruiti}),e.jsx("div",{className:"text-xs text-gray-400",children:"Pasti Azienda"})]}),e.jsxs("button",{onClick:()=>l==null?void 0:l("requests"),className:"bg-gray-800 rounded-xl p-3 border border-gray-700 text-center hover:bg-gray-700 hover:border-cyan-500 transition-all cursor-pointer",children:[e.jsx(Ht,{className:"h-6 w-6 mx-auto mb-2 text-cyan-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:n.noteSpeseInviate}),e.jsx("div",{className:"text-xs text-gray-400",children:"Note Spese"})]})]}),dc=({eventsWithBenefits:n,warehouseShifts:l})=>{const[c,u]=w.useState(new Date().getMonth()),[f,x]=w.useState(new Date().getFullYear()),[b,v]=w.useState("all"),S=q=>q?/^\d{2}:\d{2}$/.test(q)?q:/^\d{2}:\d{2}:\d{2}$/.test(q)?q.substring(0,5):q:"Non specificato",j=(()=>{const q=new Date,J=new Date(q.getFullYear(),q.getMonth(),q.getDate()).toISOString().split("T")[0],N=[];return n.forEach(_=>{const L=_.assignment,I=new Date(L.giorno_inizio_evento);I.getMonth()===c&&I.getFullYear()===f&&L.giorno_inizio_evento>=J&&N.push({id:L.id,type:"event",title:L.nome_evento,companyName:L.nome_azienda,date:L.giorno_inizio_evento,startTime:"09:00",endTime:"17:00",location:L.evento_localita,address:L.evento_indirizzo,callTime:L.evento_orario_convocazione,isTravel:L.evento_trasferta,eventData:L})}),l.forEach(_=>{const L=new Date(_.data_turno);L.getMonth()===c&&L.getFullYear()===f&&_.data_turno>=J&&N.push({id:_.id,type:"warehouse",title:`Turno ${_.nome_magazzino}`,companyName:_.nome_azienda,date:_.data_turno,startTime:S(_.ora_inizio_turno),endTime:S(_.ora_fine_turno),location:_.nome_magazzino,address:_.indirizzo_magazzino||"Indirizzo non disponibile",callTime:S(_.ora_inizio_turno),shiftData:_})}),N.sort((_,L)=>{const I=new Date(_.date),K=new Date(L.date);return I.getTime()-K.getTime()})})(),p=j.filter(q=>q.type==="event").length,M=j.filter(q=>q.type==="warehouse").length,B=b==="all"?j:b==="events"?j.filter(q=>q.type==="event"):j.filter(q=>q.type==="warehouse"),k=()=>{c===0?(u(11),x(f-1)):u(c-1)},R=()=>{c===11?(u(0),x(f+1)):u(c+1)},C=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],D=new Date().getMonth(),E=new Date().getFullYear(),U=c===D&&f===E;return e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("button",{onClick:k,className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(ta,{className:"h-5 w-5 text-gray-400"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"I Miei Prossimi Eventi"}),e.jsxs("p",{className:"text-sm text-gray-400",children:[C[c]," ",f," (",B.length,")"]})]}),e.jsx("button",{onClick:R,className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(sa,{className:"h-5 w-5 text-gray-400"})})]}),U&&e.jsx("div",{className:"bg-blue-900 border border-blue-700 rounded-lg p-2 mb-4",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(ut,{className:"h-4 w-4 text-blue-400"}),e.jsx("span",{className:"text-blue-200 text-sm font-medium",children:"Mese Corrente"})]})}),e.jsx("div",{className:"bg-gray-700 rounded-lg border border-gray-600 overflow-hidden mb-4",children:e.jsxs("div",{className:"grid grid-cols-3",children:[e.jsxs("button",{onClick:()=>v("all"),className:`flex items-center justify-center space-x-1 py-3 px-2 transition-all text-sm ${b==="all"?"bg-blue-600 text-white":"bg-gray-700 text-gray-400 hover:bg-gray-600"}`,children:[e.jsx(ut,{className:"h-4 w-4"}),e.jsx("span",{className:"font-semibold",children:"Tutti"}),j.length>0&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded-full ${b==="all"?"bg-blue-500":"bg-gray-600"}`,children:j.length})]}),e.jsxs("button",{onClick:()=>v("events"),className:`flex items-center justify-center space-x-1 py-3 px-2 transition-all text-sm ${b==="events"?"bg-blue-600 text-white":"bg-gray-700 text-gray-400 hover:bg-gray-600"}`,children:[e.jsx(ut,{className:"h-4 w-4"}),e.jsx("span",{className:"font-semibold",children:"Eventi"}),p>0&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded-full ${b==="events"?"bg-blue-500":"bg-gray-600"}`,children:p})]}),e.jsxs("button",{onClick:()=>v("warehouse"),className:`flex items-center justify-center space-x-1 py-3 px-2 transition-all text-sm ${b==="warehouse"?"bg-blue-600 text-white":"bg-gray-700 text-gray-400 hover:bg-gray-600"}`,children:[e.jsx(zt,{className:"h-4 w-4"}),e.jsx("span",{className:"font-semibold",children:"Turni"}),M>0&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded-full ${b==="warehouse"?"bg-blue-500":"bg-gray-600"}`,children:M})]})]})}),B.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[b==="warehouse"?e.jsx(zt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}):e.jsx(ut,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsxs("p",{children:[b==="all"&&"Nessun evento in programma",b==="events"&&"Nessun evento in programma",b==="warehouse"&&"Nessun turno magazzino in programma"]}),e.jsx("p",{className:"text-sm mt-1",children:U?"Controlla il calendario per nuove assegnazioni":`Nessun ${b==="warehouse"?"turno":"evento"} per ${C[c]} ${f}`})]}):e.jsx("div",{className:"space-y-3",children:B.map(q=>e.jsxs("div",{className:"bg-gray-700 rounded-lg p-4 border border-gray-600",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[q.type==="warehouse"?e.jsx(zt,{className:"h-5 w-5 text-purple-400"}):q.isTravel?e.jsx(Ts,{className:"h-5 w-5 text-green-400"}):e.jsx(ut,{className:"h-5 w-5 text-blue-400"}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${q.type==="warehouse"?"bg-purple-100 text-purple-800":q.isTravel?"bg-green-100 text-green-800":"bg-blue-100 text-blue-800"}`,children:q.type==="warehouse"?"Turno Magazzino":q.isTravel?"Evento Trasferta":"Evento"})]}),e.jsx("div",{className:"text-right",children:e.jsx("div",{className:"text-sm font-bold text-white",children:new Date(q.date).toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"})})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("h4",{className:"font-bold text-white text-lg",children:q.title}),q.shiftData&&e.jsx("p",{className:"text-xs text-purple-300 font-medium",children:q.shiftData.nome_turno||"Turno Standard"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx(ct,{className:"h-4 w-4 text-green-400"}),e.jsx("span",{className:"text-sm font-medium text-green-400",children:q.type==="warehouse"?"Orario Turno":"Orario Convocazione"})]}),e.jsxs("div",{className:"text-white",children:[q.callTime?e.jsx("p",{className:"text-xl font-bold text-green-200",children:q.callTime}):e.jsx("p",{className:"text-sm text-orange-300",children:"‚ö†Ô∏è Orario non disponibile - Contatta l'azienda"}),q.type==="warehouse"&&q.endTime&&e.jsxs("p",{className:"text-sm text-gray-300 mt-1",children:["Turno: ",q.startTime," - ",q.endTime]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx(Ut,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm font-medium text-cyan-400",children:"Localit√†"})]}),e.jsx("div",{className:"text-white",children:q.type==="warehouse"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm font-medium",children:q.location}),e.jsx("p",{className:"text-xs text-gray-300 mt-1",children:q.address||"Indirizzo non disponibile"})]}):e.jsxs(e.Fragment,{children:[q.location?e.jsx("p",{className:"text-sm font-medium",children:q.location}):e.jsx("p",{className:"text-sm text-gray-400",children:"Localit√† non specificata"}),q.address&&e.jsx("p",{className:"text-xs text-gray-300 mt-1",children:q.address})]})})]}),q.type==="event"&&q.eventData&&(q.eventData.link_scheda_tecnica||q.eventData.link_mappa_gps)&&e.jsxs("div",{className:"mt-3 flex gap-3",children:[q.eventData.link_scheda_tecnica&&e.jsxs("a",{href:q.eventData.link_scheda_tecnica,target:"_blank",rel:"noopener noreferrer",className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors",children:[e.jsx(Ht,{className:"h-5 w-5"}),e.jsx("span",{children:"SCHEDA LAVORO"})]}),q.eventData.link_mappa_gps&&e.jsxs("a",{href:q.eventData.link_mappa_gps,target:"_blank",rel:"noopener noreferrer",className:"flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors",children:[e.jsx(Qr,{className:"h-5 w-5"}),e.jsx("span",{children:"MAPPA"})]})]}),e.jsx("div",{className:"mt-3 text-center",children:(()=>{const J=new Date(q.date+"T00:00:00"),N=new Date,_=new Date(N.getFullYear(),N.getMonth(),N.getDate()),L=J.getTime()-_.getTime(),I=Math.ceil(L/(1e3*60*60*24));return I===0?e.jsx("span",{className:"inline-flex px-3 py-1 rounded-full text-sm font-bold bg-red-100 text-red-800",children:"OGGI"}):I===1?e.jsx("span",{className:"inline-flex px-3 py-1 rounded-full text-sm font-bold bg-orange-100 text-orange-800",children:"DOMANI"}):I<=7?e.jsxs("span",{className:"inline-flex px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800",children:["Tra ",I," giorni"]}):e.jsxs("span",{className:"inline-flex px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800",children:[I," giorni"]})})()})]},q.id))}),e.jsx("div",{className:"mt-4 pt-3 border-t border-gray-600",children:e.jsxs("div",{className:"flex items-center justify-center space-x-4 text-xs text-gray-400",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(zt,{className:"h-3 w-3"}),e.jsx("span",{children:"Turni"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ut,{className:"h-3 w-3"}),e.jsx("span",{children:"Eventi Standard"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(Ts,{className:"h-3 w-3"}),e.jsx("span",{children:"Eventi Trasferta"})]})]})})]})},uc=({onNavigate:n})=>e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{onClick:()=>n==null?void 0:n("calendar"),className:"bg-gradient-to-br from-blue-600 to-cyan-600 rounded-xl p-4 text-left hover:from-blue-700 hover:to-cyan-700 transition-all",children:[e.jsx(ut,{className:"h-8 w-8 mb-2 text-white"}),e.jsx("div",{className:"text-white font-bold",children:"Calendario"}),e.jsx("div",{className:"text-blue-100 text-sm",children:"Vedi tutti gli eventi"})]}),e.jsxs("button",{onClick:()=>n==null?void 0:n("checkin"),className:"bg-gradient-to-br from-purple-600 to-pink-600 rounded-xl p-4 text-left hover:from-purple-700 hover:to-pink-700 transition-all",children:[e.jsx(ft,{className:"h-8 w-8 mb-2 text-white"}),e.jsx("div",{className:"text-white font-bold",children:"Check-in"}),e.jsx("div",{className:"text-purple-100 text-sm",children:"QR Code e GPS"})]})]}),hc=({onNavigate:n})=>{const{user:l}=Pt(),[c,u]=w.useState([]),[f,x]=w.useState(null),[b,v]=w.useState([]),[S,g]=w.useState(!0),[j,p]=w.useState({turniOggi:0,turniTotaliMese:0,turniCompletati:0,eventiOggi:0,eventiTotaliMese:0,eventiCompletati:0,buoniPastoAssegnati:0,pastiAziendaliUsufruiti:0,noteSpeseInviate:0,totalBaseAmount:0,totalBenefitsAmount:0,warehouseEvents:0,regularEvents:0,travelEvents:0});w.useEffect(()=>{l!=null&&l.id&&M()},[l==null?void 0:l.id]);const M=async()=>{try{g(!0),console.log("üîç Caricamento dashboard con sistema benefit per user:",l==null?void 0:l.id);const{data:k,error:R}=await je.from("registration_requests").select(`
          *,
          regaziendasoftware!parent_company_id(
            id,
            ragione_sociale,
            email,
            telefono
          )
        `).eq("auth_user_id",l==null?void 0:l.id).single();if(R||!k){console.error("‚ùå Errore caricamento profilo:",R);return}x(k),console.log("‚úÖ Profilo caricato:",k.full_name);const C=new Date,D=C.getMonth(),E=C.getFullYear(),U=C.toISOString().split("T")[0],q=new Date(E,D,1).toISOString().split("T")[0],J=new Date(E,D+1,0).toISOString().split("T")[0];console.log("üìÖ Periodo analisi:",{startOfMonth:q,endOfMonth:J,todayString:U});const{data:N,error:_}=await je.from("crew_assegnazione_turni").select("*").eq("dipendente_id",l==null?void 0:l.id).gte("data_turno",q).lte("data_turno",J).order("data_turno",{ascending:!0});_&&console.error("‚ùå Errore caricamento turni:",_),console.log("üè≠ Turni magazzino del mese corrente:",(N==null?void 0:N.length)||0);const{data:L,error:I}=await je.from("crew_event_assegnazione").select("*").eq("dipendente_freelance_id",l==null?void 0:l.id).order("giorno_inizio_evento",{ascending:!0});if(I){console.error("‚ùå Errore caricamento assegnazioni eventi:",I),u([]);return}console.log("üìÖ Eventi assegnati trovati:",(L==null?void 0:L.length)||0);const{data:K,error:O}=await je.from("crew_assegnazione_turni").select(`
          *,
          crew_template_turni!turno_id(
            warehouse_id,
            warehouses!warehouse_id(
              name,
              address
            )
          )
        `).eq("dipendente_id",l==null?void 0:l.id).order("data_turno",{ascending:!0});O?(console.error("‚ùå Errore caricamento turni magazzino:",O),v([])):(console.log("üè≠ Turni magazzino assegnati trovati:",(K==null?void 0:K.length)||0),v(K||[]));const{data:W,error:se}=await je.from("crew_assegnazionetariffa").select("*").eq("dipendente_id",l==null?void 0:l.id).eq("attivo",!0);if(se){console.error("‚ùå Errore caricamento tariffe dipendente:",se);return}console.log("üí∞ Tariffe dipendente caricate:",(W==null?void 0:W.length)||0);const G=[];if(W&&W.length>0){const F=[];if(W.forEach(re=>{re.tariffe_ids&&re.tariffe_ids.length>0&&F.push(...re.tariffe_ids)}),console.log("üîç ID tariffe da caricare:",F),F.length>0){const re=[...new Set(F)],{data:_e,error:ge}=await je.from("crew_tariffe").select("*").in("id",re).eq("attivo",!0);if(ge){console.error("‚ùå Errore caricamento dettagli tariffe:",ge);return}console.log("‚úÖ Tariffe caricate:",(_e==null?void 0:_e.length)||0),_e==null||_e.forEach(X=>{G.push({id:X.id,nome_tariffa:X.nome_tariffa,categoria:X.categoria,tipo_calcolo:X.tipo_calcolo,importo:X.importo,attivo:X.attivo})})}}console.log("üéÅ Benefit dipendente disponibili:",G.map(F=>F.nome_tariffa));const $=[];for(const F of L||[]){console.log(`
üé≠ ANALISI EVENTO: "${F.nome_evento}"`),console.log("üìã Benefit evento disponibili:",{benefits_evento_nomi:F.benefits_evento_nomi,bonus_trasferta:F.bonus_trasferta,bonus_diaria:F.bonus_diaria,evento_trasferta:F.evento_trasferta,bonus_previsti:F.bonus_previsti});const re=[],_e=[];let ge=0;if(F.benefits_evento_nomi&&F.benefits_evento_nomi.length>0&&F.benefits_evento_nomi.forEach(X=>{const pe=G.find(me=>me.nome_tariffa.toLowerCase().includes(X.toLowerCase())||X.toLowerCase().includes(me.nome_tariffa.toLowerCase()));pe?(re.push(pe),ge+=pe.importo,_e.push({name:pe.nome_tariffa,amount:pe.importo,category:pe.categoria,applied:!0}),console.log(`‚úÖ BENEFIT APPLICATO: ${pe.nome_tariffa} = ‚Ç¨${pe.importo}`)):(_e.push({name:X,amount:0,category:"non_disponibile",applied:!1}),console.log(`‚ùå BENEFIT NON DISPONIBILE: ${X} (dipendente non ha questa tariffa)`))}),F.bonus_trasferta&&F.evento_trasferta){const X=G.find(pe=>pe.categoria==="indennita_trasferta"||pe.nome_tariffa.toLowerCase().includes("trasferta"));X&&!re.find(pe=>pe.id===X.id)&&(re.push(X),ge+=X.importo,_e.push({name:X.nome_tariffa,amount:X.importo,category:X.categoria,applied:!0}),console.log(`‚úÖ BONUS TRASFERTA APPLICATO: ${X.nome_tariffa} = ‚Ç¨${X.importo}`))}if(F.bonus_diaria){const X=G.find(pe=>pe.nome_tariffa.toLowerCase().includes("diaria")||pe.categoria==="indennita_trasferta");X&&!re.find(pe=>pe.id===X.id)&&(re.push(X),ge+=X.importo,_e.push({name:X.nome_tariffa,amount:X.importo,category:X.categoria,applied:!0}),console.log(`‚úÖ BONUS DIARIA APPLICATO: ${X.nome_tariffa} = ‚Ç¨${X.importo}`))}F.bonus_previsti&&F.bonus_previsti>0&&(ge+=F.bonus_previsti,_e.push({name:"Bonus Evento",amount:F.bonus_previsti,category:"bonus_evento",applied:!0}),console.log(`‚úÖ BONUS FISSO EVENTO: ‚Ç¨${F.bonus_previsti}`)),console.log(`üí∞ TOTALE BENEFIT APPLICABILI: ‚Ç¨${ge}`),K==null||K.forEach(X=>{var pe,me;X.warehouse_address=((me=(pe=X.crew_template_turni)==null?void 0:pe.warehouses)==null?void 0:me.address)||"Indirizzo non disponibile"}),console.log("üìä DETTAGLIO BENEFIT:",_e),$.push({assignment:F,applicableBenefits:re,totalBenefitsAmount:ge,benefitDetails:_e})}u($),await B($,N||[],K||[])}catch(k){console.error("‚ùå Errore generale caricamento dashboard:",k)}finally{g(!1)}},B=async(k,R,C)=>{const D=new Date,E=D.getMonth(),U=D.getFullYear(),q=D.toISOString().split("T")[0],J=new Date(U,E,1).toISOString().split("T")[0],N=new Date(U,E+1,0).toISOString().split("T")[0],_=R.filter(V=>V.data_turno===q).length,L=k.filter(V=>V.assignment.giorno_inizio_evento===q&&!V.assignment.nome_evento.toLowerCase().includes("magazzino")&&!V.assignment.nome_evento.toLowerCase().includes("turno")).length,I=R.length,K=k.filter(V=>{const de=new Date(V.assignment.giorno_inizio_evento);return de.getMonth()===E&&de.getFullYear()===U&&!V.assignment.nome_evento.toLowerCase().includes("magazzino")&&!V.assignment.nome_evento.toLowerCase().includes("turno")}).length,{data:O}=await je.from("timesheet_entries").select("event_id, end_time, status, is_rectified").eq("crew_id",l==null?void 0:l.id).gte("date",J).lte("date",N),W=new Set((O==null?void 0:O.filter(V=>V.end_time&&(V.status==="completed"||V.status==="submitted")).map(V=>V.event_id))||[]),se=k.filter(V=>{const de=new Date(V.assignment.giorno_inizio_evento);return de.getMonth()===E&&de.getFullYear()===U&&!V.assignment.nome_evento.toLowerCase().includes("magazzino")&&!V.assignment.nome_evento.toLowerCase().includes("turno")&&W.has(V.assignment.evento_id)}).length;let G=0,$=0,F=0,re=0;try{const{data:V,error:de}=await je.from("warehouse_checkins").select("date, meal_voucher, company_meal").eq("crew_id",l==null?void 0:l.id).gte("date",J).lte("date",N).not("check_out_time","is",null);!de&&V&&(F=new Set(V.map(Ne=>Ne.date)).size,G=new Set(V.filter(Ne=>Ne.meal_voucher===!0).map(Ne=>Ne.date)).size,$=new Set(V.filter(Ne=>Ne.company_meal===!0).map(Ne=>Ne.date)).size);const{data:ae,error:le}=await je.from("spese").select("id").eq("id_tecnico",l==null?void 0:l.id).gte("data_spesa",J).lte("data_spesa",N);!le&&ae&&(re=ae.length)}catch(V){console.error("‚ùå Errore caricamento dati dal database:",V)}const _e=k.filter(V=>{const de=new Date(V.assignment.giorno_inizio_evento);return de.getMonth()===E&&de.getFullYear()===U}),ge=_e.reduce((V,de)=>V+(de.assignment.tariffa_evento_assegnata||0),0),X=_e.reduce((V,de)=>V+de.totalBenefitsAmount,0),pe=_e.filter(V=>V.assignment.nome_evento.toLowerCase().includes("magazzino")||V.assignment.nome_evento.toLowerCase().includes("turno")).length,me=_e.filter(V=>V.assignment.evento_trasferta).length,Q=_e.length-pe-me;console.log("üìä DEBUG EVENTI TRASFERTA:",{monthlyEventsCount:_e.length,eventiConTrasferta:_e.filter(V=>V.assignment.evento_trasferta).map(V=>({nome:V.assignment.nome_evento,evento_trasferta:V.assignment.evento_trasferta})),travelEventsCount:me}),console.log("üìä STATISTICHE CALCOLATE:",{turniOggi:_,turniTotaliMese:I,turniCompletati:F,eventiOggi:L,eventiTotaliMese:K,eventiCompletati:se,buoniPastoAssegnati:G,pastiAziendaliUsufruiti:$,noteSpeseInviate:re,warehouseEvents:pe,regularEvents:Q,travelEvents:me}),p({turniOggi:_,turniTotaliMese:I,turniCompletati:F,eventiOggi:L,eventiTotaliMese:K,eventiCompletati:se,buoniPastoAssegnati:G,pastiAziendaliUsufruiti:$,noteSpeseInviate:re,totalBaseAmount:ge,totalBenefitsAmount:X,warehouseEvents:pe,regularEvents:Q,travelEvents:me})};return S?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento dashboard..."})]})}):e.jsx("div",{className:"min-h-screen bg-gray-900 text-white",children:e.jsxs("div",{className:"p-4 pb-20 space-y-6",children:[e.jsx(lc,{userProfile:f}),e.jsx(cc,{monthlyStats:j,onNavigate:n}),e.jsx(dc,{eventsWithBenefits:c,warehouseShifts:b}),e.jsx(uc,{onNavigate:n}),e.jsx(aa,{})]})})},xc=()=>{var Ye;const{user:n}=Pt(),{showSuccess:l,showError:c}=us(),[u,f]=w.useState(new Date),[x,b]=w.useState([]),[v,S]=w.useState(null),[g,j]=w.useState(!0),[p,M]=w.useState(null),[B,k]=w.useState(!1),[R,C]=w.useState("month"),[D,E]=w.useState([]),[U,q]=w.useState([]),[J,N]=w.useState([]),[_,L]=w.useState(new Set),[I,K]=w.useState({}),[O,W]=w.useState(!1);w.useEffect(()=>{n!=null&&n.id&&se()},[n==null?void 0:n.id]);const se=async()=>{try{const{data:Te,error:H}=await je.from("registration_requests").select(`
          *,
          regaziendasoftware!parent_company_id(ragione_sociale)
        `).eq("auth_user_id",n==null?void 0:n.id).single();if(H){console.error("Errore caricamento profilo:",H),j(!1);return}S(Te);const ne=Te==null?void 0:Te.id;Te!=null&&Te.parent_company_id?(await $(Te.parent_company_id,ne),await G(ne,Te.parent_company_id)):(await $(void 0,ne),await G(ne))}catch(Te){console.error("Errore loadUserProfile:",Te)}finally{j(!1)}},G=async(Te,H)=>{try{if(!Te)return;const{data:ne,error:fe}=await je.from("crew_richiesteferie_permessi").select("data_inizio, data_fine, tipo_richiesta, stato").eq("dipendente_id",Te).eq("stato","approvata");if(fe){console.error("Errore caricamento ferie approvate:",fe);return}const Ie=new Set;ne&&ne.length>0&&ne.forEach(Re=>{if(Re.tipo_richiesta==="ferie"){const ee=new Date(Re.data_inizio),oe=new Date(Re.data_fine);let De=new Date(ee);for(;De<=oe;){const Ee=ge(De);Ie.add(Ee),De.setDate(De.getDate()+1)}}}),L(Ie),console.log("‚úÖ Ferie approvate caricate:",Ie.size,"giorni")}catch(ne){console.error("Eccezione loadApprovedVacations:",ne)}},$=async(Te,H)=>{try{console.log("üìÖ Caricamento eventi, turni magazzino e corsi per:",H||(n==null?void 0:n.id));const ne=oe=>oe?/^\d{2}:\d{2}$/.test(oe)?oe:/^\d{2}:\d{2}:\d{2}$/.test(oe)?oe.substring(0,5):"09:00":"09:00";let fe=null;try{if(H){const{data:oe,error:De}=await je.from("crew_event_assegnazione").select("*").eq("dipendente_freelance_id",H).order("giorno_inizio_evento",{ascending:!0});De?console.error("Errore crew_event_assegnazione (personId):",De):fe=oe}else{const{data:oe,error:De}=await je.from("crew_event_assegnazione").select("*").eq("dipendente_freelance_id",n==null?void 0:n.id).order("giorno_inizio_evento",{ascending:!0});De?console.error("Errore crew_event_assegnazione (fallback):",De):fe=oe}console.log("‚úÖ Eventi assegnati caricati (crew_event_assegnazione):",(fe==null?void 0:fe.length)||0)}catch(oe){console.error("Eccezione crew_event_assegnazione:",oe)}let Ie=null;try{const{data:oe,error:De}=await je.from("crew_assegnazione_turni").select("*").eq("dipendente_id",H||(n==null?void 0:n.id)).order("data_turno",{ascending:!0});De?console.error("Errore crew_assegnazione_turni:",De):Ie=oe}catch(oe){console.error("Eccezione crew_assegnazione_turni:",oe)}let Re=null;try{const{data:oe,error:De}=await je.from("crew_assegnazionecorsi").select("*").eq("persona_id",H||(n==null?void 0:n.id)).order("data_invito",{ascending:!0});De?console.error("Errore crew_assegnazionecorsi:",De):Re=oe}catch(oe){console.error("Eccezione crew_assegnazionecorsi:",oe)}E(fe||[]),q(Ie||[]),N(Re||[]);const ee=[];if(fe&&fe.length>0&&fe.forEach(oe=>{const De=oe.data_inizio_assegnazione||oe.giorno_inizio_evento,Ee=oe.data_fine_assegnazione||oe.giorno_fine_evento||De,te=oe.evento_orario_convocazione||void 0,ke=(oe.nome_evento||"").toString().toLowerCase();let Z="event";ke.includes("magazzino")||ke.includes("turno")?Z="warehouse":oe.evento_trasferta&&(Z="event_travel"),ee.push({id:oe.id||oe.evento_id||String(Math.random()),title:oe.nome_evento||oe.nome_azienda||"Evento Assegnato",description:oe.evento_descrizione||void 0,type:Z,date:typeof De=="string"?De:new Date(De).toISOString().slice(0,10),endDate:typeof Ee=="string"?Ee:new Date(Ee).toISOString().slice(0,10),startTime:"09:00",endTime:"17:00",location:oe.evento_localita||oe.nome_azienda||"Localit√† non specificata",address:oe.evento_indirizzo||void 0,callTime:te,companyName:oe.nome_azienda||"",isAssigned:!0,status:"assigned",assignedCrewNames:oe.nome_dipendente_freelance||void 0,isTravel:!!oe.evento_trasferta,assignedRate:oe.tariffa_evento_assegnata?Number(oe.tariffa_evento_assegnata):void 0,bonusTravel:!!oe.bonus_trasferta,bonusDiaria:!!oe.bonus_diaria,benefitsEventoIds:oe.benefits_evento_ids||[],benefitsEventoNomi:oe.benefits_evento_nomi||[],benefitsDisponibili:oe.benefits_disponibili||{},raw:oe})}),Ie&&Ie.length>0&&Ie.forEach(oe=>{var Ee;const De=oe.data_turno?typeof oe.data_turno=="string"?oe.data_turno:new Date(oe.data_turno).toISOString().slice(0,10):ge(new Date);ee.push({id:oe.id,title:oe.nome_turno||"Turno Magazzino",description:`Turno di magazzino presso ${oe.nome_magazzino||"Magazzino"}`,type:"warehouse",date:De,endDate:De,startTime:oe.ora_inizio_turno?oe.ora_inizio_turno.substring(0,5):"09:00",endTime:oe.ora_fine_turno?oe.ora_fine_turno.substring(0,5):"17:00",location:oe.nome_magazzino||"Magazzino",address:oe.indirizzo_magazzino||void 0,callTime:oe.ora_inizio_turno?oe.ora_inizio_turno.substring(0,5):void 0,companyName:oe.nome_azienda||((Ee=v==null?void 0:v.regaziendasoftware)==null?void 0:Ee.ragione_sociale)||"La Mia Azienda",isAssigned:!0,status:"assigned",assignedCrewNames:oe.dipendente_nome||void 0,isTravel:!1,assignedRate:void 0,bonusTravel:!1,bonusDiaria:!1,raw:oe})}),Re&&Re.length>0){const oe=Array.from(new Set(Re.map(Ee=>Ee.corso_id).filter(Boolean)));let De={};try{if(oe.length>0){const{data:Ee,error:te}=await je.from("crew_corsi").select("*").in("id",oe);te?console.error("Errore caricamento crew_corsi:",te):De=(Ee||[]).reduce((ke,Z)=>(ke[Z.id]=Z,ke),{})}}catch(Ee){console.error("Eccezione caricamento crew_corsi:",Ee)}Re.forEach(Ee=>{var Z;const te=De[Ee.corso_id],ke=te!=null&&te.data_corso?typeof te.data_corso=="string"?te.data_corso:new Date(te.data_corso).toISOString().slice(0,10):Ee.data_partecipazione?typeof Ee.data_partecipazione=="string"?Ee.data_partecipazione:new Date(Ee.data_partecipazione).toISOString().slice(0,10):null;ke&&ee.push({id:Ee.id,title:(te==null?void 0:te.titolo)||`Corso ${Ee.corso_id}`,description:(te==null?void 0:te.descrizione)||void 0,type:"course",date:ke,endDate:ke,startTime:te!=null&&te.ora_inizio?te.ora_inizio.substring?te.ora_inizio.substring(0,5):te.ora_inizio:"09:00",endTime:te!=null&&te.ora_fine?te.ora_fine.substring?te.ora_fine.substring(0,5):te.ora_fine:"17:00",location:(te==null?void 0:te.luogo)||"Luogo non specificato",address:(te==null?void 0:te.luogo)||void 0,callTime:te!=null&&te.ora_inizio?te.ora_inizio.substring?te.ora_inizio.substring(0,5):te.ora_inizio:void 0,companyName:((Z=v==null?void 0:v.regaziendasoftware)==null?void 0:Z.ragione_sociale)||"",isAssigned:!0,status:Ee.stato_invito||"invitato",assignedCrewNames:Ee.persona_nome||void 0,isTravel:!1,assignedRate:void 0,bonusTravel:!1,bonusDiaria:!1,raw:{assignment:Ee,corso:te}})})}b(ee),console.log("üìä CALENDARIO COMPLETO CARICATO:",{eventiTotali:ee.length,eventi:(fe==null?void 0:fe.length)||0,turniMagazzino:(Ie==null?void 0:Ie.length)||0,corsi:(Re==null?void 0:Re.length)||0,eventiTrasferta:ee.filter(oe=>oe.isTravel).length})}catch(ne){console.error("Errore nel caricamento eventi:",ne),b([]),E([]),q([]),N([])}},F=async Te=>{K(H=>({...H,[Te]:!0}));try{const H=new Date().toISOString(),{error:ne}=await je.from("crew_assegnazionecorsi").update({stato_invito:"confermato",data_conferma:H}).eq("id",Te);return ne?(console.error("Errore conferma partecipazione corso:",ne),c("Errore","Errore durante la conferma partecipazione."),!1):(N(fe=>fe.map(Ie=>String(Ie.id)===String(Te)?{...Ie,stato_invito:"confermato",data_conferma:H}:Ie)),b(fe=>fe.map(Ie=>{if(String(Ie.id)===String(Te)&&Ie.type==="course"){const Re={...Ie.raw||{}};return Re.assignment&&(Re.assignment={...Re.assignment,stato_invito:"confermato",data_conferma:H}),{...Ie,status:"confermato",raw:Re}}return Ie})),l("Partecipazione confermata"),!0)}catch(H){return console.error("Eccezione handleConfirmCourse:",H),c("Errore","Errore durante la conferma partecipazione."),!1}finally{K(H=>({...H,[Te]:!1}))}},re=async Te=>{K(H=>({...H,[Te]:!0}));try{const{error:H}=await je.from("crew_assegnazionecorsi").update({stato_invito:"invitato",data_conferma:null}).eq("id",Te);return H?(console.error("Errore annullo partecipazione corso:",H),c("Errore","Errore durante l'annullamento partecipazione."),!1):(N(ne=>ne.map(fe=>String(fe.id)===String(Te)?{...fe,stato_invito:"invitato",data_conferma:null}:fe)),b(ne=>ne.map(fe=>{if(String(fe.id)===String(Te)&&fe.type==="course"){const Ie={...fe.raw||{}};return Ie.assignment&&(Ie.assignment={...Ie.assignment,stato_invito:"invitato",data_conferma:null}),{...fe,status:"invitato",raw:Ie}}return fe})),l("Partecipazione annullata"),!0)}catch(H){return console.error("Eccezione handleCancelCourse:",H),c("Errore","Errore durante l'annullamento partecipazione."),!1}finally{K(H=>({...H,[Te]:!1}))}};window.__confirmCourseHandler=F,window.__cancelCourseHandler=re;const _e=async Te=>{var H,ne,fe;try{if(console.log("üîé loadColleaguesForEvent (RPC): evt.id=",Te.id,"raw=",Te.raw),Te.type==="warehouse"&&Te.raw){const ee=Te.raw.turno_id||Te.raw.turno||Te.raw.turnoId,oe=Te.date;if(ee){const{data:De,error:Ee}=await je.rpc("get_shift_colleagues",{p_turno:ee,p_data:oe});if(Ee)console.warn("RPC get_shift_colleagues error",Ee);else if(De&&De.length>0)return(De||[]).map(te=>({id:te.dipendente_id,name:te.dipendente_nome}))}}const Ie=((H=Te.raw)==null?void 0:H.evento_id)||((ne=Te.raw)==null?void 0:ne.event_id)||Te.id,Re=((fe=Te.raw)==null?void 0:fe.azienda_id)||null;if(Ie){const{data:ee,error:oe}=await je.rpc("get_event_colleagues",{p_evento:Ie,p_company:Re});if(oe)console.warn("RPC get_event_colleagues error",oe);else if(ee&&ee.length>0)return(ee||[]).map(De=>({id:De.dipendente_id,name:De.dipendente_nome}))}if(Ie)try{const{data:ee,error:oe}=await je.from("crew_event_assegnazione").select("dipendente_freelance_id, nome_dipendente_freelance").eq("evento_id",Ie);if(!oe&&ee&&ee.length>0)return(ee||[]).map(De=>({id:De.dipendente_freelance_id,name:De.nome_dipendente_freelance}))}catch(ee){console.warn("fallback crew_event_assegnazione exception",ee)}return[]}catch(Ie){return console.error("Eccezione loadColleaguesForEvent:",Ie),[]}},ge=Te=>{const H=Te.getFullYear(),ne=String(Te.getMonth()+1).padStart(2,"0"),fe=String(Te.getDate()).padStart(2,"0");return`${H}-${ne}-${fe}`},X=(Te,H=1)=>{const ne=new Date(Te),fe=(ne.getDay()+7)%7,Ie=(fe<H?7:0)+fe-H;return ne.setDate(ne.getDate()-Ie),ne.setHours(0,0,0,0),ne},pe=(Te,H)=>{const ne=new Date(Te);return ne.setDate(ne.getDate()+H),ne},me=Te=>{const H=X(Te,1);return Array.from({length:7}).map((ne,fe)=>pe(H,fe))},Q=(Te,H)=>x.filter(ne=>{const fe=ne.date,Ie=ne.endDate||ne.date;return fe<=H&&Ie>=Te}),V=()=>{f(R==="month"||R==="agenda"?new Date(u.getFullYear(),u.getMonth()-1,1):R==="week"?pe(u,-7):pe(u,-1))},de=()=>{f(R==="month"||R==="agenda"?new Date(u.getFullYear(),u.getMonth()+1,1):R==="week"?pe(u,7):pe(u,1))},ae=()=>f(new Date),le=Te=>{const H=Te.getFullYear(),ne=Te.getMonth(),fe=new Date(H,ne,1),Re=new Date(H,ne+1,0).getDate(),ee=[],oe=(fe.getDay()+6)%7;for(let Ee=0;Ee<oe;Ee++){const te=new Date(H,ne,1-(oe-Ee)),ke=_.has(ge(te));ee.push({date:te,isCurrentMonth:!1,isToday:!1,events:be(te),isAvailable:!0,isVacationDay:ke})}for(let Ee=1;Ee<=Re;Ee++){const te=new Date(H,ne,Ee),ke=be(te),Z=_.has(ge(te));ee.push({date:te,isCurrentMonth:!0,isToday:ge(te)===ge(new Date),events:ke,isAvailable:ke.length===0,isVacationDay:Z})}const De=42-ee.length;for(let Ee=1;Ee<=De;Ee++){const te=new Date(H,ne+1,Ee),ke=_.has(ge(te));ee.push({date:te,isCurrentMonth:!1,isToday:!1,events:be(te),isAvailable:!0,isVacationDay:ke})}return ee},be=Te=>{const H=Te.getFullYear(),ne=String(Te.getMonth()+1).padStart(2,"0"),fe=String(Te.getDate()).padStart(2,"0"),Ie=`${H}-${ne}-${fe}`;return x.filter(Re=>{const ee=Re.date,oe=Re.endDate||Re.date;return Ie>=ee&&Ie<=oe}).sort((Re,ee)=>(Re.startTime||"").localeCompare(ee.startTime||""))},ye=J.filter(Te=>Te.stato_invito==="invitato"),Ce=()=>{const Te=me(u),H=ge(Te[0]),ne=ge(Te[6]),fe=Q(H,ne);return e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 p-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsxs("div",{className:"text-sm font-medium text-gray-200",children:["Settimana: ",new Date(H).toLocaleDateString("it-IT")," ‚Äî ",new Date(ne).toLocaleDateString("it-IT")]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-7 gap-3 md:gap-2",children:Te.map(Ie=>{const Re=ge(Ie),ee=fe.filter(Ee=>Ee.date<=Re&&(Ee.endDate||Ee.date)>=Re),oe=_.has(Re),De=ge(Ie)===ge(new Date);return e.jsxs("div",{className:`rounded-lg p-3 md:p-2 md:min-h-[140px] ${oe?"bg-red-600":"bg-gray-900"}`,children:[e.jsx("div",{className:`text-base md:text-sm font-semibold mb-2 ${De?"text-blue-300":"text-white"}`,children:Ie.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"short"})}),oe?e.jsx("div",{className:"flex items-center justify-center py-4 md:h-20",children:e.jsx("span",{className:"text-sm md:text-xs font-bold text-white uppercase tracking-wider",children:"FERIE"})}):e.jsx("div",{className:"space-y-2 md:space-y-1",children:ee.map(Ee=>e.jsx("div",{className:`text-sm md:text-[11px] leading-tight px-2 md:px-1.5 py-2 md:py-1 rounded text-white font-medium cursor-pointer hover:opacity-90 ${Ee.type==="warehouse"?Ee.isAssigned?"bg-purple-500":"bg-purple-600 opacity-80":Ee.type==="event"?Ee.isAssigned?"bg-blue-500":"bg-blue-600 opacity-80":Ee.type==="event_travel"?Ee.isAssigned?"bg-green-500":"bg-green-600 opacity-80":Ee.isAssigned?"bg-yellow-500":"bg-yellow-600 opacity-80"}`,title:Ee.title,onClick:()=>Ue(Re),children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"truncate md:block",children:Ee.title}),e.jsx("span",{className:"text-xs opacity-75 whitespace-nowrap md:hidden",children:Ee.startTime})]})},Ee.id))})]},Re)})})]})},Ne=()=>{const Te=new Date(u),H=ge(Te),ne=x.filter(fe=>fe.date<=H&&(fe.endDate||fe.date)>=H).sort((fe,Ie)=>(fe.startTime||"").localeCompare(Ie.startTime||""));return e.jsx(Ae,{dayEvents:ne,day:Te,loadColleaguesForEvent:_e,userId:n==null?void 0:n.id})},Ae=({dayEvents:Te,day:H,loadColleaguesForEvent:ne,userId:fe})=>{const[Ie,Re]=w.useState({}),[ee,oe]=w.useState({});return w.useEffect(()=>{let De=!0;return(async()=>{for(const te of Te){if(!De)return;if(te.type==="course"){oe(he=>({...he,[te.id]:!1})),Re(he=>({...he,[te.id]:[]}));continue}oe(he=>({...he,[te.id]:!0}));const ke=await ne(te);if(!De)return;const Z=ke.filter(he=>he.id!==fe);Re(he=>({...he,[te.id]:Z})),oe(he=>({...he,[te.id]:!1}))}})(),()=>{De=!1}},[Te.map(De=>De.id).join(",")]),e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 p-5",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{children:e.jsxs("div",{className:"text-base font-medium text-gray-200",children:["Giorno: ",H.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})]})})}),Te.length===0?e.jsx("div",{className:"text-center text-gray-400 py-10 text-base",children:"Nessun evento in questa data"}):e.jsx("div",{className:"space-y-4",children:Te.map(De=>e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-lg font-semibold text-white mb-1",children:De.title}),e.jsx("div",{className:"text-sm text-gray-300",children:De.location}),De.callTime&&e.jsxs("div",{className:"text-sm text-gray-400 mt-2",children:["Convocazione: ",De.callTime]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-300",children:[De.startTime," - ",De.endTime]}),e.jsx("div",{className:"text-sm mt-2",children:De.isAssigned?e.jsx("span",{className:"text-green-300 font-medium",children:"Assegnato"}):e.jsx("span",{className:"text-yellow-300 font-medium",children:"Non assegnato"})})]})]}),e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-700",children:ee[De.id]?e.jsx("div",{className:"text-sm text-gray-400",children:"Caricamento colleghi..."}):De.type!=="course"&&Ie[De.id]&&Ie[De.id].length>0?e.jsxs("div",{className:"p-3 bg-gray-800 rounded text-sm text-gray-200",children:[e.jsx("strong",{className:"text-base",children:"Con te lavoreranno:"}),e.jsx("ul",{className:"mt-2 space-y-1 text-sm",children:Ie[De.id].map(Ee=>e.jsxs("li",{className:"text-gray-300",children:["‚Ä¢ ",Ee.name]},Ee.id))})]}):De.type==="course"?null:e.jsx("div",{className:"text-sm text-gray-400",children:"Nessun altro membro assegnato trovato."})})]},De.id))})]})},Ue=Te=>{M(Te),k(!0)},qe=()=>{const Te=u.getFullYear(),H=u.getMonth(),ne=new Date(Te,H,1),fe=new Date(Te,H+1,0),Ie=ge(ne),Re=ge(fe),oe=Q(Ie,Re).sort((Ee,te)=>Ee.date!==te.date?Ee.date.localeCompare(te.date):(Ee.startTime||"").localeCompare(te.startTime||"")).reduce((Ee,te)=>{const ke=te.date;return Ee[ke]||(Ee[ke]=[]),Ee[ke].push(te),Ee},{}),De=Object.keys(oe).sort();return e.jsx("div",{className:"space-y-4",children:De.length===0?e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 p-8 text-center",children:[e.jsx(ut,{className:"h-16 w-16 mx-auto mb-4 text-gray-600"}),e.jsx("p",{className:"text-base text-gray-400",children:"Nessun evento in questo mese"})]}):De.map(Ee=>{const te=new Date(Ee+"T12:00:00"),ke=ge(te)===ge(new Date),Z=_.has(Ee),he=oe[Ee];return e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 overflow-hidden",children:[e.jsx("div",{className:`p-4 border-b border-gray-700 ${Z?"bg-red-600":ke?"bg-blue-600":"bg-gray-750"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-bold text-white",children:te.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})}),Z&&e.jsx("div",{className:"text-sm text-white font-bold mt-1 uppercase tracking-wider",children:"FERIE"}),ke&&!Z&&e.jsx("div",{className:"text-sm text-blue-100 mt-1",children:"Oggi"})]}),e.jsxs("div",{className:"text-sm text-gray-300 font-medium",children:[he.length," ",he.length===1?"evento":"eventi"]})]})}),e.jsx("div",{className:"p-4 space-y-3",children:he.map(we=>{const ve=()=>we.type==="warehouse"?"Magazzino":we.type==="event"?"Evento":we.type==="event_travel"?"Trasferta":"Corso",Qe=()=>we.type==="warehouse"?"bg-purple-500":we.type==="event"?"bg-blue-500":we.type==="event_travel"?"bg-green-500":"bg-yellow-500";return e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700 hover:border-gray-600 transition-colors cursor-pointer",onClick:()=>Ue(Ee),children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("span",{className:`inline-block px-3 py-1 text-xs font-semibold text-white rounded-full ${Qe()}`,children:ve()}),we.isAssigned&&e.jsxs("span",{className:"inline-flex items-center text-xs text-green-300 font-medium",children:[e.jsx(ft,{className:"h-3.5 w-3.5 mr-1"}),"Assegnato"]})]}),e.jsx("h4",{className:"text-base font-bold text-white mb-1",children:we.title})]})}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-300",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ct,{className:"h-4 w-4 flex-shrink-0 text-gray-400"}),e.jsxs("span",{children:[we.startTime," - ",we.endTime,we.callTime&&e.jsxs("span",{className:"text-gray-400 ml-2",children:["(Convocazione: ",we.callTime,")"]})]})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 flex-shrink-0 text-gray-400 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:we.location}),we.address&&e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:we.address})]})]}),we.companyName&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(zt,{className:"h-4 w-4 flex-shrink-0 text-gray-400"}),e.jsx("span",{children:we.companyName})]}),we.description&&e.jsx("div",{className:"mt-2 p-2 bg-gray-800 rounded text-xs text-gray-400 border border-gray-700",children:we.description}),(we.bonusTravel||we.bonusDiaria||we.assignedRate)&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-gray-700 flex flex-wrap gap-2",children:[we.bonusTravel&&e.jsx("span",{className:"inline-flex px-2 py-1 text-xs bg-green-900 text-green-200 rounded",children:"Bonus Trasferta"}),we.bonusDiaria&&e.jsx("span",{className:"inline-flex px-2 py-1 text-xs bg-blue-900 text-blue-200 rounded",children:"Bonus Diaria"}),we.assignedRate&&e.jsxs("span",{className:"inline-flex px-2 py-1 text-xs bg-gray-700 text-gray-200 rounded",children:["Tariffa: ",we.assignedRate," EUR"]})]})]})]},we.id)})})]},Ee)})})},rt=u.getMonth(),at=u.getFullYear(),Ke=D.filter(Te=>{const H=Te.data_inizio_assegnazione||Te.giorno_inizio_evento||Te.start_date||Te.date;if(!H)return!1;const ne=new Date(H);return ne.getMonth()===rt&&ne.getFullYear()===at}).length,Je=U.filter(Te=>{const H=Te.data_turno||Te.date||Te.start_date;if(!H)return!1;const ne=new Date(H);return ne.getMonth()===rt&&ne.getFullYear()===at}).length;if(g)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento calendario..."})]})});const Ge=e.jsx("style",{children:`
      .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .hide-scrollbar::-webkit-scrollbar { display: none; }
    `}),yt=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white",children:[Ge,e.jsxs("div",{className:"p-4 pb-20 space-y-4",children:[e.jsxs("div",{className:"flex flex-col space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Il Mio Calendario"}),e.jsx("p",{className:"text-gray-300",children:((Ye=v==null?void 0:v.regaziendasoftware)==null?void 0:Ye.ragione_sociale)||"La Mia Azienda"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:V,className:"p-2 hover:bg-gray-800 rounded",children:e.jsx(ta,{className:"h-5 w-5"})}),e.jsx("button",{onClick:ae,className:"px-3 py-1 bg-gray-800 rounded text-sm",children:"Oggi"}),e.jsx("button",{onClick:de,className:"p-2 hover:bg-gray-800 rounded",children:e.jsx(sa,{className:"h-5 w-5"})}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{className:"p-2 hover:bg-gray-800 rounded relative",onClick:()=>W(Te=>!Te),"aria-haspopup":"true","aria-expanded":O,title:"Corsi da confermare",children:[e.jsx(li,{className:"h-5 w-5"}),ye.length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-600 text-white text-xxs rounded-full px-1.5 py-0.5 text-[10px]",children:ye.length})]}),O&&e.jsxs("div",{className:"absolute right-0 mt-2 w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-50 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"text-base font-semibold text-white",children:"Corsi da confermare"}),e.jsx("button",{onClick:()=>W(!1),className:"text-gray-400 hover:text-gray-200",children:e.jsx(jt,{className:"h-5 w-5"})})]}),ye.length===0?e.jsx("div",{className:"text-sm text-gray-400",children:"Nessun corso da confermare"}):e.jsx("div",{className:"space-y-3 max-h-64 overflow-y-auto hide-scrollbar",children:ye.map(Te=>{const H=Te.data_partecipazione||Te.data_invito||Te.corso_meta&&(Te.corso_meta.data_corso||Te.corso_meta.data)||null,ne=H?new Date(String(H)).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"}):"‚Äî";return e.jsxs("div",{className:"p-3 bg-gray-900 rounded-lg border border-gray-700",children:[e.jsxs("div",{className:"text-sm font-semibold text-white mb-1",children:["Giorno: ",ne]}),e.jsx("div",{className:"text-sm text-gray-400 mt-1",children:"Clicca sul calendario per i dettagli, oppure conferma la partecipazione direttamente da qui."}),e.jsxs("div",{className:"mt-3 flex items-center space-x-2",children:[e.jsx("button",{className:"bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1.5 rounded disabled:opacity-60 font-medium",onClick:async()=>{await F(Te.id),J.filter(Ie=>Ie.stato_invito==="invitato"&&String(Ie.id)!==String(Te.id)).length===0&&W(!1)},disabled:!!I[Te.id],children:I[Te.id]?"Confermo...":"Conferma"}),e.jsx("button",{className:"bg-gray-700 hover:bg-gray-600 text-white text-sm px-3 py-1.5 rounded disabled:opacity-60 font-medium",onClick:async()=>{await re(Te.id),J.filter(Ie=>Ie.stato_invito==="invitato"&&String(Ie.id)!==String(Te.id)).length===0&&W(!1)},disabled:!!I[Te.id],children:I[Te.id]?"Annullo...":"Annulla"})]})]},Te.id)})})]})]})]})]}),e.jsx("div",{className:"flex justify-center px-2",children:e.jsxs("div",{className:"inline-flex items-center gap-1.5",children:[e.jsx("button",{onClick:()=>C("month"),className:`px-2.5 py-2 rounded-lg font-medium text-sm transition-colors ${R==="month"?"bg-gray-700 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"}`,children:"Mensile"}),e.jsx("button",{onClick:()=>C("week"),className:`px-2.5 py-2 rounded-lg font-medium text-sm transition-colors ${R==="week"?"bg-gray-700 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"}`,children:"Settimanale"}),e.jsx("button",{onClick:()=>C("day"),className:`px-2.5 py-2 rounded-lg font-medium text-sm transition-colors ${R==="day"?"bg-gray-700 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"}`,children:"Giornaliera"}),e.jsx("button",{onClick:()=>C("agenda"),className:`px-2.5 py-2 rounded-lg font-medium text-sm transition-colors ${R==="agenda"?"bg-green-600 text-white":"bg-green-700 text-white hover:bg-green-600"}`,children:"Agenda"})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700 text-center",children:[e.jsx(ut,{className:"h-7 w-7 mx-auto mb-2 text-blue-400"}),e.jsx("div",{className:"text-2xl font-bold text-white",children:Ke}),e.jsx("div",{className:"text-sm text-gray-400",children:"Eventi Assegnati"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700 text-center",children:[e.jsx(zt,{className:"h-7 w-7 mx-auto mb-2 text-purple-400"}),e.jsx("div",{className:"text-2xl font-bold text-white",children:Je}),e.jsx("div",{className:"text-sm text-gray-400",children:"Turni Assegnati"})]})]}),R==="month"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[e.jsxs("h2",{className:"text-lg font-semibold text-white",children:[yt[u.getMonth()]," ",u.getFullYear()]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Vista Mensile"})]}),e.jsxs("div",{className:"p-2 md:p-3",children:[e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["Lun","Mar","Mer","Gio","Ven","Sab","Dom"].map(Te=>e.jsx("div",{className:"p-1 md:p-2 text-center text-xs md:text-sm font-semibold text-gray-300",children:Te},Te))}),e.jsx("div",{className:"grid grid-cols-7 gap-1 md:gap-1.5",children:le(u).map((Te,H)=>{let ne="min-h-[70px] md:min-h-[85px] p-1 md:p-1.5 rounded-lg border cursor-pointer transition-colors relative ";return Te.isVacationDay?ne+="bg-red-600 text-white border-red-700 shadow-lg ":Te.isCurrentMonth?Te.isToday?ne+="bg-blue-600 text-white border-blue-700 shadow-lg ":ne+="bg-gray-750 hover:bg-gray-700 border-gray-700 ":ne+="bg-gray-800 text-gray-500 border-gray-700 ",e.jsxs("div",{className:ne,onClick:()=>Ue(ge(Te.date)),children:[e.jsx("div",{className:"text-xs md:text-sm font-semibold mb-1",children:Te.date.getDate()}),Te.isVacationDay?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("span",{className:"text-[8px] md:text-xs font-bold text-white uppercase tracking-wider",children:"FERIE"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-0.5",children:[Te.events.slice(0,window.innerWidth<768?1:2).map(fe=>e.jsx("div",{className:`text-[8px] md:text-[10px] leading-tight px-0.5 md:px-1 py-0.5 rounded text-white truncate font-medium ${fe.type==="warehouse"?fe.isAssigned?"bg-purple-500":"bg-purple-600 opacity-80":fe.type==="event"?fe.isAssigned?"bg-blue-500":"bg-blue-600 opacity-80":fe.type==="event_travel"?fe.isAssigned?"bg-green-500":"bg-green-600 opacity-80":fe.isAssigned?"bg-yellow-500":"bg-yellow-600 opacity-80"}`,title:`${fe.title} - ${fe.isAssigned?"Assegnato":"Non Assegnato"}`,children:fe.title},fe.id)),Te.events.length>(window.innerWidth<768?1:2)&&e.jsxs("div",{className:"text-[8px] md:text-[10px] text-gray-300 px-0.5 md:px-1 font-medium",children:["+",Te.events.length-(window.innerWidth<768?1:2)]})]}),e.jsx("div",{className:"absolute top-0.5 md:top-1 right-0.5 md:right-1",children:Te.isAvailable?e.jsx(ft,{className:"h-2.5 w-2.5 md:h-3.5 md:w-3.5 text-green-400"}):e.jsx(Zt,{className:"h-2.5 w-2.5 md:h-3.5 md:w-3.5 text-red-400"})})]})]},H)})})]})]})}),R==="agenda"&&e.jsx(e.Fragment,{children:qe()}),R==="week"&&e.jsx(e.Fragment,{children:Ce()}),R==="day"&&e.jsx(e.Fragment,{children:Ne()}),e.jsx(aa,{})]}),B&&p&&e.jsx(mc,{date:p,crewEvents:be(new Date(p+"T12:00:00")),onClose:()=>k(!1),loadColleaguesForEvent:_e})]})},mc=({date:n,crewEvents:l,onClose:c,loadColleaguesForEvent:u})=>{const{user:f}=Pt(),{showSuccess:x,showError:b}=us(),[v,S]=w.useState({}),[g,j]=w.useState({}),[p,M]=w.useState({});w.useEffect(()=>{let C=!0;return(async()=>{const E={},U={};await Promise.all(l.map(async q=>{if(q.type==="course"){U[q.id]=!1,E[q.id]=[],C&&j({...U});return}U[q.id]=!0,C&&j({...U});try{const J=await u(q),N=[f==null?void 0:f.id,f==null?void 0:f.sub,f==null?void 0:f.uid].filter(Boolean),_=J.filter(L=>!N.includes(L.id));E[q.id]=_}catch(J){console.error("Errore caricamento colleghi per evento:",J),E[q.id]=[]}finally{U[q.id]=!1,C&&j({...U})}})),C&&S(E)})(),()=>{C=!1}},[n,l]);const B=C=>new Date(C+"T12:00:00").toLocaleDateString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),k=async C=>{try{M(E=>({...E,[C]:!0}));const D=window.__confirmCourseHandler;typeof D=="function"?await D(C):b("Errore","Azione non disponibile")}catch(D){console.error("Errore callGlobalConfirm",D),b("Errore","Errore durante la conferma")}finally{M(D=>({...D,[C]:!1}))}},R=async C=>{try{M(E=>({...E,[C]:!0}));const D=window.__cancelCourseHandler;typeof D=="function"?await D(C):b("Errore","Azione non disponibile")}catch(D){console.error("Errore callGlobalCancel",D),b("Errore","Errore durante l'annullamento")}finally{M(D=>({...D,[C]:!1}))}};return e.jsxs("div",{className:"fixed inset-0 bg-gray-900 bg-opacity-95 z-[9999] flex items-center justify-center p-4",children:[e.jsx("style",{children:`
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
      `}),e.jsxs("div",{className:"w-full max-w-3xl max-h-[90vh] overflow-y-auto p-5 space-y-6 hide-scrollbar bg-gray-800 rounded-xl border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-white",children:["Eventi del ",B(n)]}),e.jsx("button",{onClick:c,className:"bg-gray-700 hover:bg-gray-600 p-2.5 rounded-lg transition-colors",children:e.jsx(jt,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"space-y-4",children:[l.length===0&&e.jsxs("div",{className:"text-center py-10 text-gray-400",children:[e.jsx(ut,{className:"h-12 w-12 mx-auto mb-3 text-gray-600"}),e.jsx("p",{className:"text-base",children:"Nessun evento in questa data"})]}),l.map(C=>{var q,J,N,_,L;const D=C.type==="course"?((q=C.raw)==null?void 0:q.corso)||((N=(J=C.raw)==null?void 0:J.assignment)==null?void 0:N.corso)||((_=C.raw)==null?void 0:_.corso):null,E=C.type==="course"&&((L=C.raw)==null?void 0:L.assignment)||null,U=(D==null?void 0:D.materiali)||(Array.isArray(E==null?void 0:E.materiali)?E.materiali:void 0);return e.jsxs("div",{className:"bg-gray-900 rounded-xl p-5 border border-gray-700",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx("h4",{className:"text-lg font-bold text-white",children:C.title}),e.jsx("span",{className:`inline-flex px-2.5 py-1 text-sm font-semibold rounded-full ${C.type==="warehouse"?"bg-purple-100 text-purple-800":C.type==="event"?"bg-blue-100 text-blue-800":C.type==="event_travel"?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"}`,children:C.type==="warehouse"?"Magazzino":C.type==="event"?"Evento":C.type==="event_travel"?"Trasferta":"Corso"})]}),e.jsxs("div",{className:"text-sm text-gray-300 space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{children:C.location})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ct,{className:"h-4 w-4 flex-shrink-0"}),e.jsxs("span",{children:[new Date(C.date).toLocaleDateString("it-IT"),C.endDate&&C.endDate!==C.date?` - ${new Date(C.endDate).toLocaleDateString("it-IT")}`:""]})]}),C.callTime&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ct,{className:"h-4 w-4 flex-shrink-0"}),e.jsxs("span",{children:["Convocazione: ",C.callTime]})]}),C.address&&e.jsx("div",{className:"text-sm text-gray-400 break-words mt-2",children:C.address}),C.description&&e.jsx("div",{className:"text-sm text-gray-400 break-words mt-2",children:C.description})]}),C.type==="course"&&e.jsxs("div",{className:"mt-4 p-4 bg-gray-800 rounded-lg border border-gray-700",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Titolo"}),e.jsx("div",{className:"text-base text-white font-semibold",children:(D==null?void 0:D.titolo)||C.title})]}),(D==null?void 0:D.descrizione)&&e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Descrizione"}),e.jsx("div",{className:"text-sm text-gray-200",children:D.descrizione})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Inizio"}),e.jsx("div",{className:"text-sm text-white font-medium",children:D!=null&&D.ora_inizio?D.ora_inizio.substring?D.ora_inizio.substring(0,5):D.ora_inizio:C.startTime})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Fine"}),e.jsx("div",{className:"text-sm text-white font-medium",children:D!=null&&D.ora_fine?D.ora_fine.substring?D.ora_fine.substring(0,5):D.ora_fine:C.endTime})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Luogo"}),e.jsx("div",{className:"text-sm text-white font-medium",children:(D==null?void 0:D.luogo)||C.location})]}),(D==null?void 0:D.istruttore)&&e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Istruttore"}),e.jsx("div",{className:"text-sm text-white font-medium",children:D.istruttore})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 items-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Categoria"}),e.jsx("div",{className:"text-sm text-white font-medium",children:(D==null?void 0:D.categoria)||"‚Äî"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Obbligatorio"}),e.jsx("div",{className:"text-sm text-white font-medium",children:D!=null&&D.obbligatorio?"S√¨":"No"})]})]}),U&&(Array.isArray(U)?U.length>0:!!U)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-xs text-gray-400",children:"Richieste / Materiali"}),Array.isArray(U)?e.jsx("ul",{className:"mt-2 list-disc pl-5 text-sm text-gray-200",children:U.map((I,K)=>e.jsx("li",{className:"break-words",children:String(I)},K))}):e.jsx("div",{className:"text-sm text-gray-200 mt-2",children:String(U)})]}),(D==null?void 0:D.note)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-xs text-gray-400",children:"Note del corso"}),e.jsx("div",{className:"text-sm text-gray-200 mt-1",children:D.note})]}),E&&e.jsxs("div",{className:"mt-4 flex items-center space-x-3",children:[E.stato_invito==="invitato"&&e.jsx("button",{className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded disabled:opacity-60",onClick:()=>k(E.id),disabled:!!p[E.id],children:p[E.id]?"Confermo...":"Conferma partecipazione"}),E.stato_invito==="confermato"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-green-300",children:"Partecipazione confermata"}),e.jsx("button",{className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded disabled:opacity-60",onClick:()=>R(E.id),disabled:!!p[E.id],children:p[E.id]?"Annullo...":"Annulla Partecipazione"})]}),E.stato_invito==="rifiutato"&&e.jsx("div",{className:"text-sm text-yellow-300",children:"Hai rifiutato la partecipazione"})]})]})]})}),e.jsx("div",{className:"mt-4",children:C.type!=="course"?g[C.id]?e.jsx("div",{className:"text-sm text-gray-400",children:"Caricamento partecipanti..."}):v[C.id]&&v[C.id].length>0?e.jsxs("div",{className:"mt-2 p-3 bg-gray-800 rounded-lg text-sm text-gray-200 max-h-48 overflow-y-auto hide-scrollbar",children:[e.jsx("strong",{className:"text-base",children:"Partecipanti confermati:"}),e.jsx("ul",{className:"mt-2 space-y-1 list-disc pl-5 text-sm",children:v[C.id].map(I=>e.jsx("li",{className:"break-words",children:I.name},I.id))})]}):e.jsx("div",{className:"mt-2 text-sm text-gray-400",children:"Nessun altro membro assegnato trovato."}):null})]},C.id)})]})]})]})};var st;(function(n){n[n.QR_CODE=0]="QR_CODE",n[n.AZTEC=1]="AZTEC",n[n.CODABAR=2]="CODABAR",n[n.CODE_39=3]="CODE_39",n[n.CODE_93=4]="CODE_93",n[n.CODE_128=5]="CODE_128",n[n.DATA_MATRIX=6]="DATA_MATRIX",n[n.MAXICODE=7]="MAXICODE",n[n.ITF=8]="ITF",n[n.EAN_13=9]="EAN_13",n[n.EAN_8=10]="EAN_8",n[n.PDF_417=11]="PDF_417",n[n.RSS_14=12]="RSS_14",n[n.RSS_EXPANDED=13]="RSS_EXPANDED",n[n.UPC_A=14]="UPC_A",n[n.UPC_E=15]="UPC_E",n[n.UPC_EAN_EXTENSION=16]="UPC_EAN_EXTENSION"})(st||(st={}));var Fn=new Map([[st.QR_CODE,"QR_CODE"],[st.AZTEC,"AZTEC"],[st.CODABAR,"CODABAR"],[st.CODE_39,"CODE_39"],[st.CODE_93,"CODE_93"],[st.CODE_128,"CODE_128"],[st.DATA_MATRIX,"DATA_MATRIX"],[st.MAXICODE,"MAXICODE"],[st.ITF,"ITF"],[st.EAN_13,"EAN_13"],[st.EAN_8,"EAN_8"],[st.PDF_417,"PDF_417"],[st.RSS_14,"RSS_14"],[st.RSS_EXPANDED,"RSS_EXPANDED"],[st.UPC_A,"UPC_A"],[st.UPC_E,"UPC_E"],[st.UPC_EAN_EXTENSION,"UPC_EAN_EXTENSION"]]),Un;(function(n){n[n.UNKNOWN=0]="UNKNOWN",n[n.URL=1]="URL"})(Un||(Un={}));function fc(n){return Object.values(st).includes(n)}var ur;(function(n){n[n.SCAN_TYPE_CAMERA=0]="SCAN_TYPE_CAMERA",n[n.SCAN_TYPE_FILE=1]="SCAN_TYPE_FILE"})(ur||(ur={}));var Ps=function(){function n(){}return n.GITHUB_PROJECT_URL="https://github.com/mebjas/html5-qrcode",n.SCAN_DEFAULT_FPS=2,n.DEFAULT_DISABLE_FLIP=!1,n.DEFAULT_REMEMBER_LAST_CAMERA_USED=!0,n.DEFAULT_SUPPORTED_SCAN_TYPE=[ur.SCAN_TYPE_CAMERA,ur.SCAN_TYPE_FILE],n}(),zi=function(){function n(l,c){this.format=l,this.formatName=c}return n.prototype.toString=function(){return this.formatName},n.create=function(l){if(!Fn.has(l))throw"".concat(l," not in html5QrcodeSupportedFormatsTextMap");return new n(l,Fn.get(l))},n}(),Vn=function(){function n(){}return n.createFromText=function(l){var c={text:l};return{decodedText:l,result:c}},n.createFromQrcodeResult=function(l){return{decodedText:l.text,result:l}},n}(),en;(function(n){n[n.UNKWOWN_ERROR=0]="UNKWOWN_ERROR",n[n.IMPLEMENTATION_ERROR=1]="IMPLEMENTATION_ERROR",n[n.NO_CODE_FOUND_ERROR=2]="NO_CODE_FOUND_ERROR"})(en||(en={}));var Oi=function(){function n(){}return n.createFrom=function(l){return{errorMessage:l,type:en.UNKWOWN_ERROR}},n}(),Ri=function(){function n(l){this.verbose=l}return n.prototype.log=function(l){this.verbose&&console.log(l)},n.prototype.warn=function(l){this.verbose&&console.warn(l)},n.prototype.logError=function(l,c){(this.verbose||c===!0)&&console.error(l)},n.prototype.logErrors=function(l){if(l.length===0)throw"Logger#logError called without arguments";this.verbose&&console.error(l)},n}();function Ys(n){return typeof n>"u"||n===null}function gc(n,l,c){return n>c?c:n<l?l:n}var Tr=function(){function n(){}return n.codeParseError=function(l){return"QR code parse error, error = ".concat(l)},n.errorGettingUserMedia=function(l){return"Error getting userMedia, error = ".concat(l)},n.onlyDeviceSupportedError=function(){return"The device doesn't support navigator.mediaDevices , only supported cameraIdOrConfig in this case is deviceId parameter (string)."},n.cameraStreamingNotSupported=function(){return"Camera streaming not supported by the browser."},n.unableToQuerySupportedDevices=function(){return"Unable to query supported devices, unknown error."},n.insecureContextCameraQueryError=function(){return"Camera access is only supported in secure context like https or localhost."},n.scannerPaused=function(){return"Scanner paused"},n}(),It=function(){function n(){}return n.scanningStatus=function(){return"Scanning"},n.idleStatus=function(){return"Idle"},n.errorStatus=function(){return"Error"},n.permissionStatus=function(){return"Permission"},n.noCameraFoundErrorStatus=function(){return"No Cameras"},n.lastMatch=function(l){return"Last Match: ".concat(l)},n.codeScannerTitle=function(){return"Code Scanner"},n.cameraPermissionTitle=function(){return"Request Camera Permissions"},n.cameraPermissionRequesting=function(){return"Requesting camera permissions..."},n.noCameraFound=function(){return"No camera found"},n.scanButtonStopScanningText=function(){return"Stop Scanning"},n.scanButtonStartScanningText=function(){return"Start Scanning"},n.torchOnButton=function(){return"Switch On Torch"},n.torchOffButton=function(){return"Switch Off Torch"},n.torchOnFailedMessage=function(){return"Failed to turn on torch"},n.torchOffFailedMessage=function(){return"Failed to turn off torch"},n.scanButtonScanningStarting=function(){return"Launching Camera..."},n.textIfCameraScanSelected=function(){return"Scan an Image File"},n.textIfFileScanSelected=function(){return"Scan using camera directly"},n.selectCamera=function(){return"Select Camera"},n.fileSelectionChooseImage=function(){return"Choose Image"},n.fileSelectionChooseAnother=function(){return"Choose Another"},n.fileSelectionNoImageSelected=function(){return"No image choosen"},n.anonymousCameraPrefix=function(){return"Anonymous Camera"},n.dragAndDropMessage=function(){return"Or drop an image to scan"},n.dragAndDropMessageOnlyImages=function(){return"Or drop an image to scan (other files not supported)"},n.zoom=function(){return"zoom"},n.loadingImage=function(){return"Loading image..."},n.cameraScanAltText=function(){return"Camera based scan"},n.fileScanAltText=function(){return"Fule based scan"},n}(),qn=function(){function n(){}return n.poweredBy=function(){return"Powered by "},n.reportIssues=function(){return"Report issues"},n}(),Li=function(){function n(){}return n.isMediaStreamConstraintsValid=function(l,c){if(typeof l!="object"){var u=typeof l;return c.logError("videoConstraints should be of type object, the "+"object passed is of type ".concat(u,"."),!0),!1}for(var f=["autoGainControl","channelCount","echoCancellation","latency","noiseSuppression","sampleRate","sampleSize","volume"],x=new Set(f),b=Object.keys(l),v=0,S=b;v<S.length;v++){var g=S[v];if(x.has(g))return c.logError("".concat(g," is not supported videoConstaints."),!0),!1}return!0},n}(),tn={exports:{}};(function(n,l){(function(c,u){u(l)})(Yr,function(c){function u(A){return A==null}var f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(A,t){A.__proto__=t}||function(A,t){for(var s in t)t.hasOwnProperty(s)&&(A[s]=t[s])};function x(A,t){f(A,t);function s(){this.constructor=A}A.prototype=t===null?Object.create(t):(s.prototype=t.prototype,new s)}function b(A,t){var s=Object.setPrototypeOf;s?s(A,t):A.__proto__=t}function v(A,t){t===void 0&&(t=A.constructor);var s=Error.captureStackTrace;s&&s(A,t)}var S=function(A){x(t,A);function t(s){var r=this.constructor,a=A.call(this,s)||this;return Object.defineProperty(a,"name",{value:r.name,enumerable:!1}),b(a,r.prototype),v(a),a}return t}(Error);class g extends S{constructor(t=void 0){super(t),this.message=t}getKind(){return this.constructor.kind}}g.kind="Exception";class j extends g{}j.kind="ArgumentException";class p extends g{}p.kind="IllegalArgumentException";class M{constructor(t){if(this.binarizer=t,t===null)throw new p("Binarizer must be non-null.")}getWidth(){return this.binarizer.getWidth()}getHeight(){return this.binarizer.getHeight()}getBlackRow(t,s){return this.binarizer.getBlackRow(t,s)}getBlackMatrix(){return(this.matrix===null||this.matrix===void 0)&&(this.matrix=this.binarizer.getBlackMatrix()),this.matrix}isCropSupported(){return this.binarizer.getLuminanceSource().isCropSupported()}crop(t,s,r,a){const i=this.binarizer.getLuminanceSource().crop(t,s,r,a);return new M(this.binarizer.createBinarizer(i))}isRotateSupported(){return this.binarizer.getLuminanceSource().isRotateSupported()}rotateCounterClockwise(){const t=this.binarizer.getLuminanceSource().rotateCounterClockwise();return new M(this.binarizer.createBinarizer(t))}rotateCounterClockwise45(){const t=this.binarizer.getLuminanceSource().rotateCounterClockwise45();return new M(this.binarizer.createBinarizer(t))}toString(){try{return this.getBlackMatrix().toString()}catch{return""}}}class B extends g{static getChecksumInstance(){return new B}}B.kind="ChecksumException";class k{constructor(t){this.source=t}getLuminanceSource(){return this.source}getWidth(){return this.source.getWidth()}getHeight(){return this.source.getHeight()}}class R{static arraycopy(t,s,r,a,i){for(;i--;)r[a++]=t[s++]}static currentTimeMillis(){return Date.now()}}class C extends g{}C.kind="IndexOutOfBoundsException";class D extends C{constructor(t=void 0,s=void 0){super(s),this.index=t,this.message=s}}D.kind="ArrayIndexOutOfBoundsException";class E{static fill(t,s){for(let r=0,a=t.length;r<a;r++)t[r]=s}static fillWithin(t,s,r,a){E.rangeCheck(t.length,s,r);for(let i=s;i<r;i++)t[i]=a}static rangeCheck(t,s,r){if(s>r)throw new p("fromIndex("+s+") > toIndex("+r+")");if(s<0)throw new D(s);if(r>t)throw new D(r)}static asList(...t){return t}static create(t,s,r){return Array.from({length:t}).map(i=>Array.from({length:s}).fill(r))}static createInt32Array(t,s,r){return Array.from({length:t}).map(i=>Int32Array.from({length:s}).fill(r))}static equals(t,s){if(!t||!s||!t.length||!s.length||t.length!==s.length)return!1;for(let r=0,a=t.length;r<a;r++)if(t[r]!==s[r])return!1;return!0}static hashCode(t){if(t===null)return 0;let s=1;for(const r of t)s=31*s+r;return s}static fillUint8Array(t,s){for(let r=0;r!==t.length;r++)t[r]=s}static copyOf(t,s){return t.slice(0,s)}static copyOfUint8Array(t,s){if(t.length<=s){const r=new Uint8Array(s);return r.set(t),r}return t.slice(0,s)}static copyOfRange(t,s,r){const a=r-s,i=new Int32Array(a);return R.arraycopy(t,s,i,0,a),i}static binarySearch(t,s,r){r===void 0&&(r=E.numberComparator);let a=0,i=t.length-1;for(;a<=i;){const o=i+a>>1,d=r(s,t[o]);if(d>0)a=o+1;else if(d<0)i=o-1;else return o}return-a-1}static numberComparator(t,s){return t-s}}class U{static numberOfTrailingZeros(t){let s;if(t===0)return 32;let r=31;return s=t<<16,s!==0&&(r-=16,t=s),s=t<<8,s!==0&&(r-=8,t=s),s=t<<4,s!==0&&(r-=4,t=s),s=t<<2,s!==0&&(r-=2,t=s),r-(t<<1>>>31)}static numberOfLeadingZeros(t){if(t===0)return 32;let s=1;return t>>>16||(s+=16,t<<=16),t>>>24||(s+=8,t<<=8),t>>>28||(s+=4,t<<=4),t>>>30||(s+=2,t<<=2),s-=t>>>31,s}static toHexString(t){return t.toString(16)}static toBinaryString(t){return String(parseInt(String(t),2))}static bitCount(t){return t=t-(t>>>1&1431655765),t=(t&858993459)+(t>>>2&858993459),t=t+(t>>>4)&252645135,t=t+(t>>>8),t=t+(t>>>16),t&63}static truncDivision(t,s){return Math.trunc(t/s)}static parseInt(t,s=void 0){return parseInt(t,s)}}U.MIN_VALUE_32_BITS=-2147483648,U.MAX_VALUE=Number.MAX_SAFE_INTEGER;class q{constructor(t,s){t===void 0?(this.size=0,this.bits=new Int32Array(1)):(this.size=t,s==null?this.bits=q.makeArray(t):this.bits=s)}getSize(){return this.size}getSizeInBytes(){return Math.floor((this.size+7)/8)}ensureCapacity(t){if(t>this.bits.length*32){const s=q.makeArray(t);R.arraycopy(this.bits,0,s,0,this.bits.length),this.bits=s}}get(t){return(this.bits[Math.floor(t/32)]&1<<(t&31))!==0}set(t){this.bits[Math.floor(t/32)]|=1<<(t&31)}flip(t){this.bits[Math.floor(t/32)]^=1<<(t&31)}getNextSet(t){const s=this.size;if(t>=s)return s;const r=this.bits;let a=Math.floor(t/32),i=r[a];i&=~((1<<(t&31))-1);const o=r.length;for(;i===0;){if(++a===o)return s;i=r[a]}const d=a*32+U.numberOfTrailingZeros(i);return d>s?s:d}getNextUnset(t){const s=this.size;if(t>=s)return s;const r=this.bits;let a=Math.floor(t/32),i=~r[a];i&=~((1<<(t&31))-1);const o=r.length;for(;i===0;){if(++a===o)return s;i=~r[a]}const d=a*32+U.numberOfTrailingZeros(i);return d>s?s:d}setBulk(t,s){this.bits[Math.floor(t/32)]=s}setRange(t,s){if(s<t||t<0||s>this.size)throw new p;if(s===t)return;s--;const r=Math.floor(t/32),a=Math.floor(s/32),i=this.bits;for(let o=r;o<=a;o++){const d=o>r?0:t&31,m=(2<<(o<a?31:s&31))-(1<<d);i[o]|=m}}clear(){const t=this.bits.length,s=this.bits;for(let r=0;r<t;r++)s[r]=0}isRange(t,s,r){if(s<t||t<0||s>this.size)throw new p;if(s===t)return!0;s--;const a=Math.floor(t/32),i=Math.floor(s/32),o=this.bits;for(let d=a;d<=i;d++){const h=d>a?0:t&31,y=(2<<(d<i?31:s&31))-(1<<h)&4294967295;if((o[d]&y)!==(r?y:0))return!1}return!0}appendBit(t){this.ensureCapacity(this.size+1),t&&(this.bits[Math.floor(this.size/32)]|=1<<(this.size&31)),this.size++}appendBits(t,s){if(s<0||s>32)throw new p("Num bits must be between 0 and 32");this.ensureCapacity(this.size+s);for(let r=s;r>0;r--)this.appendBit((t>>r-1&1)===1)}appendBitArray(t){const s=t.size;this.ensureCapacity(this.size+s);for(let r=0;r<s;r++)this.appendBit(t.get(r))}xor(t){if(this.size!==t.size)throw new p("Sizes don't match");const s=this.bits;for(let r=0,a=s.length;r<a;r++)s[r]^=t.bits[r]}toBytes(t,s,r,a){for(let i=0;i<a;i++){let o=0;for(let d=0;d<8;d++)this.get(t)&&(o|=1<<7-d),t++;s[r+i]=o}}getBitArray(){return this.bits}reverse(){const t=new Int32Array(this.bits.length),s=Math.floor((this.size-1)/32),r=s+1,a=this.bits;for(let i=0;i<r;i++){let o=a[i];o=o>>1&1431655765|(o&1431655765)<<1,o=o>>2&858993459|(o&858993459)<<2,o=o>>4&252645135|(o&252645135)<<4,o=o>>8&16711935|(o&16711935)<<8,o=o>>16&65535|(o&65535)<<16,t[s-i]=o}if(this.size!==r*32){const i=r*32-this.size;let o=t[0]>>>i;for(let d=1;d<r;d++){const h=t[d];o|=h<<32-i,t[d-1]=o,o=h>>>i}t[r-1]=o}this.bits=t}static makeArray(t){return new Int32Array(Math.floor((t+31)/32))}equals(t){if(!(t instanceof q))return!1;const s=t;return this.size===s.size&&E.equals(this.bits,s.bits)}hashCode(){return 31*this.size+E.hashCode(this.bits)}toString(){let t="";for(let s=0,r=this.size;s<r;s++)s&7||(t+=" "),t+=this.get(s)?"X":".";return t}clone(){return new q(this.size,this.bits.slice())}}var J;(function(A){A[A.OTHER=0]="OTHER",A[A.PURE_BARCODE=1]="PURE_BARCODE",A[A.POSSIBLE_FORMATS=2]="POSSIBLE_FORMATS",A[A.TRY_HARDER=3]="TRY_HARDER",A[A.CHARACTER_SET=4]="CHARACTER_SET",A[A.ALLOWED_LENGTHS=5]="ALLOWED_LENGTHS",A[A.ASSUME_CODE_39_CHECK_DIGIT=6]="ASSUME_CODE_39_CHECK_DIGIT",A[A.ASSUME_GS1=7]="ASSUME_GS1",A[A.RETURN_CODABAR_START_END=8]="RETURN_CODABAR_START_END",A[A.NEED_RESULT_POINT_CALLBACK=9]="NEED_RESULT_POINT_CALLBACK",A[A.ALLOWED_EAN_EXTENSIONS=10]="ALLOWED_EAN_EXTENSIONS"})(J||(J={}));var N=J;class _ extends g{static getFormatInstance(){return new _}}_.kind="FormatException";var L;(function(A){A[A.Cp437=0]="Cp437",A[A.ISO8859_1=1]="ISO8859_1",A[A.ISO8859_2=2]="ISO8859_2",A[A.ISO8859_3=3]="ISO8859_3",A[A.ISO8859_4=4]="ISO8859_4",A[A.ISO8859_5=5]="ISO8859_5",A[A.ISO8859_6=6]="ISO8859_6",A[A.ISO8859_7=7]="ISO8859_7",A[A.ISO8859_8=8]="ISO8859_8",A[A.ISO8859_9=9]="ISO8859_9",A[A.ISO8859_10=10]="ISO8859_10",A[A.ISO8859_11=11]="ISO8859_11",A[A.ISO8859_13=12]="ISO8859_13",A[A.ISO8859_14=13]="ISO8859_14",A[A.ISO8859_15=14]="ISO8859_15",A[A.ISO8859_16=15]="ISO8859_16",A[A.SJIS=16]="SJIS",A[A.Cp1250=17]="Cp1250",A[A.Cp1251=18]="Cp1251",A[A.Cp1252=19]="Cp1252",A[A.Cp1256=20]="Cp1256",A[A.UnicodeBigUnmarked=21]="UnicodeBigUnmarked",A[A.UTF8=22]="UTF8",A[A.ASCII=23]="ASCII",A[A.Big5=24]="Big5",A[A.GB18030=25]="GB18030",A[A.EUC_KR=26]="EUC_KR"})(L||(L={}));class I{constructor(t,s,r,...a){this.valueIdentifier=t,this.name=r,typeof s=="number"?this.values=Int32Array.from([s]):this.values=s,this.otherEncodingNames=a,I.VALUE_IDENTIFIER_TO_ECI.set(t,this),I.NAME_TO_ECI.set(r,this);const i=this.values;for(let o=0,d=i.length;o!==d;o++){const h=i[o];I.VALUES_TO_ECI.set(h,this)}for(const o of a)I.NAME_TO_ECI.set(o,this)}getValueIdentifier(){return this.valueIdentifier}getName(){return this.name}getValue(){return this.values[0]}static getCharacterSetECIByValue(t){if(t<0||t>=900)throw new _("incorect value");const s=I.VALUES_TO_ECI.get(t);if(s===void 0)throw new _("incorect value");return s}static getCharacterSetECIByName(t){const s=I.NAME_TO_ECI.get(t);if(s===void 0)throw new _("incorect value");return s}equals(t){if(!(t instanceof I))return!1;const s=t;return this.getName()===s.getName()}}I.VALUE_IDENTIFIER_TO_ECI=new Map,I.VALUES_TO_ECI=new Map,I.NAME_TO_ECI=new Map,I.Cp437=new I(L.Cp437,Int32Array.from([0,2]),"Cp437"),I.ISO8859_1=new I(L.ISO8859_1,Int32Array.from([1,3]),"ISO-8859-1","ISO88591","ISO8859_1"),I.ISO8859_2=new I(L.ISO8859_2,4,"ISO-8859-2","ISO88592","ISO8859_2"),I.ISO8859_3=new I(L.ISO8859_3,5,"ISO-8859-3","ISO88593","ISO8859_3"),I.ISO8859_4=new I(L.ISO8859_4,6,"ISO-8859-4","ISO88594","ISO8859_4"),I.ISO8859_5=new I(L.ISO8859_5,7,"ISO-8859-5","ISO88595","ISO8859_5"),I.ISO8859_6=new I(L.ISO8859_6,8,"ISO-8859-6","ISO88596","ISO8859_6"),I.ISO8859_7=new I(L.ISO8859_7,9,"ISO-8859-7","ISO88597","ISO8859_7"),I.ISO8859_8=new I(L.ISO8859_8,10,"ISO-8859-8","ISO88598","ISO8859_8"),I.ISO8859_9=new I(L.ISO8859_9,11,"ISO-8859-9","ISO88599","ISO8859_9"),I.ISO8859_10=new I(L.ISO8859_10,12,"ISO-8859-10","ISO885910","ISO8859_10"),I.ISO8859_11=new I(L.ISO8859_11,13,"ISO-8859-11","ISO885911","ISO8859_11"),I.ISO8859_13=new I(L.ISO8859_13,15,"ISO-8859-13","ISO885913","ISO8859_13"),I.ISO8859_14=new I(L.ISO8859_14,16,"ISO-8859-14","ISO885914","ISO8859_14"),I.ISO8859_15=new I(L.ISO8859_15,17,"ISO-8859-15","ISO885915","ISO8859_15"),I.ISO8859_16=new I(L.ISO8859_16,18,"ISO-8859-16","ISO885916","ISO8859_16"),I.SJIS=new I(L.SJIS,20,"SJIS","Shift_JIS"),I.Cp1250=new I(L.Cp1250,21,"Cp1250","windows-1250"),I.Cp1251=new I(L.Cp1251,22,"Cp1251","windows-1251"),I.Cp1252=new I(L.Cp1252,23,"Cp1252","windows-1252"),I.Cp1256=new I(L.Cp1256,24,"Cp1256","windows-1256"),I.UnicodeBigUnmarked=new I(L.UnicodeBigUnmarked,25,"UnicodeBigUnmarked","UTF-16BE","UnicodeBig"),I.UTF8=new I(L.UTF8,26,"UTF8","UTF-8"),I.ASCII=new I(L.ASCII,Int32Array.from([27,170]),"ASCII","US-ASCII"),I.Big5=new I(L.Big5,28,"Big5"),I.GB18030=new I(L.GB18030,29,"GB18030","GB2312","EUC_CN","GBK"),I.EUC_KR=new I(L.EUC_KR,30,"EUC_KR","EUC-KR");class K extends g{}K.kind="UnsupportedOperationException";class O{static decode(t,s){const r=this.encodingName(s);return this.customDecoder?this.customDecoder(t,r):typeof TextDecoder>"u"||this.shouldDecodeOnFallback(r)?this.decodeFallback(t,r):new TextDecoder(r).decode(t)}static shouldDecodeOnFallback(t){return!O.isBrowser()&&t==="ISO-8859-1"}static encode(t,s){const r=this.encodingName(s);return this.customEncoder?this.customEncoder(t,r):typeof TextEncoder>"u"?this.encodeFallback(t):new TextEncoder().encode(t)}static isBrowser(){return typeof window<"u"&&{}.toString.call(window)==="[object Window]"}static encodingName(t){return typeof t=="string"?t:t.getName()}static encodingCharacterSet(t){return t instanceof I?t:I.getCharacterSetECIByName(t)}static decodeFallback(t,s){const r=this.encodingCharacterSet(s);if(O.isDecodeFallbackSupported(r)){let a="";for(let i=0,o=t.length;i<o;i++){let d=t[i].toString(16);d.length<2&&(d="0"+d),a+="%"+d}return decodeURIComponent(a)}if(r.equals(I.UnicodeBigUnmarked))return String.fromCharCode.apply(null,new Uint16Array(t.buffer));throw new K(`Encoding ${this.encodingName(s)} not supported by fallback.`)}static isDecodeFallbackSupported(t){return t.equals(I.UTF8)||t.equals(I.ISO8859_1)||t.equals(I.ASCII)}static encodeFallback(t){const r=btoa(unescape(encodeURIComponent(t))).split(""),a=[];for(let i=0;i<r.length;i++)a.push(r[i].charCodeAt(0));return new Uint8Array(a)}}class W{static castAsNonUtf8Char(t,s=null){const r=s?s.getName():this.ISO88591;return O.decode(new Uint8Array([t]),r)}static guessEncoding(t,s){if(s!=null&&s.get(N.CHARACTER_SET)!==void 0)return s.get(N.CHARACTER_SET).toString();const r=t.length;let a=!0,i=!0,o=!0,d=0,h=0,m=0,y=0,T=0,z=0,Y=0,ce=0,ue=0,Se=0,ze=0;const We=t.length>3&&t[0]===239&&t[1]===187&&t[2]===191;for(let $e=0;$e<r&&(a||i||o);$e++){const Ve=t[$e]&255;o&&(d>0?Ve&128?d--:o=!1:Ve&128&&(Ve&64?(d++,Ve&32?(d++,Ve&16?(d++,Ve&8?o=!1:y++):m++):h++):o=!1)),a&&(Ve>127&&Ve<160?a=!1:Ve>159&&(Ve<192||Ve===215||Ve===247)&&ze++),i&&(T>0?Ve<64||Ve===127||Ve>252?i=!1:T--:Ve===128||Ve===160||Ve>239?i=!1:Ve>160&&Ve<224?(z++,ce=0,Y++,Y>ue&&(ue=Y)):Ve>127?(T++,Y=0,ce++,ce>Se&&(Se=ce)):(Y=0,ce=0))}return o&&d>0&&(o=!1),i&&T>0&&(i=!1),o&&(We||h+m+y>0)?W.UTF8:i&&(W.ASSUME_SHIFT_JIS||ue>=3||Se>=3)?W.SHIFT_JIS:a&&i?ue===2&&z===2||ze*10>=r?W.SHIFT_JIS:W.ISO88591:a?W.ISO88591:i?W.SHIFT_JIS:o?W.UTF8:W.PLATFORM_DEFAULT_ENCODING}static format(t,...s){let r=-1;function a(o,d,h,m,y,T){if(o==="%%")return"%";if(s[++r]===void 0)return;o=m?parseInt(m.substr(1)):void 0;let z=y?parseInt(y.substr(1)):void 0,Y;switch(T){case"s":Y=s[r];break;case"c":Y=s[r][0];break;case"f":Y=parseFloat(s[r]).toFixed(o);break;case"p":Y=parseFloat(s[r]).toPrecision(o);break;case"e":Y=parseFloat(s[r]).toExponential(o);break;case"x":Y=parseInt(s[r]).toString(z||16);break;case"d":Y=parseFloat(parseInt(s[r],z||10).toPrecision(o)).toFixed(0);break}Y=typeof Y=="object"?JSON.stringify(Y):(+Y).toString(z);let ce=parseInt(h),ue=h&&h[0]+""=="0"?"0":" ";for(;Y.length<ce;)Y=d!==void 0?Y+ue:ue+Y;return Y}let i=/%(-)?(0?[0-9]+)?([.][0-9]+)?([#][0-9]+)?([scfpexd%])/g;return t.replace(i,a)}static getBytes(t,s){return O.encode(t,s)}static getCharCode(t,s=0){return t.charCodeAt(s)}static getCharAt(t){return String.fromCharCode(t)}}W.SHIFT_JIS=I.SJIS.getName(),W.GB2312="GB2312",W.ISO88591=I.ISO8859_1.getName(),W.EUC_JP="EUC_JP",W.UTF8=I.UTF8.getName(),W.PLATFORM_DEFAULT_ENCODING=W.UTF8,W.ASSUME_SHIFT_JIS=!1;class se{constructor(t=""){this.value=t}enableDecoding(t){return this.encoding=t,this}append(t){return typeof t=="string"?this.value+=t.toString():this.encoding?this.value+=W.castAsNonUtf8Char(t,this.encoding):this.value+=String.fromCharCode(t),this}appendChars(t,s,r){for(let a=s;s<s+r;a++)this.append(t[a]);return this}length(){return this.value.length}charAt(t){return this.value.charAt(t)}deleteCharAt(t){this.value=this.value.substr(0,t)+this.value.substring(t+1)}setCharAt(t,s){this.value=this.value.substr(0,t)+s+this.value.substr(t+1)}substring(t,s){return this.value.substring(t,s)}setLengthToZero(){this.value=""}toString(){return this.value}insert(t,s){this.value=this.value.substr(0,t)+s+this.value.substr(t+s.length)}}class G{constructor(t,s,r,a){if(this.width=t,this.height=s,this.rowSize=r,this.bits=a,s==null&&(s=t),this.height=s,t<1||s<1)throw new p("Both dimensions must be greater than 0");r==null&&(r=Math.floor((t+31)/32)),this.rowSize=r,a==null&&(this.bits=new Int32Array(this.rowSize*this.height))}static parseFromBooleanArray(t){const s=t.length,r=t[0].length,a=new G(r,s);for(let i=0;i<s;i++){const o=t[i];for(let d=0;d<r;d++)o[d]&&a.set(d,i)}return a}static parseFromString(t,s,r){if(t===null)throw new p("stringRepresentation cannot be null");const a=new Array(t.length);let i=0,o=0,d=-1,h=0,m=0;for(;m<t.length;)if(t.charAt(m)===`
`||t.charAt(m)==="\r"){if(i>o){if(d===-1)d=i-o;else if(i-o!==d)throw new p("row lengths do not match");o=i,h++}m++}else if(t.substring(m,m+s.length)===s)m+=s.length,a[i]=!0,i++;else if(t.substring(m,m+r.length)===r)m+=r.length,a[i]=!1,i++;else throw new p("illegal character encountered: "+t.substring(m));if(i>o){if(d===-1)d=i-o;else if(i-o!==d)throw new p("row lengths do not match");h++}const y=new G(d,h);for(let T=0;T<i;T++)a[T]&&y.set(Math.floor(T%d),Math.floor(T/d));return y}get(t,s){const r=s*this.rowSize+Math.floor(t/32);return(this.bits[r]>>>(t&31)&1)!==0}set(t,s){const r=s*this.rowSize+Math.floor(t/32);this.bits[r]|=1<<(t&31)&4294967295}unset(t,s){const r=s*this.rowSize+Math.floor(t/32);this.bits[r]&=~(1<<(t&31)&4294967295)}flip(t,s){const r=s*this.rowSize+Math.floor(t/32);this.bits[r]^=1<<(t&31)&4294967295}xor(t){if(this.width!==t.getWidth()||this.height!==t.getHeight()||this.rowSize!==t.getRowSize())throw new p("input matrix dimensions do not match");const s=new q(Math.floor(this.width/32)+1),r=this.rowSize,a=this.bits;for(let i=0,o=this.height;i<o;i++){const d=i*r,h=t.getRow(i,s).getBitArray();for(let m=0;m<r;m++)a[d+m]^=h[m]}}clear(){const t=this.bits,s=t.length;for(let r=0;r<s;r++)t[r]=0}setRegion(t,s,r,a){if(s<0||t<0)throw new p("Left and top must be nonnegative");if(a<1||r<1)throw new p("Height and width must be at least 1");const i=t+r,o=s+a;if(o>this.height||i>this.width)throw new p("The region must fit inside the matrix");const d=this.rowSize,h=this.bits;for(let m=s;m<o;m++){const y=m*d;for(let T=t;T<i;T++)h[y+Math.floor(T/32)]|=1<<(T&31)&4294967295}}getRow(t,s){s==null||s.getSize()<this.width?s=new q(this.width):s.clear();const r=this.rowSize,a=this.bits,i=t*r;for(let o=0;o<r;o++)s.setBulk(o*32,a[i+o]);return s}setRow(t,s){R.arraycopy(s.getBitArray(),0,this.bits,t*this.rowSize,this.rowSize)}rotate180(){const t=this.getWidth(),s=this.getHeight();let r=new q(t),a=new q(t);for(let i=0,o=Math.floor((s+1)/2);i<o;i++)r=this.getRow(i,r),a=this.getRow(s-1-i,a),r.reverse(),a.reverse(),this.setRow(i,a),this.setRow(s-1-i,r)}getEnclosingRectangle(){const t=this.width,s=this.height,r=this.rowSize,a=this.bits;let i=t,o=s,d=-1,h=-1;for(let m=0;m<s;m++)for(let y=0;y<r;y++){const T=a[m*r+y];if(T!==0){if(m<o&&(o=m),m>h&&(h=m),y*32<i){let z=0;for(;!(T<<31-z&4294967295);)z++;y*32+z<i&&(i=y*32+z)}if(y*32+31>d){let z=31;for(;!(T>>>z);)z--;y*32+z>d&&(d=y*32+z)}}}return d<i||h<o?null:Int32Array.from([i,o,d-i+1,h-o+1])}getTopLeftOnBit(){const t=this.rowSize,s=this.bits;let r=0;for(;r<s.length&&s[r]===0;)r++;if(r===s.length)return null;const a=r/t;let i=r%t*32;const o=s[r];let d=0;for(;!(o<<31-d&4294967295);)d++;return i+=d,Int32Array.from([i,a])}getBottomRightOnBit(){const t=this.rowSize,s=this.bits;let r=s.length-1;for(;r>=0&&s[r]===0;)r--;if(r<0)return null;const a=Math.floor(r/t);let i=Math.floor(r%t)*32;const o=s[r];let d=31;for(;!(o>>>d);)d--;return i+=d,Int32Array.from([i,a])}getWidth(){return this.width}getHeight(){return this.height}getRowSize(){return this.rowSize}equals(t){if(!(t instanceof G))return!1;const s=t;return this.width===s.width&&this.height===s.height&&this.rowSize===s.rowSize&&E.equals(this.bits,s.bits)}hashCode(){let t=this.width;return t=31*t+this.width,t=31*t+this.height,t=31*t+this.rowSize,t=31*t+E.hashCode(this.bits),t}toString(t="X ",s="  ",r=`
`){return this.buildToString(t,s,r)}buildToString(t,s,r){let a=new se;for(let i=0,o=this.height;i<o;i++){for(let d=0,h=this.width;d<h;d++)a.append(this.get(d,i)?t:s);a.append(r)}return a.toString()}clone(){return new G(this.width,this.height,this.rowSize,this.bits.slice())}}class $ extends g{static getNotFoundInstance(){return new $}}$.kind="NotFoundException";class F extends k{constructor(t){super(t),this.luminances=F.EMPTY,this.buckets=new Int32Array(F.LUMINANCE_BUCKETS)}getBlackRow(t,s){const r=this.getLuminanceSource(),a=r.getWidth();s==null||s.getSize()<a?s=new q(a):s.clear(),this.initArrays(a);const i=r.getRow(t,this.luminances),o=this.buckets;for(let h=0;h<a;h++)o[(i[h]&255)>>F.LUMINANCE_SHIFT]++;const d=F.estimateBlackPoint(o);if(a<3)for(let h=0;h<a;h++)(i[h]&255)<d&&s.set(h);else{let h=i[0]&255,m=i[1]&255;for(let y=1;y<a-1;y++){const T=i[y+1]&255;(m*4-h-T)/2<d&&s.set(y),h=m,m=T}}return s}getBlackMatrix(){const t=this.getLuminanceSource(),s=t.getWidth(),r=t.getHeight(),a=new G(s,r);this.initArrays(s);const i=this.buckets;for(let h=1;h<5;h++){const m=Math.floor(r*h/5),y=t.getRow(m,this.luminances),T=Math.floor(s*4/5);for(let z=Math.floor(s/5);z<T;z++){const Y=y[z]&255;i[Y>>F.LUMINANCE_SHIFT]++}}const o=F.estimateBlackPoint(i),d=t.getMatrix();for(let h=0;h<r;h++){const m=h*s;for(let y=0;y<s;y++)(d[m+y]&255)<o&&a.set(y,h)}return a}createBinarizer(t){return new F(t)}initArrays(t){this.luminances.length<t&&(this.luminances=new Uint8ClampedArray(t));const s=this.buckets;for(let r=0;r<F.LUMINANCE_BUCKETS;r++)s[r]=0}static estimateBlackPoint(t){const s=t.length;let r=0,a=0,i=0;for(let y=0;y<s;y++)t[y]>i&&(a=y,i=t[y]),t[y]>r&&(r=t[y]);let o=0,d=0;for(let y=0;y<s;y++){const T=y-a,z=t[y]*T*T;z>d&&(o=y,d=z)}if(a>o){const y=a;a=o,o=y}if(o-a<=s/16)throw new $;let h=o-1,m=-1;for(let y=o-1;y>a;y--){const T=y-a,z=T*T*(o-y)*(r-t[y]);z>m&&(h=y,m=z)}return h<<F.LUMINANCE_SHIFT}}F.LUMINANCE_BITS=5,F.LUMINANCE_SHIFT=8-F.LUMINANCE_BITS,F.LUMINANCE_BUCKETS=1<<F.LUMINANCE_BITS,F.EMPTY=Uint8ClampedArray.from([0]);class re extends F{constructor(t){super(t),this.matrix=null}getBlackMatrix(){if(this.matrix!==null)return this.matrix;const t=this.getLuminanceSource(),s=t.getWidth(),r=t.getHeight();if(s>=re.MINIMUM_DIMENSION&&r>=re.MINIMUM_DIMENSION){const a=t.getMatrix();let i=s>>re.BLOCK_SIZE_POWER;s&re.BLOCK_SIZE_MASK&&i++;let o=r>>re.BLOCK_SIZE_POWER;r&re.BLOCK_SIZE_MASK&&o++;const d=re.calculateBlackPoints(a,i,o,s,r),h=new G(s,r);re.calculateThresholdForBlock(a,i,o,s,r,d,h),this.matrix=h}else this.matrix=super.getBlackMatrix();return this.matrix}createBinarizer(t){return new re(t)}static calculateThresholdForBlock(t,s,r,a,i,o,d){const h=i-re.BLOCK_SIZE,m=a-re.BLOCK_SIZE;for(let y=0;y<r;y++){let T=y<<re.BLOCK_SIZE_POWER;T>h&&(T=h);const z=re.cap(y,2,r-3);for(let Y=0;Y<s;Y++){let ce=Y<<re.BLOCK_SIZE_POWER;ce>m&&(ce=m);const ue=re.cap(Y,2,s-3);let Se=0;for(let We=-2;We<=2;We++){const $e=o[z+We];Se+=$e[ue-2]+$e[ue-1]+$e[ue]+$e[ue+1]+$e[ue+2]}const ze=Se/25;re.thresholdBlock(t,ce,T,ze,a,d)}}}static cap(t,s,r){return t<s?s:t>r?r:t}static thresholdBlock(t,s,r,a,i,o){for(let d=0,h=r*i+s;d<re.BLOCK_SIZE;d++,h+=i)for(let m=0;m<re.BLOCK_SIZE;m++)(t[h+m]&255)<=a&&o.set(s+m,r+d)}static calculateBlackPoints(t,s,r,a,i){const o=i-re.BLOCK_SIZE,d=a-re.BLOCK_SIZE,h=new Array(r);for(let m=0;m<r;m++){h[m]=new Int32Array(s);let y=m<<re.BLOCK_SIZE_POWER;y>o&&(y=o);for(let T=0;T<s;T++){let z=T<<re.BLOCK_SIZE_POWER;z>d&&(z=d);let Y=0,ce=255,ue=0;for(let ze=0,We=y*a+z;ze<re.BLOCK_SIZE;ze++,We+=a){for(let $e=0;$e<re.BLOCK_SIZE;$e++){const Ve=t[We+$e]&255;Y+=Ve,Ve<ce&&(ce=Ve),Ve>ue&&(ue=Ve)}if(ue-ce>re.MIN_DYNAMIC_RANGE)for(ze++,We+=a;ze<re.BLOCK_SIZE;ze++,We+=a)for(let $e=0;$e<re.BLOCK_SIZE;$e++)Y+=t[We+$e]&255}let Se=Y>>re.BLOCK_SIZE_POWER*2;if(ue-ce<=re.MIN_DYNAMIC_RANGE&&(Se=ce/2,m>0&&T>0)){const ze=(h[m-1][T]+2*h[m][T-1]+h[m-1][T-1])/4;ce<ze&&(Se=ze)}h[m][T]=Se}}return h}}re.BLOCK_SIZE_POWER=3,re.BLOCK_SIZE=1<<re.BLOCK_SIZE_POWER,re.BLOCK_SIZE_MASK=re.BLOCK_SIZE-1,re.MINIMUM_DIMENSION=re.BLOCK_SIZE*5,re.MIN_DYNAMIC_RANGE=24;class _e{constructor(t,s){this.width=t,this.height=s}getWidth(){return this.width}getHeight(){return this.height}isCropSupported(){return!1}crop(t,s,r,a){throw new K("This luminance source does not support cropping.")}isRotateSupported(){return!1}rotateCounterClockwise(){throw new K("This luminance source does not support rotation by 90 degrees.")}rotateCounterClockwise45(){throw new K("This luminance source does not support rotation by 45 degrees.")}toString(){const t=new Uint8ClampedArray(this.width);let s=new se;for(let r=0;r<this.height;r++){const a=this.getRow(r,t);for(let i=0;i<this.width;i++){const o=a[i]&255;let d;o<64?d="#":o<128?d="+":o<192?d=".":d=" ",s.append(d)}s.append(`
`)}return s.toString()}}class ge extends _e{constructor(t){super(t.getWidth(),t.getHeight()),this.delegate=t}getRow(t,s){const r=this.delegate.getRow(t,s),a=this.getWidth();for(let i=0;i<a;i++)r[i]=255-(r[i]&255);return r}getMatrix(){const t=this.delegate.getMatrix(),s=this.getWidth()*this.getHeight(),r=new Uint8ClampedArray(s);for(let a=0;a<s;a++)r[a]=255-(t[a]&255);return r}isCropSupported(){return this.delegate.isCropSupported()}crop(t,s,r,a){return new ge(this.delegate.crop(t,s,r,a))}isRotateSupported(){return this.delegate.isRotateSupported()}invert(){return this.delegate}rotateCounterClockwise(){return new ge(this.delegate.rotateCounterClockwise())}rotateCounterClockwise45(){return new ge(this.delegate.rotateCounterClockwise45())}}class X extends _e{constructor(t){super(t.width,t.height),this.canvas=t,this.tempCanvasElement=null,this.buffer=X.makeBufferFromCanvasImageData(t)}static makeBufferFromCanvasImageData(t){const s=t.getContext("2d").getImageData(0,0,t.width,t.height);return X.toGrayscaleBuffer(s.data,t.width,t.height)}static toGrayscaleBuffer(t,s,r){const a=new Uint8ClampedArray(s*r);for(let i=0,o=0,d=t.length;i<d;i+=4,o++){let h;if(t[i+3]===0)h=255;else{const y=t[i],T=t[i+1],z=t[i+2];h=306*y+601*T+117*z+512>>10}a[o]=h}return a}getRow(t,s){if(t<0||t>=this.getHeight())throw new p("Requested row is outside the image: "+t);const r=this.getWidth(),a=t*r;return s===null?s=this.buffer.slice(a,a+r):(s.length<r&&(s=new Uint8ClampedArray(r)),s.set(this.buffer.slice(a,a+r))),s}getMatrix(){return this.buffer}isCropSupported(){return!0}crop(t,s,r,a){return super.crop(t,s,r,a),this}isRotateSupported(){return!0}rotateCounterClockwise(){return this.rotate(-90),this}rotateCounterClockwise45(){return this.rotate(-45),this}getTempCanvasElement(){if(this.tempCanvasElement===null){const t=this.canvas.ownerDocument.createElement("canvas");t.width=this.canvas.width,t.height=this.canvas.height,this.tempCanvasElement=t}return this.tempCanvasElement}rotate(t){const s=this.getTempCanvasElement(),r=s.getContext("2d"),a=t*X.DEGREE_TO_RADIANS,i=this.canvas.width,o=this.canvas.height,d=Math.ceil(Math.abs(Math.cos(a))*i+Math.abs(Math.sin(a))*o),h=Math.ceil(Math.abs(Math.sin(a))*i+Math.abs(Math.cos(a))*o);return s.width=d,s.height=h,r.translate(d/2,h/2),r.rotate(a),r.drawImage(this.canvas,i/-2,o/-2),this.buffer=X.makeBufferFromCanvasImageData(s),this}invert(){return new ge(this)}}X.DEGREE_TO_RADIANS=Math.PI/180;class pe{constructor(t,s,r){this.deviceId=t,this.label=s,this.kind="videoinput",this.groupId=r||void 0}toJSON(){return{kind:this.kind,groupId:this.groupId,deviceId:this.deviceId,label:this.label}}}var me=(globalThis||Yr||self||window||void 0)&&(globalThis||Yr||self||window||void 0).__awaiter||function(A,t,s,r){function a(i){return i instanceof s?i:new s(function(o){o(i)})}return new(s||(s=Promise))(function(i,o){function d(y){try{m(r.next(y))}catch(T){o(T)}}function h(y){try{m(r.throw(y))}catch(T){o(T)}}function m(y){y.done?i(y.value):a(y.value).then(d,h)}m((r=r.apply(A,t||[])).next())})};class Q{constructor(t,s=500,r){this.reader=t,this.timeBetweenScansMillis=s,this._hints=r,this._stopContinuousDecode=!1,this._stopAsyncDecode=!1,this._timeBetweenDecodingAttempts=0}get hasNavigator(){return typeof navigator<"u"}get isMediaDevicesSuported(){return this.hasNavigator&&!!navigator.mediaDevices}get canEnumerateDevices(){return!!(this.isMediaDevicesSuported&&navigator.mediaDevices.enumerateDevices)}get timeBetweenDecodingAttempts(){return this._timeBetweenDecodingAttempts}set timeBetweenDecodingAttempts(t){this._timeBetweenDecodingAttempts=t<0?0:t}set hints(t){this._hints=t||null}get hints(){return this._hints}listVideoInputDevices(){return me(this,void 0,void 0,function*(){if(!this.hasNavigator)throw new Error("Can't enumerate devices, navigator is not present.");if(!this.canEnumerateDevices)throw new Error("Can't enumerate devices, method not supported.");const t=yield navigator.mediaDevices.enumerateDevices(),s=[];for(const r of t){const a=r.kind==="video"?"videoinput":r.kind;if(a!=="videoinput")continue;const i=r.deviceId||r.id,o=r.label||`Video device ${s.length+1}`,d=r.groupId,h={deviceId:i,label:o,kind:a,groupId:d};s.push(h)}return s})}getVideoInputDevices(){return me(this,void 0,void 0,function*(){return(yield this.listVideoInputDevices()).map(s=>new pe(s.deviceId,s.label))})}findDeviceById(t){return me(this,void 0,void 0,function*(){const s=yield this.listVideoInputDevices();return s?s.find(r=>r.deviceId===t):null})}decodeFromInputVideoDevice(t,s){return me(this,void 0,void 0,function*(){return yield this.decodeOnceFromVideoDevice(t,s)})}decodeOnceFromVideoDevice(t,s){return me(this,void 0,void 0,function*(){this.reset();let r;t?r={deviceId:{exact:t}}:r={facingMode:"environment"};const a={video:r};return yield this.decodeOnceFromConstraints(a,s)})}decodeOnceFromConstraints(t,s){return me(this,void 0,void 0,function*(){const r=yield navigator.mediaDevices.getUserMedia(t);return yield this.decodeOnceFromStream(r,s)})}decodeOnceFromStream(t,s){return me(this,void 0,void 0,function*(){this.reset();const r=yield this.attachStreamToVideo(t,s);return yield this.decodeOnce(r)})}decodeFromInputVideoDeviceContinuously(t,s,r){return me(this,void 0,void 0,function*(){return yield this.decodeFromVideoDevice(t,s,r)})}decodeFromVideoDevice(t,s,r){return me(this,void 0,void 0,function*(){let a;t?a={deviceId:{exact:t}}:a={facingMode:"environment"};const i={video:a};return yield this.decodeFromConstraints(i,s,r)})}decodeFromConstraints(t,s,r){return me(this,void 0,void 0,function*(){const a=yield navigator.mediaDevices.getUserMedia(t);return yield this.decodeFromStream(a,s,r)})}decodeFromStream(t,s,r){return me(this,void 0,void 0,function*(){this.reset();const a=yield this.attachStreamToVideo(t,s);return yield this.decodeContinuously(a,r)})}stopAsyncDecode(){this._stopAsyncDecode=!0}stopContinuousDecode(){this._stopContinuousDecode=!0}attachStreamToVideo(t,s){return me(this,void 0,void 0,function*(){const r=this.prepareVideoElement(s);return this.addVideoSource(r,t),this.videoElement=r,this.stream=t,yield this.playVideoOnLoadAsync(r),r})}playVideoOnLoadAsync(t){return new Promise((s,r)=>this.playVideoOnLoad(t,()=>s()))}playVideoOnLoad(t,s){this.videoEndedListener=()=>this.stopStreams(),this.videoCanPlayListener=()=>this.tryPlayVideo(t),t.addEventListener("ended",this.videoEndedListener),t.addEventListener("canplay",this.videoCanPlayListener),t.addEventListener("playing",s),this.tryPlayVideo(t)}isVideoPlaying(t){return t.currentTime>0&&!t.paused&&!t.ended&&t.readyState>2}tryPlayVideo(t){return me(this,void 0,void 0,function*(){if(this.isVideoPlaying(t)){console.warn("Trying to play video that is already playing.");return}try{yield t.play()}catch{console.warn("It was not possible to play the video.")}})}getMediaElement(t,s){const r=document.getElementById(t);if(!r)throw new j(`element with id '${t}' not found`);if(r.nodeName.toLowerCase()!==s.toLowerCase())throw new j(`element with id '${t}' must be an ${s} element`);return r}decodeFromImage(t,s){if(!t&&!s)throw new j("either imageElement with a src set or an url must be provided");return s&&!t?this.decodeFromImageUrl(s):this.decodeFromImageElement(t)}decodeFromVideo(t,s){if(!t&&!s)throw new j("Either an element with a src set or an URL must be provided");return s&&!t?this.decodeFromVideoUrl(s):this.decodeFromVideoElement(t)}decodeFromVideoContinuously(t,s,r){if(t===void 0&&s===void 0)throw new j("Either an element with a src set or an URL must be provided");return s&&!t?this.decodeFromVideoUrlContinuously(s,r):this.decodeFromVideoElementContinuously(t,r)}decodeFromImageElement(t){if(!t)throw new j("An image element must be provided.");this.reset();const s=this.prepareImageElement(t);this.imageElement=s;let r;return this.isImageLoaded(s)?r=this.decodeOnce(s,!1,!0):r=this._decodeOnLoadImage(s),r}decodeFromVideoElement(t){const s=this._decodeFromVideoElementSetup(t);return this._decodeOnLoadVideo(s)}decodeFromVideoElementContinuously(t,s){const r=this._decodeFromVideoElementSetup(t);return this._decodeOnLoadVideoContinuously(r,s)}_decodeFromVideoElementSetup(t){if(!t)throw new j("A video element must be provided.");this.reset();const s=this.prepareVideoElement(t);return this.videoElement=s,s}decodeFromImageUrl(t){if(!t)throw new j("An URL must be provided.");this.reset();const s=this.prepareImageElement();this.imageElement=s;const r=this._decodeOnLoadImage(s);return s.src=t,r}decodeFromVideoUrl(t){if(!t)throw new j("An URL must be provided.");this.reset();const s=this.prepareVideoElement(),r=this.decodeFromVideoElement(s);return s.src=t,r}decodeFromVideoUrlContinuously(t,s){if(!t)throw new j("An URL must be provided.");this.reset();const r=this.prepareVideoElement(),a=this.decodeFromVideoElementContinuously(r,s);return r.src=t,a}_decodeOnLoadImage(t){return new Promise((s,r)=>{this.imageLoadedListener=()=>this.decodeOnce(t,!1,!0).then(s,r),t.addEventListener("load",this.imageLoadedListener)})}_decodeOnLoadVideo(t){return me(this,void 0,void 0,function*(){return yield this.playVideoOnLoadAsync(t),yield this.decodeOnce(t)})}_decodeOnLoadVideoContinuously(t,s){return me(this,void 0,void 0,function*(){yield this.playVideoOnLoadAsync(t),this.decodeContinuously(t,s)})}isImageLoaded(t){return!(!t.complete||t.naturalWidth===0)}prepareImageElement(t){let s;return typeof t>"u"&&(s=document.createElement("img"),s.width=200,s.height=200),typeof t=="string"&&(s=this.getMediaElement(t,"img")),t instanceof HTMLImageElement&&(s=t),s}prepareVideoElement(t){let s;return!t&&typeof document<"u"&&(s=document.createElement("video"),s.width=200,s.height=200),typeof t=="string"&&(s=this.getMediaElement(t,"video")),t instanceof HTMLVideoElement&&(s=t),s.setAttribute("autoplay","true"),s.setAttribute("muted","true"),s.setAttribute("playsinline","true"),s}decodeOnce(t,s=!0,r=!0){this._stopAsyncDecode=!1;const a=(i,o)=>{if(this._stopAsyncDecode){o(new $("Video stream has ended before any code could be detected.")),this._stopAsyncDecode=void 0;return}try{const d=this.decode(t);i(d)}catch(d){const h=s&&d instanceof $,y=(d instanceof B||d instanceof _)&&r;if(h||y)return setTimeout(a,this._timeBetweenDecodingAttempts,i,o);o(d)}};return new Promise((i,o)=>a(i,o))}decodeContinuously(t,s){this._stopContinuousDecode=!1;const r=()=>{if(this._stopContinuousDecode){this._stopContinuousDecode=void 0;return}try{const a=this.decode(t);s(a,null),setTimeout(r,this.timeBetweenScansMillis)}catch(a){s(null,a);const i=a instanceof B||a instanceof _,o=a instanceof $;(i||o)&&setTimeout(r,this._timeBetweenDecodingAttempts)}};r()}decode(t){const s=this.createBinaryBitmap(t);return this.decodeBitmap(s)}_isHTMLVideoElement(t){return t.videoWidth!==0}drawFrameOnCanvas(t,s,r){s||(s={sx:0,sy:0,sWidth:t.videoWidth,sHeight:t.videoHeight,dx:0,dy:0,dWidth:t.videoWidth,dHeight:t.videoHeight}),r||(r=this.captureCanvasContext),r.drawImage(t,s.sx,s.sy,s.sWidth,s.sHeight,s.dx,s.dy,s.dWidth,s.dHeight)}drawImageOnCanvas(t,s,r=this.captureCanvasContext){s||(s={sx:0,sy:0,sWidth:t.naturalWidth,sHeight:t.naturalHeight,dx:0,dy:0,dWidth:t.naturalWidth,dHeight:t.naturalHeight}),r||(r=this.captureCanvasContext),r.drawImage(t,s.sx,s.sy,s.sWidth,s.sHeight,s.dx,s.dy,s.dWidth,s.dHeight)}createBinaryBitmap(t){this.getCaptureCanvasContext(t),this._isHTMLVideoElement(t)?this.drawFrameOnCanvas(t):this.drawImageOnCanvas(t);const s=this.getCaptureCanvas(t),r=new X(s),a=new re(r);return new M(a)}getCaptureCanvasContext(t){if(!this.captureCanvasContext){const r=this.getCaptureCanvas(t).getContext("2d");this.captureCanvasContext=r}return this.captureCanvasContext}getCaptureCanvas(t){if(!this.captureCanvas){const s=this.createCaptureCanvas(t);this.captureCanvas=s}return this.captureCanvas}decodeBitmap(t){return this.reader.decode(t,this._hints)}createCaptureCanvas(t){if(typeof document>"u")return this._destroyCaptureCanvas(),null;const s=document.createElement("canvas");let r,a;return typeof t<"u"&&(t instanceof HTMLVideoElement?(r=t.videoWidth,a=t.videoHeight):t instanceof HTMLImageElement&&(r=t.naturalWidth||t.width,a=t.naturalHeight||t.height)),s.style.width=r+"px",s.style.height=a+"px",s.width=r,s.height=a,s}stopStreams(){this.stream&&(this.stream.getVideoTracks().forEach(t=>t.stop()),this.stream=void 0),this._stopAsyncDecode===!1&&this.stopAsyncDecode(),this._stopContinuousDecode===!1&&this.stopContinuousDecode()}reset(){this.stopStreams(),this._destroyVideoElement(),this._destroyImageElement(),this._destroyCaptureCanvas()}_destroyVideoElement(){this.videoElement&&(typeof this.videoEndedListener<"u"&&this.videoElement.removeEventListener("ended",this.videoEndedListener),typeof this.videoPlayingEventListener<"u"&&this.videoElement.removeEventListener("playing",this.videoPlayingEventListener),typeof this.videoCanPlayListener<"u"&&this.videoElement.removeEventListener("loadedmetadata",this.videoCanPlayListener),this.cleanVideoSource(this.videoElement),this.videoElement=void 0)}_destroyImageElement(){this.imageElement&&(this.imageLoadedListener!==void 0&&this.imageElement.removeEventListener("load",this.imageLoadedListener),this.imageElement.src=void 0,this.imageElement.removeAttribute("src"),this.imageElement=void 0)}_destroyCaptureCanvas(){this.captureCanvasContext=void 0,this.captureCanvas=void 0}addVideoSource(t,s){try{t.srcObject=s}catch{t.src=URL.createObjectURL(s)}}cleanVideoSource(t){try{t.srcObject=null}catch{t.src=""}this.videoElement.removeAttribute("src")}}class V{constructor(t,s,r=s==null?0:8*s.length,a,i,o=R.currentTimeMillis()){this.text=t,this.rawBytes=s,this.numBits=r,this.resultPoints=a,this.format=i,this.timestamp=o,this.text=t,this.rawBytes=s,r==null?this.numBits=s==null?0:8*s.length:this.numBits=r,this.resultPoints=a,this.format=i,this.resultMetadata=null,o==null?this.timestamp=R.currentTimeMillis():this.timestamp=o}getText(){return this.text}getRawBytes(){return this.rawBytes}getNumBits(){return this.numBits}getResultPoints(){return this.resultPoints}getBarcodeFormat(){return this.format}getResultMetadata(){return this.resultMetadata}putMetadata(t,s){this.resultMetadata===null&&(this.resultMetadata=new Map),this.resultMetadata.set(t,s)}putAllMetadata(t){t!==null&&(this.resultMetadata===null?this.resultMetadata=t:this.resultMetadata=new Map(t))}addResultPoints(t){const s=this.resultPoints;if(s===null)this.resultPoints=t;else if(t!==null&&t.length>0){const r=new Array(s.length+t.length);R.arraycopy(s,0,r,0,s.length),R.arraycopy(t,0,r,s.length,t.length),this.resultPoints=r}}getTimestamp(){return this.timestamp}toString(){return this.text}}var de;(function(A){A[A.AZTEC=0]="AZTEC",A[A.CODABAR=1]="CODABAR",A[A.CODE_39=2]="CODE_39",A[A.CODE_93=3]="CODE_93",A[A.CODE_128=4]="CODE_128",A[A.DATA_MATRIX=5]="DATA_MATRIX",A[A.EAN_8=6]="EAN_8",A[A.EAN_13=7]="EAN_13",A[A.ITF=8]="ITF",A[A.MAXICODE=9]="MAXICODE",A[A.PDF_417=10]="PDF_417",A[A.QR_CODE=11]="QR_CODE",A[A.RSS_14=12]="RSS_14",A[A.RSS_EXPANDED=13]="RSS_EXPANDED",A[A.UPC_A=14]="UPC_A",A[A.UPC_E=15]="UPC_E",A[A.UPC_EAN_EXTENSION=16]="UPC_EAN_EXTENSION"})(de||(de={}));var ae=de,le;(function(A){A[A.OTHER=0]="OTHER",A[A.ORIENTATION=1]="ORIENTATION",A[A.BYTE_SEGMENTS=2]="BYTE_SEGMENTS",A[A.ERROR_CORRECTION_LEVEL=3]="ERROR_CORRECTION_LEVEL",A[A.ISSUE_NUMBER=4]="ISSUE_NUMBER",A[A.SUGGESTED_PRICE=5]="SUGGESTED_PRICE",A[A.POSSIBLE_COUNTRY=6]="POSSIBLE_COUNTRY",A[A.UPC_EAN_EXTENSION=7]="UPC_EAN_EXTENSION",A[A.PDF417_EXTRA_METADATA=8]="PDF417_EXTRA_METADATA",A[A.STRUCTURED_APPEND_SEQUENCE=9]="STRUCTURED_APPEND_SEQUENCE",A[A.STRUCTURED_APPEND_PARITY=10]="STRUCTURED_APPEND_PARITY"})(le||(le={}));var be=le;class ye{constructor(t,s,r,a,i=-1,o=-1){this.rawBytes=t,this.text=s,this.byteSegments=r,this.ecLevel=a,this.structuredAppendSequenceNumber=i,this.structuredAppendParity=o,this.numBits=t==null?0:8*t.length}getRawBytes(){return this.rawBytes}getNumBits(){return this.numBits}setNumBits(t){this.numBits=t}getText(){return this.text}getByteSegments(){return this.byteSegments}getECLevel(){return this.ecLevel}getErrorsCorrected(){return this.errorsCorrected}setErrorsCorrected(t){this.errorsCorrected=t}getErasures(){return this.erasures}setErasures(t){this.erasures=t}getOther(){return this.other}setOther(t){this.other=t}hasStructuredAppend(){return this.structuredAppendParity>=0&&this.structuredAppendSequenceNumber>=0}getStructuredAppendParity(){return this.structuredAppendParity}getStructuredAppendSequenceNumber(){return this.structuredAppendSequenceNumber}}class Ce{exp(t){return this.expTable[t]}log(t){if(t===0)throw new p;return this.logTable[t]}static addOrSubtract(t,s){return t^s}}class Ne{constructor(t,s){if(s.length===0)throw new p;this.field=t;const r=s.length;if(r>1&&s[0]===0){let a=1;for(;a<r&&s[a]===0;)a++;a===r?this.coefficients=Int32Array.from([0]):(this.coefficients=new Int32Array(r-a),R.arraycopy(s,a,this.coefficients,0,this.coefficients.length))}else this.coefficients=s}getCoefficients(){return this.coefficients}getDegree(){return this.coefficients.length-1}isZero(){return this.coefficients[0]===0}getCoefficient(t){return this.coefficients[this.coefficients.length-1-t]}evaluateAt(t){if(t===0)return this.getCoefficient(0);const s=this.coefficients;let r;if(t===1){r=0;for(let o=0,d=s.length;o!==d;o++){const h=s[o];r=Ce.addOrSubtract(r,h)}return r}r=s[0];const a=s.length,i=this.field;for(let o=1;o<a;o++)r=Ce.addOrSubtract(i.multiply(t,r),s[o]);return r}addOrSubtract(t){if(!this.field.equals(t.field))throw new p("GenericGFPolys do not have same GenericGF field");if(this.isZero())return t;if(t.isZero())return this;let s=this.coefficients,r=t.coefficients;if(s.length>r.length){const o=s;s=r,r=o}let a=new Int32Array(r.length);const i=r.length-s.length;R.arraycopy(r,0,a,0,i);for(let o=i;o<r.length;o++)a[o]=Ce.addOrSubtract(s[o-i],r[o]);return new Ne(this.field,a)}multiply(t){if(!this.field.equals(t.field))throw new p("GenericGFPolys do not have same GenericGF field");if(this.isZero()||t.isZero())return this.field.getZero();const s=this.coefficients,r=s.length,a=t.coefficients,i=a.length,o=new Int32Array(r+i-1),d=this.field;for(let h=0;h<r;h++){const m=s[h];for(let y=0;y<i;y++)o[h+y]=Ce.addOrSubtract(o[h+y],d.multiply(m,a[y]))}return new Ne(d,o)}multiplyScalar(t){if(t===0)return this.field.getZero();if(t===1)return this;const s=this.coefficients.length,r=this.field,a=new Int32Array(s),i=this.coefficients;for(let o=0;o<s;o++)a[o]=r.multiply(i[o],t);return new Ne(r,a)}multiplyByMonomial(t,s){if(t<0)throw new p;if(s===0)return this.field.getZero();const r=this.coefficients,a=r.length,i=new Int32Array(a+t),o=this.field;for(let d=0;d<a;d++)i[d]=o.multiply(r[d],s);return new Ne(o,i)}divide(t){if(!this.field.equals(t.field))throw new p("GenericGFPolys do not have same GenericGF field");if(t.isZero())throw new p("Divide by 0");const s=this.field;let r=s.getZero(),a=this;const i=t.getCoefficient(t.getDegree()),o=s.inverse(i);for(;a.getDegree()>=t.getDegree()&&!a.isZero();){const d=a.getDegree()-t.getDegree(),h=s.multiply(a.getCoefficient(a.getDegree()),o),m=t.multiplyByMonomial(d,h),y=s.buildMonomial(d,h);r=r.addOrSubtract(y),a=a.addOrSubtract(m)}return[r,a]}toString(){let t="";for(let s=this.getDegree();s>=0;s--){let r=this.getCoefficient(s);if(r!==0){if(r<0?(t+=" - ",r=-r):t.length>0&&(t+=" + "),s===0||r!==1){const a=this.field.log(r);a===0?t+="1":a===1?t+="a":(t+="a^",t+=a)}s!==0&&(s===1?t+="x":(t+="x^",t+=s))}}return t}}class Ae extends g{}Ae.kind="ArithmeticException";class Ue extends Ce{constructor(t,s,r){super(),this.primitive=t,this.size=s,this.generatorBase=r;const a=new Int32Array(s);let i=1;for(let d=0;d<s;d++)a[d]=i,i*=2,i>=s&&(i^=t,i&=s-1);this.expTable=a;const o=new Int32Array(s);for(let d=0;d<s-1;d++)o[a[d]]=d;this.logTable=o,this.zero=new Ne(this,Int32Array.from([0])),this.one=new Ne(this,Int32Array.from([1]))}getZero(){return this.zero}getOne(){return this.one}buildMonomial(t,s){if(t<0)throw new p;if(s===0)return this.zero;const r=new Int32Array(t+1);return r[0]=s,new Ne(this,r)}inverse(t){if(t===0)throw new Ae;return this.expTable[this.size-this.logTable[t]-1]}multiply(t,s){return t===0||s===0?0:this.expTable[(this.logTable[t]+this.logTable[s])%(this.size-1)]}getSize(){return this.size}getGeneratorBase(){return this.generatorBase}toString(){return"GF(0x"+U.toHexString(this.primitive)+","+this.size+")"}equals(t){return t===this}}Ue.AZTEC_DATA_12=new Ue(4201,4096,1),Ue.AZTEC_DATA_10=new Ue(1033,1024,1),Ue.AZTEC_DATA_6=new Ue(67,64,1),Ue.AZTEC_PARAM=new Ue(19,16,1),Ue.QR_CODE_FIELD_256=new Ue(285,256,0),Ue.DATA_MATRIX_FIELD_256=new Ue(301,256,1),Ue.AZTEC_DATA_8=Ue.DATA_MATRIX_FIELD_256,Ue.MAXICODE_FIELD_64=Ue.AZTEC_DATA_6;class qe extends g{}qe.kind="ReedSolomonException";class rt extends g{}rt.kind="IllegalStateException";class at{constructor(t){this.field=t}decode(t,s){const r=this.field,a=new Ne(r,t),i=new Int32Array(s);let o=!0;for(let Y=0;Y<s;Y++){const ce=a.evaluateAt(r.exp(Y+r.getGeneratorBase()));i[i.length-1-Y]=ce,ce!==0&&(o=!1)}if(o)return;const d=new Ne(r,i),h=this.runEuclideanAlgorithm(r.buildMonomial(s,1),d,s),m=h[0],y=h[1],T=this.findErrorLocations(m),z=this.findErrorMagnitudes(y,T);for(let Y=0;Y<T.length;Y++){const ce=t.length-1-r.log(T[Y]);if(ce<0)throw new qe("Bad error location");t[ce]=Ue.addOrSubtract(t[ce],z[Y])}}runEuclideanAlgorithm(t,s,r){if(t.getDegree()<s.getDegree()){const Y=t;t=s,s=Y}const a=this.field;let i=t,o=s,d=a.getZero(),h=a.getOne();for(;o.getDegree()>=(r/2|0);){let Y=i,ce=d;if(i=o,d=h,i.isZero())throw new qe("r_{i-1} was zero");o=Y;let ue=a.getZero();const Se=i.getCoefficient(i.getDegree()),ze=a.inverse(Se);for(;o.getDegree()>=i.getDegree()&&!o.isZero();){const We=o.getDegree()-i.getDegree(),$e=a.multiply(o.getCoefficient(o.getDegree()),ze);ue=ue.addOrSubtract(a.buildMonomial(We,$e)),o=o.addOrSubtract(i.multiplyByMonomial(We,$e))}if(h=ue.multiply(d).addOrSubtract(ce),o.getDegree()>=i.getDegree())throw new rt("Division algorithm failed to reduce polynomial?")}const m=h.getCoefficient(0);if(m===0)throw new qe("sigmaTilde(0) was zero");const y=a.inverse(m),T=h.multiplyScalar(y),z=o.multiplyScalar(y);return[T,z]}findErrorLocations(t){const s=t.getDegree();if(s===1)return Int32Array.from([t.getCoefficient(1)]);const r=new Int32Array(s);let a=0;const i=this.field;for(let o=1;o<i.getSize()&&a<s;o++)t.evaluateAt(o)===0&&(r[a]=i.inverse(o),a++);if(a!==s)throw new qe("Error locator degree does not match number of roots");return r}findErrorMagnitudes(t,s){const r=s.length,a=new Int32Array(r),i=this.field;for(let o=0;o<r;o++){const d=i.inverse(s[o]);let h=1;for(let m=0;m<r;m++)if(o!==m){const y=i.multiply(s[m],d),T=y&1?y&-2:y|1;h=i.multiply(h,T)}a[o]=i.multiply(t.evaluateAt(d),i.inverse(h)),i.getGeneratorBase()!==0&&(a[o]=i.multiply(a[o],d))}return a}}var Ke;(function(A){A[A.UPPER=0]="UPPER",A[A.LOWER=1]="LOWER",A[A.MIXED=2]="MIXED",A[A.DIGIT=3]="DIGIT",A[A.PUNCT=4]="PUNCT",A[A.BINARY=5]="BINARY"})(Ke||(Ke={}));class Je{decode(t){this.ddata=t;let s=t.getBits(),r=this.extractBits(s),a=this.correctBits(r),i=Je.convertBoolArrayToByteArray(a),o=Je.getEncodedData(a),d=new ye(i,o,null,null);return d.setNumBits(a.length),d}static highLevelDecode(t){return this.getEncodedData(t)}static getEncodedData(t){let s=t.length,r=Ke.UPPER,a=Ke.UPPER,i="",o=0;for(;o<s;)if(a===Ke.BINARY){if(s-o<5)break;let d=Je.readCode(t,o,5);if(o+=5,d===0){if(s-o<11)break;d=Je.readCode(t,o,11)+31,o+=11}for(let h=0;h<d;h++){if(s-o<8){o=s;break}const m=Je.readCode(t,o,8);i+=W.castAsNonUtf8Char(m),o+=8}a=r}else{let d=a===Ke.DIGIT?4:5;if(s-o<d)break;let h=Je.readCode(t,o,d);o+=d;let m=Je.getCharacter(a,h);m.startsWith("CTRL_")?(r=a,a=Je.getTable(m.charAt(5)),m.charAt(6)==="L"&&(r=a)):(i+=m,a=r)}return i}static getTable(t){switch(t){case"L":return Ke.LOWER;case"P":return Ke.PUNCT;case"M":return Ke.MIXED;case"D":return Ke.DIGIT;case"B":return Ke.BINARY;case"U":default:return Ke.UPPER}}static getCharacter(t,s){switch(t){case Ke.UPPER:return Je.UPPER_TABLE[s];case Ke.LOWER:return Je.LOWER_TABLE[s];case Ke.MIXED:return Je.MIXED_TABLE[s];case Ke.PUNCT:return Je.PUNCT_TABLE[s];case Ke.DIGIT:return Je.DIGIT_TABLE[s];default:throw new rt("Bad table")}}correctBits(t){let s,r;this.ddata.getNbLayers()<=2?(r=6,s=Ue.AZTEC_DATA_6):this.ddata.getNbLayers()<=8?(r=8,s=Ue.AZTEC_DATA_8):this.ddata.getNbLayers()<=22?(r=10,s=Ue.AZTEC_DATA_10):(r=12,s=Ue.AZTEC_DATA_12);let a=this.ddata.getNbDatablocks(),i=t.length/r;if(i<a)throw new _;let o=t.length%r,d=new Int32Array(i);for(let z=0;z<i;z++,o+=r)d[z]=Je.readCode(t,o,r);try{new at(s).decode(d,i-a)}catch(z){throw new _(z)}let h=(1<<r)-1,m=0;for(let z=0;z<a;z++){let Y=d[z];if(Y===0||Y===h)throw new _;(Y===1||Y===h-1)&&m++}let y=new Array(a*r-m),T=0;for(let z=0;z<a;z++){let Y=d[z];if(Y===1||Y===h-1)y.fill(Y>1,T,T+r-1),T+=r-1;else for(let ce=r-1;ce>=0;--ce)y[T++]=(Y&1<<ce)!==0}return y}extractBits(t){let s=this.ddata.isCompact(),r=this.ddata.getNbLayers(),a=(s?11:14)+r*4,i=new Int32Array(a),o=new Array(this.totalBitsInLayer(r,s));if(s)for(let d=0;d<i.length;d++)i[d]=d;else{let d=a+1+2*U.truncDivision(U.truncDivision(a,2)-1,15),h=a/2,m=U.truncDivision(d,2);for(let y=0;y<h;y++){let T=y+U.truncDivision(y,15);i[h-y-1]=m-T-1,i[h+y]=m+T+1}}for(let d=0,h=0;d<r;d++){let m=(r-d)*4+(s?9:12),y=d*2,T=a-1-y;for(let z=0;z<m;z++){let Y=z*2;for(let ce=0;ce<2;ce++)o[h+Y+ce]=t.get(i[y+ce],i[y+z]),o[h+2*m+Y+ce]=t.get(i[y+z],i[T-ce]),o[h+4*m+Y+ce]=t.get(i[T-ce],i[T-z]),o[h+6*m+Y+ce]=t.get(i[T-z],i[y+ce])}h+=m*8}return o}static readCode(t,s,r){let a=0;for(let i=s;i<s+r;i++)a<<=1,t[i]&&(a|=1);return a}static readByte(t,s){let r=t.length-s;return r>=8?Je.readCode(t,s,8):Je.readCode(t,s,r)<<8-r}static convertBoolArrayToByteArray(t){let s=new Uint8Array((t.length+7)/8);for(let r=0;r<s.length;r++)s[r]=Je.readByte(t,8*r);return s}totalBitsInLayer(t,s){return((s?88:112)+16*t)*t}}Je.UPPER_TABLE=["CTRL_PS"," ","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","CTRL_LL","CTRL_ML","CTRL_DL","CTRL_BS"],Je.LOWER_TABLE=["CTRL_PS"," ","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","CTRL_US","CTRL_ML","CTRL_DL","CTRL_BS"],Je.MIXED_TABLE=["CTRL_PS"," ","\\1","\\2","\\3","\\4","\\5","\\6","\\7","\b","	",`
`,"\\13","\f","\r","\\33","\\34","\\35","\\36","\\37","@","\\","^","_","`","|","~","\\177","CTRL_LL","CTRL_UL","CTRL_PL","CTRL_BS"],Je.PUNCT_TABLE=["","\r",`\r
`,". ",", ",": ","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/",":",";","<","=",">","?","[","]","{","}","CTRL_UL"],Je.DIGIT_TABLE=["CTRL_PS"," ","0","1","2","3","4","5","6","7","8","9",",",".","CTRL_UL","CTRL_US"];class Ge{constructor(){}static round(t){return t===NaN?0:t<=Number.MIN_SAFE_INTEGER?Number.MIN_SAFE_INTEGER:t>=Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:t+(t<0?-.5:.5)|0}static distance(t,s,r,a){const i=t-r,o=s-a;return Math.sqrt(i*i+o*o)}static sum(t){let s=0;for(let r=0,a=t.length;r!==a;r++){const i=t[r];s+=i}return s}}class yt{static floatToIntBits(t){return t}}yt.MAX_VALUE=Number.MAX_SAFE_INTEGER;class Ye{constructor(t,s){this.x=t,this.y=s}getX(){return this.x}getY(){return this.y}equals(t){if(t instanceof Ye){const s=t;return this.x===s.x&&this.y===s.y}return!1}hashCode(){return 31*yt.floatToIntBits(this.x)+yt.floatToIntBits(this.y)}toString(){return"("+this.x+","+this.y+")"}static orderBestPatterns(t){const s=this.distance(t[0],t[1]),r=this.distance(t[1],t[2]),a=this.distance(t[0],t[2]);let i,o,d;if(r>=s&&r>=a?(o=t[0],i=t[1],d=t[2]):a>=r&&a>=s?(o=t[1],i=t[0],d=t[2]):(o=t[2],i=t[0],d=t[1]),this.crossProductZ(i,o,d)<0){const h=i;i=d,d=h}t[0]=i,t[1]=o,t[2]=d}static distance(t,s){return Ge.distance(t.x,t.y,s.x,s.y)}static crossProductZ(t,s,r){const a=s.x,i=s.y;return(r.x-a)*(t.y-i)-(r.y-i)*(t.x-a)}}class Te{constructor(t,s){this.bits=t,this.points=s}getBits(){return this.bits}getPoints(){return this.points}}class H extends Te{constructor(t,s,r,a,i){super(t,s),this.compact=r,this.nbDatablocks=a,this.nbLayers=i}getNbLayers(){return this.nbLayers}getNbDatablocks(){return this.nbDatablocks}isCompact(){return this.compact}}class ne{constructor(t,s,r,a){this.image=t,this.height=t.getHeight(),this.width=t.getWidth(),s==null&&(s=ne.INIT_SIZE),r==null&&(r=t.getWidth()/2|0),a==null&&(a=t.getHeight()/2|0);const i=s/2|0;if(this.leftInit=r-i,this.rightInit=r+i,this.upInit=a-i,this.downInit=a+i,this.upInit<0||this.leftInit<0||this.downInit>=this.height||this.rightInit>=this.width)throw new $}detect(){let t=this.leftInit,s=this.rightInit,r=this.upInit,a=this.downInit,i=!1,o=!0,d=!1,h=!1,m=!1,y=!1,T=!1;const z=this.width,Y=this.height;for(;o;){o=!1;let ce=!0;for(;(ce||!h)&&s<z;)ce=this.containsBlackPoint(r,a,s,!1),ce?(s++,o=!0,h=!0):h||s++;if(s>=z){i=!0;break}let ue=!0;for(;(ue||!m)&&a<Y;)ue=this.containsBlackPoint(t,s,a,!0),ue?(a++,o=!0,m=!0):m||a++;if(a>=Y){i=!0;break}let Se=!0;for(;(Se||!y)&&t>=0;)Se=this.containsBlackPoint(r,a,t,!1),Se?(t--,o=!0,y=!0):y||t--;if(t<0){i=!0;break}let ze=!0;for(;(ze||!T)&&r>=0;)ze=this.containsBlackPoint(t,s,r,!0),ze?(r--,o=!0,T=!0):T||r--;if(r<0){i=!0;break}o&&(d=!0)}if(!i&&d){const ce=s-t;let ue=null;for(let $e=1;ue===null&&$e<ce;$e++)ue=this.getBlackPointOnSegment(t,a-$e,t+$e,a);if(ue==null)throw new $;let Se=null;for(let $e=1;Se===null&&$e<ce;$e++)Se=this.getBlackPointOnSegment(t,r+$e,t+$e,r);if(Se==null)throw new $;let ze=null;for(let $e=1;ze===null&&$e<ce;$e++)ze=this.getBlackPointOnSegment(s,r+$e,s-$e,r);if(ze==null)throw new $;let We=null;for(let $e=1;We===null&&$e<ce;$e++)We=this.getBlackPointOnSegment(s,a-$e,s-$e,a);if(We==null)throw new $;return this.centerEdges(We,ue,ze,Se)}else throw new $}getBlackPointOnSegment(t,s,r,a){const i=Ge.round(Ge.distance(t,s,r,a)),o=(r-t)/i,d=(a-s)/i,h=this.image;for(let m=0;m<i;m++){const y=Ge.round(t+m*o),T=Ge.round(s+m*d);if(h.get(y,T))return new Ye(y,T)}return null}centerEdges(t,s,r,a){const i=t.getX(),o=t.getY(),d=s.getX(),h=s.getY(),m=r.getX(),y=r.getY(),T=a.getX(),z=a.getY(),Y=ne.CORR;return i<this.width/2?[new Ye(T-Y,z+Y),new Ye(d+Y,h+Y),new Ye(m-Y,y-Y),new Ye(i+Y,o-Y)]:[new Ye(T+Y,z+Y),new Ye(d+Y,h-Y),new Ye(m-Y,y+Y),new Ye(i-Y,o-Y)]}containsBlackPoint(t,s,r,a){const i=this.image;if(a){for(let o=t;o<=s;o++)if(i.get(o,r))return!0}else for(let o=t;o<=s;o++)if(i.get(r,o))return!0;return!1}}ne.INIT_SIZE=10,ne.CORR=1;class fe{static checkAndNudgePoints(t,s){const r=t.getWidth(),a=t.getHeight();let i=!0;for(let o=0;o<s.length&&i;o+=2){const d=Math.floor(s[o]),h=Math.floor(s[o+1]);if(d<-1||d>r||h<-1||h>a)throw new $;i=!1,d===-1?(s[o]=0,i=!0):d===r&&(s[o]=r-1,i=!0),h===-1?(s[o+1]=0,i=!0):h===a&&(s[o+1]=a-1,i=!0)}i=!0;for(let o=s.length-2;o>=0&&i;o-=2){const d=Math.floor(s[o]),h=Math.floor(s[o+1]);if(d<-1||d>r||h<-1||h>a)throw new $;i=!1,d===-1?(s[o]=0,i=!0):d===r&&(s[o]=r-1,i=!0),h===-1?(s[o+1]=0,i=!0):h===a&&(s[o+1]=a-1,i=!0)}}}class Ie{constructor(t,s,r,a,i,o,d,h,m){this.a11=t,this.a21=s,this.a31=r,this.a12=a,this.a22=i,this.a32=o,this.a13=d,this.a23=h,this.a33=m}static quadrilateralToQuadrilateral(t,s,r,a,i,o,d,h,m,y,T,z,Y,ce,ue,Se){const ze=Ie.quadrilateralToSquare(t,s,r,a,i,o,d,h);return Ie.squareToQuadrilateral(m,y,T,z,Y,ce,ue,Se).times(ze)}transformPoints(t){const s=t.length,r=this.a11,a=this.a12,i=this.a13,o=this.a21,d=this.a22,h=this.a23,m=this.a31,y=this.a32,T=this.a33;for(let z=0;z<s;z+=2){const Y=t[z],ce=t[z+1],ue=i*Y+h*ce+T;t[z]=(r*Y+o*ce+m)/ue,t[z+1]=(a*Y+d*ce+y)/ue}}transformPointsWithValues(t,s){const r=this.a11,a=this.a12,i=this.a13,o=this.a21,d=this.a22,h=this.a23,m=this.a31,y=this.a32,T=this.a33,z=t.length;for(let Y=0;Y<z;Y++){const ce=t[Y],ue=s[Y],Se=i*ce+h*ue+T;t[Y]=(r*ce+o*ue+m)/Se,s[Y]=(a*ce+d*ue+y)/Se}}static squareToQuadrilateral(t,s,r,a,i,o,d,h){const m=t-r+i-d,y=s-a+o-h;if(m===0&&y===0)return new Ie(r-t,i-r,t,a-s,o-a,s,0,0,1);{const T=r-i,z=d-i,Y=a-o,ce=h-o,ue=T*ce-z*Y,Se=(m*ce-z*y)/ue,ze=(T*y-m*Y)/ue;return new Ie(r-t+Se*r,d-t+ze*d,t,a-s+Se*a,h-s+ze*h,s,Se,ze,1)}}static quadrilateralToSquare(t,s,r,a,i,o,d,h){return Ie.squareToQuadrilateral(t,s,r,a,i,o,d,h).buildAdjoint()}buildAdjoint(){return new Ie(this.a22*this.a33-this.a23*this.a32,this.a23*this.a31-this.a21*this.a33,this.a21*this.a32-this.a22*this.a31,this.a13*this.a32-this.a12*this.a33,this.a11*this.a33-this.a13*this.a31,this.a12*this.a31-this.a11*this.a32,this.a12*this.a23-this.a13*this.a22,this.a13*this.a21-this.a11*this.a23,this.a11*this.a22-this.a12*this.a21)}times(t){return new Ie(this.a11*t.a11+this.a21*t.a12+this.a31*t.a13,this.a11*t.a21+this.a21*t.a22+this.a31*t.a23,this.a11*t.a31+this.a21*t.a32+this.a31*t.a33,this.a12*t.a11+this.a22*t.a12+this.a32*t.a13,this.a12*t.a21+this.a22*t.a22+this.a32*t.a23,this.a12*t.a31+this.a22*t.a32+this.a32*t.a33,this.a13*t.a11+this.a23*t.a12+this.a33*t.a13,this.a13*t.a21+this.a23*t.a22+this.a33*t.a23,this.a13*t.a31+this.a23*t.a32+this.a33*t.a33)}}class Re extends fe{sampleGrid(t,s,r,a,i,o,d,h,m,y,T,z,Y,ce,ue,Se,ze,We,$e){const Ve=Ie.quadrilateralToQuadrilateral(a,i,o,d,h,m,y,T,z,Y,ce,ue,Se,ze,We,$e);return this.sampleGridWithTransform(t,s,r,Ve)}sampleGridWithTransform(t,s,r,a){if(s<=0||r<=0)throw new $;const i=new G(s,r),o=new Float32Array(2*s);for(let d=0;d<r;d++){const h=o.length,m=d+.5;for(let y=0;y<h;y+=2)o[y]=y/2+.5,o[y+1]=m;a.transformPoints(o),fe.checkAndNudgePoints(t,o);try{for(let y=0;y<h;y+=2)t.get(Math.floor(o[y]),Math.floor(o[y+1]))&&i.set(y/2,d)}catch{throw new $}}return i}}class ee{static setGridSampler(t){ee.gridSampler=t}static getInstance(){return ee.gridSampler}}ee.gridSampler=new Re;class oe{constructor(t,s){this.x=t,this.y=s}toResultPoint(){return new Ye(this.getX(),this.getY())}getX(){return this.x}getY(){return this.y}}class De{constructor(t){this.EXPECTED_CORNER_BITS=new Int32Array([3808,476,2107,1799]),this.image=t}detect(){return this.detectMirror(!1)}detectMirror(t){let s=this.getMatrixCenter(),r=this.getBullsEyeCorners(s);if(t){let o=r[0];r[0]=r[2],r[2]=o}this.extractParameters(r);let a=this.sampleGrid(this.image,r[this.shift%4],r[(this.shift+1)%4],r[(this.shift+2)%4],r[(this.shift+3)%4]),i=this.getMatrixCornerPoints(r);return new H(a,i,this.compact,this.nbDataBlocks,this.nbLayers)}extractParameters(t){if(!this.isValidPoint(t[0])||!this.isValidPoint(t[1])||!this.isValidPoint(t[2])||!this.isValidPoint(t[3]))throw new $;let s=2*this.nbCenterLayers,r=new Int32Array([this.sampleLine(t[0],t[1],s),this.sampleLine(t[1],t[2],s),this.sampleLine(t[2],t[3],s),this.sampleLine(t[3],t[0],s)]);this.shift=this.getRotation(r,s);let a=0;for(let o=0;o<4;o++){let d=r[(this.shift+o)%4];this.compact?(a<<=7,a+=d>>1&127):(a<<=10,a+=(d>>2&992)+(d>>1&31))}let i=this.getCorrectedParameterData(a,this.compact);this.compact?(this.nbLayers=(i>>6)+1,this.nbDataBlocks=(i&63)+1):(this.nbLayers=(i>>11)+1,this.nbDataBlocks=(i&2047)+1)}getRotation(t,s){let r=0;t.forEach((a,i,o)=>{let d=(a>>s-2<<1)+(a&1);r=(r<<3)+d}),r=((r&1)<<11)+(r>>1);for(let a=0;a<4;a++)if(U.bitCount(r^this.EXPECTED_CORNER_BITS[a])<=2)return a;throw new $}getCorrectedParameterData(t,s){let r,a;s?(r=7,a=2):(r=10,a=4);let i=r-a,o=new Int32Array(r);for(let h=r-1;h>=0;--h)o[h]=t&15,t>>=4;try{new at(Ue.AZTEC_PARAM).decode(o,i)}catch{throw new $}let d=0;for(let h=0;h<a;h++)d=(d<<4)+o[h];return d}getBullsEyeCorners(t){let s=t,r=t,a=t,i=t,o=!0;for(this.nbCenterLayers=1;this.nbCenterLayers<9;this.nbCenterLayers++){let T=this.getFirstDifferent(s,o,1,-1),z=this.getFirstDifferent(r,o,1,1),Y=this.getFirstDifferent(a,o,-1,1),ce=this.getFirstDifferent(i,o,-1,-1);if(this.nbCenterLayers>2){let ue=this.distancePoint(ce,T)*this.nbCenterLayers/(this.distancePoint(i,s)*(this.nbCenterLayers+2));if(ue<.75||ue>1.25||!this.isWhiteOrBlackRectangle(T,z,Y,ce))break}s=T,r=z,a=Y,i=ce,o=!o}if(this.nbCenterLayers!==5&&this.nbCenterLayers!==7)throw new $;this.compact=this.nbCenterLayers===5;let d=new Ye(s.getX()+.5,s.getY()-.5),h=new Ye(r.getX()+.5,r.getY()+.5),m=new Ye(a.getX()-.5,a.getY()+.5),y=new Ye(i.getX()-.5,i.getY()-.5);return this.expandSquare([d,h,m,y],2*this.nbCenterLayers-3,2*this.nbCenterLayers)}getMatrixCenter(){let t,s,r,a;try{let d=new ne(this.image).detect();t=d[0],s=d[1],r=d[2],a=d[3]}catch{let h=this.image.getWidth()/2,m=this.image.getHeight()/2;t=this.getFirstDifferent(new oe(h+7,m-7),!1,1,-1).toResultPoint(),s=this.getFirstDifferent(new oe(h+7,m+7),!1,1,1).toResultPoint(),r=this.getFirstDifferent(new oe(h-7,m+7),!1,-1,1).toResultPoint(),a=this.getFirstDifferent(new oe(h-7,m-7),!1,-1,-1).toResultPoint()}let i=Ge.round((t.getX()+a.getX()+s.getX()+r.getX())/4),o=Ge.round((t.getY()+a.getY()+s.getY()+r.getY())/4);try{let d=new ne(this.image,15,i,o).detect();t=d[0],s=d[1],r=d[2],a=d[3]}catch{t=this.getFirstDifferent(new oe(i+7,o-7),!1,1,-1).toResultPoint(),s=this.getFirstDifferent(new oe(i+7,o+7),!1,1,1).toResultPoint(),r=this.getFirstDifferent(new oe(i-7,o+7),!1,-1,1).toResultPoint(),a=this.getFirstDifferent(new oe(i-7,o-7),!1,-1,-1).toResultPoint()}return i=Ge.round((t.getX()+a.getX()+s.getX()+r.getX())/4),o=Ge.round((t.getY()+a.getY()+s.getY()+r.getY())/4),new oe(i,o)}getMatrixCornerPoints(t){return this.expandSquare(t,2*this.nbCenterLayers,this.getDimension())}sampleGrid(t,s,r,a,i){let o=ee.getInstance(),d=this.getDimension(),h=d/2-this.nbCenterLayers,m=d/2+this.nbCenterLayers;return o.sampleGrid(t,d,d,h,h,m,h,m,m,h,m,s.getX(),s.getY(),r.getX(),r.getY(),a.getX(),a.getY(),i.getX(),i.getY())}sampleLine(t,s,r){let a=0,i=this.distanceResultPoint(t,s),o=i/r,d=t.getX(),h=t.getY(),m=o*(s.getX()-t.getX())/i,y=o*(s.getY()-t.getY())/i;for(let T=0;T<r;T++)this.image.get(Ge.round(d+T*m),Ge.round(h+T*y))&&(a|=1<<r-T-1);return a}isWhiteOrBlackRectangle(t,s,r,a){let i=3;t=new oe(t.getX()-i,t.getY()+i),s=new oe(s.getX()-i,s.getY()-i),r=new oe(r.getX()+i,r.getY()-i),a=new oe(a.getX()+i,a.getY()+i);let o=this.getColor(a,t);if(o===0)return!1;let d=this.getColor(t,s);return d!==o||(d=this.getColor(s,r),d!==o)?!1:(d=this.getColor(r,a),d===o)}getColor(t,s){let r=this.distancePoint(t,s),a=(s.getX()-t.getX())/r,i=(s.getY()-t.getY())/r,o=0,d=t.getX(),h=t.getY(),m=this.image.get(t.getX(),t.getY()),y=Math.ceil(r);for(let z=0;z<y;z++)d+=a,h+=i,this.image.get(Ge.round(d),Ge.round(h))!==m&&o++;let T=o/r;return T>.1&&T<.9?0:T<=.1===m?1:-1}getFirstDifferent(t,s,r,a){let i=t.getX()+r,o=t.getY()+a;for(;this.isValid(i,o)&&this.image.get(i,o)===s;)i+=r,o+=a;for(i-=r,o-=a;this.isValid(i,o)&&this.image.get(i,o)===s;)i+=r;for(i-=r;this.isValid(i,o)&&this.image.get(i,o)===s;)o+=a;return o-=a,new oe(i,o)}expandSquare(t,s,r){let a=r/(2*s),i=t[0].getX()-t[2].getX(),o=t[0].getY()-t[2].getY(),d=(t[0].getX()+t[2].getX())/2,h=(t[0].getY()+t[2].getY())/2,m=new Ye(d+a*i,h+a*o),y=new Ye(d-a*i,h-a*o);i=t[1].getX()-t[3].getX(),o=t[1].getY()-t[3].getY(),d=(t[1].getX()+t[3].getX())/2,h=(t[1].getY()+t[3].getY())/2;let T=new Ye(d+a*i,h+a*o),z=new Ye(d-a*i,h-a*o);return[m,T,y,z]}isValid(t,s){return t>=0&&t<this.image.getWidth()&&s>0&&s<this.image.getHeight()}isValidPoint(t){let s=Ge.round(t.getX()),r=Ge.round(t.getY());return this.isValid(s,r)}distancePoint(t,s){return Ge.distance(t.getX(),t.getY(),s.getX(),s.getY())}distanceResultPoint(t,s){return Ge.distance(t.getX(),t.getY(),s.getX(),s.getY())}getDimension(){return this.compact?4*this.nbLayers+11:this.nbLayers<=4?4*this.nbLayers+15:4*this.nbLayers+2*(U.truncDivision(this.nbLayers-4,8)+1)+15}}class Ee{decode(t,s=null){let r=null,a=new De(t.getBlackMatrix()),i=null,o=null;try{let y=a.detectMirror(!1);i=y.getPoints(),this.reportFoundResultPoints(s,i),o=new Je().decode(y)}catch(y){r=y}if(o==null)try{let y=a.detectMirror(!0);i=y.getPoints(),this.reportFoundResultPoints(s,i),o=new Je().decode(y)}catch(y){throw r??y}let d=new V(o.getText(),o.getRawBytes(),o.getNumBits(),i,ae.AZTEC,R.currentTimeMillis()),h=o.getByteSegments();h!=null&&d.putMetadata(be.BYTE_SEGMENTS,h);let m=o.getECLevel();return m!=null&&d.putMetadata(be.ERROR_CORRECTION_LEVEL,m),d}reportFoundResultPoints(t,s){if(t!=null){let r=t.get(N.NEED_RESULT_POINT_CALLBACK);r!=null&&s.forEach((a,i,o)=>{r.foundPossibleResultPoint(a)})}}reset(){}}class te extends Q{constructor(t=500){super(new Ee,t)}}class ke{decode(t,s){try{return this.doDecode(t,s)}catch{if(s&&s.get(N.TRY_HARDER)===!0&&t.isRotateSupported()){const i=t.rotateCounterClockwise(),o=this.doDecode(i,s),d=o.getResultMetadata();let h=270;d!==null&&d.get(be.ORIENTATION)===!0&&(h=h+d.get(be.ORIENTATION)%360),o.putMetadata(be.ORIENTATION,h);const m=o.getResultPoints();if(m!==null){const y=i.getHeight();for(let T=0;T<m.length;T++)m[T]=new Ye(y-m[T].getY()-1,m[T].getX())}return o}else throw new $}}reset(){}doDecode(t,s){const r=t.getWidth(),a=t.getHeight();let i=new q(r);const o=s&&s.get(N.TRY_HARDER)===!0,d=Math.max(1,a>>(o?8:5));let h;o?h=a:h=15;const m=Math.trunc(a/2);for(let y=0;y<h;y++){const T=Math.trunc((y+1)/2),z=(y&1)===0,Y=m+d*(z?T:-T);if(Y<0||Y>=a)break;try{i=t.getBlackRow(Y,i)}catch{continue}for(let ce=0;ce<2;ce++){if(ce===1&&(i.reverse(),s&&s.get(N.NEED_RESULT_POINT_CALLBACK)===!0)){const ue=new Map;s.forEach((Se,ze)=>ue.set(ze,Se)),ue.delete(N.NEED_RESULT_POINT_CALLBACK),s=ue}try{const ue=this.decodeRow(Y,i,s);if(ce===1){ue.putMetadata(be.ORIENTATION,180);const Se=ue.getResultPoints();Se!==null&&(Se[0]=new Ye(r-Se[0].getX()-1,Se[0].getY()),Se[1]=new Ye(r-Se[1].getX()-1,Se[1].getY()))}return ue}catch{}}}throw new $}static recordPattern(t,s,r){const a=r.length;for(let m=0;m<a;m++)r[m]=0;const i=t.getSize();if(s>=i)throw new $;let o=!t.get(s),d=0,h=s;for(;h<i;){if(t.get(h)!==o)r[d]++;else{if(++d===a)break;r[d]=1,o=!o}h++}if(!(d===a||d===a-1&&h===i))throw new $}static recordPatternInReverse(t,s,r){let a=r.length,i=t.get(s);for(;s>0&&a>=0;)t.get(--s)!==i&&(a--,i=!i);if(a>=0)throw new $;ke.recordPattern(t,s+1,r)}static patternMatchVariance(t,s,r){const a=t.length;let i=0,o=0;for(let m=0;m<a;m++)i+=t[m],o+=s[m];if(i<o)return Number.POSITIVE_INFINITY;const d=i/o;r*=d;let h=0;for(let m=0;m<a;m++){const y=t[m],T=s[m]*d,z=y>T?y-T:T-y;if(z>r)return Number.POSITIVE_INFINITY;h+=z}return h/i}}class Z extends ke{static findStartPattern(t){const s=t.getSize(),r=t.getNextSet(0);let a=0,i=Int32Array.from([0,0,0,0,0,0]),o=r,d=!1;const h=6;for(let m=r;m<s;m++)if(t.get(m)!==d)i[a]++;else{if(a===h-1){let y=Z.MAX_AVG_VARIANCE,T=-1;for(let z=Z.CODE_START_A;z<=Z.CODE_START_C;z++){const Y=ke.patternMatchVariance(i,Z.CODE_PATTERNS[z],Z.MAX_INDIVIDUAL_VARIANCE);Y<y&&(y=Y,T=z)}if(T>=0&&t.isRange(Math.max(0,o-(m-o)/2),o,!1))return Int32Array.from([o,m,T]);o+=i[0]+i[1],i=i.slice(2,i.length-1),i[a-1]=0,i[a]=0,a--}else a++;i[a]=1,d=!d}throw new $}static decodeCode(t,s,r){ke.recordPattern(t,r,s);let a=Z.MAX_AVG_VARIANCE,i=-1;for(let o=0;o<Z.CODE_PATTERNS.length;o++){const d=Z.CODE_PATTERNS[o],h=this.patternMatchVariance(s,d,Z.MAX_INDIVIDUAL_VARIANCE);h<a&&(a=h,i=o)}if(i>=0)return i;throw new $}decodeRow(t,s,r){const a=r&&r.get(N.ASSUME_GS1)===!0,i=Z.findStartPattern(s),o=i[2];let d=0;const h=new Uint8Array(20);h[d++]=o;let m;switch(o){case Z.CODE_START_A:m=Z.CODE_CODE_A;break;case Z.CODE_START_B:m=Z.CODE_CODE_B;break;case Z.CODE_START_C:m=Z.CODE_CODE_C;break;default:throw new _}let y=!1,T=!1,z="",Y=i[0],ce=i[1];const ue=Int32Array.from([0,0,0,0,0,0]);let Se=0,ze=0,We=o,$e=0,Ve=!0,vt=!1,mt=!1;for(;!y;){const Sr=T;switch(T=!1,Se=ze,ze=Z.decodeCode(s,ue,ce),h[d++]=ze,ze!==Z.CODE_STOP&&(Ve=!0),ze!==Z.CODE_STOP&&($e++,We+=$e*ze),Y=ce,ce+=ue.reduce((lo,co)=>lo+co,0),ze){case Z.CODE_START_A:case Z.CODE_START_B:case Z.CODE_START_C:throw new _}switch(m){case Z.CODE_CODE_A:if(ze<64)mt===vt?z+=String.fromCharCode(32+ze):z+=String.fromCharCode(32+ze+128),mt=!1;else if(ze<96)mt===vt?z+=String.fromCharCode(ze-64):z+=String.fromCharCode(ze+64),mt=!1;else switch(ze!==Z.CODE_STOP&&(Ve=!1),ze){case Z.CODE_FNC_1:a&&(z.length===0?z+="]C1":z+="");break;case Z.CODE_FNC_2:case Z.CODE_FNC_3:break;case Z.CODE_FNC_4_A:!vt&&mt?(vt=!0,mt=!1):vt&&mt?(vt=!1,mt=!1):mt=!0;break;case Z.CODE_SHIFT:T=!0,m=Z.CODE_CODE_B;break;case Z.CODE_CODE_B:m=Z.CODE_CODE_B;break;case Z.CODE_CODE_C:m=Z.CODE_CODE_C;break;case Z.CODE_STOP:y=!0;break}break;case Z.CODE_CODE_B:if(ze<96)mt===vt?z+=String.fromCharCode(32+ze):z+=String.fromCharCode(32+ze+128),mt=!1;else switch(ze!==Z.CODE_STOP&&(Ve=!1),ze){case Z.CODE_FNC_1:a&&(z.length===0?z+="]C1":z+="");break;case Z.CODE_FNC_2:case Z.CODE_FNC_3:break;case Z.CODE_FNC_4_B:!vt&&mt?(vt=!0,mt=!1):vt&&mt?(vt=!1,mt=!1):mt=!0;break;case Z.CODE_SHIFT:T=!0,m=Z.CODE_CODE_A;break;case Z.CODE_CODE_A:m=Z.CODE_CODE_A;break;case Z.CODE_CODE_C:m=Z.CODE_CODE_C;break;case Z.CODE_STOP:y=!0;break}break;case Z.CODE_CODE_C:if(ze<100)ze<10&&(z+="0"),z+=ze;else switch(ze!==Z.CODE_STOP&&(Ve=!1),ze){case Z.CODE_FNC_1:a&&(z.length===0?z+="]C1":z+="");break;case Z.CODE_CODE_A:m=Z.CODE_CODE_A;break;case Z.CODE_CODE_B:m=Z.CODE_CODE_B;break;case Z.CODE_STOP:y=!0;break}break}Sr&&(m=m===Z.CODE_CODE_A?Z.CODE_CODE_B:Z.CODE_CODE_A)}const gs=ce-Y;if(ce=s.getNextUnset(ce),!s.isRange(ce,Math.min(s.getSize(),ce+(ce-Y)/2),!1))throw new $;if(We-=$e*Se,We%103!==Se)throw new B;const Rs=z.length;if(Rs===0)throw new $;Rs>0&&Ve&&(m===Z.CODE_CODE_C?z=z.substring(0,Rs-2):z=z.substring(0,Rs-1));const ps=(i[1]+i[0])/2,Mt=Y+gs/2,is=h.length,Ns=new Uint8Array(is);for(let Sr=0;Sr<is;Sr++)Ns[Sr]=h[Sr];const Er=[new Ye(ps,t),new Ye(Mt,t)];return new V(z,Ns,0,Er,ae.CODE_128,new Date().getTime())}}Z.CODE_PATTERNS=[Int32Array.from([2,1,2,2,2,2]),Int32Array.from([2,2,2,1,2,2]),Int32Array.from([2,2,2,2,2,1]),Int32Array.from([1,2,1,2,2,3]),Int32Array.from([1,2,1,3,2,2]),Int32Array.from([1,3,1,2,2,2]),Int32Array.from([1,2,2,2,1,3]),Int32Array.from([1,2,2,3,1,2]),Int32Array.from([1,3,2,2,1,2]),Int32Array.from([2,2,1,2,1,3]),Int32Array.from([2,2,1,3,1,2]),Int32Array.from([2,3,1,2,1,2]),Int32Array.from([1,1,2,2,3,2]),Int32Array.from([1,2,2,1,3,2]),Int32Array.from([1,2,2,2,3,1]),Int32Array.from([1,1,3,2,2,2]),Int32Array.from([1,2,3,1,2,2]),Int32Array.from([1,2,3,2,2,1]),Int32Array.from([2,2,3,2,1,1]),Int32Array.from([2,2,1,1,3,2]),Int32Array.from([2,2,1,2,3,1]),Int32Array.from([2,1,3,2,1,2]),Int32Array.from([2,2,3,1,1,2]),Int32Array.from([3,1,2,1,3,1]),Int32Array.from([3,1,1,2,2,2]),Int32Array.from([3,2,1,1,2,2]),Int32Array.from([3,2,1,2,2,1]),Int32Array.from([3,1,2,2,1,2]),Int32Array.from([3,2,2,1,1,2]),Int32Array.from([3,2,2,2,1,1]),Int32Array.from([2,1,2,1,2,3]),Int32Array.from([2,1,2,3,2,1]),Int32Array.from([2,3,2,1,2,1]),Int32Array.from([1,1,1,3,2,3]),Int32Array.from([1,3,1,1,2,3]),Int32Array.from([1,3,1,3,2,1]),Int32Array.from([1,1,2,3,1,3]),Int32Array.from([1,3,2,1,1,3]),Int32Array.from([1,3,2,3,1,1]),Int32Array.from([2,1,1,3,1,3]),Int32Array.from([2,3,1,1,1,3]),Int32Array.from([2,3,1,3,1,1]),Int32Array.from([1,1,2,1,3,3]),Int32Array.from([1,1,2,3,3,1]),Int32Array.from([1,3,2,1,3,1]),Int32Array.from([1,1,3,1,2,3]),Int32Array.from([1,1,3,3,2,1]),Int32Array.from([1,3,3,1,2,1]),Int32Array.from([3,1,3,1,2,1]),Int32Array.from([2,1,1,3,3,1]),Int32Array.from([2,3,1,1,3,1]),Int32Array.from([2,1,3,1,1,3]),Int32Array.from([2,1,3,3,1,1]),Int32Array.from([2,1,3,1,3,1]),Int32Array.from([3,1,1,1,2,3]),Int32Array.from([3,1,1,3,2,1]),Int32Array.from([3,3,1,1,2,1]),Int32Array.from([3,1,2,1,1,3]),Int32Array.from([3,1,2,3,1,1]),Int32Array.from([3,3,2,1,1,1]),Int32Array.from([3,1,4,1,1,1]),Int32Array.from([2,2,1,4,1,1]),Int32Array.from([4,3,1,1,1,1]),Int32Array.from([1,1,1,2,2,4]),Int32Array.from([1,1,1,4,2,2]),Int32Array.from([1,2,1,1,2,4]),Int32Array.from([1,2,1,4,2,1]),Int32Array.from([1,4,1,1,2,2]),Int32Array.from([1,4,1,2,2,1]),Int32Array.from([1,1,2,2,1,4]),Int32Array.from([1,1,2,4,1,2]),Int32Array.from([1,2,2,1,1,4]),Int32Array.from([1,2,2,4,1,1]),Int32Array.from([1,4,2,1,1,2]),Int32Array.from([1,4,2,2,1,1]),Int32Array.from([2,4,1,2,1,1]),Int32Array.from([2,2,1,1,1,4]),Int32Array.from([4,1,3,1,1,1]),Int32Array.from([2,4,1,1,1,2]),Int32Array.from([1,3,4,1,1,1]),Int32Array.from([1,1,1,2,4,2]),Int32Array.from([1,2,1,1,4,2]),Int32Array.from([1,2,1,2,4,1]),Int32Array.from([1,1,4,2,1,2]),Int32Array.from([1,2,4,1,1,2]),Int32Array.from([1,2,4,2,1,1]),Int32Array.from([4,1,1,2,1,2]),Int32Array.from([4,2,1,1,1,2]),Int32Array.from([4,2,1,2,1,1]),Int32Array.from([2,1,2,1,4,1]),Int32Array.from([2,1,4,1,2,1]),Int32Array.from([4,1,2,1,2,1]),Int32Array.from([1,1,1,1,4,3]),Int32Array.from([1,1,1,3,4,1]),Int32Array.from([1,3,1,1,4,1]),Int32Array.from([1,1,4,1,1,3]),Int32Array.from([1,1,4,3,1,1]),Int32Array.from([4,1,1,1,1,3]),Int32Array.from([4,1,1,3,1,1]),Int32Array.from([1,1,3,1,4,1]),Int32Array.from([1,1,4,1,3,1]),Int32Array.from([3,1,1,1,4,1]),Int32Array.from([4,1,1,1,3,1]),Int32Array.from([2,1,1,4,1,2]),Int32Array.from([2,1,1,2,1,4]),Int32Array.from([2,1,1,2,3,2]),Int32Array.from([2,3,3,1,1,1,2])],Z.MAX_AVG_VARIANCE=.25,Z.MAX_INDIVIDUAL_VARIANCE=.7,Z.CODE_SHIFT=98,Z.CODE_CODE_C=99,Z.CODE_CODE_B=100,Z.CODE_CODE_A=101,Z.CODE_FNC_1=102,Z.CODE_FNC_2=97,Z.CODE_FNC_3=96,Z.CODE_FNC_4_A=101,Z.CODE_FNC_4_B=100,Z.CODE_START_A=103,Z.CODE_START_B=104,Z.CODE_START_C=105,Z.CODE_STOP=106;class he extends ke{constructor(t=!1,s=!1){super(),this.usingCheckDigit=t,this.extendedMode=s,this.decodeRowResult="",this.counters=new Int32Array(9)}decodeRow(t,s,r){let a=this.counters;a.fill(0),this.decodeRowResult="";let i=he.findAsteriskPattern(s,a),o=s.getNextSet(i[1]),d=s.getSize(),h,m;do{he.recordPattern(s,o,a);let ue=he.toNarrowWidePattern(a);if(ue<0)throw new $;h=he.patternToChar(ue),this.decodeRowResult+=h,m=o;for(let Se of a)o+=Se;o=s.getNextSet(o)}while(h!=="*");this.decodeRowResult=this.decodeRowResult.substring(0,this.decodeRowResult.length-1);let y=0;for(let ue of a)y+=ue;let T=o-m-y;if(o!==d&&T*2<y)throw new $;if(this.usingCheckDigit){let ue=this.decodeRowResult.length-1,Se=0;for(let ze=0;ze<ue;ze++)Se+=he.ALPHABET_STRING.indexOf(this.decodeRowResult.charAt(ze));if(this.decodeRowResult.charAt(ue)!==he.ALPHABET_STRING.charAt(Se%43))throw new B;this.decodeRowResult=this.decodeRowResult.substring(0,ue)}if(this.decodeRowResult.length===0)throw new $;let z;this.extendedMode?z=he.decodeExtended(this.decodeRowResult):z=this.decodeRowResult;let Y=(i[1]+i[0])/2,ce=m+y/2;return new V(z,null,0,[new Ye(Y,t),new Ye(ce,t)],ae.CODE_39,new Date().getTime())}static findAsteriskPattern(t,s){let r=t.getSize(),a=t.getNextSet(0),i=0,o=a,d=!1,h=s.length;for(let m=a;m<r;m++)if(t.get(m)!==d)s[i]++;else{if(i===h-1){if(this.toNarrowWidePattern(s)===he.ASTERISK_ENCODING&&t.isRange(Math.max(0,o-Math.floor((m-o)/2)),o,!1))return[o,m];o+=s[0]+s[1],s.copyWithin(0,2,2+i-1),s[i-1]=0,s[i]=0,i--}else i++;s[i]=1,d=!d}throw new $}static toNarrowWidePattern(t){let s=t.length,r=0,a;do{let i=2147483647;for(let h of t)h<i&&h>r&&(i=h);r=i,a=0;let o=0,d=0;for(let h=0;h<s;h++){let m=t[h];m>r&&(d|=1<<s-1-h,a++,o+=m)}if(a===3){for(let h=0;h<s&&a>0;h++){let m=t[h];if(m>r&&(a--,m*2>=o))return-1}return d}}while(a>3);return-1}static patternToChar(t){for(let s=0;s<he.CHARACTER_ENCODINGS.length;s++)if(he.CHARACTER_ENCODINGS[s]===t)return he.ALPHABET_STRING.charAt(s);if(t===he.ASTERISK_ENCODING)return"*";throw new $}static decodeExtended(t){let s=t.length,r="";for(let a=0;a<s;a++){let i=t.charAt(a);if(i==="+"||i==="$"||i==="%"||i==="/"){let o=t.charAt(a+1),d="\0";switch(i){case"+":if(o>="A"&&o<="Z")d=String.fromCharCode(o.charCodeAt(0)+32);else throw new _;break;case"$":if(o>="A"&&o<="Z")d=String.fromCharCode(o.charCodeAt(0)-64);else throw new _;break;case"%":if(o>="A"&&o<="E")d=String.fromCharCode(o.charCodeAt(0)-38);else if(o>="F"&&o<="J")d=String.fromCharCode(o.charCodeAt(0)-11);else if(o>="K"&&o<="O")d=String.fromCharCode(o.charCodeAt(0)+16);else if(o>="P"&&o<="T")d=String.fromCharCode(o.charCodeAt(0)+43);else if(o==="U")d="\0";else if(o==="V")d="@";else if(o==="W")d="`";else if(o==="X"||o==="Y"||o==="Z")d="";else throw new _;break;case"/":if(o>="A"&&o<="O")d=String.fromCharCode(o.charCodeAt(0)-32);else if(o==="Z")d=":";else throw new _;break}r+=d,a++}else r+=i}return r}}he.ALPHABET_STRING="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-. $/+%",he.CHARACTER_ENCODINGS=[52,289,97,352,49,304,112,37,292,100,265,73,328,25,280,88,13,268,76,28,259,67,322,19,274,82,7,262,70,22,385,193,448,145,400,208,133,388,196,168,162,138,42],he.ASTERISK_ENCODING=148;class we extends ke{constructor(){super(...arguments),this.narrowLineWidth=-1}decodeRow(t,s,r){let a=this.decodeStart(s),i=this.decodeEnd(s),o=new se;we.decodeMiddle(s,a[1],i[0],o);let d=o.toString(),h=null;r!=null&&(h=r.get(N.ALLOWED_LENGTHS)),h==null&&(h=we.DEFAULT_ALLOWED_LENGTHS);let m=d.length,y=!1,T=0;for(let ce of h){if(m===ce){y=!0;break}ce>T&&(T=ce)}if(!y&&m>T&&(y=!0),!y)throw new _;const z=[new Ye(a[1],t),new Ye(i[0],t)];return new V(d,null,0,z,ae.ITF,new Date().getTime())}static decodeMiddle(t,s,r,a){let i=new Int32Array(10),o=new Int32Array(5),d=new Int32Array(5);for(i.fill(0),o.fill(0),d.fill(0);s<r;){ke.recordPattern(t,s,i);for(let m=0;m<5;m++){let y=2*m;o[m]=i[y],d[m]=i[y+1]}let h=we.decodeDigit(o);a.append(h.toString()),h=this.decodeDigit(d),a.append(h.toString()),i.forEach(function(m){s+=m})}}decodeStart(t){let s=we.skipWhiteSpace(t),r=we.findGuardPattern(t,s,we.START_PATTERN);return this.narrowLineWidth=(r[1]-r[0])/4,this.validateQuietZone(t,r[0]),r}validateQuietZone(t,s){let r=this.narrowLineWidth*10;r=r<s?r:s;for(let a=s-1;r>0&&a>=0&&!t.get(a);a--)r--;if(r!==0)throw new $}static skipWhiteSpace(t){const s=t.getSize(),r=t.getNextSet(0);if(r===s)throw new $;return r}decodeEnd(t){t.reverse();try{let s=we.skipWhiteSpace(t),r;try{r=we.findGuardPattern(t,s,we.END_PATTERN_REVERSED[0])}catch(i){i instanceof $&&(r=we.findGuardPattern(t,s,we.END_PATTERN_REVERSED[1]))}this.validateQuietZone(t,r[0]);let a=r[0];return r[0]=t.getSize()-r[1],r[1]=t.getSize()-a,r}finally{t.reverse()}}static findGuardPattern(t,s,r){let a=r.length,i=new Int32Array(a),o=t.getSize(),d=!1,h=0,m=s;i.fill(0);for(let y=s;y<o;y++)if(t.get(y)!==d)i[h]++;else{if(h===a-1){if(ke.patternMatchVariance(i,r,we.MAX_INDIVIDUAL_VARIANCE)<we.MAX_AVG_VARIANCE)return[m,y];m+=i[0]+i[1],R.arraycopy(i,2,i,0,h-1),i[h-1]=0,i[h]=0,h--}else h++;i[h]=1,d=!d}throw new $}static decodeDigit(t){let s=we.MAX_AVG_VARIANCE,r=-1,a=we.PATTERNS.length;for(let i=0;i<a;i++){let o=we.PATTERNS[i],d=ke.patternMatchVariance(t,o,we.MAX_INDIVIDUAL_VARIANCE);d<s?(s=d,r=i):d===s&&(r=-1)}if(r>=0)return r%10;throw new $}}we.PATTERNS=[Int32Array.from([1,1,2,2,1]),Int32Array.from([2,1,1,1,2]),Int32Array.from([1,2,1,1,2]),Int32Array.from([2,2,1,1,1]),Int32Array.from([1,1,2,1,2]),Int32Array.from([2,1,2,1,1]),Int32Array.from([1,2,2,1,1]),Int32Array.from([1,1,1,2,2]),Int32Array.from([2,1,1,2,1]),Int32Array.from([1,2,1,2,1]),Int32Array.from([1,1,3,3,1]),Int32Array.from([3,1,1,1,3]),Int32Array.from([1,3,1,1,3]),Int32Array.from([3,3,1,1,1]),Int32Array.from([1,1,3,1,3]),Int32Array.from([3,1,3,1,1]),Int32Array.from([1,3,3,1,1]),Int32Array.from([1,1,1,3,3]),Int32Array.from([3,1,1,3,1]),Int32Array.from([1,3,1,3,1])],we.MAX_AVG_VARIANCE=.38,we.MAX_INDIVIDUAL_VARIANCE=.5,we.DEFAULT_ALLOWED_LENGTHS=[6,8,10,12,14],we.START_PATTERN=Int32Array.from([1,1,1,1]),we.END_PATTERN_REVERSED=[Int32Array.from([1,1,2]),Int32Array.from([1,1,3])];class ve extends ke{constructor(){super(...arguments),this.decodeRowStringBuffer=""}static findStartGuardPattern(t){let s=!1,r,a=0,i=Int32Array.from([0,0,0]);for(;!s;){i=Int32Array.from([0,0,0]),r=ve.findGuardPattern(t,a,!1,this.START_END_PATTERN,i);let o=r[0];a=r[1];let d=o-(a-o);d>=0&&(s=t.isRange(d,o,!1))}return r}static checkChecksum(t){return ve.checkStandardUPCEANChecksum(t)}static checkStandardUPCEANChecksum(t){let s=t.length;if(s===0)return!1;let r=parseInt(t.charAt(s-1),10);return ve.getStandardUPCEANChecksum(t.substring(0,s-1))===r}static getStandardUPCEANChecksum(t){let s=t.length,r=0;for(let a=s-1;a>=0;a-=2){let i=t.charAt(a).charCodeAt(0)-48;if(i<0||i>9)throw new _;r+=i}r*=3;for(let a=s-2;a>=0;a-=2){let i=t.charAt(a).charCodeAt(0)-48;if(i<0||i>9)throw new _;r+=i}return(1e3-r)%10}static decodeEnd(t,s){return ve.findGuardPattern(t,s,!1,ve.START_END_PATTERN,new Int32Array(ve.START_END_PATTERN.length).fill(0))}static findGuardPatternWithoutCounters(t,s,r,a){return this.findGuardPattern(t,s,r,a,new Int32Array(a.length))}static findGuardPattern(t,s,r,a,i){let o=t.getSize();s=r?t.getNextUnset(s):t.getNextSet(s);let d=0,h=s,m=a.length,y=r;for(let T=s;T<o;T++)if(t.get(T)!==y)i[d]++;else{if(d===m-1){if(ke.patternMatchVariance(i,a,ve.MAX_INDIVIDUAL_VARIANCE)<ve.MAX_AVG_VARIANCE)return Int32Array.from([h,T]);h+=i[0]+i[1];let z=i.slice(2,i.length-1);for(let Y=0;Y<d-1;Y++)i[Y]=z[Y];i[d-1]=0,i[d]=0,d--}else d++;i[d]=1,y=!y}throw new $}static decodeDigit(t,s,r,a){this.recordPattern(t,r,s);let i=this.MAX_AVG_VARIANCE,o=-1,d=a.length;for(let h=0;h<d;h++){let m=a[h],y=ke.patternMatchVariance(s,m,ve.MAX_INDIVIDUAL_VARIANCE);y<i&&(i=y,o=h)}if(o>=0)return o;throw new $}}ve.MAX_AVG_VARIANCE=.48,ve.MAX_INDIVIDUAL_VARIANCE=.7,ve.START_END_PATTERN=Int32Array.from([1,1,1]),ve.MIDDLE_PATTERN=Int32Array.from([1,1,1,1,1]),ve.END_PATTERN=Int32Array.from([1,1,1,1,1,1]),ve.L_PATTERNS=[Int32Array.from([3,2,1,1]),Int32Array.from([2,2,2,1]),Int32Array.from([2,1,2,2]),Int32Array.from([1,4,1,1]),Int32Array.from([1,1,3,2]),Int32Array.from([1,2,3,1]),Int32Array.from([1,1,1,4]),Int32Array.from([1,3,1,2]),Int32Array.from([1,2,1,3]),Int32Array.from([3,1,1,2])];class Qe{constructor(){this.CHECK_DIGIT_ENCODINGS=[24,20,18,17,12,6,3,10,9,5],this.decodeMiddleCounters=Int32Array.from([0,0,0,0]),this.decodeRowStringBuffer=""}decodeRow(t,s,r){let a=this.decodeRowStringBuffer,i=this.decodeMiddle(s,r,a),o=a.toString(),d=Qe.parseExtensionString(o),h=[new Ye((r[0]+r[1])/2,t),new Ye(i,t)],m=new V(o,null,0,h,ae.UPC_EAN_EXTENSION,new Date().getTime());return d!=null&&m.putAllMetadata(d),m}decodeMiddle(t,s,r){let a=this.decodeMiddleCounters;a[0]=0,a[1]=0,a[2]=0,a[3]=0;let i=t.getSize(),o=s[1],d=0;for(let m=0;m<5&&o<i;m++){let y=ve.decodeDigit(t,a,o,ve.L_AND_G_PATTERNS);r+=String.fromCharCode(48+y%10);for(let T of a)o+=T;y>=10&&(d|=1<<4-m),m!==4&&(o=t.getNextSet(o),o=t.getNextUnset(o))}if(r.length!==5)throw new $;let h=this.determineCheckDigit(d);if(Qe.extensionChecksum(r.toString())!==h)throw new $;return o}static extensionChecksum(t){let s=t.length,r=0;for(let a=s-2;a>=0;a-=2)r+=t.charAt(a).charCodeAt(0)-48;r*=3;for(let a=s-1;a>=0;a-=2)r+=t.charAt(a).charCodeAt(0)-48;return r*=3,r%10}determineCheckDigit(t){for(let s=0;s<10;s++)if(t===this.CHECK_DIGIT_ENCODINGS[s])return s;throw new $}static parseExtensionString(t){if(t.length!==5)return null;let s=Qe.parseExtension5String(t);return s==null?null:new Map([[be.SUGGESTED_PRICE,s]])}static parseExtension5String(t){let s;switch(t.charAt(0)){case"0":s="¬£";break;case"5":s="$";break;case"9":switch(t){case"90000":return null;case"99991":return"0.00";case"99990":return"Used"}s="";break;default:s="";break}let r=parseInt(t.substring(1)),a=(r/100).toString(),i=r%100,o=i<10?"0"+i:i.toString();return s+a+"."+o}}class nt{constructor(){this.decodeMiddleCounters=Int32Array.from([0,0,0,0]),this.decodeRowStringBuffer=""}decodeRow(t,s,r){let a=this.decodeRowStringBuffer,i=this.decodeMiddle(s,r,a),o=a.toString(),d=nt.parseExtensionString(o),h=[new Ye((r[0]+r[1])/2,t),new Ye(i,t)],m=new V(o,null,0,h,ae.UPC_EAN_EXTENSION,new Date().getTime());return d!=null&&m.putAllMetadata(d),m}decodeMiddle(t,s,r){let a=this.decodeMiddleCounters;a[0]=0,a[1]=0,a[2]=0,a[3]=0;let i=t.getSize(),o=s[1],d=0;for(let h=0;h<2&&o<i;h++){let m=ve.decodeDigit(t,a,o,ve.L_AND_G_PATTERNS);r+=String.fromCharCode(48+m%10);for(let y of a)o+=y;m>=10&&(d|=1<<1-h),h!==1&&(o=t.getNextSet(o),o=t.getNextUnset(o))}if(r.length!==2)throw new $;if(parseInt(r.toString())%4!==d)throw new $;return o}static parseExtensionString(t){return t.length!==2?null:new Map([[be.ISSUE_NUMBER,parseInt(t)]])}}class pt{static decodeRow(t,s,r){let a=ve.findGuardPattern(s,r,!1,this.EXTENSION_START_PATTERN,new Int32Array(this.EXTENSION_START_PATTERN.length).fill(0));try{return new Qe().decodeRow(t,s,a)}catch{return new nt().decodeRow(t,s,a)}}}pt.EXTENSION_START_PATTERN=Int32Array.from([1,1,2]);class Oe extends ve{constructor(){super(),this.decodeRowStringBuffer="",Oe.L_AND_G_PATTERNS=Oe.L_PATTERNS.map(t=>Int32Array.from(t));for(let t=10;t<20;t++){let s=Oe.L_PATTERNS[t-10],r=new Int32Array(s.length);for(let a=0;a<s.length;a++)r[a]=s[s.length-a-1];Oe.L_AND_G_PATTERNS[t]=r}}decodeRow(t,s,r){let a=Oe.findStartGuardPattern(s),i=r==null?null:r.get(N.NEED_RESULT_POINT_CALLBACK);if(i!=null){const Ve=new Ye((a[0]+a[1])/2,t);i.foundPossibleResultPoint(Ve)}let o=this.decodeMiddle(s,a,this.decodeRowStringBuffer),d=o.rowOffset,h=o.resultString;if(i!=null){const Ve=new Ye(d,t);i.foundPossibleResultPoint(Ve)}let m=this.decodeEnd(s,d);if(i!=null){const Ve=new Ye((m[0]+m[1])/2,t);i.foundPossibleResultPoint(Ve)}let y=m[1],T=y+(y-m[0]);if(T>=s.getSize()||!s.isRange(y,T,!1))throw new $;let z=h.toString();if(z.length<8)throw new _;if(!Oe.checkChecksum(z))throw new B;let Y=(a[1]+a[0])/2,ce=(m[1]+m[0])/2,ue=this.getBarcodeFormat(),Se=[new Ye(Y,t),new Ye(ce,t)],ze=new V(z,null,0,Se,ue,new Date().getTime()),We=0;try{let Ve=pt.decodeRow(t,s,m[1]);ze.putMetadata(be.UPC_EAN_EXTENSION,Ve.getText()),ze.putAllMetadata(Ve.getResultMetadata()),ze.addResultPoints(Ve.getResultPoints()),We=Ve.getText().length}catch{}let $e=r==null?null:r.get(N.ALLOWED_EAN_EXTENSIONS);if($e!=null){let Ve=!1;for(let vt in $e)if(We.toString()===vt){Ve=!0;break}if(!Ve)throw new $}return ze}decodeEnd(t,s){return Oe.findGuardPattern(t,s,!1,Oe.START_END_PATTERN,new Int32Array(Oe.START_END_PATTERN.length).fill(0))}static checkChecksum(t){return Oe.checkStandardUPCEANChecksum(t)}static checkStandardUPCEANChecksum(t){let s=t.length;if(s===0)return!1;let r=parseInt(t.charAt(s-1),10);return Oe.getStandardUPCEANChecksum(t.substring(0,s-1))===r}static getStandardUPCEANChecksum(t){let s=t.length,r=0;for(let a=s-1;a>=0;a-=2){let i=t.charAt(a).charCodeAt(0)-48;if(i<0||i>9)throw new _;r+=i}r*=3;for(let a=s-2;a>=0;a-=2){let i=t.charAt(a).charCodeAt(0)-48;if(i<0||i>9)throw new _;r+=i}return(1e3-r)%10}}class At extends Oe{constructor(){super(),this.decodeMiddleCounters=Int32Array.from([0,0,0,0])}decodeMiddle(t,s,r){let a=this.decodeMiddleCounters;a[0]=0,a[1]=0,a[2]=0,a[3]=0;let i=t.getSize(),o=s[1],d=0;for(let m=0;m<6&&o<i;m++){let y=Oe.decodeDigit(t,a,o,Oe.L_AND_G_PATTERNS);r+=String.fromCharCode(48+y%10);for(let T of a)o+=T;y>=10&&(d|=1<<5-m)}r=At.determineFirstDigit(r,d),o=Oe.findGuardPattern(t,o,!0,Oe.MIDDLE_PATTERN,new Int32Array(Oe.MIDDLE_PATTERN.length).fill(0))[1];for(let m=0;m<6&&o<i;m++){let y=Oe.decodeDigit(t,a,o,Oe.L_PATTERNS);r+=String.fromCharCode(48+y);for(let T of a)o+=T}return{rowOffset:o,resultString:r}}getBarcodeFormat(){return ae.EAN_13}static determineFirstDigit(t,s){for(let r=0;r<10;r++)if(s===this.FIRST_DIGIT_ENCODINGS[r])return t=String.fromCharCode(48+r)+t,t;throw new $}}At.FIRST_DIGIT_ENCODINGS=[0,11,13,14,19,25,28,21,22,26];class it extends Oe{constructor(){super(),this.decodeMiddleCounters=Int32Array.from([0,0,0,0])}decodeMiddle(t,s,r){const a=this.decodeMiddleCounters;a[0]=0,a[1]=0,a[2]=0,a[3]=0;let i=t.getSize(),o=s[1];for(let h=0;h<4&&o<i;h++){let m=Oe.decodeDigit(t,a,o,Oe.L_PATTERNS);r+=String.fromCharCode(48+m);for(let y of a)o+=y}o=Oe.findGuardPattern(t,o,!0,Oe.MIDDLE_PATTERN,new Int32Array(Oe.MIDDLE_PATTERN.length).fill(0))[1];for(let h=0;h<4&&o<i;h++){let m=Oe.decodeDigit(t,a,o,Oe.L_PATTERNS);r+=String.fromCharCode(48+m);for(let y of a)o+=y}return{rowOffset:o,resultString:r}}getBarcodeFormat(){return ae.EAN_8}}class ks extends Oe{constructor(){super(...arguments),this.ean13Reader=new At}getBarcodeFormat(){return ae.UPC_A}decode(t,s){return this.maybeReturnResult(this.ean13Reader.decode(t))}decodeRow(t,s,r){return this.maybeReturnResult(this.ean13Reader.decodeRow(t,s,r))}decodeMiddle(t,s,r){return this.ean13Reader.decodeMiddle(t,s,r)}maybeReturnResult(t){let s=t.getText();if(s.charAt(0)==="0"){let r=new V(s.substring(1),null,null,t.getResultPoints(),ae.UPC_A);return t.getResultMetadata()!=null&&r.putAllMetadata(t.getResultMetadata()),r}else throw new $}reset(){this.ean13Reader.reset()}}class Kt extends Oe{constructor(){super(),this.decodeMiddleCounters=new Int32Array(4)}decodeMiddle(t,s,r){const a=this.decodeMiddleCounters.map(m=>m);a[0]=0,a[1]=0,a[2]=0,a[3]=0;const i=t.getSize();let o=s[1],d=0;for(let m=0;m<6&&o<i;m++){const y=Kt.decodeDigit(t,a,o,Kt.L_AND_G_PATTERNS);r+=String.fromCharCode(48+y%10);for(let T of a)o+=T;y>=10&&(d|=1<<5-m)}let h=Kt.determineNumSysAndCheckDigit(r,d);return{rowOffset:o,resultString:h}}decodeEnd(t,s){return Kt.findGuardPatternWithoutCounters(t,s,!0,Kt.MIDDLE_END_PATTERN)}checkChecksum(t){return Oe.checkChecksum(Kt.convertUPCEtoUPCA(t))}static determineNumSysAndCheckDigit(t,s){for(let r=0;r<=1;r++)for(let a=0;a<10;a++)if(s===this.NUMSYS_AND_CHECK_DIGIT_PATTERNS[r][a]){let i=String.fromCharCode(48+r),o=String.fromCharCode(48+a);return i+t+o}throw $.getNotFoundInstance()}getBarcodeFormat(){return ae.UPC_E}static convertUPCEtoUPCA(t){const s=t.slice(1,7).split("").map(i=>i.charCodeAt(0)),r=new se;r.append(t.charAt(0));let a=s[5];switch(a){case 0:case 1:case 2:r.appendChars(s,0,2),r.append(a),r.append("0000"),r.appendChars(s,2,3);break;case 3:r.appendChars(s,0,3),r.append("00000"),r.appendChars(s,3,2);break;case 4:r.appendChars(s,0,4),r.append("00000"),r.append(s[4]);break;default:r.appendChars(s,0,5),r.append("0000"),r.append(a);break}return t.length>=8&&r.append(t.charAt(7)),r.toString()}}Kt.MIDDLE_END_PATTERN=Int32Array.from([1,1,1,1,1,1]),Kt.NUMSYS_AND_CHECK_DIGIT_PATTERNS=[Int32Array.from([56,52,50,49,44,38,35,42,41,37]),Int32Array.from([7,11,13,14,19,25,28,21,22,26])];class St extends ke{constructor(t){super();let s=t==null?null:t.get(N.POSSIBLE_FORMATS),r=[];u(s)?(r.push(new At),r.push(new ks),r.push(new it),r.push(new Kt)):(s.indexOf(ae.EAN_13)>-1&&r.push(new At),s.indexOf(ae.UPC_A)>-1&&r.push(new ks),s.indexOf(ae.EAN_8)>-1&&r.push(new it),s.indexOf(ae.UPC_E)>-1&&r.push(new Kt)),this.readers=r}decodeRow(t,s,r){for(let a of this.readers)try{const i=a.decodeRow(t,s,r),o=i.getBarcodeFormat()===ae.EAN_13&&i.getText().charAt(0)==="0",d=r==null?null:r.get(N.POSSIBLE_FORMATS),h=d==null||d.includes(ae.UPC_A);if(o&&h){const m=i.getRawBytes(),y=new V(i.getText().substring(1),m,m?m.length:null,i.getResultPoints(),ae.UPC_A);return y.putAllMetadata(i.getResultMetadata()),y}return i}catch{}throw new $}reset(){for(let t of this.readers)t.reset()}}class ht extends ke{constructor(){super(),this.decodeFinderCounters=new Int32Array(4),this.dataCharacterCounters=new Int32Array(8),this.oddRoundingErrors=new Array(4),this.evenRoundingErrors=new Array(4),this.oddCounts=new Array(this.dataCharacterCounters.length/2),this.evenCounts=new Array(this.dataCharacterCounters.length/2)}getDecodeFinderCounters(){return this.decodeFinderCounters}getDataCharacterCounters(){return this.dataCharacterCounters}getOddRoundingErrors(){return this.oddRoundingErrors}getEvenRoundingErrors(){return this.evenRoundingErrors}getOddCounts(){return this.oddCounts}getEvenCounts(){return this.evenCounts}parseFinderValue(t,s){for(let r=0;r<s.length;r++)if(ke.patternMatchVariance(t,s[r],ht.MAX_INDIVIDUAL_VARIANCE)<ht.MAX_AVG_VARIANCE)return r;throw new $}static count(t){return Ge.sum(new Int32Array(t))}static increment(t,s){let r=0,a=s[0];for(let i=1;i<t.length;i++)s[i]>a&&(a=s[i],r=i);t[r]++}static decrement(t,s){let r=0,a=s[0];for(let i=1;i<t.length;i++)s[i]<a&&(a=s[i],r=i);t[r]--}static isFinderPattern(t){let s=t[0]+t[1],r=s+t[2]+t[3],a=s/r;if(a>=ht.MIN_FINDER_PATTERN_RATIO&&a<=ht.MAX_FINDER_PATTERN_RATIO){let i=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER;for(let d of t)d>o&&(o=d),d<i&&(i=d);return o<10*i}return!1}}ht.MAX_AVG_VARIANCE=.2,ht.MAX_INDIVIDUAL_VARIANCE=.45,ht.MIN_FINDER_PATTERN_RATIO=9.5/12,ht.MAX_FINDER_PATTERN_RATIO=12.5/14;class Jt{constructor(t,s){this.value=t,this.checksumPortion=s}getValue(){return this.value}getChecksumPortion(){return this.checksumPortion}toString(){return this.value+"("+this.checksumPortion+")"}equals(t){if(!(t instanceof Jt))return!1;const s=t;return this.value===s.value&&this.checksumPortion===s.checksumPortion}hashCode(){return this.value^this.checksumPortion}}class xr{constructor(t,s,r,a,i){this.value=t,this.startEnd=s,this.value=t,this.startEnd=s,this.resultPoints=new Array,this.resultPoints.push(new Ye(r,i)),this.resultPoints.push(new Ye(a,i))}getValue(){return this.value}getStartEnd(){return this.startEnd}getResultPoints(){return this.resultPoints}equals(t){if(!(t instanceof xr))return!1;const s=t;return this.value===s.value}hashCode(){return this.value}}class bs{constructor(){}static getRSSvalue(t,s,r){let a=0;for(let h of t)a+=h;let i=0,o=0,d=t.length;for(let h=0;h<d-1;h++){let m;for(m=1,o|=1<<h;m<t[h];m++,o&=~(1<<h)){let y=bs.combins(a-m-1,d-h-2);if(r&&o===0&&a-m-(d-h-1)>=d-h-1&&(y-=bs.combins(a-m-(d-h),d-h-2)),d-h-1>1){let T=0;for(let z=a-m-(d-h-2);z>s;z--)T+=bs.combins(a-m-z-1,d-h-3);y-=T*(d-1-h)}else a-m>s&&y--;i+=y}a-=m}return i}static combins(t,s){let r,a;t-s>s?(a=s,r=t-s):(a=t-s,r=s);let i=1,o=1;for(let d=t;d>r;d--)i*=d,o<=a&&(i/=o,o++);for(;o<=a;)i/=o,o++;return i}}class na{static buildBitArray(t){let s=t.length*2-1;t[t.length-1].getRightChar()==null&&(s-=1);let r=12*s,a=new q(r),i=0,d=t[0].getRightChar().getValue();for(let h=11;h>=0;--h)d&1<<h&&a.set(i),i++;for(let h=1;h<t.length;++h){let m=t[h],y=m.getLeftChar().getValue();for(let T=11;T>=0;--T)y&1<<T&&a.set(i),i++;if(m.getRightChar()!=null){let T=m.getRightChar().getValue();for(let z=11;z>=0;--z)T&1<<z&&a.set(i),i++}}return a}}class Fs{constructor(t,s){s?this.decodedInformation=null:(this.finished=t,this.decodedInformation=s)}getDecodedInformation(){return this.decodedInformation}isFinished(){return this.finished}}class mr{constructor(t){this.newPosition=t}getNewPosition(){return this.newPosition}}class es extends mr{constructor(t,s){super(t),this.value=s}getValue(){return this.value}isFNC1(){return this.value===es.FNC1}}es.FNC1="$";class Ms extends mr{constructor(t,s,r){super(t),r?(this.remaining=!0,this.remainingValue=this.remainingValue):(this.remaining=!1,this.remainingValue=0),this.newString=s}getNewString(){return this.newString}isRemaining(){return this.remaining}getRemainingValue(){return this.remainingValue}}class hs extends mr{constructor(t,s,r){if(super(t),s<0||s>10||r<0||r>10)throw new _;this.firstDigit=s,this.secondDigit=r}getFirstDigit(){return this.firstDigit}getSecondDigit(){return this.secondDigit}getValue(){return this.firstDigit*10+this.secondDigit}isFirstDigitFNC1(){return this.firstDigit===hs.FNC1}isSecondDigitFNC1(){return this.secondDigit===hs.FNC1}isAnyFNC1(){return this.firstDigit===hs.FNC1||this.secondDigit===hs.FNC1}}hs.FNC1=10;class et{constructor(){}static parseFieldsInGeneralPurpose(t){if(!t)return null;if(t.length<2)throw new $;let s=t.substring(0,2);for(let i of et.TWO_DIGIT_DATA_LENGTH)if(i[0]===s)return i[1]===et.VARIABLE_LENGTH?et.processVariableAI(2,i[2],t):et.processFixedAI(2,i[1],t);if(t.length<3)throw new $;let r=t.substring(0,3);for(let i of et.THREE_DIGIT_DATA_LENGTH)if(i[0]===r)return i[1]===et.VARIABLE_LENGTH?et.processVariableAI(3,i[2],t):et.processFixedAI(3,i[1],t);for(let i of et.THREE_DIGIT_PLUS_DIGIT_DATA_LENGTH)if(i[0]===r)return i[1]===et.VARIABLE_LENGTH?et.processVariableAI(4,i[2],t):et.processFixedAI(4,i[1],t);if(t.length<4)throw new $;let a=t.substring(0,4);for(let i of et.FOUR_DIGIT_DATA_LENGTH)if(i[0]===a)return i[1]===et.VARIABLE_LENGTH?et.processVariableAI(4,i[2],t):et.processFixedAI(4,i[1],t);throw new $}static processFixedAI(t,s,r){if(r.length<t)throw new $;let a=r.substring(0,t);if(r.length<t+s)throw new $;let i=r.substring(t,t+s),o=r.substring(t+s),d="("+a+")"+i,h=et.parseFieldsInGeneralPurpose(o);return h==null?d:d+h}static processVariableAI(t,s,r){let a=r.substring(0,t),i;r.length<t+s?i=r.length:i=t+s;let o=r.substring(t,i),d=r.substring(i),h="("+a+")"+o,m=et.parseFieldsInGeneralPurpose(d);return m==null?h:h+m}}et.VARIABLE_LENGTH=[],et.TWO_DIGIT_DATA_LENGTH=[["00",18],["01",14],["02",14],["10",et.VARIABLE_LENGTH,20],["11",6],["12",6],["13",6],["15",6],["17",6],["20",2],["21",et.VARIABLE_LENGTH,20],["22",et.VARIABLE_LENGTH,29],["30",et.VARIABLE_LENGTH,8],["37",et.VARIABLE_LENGTH,8],["90",et.VARIABLE_LENGTH,30],["91",et.VARIABLE_LENGTH,30],["92",et.VARIABLE_LENGTH,30],["93",et.VARIABLE_LENGTH,30],["94",et.VARIABLE_LENGTH,30],["95",et.VARIABLE_LENGTH,30],["96",et.VARIABLE_LENGTH,30],["97",et.VARIABLE_LENGTH,3],["98",et.VARIABLE_LENGTH,30],["99",et.VARIABLE_LENGTH,30]],et.THREE_DIGIT_DATA_LENGTH=[["240",et.VARIABLE_LENGTH,30],["241",et.VARIABLE_LENGTH,30],["242",et.VARIABLE_LENGTH,6],["250",et.VARIABLE_LENGTH,30],["251",et.VARIABLE_LENGTH,30],["253",et.VARIABLE_LENGTH,17],["254",et.VARIABLE_LENGTH,20],["400",et.VARIABLE_LENGTH,30],["401",et.VARIABLE_LENGTH,30],["402",17],["403",et.VARIABLE_LENGTH,30],["410",13],["411",13],["412",13],["413",13],["414",13],["420",et.VARIABLE_LENGTH,20],["421",et.VARIABLE_LENGTH,15],["422",3],["423",et.VARIABLE_LENGTH,15],["424",3],["425",3],["426",3]],et.THREE_DIGIT_PLUS_DIGIT_DATA_LENGTH=[["310",6],["311",6],["312",6],["313",6],["314",6],["315",6],["316",6],["320",6],["321",6],["322",6],["323",6],["324",6],["325",6],["326",6],["327",6],["328",6],["329",6],["330",6],["331",6],["332",6],["333",6],["334",6],["335",6],["336",6],["340",6],["341",6],["342",6],["343",6],["344",6],["345",6],["346",6],["347",6],["348",6],["349",6],["350",6],["351",6],["352",6],["353",6],["354",6],["355",6],["356",6],["357",6],["360",6],["361",6],["362",6],["363",6],["364",6],["365",6],["366",6],["367",6],["368",6],["369",6],["390",et.VARIABLE_LENGTH,15],["391",et.VARIABLE_LENGTH,18],["392",et.VARIABLE_LENGTH,15],["393",et.VARIABLE_LENGTH,18],["703",et.VARIABLE_LENGTH,30]],et.FOUR_DIGIT_DATA_LENGTH=[["7001",13],["7002",et.VARIABLE_LENGTH,30],["7003",10],["8001",14],["8002",et.VARIABLE_LENGTH,20],["8003",et.VARIABLE_LENGTH,30],["8004",et.VARIABLE_LENGTH,30],["8005",6],["8006",18],["8007",et.VARIABLE_LENGTH,30],["8008",et.VARIABLE_LENGTH,12],["8018",18],["8020",et.VARIABLE_LENGTH,25],["8100",6],["8101",10],["8102",2],["8110",et.VARIABLE_LENGTH,70],["8200",et.VARIABLE_LENGTH,70]];class $s{constructor(t){this.buffer=new se,this.information=t}decodeAllCodes(t,s){let r=s,a=null;do{let i=this.decodeGeneralPurposeField(r,a),o=et.parseFieldsInGeneralPurpose(i.getNewString());if(o!=null&&t.append(o),i.isRemaining()?a=""+i.getRemainingValue():a=null,r===i.getNewPosition())break;r=i.getNewPosition()}while(!0);return t.toString()}isStillNumeric(t){if(t+7>this.information.getSize())return t+4<=this.information.getSize();for(let s=t;s<t+3;++s)if(this.information.get(s))return!0;return this.information.get(t+3)}decodeNumeric(t){if(t+7>this.information.getSize()){let i=this.extractNumericValueFromBitArray(t,4);return i===0?new hs(this.information.getSize(),hs.FNC1,hs.FNC1):new hs(this.information.getSize(),i-1,hs.FNC1)}let s=this.extractNumericValueFromBitArray(t,7),r=(s-8)/11,a=(s-8)%11;return new hs(t+7,r,a)}extractNumericValueFromBitArray(t,s){return $s.extractNumericValueFromBitArray(this.information,t,s)}static extractNumericValueFromBitArray(t,s,r){let a=0;for(let i=0;i<r;++i)t.get(s+i)&&(a|=1<<r-i-1);return a}decodeGeneralPurposeField(t,s){this.buffer.setLengthToZero(),s!=null&&this.buffer.append(s),this.current.setPosition(t);let r=this.parseBlocks();return r!=null&&r.isRemaining()?new Ms(this.current.getPosition(),this.buffer.toString(),r.getRemainingValue()):new Ms(this.current.getPosition(),this.buffer.toString())}parseBlocks(){let t,s;do{let r=this.current.getPosition();if(this.current.isAlpha()?(s=this.parseAlphaBlock(),t=s.isFinished()):this.current.isIsoIec646()?(s=this.parseIsoIec646Block(),t=s.isFinished()):(s=this.parseNumericBlock(),t=s.isFinished()),!(r!==this.current.getPosition())&&!t)break}while(!t);return s.getDecodedInformation()}parseNumericBlock(){for(;this.isStillNumeric(this.current.getPosition());){let t=this.decodeNumeric(this.current.getPosition());if(this.current.setPosition(t.getNewPosition()),t.isFirstDigitFNC1()){let s;return t.isSecondDigitFNC1()?s=new Ms(this.current.getPosition(),this.buffer.toString()):s=new Ms(this.current.getPosition(),this.buffer.toString(),t.getSecondDigit()),new Fs(!0,s)}if(this.buffer.append(t.getFirstDigit()),t.isSecondDigitFNC1()){let s=new Ms(this.current.getPosition(),this.buffer.toString());return new Fs(!0,s)}this.buffer.append(t.getSecondDigit())}return this.isNumericToAlphaNumericLatch(this.current.getPosition())&&(this.current.setAlpha(),this.current.incrementPosition(4)),new Fs(!1)}parseIsoIec646Block(){for(;this.isStillIsoIec646(this.current.getPosition());){let t=this.decodeIsoIec646(this.current.getPosition());if(this.current.setPosition(t.getNewPosition()),t.isFNC1()){let s=new Ms(this.current.getPosition(),this.buffer.toString());return new Fs(!0,s)}this.buffer.append(t.getValue())}return this.isAlphaOr646ToNumericLatch(this.current.getPosition())?(this.current.incrementPosition(3),this.current.setNumeric()):this.isAlphaTo646ToAlphaLatch(this.current.getPosition())&&(this.current.getPosition()+5<this.information.getSize()?this.current.incrementPosition(5):this.current.setPosition(this.information.getSize()),this.current.setAlpha()),new Fs(!1)}parseAlphaBlock(){for(;this.isStillAlpha(this.current.getPosition());){let t=this.decodeAlphanumeric(this.current.getPosition());if(this.current.setPosition(t.getNewPosition()),t.isFNC1()){let s=new Ms(this.current.getPosition(),this.buffer.toString());return new Fs(!0,s)}this.buffer.append(t.getValue())}return this.isAlphaOr646ToNumericLatch(this.current.getPosition())?(this.current.incrementPosition(3),this.current.setNumeric()):this.isAlphaTo646ToAlphaLatch(this.current.getPosition())&&(this.current.getPosition()+5<this.information.getSize()?this.current.incrementPosition(5):this.current.setPosition(this.information.getSize()),this.current.setIsoIec646()),new Fs(!1)}isStillIsoIec646(t){if(t+5>this.information.getSize())return!1;let s=this.extractNumericValueFromBitArray(t,5);if(s>=5&&s<16)return!0;if(t+7>this.information.getSize())return!1;let r=this.extractNumericValueFromBitArray(t,7);if(r>=64&&r<116)return!0;if(t+8>this.information.getSize())return!1;let a=this.extractNumericValueFromBitArray(t,8);return a>=232&&a<253}decodeIsoIec646(t){let s=this.extractNumericValueFromBitArray(t,5);if(s===15)return new es(t+5,es.FNC1);if(s>=5&&s<15)return new es(t+5,"0"+(s-5));let r=this.extractNumericValueFromBitArray(t,7);if(r>=64&&r<90)return new es(t+7,""+(r+1));if(r>=90&&r<116)return new es(t+7,""+(r+7));let a=this.extractNumericValueFromBitArray(t,8),i;switch(a){case 232:i="!";break;case 233:i='"';break;case 234:i="%";break;case 235:i="&";break;case 236:i="'";break;case 237:i="(";break;case 238:i=")";break;case 239:i="*";break;case 240:i="+";break;case 241:i=",";break;case 242:i="-";break;case 243:i=".";break;case 244:i="/";break;case 245:i=":";break;case 246:i=";";break;case 247:i="<";break;case 248:i="=";break;case 249:i=">";break;case 250:i="?";break;case 251:i="_";break;case 252:i=" ";break;default:throw new _}return new es(t+8,i)}isStillAlpha(t){if(t+5>this.information.getSize())return!1;let s=this.extractNumericValueFromBitArray(t,5);if(s>=5&&s<16)return!0;if(t+6>this.information.getSize())return!1;let r=this.extractNumericValueFromBitArray(t,6);return r>=16&&r<63}decodeAlphanumeric(t){let s=this.extractNumericValueFromBitArray(t,5);if(s===15)return new es(t+5,es.FNC1);if(s>=5&&s<15)return new es(t+5,"0"+(s-5));let r=this.extractNumericValueFromBitArray(t,6);if(r>=32&&r<58)return new es(t+6,""+(r+33));let a;switch(r){case 58:a="*";break;case 59:a=",";break;case 60:a="-";break;case 61:a=".";break;case 62:a="/";break;default:throw new rt("Decoding invalid alphanumeric value: "+r)}return new es(t+6,a)}isAlphaTo646ToAlphaLatch(t){if(t+1>this.information.getSize())return!1;for(let s=0;s<5&&s+t<this.information.getSize();++s)if(s===2){if(!this.information.get(t+2))return!1}else if(this.information.get(t+s))return!1;return!0}isAlphaOr646ToNumericLatch(t){if(t+3>this.information.getSize())return!1;for(let s=t;s<t+3;++s)if(this.information.get(s))return!1;return!0}isNumericToAlphaNumericLatch(t){if(t+1>this.information.getSize())return!1;for(let s=0;s<4&&s+t<this.information.getSize();++s)if(this.information.get(t+s))return!1;return!0}}class Rr{constructor(t){this.information=t,this.generalDecoder=new $s(t)}getInformation(){return this.information}getGeneralDecoder(){return this.generalDecoder}}class rs extends Rr{constructor(t){super(t)}encodeCompressedGtin(t,s){t.append("(01)");let r=t.length();t.append("9"),this.encodeCompressedGtinWithoutAI(t,s,r)}encodeCompressedGtinWithoutAI(t,s,r){for(let a=0;a<4;++a){let i=this.getGeneralDecoder().extractNumericValueFromBitArray(s+10*a,10);i/100===0&&t.append("0"),i/10===0&&t.append("0"),t.append(i)}rs.appendCheckDigit(t,r)}static appendCheckDigit(t,s){let r=0;for(let a=0;a<13;a++){let i=t.charAt(a+s).charCodeAt(0)-48;r+=a&1?i:3*i}r=10-r%10,r===10&&(r=0),t.append(r)}}rs.GTIN_SIZE=40;class er extends rs{constructor(t){super(t)}parseInformation(){let t=new se;t.append("(01)");let s=t.length(),r=this.getGeneralDecoder().extractNumericValueFromBitArray(er.HEADER_SIZE,4);return t.append(r),this.encodeCompressedGtinWithoutAI(t,er.HEADER_SIZE+4,s),this.getGeneralDecoder().decodeAllCodes(t,er.HEADER_SIZE+44)}}er.HEADER_SIZE=4;class Us extends Rr{constructor(t){super(t)}parseInformation(){let t=new se;return this.getGeneralDecoder().decodeAllCodes(t,Us.HEADER_SIZE)}}Us.HEADER_SIZE=5;class vr extends rs{constructor(t){super(t)}encodeCompressedWeight(t,s,r){let a=this.getGeneralDecoder().extractNumericValueFromBitArray(s,r);this.addWeightCode(t,a);let i=this.checkWeight(a),o=1e5;for(let d=0;d<5;++d)i/o===0&&t.append("0"),o/=10;t.append(i)}}class ws extends vr{constructor(t){super(t)}parseInformation(){if(this.getInformation().getSize()!=ws.HEADER_SIZE+vr.GTIN_SIZE+ws.WEIGHT_SIZE)throw new $;let t=new se;return this.encodeCompressedGtin(t,ws.HEADER_SIZE),this.encodeCompressedWeight(t,ws.HEADER_SIZE+vr.GTIN_SIZE,ws.WEIGHT_SIZE),t.toString()}}ws.HEADER_SIZE=5,ws.WEIGHT_SIZE=15;class ka extends ws{constructor(t){super(t)}addWeightCode(t,s){t.append("(3103)")}checkWeight(t){return t}}class Ma extends ws{constructor(t){super(t)}addWeightCode(t,s){s<1e4?t.append("(3202)"):t.append("(3203)")}checkWeight(t){return t<1e4?t:t-1e4}}class ys extends rs{constructor(t){super(t)}parseInformation(){if(this.getInformation().getSize()<ys.HEADER_SIZE+rs.GTIN_SIZE)throw new $;let t=new se;this.encodeCompressedGtin(t,ys.HEADER_SIZE);let s=this.getGeneralDecoder().extractNumericValueFromBitArray(ys.HEADER_SIZE+rs.GTIN_SIZE,ys.LAST_DIGIT_SIZE);t.append("(392"),t.append(s),t.append(")");let r=this.getGeneralDecoder().decodeGeneralPurposeField(ys.HEADER_SIZE+rs.GTIN_SIZE+ys.LAST_DIGIT_SIZE,null);return t.append(r.getNewString()),t.toString()}}ys.HEADER_SIZE=8,ys.LAST_DIGIT_SIZE=2;class ts extends rs{constructor(t){super(t)}parseInformation(){if(this.getInformation().getSize()<ts.HEADER_SIZE+rs.GTIN_SIZE)throw new $;let t=new se;this.encodeCompressedGtin(t,ts.HEADER_SIZE);let s=this.getGeneralDecoder().extractNumericValueFromBitArray(ts.HEADER_SIZE+rs.GTIN_SIZE,ts.LAST_DIGIT_SIZE);t.append("(393"),t.append(s),t.append(")");let r=this.getGeneralDecoder().extractNumericValueFromBitArray(ts.HEADER_SIZE+rs.GTIN_SIZE+ts.LAST_DIGIT_SIZE,ts.FIRST_THREE_DIGITS_SIZE);r/100==0&&t.append("0"),r/10==0&&t.append("0"),t.append(r);let a=this.getGeneralDecoder().decodeGeneralPurposeField(ts.HEADER_SIZE+rs.GTIN_SIZE+ts.LAST_DIGIT_SIZE+ts.FIRST_THREE_DIGITS_SIZE,null);return t.append(a.getNewString()),t.toString()}}ts.HEADER_SIZE=8,ts.LAST_DIGIT_SIZE=2,ts.FIRST_THREE_DIGITS_SIZE=10;class Ot extends vr{constructor(t,s,r){super(t),this.dateCode=r,this.firstAIdigits=s}parseInformation(){if(this.getInformation().getSize()!=Ot.HEADER_SIZE+Ot.GTIN_SIZE+Ot.WEIGHT_SIZE+Ot.DATE_SIZE)throw new $;let t=new se;return this.encodeCompressedGtin(t,Ot.HEADER_SIZE),this.encodeCompressedWeight(t,Ot.HEADER_SIZE+Ot.GTIN_SIZE,Ot.WEIGHT_SIZE),this.encodeCompressedDate(t,Ot.HEADER_SIZE+Ot.GTIN_SIZE+Ot.WEIGHT_SIZE),t.toString()}encodeCompressedDate(t,s){let r=this.getGeneralDecoder().extractNumericValueFromBitArray(s,Ot.DATE_SIZE);if(r==38400)return;t.append("("),t.append(this.dateCode),t.append(")");let a=r%32;r/=32;let i=r%12+1;r/=12;let o=r;o/10==0&&t.append("0"),t.append(o),i/10==0&&t.append("0"),t.append(i),a/10==0&&t.append("0"),t.append(a)}addWeightCode(t,s){t.append("("),t.append(this.firstAIdigits),t.append(s/1e5),t.append(")")}checkWeight(t){return t%1e5}}Ot.HEADER_SIZE=8,Ot.WEIGHT_SIZE=20,Ot.DATE_SIZE=16;function ia(A){try{if(A.get(1))return new er(A);if(!A.get(2))return new Us(A);switch($s.extractNumericValueFromBitArray(A,1,4)){case 4:return new ka(A);case 5:return new Ma(A)}switch($s.extractNumericValueFromBitArray(A,1,5)){case 12:return new ys(A);case 13:return new ts(A)}switch($s.extractNumericValueFromBitArray(A,1,7)){case 56:return new Ot(A,"310","11");case 57:return new Ot(A,"320","11");case 58:return new Ot(A,"310","13");case 59:return new Ot(A,"320","13");case 60:return new Ot(A,"310","15");case 61:return new Ot(A,"320","15");case 62:return new Ot(A,"310","17");case 63:return new Ot(A,"320","17")}}catch(t){throw console.log(t),new rt("unknown decoder: "+A)}}class Vs{constructor(t,s,r,a){this.leftchar=t,this.rightchar=s,this.finderpattern=r,this.maybeLast=a}mayBeLast(){return this.maybeLast}getLeftChar(){return this.leftchar}getRightChar(){return this.rightchar}getFinderPattern(){return this.finderpattern}mustBeLast(){return this.rightchar==null}toString(){return"[ "+this.leftchar+", "+this.rightchar+" : "+(this.finderpattern==null?"null":this.finderpattern.getValue())+" ]"}static equals(t,s){return t instanceof Vs?Vs.equalsOrNull(t.leftchar,s.leftchar)&&Vs.equalsOrNull(t.rightchar,s.rightchar)&&Vs.equalsOrNull(t.finderpattern,s.finderpattern):!1}static equalsOrNull(t,s){return t===null?s===null:Vs.equals(t,s)}hashCode(){return this.leftchar.getValue()^this.rightchar.getValue()^this.finderpattern.getValue()}}class Nr{constructor(t,s,r){this.pairs=t,this.rowNumber=s,this.wasReversed=r}getPairs(){return this.pairs}getRowNumber(){return this.rowNumber}isReversed(){return this.wasReversed}isEquivalent(t){return this.checkEqualitity(this,t)}toString(){return"{ "+this.pairs+" }"}equals(t,s){return t instanceof Nr?this.checkEqualitity(t,s)&&t.wasReversed===s.wasReversed:!1}checkEqualitity(t,s){if(!t||!s)return;let r;return t.forEach((a,i)=>{s.forEach(o=>{a.getLeftChar().getValue()===o.getLeftChar().getValue()&&a.getRightChar().getValue()===o.getRightChar().getValue()&&a.getFinderPatter().getValue()===o.getFinderPatter().getValue()&&(r=!0)})}),r}}class Fe extends ht{constructor(t){super(...arguments),this.pairs=new Array(Fe.MAX_PAIRS),this.rows=new Array,this.startEnd=[2],this.verbose=t===!0}decodeRow(t,s,r){this.pairs.length=0,this.startFromEven=!1;try{return Fe.constructResult(this.decodeRow2pairs(t,s))}catch(a){this.verbose&&console.log(a)}return this.pairs.length=0,this.startFromEven=!0,Fe.constructResult(this.decodeRow2pairs(t,s))}reset(){this.pairs.length=0,this.rows.length=0}decodeRow2pairs(t,s){let r=!1;for(;!r;)try{this.pairs.push(this.retrieveNextPair(s,this.pairs,t))}catch(i){if(i instanceof $){if(!this.pairs.length)throw new $;r=!0}}if(this.checkChecksum())return this.pairs;let a;if(this.rows.length?a=!0:a=!1,this.storeRow(t,!1),a){let i=this.checkRowsBoolean(!1);if(i!=null||(i=this.checkRowsBoolean(!0),i!=null))return i}throw new $}checkRowsBoolean(t){if(this.rows.length>25)return this.rows.length=0,null;this.pairs.length=0,t&&(this.rows=this.rows.reverse());let s=null;try{s=this.checkRows(new Array,0)}catch(r){this.verbose&&console.log(r)}return t&&(this.rows=this.rows.reverse()),s}checkRows(t,s){for(let r=s;r<this.rows.length;r++){let a=this.rows[r];this.pairs.length=0;for(let o of t)this.pairs.push(o.getPairs());if(this.pairs.push(a.getPairs()),!Fe.isValidSequence(this.pairs))continue;if(this.checkChecksum())return this.pairs;let i=new Array(t);i.push(a);try{return this.checkRows(i,r+1)}catch(o){this.verbose&&console.log(o)}}throw new $}static isValidSequence(t){for(let s of Fe.FINDER_PATTERN_SEQUENCES){if(t.length>s.length)continue;let r=!0;for(let a=0;a<t.length;a++)if(t[a].getFinderPattern().getValue()!=s[a]){r=!1;break}if(r)return!0}return!1}storeRow(t,s){let r=0,a=!1,i=!1;for(;r<this.rows.length;){let o=this.rows[r];if(o.getRowNumber()>t){i=o.isEquivalent(this.pairs);break}a=o.isEquivalent(this.pairs),r++}i||a||Fe.isPartialRow(this.pairs,this.rows)||(this.rows.push(r,new Nr(this.pairs,t,s)),this.removePartialRows(this.pairs,this.rows))}removePartialRows(t,s){for(let r of s)if(r.getPairs().length!==t.length){for(let a of r.getPairs())for(let i of t)if(Vs.equals(a,i))break}}static isPartialRow(t,s){for(let r of s){let a=!0;for(let i of t){let o=!1;for(let d of r.getPairs())if(i.equals(d)){o=!0;break}if(!o){a=!1;break}}if(a)return!0}return!1}getRows(){return this.rows}static constructResult(t){let s=na.buildBitArray(t),a=ia(s).parseInformation(),i=t[0].getFinderPattern().getResultPoints(),o=t[t.length-1].getFinderPattern().getResultPoints(),d=[i[0],i[1],o[0],o[1]];return new V(a,null,null,d,ae.RSS_EXPANDED,null)}checkChecksum(){let t=this.pairs.get(0),s=t.getLeftChar(),r=t.getRightChar();if(r==null)return!1;let a=r.getChecksumPortion(),i=2;for(let d=1;d<this.pairs.size();++d){let h=this.pairs.get(d);a+=h.getLeftChar().getChecksumPortion(),i++;let m=h.getRightChar();m!=null&&(a+=m.getChecksumPortion(),i++)}return a%=211,211*(i-4)+a==s.getValue()}static getNextSecondBar(t,s){let r;return t.get(s)?(r=t.getNextUnset(s),r=t.getNextSet(r)):(r=t.getNextSet(s),r=t.getNextUnset(r)),r}retrieveNextPair(t,s,r){let a=s.length%2==0;this.startFromEven&&(a=!a);let i,o=!0,d=-1;do this.findNextPair(t,s,d),i=this.parseFoundFinderPattern(t,r,a),i==null?d=Fe.getNextSecondBar(t,this.startEnd[0]):o=!1;while(o);let h=this.decodeDataCharacter(t,i,a,!0);if(!this.isEmptyPair(s)&&s[s.length-1].mustBeLast())throw new $;let m;try{m=this.decodeDataCharacter(t,i,a,!1)}catch(y){m=null,this.verbose&&console.log(y)}return new Vs(h,m,i,!0)}isEmptyPair(t){return t.length===0}findNextPair(t,s,r){let a=this.getDecodeFinderCounters();a[0]=0,a[1]=0,a[2]=0,a[3]=0;let i=t.getSize(),o;r>=0?o=r:this.isEmptyPair(s)?o=0:o=s[s.length-1].getFinderPattern().getStartEnd()[1];let d=s.length%2!=0;this.startFromEven&&(d=!d);let h=!1;for(;o<i&&(h=!t.get(o),!!h);)o++;let m=0,y=o;for(let T=o;T<i;T++)if(t.get(T)!=h)a[m]++;else{if(m==3){if(d&&Fe.reverseCounters(a),Fe.isFinderPattern(a)){this.startEnd[0]=y,this.startEnd[1]=T;return}d&&Fe.reverseCounters(a),y+=a[0]+a[1],a[0]=a[2],a[1]=a[3],a[2]=0,a[3]=0,m--}else m++;a[m]=1,h=!h}throw new $}static reverseCounters(t){let s=t.length;for(let r=0;r<s/2;++r){let a=t[r];t[r]=t[s-r-1],t[s-r-1]=a}}parseFoundFinderPattern(t,s,r){let a,i,o;if(r){let m=this.startEnd[0]-1;for(;m>=0&&!t.get(m);)m--;m++,a=this.startEnd[0]-m,i=m,o=this.startEnd[1]}else i=this.startEnd[0],o=t.getNextUnset(this.startEnd[1]+1),a=o-this.startEnd[1];let d=this.getDecodeFinderCounters();R.arraycopy(d,0,d,1,d.length-1),d[0]=a;let h;try{h=this.parseFinderValue(d,Fe.FINDER_PATTERNS)}catch{return null}return new xr(h,[i,o],i,o,s)}decodeDataCharacter(t,s,r,a){let i=this.getDataCharacterCounters();for(let Mt=0;Mt<i.length;Mt++)i[Mt]=0;if(a)Fe.recordPatternInReverse(t,s.getStartEnd()[0],i);else{Fe.recordPattern(t,s.getStartEnd()[1],i);for(let Mt=0,is=i.length-1;Mt<is;Mt++,is--){let Ns=i[Mt];i[Mt]=i[is],i[is]=Ns}}let o=17,d=Ge.sum(new Int32Array(i))/o,h=(s.getStartEnd()[1]-s.getStartEnd()[0])/15;if(Math.abs(d-h)/h>.3)throw new $;let m=this.getOddCounts(),y=this.getEvenCounts(),T=this.getOddRoundingErrors(),z=this.getEvenRoundingErrors();for(let Mt=0;Mt<i.length;Mt++){let is=1*i[Mt]/d,Ns=is+.5;if(Ns<1){if(is<.3)throw new $;Ns=1}else if(Ns>8){if(is>8.7)throw new $;Ns=8}let Er=Mt/2;Mt&1?(y[Er]=Ns,z[Er]=is-Ns):(m[Er]=Ns,T[Er]=is-Ns)}this.adjustOddEvenCounts(o);let Y=4*s.getValue()+(r?0:2)+(a?0:1)-1,ce=0,ue=0;for(let Mt=m.length-1;Mt>=0;Mt--){if(Fe.isNotA1left(s,r,a)){let is=Fe.WEIGHTS[Y][2*Mt];ue+=m[Mt]*is}ce+=m[Mt]}let Se=0;for(let Mt=y.length-1;Mt>=0;Mt--)if(Fe.isNotA1left(s,r,a)){let is=Fe.WEIGHTS[Y][2*Mt+1];Se+=y[Mt]*is}let ze=ue+Se;if(ce&1||ce>13||ce<4)throw new $;let We=(13-ce)/2,$e=Fe.SYMBOL_WIDEST[We],Ve=9-$e,vt=bs.getRSSvalue(m,$e,!0),mt=bs.getRSSvalue(y,Ve,!1),gs=Fe.EVEN_TOTAL_SUBSET[We],Rs=Fe.GSUM[We],ps=vt*gs+mt+Rs;return new Jt(ps,ze)}static isNotA1left(t,s,r){return!(t.getValue()==0&&s&&r)}adjustOddEvenCounts(t){let s=Ge.sum(new Int32Array(this.getOddCounts())),r=Ge.sum(new Int32Array(this.getEvenCounts())),a=!1,i=!1;s>13?i=!0:s<4&&(a=!0);let o=!1,d=!1;r>13?d=!0:r<4&&(o=!0);let h=s+r-t,m=(s&1)==1,y=(r&1)==0;if(h==1)if(m){if(y)throw new $;i=!0}else{if(!y)throw new $;d=!0}else if(h==-1)if(m){if(y)throw new $;a=!0}else{if(!y)throw new $;o=!0}else if(h==0){if(m){if(!y)throw new $;s<r?(a=!0,d=!0):(i=!0,o=!0)}else if(y)throw new $}else throw new $;if(a){if(i)throw new $;Fe.increment(this.getOddCounts(),this.getOddRoundingErrors())}if(i&&Fe.decrement(this.getOddCounts(),this.getOddRoundingErrors()),o){if(d)throw new $;Fe.increment(this.getEvenCounts(),this.getOddRoundingErrors())}d&&Fe.decrement(this.getEvenCounts(),this.getEvenRoundingErrors())}}Fe.SYMBOL_WIDEST=[7,5,4,3,1],Fe.EVEN_TOTAL_SUBSET=[4,20,52,104,204],Fe.GSUM=[0,348,1388,2948,3988],Fe.FINDER_PATTERNS=[Int32Array.from([1,8,4,1]),Int32Array.from([3,6,4,1]),Int32Array.from([3,4,6,1]),Int32Array.from([3,2,8,1]),Int32Array.from([2,6,5,1]),Int32Array.from([2,2,9,1])],Fe.WEIGHTS=[[1,3,9,27,81,32,96,77],[20,60,180,118,143,7,21,63],[189,145,13,39,117,140,209,205],[193,157,49,147,19,57,171,91],[62,186,136,197,169,85,44,132],[185,133,188,142,4,12,36,108],[113,128,173,97,80,29,87,50],[150,28,84,41,123,158,52,156],[46,138,203,187,139,206,196,166],[76,17,51,153,37,111,122,155],[43,129,176,106,107,110,119,146],[16,48,144,10,30,90,59,177],[109,116,137,200,178,112,125,164],[70,210,208,202,184,130,179,115],[134,191,151,31,93,68,204,190],[148,22,66,198,172,94,71,2],[6,18,54,162,64,192,154,40],[120,149,25,75,14,42,126,167],[79,26,78,23,69,207,199,175],[103,98,83,38,114,131,182,124],[161,61,183,127,170,88,53,159],[55,165,73,8,24,72,5,15],[45,135,194,160,58,174,100,89]],Fe.FINDER_PAT_A=0,Fe.FINDER_PAT_B=1,Fe.FINDER_PAT_C=2,Fe.FINDER_PAT_D=3,Fe.FINDER_PAT_E=4,Fe.FINDER_PAT_F=5,Fe.FINDER_PATTERN_SEQUENCES=[[Fe.FINDER_PAT_A,Fe.FINDER_PAT_A],[Fe.FINDER_PAT_A,Fe.FINDER_PAT_B,Fe.FINDER_PAT_B],[Fe.FINDER_PAT_A,Fe.FINDER_PAT_C,Fe.FINDER_PAT_B,Fe.FINDER_PAT_D],[Fe.FINDER_PAT_A,Fe.FINDER_PAT_E,Fe.FINDER_PAT_B,Fe.FINDER_PAT_D,Fe.FINDER_PAT_C],[Fe.FINDER_PAT_A,Fe.FINDER_PAT_E,Fe.FINDER_PAT_B,Fe.FINDER_PAT_D,Fe.FINDER_PAT_D,Fe.FINDER_PAT_F],[Fe.FINDER_PAT_A,Fe.FINDER_PAT_E,Fe.FINDER_PAT_B,Fe.FINDER_PAT_D,Fe.FINDER_PAT_E,Fe.FINDER_PAT_F,Fe.FINDER_PAT_F],[Fe.FINDER_PAT_A,Fe.FINDER_PAT_A,Fe.FINDER_PAT_B,Fe.FINDER_PAT_B,Fe.FINDER_PAT_C,Fe.FINDER_PAT_C,Fe.FINDER_PAT_D,Fe.FINDER_PAT_D],[Fe.FINDER_PAT_A,Fe.FINDER_PAT_A,Fe.FINDER_PAT_B,Fe.FINDER_PAT_B,Fe.FINDER_PAT_C,Fe.FINDER_PAT_C,Fe.FINDER_PAT_D,Fe.FINDER_PAT_E,Fe.FINDER_PAT_E],[Fe.FINDER_PAT_A,Fe.FINDER_PAT_A,Fe.FINDER_PAT_B,Fe.FINDER_PAT_B,Fe.FINDER_PAT_C,Fe.FINDER_PAT_C,Fe.FINDER_PAT_D,Fe.FINDER_PAT_E,Fe.FINDER_PAT_F,Fe.FINDER_PAT_F],[Fe.FINDER_PAT_A,Fe.FINDER_PAT_A,Fe.FINDER_PAT_B,Fe.FINDER_PAT_B,Fe.FINDER_PAT_C,Fe.FINDER_PAT_D,Fe.FINDER_PAT_D,Fe.FINDER_PAT_E,Fe.FINDER_PAT_E,Fe.FINDER_PAT_F,Fe.FINDER_PAT_F]],Fe.MAX_PAIRS=11;class oa extends Jt{constructor(t,s,r){super(t,s),this.count=0,this.finderPattern=r}getFinderPattern(){return this.finderPattern}getCount(){return this.count}incrementCount(){this.count++}}class Vt extends ht{constructor(){super(...arguments),this.possibleLeftPairs=[],this.possibleRightPairs=[]}decodeRow(t,s,r){const a=this.decodePair(s,!1,t,r);Vt.addOrTally(this.possibleLeftPairs,a),s.reverse();let i=this.decodePair(s,!0,t,r);Vt.addOrTally(this.possibleRightPairs,i),s.reverse();for(let o of this.possibleLeftPairs)if(o.getCount()>1){for(let d of this.possibleRightPairs)if(d.getCount()>1&&Vt.checkChecksum(o,d))return Vt.constructResult(o,d)}throw new $}static addOrTally(t,s){if(s==null)return;let r=!1;for(let a of t)if(a.getValue()===s.getValue()){a.incrementCount(),r=!0;break}r||t.push(s)}reset(){this.possibleLeftPairs.length=0,this.possibleRightPairs.length=0}static constructResult(t,s){let r=4537077*t.getValue()+s.getValue(),a=new String(r).toString(),i=new se;for(let m=13-a.length;m>0;m--)i.append("0");i.append(a);let o=0;for(let m=0;m<13;m++){let y=i.charAt(m).charCodeAt(0)-48;o+=m&1?y:3*y}o=10-o%10,o===10&&(o=0),i.append(o.toString());let d=t.getFinderPattern().getResultPoints(),h=s.getFinderPattern().getResultPoints();return new V(i.toString(),null,0,[d[0],d[1],h[0],h[1]],ae.RSS_14,new Date().getTime())}static checkChecksum(t,s){let r=(t.getChecksumPortion()+16*s.getChecksumPortion())%79,a=9*t.getFinderPattern().getValue()+s.getFinderPattern().getValue();return a>72&&a--,a>8&&a--,r===a}decodePair(t,s,r,a){try{let i=this.findFinderPattern(t,s),o=this.parseFoundFinderPattern(t,r,s,i),d=a==null?null:a.get(N.NEED_RESULT_POINT_CALLBACK);if(d!=null){let y=(i[0]+i[1])/2;s&&(y=t.getSize()-1-y),d.foundPossibleResultPoint(new Ye(y,r))}let h=this.decodeDataCharacter(t,o,!0),m=this.decodeDataCharacter(t,o,!1);return new oa(1597*h.getValue()+m.getValue(),h.getChecksumPortion()+4*m.getChecksumPortion(),o)}catch{return null}}decodeDataCharacter(t,s,r){let a=this.getDataCharacterCounters();for(let Se=0;Se<a.length;Se++)a[Se]=0;if(r)ke.recordPatternInReverse(t,s.getStartEnd()[0],a);else{ke.recordPattern(t,s.getStartEnd()[1]+1,a);for(let Se=0,ze=a.length-1;Se<ze;Se++,ze--){let We=a[Se];a[Se]=a[ze],a[ze]=We}}let i=r?16:15,o=Ge.sum(new Int32Array(a))/i,d=this.getOddCounts(),h=this.getEvenCounts(),m=this.getOddRoundingErrors(),y=this.getEvenRoundingErrors();for(let Se=0;Se<a.length;Se++){let ze=a[Se]/o,We=Math.floor(ze+.5);We<1?We=1:We>8&&(We=8);let $e=Math.floor(Se/2);Se&1?(h[$e]=We,y[$e]=ze-We):(d[$e]=We,m[$e]=ze-We)}this.adjustOddEvenCounts(r,i);let T=0,z=0;for(let Se=d.length-1;Se>=0;Se--)z*=9,z+=d[Se],T+=d[Se];let Y=0,ce=0;for(let Se=h.length-1;Se>=0;Se--)Y*=9,Y+=h[Se],ce+=h[Se];let ue=z+3*Y;if(r){if(T&1||T>12||T<4)throw new $;let Se=(12-T)/2,ze=Vt.OUTSIDE_ODD_WIDEST[Se],We=9-ze,$e=bs.getRSSvalue(d,ze,!1),Ve=bs.getRSSvalue(h,We,!0),vt=Vt.OUTSIDE_EVEN_TOTAL_SUBSET[Se],mt=Vt.OUTSIDE_GSUM[Se];return new Jt($e*vt+Ve+mt,ue)}else{if(ce&1||ce>10||ce<4)throw new $;let Se=(10-ce)/2,ze=Vt.INSIDE_ODD_WIDEST[Se],We=9-ze,$e=bs.getRSSvalue(d,ze,!0),Ve=bs.getRSSvalue(h,We,!1),vt=Vt.INSIDE_ODD_TOTAL_SUBSET[Se],mt=Vt.INSIDE_GSUM[Se];return new Jt(Ve*vt+$e+mt,ue)}}findFinderPattern(t,s){let r=this.getDecodeFinderCounters();r[0]=0,r[1]=0,r[2]=0,r[3]=0;let a=t.getSize(),i=!1,o=0;for(;o<a&&(i=!t.get(o),s!==i);)o++;let d=0,h=o;for(let m=o;m<a;m++)if(t.get(m)!==i)r[d]++;else{if(d===3){if(ht.isFinderPattern(r))return[h,m];h+=r[0]+r[1],r[0]=r[2],r[1]=r[3],r[2]=0,r[3]=0,d--}else d++;r[d]=1,i=!i}throw new $}parseFoundFinderPattern(t,s,r,a){let i=t.get(a[0]),o=a[0]-1;for(;o>=0&&i!==t.get(o);)o--;o++;const d=a[0]-o,h=this.getDecodeFinderCounters(),m=new Int32Array(h.length);R.arraycopy(h,0,m,1,h.length-1),m[0]=d;const y=this.parseFinderValue(m,Vt.FINDER_PATTERNS);let T=o,z=a[1];return r&&(T=t.getSize()-1-T,z=t.getSize()-1-z),new xr(y,[o,a[1]],T,z,s)}adjustOddEvenCounts(t,s){let r=Ge.sum(new Int32Array(this.getOddCounts())),a=Ge.sum(new Int32Array(this.getEvenCounts())),i=!1,o=!1,d=!1,h=!1;t?(r>12?o=!0:r<4&&(i=!0),a>12?h=!0:a<4&&(d=!0)):(r>11?o=!0:r<5&&(i=!0),a>10?h=!0:a<4&&(d=!0));let m=r+a-s,y=(r&1)===(t?1:0),T=(a&1)===1;if(m===1)if(y){if(T)throw new $;o=!0}else{if(!T)throw new $;h=!0}else if(m===-1)if(y){if(T)throw new $;i=!0}else{if(!T)throw new $;d=!0}else if(m===0){if(y){if(!T)throw new $;r<a?(i=!0,h=!0):(o=!0,d=!0)}else if(T)throw new $}else throw new $;if(i){if(o)throw new $;ht.increment(this.getOddCounts(),this.getOddRoundingErrors())}if(o&&ht.decrement(this.getOddCounts(),this.getOddRoundingErrors()),d){if(h)throw new $;ht.increment(this.getEvenCounts(),this.getOddRoundingErrors())}h&&ht.decrement(this.getEvenCounts(),this.getEvenRoundingErrors())}}Vt.OUTSIDE_EVEN_TOTAL_SUBSET=[1,10,34,70,126],Vt.INSIDE_ODD_TOTAL_SUBSET=[4,20,48,81],Vt.OUTSIDE_GSUM=[0,161,961,2015,2715],Vt.INSIDE_GSUM=[0,336,1036,1516],Vt.OUTSIDE_ODD_WIDEST=[8,6,4,3,1],Vt.INSIDE_ODD_WIDEST=[2,4,6,8],Vt.FINDER_PATTERNS=[Int32Array.from([3,8,2,1]),Int32Array.from([3,5,5,1]),Int32Array.from([3,3,7,1]),Int32Array.from([3,1,9,1]),Int32Array.from([2,7,4,1]),Int32Array.from([2,5,6,1]),Int32Array.from([2,3,8,1]),Int32Array.from([1,5,7,1]),Int32Array.from([1,3,9,1])];class tr extends ke{constructor(t,s){super(),this.readers=[],this.verbose=s===!0;const r=t?t.get(N.POSSIBLE_FORMATS):null,a=t&&t.get(N.ASSUME_CODE_39_CHECK_DIGIT)!==void 0;r?((r.includes(ae.EAN_13)||r.includes(ae.UPC_A)||r.includes(ae.EAN_8)||r.includes(ae.UPC_E))&&this.readers.push(new St(t)),r.includes(ae.CODE_39)&&this.readers.push(new he(a)),r.includes(ae.CODE_128)&&this.readers.push(new Z),r.includes(ae.ITF)&&this.readers.push(new we),r.includes(ae.RSS_14)&&this.readers.push(new Vt),r.includes(ae.RSS_EXPANDED)&&this.readers.push(new Fe(this.verbose))):(this.readers.push(new St(t)),this.readers.push(new he),this.readers.push(new St(t)),this.readers.push(new Z),this.readers.push(new we),this.readers.push(new Vt),this.readers.push(new Fe(this.verbose)))}decodeRow(t,s,r){for(let a=0;a<this.readers.length;a++)try{return this.readers[a].decodeRow(t,s,r)}catch{}throw new $}reset(){this.readers.forEach(t=>t.reset())}}class la extends Q{constructor(t=500,s){super(new tr(s),t,s)}}class Ct{constructor(t,s,r){this.ecCodewords=t,this.ecBlocks=[s],r&&this.ecBlocks.push(r)}getECCodewords(){return this.ecCodewords}getECBlocks(){return this.ecBlocks}}class Nt{constructor(t,s){this.count=t,this.dataCodewords=s}getCount(){return this.count}getDataCodewords(){return this.dataCodewords}}class _t{constructor(t,s,r,a,i,o){this.versionNumber=t,this.symbolSizeRows=s,this.symbolSizeColumns=r,this.dataRegionSizeRows=a,this.dataRegionSizeColumns=i,this.ecBlocks=o;let d=0;const h=o.getECCodewords(),m=o.getECBlocks();for(let y of m)d+=y.getCount()*(y.getDataCodewords()+h);this.totalCodewords=d}getVersionNumber(){return this.versionNumber}getSymbolSizeRows(){return this.symbolSizeRows}getSymbolSizeColumns(){return this.symbolSizeColumns}getDataRegionSizeRows(){return this.dataRegionSizeRows}getDataRegionSizeColumns(){return this.dataRegionSizeColumns}getTotalCodewords(){return this.totalCodewords}getECBlocks(){return this.ecBlocks}static getVersionForDimensions(t,s){if(t&1||s&1)throw new _;for(let r of _t.VERSIONS)if(r.symbolSizeRows===t&&r.symbolSizeColumns===s)return r;throw new _}toString(){return""+this.versionNumber}static buildVersions(){return[new _t(1,10,10,8,8,new Ct(5,new Nt(1,3))),new _t(2,12,12,10,10,new Ct(7,new Nt(1,5))),new _t(3,14,14,12,12,new Ct(10,new Nt(1,8))),new _t(4,16,16,14,14,new Ct(12,new Nt(1,12))),new _t(5,18,18,16,16,new Ct(14,new Nt(1,18))),new _t(6,20,20,18,18,new Ct(18,new Nt(1,22))),new _t(7,22,22,20,20,new Ct(20,new Nt(1,30))),new _t(8,24,24,22,22,new Ct(24,new Nt(1,36))),new _t(9,26,26,24,24,new Ct(28,new Nt(1,44))),new _t(10,32,32,14,14,new Ct(36,new Nt(1,62))),new _t(11,36,36,16,16,new Ct(42,new Nt(1,86))),new _t(12,40,40,18,18,new Ct(48,new Nt(1,114))),new _t(13,44,44,20,20,new Ct(56,new Nt(1,144))),new _t(14,48,48,22,22,new Ct(68,new Nt(1,174))),new _t(15,52,52,24,24,new Ct(42,new Nt(2,102))),new _t(16,64,64,14,14,new Ct(56,new Nt(2,140))),new _t(17,72,72,16,16,new Ct(36,new Nt(4,92))),new _t(18,80,80,18,18,new Ct(48,new Nt(4,114))),new _t(19,88,88,20,20,new Ct(56,new Nt(4,144))),new _t(20,96,96,22,22,new Ct(68,new Nt(4,174))),new _t(21,104,104,24,24,new Ct(56,new Nt(6,136))),new _t(22,120,120,18,18,new Ct(68,new Nt(6,175))),new _t(23,132,132,20,20,new Ct(62,new Nt(8,163))),new _t(24,144,144,22,22,new Ct(62,new Nt(8,156),new Nt(2,155))),new _t(25,8,18,6,16,new Ct(7,new Nt(1,5))),new _t(26,8,32,6,14,new Ct(11,new Nt(1,10))),new _t(27,12,26,10,24,new Ct(14,new Nt(1,16))),new _t(28,12,36,10,16,new Ct(18,new Nt(1,22))),new _t(29,16,36,14,16,new Ct(24,new Nt(1,32))),new _t(30,16,48,14,22,new Ct(28,new Nt(1,49)))]}}_t.VERSIONS=_t.buildVersions();class Lr{constructor(t){const s=t.getHeight();if(s<8||s>144||s&1)throw new _;this.version=Lr.readVersion(t),this.mappingBitMatrix=this.extractDataRegion(t),this.readMappingMatrix=new G(this.mappingBitMatrix.getWidth(),this.mappingBitMatrix.getHeight())}getVersion(){return this.version}static readVersion(t){const s=t.getHeight(),r=t.getWidth();return _t.getVersionForDimensions(s,r)}readCodewords(){const t=new Int8Array(this.version.getTotalCodewords());let s=0,r=4,a=0;const i=this.mappingBitMatrix.getHeight(),o=this.mappingBitMatrix.getWidth();let d=!1,h=!1,m=!1,y=!1;do if(r===i&&a===0&&!d)t[s++]=this.readCorner1(i,o)&255,r-=2,a+=2,d=!0;else if(r===i-2&&a===0&&o&3&&!h)t[s++]=this.readCorner2(i,o)&255,r-=2,a+=2,h=!0;else if(r===i+4&&a===2&&!(o&7)&&!m)t[s++]=this.readCorner3(i,o)&255,r-=2,a+=2,m=!0;else if(r===i-2&&a===0&&(o&7)===4&&!y)t[s++]=this.readCorner4(i,o)&255,r-=2,a+=2,y=!0;else{do r<i&&a>=0&&!this.readMappingMatrix.get(a,r)&&(t[s++]=this.readUtah(r,a,i,o)&255),r-=2,a+=2;while(r>=0&&a<o);r+=1,a+=3;do r>=0&&a<o&&!this.readMappingMatrix.get(a,r)&&(t[s++]=this.readUtah(r,a,i,o)&255),r+=2,a-=2;while(r<i&&a>=0);r+=3,a+=1}while(r<i||a<o);if(s!==this.version.getTotalCodewords())throw new _;return t}readModule(t,s,r,a){return t<0&&(t+=r,s+=4-(r+4&7)),s<0&&(s+=a,t+=4-(a+4&7)),this.readMappingMatrix.set(s,t),this.mappingBitMatrix.get(s,t)}readUtah(t,s,r,a){let i=0;return this.readModule(t-2,s-2,r,a)&&(i|=1),i<<=1,this.readModule(t-2,s-1,r,a)&&(i|=1),i<<=1,this.readModule(t-1,s-2,r,a)&&(i|=1),i<<=1,this.readModule(t-1,s-1,r,a)&&(i|=1),i<<=1,this.readModule(t-1,s,r,a)&&(i|=1),i<<=1,this.readModule(t,s-2,r,a)&&(i|=1),i<<=1,this.readModule(t,s-1,r,a)&&(i|=1),i<<=1,this.readModule(t,s,r,a)&&(i|=1),i}readCorner1(t,s){let r=0;return this.readModule(t-1,0,t,s)&&(r|=1),r<<=1,this.readModule(t-1,1,t,s)&&(r|=1),r<<=1,this.readModule(t-1,2,t,s)&&(r|=1),r<<=1,this.readModule(0,s-2,t,s)&&(r|=1),r<<=1,this.readModule(0,s-1,t,s)&&(r|=1),r<<=1,this.readModule(1,s-1,t,s)&&(r|=1),r<<=1,this.readModule(2,s-1,t,s)&&(r|=1),r<<=1,this.readModule(3,s-1,t,s)&&(r|=1),r}readCorner2(t,s){let r=0;return this.readModule(t-3,0,t,s)&&(r|=1),r<<=1,this.readModule(t-2,0,t,s)&&(r|=1),r<<=1,this.readModule(t-1,0,t,s)&&(r|=1),r<<=1,this.readModule(0,s-4,t,s)&&(r|=1),r<<=1,this.readModule(0,s-3,t,s)&&(r|=1),r<<=1,this.readModule(0,s-2,t,s)&&(r|=1),r<<=1,this.readModule(0,s-1,t,s)&&(r|=1),r<<=1,this.readModule(1,s-1,t,s)&&(r|=1),r}readCorner3(t,s){let r=0;return this.readModule(t-1,0,t,s)&&(r|=1),r<<=1,this.readModule(t-1,s-1,t,s)&&(r|=1),r<<=1,this.readModule(0,s-3,t,s)&&(r|=1),r<<=1,this.readModule(0,s-2,t,s)&&(r|=1),r<<=1,this.readModule(0,s-1,t,s)&&(r|=1),r<<=1,this.readModule(1,s-3,t,s)&&(r|=1),r<<=1,this.readModule(1,s-2,t,s)&&(r|=1),r<<=1,this.readModule(1,s-1,t,s)&&(r|=1),r}readCorner4(t,s){let r=0;return this.readModule(t-3,0,t,s)&&(r|=1),r<<=1,this.readModule(t-2,0,t,s)&&(r|=1),r<<=1,this.readModule(t-1,0,t,s)&&(r|=1),r<<=1,this.readModule(0,s-2,t,s)&&(r|=1),r<<=1,this.readModule(0,s-1,t,s)&&(r|=1),r<<=1,this.readModule(1,s-1,t,s)&&(r|=1),r<<=1,this.readModule(2,s-1,t,s)&&(r|=1),r<<=1,this.readModule(3,s-1,t,s)&&(r|=1),r}extractDataRegion(t){const s=this.version.getSymbolSizeRows(),r=this.version.getSymbolSizeColumns();if(t.getHeight()!==s)throw new p("Dimension of bitMatrix must match the version size");const a=this.version.getDataRegionSizeRows(),i=this.version.getDataRegionSizeColumns(),o=s/a|0,d=r/i|0,h=o*a,m=d*i,y=new G(m,h);for(let T=0;T<o;++T){const z=T*a;for(let Y=0;Y<d;++Y){const ce=Y*i;for(let ue=0;ue<a;++ue){const Se=T*(a+2)+1+ue,ze=z+ue;for(let We=0;We<i;++We){const $e=Y*(i+2)+1+We;if(t.get($e,Se)){const Ve=ce+We;y.set(Ve,ze)}}}}}return y}}class Pr{constructor(t,s){this.numDataCodewords=t,this.codewords=s}static getDataBlocks(t,s){const r=s.getECBlocks();let a=0;const i=r.getECBlocks();for(let ue of i)a+=ue.getCount();const o=new Array(a);let d=0;for(let ue of i)for(let Se=0;Se<ue.getCount();Se++){const ze=ue.getDataCodewords(),We=r.getECCodewords()+ze;o[d++]=new Pr(ze,new Uint8Array(We))}const m=o[0].codewords.length-r.getECCodewords(),y=m-1;let T=0;for(let ue=0;ue<y;ue++)for(let Se=0;Se<d;Se++)o[Se].codewords[ue]=t[T++];const z=s.getVersionNumber()===24,Y=z?8:d;for(let ue=0;ue<Y;ue++)o[ue].codewords[m-1]=t[T++];const ce=o[0].codewords.length;for(let ue=m;ue<ce;ue++)for(let Se=0;Se<d;Se++){const ze=z?(Se+8)%d:Se,We=z&&ze>7?ue-1:ue;o[ze].codewords[We]=t[T++]}if(T!==t.length)throw new p;return o}getNumDataCodewords(){return this.numDataCodewords}getCodewords(){return this.codewords}}class Br{constructor(t){this.bytes=t,this.byteOffset=0,this.bitOffset=0}getBitOffset(){return this.bitOffset}getByteOffset(){return this.byteOffset}readBits(t){if(t<1||t>32||t>this.available())throw new p(""+t);let s=0,r=this.bitOffset,a=this.byteOffset;const i=this.bytes;if(r>0){const o=8-r,d=t<o?t:o,h=o-d,m=255>>8-d<<h;s=(i[a]&m)>>h,t-=d,r+=d,r===8&&(r=0,a++)}if(t>0){for(;t>=8;)s=s<<8|i[a]&255,a++,t-=8;if(t>0){const o=8-t,d=255>>o<<o;s=s<<t|(i[a]&d)>>o,r+=t}}return this.bitOffset=r,this.byteOffset=a,s}available(){return 8*(this.bytes.length-this.byteOffset)-this.bitOffset}}var Yt;(function(A){A[A.PAD_ENCODE=0]="PAD_ENCODE",A[A.ASCII_ENCODE=1]="ASCII_ENCODE",A[A.C40_ENCODE=2]="C40_ENCODE",A[A.TEXT_ENCODE=3]="TEXT_ENCODE",A[A.ANSIX12_ENCODE=4]="ANSIX12_ENCODE",A[A.EDIFACT_ENCODE=5]="EDIFACT_ENCODE",A[A.BASE256_ENCODE=6]="BASE256_ENCODE"})(Yt||(Yt={}));class qs{static decode(t){const s=new Br(t),r=new se,a=new se,i=new Array;let o=Yt.ASCII_ENCODE;do if(o===Yt.ASCII_ENCODE)o=this.decodeAsciiSegment(s,r,a);else{switch(o){case Yt.C40_ENCODE:this.decodeC40Segment(s,r);break;case Yt.TEXT_ENCODE:this.decodeTextSegment(s,r);break;case Yt.ANSIX12_ENCODE:this.decodeAnsiX12Segment(s,r);break;case Yt.EDIFACT_ENCODE:this.decodeEdifactSegment(s,r);break;case Yt.BASE256_ENCODE:this.decodeBase256Segment(s,r,i);break;default:throw new _}o=Yt.ASCII_ENCODE}while(o!==Yt.PAD_ENCODE&&s.available()>0);return a.length()>0&&r.append(a.toString()),new ye(t,r.toString(),i.length===0?null:i,null)}static decodeAsciiSegment(t,s,r){let a=!1;do{let i=t.readBits(8);if(i===0)throw new _;if(i<=128)return a&&(i+=128),s.append(String.fromCharCode(i-1)),Yt.ASCII_ENCODE;if(i===129)return Yt.PAD_ENCODE;if(i<=229){const o=i-130;o<10&&s.append("0"),s.append(""+o)}else switch(i){case 230:return Yt.C40_ENCODE;case 231:return Yt.BASE256_ENCODE;case 232:s.append("");break;case 233:case 234:break;case 235:a=!0;break;case 236:s.append("[)>05"),r.insert(0,"");break;case 237:s.append("[)>06"),r.insert(0,"");break;case 238:return Yt.ANSIX12_ENCODE;case 239:return Yt.TEXT_ENCODE;case 240:return Yt.EDIFACT_ENCODE;case 241:break;default:if(i!==254||t.available()!==0)throw new _;break}}while(t.available()>0);return Yt.ASCII_ENCODE}static decodeC40Segment(t,s){let r=!1;const a=[];let i=0;do{if(t.available()===8)return;const o=t.readBits(8);if(o===254)return;this.parseTwoBytes(o,t.readBits(8),a);for(let d=0;d<3;d++){const h=a[d];switch(i){case 0:if(h<3)i=h+1;else if(h<this.C40_BASIC_SET_CHARS.length){const m=this.C40_BASIC_SET_CHARS[h];r?(s.append(String.fromCharCode(m.charCodeAt(0)+128)),r=!1):s.append(m)}else throw new _;break;case 1:r?(s.append(String.fromCharCode(h+128)),r=!1):s.append(String.fromCharCode(h)),i=0;break;case 2:if(h<this.C40_SHIFT2_SET_CHARS.length){const m=this.C40_SHIFT2_SET_CHARS[h];r?(s.append(String.fromCharCode(m.charCodeAt(0)+128)),r=!1):s.append(m)}else switch(h){case 27:s.append("");break;case 30:r=!0;break;default:throw new _}i=0;break;case 3:r?(s.append(String.fromCharCode(h+224)),r=!1):s.append(String.fromCharCode(h+96)),i=0;break;default:throw new _}}}while(t.available()>0)}static decodeTextSegment(t,s){let r=!1,a=[],i=0;do{if(t.available()===8)return;const o=t.readBits(8);if(o===254)return;this.parseTwoBytes(o,t.readBits(8),a);for(let d=0;d<3;d++){const h=a[d];switch(i){case 0:if(h<3)i=h+1;else if(h<this.TEXT_BASIC_SET_CHARS.length){const m=this.TEXT_BASIC_SET_CHARS[h];r?(s.append(String.fromCharCode(m.charCodeAt(0)+128)),r=!1):s.append(m)}else throw new _;break;case 1:r?(s.append(String.fromCharCode(h+128)),r=!1):s.append(String.fromCharCode(h)),i=0;break;case 2:if(h<this.TEXT_SHIFT2_SET_CHARS.length){const m=this.TEXT_SHIFT2_SET_CHARS[h];r?(s.append(String.fromCharCode(m.charCodeAt(0)+128)),r=!1):s.append(m)}else switch(h){case 27:s.append("");break;case 30:r=!0;break;default:throw new _}i=0;break;case 3:if(h<this.TEXT_SHIFT3_SET_CHARS.length){const m=this.TEXT_SHIFT3_SET_CHARS[h];r?(s.append(String.fromCharCode(m.charCodeAt(0)+128)),r=!1):s.append(m),i=0}else throw new _;break;default:throw new _}}}while(t.available()>0)}static decodeAnsiX12Segment(t,s){const r=[];do{if(t.available()===8)return;const a=t.readBits(8);if(a===254)return;this.parseTwoBytes(a,t.readBits(8),r);for(let i=0;i<3;i++){const o=r[i];switch(o){case 0:s.append("\r");break;case 1:s.append("*");break;case 2:s.append(">");break;case 3:s.append(" ");break;default:if(o<14)s.append(String.fromCharCode(o+44));else if(o<40)s.append(String.fromCharCode(o+51));else throw new _;break}}}while(t.available()>0)}static parseTwoBytes(t,s,r){let a=(t<<8)+s-1,i=Math.floor(a/1600);r[0]=i,a-=i*1600,i=Math.floor(a/40),r[1]=i,r[2]=a-i*40}static decodeEdifactSegment(t,s){do{if(t.available()<=16)return;for(let r=0;r<4;r++){let a=t.readBits(6);if(a===31){const i=8-t.getBitOffset();i!==8&&t.readBits(i);return}a&32||(a|=64),s.append(String.fromCharCode(a))}}while(t.available()>0)}static decodeBase256Segment(t,s,r){let a=1+t.getByteOffset();const i=this.unrandomize255State(t.readBits(8),a++);let o;if(i===0?o=t.available()/8|0:i<250?o=i:o=250*(i-249)+this.unrandomize255State(t.readBits(8),a++),o<0)throw new _;const d=new Uint8Array(o);for(let h=0;h<o;h++){if(t.available()<8)throw new _;d[h]=this.unrandomize255State(t.readBits(8),a++)}r.push(d);try{s.append(O.decode(d,W.ISO88591))}catch(h){throw new rt("Platform does not support required encoding: "+h.message)}}static unrandomize255State(t,s){const r=149*s%255+1,a=t-r;return a>=0?a:a+256}}qs.C40_BASIC_SET_CHARS=["*","*","*"," ","0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],qs.C40_SHIFT2_SET_CHARS=["!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/",":",";","<","=",">","?","@","[","\\","]","^","_"],qs.TEXT_BASIC_SET_CHARS=["*","*","*"," ","0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],qs.TEXT_SHIFT2_SET_CHARS=qs.C40_SHIFT2_SET_CHARS,qs.TEXT_SHIFT3_SET_CHARS=["`","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","{","|","}","~",""];class xs{constructor(){this.rsDecoder=new at(Ue.DATA_MATRIX_FIELD_256)}decode(t){const s=new Lr(t),r=s.getVersion(),a=s.readCodewords(),i=Pr.getDataBlocks(a,r);let o=0;for(let m of i)o+=m.getNumDataCodewords();const d=new Uint8Array(o),h=i.length;for(let m=0;m<h;m++){const y=i[m],T=y.getCodewords(),z=y.getNumDataCodewords();this.correctErrors(T,z);for(let Y=0;Y<z;Y++)d[Y*h+m]=T[Y]}return qs.decode(d)}correctErrors(t,s){const r=new Int32Array(t);try{this.rsDecoder.decode(r,t.length-s)}catch{throw new B}for(let a=0;a<s;a++)t[a]=r[a]}}class qt{constructor(t){this.image=t,this.rectangleDetector=new ne(this.image)}detect(){const t=this.rectangleDetector.detect();let s=this.detectSolid1(t);if(s=this.detectSolid2(s),s[3]=this.correctTopRight(s),!s[3])throw new $;s=this.shiftToModuleCenter(s);const r=s[0],a=s[1],i=s[2],o=s[3];let d=this.transitionsBetween(r,o)+1,h=this.transitionsBetween(i,o)+1;(d&1)===1&&(d+=1),(h&1)===1&&(h+=1),4*d<7*h&&4*h<7*d&&(d=h=Math.max(d,h));let m=qt.sampleGrid(this.image,r,a,i,o,d,h);return new Te(m,[r,a,i,o])}static shiftPoint(t,s,r){let a=(s.getX()-t.getX())/(r+1),i=(s.getY()-t.getY())/(r+1);return new Ye(t.getX()+a,t.getY()+i)}static moveAway(t,s,r){let a=t.getX(),i=t.getY();return a<s?a-=1:a+=1,i<r?i-=1:i+=1,new Ye(a,i)}detectSolid1(t){let s=t[0],r=t[1],a=t[3],i=t[2],o=this.transitionsBetween(s,r),d=this.transitionsBetween(r,a),h=this.transitionsBetween(a,i),m=this.transitionsBetween(i,s),y=o,T=[i,s,r,a];return y>d&&(y=d,T[0]=s,T[1]=r,T[2]=a,T[3]=i),y>h&&(y=h,T[0]=r,T[1]=a,T[2]=i,T[3]=s),y>m&&(T[0]=a,T[1]=i,T[2]=s,T[3]=r),T}detectSolid2(t){let s=t[0],r=t[1],a=t[2],i=t[3],o=this.transitionsBetween(s,i),d=qt.shiftPoint(r,a,(o+1)*4),h=qt.shiftPoint(a,r,(o+1)*4),m=this.transitionsBetween(d,s),y=this.transitionsBetween(h,i);return m<y?(t[0]=s,t[1]=r,t[2]=a,t[3]=i):(t[0]=r,t[1]=a,t[2]=i,t[3]=s),t}correctTopRight(t){let s=t[0],r=t[1],a=t[2],i=t[3],o=this.transitionsBetween(s,i),d=this.transitionsBetween(r,i),h=qt.shiftPoint(s,r,(d+1)*4),m=qt.shiftPoint(a,r,(o+1)*4);o=this.transitionsBetween(h,i),d=this.transitionsBetween(m,i);let y=new Ye(i.getX()+(a.getX()-r.getX())/(o+1),i.getY()+(a.getY()-r.getY())/(o+1)),T=new Ye(i.getX()+(s.getX()-r.getX())/(d+1),i.getY()+(s.getY()-r.getY())/(d+1));if(!this.isValid(y))return this.isValid(T)?T:null;if(!this.isValid(T))return y;let z=this.transitionsBetween(h,y)+this.transitionsBetween(m,y),Y=this.transitionsBetween(h,T)+this.transitionsBetween(m,T);return z>Y?y:T}shiftToModuleCenter(t){let s=t[0],r=t[1],a=t[2],i=t[3],o=this.transitionsBetween(s,i)+1,d=this.transitionsBetween(a,i)+1,h=qt.shiftPoint(s,r,d*4),m=qt.shiftPoint(a,r,o*4);o=this.transitionsBetween(h,i)+1,d=this.transitionsBetween(m,i)+1,(o&1)===1&&(o+=1),(d&1)===1&&(d+=1);let y=(s.getX()+r.getX()+a.getX()+i.getX())/4,T=(s.getY()+r.getY()+a.getY()+i.getY())/4;s=qt.moveAway(s,y,T),r=qt.moveAway(r,y,T),a=qt.moveAway(a,y,T),i=qt.moveAway(i,y,T);let z,Y;return h=qt.shiftPoint(s,r,d*4),h=qt.shiftPoint(h,i,o*4),z=qt.shiftPoint(r,s,d*4),z=qt.shiftPoint(z,a,o*4),m=qt.shiftPoint(a,i,d*4),m=qt.shiftPoint(m,r,o*4),Y=qt.shiftPoint(i,a,d*4),Y=qt.shiftPoint(Y,s,o*4),[h,z,m,Y]}isValid(t){return t.getX()>=0&&t.getX()<this.image.getWidth()&&t.getY()>0&&t.getY()<this.image.getHeight()}static sampleGrid(t,s,r,a,i,o,d){return ee.getInstance().sampleGrid(t,o,d,.5,.5,o-.5,.5,o-.5,d-.5,.5,d-.5,s.getX(),s.getY(),i.getX(),i.getY(),a.getX(),a.getY(),r.getX(),r.getY())}transitionsBetween(t,s){let r=Math.trunc(t.getX()),a=Math.trunc(t.getY()),i=Math.trunc(s.getX()),o=Math.trunc(s.getY()),d=Math.abs(o-a)>Math.abs(i-r);if(d){let ue=r;r=a,a=ue,ue=i,i=o,o=ue}let h=Math.abs(i-r),m=Math.abs(o-a),y=-h/2,T=a<o?1:-1,z=r<i?1:-1,Y=0,ce=this.image.get(d?a:r,d?r:a);for(let ue=r,Se=a;ue!==i;ue+=z){let ze=this.image.get(d?Se:ue,d?ue:Se);if(ze!==ce&&(Y++,ce=ze),y+=m,y>0){if(Se===o)break;Se+=T,y-=h}}return Y}}class xe{constructor(){this.decoder=new xs}decode(t,s=null){let r,a;if(s!=null&&s.has(N.PURE_BARCODE)){const m=xe.extractPureBits(t.getBlackMatrix());r=this.decoder.decode(m),a=xe.NO_POINTS}else{const m=new qt(t.getBlackMatrix()).detect();r=this.decoder.decode(m.getBits()),a=m.getPoints()}const i=r.getRawBytes(),o=new V(r.getText(),i,8*i.length,a,ae.DATA_MATRIX,R.currentTimeMillis()),d=r.getByteSegments();d!=null&&o.putMetadata(be.BYTE_SEGMENTS,d);const h=r.getECLevel();return h!=null&&o.putMetadata(be.ERROR_CORRECTION_LEVEL,h),o}reset(){}static extractPureBits(t){const s=t.getTopLeftOnBit(),r=t.getBottomRightOnBit();if(s==null||r==null)throw new $;const a=this.moduleSize(s,t);let i=s[1];const o=r[1];let d=s[0];const m=(r[0]-d+1)/a,y=(o-i+1)/a;if(m<=0||y<=0)throw new $;const T=a/2;i+=T,d+=T;const z=new G(m,y);for(let Y=0;Y<y;Y++){const ce=i+Y*a;for(let ue=0;ue<m;ue++)t.get(d+ue*a,ce)&&z.set(ue,Y)}return z}static moduleSize(t,s){const r=s.getWidth();let a=t[0];const i=t[1];for(;a<r&&s.get(a,i);)a++;if(a===r)throw new $;const o=a-t[0];if(o===0)throw new $;return o}}xe.NO_POINTS=[];class Be extends Q{constructor(t=500){super(new xe,t)}}var Xe;(function(A){A[A.L=0]="L",A[A.M=1]="M",A[A.Q=2]="Q",A[A.H=3]="H"})(Xe||(Xe={}));class Pe{constructor(t,s,r){this.value=t,this.stringValue=s,this.bits=r,Pe.FOR_BITS.set(r,this),Pe.FOR_VALUE.set(t,this)}getValue(){return this.value}getBits(){return this.bits}static fromString(t){switch(t){case"L":return Pe.L;case"M":return Pe.M;case"Q":return Pe.Q;case"H":return Pe.H;default:throw new j(t+"not available")}}toString(){return this.stringValue}equals(t){if(!(t instanceof Pe))return!1;const s=t;return this.value===s.value}static forBits(t){if(t<0||t>=Pe.FOR_BITS.size)throw new p;return Pe.FOR_BITS.get(t)}}Pe.FOR_BITS=new Map,Pe.FOR_VALUE=new Map,Pe.L=new Pe(Xe.L,"L",1),Pe.M=new Pe(Xe.M,"M",0),Pe.Q=new Pe(Xe.Q,"Q",3),Pe.H=new Pe(Xe.H,"H",2);class Ze{constructor(t){this.errorCorrectionLevel=Pe.forBits(t>>3&3),this.dataMask=t&7}static numBitsDiffering(t,s){return U.bitCount(t^s)}static decodeFormatInformation(t,s){const r=Ze.doDecodeFormatInformation(t,s);return r!==null?r:Ze.doDecodeFormatInformation(t^Ze.FORMAT_INFO_MASK_QR,s^Ze.FORMAT_INFO_MASK_QR)}static doDecodeFormatInformation(t,s){let r=Number.MAX_SAFE_INTEGER,a=0;for(const i of Ze.FORMAT_INFO_DECODE_LOOKUP){const o=i[0];if(o===t||o===s)return new Ze(i[1]);let d=Ze.numBitsDiffering(t,o);d<r&&(a=i[1],r=d),t!==s&&(d=Ze.numBitsDiffering(s,o),d<r&&(a=i[1],r=d))}return r<=3?new Ze(a):null}getErrorCorrectionLevel(){return this.errorCorrectionLevel}getDataMask(){return this.dataMask}hashCode(){return this.errorCorrectionLevel.getBits()<<3|this.dataMask}equals(t){if(!(t instanceof Ze))return!1;const s=t;return this.errorCorrectionLevel===s.errorCorrectionLevel&&this.dataMask===s.dataMask}}Ze.FORMAT_INFO_MASK_QR=21522,Ze.FORMAT_INFO_DECODE_LOOKUP=[Int32Array.from([21522,0]),Int32Array.from([20773,1]),Int32Array.from([24188,2]),Int32Array.from([23371,3]),Int32Array.from([17913,4]),Int32Array.from([16590,5]),Int32Array.from([20375,6]),Int32Array.from([19104,7]),Int32Array.from([30660,8]),Int32Array.from([29427,9]),Int32Array.from([32170,10]),Int32Array.from([30877,11]),Int32Array.from([26159,12]),Int32Array.from([25368,13]),Int32Array.from([27713,14]),Int32Array.from([26998,15]),Int32Array.from([5769,16]),Int32Array.from([5054,17]),Int32Array.from([7399,18]),Int32Array.from([6608,19]),Int32Array.from([1890,20]),Int32Array.from([597,21]),Int32Array.from([3340,22]),Int32Array.from([2107,23]),Int32Array.from([13663,24]),Int32Array.from([12392,25]),Int32Array.from([16177,26]),Int32Array.from([14854,27]),Int32Array.from([9396,28]),Int32Array.from([8579,29]),Int32Array.from([11994,30]),Int32Array.from([11245,31])];class ie{constructor(t,...s){this.ecCodewordsPerBlock=t,this.ecBlocks=s}getECCodewordsPerBlock(){return this.ecCodewordsPerBlock}getNumBlocks(){let t=0;const s=this.ecBlocks;for(const r of s)t+=r.getCount();return t}getTotalECCodewords(){return this.ecCodewordsPerBlock*this.getNumBlocks()}getECBlocks(){return this.ecBlocks}}class P{constructor(t,s){this.count=t,this.dataCodewords=s}getCount(){return this.count}getDataCodewords(){return this.dataCodewords}}class He{constructor(t,s,...r){this.versionNumber=t,this.alignmentPatternCenters=s,this.ecBlocks=r;let a=0;const i=r[0].getECCodewordsPerBlock(),o=r[0].getECBlocks();for(const d of o)a+=d.getCount()*(d.getDataCodewords()+i);this.totalCodewords=a}getVersionNumber(){return this.versionNumber}getAlignmentPatternCenters(){return this.alignmentPatternCenters}getTotalCodewords(){return this.totalCodewords}getDimensionForVersion(){return 17+4*this.versionNumber}getECBlocksForLevel(t){return this.ecBlocks[t.getValue()]}static getProvisionalVersionForDimension(t){if(t%4!==1)throw new _;try{return this.getVersionForNumber((t-17)/4)}catch{throw new _}}static getVersionForNumber(t){if(t<1||t>40)throw new p;return He.VERSIONS[t-1]}static decodeVersionInformation(t){let s=Number.MAX_SAFE_INTEGER,r=0;for(let a=0;a<He.VERSION_DECODE_INFO.length;a++){const i=He.VERSION_DECODE_INFO[a];if(i===t)return He.getVersionForNumber(a+7);const o=Ze.numBitsDiffering(t,i);o<s&&(r=a+7,s=o)}return s<=3?He.getVersionForNumber(r):null}buildFunctionPattern(){const t=this.getDimensionForVersion(),s=new G(t);s.setRegion(0,0,9,9),s.setRegion(t-8,0,8,9),s.setRegion(0,t-8,9,8);const r=this.alignmentPatternCenters.length;for(let a=0;a<r;a++){const i=this.alignmentPatternCenters[a]-2;for(let o=0;o<r;o++)a===0&&(o===0||o===r-1)||a===r-1&&o===0||s.setRegion(this.alignmentPatternCenters[o]-2,i,5,5)}return s.setRegion(6,9,1,t-17),s.setRegion(9,6,t-17,1),this.versionNumber>6&&(s.setRegion(t-11,0,3,6),s.setRegion(0,t-11,6,3)),s}toString(){return""+this.versionNumber}}He.VERSION_DECODE_INFO=Int32Array.from([31892,34236,39577,42195,48118,51042,55367,58893,63784,68472,70749,76311,79154,84390,87683,92361,96236,102084,102881,110507,110734,117786,119615,126325,127568,133589,136944,141498,145311,150283,152622,158308,161089,167017]),He.VERSIONS=[new He(1,new Int32Array(0),new ie(7,new P(1,19)),new ie(10,new P(1,16)),new ie(13,new P(1,13)),new ie(17,new P(1,9))),new He(2,Int32Array.from([6,18]),new ie(10,new P(1,34)),new ie(16,new P(1,28)),new ie(22,new P(1,22)),new ie(28,new P(1,16))),new He(3,Int32Array.from([6,22]),new ie(15,new P(1,55)),new ie(26,new P(1,44)),new ie(18,new P(2,17)),new ie(22,new P(2,13))),new He(4,Int32Array.from([6,26]),new ie(20,new P(1,80)),new ie(18,new P(2,32)),new ie(26,new P(2,24)),new ie(16,new P(4,9))),new He(5,Int32Array.from([6,30]),new ie(26,new P(1,108)),new ie(24,new P(2,43)),new ie(18,new P(2,15),new P(2,16)),new ie(22,new P(2,11),new P(2,12))),new He(6,Int32Array.from([6,34]),new ie(18,new P(2,68)),new ie(16,new P(4,27)),new ie(24,new P(4,19)),new ie(28,new P(4,15))),new He(7,Int32Array.from([6,22,38]),new ie(20,new P(2,78)),new ie(18,new P(4,31)),new ie(18,new P(2,14),new P(4,15)),new ie(26,new P(4,13),new P(1,14))),new He(8,Int32Array.from([6,24,42]),new ie(24,new P(2,97)),new ie(22,new P(2,38),new P(2,39)),new ie(22,new P(4,18),new P(2,19)),new ie(26,new P(4,14),new P(2,15))),new He(9,Int32Array.from([6,26,46]),new ie(30,new P(2,116)),new ie(22,new P(3,36),new P(2,37)),new ie(20,new P(4,16),new P(4,17)),new ie(24,new P(4,12),new P(4,13))),new He(10,Int32Array.from([6,28,50]),new ie(18,new P(2,68),new P(2,69)),new ie(26,new P(4,43),new P(1,44)),new ie(24,new P(6,19),new P(2,20)),new ie(28,new P(6,15),new P(2,16))),new He(11,Int32Array.from([6,30,54]),new ie(20,new P(4,81)),new ie(30,new P(1,50),new P(4,51)),new ie(28,new P(4,22),new P(4,23)),new ie(24,new P(3,12),new P(8,13))),new He(12,Int32Array.from([6,32,58]),new ie(24,new P(2,92),new P(2,93)),new ie(22,new P(6,36),new P(2,37)),new ie(26,new P(4,20),new P(6,21)),new ie(28,new P(7,14),new P(4,15))),new He(13,Int32Array.from([6,34,62]),new ie(26,new P(4,107)),new ie(22,new P(8,37),new P(1,38)),new ie(24,new P(8,20),new P(4,21)),new ie(22,new P(12,11),new P(4,12))),new He(14,Int32Array.from([6,26,46,66]),new ie(30,new P(3,115),new P(1,116)),new ie(24,new P(4,40),new P(5,41)),new ie(20,new P(11,16),new P(5,17)),new ie(24,new P(11,12),new P(5,13))),new He(15,Int32Array.from([6,26,48,70]),new ie(22,new P(5,87),new P(1,88)),new ie(24,new P(5,41),new P(5,42)),new ie(30,new P(5,24),new P(7,25)),new ie(24,new P(11,12),new P(7,13))),new He(16,Int32Array.from([6,26,50,74]),new ie(24,new P(5,98),new P(1,99)),new ie(28,new P(7,45),new P(3,46)),new ie(24,new P(15,19),new P(2,20)),new ie(30,new P(3,15),new P(13,16))),new He(17,Int32Array.from([6,30,54,78]),new ie(28,new P(1,107),new P(5,108)),new ie(28,new P(10,46),new P(1,47)),new ie(28,new P(1,22),new P(15,23)),new ie(28,new P(2,14),new P(17,15))),new He(18,Int32Array.from([6,30,56,82]),new ie(30,new P(5,120),new P(1,121)),new ie(26,new P(9,43),new P(4,44)),new ie(28,new P(17,22),new P(1,23)),new ie(28,new P(2,14),new P(19,15))),new He(19,Int32Array.from([6,30,58,86]),new ie(28,new P(3,113),new P(4,114)),new ie(26,new P(3,44),new P(11,45)),new ie(26,new P(17,21),new P(4,22)),new ie(26,new P(9,13),new P(16,14))),new He(20,Int32Array.from([6,34,62,90]),new ie(28,new P(3,107),new P(5,108)),new ie(26,new P(3,41),new P(13,42)),new ie(30,new P(15,24),new P(5,25)),new ie(28,new P(15,15),new P(10,16))),new He(21,Int32Array.from([6,28,50,72,94]),new ie(28,new P(4,116),new P(4,117)),new ie(26,new P(17,42)),new ie(28,new P(17,22),new P(6,23)),new ie(30,new P(19,16),new P(6,17))),new He(22,Int32Array.from([6,26,50,74,98]),new ie(28,new P(2,111),new P(7,112)),new ie(28,new P(17,46)),new ie(30,new P(7,24),new P(16,25)),new ie(24,new P(34,13))),new He(23,Int32Array.from([6,30,54,78,102]),new ie(30,new P(4,121),new P(5,122)),new ie(28,new P(4,47),new P(14,48)),new ie(30,new P(11,24),new P(14,25)),new ie(30,new P(16,15),new P(14,16))),new He(24,Int32Array.from([6,28,54,80,106]),new ie(30,new P(6,117),new P(4,118)),new ie(28,new P(6,45),new P(14,46)),new ie(30,new P(11,24),new P(16,25)),new ie(30,new P(30,16),new P(2,17))),new He(25,Int32Array.from([6,32,58,84,110]),new ie(26,new P(8,106),new P(4,107)),new ie(28,new P(8,47),new P(13,48)),new ie(30,new P(7,24),new P(22,25)),new ie(30,new P(22,15),new P(13,16))),new He(26,Int32Array.from([6,30,58,86,114]),new ie(28,new P(10,114),new P(2,115)),new ie(28,new P(19,46),new P(4,47)),new ie(28,new P(28,22),new P(6,23)),new ie(30,new P(33,16),new P(4,17))),new He(27,Int32Array.from([6,34,62,90,118]),new ie(30,new P(8,122),new P(4,123)),new ie(28,new P(22,45),new P(3,46)),new ie(30,new P(8,23),new P(26,24)),new ie(30,new P(12,15),new P(28,16))),new He(28,Int32Array.from([6,26,50,74,98,122]),new ie(30,new P(3,117),new P(10,118)),new ie(28,new P(3,45),new P(23,46)),new ie(30,new P(4,24),new P(31,25)),new ie(30,new P(11,15),new P(31,16))),new He(29,Int32Array.from([6,30,54,78,102,126]),new ie(30,new P(7,116),new P(7,117)),new ie(28,new P(21,45),new P(7,46)),new ie(30,new P(1,23),new P(37,24)),new ie(30,new P(19,15),new P(26,16))),new He(30,Int32Array.from([6,26,52,78,104,130]),new ie(30,new P(5,115),new P(10,116)),new ie(28,new P(19,47),new P(10,48)),new ie(30,new P(15,24),new P(25,25)),new ie(30,new P(23,15),new P(25,16))),new He(31,Int32Array.from([6,30,56,82,108,134]),new ie(30,new P(13,115),new P(3,116)),new ie(28,new P(2,46),new P(29,47)),new ie(30,new P(42,24),new P(1,25)),new ie(30,new P(23,15),new P(28,16))),new He(32,Int32Array.from([6,34,60,86,112,138]),new ie(30,new P(17,115)),new ie(28,new P(10,46),new P(23,47)),new ie(30,new P(10,24),new P(35,25)),new ie(30,new P(19,15),new P(35,16))),new He(33,Int32Array.from([6,30,58,86,114,142]),new ie(30,new P(17,115),new P(1,116)),new ie(28,new P(14,46),new P(21,47)),new ie(30,new P(29,24),new P(19,25)),new ie(30,new P(11,15),new P(46,16))),new He(34,Int32Array.from([6,34,62,90,118,146]),new ie(30,new P(13,115),new P(6,116)),new ie(28,new P(14,46),new P(23,47)),new ie(30,new P(44,24),new P(7,25)),new ie(30,new P(59,16),new P(1,17))),new He(35,Int32Array.from([6,30,54,78,102,126,150]),new ie(30,new P(12,121),new P(7,122)),new ie(28,new P(12,47),new P(26,48)),new ie(30,new P(39,24),new P(14,25)),new ie(30,new P(22,15),new P(41,16))),new He(36,Int32Array.from([6,24,50,76,102,128,154]),new ie(30,new P(6,121),new P(14,122)),new ie(28,new P(6,47),new P(34,48)),new ie(30,new P(46,24),new P(10,25)),new ie(30,new P(2,15),new P(64,16))),new He(37,Int32Array.from([6,28,54,80,106,132,158]),new ie(30,new P(17,122),new P(4,123)),new ie(28,new P(29,46),new P(14,47)),new ie(30,new P(49,24),new P(10,25)),new ie(30,new P(24,15),new P(46,16))),new He(38,Int32Array.from([6,32,58,84,110,136,162]),new ie(30,new P(4,122),new P(18,123)),new ie(28,new P(13,46),new P(32,47)),new ie(30,new P(48,24),new P(14,25)),new ie(30,new P(42,15),new P(32,16))),new He(39,Int32Array.from([6,26,54,82,110,138,166]),new ie(30,new P(20,117),new P(4,118)),new ie(28,new P(40,47),new P(7,48)),new ie(30,new P(43,24),new P(22,25)),new ie(30,new P(10,15),new P(67,16))),new He(40,Int32Array.from([6,30,58,86,114,142,170]),new ie(30,new P(19,118),new P(6,119)),new ie(28,new P(18,47),new P(31,48)),new ie(30,new P(34,24),new P(34,25)),new ie(30,new P(20,15),new P(61,16)))];var dt;(function(A){A[A.DATA_MASK_000=0]="DATA_MASK_000",A[A.DATA_MASK_001=1]="DATA_MASK_001",A[A.DATA_MASK_010=2]="DATA_MASK_010",A[A.DATA_MASK_011=3]="DATA_MASK_011",A[A.DATA_MASK_100=4]="DATA_MASK_100",A[A.DATA_MASK_101=5]="DATA_MASK_101",A[A.DATA_MASK_110=6]="DATA_MASK_110",A[A.DATA_MASK_111=7]="DATA_MASK_111"})(dt||(dt={}));class Rt{constructor(t,s){this.value=t,this.isMasked=s}unmaskBitMatrix(t,s){for(let r=0;r<s;r++)for(let a=0;a<s;a++)this.isMasked(r,a)&&t.flip(a,r)}}Rt.values=new Map([[dt.DATA_MASK_000,new Rt(dt.DATA_MASK_000,(A,t)=>(A+t&1)===0)],[dt.DATA_MASK_001,new Rt(dt.DATA_MASK_001,(A,t)=>(A&1)===0)],[dt.DATA_MASK_010,new Rt(dt.DATA_MASK_010,(A,t)=>t%3===0)],[dt.DATA_MASK_011,new Rt(dt.DATA_MASK_011,(A,t)=>(A+t)%3===0)],[dt.DATA_MASK_100,new Rt(dt.DATA_MASK_100,(A,t)=>(Math.floor(A/2)+Math.floor(t/3)&1)===0)],[dt.DATA_MASK_101,new Rt(dt.DATA_MASK_101,(A,t)=>A*t%6===0)],[dt.DATA_MASK_110,new Rt(dt.DATA_MASK_110,(A,t)=>A*t%6<3)],[dt.DATA_MASK_111,new Rt(dt.DATA_MASK_111,(A,t)=>(A+t+A*t%3&1)===0)]]);class _s{constructor(t){const s=t.getHeight();if(s<21||(s&3)!==1)throw new _;this.bitMatrix=t}readFormatInformation(){if(this.parsedFormatInfo!==null&&this.parsedFormatInfo!==void 0)return this.parsedFormatInfo;let t=0;for(let i=0;i<6;i++)t=this.copyBit(i,8,t);t=this.copyBit(7,8,t),t=this.copyBit(8,8,t),t=this.copyBit(8,7,t);for(let i=5;i>=0;i--)t=this.copyBit(8,i,t);const s=this.bitMatrix.getHeight();let r=0;const a=s-7;for(let i=s-1;i>=a;i--)r=this.copyBit(8,i,r);for(let i=s-8;i<s;i++)r=this.copyBit(i,8,r);if(this.parsedFormatInfo=Ze.decodeFormatInformation(t,r),this.parsedFormatInfo!==null)return this.parsedFormatInfo;throw new _}readVersion(){if(this.parsedVersion!==null&&this.parsedVersion!==void 0)return this.parsedVersion;const t=this.bitMatrix.getHeight(),s=Math.floor((t-17)/4);if(s<=6)return He.getVersionForNumber(s);let r=0;const a=t-11;for(let o=5;o>=0;o--)for(let d=t-9;d>=a;d--)r=this.copyBit(d,o,r);let i=He.decodeVersionInformation(r);if(i!==null&&i.getDimensionForVersion()===t)return this.parsedVersion=i,i;r=0;for(let o=5;o>=0;o--)for(let d=t-9;d>=a;d--)r=this.copyBit(o,d,r);if(i=He.decodeVersionInformation(r),i!==null&&i.getDimensionForVersion()===t)return this.parsedVersion=i,i;throw new _}copyBit(t,s,r){return(this.isMirror?this.bitMatrix.get(s,t):this.bitMatrix.get(t,s))?r<<1|1:r<<1}readCodewords(){const t=this.readFormatInformation(),s=this.readVersion(),r=Rt.values.get(t.getDataMask()),a=this.bitMatrix.getHeight();r.unmaskBitMatrix(this.bitMatrix,a);const i=s.buildFunctionPattern();let o=!0;const d=new Uint8Array(s.getTotalCodewords());let h=0,m=0,y=0;for(let T=a-1;T>0;T-=2){T===6&&T--;for(let z=0;z<a;z++){const Y=o?a-1-z:z;for(let ce=0;ce<2;ce++)i.get(T-ce,Y)||(y++,m<<=1,this.bitMatrix.get(T-ce,Y)&&(m|=1),y===8&&(d[h++]=m,y=0,m=0))}o=!o}if(h!==s.getTotalCodewords())throw new _;return d}remask(){if(this.parsedFormatInfo===null)return;const t=Rt.values[this.parsedFormatInfo.getDataMask()],s=this.bitMatrix.getHeight();t.unmaskBitMatrix(this.bitMatrix,s)}setMirror(t){this.parsedVersion=null,this.parsedFormatInfo=null,this.isMirror=t}mirror(){const t=this.bitMatrix;for(let s=0,r=t.getWidth();s<r;s++)for(let a=s+1,i=t.getHeight();a<i;a++)t.get(s,a)!==t.get(a,s)&&(t.flip(a,s),t.flip(s,a))}}class ms{constructor(t,s){this.numDataCodewords=t,this.codewords=s}static getDataBlocks(t,s,r){if(t.length!==s.getTotalCodewords())throw new p;const a=s.getECBlocksForLevel(r);let i=0;const o=a.getECBlocks();for(const ce of o)i+=ce.getCount();const d=new Array(i);let h=0;for(const ce of o)for(let ue=0;ue<ce.getCount();ue++){const Se=ce.getDataCodewords(),ze=a.getECCodewordsPerBlock()+Se;d[h++]=new ms(Se,new Uint8Array(ze))}const m=d[0].codewords.length;let y=d.length-1;for(;y>=0&&d[y].codewords.length!==m;)y--;y++;const T=m-a.getECCodewordsPerBlock();let z=0;for(let ce=0;ce<T;ce++)for(let ue=0;ue<h;ue++)d[ue].codewords[ce]=t[z++];for(let ce=y;ce<h;ce++)d[ce].codewords[T]=t[z++];const Y=d[0].codewords.length;for(let ce=T;ce<Y;ce++)for(let ue=0;ue<h;ue++){const Se=ue<y?ce:ce+1;d[ue].codewords[Se]=t[z++]}return d}getNumDataCodewords(){return this.numDataCodewords}getCodewords(){return this.codewords}}var $t;(function(A){A[A.TERMINATOR=0]="TERMINATOR",A[A.NUMERIC=1]="NUMERIC",A[A.ALPHANUMERIC=2]="ALPHANUMERIC",A[A.STRUCTURED_APPEND=3]="STRUCTURED_APPEND",A[A.BYTE=4]="BYTE",A[A.ECI=5]="ECI",A[A.KANJI=6]="KANJI",A[A.FNC1_FIRST_POSITION=7]="FNC1_FIRST_POSITION",A[A.FNC1_SECOND_POSITION=8]="FNC1_SECOND_POSITION",A[A.HANZI=9]="HANZI"})($t||($t={}));class tt{constructor(t,s,r,a){this.value=t,this.stringValue=s,this.characterCountBitsForVersions=r,this.bits=a,tt.FOR_BITS.set(a,this),tt.FOR_VALUE.set(t,this)}static forBits(t){const s=tt.FOR_BITS.get(t);if(s===void 0)throw new p;return s}getCharacterCountBits(t){const s=t.getVersionNumber();let r;return s<=9?r=0:s<=26?r=1:r=2,this.characterCountBitsForVersions[r]}getValue(){return this.value}getBits(){return this.bits}equals(t){if(!(t instanceof tt))return!1;const s=t;return this.value===s.value}toString(){return this.stringValue}}tt.FOR_BITS=new Map,tt.FOR_VALUE=new Map,tt.TERMINATOR=new tt($t.TERMINATOR,"TERMINATOR",Int32Array.from([0,0,0]),0),tt.NUMERIC=new tt($t.NUMERIC,"NUMERIC",Int32Array.from([10,12,14]),1),tt.ALPHANUMERIC=new tt($t.ALPHANUMERIC,"ALPHANUMERIC",Int32Array.from([9,11,13]),2),tt.STRUCTURED_APPEND=new tt($t.STRUCTURED_APPEND,"STRUCTURED_APPEND",Int32Array.from([0,0,0]),3),tt.BYTE=new tt($t.BYTE,"BYTE",Int32Array.from([8,16,16]),4),tt.ECI=new tt($t.ECI,"ECI",Int32Array.from([0,0,0]),7),tt.KANJI=new tt($t.KANJI,"KANJI",Int32Array.from([8,10,12]),8),tt.FNC1_FIRST_POSITION=new tt($t.FNC1_FIRST_POSITION,"FNC1_FIRST_POSITION",Int32Array.from([0,0,0]),5),tt.FNC1_SECOND_POSITION=new tt($t.FNC1_SECOND_POSITION,"FNC1_SECOND_POSITION",Int32Array.from([0,0,0]),9),tt.HANZI=new tt($t.HANZI,"HANZI",Int32Array.from([8,10,12]),13);class xt{static decode(t,s,r,a){const i=new Br(t);let o=new se;const d=new Array;let h=-1,m=-1;try{let y=null,T=!1,z;do{if(i.available()<4)z=tt.TERMINATOR;else{const Y=i.readBits(4);z=tt.forBits(Y)}switch(z){case tt.TERMINATOR:break;case tt.FNC1_FIRST_POSITION:case tt.FNC1_SECOND_POSITION:T=!0;break;case tt.STRUCTURED_APPEND:if(i.available()<16)throw new _;h=i.readBits(8),m=i.readBits(8);break;case tt.ECI:const Y=xt.parseECIValue(i);if(y=I.getCharacterSetECIByValue(Y),y===null)throw new _;break;case tt.HANZI:const ce=i.readBits(4),ue=i.readBits(z.getCharacterCountBits(s));ce===xt.GB2312_SUBSET&&xt.decodeHanziSegment(i,o,ue);break;default:const Se=i.readBits(z.getCharacterCountBits(s));switch(z){case tt.NUMERIC:xt.decodeNumericSegment(i,o,Se);break;case tt.ALPHANUMERIC:xt.decodeAlphanumericSegment(i,o,Se,T);break;case tt.BYTE:xt.decodeByteSegment(i,o,Se,y,d,a);break;case tt.KANJI:xt.decodeKanjiSegment(i,o,Se);break;default:throw new _}break}}while(z!==tt.TERMINATOR)}catch{throw new _}return new ye(t,o.toString(),d.length===0?null:d,r===null?null:r.toString(),h,m)}static decodeHanziSegment(t,s,r){if(r*13>t.available())throw new _;const a=new Uint8Array(2*r);let i=0;for(;r>0;){const o=t.readBits(13);let d=o/96<<8&4294967295|o%96;d<959?d+=41377:d+=42657,a[i]=d>>8&255,a[i+1]=d&255,i+=2,r--}try{s.append(O.decode(a,W.GB2312))}catch(o){throw new _(o)}}static decodeKanjiSegment(t,s,r){if(r*13>t.available())throw new _;const a=new Uint8Array(2*r);let i=0;for(;r>0;){const o=t.readBits(13);let d=o/192<<8&4294967295|o%192;d<7936?d+=33088:d+=49472,a[i]=d>>8,a[i+1]=d,i+=2,r--}try{s.append(O.decode(a,W.SHIFT_JIS))}catch(o){throw new _(o)}}static decodeByteSegment(t,s,r,a,i,o){if(8*r>t.available())throw new _;const d=new Uint8Array(r);for(let m=0;m<r;m++)d[m]=t.readBits(8);let h;a===null?h=W.guessEncoding(d,o):h=a.getName();try{s.append(O.decode(d,h))}catch(m){throw new _(m)}i.push(d)}static toAlphaNumericChar(t){if(t>=xt.ALPHANUMERIC_CHARS.length)throw new _;return xt.ALPHANUMERIC_CHARS[t]}static decodeAlphanumericSegment(t,s,r,a){const i=s.length();for(;r>1;){if(t.available()<11)throw new _;const o=t.readBits(11);s.append(xt.toAlphaNumericChar(Math.floor(o/45))),s.append(xt.toAlphaNumericChar(o%45)),r-=2}if(r===1){if(t.available()<6)throw new _;s.append(xt.toAlphaNumericChar(t.readBits(6)))}if(a)for(let o=i;o<s.length();o++)s.charAt(o)==="%"&&(o<s.length()-1&&s.charAt(o+1)==="%"?s.deleteCharAt(o+1):s.setCharAt(o,""))}static decodeNumericSegment(t,s,r){for(;r>=3;){if(t.available()<10)throw new _;const a=t.readBits(10);if(a>=1e3)throw new _;s.append(xt.toAlphaNumericChar(Math.floor(a/100))),s.append(xt.toAlphaNumericChar(Math.floor(a/10)%10)),s.append(xt.toAlphaNumericChar(a%10)),r-=3}if(r===2){if(t.available()<7)throw new _;const a=t.readBits(7);if(a>=100)throw new _;s.append(xt.toAlphaNumericChar(Math.floor(a/10))),s.append(xt.toAlphaNumericChar(a%10))}else if(r===1){if(t.available()<4)throw new _;const a=t.readBits(4);if(a>=10)throw new _;s.append(xt.toAlphaNumericChar(a))}}static parseECIValue(t){const s=t.readBits(8);if(!(s&128))return s&127;if((s&192)===128){const r=t.readBits(8);return(s&63)<<8&4294967295|r}if((s&224)===192){const r=t.readBits(16);return(s&31)<<16&4294967295|r}throw new _}}xt.ALPHANUMERIC_CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:",xt.GB2312_SUBSET=1;class cs{constructor(t){this.mirrored=t}isMirrored(){return this.mirrored}applyMirroredCorrection(t){if(!this.mirrored||t===null||t.length<3)return;const s=t[0];t[0]=t[2],t[2]=s}}class zs{constructor(){this.rsDecoder=new at(Ue.QR_CODE_FIELD_256)}decodeBooleanArray(t,s){return this.decodeBitMatrix(G.parseFromBooleanArray(t),s)}decodeBitMatrix(t,s){const r=new _s(t);let a=null;try{return this.decodeBitMatrixParser(r,s)}catch(i){a=i}try{r.remask(),r.setMirror(!0),r.readVersion(),r.readFormatInformation(),r.mirror();const i=this.decodeBitMatrixParser(r,s);return i.setOther(new cs(!0)),i}catch(i){throw a!==null?a:i}}decodeBitMatrixParser(t,s){const r=t.readVersion(),a=t.readFormatInformation().getErrorCorrectionLevel(),i=t.readCodewords(),o=ms.getDataBlocks(i,r,a);let d=0;for(const y of o)d+=y.getNumDataCodewords();const h=new Uint8Array(d);let m=0;for(const y of o){const T=y.getCodewords(),z=y.getNumDataCodewords();this.correctErrors(T,z);for(let Y=0;Y<z;Y++)h[m++]=T[Y]}return xt.decode(h,r,a,s)}correctErrors(t,s){const r=new Int32Array(t);try{this.rsDecoder.decode(r,t.length-s)}catch{throw new B}for(let a=0;a<s;a++)t[a]=r[a]}}class Os extends Ye{constructor(t,s,r){super(t,s),this.estimatedModuleSize=r}aboutEquals(t,s,r){if(Math.abs(s-this.getY())<=t&&Math.abs(r-this.getX())<=t){const a=Math.abs(t-this.estimatedModuleSize);return a<=1||a<=this.estimatedModuleSize}return!1}combineEstimate(t,s,r){const a=(this.getX()+s)/2,i=(this.getY()+t)/2,o=(this.estimatedModuleSize+r)/2;return new Os(a,i,o)}}class Xs{constructor(t,s,r,a,i,o,d){this.image=t,this.startX=s,this.startY=r,this.width=a,this.height=i,this.moduleSize=o,this.resultPointCallback=d,this.possibleCenters=[],this.crossCheckStateCount=new Int32Array(3)}find(){const t=this.startX,s=this.height,r=this.width,a=t+r,i=this.startY+s/2,o=new Int32Array(3),d=this.image;for(let h=0;h<s;h++){const m=i+(h&1?-Math.floor((h+1)/2):Math.floor((h+1)/2));o[0]=0,o[1]=0,o[2]=0;let y=t;for(;y<a&&!d.get(y,m);)y++;let T=0;for(;y<a;){if(d.get(y,m))if(T===1)o[1]++;else if(T===2){if(this.foundPatternCross(o)){const z=this.handlePossibleCenter(o,m,y);if(z!==null)return z}o[0]=o[2],o[1]=1,o[2]=0,T=1}else o[++T]++;else T===1&&T++,o[T]++;y++}if(this.foundPatternCross(o)){const z=this.handlePossibleCenter(o,m,a);if(z!==null)return z}}if(this.possibleCenters.length!==0)return this.possibleCenters[0];throw new $}static centerFromEnd(t,s){return s-t[2]-t[1]/2}foundPatternCross(t){const s=this.moduleSize,r=s/2;for(let a=0;a<3;a++)if(Math.abs(s-t[a])>=r)return!1;return!0}crossCheckVertical(t,s,r,a){const i=this.image,o=i.getHeight(),d=this.crossCheckStateCount;d[0]=0,d[1]=0,d[2]=0;let h=t;for(;h>=0&&i.get(s,h)&&d[1]<=r;)d[1]++,h--;if(h<0||d[1]>r)return NaN;for(;h>=0&&!i.get(s,h)&&d[0]<=r;)d[0]++,h--;if(d[0]>r)return NaN;for(h=t+1;h<o&&i.get(s,h)&&d[1]<=r;)d[1]++,h++;if(h===o||d[1]>r)return NaN;for(;h<o&&!i.get(s,h)&&d[2]<=r;)d[2]++,h++;if(d[2]>r)return NaN;const m=d[0]+d[1]+d[2];return 5*Math.abs(m-a)>=2*a?NaN:this.foundPatternCross(d)?Xs.centerFromEnd(d,h):NaN}handlePossibleCenter(t,s,r){const a=t[0]+t[1]+t[2],i=Xs.centerFromEnd(t,r),o=this.crossCheckVertical(s,i,2*t[1],a);if(!isNaN(o)){const d=(t[0]+t[1]+t[2])/3;for(const m of this.possibleCenters)if(m.aboutEquals(d,o,i))return m.combineEstimate(o,i,d);const h=new Os(i,o,d);this.possibleCenters.push(h),this.resultPointCallback!==null&&this.resultPointCallback!==void 0&&this.resultPointCallback.foundPossibleResultPoint(h)}return null}}class fr extends Ye{constructor(t,s,r,a){super(t,s),this.estimatedModuleSize=r,this.count=a,a===void 0&&(this.count=1)}getEstimatedModuleSize(){return this.estimatedModuleSize}getCount(){return this.count}aboutEquals(t,s,r){if(Math.abs(s-this.getY())<=t&&Math.abs(r-this.getX())<=t){const a=Math.abs(t-this.estimatedModuleSize);return a<=1||a<=this.estimatedModuleSize}return!1}combineEstimate(t,s,r){const a=this.count+1,i=(this.count*this.getX()+s)/a,o=(this.count*this.getY()+t)/a,d=(this.count*this.estimatedModuleSize+r)/a;return new fr(i,o,d,a)}}class vs{constructor(t){this.bottomLeft=t[0],this.topLeft=t[1],this.topRight=t[2]}getBottomLeft(){return this.bottomLeft}getTopLeft(){return this.topLeft}getTopRight(){return this.topRight}}class Lt{constructor(t,s){this.image=t,this.resultPointCallback=s,this.possibleCenters=[],this.crossCheckStateCount=new Int32Array(5),this.resultPointCallback=s}getImage(){return this.image}getPossibleCenters(){return this.possibleCenters}find(t){const s=t!=null&&t.get(N.TRY_HARDER)!==void 0,r=t!=null&&t.get(N.PURE_BARCODE)!==void 0,a=this.image,i=a.getHeight(),o=a.getWidth();let d=Math.floor(3*i/(4*Lt.MAX_MODULES));(d<Lt.MIN_SKIP||s)&&(d=Lt.MIN_SKIP);let h=!1;const m=new Int32Array(5);for(let T=d-1;T<i&&!h;T+=d){m[0]=0,m[1]=0,m[2]=0,m[3]=0,m[4]=0;let z=0;for(let Y=0;Y<o;Y++)if(a.get(Y,T))(z&1)===1&&z++,m[z]++;else if(z&1)m[z]++;else if(z===4)if(Lt.foundPatternCross(m)){if(this.handlePossibleCenter(m,T,Y,r)===!0)if(d=2,this.hasSkipped===!0)h=this.haveMultiplyConfirmedCenters();else{const ue=this.findRowSkip();ue>m[2]&&(T+=ue-m[2]-d,Y=o-1)}else{m[0]=m[2],m[1]=m[3],m[2]=m[4],m[3]=1,m[4]=0,z=3;continue}z=0,m[0]=0,m[1]=0,m[2]=0,m[3]=0,m[4]=0}else m[0]=m[2],m[1]=m[3],m[2]=m[4],m[3]=1,m[4]=0,z=3;else m[++z]++;Lt.foundPatternCross(m)&&this.handlePossibleCenter(m,T,o,r)===!0&&(d=m[0],this.hasSkipped&&(h=this.haveMultiplyConfirmedCenters()))}const y=this.selectBestPatterns();return Ye.orderBestPatterns(y),new vs(y)}static centerFromEnd(t,s){return s-t[4]-t[3]-t[2]/2}static foundPatternCross(t){let s=0;for(let i=0;i<5;i++){const o=t[i];if(o===0)return!1;s+=o}if(s<7)return!1;const r=s/7,a=r/2;return Math.abs(r-t[0])<a&&Math.abs(r-t[1])<a&&Math.abs(3*r-t[2])<3*a&&Math.abs(r-t[3])<a&&Math.abs(r-t[4])<a}getCrossCheckStateCount(){const t=this.crossCheckStateCount;return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t}crossCheckDiagonal(t,s,r,a){const i=this.getCrossCheckStateCount();let o=0;const d=this.image;for(;t>=o&&s>=o&&d.get(s-o,t-o);)i[2]++,o++;if(t<o||s<o)return!1;for(;t>=o&&s>=o&&!d.get(s-o,t-o)&&i[1]<=r;)i[1]++,o++;if(t<o||s<o||i[1]>r)return!1;for(;t>=o&&s>=o&&d.get(s-o,t-o)&&i[0]<=r;)i[0]++,o++;if(i[0]>r)return!1;const h=d.getHeight(),m=d.getWidth();for(o=1;t+o<h&&s+o<m&&d.get(s+o,t+o);)i[2]++,o++;if(t+o>=h||s+o>=m)return!1;for(;t+o<h&&s+o<m&&!d.get(s+o,t+o)&&i[3]<r;)i[3]++,o++;if(t+o>=h||s+o>=m||i[3]>=r)return!1;for(;t+o<h&&s+o<m&&d.get(s+o,t+o)&&i[4]<r;)i[4]++,o++;if(i[4]>=r)return!1;const y=i[0]+i[1]+i[2]+i[3]+i[4];return Math.abs(y-a)<2*a&&Lt.foundPatternCross(i)}crossCheckVertical(t,s,r,a){const i=this.image,o=i.getHeight(),d=this.getCrossCheckStateCount();let h=t;for(;h>=0&&i.get(s,h);)d[2]++,h--;if(h<0)return NaN;for(;h>=0&&!i.get(s,h)&&d[1]<=r;)d[1]++,h--;if(h<0||d[1]>r)return NaN;for(;h>=0&&i.get(s,h)&&d[0]<=r;)d[0]++,h--;if(d[0]>r)return NaN;for(h=t+1;h<o&&i.get(s,h);)d[2]++,h++;if(h===o)return NaN;for(;h<o&&!i.get(s,h)&&d[3]<r;)d[3]++,h++;if(h===o||d[3]>=r)return NaN;for(;h<o&&i.get(s,h)&&d[4]<r;)d[4]++,h++;if(d[4]>=r)return NaN;const m=d[0]+d[1]+d[2]+d[3]+d[4];return 5*Math.abs(m-a)>=2*a?NaN:Lt.foundPatternCross(d)?Lt.centerFromEnd(d,h):NaN}crossCheckHorizontal(t,s,r,a){const i=this.image,o=i.getWidth(),d=this.getCrossCheckStateCount();let h=t;for(;h>=0&&i.get(h,s);)d[2]++,h--;if(h<0)return NaN;for(;h>=0&&!i.get(h,s)&&d[1]<=r;)d[1]++,h--;if(h<0||d[1]>r)return NaN;for(;h>=0&&i.get(h,s)&&d[0]<=r;)d[0]++,h--;if(d[0]>r)return NaN;for(h=t+1;h<o&&i.get(h,s);)d[2]++,h++;if(h===o)return NaN;for(;h<o&&!i.get(h,s)&&d[3]<r;)d[3]++,h++;if(h===o||d[3]>=r)return NaN;for(;h<o&&i.get(h,s)&&d[4]<r;)d[4]++,h++;if(d[4]>=r)return NaN;const m=d[0]+d[1]+d[2]+d[3]+d[4];return 5*Math.abs(m-a)>=a?NaN:Lt.foundPatternCross(d)?Lt.centerFromEnd(d,h):NaN}handlePossibleCenter(t,s,r,a){const i=t[0]+t[1]+t[2]+t[3]+t[4];let o=Lt.centerFromEnd(t,r),d=this.crossCheckVertical(s,Math.floor(o),t[2],i);if(!isNaN(d)&&(o=this.crossCheckHorizontal(Math.floor(o),Math.floor(d),t[2],i),!isNaN(o)&&(!a||this.crossCheckDiagonal(Math.floor(d),Math.floor(o),t[2],i)))){const h=i/7;let m=!1;const y=this.possibleCenters;for(let T=0,z=y.length;T<z;T++){const Y=y[T];if(Y.aboutEquals(h,d,o)){y[T]=Y.combineEstimate(d,o,h),m=!0;break}}if(!m){const T=new fr(o,d,h);y.push(T),this.resultPointCallback!==null&&this.resultPointCallback!==void 0&&this.resultPointCallback.foundPossibleResultPoint(T)}return!0}return!1}findRowSkip(){if(this.possibleCenters.length<=1)return 0;let s=null;for(const r of this.possibleCenters)if(r.getCount()>=Lt.CENTER_QUORUM)if(s==null)s=r;else return this.hasSkipped=!0,Math.floor((Math.abs(s.getX()-r.getX())-Math.abs(s.getY()-r.getY()))/2);return 0}haveMultiplyConfirmedCenters(){let t=0,s=0;const r=this.possibleCenters.length;for(const o of this.possibleCenters)o.getCount()>=Lt.CENTER_QUORUM&&(t++,s+=o.getEstimatedModuleSize());if(t<3)return!1;const a=s/r;let i=0;for(const o of this.possibleCenters)i+=Math.abs(o.getEstimatedModuleSize()-a);return i<=.05*s}selectBestPatterns(){const t=this.possibleCenters.length;if(t<3)throw new $;const s=this.possibleCenters;let r;if(t>3){let a=0,i=0;for(const h of this.possibleCenters){const m=h.getEstimatedModuleSize();a+=m,i+=m*m}r=a/t;let o=Math.sqrt(i/t-r*r);s.sort((h,m)=>{const y=Math.abs(m.getEstimatedModuleSize()-r),T=Math.abs(h.getEstimatedModuleSize()-r);return y<T?-1:y>T?1:0});const d=Math.max(.2*r,o);for(let h=0;h<s.length&&s.length>3;h++){const m=s[h];Math.abs(m.getEstimatedModuleSize()-r)>d&&(s.splice(h,1),h--)}}if(s.length>3){let a=0;for(const i of s)a+=i.getEstimatedModuleSize();r=a/s.length,s.sort((i,o)=>{if(o.getCount()===i.getCount()){const d=Math.abs(o.getEstimatedModuleSize()-r),h=Math.abs(i.getEstimatedModuleSize()-r);return d<h?1:d>h?-1:0}else return o.getCount()-i.getCount()}),s.splice(3)}return[s[0],s[1],s[2]]}}Lt.CENTER_QUORUM=2,Lt.MIN_SKIP=3,Lt.MAX_MODULES=57;class sr{constructor(t){this.image=t}getImage(){return this.image}getResultPointCallback(){return this.resultPointCallback}detect(t){this.resultPointCallback=t==null?null:t.get(N.NEED_RESULT_POINT_CALLBACK);const r=new Lt(this.image,this.resultPointCallback).find(t);return this.processFinderPatternInfo(r)}processFinderPatternInfo(t){const s=t.getTopLeft(),r=t.getTopRight(),a=t.getBottomLeft(),i=this.calculateModuleSize(s,r,a);if(i<1)throw new $("No pattern found in proccess finder.");const o=sr.computeDimension(s,r,a,i),d=He.getProvisionalVersionForDimension(o),h=d.getDimensionForVersion()-7;let m=null;if(d.getAlignmentPatternCenters().length>0){const Y=r.getX()-s.getX()+a.getX(),ce=r.getY()-s.getY()+a.getY(),ue=1-3/h,Se=Math.floor(s.getX()+ue*(Y-s.getX())),ze=Math.floor(s.getY()+ue*(ce-s.getY()));for(let We=4;We<=16;We<<=1)try{m=this.findAlignmentInRegion(i,Se,ze,We);break}catch($e){if(!($e instanceof $))throw $e}}const y=sr.createTransform(s,r,a,m,o),T=sr.sampleGrid(this.image,y,o);let z;return m===null?z=[a,s,r]:z=[a,s,r,m],new Te(T,z)}static createTransform(t,s,r,a,i){const o=i-3.5;let d,h,m,y;return a!==null?(d=a.getX(),h=a.getY(),m=o-3,y=m):(d=s.getX()-t.getX()+r.getX(),h=s.getY()-t.getY()+r.getY(),m=o,y=o),Ie.quadrilateralToQuadrilateral(3.5,3.5,o,3.5,m,y,3.5,o,t.getX(),t.getY(),s.getX(),s.getY(),d,h,r.getX(),r.getY())}static sampleGrid(t,s,r){return ee.getInstance().sampleGridWithTransform(t,r,r,s)}static computeDimension(t,s,r,a){const i=Ge.round(Ye.distance(t,s)/a),o=Ge.round(Ye.distance(t,r)/a);let d=Math.floor((i+o)/2)+7;switch(d&3){case 0:d++;break;case 2:d--;break;case 3:throw new $("Dimensions could be not found.")}return d}calculateModuleSize(t,s,r){return(this.calculateModuleSizeOneWay(t,s)+this.calculateModuleSizeOneWay(t,r))/2}calculateModuleSizeOneWay(t,s){const r=this.sizeOfBlackWhiteBlackRunBothWays(Math.floor(t.getX()),Math.floor(t.getY()),Math.floor(s.getX()),Math.floor(s.getY())),a=this.sizeOfBlackWhiteBlackRunBothWays(Math.floor(s.getX()),Math.floor(s.getY()),Math.floor(t.getX()),Math.floor(t.getY()));return isNaN(r)?a/7:isNaN(a)?r/7:(r+a)/14}sizeOfBlackWhiteBlackRunBothWays(t,s,r,a){let i=this.sizeOfBlackWhiteBlackRun(t,s,r,a),o=1,d=t-(r-t);d<0?(o=t/(t-d),d=0):d>=this.image.getWidth()&&(o=(this.image.getWidth()-1-t)/(d-t),d=this.image.getWidth()-1);let h=Math.floor(s-(a-s)*o);return o=1,h<0?(o=s/(s-h),h=0):h>=this.image.getHeight()&&(o=(this.image.getHeight()-1-s)/(h-s),h=this.image.getHeight()-1),d=Math.floor(t+(d-t)*o),i+=this.sizeOfBlackWhiteBlackRun(t,s,d,h),i-1}sizeOfBlackWhiteBlackRun(t,s,r,a){const i=Math.abs(a-s)>Math.abs(r-t);if(i){let Y=t;t=s,s=Y,Y=r,r=a,a=Y}const o=Math.abs(r-t),d=Math.abs(a-s);let h=-o/2;const m=t<r?1:-1,y=s<a?1:-1;let T=0;const z=r+m;for(let Y=t,ce=s;Y!==z;Y+=m){const ue=i?ce:Y,Se=i?Y:ce;if(T===1===this.image.get(ue,Se)){if(T===2)return Ge.distance(Y,ce,t,s);T++}if(h+=d,h>0){if(ce===a)break;ce+=y,h-=o}}return T===2?Ge.distance(r+m,a,t,s):NaN}findAlignmentInRegion(t,s,r,a){const i=Math.floor(a*t),o=Math.max(0,s-i),d=Math.min(this.image.getWidth()-1,s+i);if(d-o<t*3)throw new $("Alignment top exceeds estimated module size.");const h=Math.max(0,r-i),m=Math.min(this.image.getHeight()-1,r+i);if(m-h<t*3)throw new $("Alignment bottom exceeds estimated module size.");return new Xs(this.image,o,h,d-o,m-h,t,this.resultPointCallback).find()}}class ss{constructor(){this.decoder=new zs}getDecoder(){return this.decoder}decode(t,s){let r,a;if(s!=null&&s.get(N.PURE_BARCODE)!==void 0){const h=ss.extractPureBits(t.getBlackMatrix());r=this.decoder.decodeBitMatrix(h,s),a=ss.NO_POINTS}else{const h=new sr(t.getBlackMatrix()).detect(s);r=this.decoder.decodeBitMatrix(h.getBits(),s),a=h.getPoints()}r.getOther()instanceof cs&&r.getOther().applyMirroredCorrection(a);const i=new V(r.getText(),r.getRawBytes(),void 0,a,ae.QR_CODE,void 0),o=r.getByteSegments();o!==null&&i.putMetadata(be.BYTE_SEGMENTS,o);const d=r.getECLevel();return d!==null&&i.putMetadata(be.ERROR_CORRECTION_LEVEL,d),r.hasStructuredAppend()&&(i.putMetadata(be.STRUCTURED_APPEND_SEQUENCE,r.getStructuredAppendSequenceNumber()),i.putMetadata(be.STRUCTURED_APPEND_PARITY,r.getStructuredAppendParity())),i}reset(){}static extractPureBits(t){const s=t.getTopLeftOnBit(),r=t.getBottomRightOnBit();if(s===null||r===null)throw new $;const a=this.moduleSize(s,t);let i=s[1],o=r[1],d=s[0],h=r[0];if(d>=h||i>=o)throw new $;if(o-i!==h-d&&(h=d+(o-i),h>=t.getWidth()))throw new $;const m=Math.round((h-d+1)/a),y=Math.round((o-i+1)/a);if(m<=0||y<=0)throw new $;if(y!==m)throw new $;const T=Math.floor(a/2);i+=T,d+=T;const z=d+Math.floor((m-1)*a)-h;if(z>0){if(z>T)throw new $;d-=z}const Y=i+Math.floor((y-1)*a)-o;if(Y>0){if(Y>T)throw new $;i-=Y}const ce=new G(m,y);for(let ue=0;ue<y;ue++){const Se=i+Math.floor(ue*a);for(let ze=0;ze<m;ze++)t.get(d+Math.floor(ze*a),Se)&&ce.set(ze,ue)}return ce}static moduleSize(t,s){const r=s.getHeight(),a=s.getWidth();let i=t[0],o=t[1],d=!0,h=0;for(;i<a&&o<r;){if(d!==s.get(i,o)){if(++h===5)break;d=!d}i++,o++}if(i===a||o===r)throw new $;return(i-t[0])/7}}ss.NO_POINTS=new Array;class lt{PDF417Common(){}static getBitCountSum(t){return Ge.sum(t)}static toIntArray(t){if(t==null||!t.length)return lt.EMPTY_INT_ARRAY;const s=new Int32Array(t.length);let r=0;for(const a of t)s[r++]=a;return s}static getCodeword(t){const s=E.binarySearch(lt.SYMBOL_TABLE,t&262143);return s<0?-1:(lt.CODEWORD_TABLE[s]-1)%lt.NUMBER_OF_CODEWORDS}}lt.NUMBER_OF_CODEWORDS=929,lt.MAX_CODEWORDS_IN_BARCODE=lt.NUMBER_OF_CODEWORDS-1,lt.MIN_ROWS_IN_BARCODE=3,lt.MAX_ROWS_IN_BARCODE=90,lt.MODULES_IN_CODEWORD=17,lt.MODULES_IN_STOP_PATTERN=18,lt.BARS_IN_MODULE=8,lt.EMPTY_INT_ARRAY=new Int32Array([]),lt.SYMBOL_TABLE=Int32Array.from([66142,66170,66206,66236,66290,66292,66350,66382,66396,66454,66470,66476,66594,66600,66614,66626,66628,66632,66640,66654,66662,66668,66682,66690,66718,66720,66748,66758,66776,66798,66802,66804,66820,66824,66832,66846,66848,66876,66880,66936,66950,66956,66968,66992,67006,67022,67036,67042,67044,67048,67062,67118,67150,67164,67214,67228,67256,67294,67322,67350,67366,67372,67398,67404,67416,67438,67474,67476,67490,67492,67496,67510,67618,67624,67650,67656,67664,67678,67686,67692,67706,67714,67716,67728,67742,67744,67772,67782,67788,67800,67822,67826,67828,67842,67848,67870,67872,67900,67904,67960,67974,67992,68016,68030,68046,68060,68066,68068,68072,68086,68104,68112,68126,68128,68156,68160,68216,68336,68358,68364,68376,68400,68414,68448,68476,68494,68508,68536,68546,68548,68552,68560,68574,68582,68588,68654,68686,68700,68706,68708,68712,68726,68750,68764,68792,68802,68804,68808,68816,68830,68838,68844,68858,68878,68892,68920,68976,68990,68994,68996,69e3,69008,69022,69024,69052,69062,69068,69080,69102,69106,69108,69142,69158,69164,69190,69208,69230,69254,69260,69272,69296,69310,69326,69340,69386,69394,69396,69410,69416,69430,69442,69444,69448,69456,69470,69478,69484,69554,69556,69666,69672,69698,69704,69712,69726,69754,69762,69764,69776,69790,69792,69820,69830,69836,69848,69870,69874,69876,69890,69918,69920,69948,69952,70008,70022,70040,70064,70078,70094,70108,70114,70116,70120,70134,70152,70174,70176,70264,70384,70412,70448,70462,70496,70524,70542,70556,70584,70594,70600,70608,70622,70630,70636,70664,70672,70686,70688,70716,70720,70776,70896,71136,71180,71192,71216,71230,71264,71292,71360,71416,71452,71480,71536,71550,71554,71556,71560,71568,71582,71584,71612,71622,71628,71640,71662,71726,71732,71758,71772,71778,71780,71784,71798,71822,71836,71864,71874,71880,71888,71902,71910,71916,71930,71950,71964,71992,72048,72062,72066,72068,72080,72094,72096,72124,72134,72140,72152,72174,72178,72180,72206,72220,72248,72304,72318,72416,72444,72456,72464,72478,72480,72508,72512,72568,72588,72600,72624,72638,72654,72668,72674,72676,72680,72694,72726,72742,72748,72774,72780,72792,72814,72838,72856,72880,72894,72910,72924,72930,72932,72936,72950,72966,72972,72984,73008,73022,73056,73084,73102,73116,73144,73156,73160,73168,73182,73190,73196,73210,73226,73234,73236,73250,73252,73256,73270,73282,73284,73296,73310,73318,73324,73346,73348,73352,73360,73374,73376,73404,73414,73420,73432,73454,73498,73518,73522,73524,73550,73564,73570,73572,73576,73590,73800,73822,73858,73860,73872,73886,73888,73916,73944,73970,73972,73992,74014,74016,74044,74048,74104,74118,74136,74160,74174,74210,74212,74216,74230,74244,74256,74270,74272,74360,74480,74502,74508,74544,74558,74592,74620,74638,74652,74680,74690,74696,74704,74726,74732,74782,74784,74812,74992,75232,75288,75326,75360,75388,75456,75512,75576,75632,75646,75650,75652,75664,75678,75680,75708,75718,75724,75736,75758,75808,75836,75840,75896,76016,76256,76736,76824,76848,76862,76896,76924,76992,77048,77296,77340,77368,77424,77438,77536,77564,77572,77576,77584,77600,77628,77632,77688,77702,77708,77720,77744,77758,77774,77788,77870,77902,77916,77922,77928,77966,77980,78008,78018,78024,78032,78046,78060,78074,78094,78136,78192,78206,78210,78212,78224,78238,78240,78268,78278,78284,78296,78322,78324,78350,78364,78448,78462,78560,78588,78600,78622,78624,78652,78656,78712,78726,78744,78768,78782,78798,78812,78818,78820,78824,78838,78862,78876,78904,78960,78974,79072,79100,79296,79352,79368,79376,79390,79392,79420,79424,79480,79600,79628,79640,79664,79678,79712,79740,79772,79800,79810,79812,79816,79824,79838,79846,79852,79894,79910,79916,79942,79948,79960,79982,79988,80006,80024,80048,80062,80078,80092,80098,80100,80104,80134,80140,80176,80190,80224,80252,80270,80284,80312,80328,80336,80350,80358,80364,80378,80390,80396,80408,80432,80446,80480,80508,80576,80632,80654,80668,80696,80752,80766,80776,80784,80798,80800,80828,80844,80856,80878,80882,80884,80914,80916,80930,80932,80936,80950,80962,80968,80976,80990,80998,81004,81026,81028,81040,81054,81056,81084,81094,81100,81112,81134,81154,81156,81160,81168,81182,81184,81212,81216,81272,81286,81292,81304,81328,81342,81358,81372,81380,81384,81398,81434,81454,81458,81460,81486,81500,81506,81508,81512,81526,81550,81564,81592,81602,81604,81608,81616,81630,81638,81644,81702,81708,81722,81734,81740,81752,81774,81778,81780,82050,82078,82080,82108,82180,82184,82192,82206,82208,82236,82240,82296,82316,82328,82352,82366,82402,82404,82408,82440,82448,82462,82464,82492,82496,82552,82672,82694,82700,82712,82736,82750,82784,82812,82830,82882,82884,82888,82896,82918,82924,82952,82960,82974,82976,83004,83008,83064,83184,83424,83468,83480,83504,83518,83552,83580,83648,83704,83740,83768,83824,83838,83842,83844,83848,83856,83872,83900,83910,83916,83928,83950,83984,84e3,84028,84032,84088,84208,84448,84928,85040,85054,85088,85116,85184,85240,85488,85560,85616,85630,85728,85756,85764,85768,85776,85790,85792,85820,85824,85880,85894,85900,85912,85936,85966,85980,86048,86080,86136,86256,86496,86976,88160,88188,88256,88312,88560,89056,89200,89214,89312,89340,89536,89592,89608,89616,89632,89664,89720,89840,89868,89880,89904,89952,89980,89998,90012,90040,90190,90204,90254,90268,90296,90306,90308,90312,90334,90382,90396,90424,90480,90494,90500,90504,90512,90526,90528,90556,90566,90572,90584,90610,90612,90638,90652,90680,90736,90750,90848,90876,90884,90888,90896,90910,90912,90940,90944,91e3,91014,91020,91032,91056,91070,91086,91100,91106,91108,91112,91126,91150,91164,91192,91248,91262,91360,91388,91584,91640,91664,91678,91680,91708,91712,91768,91888,91928,91952,91966,92e3,92028,92046,92060,92088,92098,92100,92104,92112,92126,92134,92140,92188,92216,92272,92384,92412,92608,92664,93168,93200,93214,93216,93244,93248,93304,93424,93664,93720,93744,93758,93792,93820,93888,93944,93980,94008,94064,94078,94084,94088,94096,94110,94112,94140,94150,94156,94168,94246,94252,94278,94284,94296,94318,94342,94348,94360,94384,94398,94414,94428,94440,94470,94476,94488,94512,94526,94560,94588,94606,94620,94648,94658,94660,94664,94672,94686,94694,94700,94714,94726,94732,94744,94768,94782,94816,94844,94912,94968,94990,95004,95032,95088,95102,95112,95120,95134,95136,95164,95180,95192,95214,95218,95220,95244,95256,95280,95294,95328,95356,95424,95480,95728,95758,95772,95800,95856,95870,95968,95996,96008,96016,96030,96032,96060,96064,96120,96152,96176,96190,96220,96226,96228,96232,96290,96292,96296,96310,96322,96324,96328,96336,96350,96358,96364,96386,96388,96392,96400,96414,96416,96444,96454,96460,96472,96494,96498,96500,96514,96516,96520,96528,96542,96544,96572,96576,96632,96646,96652,96664,96688,96702,96718,96732,96738,96740,96744,96758,96772,96776,96784,96798,96800,96828,96832,96888,97008,97030,97036,97048,97072,97086,97120,97148,97166,97180,97208,97220,97224,97232,97246,97254,97260,97326,97330,97332,97358,97372,97378,97380,97384,97398,97422,97436,97464,97474,97476,97480,97488,97502,97510,97516,97550,97564,97592,97648,97666,97668,97672,97680,97694,97696,97724,97734,97740,97752,97774,97830,97836,97850,97862,97868,97880,97902,97906,97908,97926,97932,97944,97968,97998,98012,98018,98020,98024,98038,98618,98674,98676,98838,98854,98874,98892,98904,98926,98930,98932,98968,99006,99042,99044,99048,99062,99166,99194,99246,99286,99350,99366,99372,99386,99398,99416,99438,99442,99444,99462,99504,99518,99534,99548,99554,99556,99560,99574,99590,99596,99608,99632,99646,99680,99708,99726,99740,99768,99778,99780,99784,99792,99806,99814,99820,99834,99858,99860,99874,99880,99894,99906,99920,99934,99962,99970,99972,99976,99984,99998,1e5,100028,100038,100044,100056,100078,100082,100084,100142,100174,100188,100246,100262,100268,100306,100308,100390,100396,100410,100422,100428,100440,100462,100466,100468,100486,100504,100528,100542,100558,100572,100578,100580,100584,100598,100620,100656,100670,100704,100732,100750,100792,100802,100808,100816,100830,100838,100844,100858,100888,100912,100926,100960,100988,101056,101112,101148,101176,101232,101246,101250,101252,101256,101264,101278,101280,101308,101318,101324,101336,101358,101362,101364,101410,101412,101416,101430,101442,101448,101456,101470,101478,101498,101506,101508,101520,101534,101536,101564,101580,101618,101620,101636,101640,101648,101662,101664,101692,101696,101752,101766,101784,101838,101858,101860,101864,101934,101938,101940,101966,101980,101986,101988,101992,102030,102044,102072,102082,102084,102088,102096,102138,102166,102182,102188,102214,102220,102232,102254,102282,102290,102292,102306,102308,102312,102326,102444,102458,102470,102476,102488,102514,102516,102534,102552,102576,102590,102606,102620,102626,102632,102646,102662,102668,102704,102718,102752,102780,102798,102812,102840,102850,102856,102864,102878,102886,102892,102906,102936,102974,103008,103036,103104,103160,103224,103280,103294,103298,103300,103312,103326,103328,103356,103366,103372,103384,103406,103410,103412,103472,103486,103520,103548,103616,103672,103920,103992,104048,104062,104160,104188,104194,104196,104200,104208,104224,104252,104256,104312,104326,104332,104344,104368,104382,104398,104412,104418,104420,104424,104482,104484,104514,104520,104528,104542,104550,104570,104578,104580,104592,104606,104608,104636,104652,104690,104692,104706,104712,104734,104736,104764,104768,104824,104838,104856,104910,104930,104932,104936,104968,104976,104990,104992,105020,105024,105080,105200,105240,105278,105312,105372,105410,105412,105416,105424,105446,105518,105524,105550,105564,105570,105572,105576,105614,105628,105656,105666,105672,105680,105702,105722,105742,105756,105784,105840,105854,105858,105860,105864,105872,105888,105932,105970,105972,106006,106022,106028,106054,106060,106072,106100,106118,106124,106136,106160,106174,106190,106210,106212,106216,106250,106258,106260,106274,106276,106280,106306,106308,106312,106320,106334,106348,106394,106414,106418,106420,106566,106572,106610,106612,106630,106636,106648,106672,106686,106722,106724,106728,106742,106758,106764,106776,106800,106814,106848,106876,106894,106908,106936,106946,106948,106952,106960,106974,106982,106988,107032,107056,107070,107104,107132,107200,107256,107292,107320,107376,107390,107394,107396,107400,107408,107422,107424,107452,107462,107468,107480,107502,107506,107508,107544,107568,107582,107616,107644,107712,107768,108016,108060,108088,108144,108158,108256,108284,108290,108292,108296,108304,108318,108320,108348,108352,108408,108422,108428,108440,108464,108478,108494,108508,108514,108516,108520,108592,108640,108668,108736,108792,109040,109536,109680,109694,109792,109820,110016,110072,110084,110088,110096,110112,110140,110144,110200,110320,110342,110348,110360,110384,110398,110432,110460,110478,110492,110520,110532,110536,110544,110558,110658,110686,110714,110722,110724,110728,110736,110750,110752,110780,110796,110834,110836,110850,110852,110856,110864,110878,110880,110908,110912,110968,110982,111e3,111054,111074,111076,111080,111108,111112,111120,111134,111136,111164,111168,111224,111344,111372,111422,111456,111516,111554,111556,111560,111568,111590,111632,111646,111648,111676,111680,111736,111856,112096,112152,112224,112252,112320,112440,112514,112516,112520,112528,112542,112544,112588,112686,112718,112732,112782,112796,112824,112834,112836,112840,112848,112870,112890,112910,112924,112952,113008,113022,113026,113028,113032,113040,113054,113056,113100,113138,113140,113166,113180,113208,113264,113278,113376,113404,113416,113424,113440,113468,113472,113560,113614,113634,113636,113640,113686,113702,113708,113734,113740,113752,113778,113780,113798,113804,113816,113840,113854,113870,113890,113892,113896,113926,113932,113944,113968,113982,114016,114044,114076,114114,114116,114120,114128,114150,114170,114194,114196,114210,114212,114216,114242,114244,114248,114256,114270,114278,114306,114308,114312,114320,114334,114336,114364,114380,114420,114458,114478,114482,114484,114510,114524,114530,114532,114536,114842,114866,114868,114970,114994,114996,115042,115044,115048,115062,115130,115226,115250,115252,115278,115292,115298,115300,115304,115318,115342,115394,115396,115400,115408,115422,115430,115436,115450,115478,115494,115514,115526,115532,115570,115572,115738,115758,115762,115764,115790,115804,115810,115812,115816,115830,115854,115868,115896,115906,115912,115920,115934,115942,115948,115962,115996,116024,116080,116094,116098,116100,116104,116112,116126,116128,116156,116166,116172,116184,116206,116210,116212,116246,116262,116268,116282,116294,116300,116312,116334,116338,116340,116358,116364,116376,116400,116414,116430,116444,116450,116452,116456,116498,116500,116514,116520,116534,116546,116548,116552,116560,116574,116582,116588,116602,116654,116694,116714,116762,116782,116786,116788,116814,116828,116834,116836,116840,116854,116878,116892,116920,116930,116936,116944,116958,116966,116972,116986,117006,117048,117104,117118,117122,117124,117136,117150,117152,117180,117190,117196,117208,117230,117234,117236,117304,117360,117374,117472,117500,117506,117508,117512,117520,117536,117564,117568,117624,117638,117644,117656,117680,117694,117710,117724,117730,117732,117736,117750,117782,117798,117804,117818,117830,117848,117874,117876,117894,117936,117950,117966,117986,117988,117992,118022,118028,118040,118064,118078,118112,118140,118172,118210,118212,118216,118224,118238,118246,118266,118306,118312,118338,118352,118366,118374,118394,118402,118404,118408,118416,118430,118432,118460,118476,118514,118516,118574,118578,118580,118606,118620,118626,118628,118632,118678,118694,118700,118730,118738,118740,118830,118834,118836,118862,118876,118882,118884,118888,118902,118926,118940,118968,118978,118980,118984,118992,119006,119014,119020,119034,119068,119096,119152,119166,119170,119172,119176,119184,119198,119200,119228,119238,119244,119256,119278,119282,119284,119324,119352,119408,119422,119520,119548,119554,119556,119560,119568,119582,119584,119612,119616,119672,119686,119692,119704,119728,119742,119758,119772,119778,119780,119784,119798,119920,119934,120032,120060,120256,120312,120324,120328,120336,120352,120384,120440,120560,120582,120588,120600,120624,120638,120672,120700,120718,120732,120760,120770,120772,120776,120784,120798,120806,120812,120870,120876,120890,120902,120908,120920,120946,120948,120966,120972,120984,121008,121022,121038,121058,121060,121064,121078,121100,121112,121136,121150,121184,121212,121244,121282,121284,121288,121296,121318,121338,121356,121368,121392,121406,121440,121468,121536,121592,121656,121730,121732,121736,121744,121758,121760,121804,121842,121844,121890,121922,121924,121928,121936,121950,121958,121978,121986,121988,121992,122e3,122014,122016,122044,122060,122098,122100,122116,122120,122128,122142,122144,122172,122176,122232,122246,122264,122318,122338,122340,122344,122414,122418,122420,122446,122460,122466,122468,122472,122510,122524,122552,122562,122564,122568,122576,122598,122618,122646,122662,122668,122694,122700,122712,122738,122740,122762,122770,122772,122786,122788,122792,123018,123026,123028,123042,123044,123048,123062,123098,123146,123154,123156,123170,123172,123176,123190,123202,123204,123208,123216,123238,123244,123258,123290,123314,123316,123402,123410,123412,123426,123428,123432,123446,123458,123464,123472,123486,123494,123500,123514,123522,123524,123528,123536,123552,123580,123590,123596,123608,123630,123634,123636,123674,123698,123700,123740,123746,123748,123752,123834,123914,123922,123924,123938,123944,123958,123970,123976,123984,123998,124006,124012,124026,124034,124036,124048,124062,124064,124092,124102,124108,124120,124142,124146,124148,124162,124164,124168,124176,124190,124192,124220,124224,124280,124294,124300,124312,124336,124350,124366,124380,124386,124388,124392,124406,124442,124462,124466,124468,124494,124508,124514,124520,124558,124572,124600,124610,124612,124616,124624,124646,124666,124694,124710,124716,124730,124742,124748,124760,124786,124788,124818,124820,124834,124836,124840,124854,124946,124948,124962,124964,124968,124982,124994,124996,125e3,125008,125022,125030,125036,125050,125058,125060,125064,125072,125086,125088,125116,125126,125132,125144,125166,125170,125172,125186,125188,125192,125200,125216,125244,125248,125304,125318,125324,125336,125360,125374,125390,125404,125410,125412,125416,125430,125444,125448,125456,125472,125504,125560,125680,125702,125708,125720,125744,125758,125792,125820,125838,125852,125880,125890,125892,125896,125904,125918,125926,125932,125978,125998,126002,126004,126030,126044,126050,126052,126056,126094,126108,126136,126146,126148,126152,126160,126182,126202,126222,126236,126264,126320,126334,126338,126340,126344,126352,126366,126368,126412,126450,126452,126486,126502,126508,126522,126534,126540,126552,126574,126578,126580,126598,126604,126616,126640,126654,126670,126684,126690,126692,126696,126738,126754,126756,126760,126774,126786,126788,126792,126800,126814,126822,126828,126842,126894,126898,126900,126934,127126,127142,127148,127162,127178,127186,127188,127254,127270,127276,127290,127302,127308,127320,127342,127346,127348,127370,127378,127380,127394,127396,127400,127450,127510,127526,127532,127546,127558,127576,127598,127602,127604,127622,127628,127640,127664,127678,127694,127708,127714,127716,127720,127734,127754,127762,127764,127778,127784,127810,127812,127816,127824,127838,127846,127866,127898,127918,127922,127924,128022,128038,128044,128058,128070,128076,128088,128110,128114,128116,128134,128140,128152,128176,128190,128206,128220,128226,128228,128232,128246,128262,128268,128280,128304,128318,128352,128380,128398,128412,128440,128450,128452,128456,128464,128478,128486,128492,128506,128522,128530,128532,128546,128548,128552,128566,128578,128580,128584,128592,128606,128614,128634,128642,128644,128648,128656,128670,128672,128700,128716,128754,128756,128794,128814,128818,128820,128846,128860,128866,128868,128872,128886,128918,128934,128940,128954,128978,128980,129178,129198,129202,129204,129238,129258,129306,129326,129330,129332,129358,129372,129378,129380,129384,129398,129430,129446,129452,129466,129482,129490,129492,129562,129582,129586,129588,129614,129628,129634,129636,129640,129654,129678,129692,129720,129730,129732,129736,129744,129758,129766,129772,129814,129830,129836,129850,129862,129868,129880,129902,129906,129908,129930,129938,129940,129954,129956,129960,129974,130010]),lt.CODEWORD_TABLE=Int32Array.from([2627,1819,2622,2621,1813,1812,2729,2724,2723,2779,2774,2773,902,896,908,868,865,861,859,2511,873,871,1780,835,2493,825,2491,842,837,844,1764,1762,811,810,809,2483,807,2482,806,2480,815,814,813,812,2484,817,816,1745,1744,1742,1746,2655,2637,2635,2626,2625,2623,2628,1820,2752,2739,2737,2728,2727,2725,2730,2785,2783,2778,2777,2775,2780,787,781,747,739,736,2413,754,752,1719,692,689,681,2371,678,2369,700,697,694,703,1688,1686,642,638,2343,631,2341,627,2338,651,646,643,2345,654,652,1652,1650,1647,1654,601,599,2322,596,2321,594,2319,2317,611,610,608,606,2324,603,2323,615,614,612,1617,1616,1614,1612,616,1619,1618,2575,2538,2536,905,901,898,909,2509,2507,2504,870,867,864,860,2512,875,872,1781,2490,2489,2487,2485,1748,836,834,832,830,2494,827,2492,843,841,839,845,1765,1763,2701,2676,2674,2653,2648,2656,2634,2633,2631,2629,1821,2638,2636,2770,2763,2761,2750,2745,2753,2736,2735,2733,2731,1848,2740,2738,2786,2784,591,588,576,569,566,2296,1590,537,534,526,2276,522,2274,545,542,539,548,1572,1570,481,2245,466,2242,462,2239,492,485,482,2249,496,494,1534,1531,1528,1538,413,2196,406,2191,2188,425,419,2202,415,2199,432,430,427,1472,1467,1464,433,1476,1474,368,367,2160,365,2159,362,2157,2155,2152,378,377,375,2166,372,2165,369,2162,383,381,379,2168,1419,1418,1416,1414,385,1411,384,1423,1422,1420,1424,2461,802,2441,2439,790,786,783,794,2409,2406,2403,750,742,738,2414,756,753,1720,2367,2365,2362,2359,1663,693,691,684,2373,680,2370,702,699,696,704,1690,1687,2337,2336,2334,2332,1624,2329,1622,640,637,2344,634,2342,630,2340,650,648,645,2346,655,653,1653,1651,1649,1655,2612,2597,2595,2571,2568,2565,2576,2534,2529,2526,1787,2540,2537,907,904,900,910,2503,2502,2500,2498,1768,2495,1767,2510,2508,2506,869,866,863,2513,876,874,1782,2720,2713,2711,2697,2694,2691,2702,2672,2670,2664,1828,2678,2675,2647,2646,2644,2642,1823,2639,1822,2654,2652,2650,2657,2771,1855,2765,2762,1850,1849,2751,2749,2747,2754,353,2148,344,342,336,2142,332,2140,345,1375,1373,306,2130,299,2128,295,2125,319,314,311,2132,1354,1352,1349,1356,262,257,2101,253,2096,2093,274,273,267,2107,263,2104,280,278,275,1316,1311,1308,1320,1318,2052,202,2050,2044,2040,219,2063,212,2060,208,2055,224,221,2066,1260,1258,1252,231,1248,229,1266,1264,1261,1268,155,1998,153,1996,1994,1991,1988,165,164,2007,162,2006,159,2003,2e3,172,171,169,2012,166,2010,1186,1184,1182,1179,175,1176,173,1192,1191,1189,1187,176,1194,1193,2313,2307,2305,592,589,2294,2292,2289,578,572,568,2297,580,1591,2272,2267,2264,1547,538,536,529,2278,525,2275,547,544,541,1574,1571,2237,2235,2229,1493,2225,1489,478,2247,470,2244,465,2241,493,488,484,2250,498,495,1536,1533,1530,1539,2187,2186,2184,2182,1432,2179,1430,2176,1427,414,412,2197,409,2195,405,2193,2190,426,424,421,2203,418,2201,431,429,1473,1471,1469,1466,434,1477,1475,2478,2472,2470,2459,2457,2454,2462,803,2437,2432,2429,1726,2443,2440,792,789,785,2401,2399,2393,1702,2389,1699,2411,2408,2405,745,741,2415,758,755,1721,2358,2357,2355,2353,1661,2350,1660,2347,1657,2368,2366,2364,2361,1666,690,687,2374,683,2372,701,698,705,1691,1689,2619,2617,2610,2608,2605,2613,2593,2588,2585,1803,2599,2596,2563,2561,2555,1797,2551,1795,2573,2570,2567,2577,2525,2524,2522,2520,1786,2517,1785,2514,1783,2535,2533,2531,2528,1788,2541,2539,906,903,911,2721,1844,2715,2712,1838,1836,2699,2696,2693,2703,1827,1826,1824,2673,2671,2669,2666,1829,2679,2677,1858,1857,2772,1854,1853,1851,1856,2766,2764,143,1987,139,1986,135,133,131,1984,128,1983,125,1981,138,137,136,1985,1133,1132,1130,112,110,1974,107,1973,104,1971,1969,122,121,119,117,1977,114,1976,124,1115,1114,1112,1110,1117,1116,84,83,1953,81,1952,78,1950,1948,1945,94,93,91,1959,88,1958,85,1955,99,97,95,1961,1086,1085,1083,1081,1078,100,1090,1089,1087,1091,49,47,1917,44,1915,1913,1910,1907,59,1926,56,1925,53,1922,1919,66,64,1931,61,1929,1042,1040,1038,71,1035,70,1032,68,1048,1047,1045,1043,1050,1049,12,10,1869,1867,1864,1861,21,1880,19,1877,1874,1871,28,1888,25,1886,22,1883,982,980,977,974,32,30,991,989,987,984,34,995,994,992,2151,2150,2147,2146,2144,356,355,354,2149,2139,2138,2136,2134,1359,343,341,338,2143,335,2141,348,347,346,1376,1374,2124,2123,2121,2119,1326,2116,1324,310,308,305,2131,302,2129,298,2127,320,318,316,313,2133,322,321,1355,1353,1351,1357,2092,2091,2089,2087,1276,2084,1274,2081,1271,259,2102,256,2100,252,2098,2095,272,269,2108,266,2106,281,279,277,1317,1315,1313,1310,282,1321,1319,2039,2037,2035,2032,1203,2029,1200,1197,207,2053,205,2051,201,2049,2046,2043,220,218,2064,215,2062,211,2059,228,226,223,2069,1259,1257,1254,232,1251,230,1267,1265,1263,2316,2315,2312,2311,2309,2314,2304,2303,2301,2299,1593,2308,2306,590,2288,2287,2285,2283,1578,2280,1577,2295,2293,2291,579,577,574,571,2298,582,581,1592,2263,2262,2260,2258,1545,2255,1544,2252,1541,2273,2271,2269,2266,1550,535,532,2279,528,2277,546,543,549,1575,1573,2224,2222,2220,1486,2217,1485,2214,1482,1479,2238,2236,2234,2231,1496,2228,1492,480,477,2248,473,2246,469,2243,490,487,2251,497,1537,1535,1532,2477,2476,2474,2479,2469,2468,2466,2464,1730,2473,2471,2453,2452,2450,2448,1729,2445,1728,2460,2458,2456,2463,805,804,2428,2427,2425,2423,1725,2420,1724,2417,1722,2438,2436,2434,2431,1727,2444,2442,793,791,788,795,2388,2386,2384,1697,2381,1696,2378,1694,1692,2402,2400,2398,2395,1703,2392,1701,2412,2410,2407,751,748,744,2416,759,757,1807,2620,2618,1806,1805,2611,2609,2607,2614,1802,1801,1799,2594,2592,2590,2587,1804,2600,2598,1794,1793,1791,1789,2564,2562,2560,2557,1798,2554,1796,2574,2572,2569,2578,1847,1846,2722,1843,1842,1840,1845,2716,2714,1835,1834,1832,1830,1839,1837,2700,2698,2695,2704,1817,1811,1810,897,862,1777,829,826,838,1760,1758,808,2481,1741,1740,1738,1743,2624,1818,2726,2776,782,740,737,1715,686,679,695,1682,1680,639,628,2339,647,644,1645,1643,1640,1648,602,600,597,595,2320,593,2318,609,607,604,1611,1610,1608,1606,613,1615,1613,2328,926,924,892,886,899,857,850,2505,1778,824,823,821,819,2488,818,2486,833,831,828,840,1761,1759,2649,2632,2630,2746,2734,2732,2782,2781,570,567,1587,531,527,523,540,1566,1564,476,467,463,2240,486,483,1524,1521,1518,1529,411,403,2192,399,2189,423,416,1462,1457,1454,428,1468,1465,2210,366,363,2158,360,2156,357,2153,376,373,370,2163,1410,1409,1407,1405,382,1402,380,1417,1415,1412,1421,2175,2174,777,774,771,784,732,725,722,2404,743,1716,676,674,668,2363,665,2360,685,1684,1681,626,624,622,2335,620,2333,617,2330,641,635,649,1646,1644,1642,2566,928,925,2530,2527,894,891,888,2501,2499,2496,858,856,854,851,1779,2692,2668,2665,2645,2643,2640,2651,2768,2759,2757,2744,2743,2741,2748,352,1382,340,337,333,1371,1369,307,300,296,2126,315,312,1347,1342,1350,261,258,250,2097,246,2094,271,268,264,1306,1301,1298,276,1312,1309,2115,203,2048,195,2045,191,2041,213,209,2056,1246,1244,1238,225,1234,222,1256,1253,1249,1262,2080,2079,154,1997,150,1995,147,1992,1989,163,160,2004,156,2001,1175,1174,1172,1170,1167,170,1164,167,1185,1183,1180,1177,174,1190,1188,2025,2024,2022,587,586,564,559,556,2290,573,1588,520,518,512,2268,508,2265,530,1568,1565,461,457,2233,450,2230,446,2226,479,471,489,1526,1523,1520,397,395,2185,392,2183,389,2180,2177,410,2194,402,422,1463,1461,1459,1456,1470,2455,799,2433,2430,779,776,773,2397,2394,2390,734,728,724,746,1717,2356,2354,2351,2348,1658,677,675,673,670,667,688,1685,1683,2606,2589,2586,2559,2556,2552,927,2523,2521,2518,2515,1784,2532,895,893,890,2718,2709,2707,2689,2687,2684,2663,2662,2660,2658,1825,2667,2769,1852,2760,2758,142,141,1139,1138,134,132,129,126,1982,1129,1128,1126,1131,113,111,108,105,1972,101,1970,120,118,115,1109,1108,1106,1104,123,1113,1111,82,79,1951,75,1949,72,1946,92,89,86,1956,1077,1076,1074,1072,98,1069,96,1084,1082,1079,1088,1968,1967,48,45,1916,42,1914,39,1911,1908,60,57,54,1923,50,1920,1031,1030,1028,1026,67,1023,65,1020,62,1041,1039,1036,1033,69,1046,1044,1944,1943,1941,11,9,1868,7,1865,1862,1859,20,1878,16,1875,13,1872,970,968,966,963,29,960,26,23,983,981,978,975,33,971,31,990,988,985,1906,1904,1902,993,351,2145,1383,331,330,328,326,2137,323,2135,339,1372,1370,294,293,291,289,2122,286,2120,283,2117,309,303,317,1348,1346,1344,245,244,242,2090,239,2088,236,2085,2082,260,2099,249,270,1307,1305,1303,1300,1314,189,2038,186,2036,183,2033,2030,2026,206,198,2047,194,216,1247,1245,1243,1240,227,1237,1255,2310,2302,2300,2286,2284,2281,565,563,561,558,575,1589,2261,2259,2256,2253,1542,521,519,517,514,2270,511,533,1569,1567,2223,2221,2218,2215,1483,2211,1480,459,456,453,2232,449,474,491,1527,1525,1522,2475,2467,2465,2451,2449,2446,801,800,2426,2424,2421,2418,1723,2435,780,778,775,2387,2385,2382,2379,1695,2375,1693,2396,735,733,730,727,749,1718,2616,2615,2604,2603,2601,2584,2583,2581,2579,1800,2591,2550,2549,2547,2545,1792,2542,1790,2558,929,2719,1841,2710,2708,1833,1831,2690,2688,2686,1815,1809,1808,1774,1756,1754,1737,1736,1734,1739,1816,1711,1676,1674,633,629,1638,1636,1633,1641,598,1605,1604,1602,1600,605,1609,1607,2327,887,853,1775,822,820,1757,1755,1584,524,1560,1558,468,464,1514,1511,1508,1519,408,404,400,1452,1447,1444,417,1458,1455,2208,364,361,358,2154,1401,1400,1398,1396,374,1393,371,1408,1406,1403,1413,2173,2172,772,726,723,1712,672,669,666,682,1678,1675,625,623,621,618,2331,636,632,1639,1637,1635,920,918,884,880,889,849,848,847,846,2497,855,852,1776,2641,2742,2787,1380,334,1367,1365,301,297,1340,1338,1335,1343,255,251,247,1296,1291,1288,265,1302,1299,2113,204,196,192,2042,1232,1230,1224,214,1220,210,1242,1239,1235,1250,2077,2075,151,148,1993,144,1990,1163,1162,1160,1158,1155,161,1152,157,1173,1171,1168,1165,168,1181,1178,2021,2020,2018,2023,585,560,557,1585,516,509,1562,1559,458,447,2227,472,1516,1513,1510,398,396,393,390,2181,386,2178,407,1453,1451,1449,1446,420,1460,2209,769,764,720,712,2391,729,1713,664,663,661,659,2352,656,2349,671,1679,1677,2553,922,919,2519,2516,885,883,881,2685,2661,2659,2767,2756,2755,140,1137,1136,130,127,1125,1124,1122,1127,109,106,102,1103,1102,1100,1098,116,1107,1105,1980,80,76,73,1947,1068,1067,1065,1063,90,1060,87,1075,1073,1070,1080,1966,1965,46,43,40,1912,36,1909,1019,1018,1016,1014,58,1011,55,1008,51,1029,1027,1024,1021,63,1037,1034,1940,1939,1937,1942,8,1866,4,1863,1,1860,956,954,952,949,946,17,14,969,967,964,961,27,957,24,979,976,972,1901,1900,1898,1896,986,1905,1903,350,349,1381,329,327,324,1368,1366,292,290,287,284,2118,304,1341,1339,1337,1345,243,240,237,2086,233,2083,254,1297,1295,1293,1290,1304,2114,190,187,184,2034,180,2031,177,2027,199,1233,1231,1229,1226,217,1223,1241,2078,2076,584,555,554,552,550,2282,562,1586,507,506,504,502,2257,499,2254,515,1563,1561,445,443,441,2219,438,2216,435,2212,460,454,475,1517,1515,1512,2447,798,797,2422,2419,770,768,766,2383,2380,2376,721,719,717,714,731,1714,2602,2582,2580,2548,2546,2543,923,921,2717,2706,2705,2683,2682,2680,1771,1752,1750,1733,1732,1731,1735,1814,1707,1670,1668,1631,1629,1626,1634,1599,1598,1596,1594,1603,1601,2326,1772,1753,1751,1581,1554,1552,1504,1501,1498,1509,1442,1437,1434,401,1448,1445,2206,1392,1391,1389,1387,1384,359,1399,1397,1394,1404,2171,2170,1708,1672,1669,619,1632,1630,1628,1773,1378,1363,1361,1333,1328,1336,1286,1281,1278,248,1292,1289,2111,1218,1216,1210,197,1206,193,1228,1225,1221,1236,2073,2071,1151,1150,1148,1146,152,1143,149,1140,145,1161,1159,1156,1153,158,1169,1166,2017,2016,2014,2019,1582,510,1556,1553,452,448,1506,1500,394,391,387,1443,1441,1439,1436,1450,2207,765,716,713,1709,662,660,657,1673,1671,916,914,879,878,877,882,1135,1134,1121,1120,1118,1123,1097,1096,1094,1092,103,1101,1099,1979,1059,1058,1056,1054,77,1051,74,1066,1064,1061,1071,1964,1963,1007,1006,1004,1002,999,41,996,37,1017,1015,1012,1009,52,1025,1022,1936,1935,1933,1938,942,940,938,935,932,5,2,955,953,950,947,18,943,15,965,962,958,1895,1894,1892,1890,973,1899,1897,1379,325,1364,1362,288,285,1334,1332,1330,241,238,234,1287,1285,1283,1280,1294,2112,188,185,181,178,2028,1219,1217,1215,1212,200,1209,1227,2074,2072,583,553,551,1583,505,503,500,513,1557,1555,444,442,439,436,2213,455,451,1507,1505,1502,796,763,762,760,767,711,710,708,706,2377,718,715,1710,2544,917,915,2681,1627,1597,1595,2325,1769,1749,1747,1499,1438,1435,2204,1390,1388,1385,1395,2169,2167,1704,1665,1662,1625,1623,1620,1770,1329,1282,1279,2109,1214,1207,1222,2068,2065,1149,1147,1144,1141,146,1157,1154,2013,2011,2008,2015,1579,1549,1546,1495,1487,1433,1431,1428,1425,388,1440,2205,1705,658,1667,1664,1119,1095,1093,1978,1057,1055,1052,1062,1962,1960,1005,1003,1e3,997,38,1013,1010,1932,1930,1927,1934,941,939,936,933,6,930,3,951,948,944,1889,1887,1884,1881,959,1893,1891,35,1377,1360,1358,1327,1325,1322,1331,1277,1275,1272,1269,235,1284,2110,1205,1204,1201,1198,182,1195,179,1213,2070,2067,1580,501,1551,1548,440,437,1497,1494,1490,1503,761,709,707,1706,913,912,2198,1386,2164,2161,1621,1766,2103,1208,2058,2054,1145,1142,2005,2002,1999,2009,1488,1429,1426,2200,1698,1659,1656,1975,1053,1957,1954,1001,998,1924,1921,1918,1928,937,934,931,1879,1876,1873,1870,945,1885,1882,1323,1273,1270,2105,1202,1199,1196,1211,2061,2057,1576,1543,1540,1484,1481,1478,1491,1700]);class Hi{constructor(t,s){this.bits=t,this.points=s}getBits(){return this.bits}getPoints(){return this.points}}class gt{static detectMultiple(t,s,r){let a=t.getBlackMatrix(),i=gt.detect(r,a);return i.length||(a=a.clone(),a.rotate180(),i=gt.detect(r,a)),new Hi(a,i)}static detect(t,s){const r=new Array;let a=0,i=0,o=!1;for(;a<s.getHeight();){const d=gt.findVertices(s,a,i);if(d[0]==null&&d[3]==null){if(!o)break;o=!1,i=0;for(const h of r)h[1]!=null&&(a=Math.trunc(Math.max(a,h[1].getY()))),h[3]!=null&&(a=Math.max(a,Math.trunc(h[3].getY())));a+=gt.ROW_STEP;continue}if(o=!0,r.push(d),!t)break;d[2]!=null?(i=Math.trunc(d[2].getX()),a=Math.trunc(d[2].getY())):(i=Math.trunc(d[4].getX()),a=Math.trunc(d[4].getY()))}return r}static findVertices(t,s,r){const a=t.getHeight(),i=t.getWidth(),o=new Array(8);return gt.copyToResult(o,gt.findRowsWithPattern(t,a,i,s,r,gt.START_PATTERN),gt.INDEXES_START_PATTERN),o[4]!=null&&(r=Math.trunc(o[4].getX()),s=Math.trunc(o[4].getY())),gt.copyToResult(o,gt.findRowsWithPattern(t,a,i,s,r,gt.STOP_PATTERN),gt.INDEXES_STOP_PATTERN),o}static copyToResult(t,s,r){for(let a=0;a<r.length;a++)t[r[a]]=s[a]}static findRowsWithPattern(t,s,r,a,i,o){const d=new Array(4);let h=!1;const m=new Int32Array(o.length);for(;a<s;a+=gt.ROW_STEP){let T=gt.findGuardPattern(t,i,a,r,!1,o,m);if(T!=null){for(;a>0;){const z=gt.findGuardPattern(t,i,--a,r,!1,o,m);if(z!=null)T=z;else{a++;break}}d[0]=new Ye(T[0],a),d[1]=new Ye(T[1],a),h=!0;break}}let y=a+1;if(h){let T=0,z=Int32Array.from([Math.trunc(d[0].getX()),Math.trunc(d[1].getX())]);for(;y<s;y++){const Y=gt.findGuardPattern(t,z[0],y,r,!1,o,m);if(Y!=null&&Math.abs(z[0]-Y[0])<gt.MAX_PATTERN_DRIFT&&Math.abs(z[1]-Y[1])<gt.MAX_PATTERN_DRIFT)z=Y,T=0;else{if(T>gt.SKIPPED_ROW_COUNT_MAX)break;T++}}y-=T+1,d[2]=new Ye(z[0],y),d[3]=new Ye(z[1],y)}return y-a<gt.BARCODE_MIN_HEIGHT&&E.fill(d,null),d}static findGuardPattern(t,s,r,a,i,o,d){E.fillWithin(d,0,d.length,0);let h=s,m=0;for(;t.get(h,r)&&h>0&&m++<gt.MAX_PIXEL_DRIFT;)h--;let y=h,T=0,z=o.length;for(let Y=i;y<a;y++)if(t.get(y,r)!==Y)d[T]++;else{if(T===z-1){if(gt.patternMatchVariance(d,o,gt.MAX_INDIVIDUAL_VARIANCE)<gt.MAX_AVG_VARIANCE)return new Int32Array([h,y]);h+=d[0]+d[1],R.arraycopy(d,2,d,0,T-1),d[T-1]=0,d[T]=0,T--}else T++;d[T]=1,Y=!Y}return T===z-1&&gt.patternMatchVariance(d,o,gt.MAX_INDIVIDUAL_VARIANCE)<gt.MAX_AVG_VARIANCE?new Int32Array([h,y-1]):null}static patternMatchVariance(t,s,r){let a=t.length,i=0,o=0;for(let m=0;m<a;m++)i+=t[m],o+=s[m];if(i<o)return 1/0;let d=i/o;r*=d;let h=0;for(let m=0;m<a;m++){let y=t[m],T=s[m]*d,z=y>T?y-T:T-y;if(z>r)return 1/0;h+=z}return h/i}}gt.INDEXES_START_PATTERN=Int32Array.from([0,4,1,5]),gt.INDEXES_STOP_PATTERN=Int32Array.from([6,2,7,3]),gt.MAX_AVG_VARIANCE=.42,gt.MAX_INDIVIDUAL_VARIANCE=.8,gt.START_PATTERN=Int32Array.from([8,1,1,1,1,1,1,3]),gt.STOP_PATTERN=Int32Array.from([7,1,1,3,1,1,1,2,1]),gt.MAX_PIXEL_DRIFT=3,gt.MAX_PATTERN_DRIFT=5,gt.SKIPPED_ROW_COUNT_MAX=25,gt.ROW_STEP=5,gt.BARCODE_MIN_HEIGHT=10;class as{constructor(t,s){if(s.length===0)throw new p;this.field=t;let r=s.length;if(r>1&&s[0]===0){let a=1;for(;a<r&&s[a]===0;)a++;a===r?this.coefficients=new Int32Array([0]):(this.coefficients=new Int32Array(r-a),R.arraycopy(s,a,this.coefficients,0,this.coefficients.length))}else this.coefficients=s}getCoefficients(){return this.coefficients}getDegree(){return this.coefficients.length-1}isZero(){return this.coefficients[0]===0}getCoefficient(t){return this.coefficients[this.coefficients.length-1-t]}evaluateAt(t){if(t===0)return this.getCoefficient(0);if(t===1){let a=0;for(let i of this.coefficients)a=this.field.add(a,i);return a}let s=this.coefficients[0],r=this.coefficients.length;for(let a=1;a<r;a++)s=this.field.add(this.field.multiply(t,s),this.coefficients[a]);return s}add(t){if(!this.field.equals(t.field))throw new p("ModulusPolys do not have same ModulusGF field");if(this.isZero())return t;if(t.isZero())return this;let s=this.coefficients,r=t.coefficients;if(s.length>r.length){let o=s;s=r,r=o}let a=new Int32Array(r.length),i=r.length-s.length;R.arraycopy(r,0,a,0,i);for(let o=i;o<r.length;o++)a[o]=this.field.add(s[o-i],r[o]);return new as(this.field,a)}subtract(t){if(!this.field.equals(t.field))throw new p("ModulusPolys do not have same ModulusGF field");return t.isZero()?this:this.add(t.negative())}multiply(t){return t instanceof as?this.multiplyOther(t):this.multiplyScalar(t)}multiplyOther(t){if(!this.field.equals(t.field))throw new p("ModulusPolys do not have same ModulusGF field");if(this.isZero()||t.isZero())return new as(this.field,new Int32Array([0]));let s=this.coefficients,r=s.length,a=t.coefficients,i=a.length,o=new Int32Array(r+i-1);for(let d=0;d<r;d++){let h=s[d];for(let m=0;m<i;m++)o[d+m]=this.field.add(o[d+m],this.field.multiply(h,a[m]))}return new as(this.field,o)}negative(){let t=this.coefficients.length,s=new Int32Array(t);for(let r=0;r<t;r++)s[r]=this.field.subtract(0,this.coefficients[r]);return new as(this.field,s)}multiplyScalar(t){if(t===0)return new as(this.field,new Int32Array([0]));if(t===1)return this;let s=this.coefficients.length,r=new Int32Array(s);for(let a=0;a<s;a++)r[a]=this.field.multiply(this.coefficients[a],t);return new as(this.field,r)}multiplyByMonomial(t,s){if(t<0)throw new p;if(s===0)return new as(this.field,new Int32Array([0]));let r=this.coefficients.length,a=new Int32Array(r+t);for(let i=0;i<r;i++)a[i]=this.field.multiply(this.coefficients[i],s);return new as(this.field,a)}toString(){let t=new se;for(let s=this.getDegree();s>=0;s--){let r=this.getCoefficient(s);r!==0&&(r<0?(t.append(" - "),r=-r):t.length()>0&&t.append(" + "),(s===0||r!==1)&&t.append(r),s!==0&&(s===1?t.append("x"):(t.append("x^"),t.append(s))))}return t.toString()}}class Gi{add(t,s){return(t+s)%this.modulus}subtract(t,s){return(this.modulus+t-s)%this.modulus}exp(t){return this.expTable[t]}log(t){if(t===0)throw new p;return this.logTable[t]}inverse(t){if(t===0)throw new Ae;return this.expTable[this.modulus-this.logTable[t]-1]}multiply(t,s){return t===0||s===0?0:this.expTable[(this.logTable[t]+this.logTable[s])%(this.modulus-1)]}getSize(){return this.modulus}equals(t){return t===this}}class za extends Gi{constructor(t,s){super(),this.modulus=t,this.expTable=new Int32Array(t),this.logTable=new Int32Array(t);let r=1;for(let a=0;a<t;a++)this.expTable[a]=r,r=r*s%t;for(let a=0;a<t-1;a++)this.logTable[this.expTable[a]]=a;this.zero=new as(this,new Int32Array([0])),this.one=new as(this,new Int32Array([1]))}getZero(){return this.zero}getOne(){return this.one}buildMonomial(t,s){if(t<0)throw new p;if(s===0)return this.zero;let r=new Int32Array(t+1);return r[0]=s,new as(this,r)}}za.PDF417_GF=new za(lt.NUMBER_OF_CODEWORDS,3);class mn{constructor(){this.field=za.PDF417_GF}decode(t,s,r){let a=new as(this.field,t),i=new Int32Array(s),o=!1;for(let ce=s;ce>0;ce--){let ue=a.evaluateAt(this.field.exp(ce));i[s-ce]=ue,ue!==0&&(o=!0)}if(!o)return 0;let d=this.field.getOne();if(r!=null)for(const ce of r){let ue=this.field.exp(t.length-1-ce),Se=new as(this.field,new Int32Array([this.field.subtract(0,ue),1]));d=d.multiply(Se)}let h=new as(this.field,i),m=this.runEuclideanAlgorithm(this.field.buildMonomial(s,1),h,s),y=m[0],T=m[1],z=this.findErrorLocations(y),Y=this.findErrorMagnitudes(T,y,z);for(let ce=0;ce<z.length;ce++){let ue=t.length-1-this.field.log(z[ce]);if(ue<0)throw B.getChecksumInstance();t[ue]=this.field.subtract(t[ue],Y[ce])}return z.length}runEuclideanAlgorithm(t,s,r){if(t.getDegree()<s.getDegree()){let z=t;t=s,s=z}let a=t,i=s,o=this.field.getZero(),d=this.field.getOne();for(;i.getDegree()>=Math.round(r/2);){let z=a,Y=o;if(a=i,o=d,a.isZero())throw B.getChecksumInstance();i=z;let ce=this.field.getZero(),ue=a.getCoefficient(a.getDegree()),Se=this.field.inverse(ue);for(;i.getDegree()>=a.getDegree()&&!i.isZero();){let ze=i.getDegree()-a.getDegree(),We=this.field.multiply(i.getCoefficient(i.getDegree()),Se);ce=ce.add(this.field.buildMonomial(ze,We)),i=i.subtract(a.multiplyByMonomial(ze,We))}d=ce.multiply(o).subtract(Y).negative()}let h=d.getCoefficient(0);if(h===0)throw B.getChecksumInstance();let m=this.field.inverse(h),y=d.multiply(m),T=i.multiply(m);return[y,T]}findErrorLocations(t){let s=t.getDegree(),r=new Int32Array(s),a=0;for(let i=1;i<this.field.getSize()&&a<s;i++)t.evaluateAt(i)===0&&(r[a]=this.field.inverse(i),a++);if(a!==s)throw B.getChecksumInstance();return r}findErrorMagnitudes(t,s,r){let a=s.getDegree(),i=new Int32Array(a);for(let m=1;m<=a;m++)i[a-m]=this.field.multiply(m,s.getCoefficient(m));let o=new as(this.field,i),d=r.length,h=new Int32Array(d);for(let m=0;m<d;m++){let y=this.field.inverse(r[m]),T=this.field.subtract(0,t.evaluateAt(y)),z=this.field.inverse(o.evaluateAt(y));h[m]=this.field.multiply(T,z)}return h}}class gr{constructor(t,s,r,a,i){t instanceof gr?this.constructor_2(t):this.constructor_1(t,s,r,a,i)}constructor_1(t,s,r,a,i){const o=s==null||r==null,d=a==null||i==null;if(o&&d)throw new $;o?(s=new Ye(0,a.getY()),r=new Ye(0,i.getY())):d&&(a=new Ye(t.getWidth()-1,s.getY()),i=new Ye(t.getWidth()-1,r.getY())),this.image=t,this.topLeft=s,this.bottomLeft=r,this.topRight=a,this.bottomRight=i,this.minX=Math.trunc(Math.min(s.getX(),r.getX())),this.maxX=Math.trunc(Math.max(a.getX(),i.getX())),this.minY=Math.trunc(Math.min(s.getY(),a.getY())),this.maxY=Math.trunc(Math.max(r.getY(),i.getY()))}constructor_2(t){this.image=t.image,this.topLeft=t.getTopLeft(),this.bottomLeft=t.getBottomLeft(),this.topRight=t.getTopRight(),this.bottomRight=t.getBottomRight(),this.minX=t.getMinX(),this.maxX=t.getMaxX(),this.minY=t.getMinY(),this.maxY=t.getMaxY()}static merge(t,s){return t==null?s:s==null?t:new gr(t.image,t.topLeft,t.bottomLeft,s.topRight,s.bottomRight)}addMissingRows(t,s,r){let a=this.topLeft,i=this.bottomLeft,o=this.topRight,d=this.bottomRight;if(t>0){let h=r?this.topLeft:this.topRight,m=Math.trunc(h.getY()-t);m<0&&(m=0);let y=new Ye(h.getX(),m);r?a=y:o=y}if(s>0){let h=r?this.bottomLeft:this.bottomRight,m=Math.trunc(h.getY()+s);m>=this.image.getHeight()&&(m=this.image.getHeight()-1);let y=new Ye(h.getX(),m);r?i=y:d=y}return new gr(this.image,a,i,o,d)}getMinX(){return this.minX}getMaxX(){return this.maxX}getMinY(){return this.minY}getMaxY(){return this.maxY}getTopLeft(){return this.topLeft}getTopRight(){return this.topRight}getBottomLeft(){return this.bottomLeft}getBottomRight(){return this.bottomRight}}class Wi{constructor(t,s,r,a){this.columnCount=t,this.errorCorrectionLevel=a,this.rowCountUpperPart=s,this.rowCountLowerPart=r,this.rowCount=s+r}getColumnCount(){return this.columnCount}getErrorCorrectionLevel(){return this.errorCorrectionLevel}getRowCount(){return this.rowCount}getRowCountUpperPart(){return this.rowCountUpperPart}getRowCountLowerPart(){return this.rowCountLowerPart}}class Fr{constructor(){this.buffer=""}static form(t,s){let r=-1;function a(o,d,h,m,y,T){if(o==="%%")return"%";if(s[++r]===void 0)return;o=m?parseInt(m.substr(1)):void 0;let z=y?parseInt(y.substr(1)):void 0,Y;switch(T){case"s":Y=s[r];break;case"c":Y=s[r][0];break;case"f":Y=parseFloat(s[r]).toFixed(o);break;case"p":Y=parseFloat(s[r]).toPrecision(o);break;case"e":Y=parseFloat(s[r]).toExponential(o);break;case"x":Y=parseInt(s[r]).toString(z||16);break;case"d":Y=parseFloat(parseInt(s[r],z||10).toPrecision(o)).toFixed(0);break}Y=typeof Y=="object"?JSON.stringify(Y):(+Y).toString(z);let ce=parseInt(h),ue=h&&h[0]+""=="0"?"0":" ";for(;Y.length<ce;)Y=d!==void 0?Y+ue:ue+Y;return Y}let i=/%(-)?(0?[0-9]+)?([.][0-9]+)?([#][0-9]+)?([scfpexd%])/g;return t.replace(i,a)}format(t,...s){this.buffer+=Fr.form(t,s)}toString(){return this.buffer}}class Ur{constructor(t){this.boundingBox=new gr(t),this.codewords=new Array(t.getMaxY()-t.getMinY()+1)}getCodewordNearby(t){let s=this.getCodeword(t);if(s!=null)return s;for(let r=1;r<Ur.MAX_NEARBY_DISTANCE;r++){let a=this.imageRowToCodewordIndex(t)-r;if(a>=0&&(s=this.codewords[a],s!=null)||(a=this.imageRowToCodewordIndex(t)+r,a<this.codewords.length&&(s=this.codewords[a],s!=null)))return s}return null}imageRowToCodewordIndex(t){return t-this.boundingBox.getMinY()}setCodeword(t,s){this.codewords[this.imageRowToCodewordIndex(t)]=s}getCodeword(t){return this.codewords[this.imageRowToCodewordIndex(t)]}getBoundingBox(){return this.boundingBox}getCodewords(){return this.codewords}toString(){const t=new Fr;let s=0;for(const r of this.codewords){if(r==null){t.format("%3d:    |   %n",s++);continue}t.format("%3d: %3d|%3d%n",s++,r.getRowNumber(),r.getValue())}return t.toString()}}Ur.MAX_NEARBY_DISTANCE=5;class Vr{constructor(){this.values=new Map}setValue(t){t=Math.trunc(t);let s=this.values.get(t);s==null&&(s=0),s++,this.values.set(t,s)}getValue(){let t=-1,s=new Array;for(const[r,a]of this.values.entries()){const i={getKey:()=>r,getValue:()=>a};i.getValue()>t?(t=i.getValue(),s=[],s.push(i.getKey())):i.getValue()===t&&s.push(i.getKey())}return lt.toIntArray(s)}getConfidence(t){return this.values.get(t)}}class fn extends Ur{constructor(t,s){super(t),this._isLeft=s}setRowNumbers(){for(let t of this.getCodewords())t!=null&&t.setRowNumberAsRowIndicatorColumn()}adjustCompleteIndicatorColumnRowNumbers(t){let s=this.getCodewords();this.setRowNumbers(),this.removeIncorrectCodewords(s,t);let r=this.getBoundingBox(),a=this._isLeft?r.getTopLeft():r.getTopRight(),i=this._isLeft?r.getBottomLeft():r.getBottomRight(),o=this.imageRowToCodewordIndex(Math.trunc(a.getY())),d=this.imageRowToCodewordIndex(Math.trunc(i.getY())),h=-1,m=1,y=0;for(let T=o;T<d;T++){if(s[T]==null)continue;let z=s[T],Y=z.getRowNumber()-h;if(Y===0)y++;else if(Y===1)m=Math.max(m,y),y=1,h=z.getRowNumber();else if(Y<0||z.getRowNumber()>=t.getRowCount()||Y>T)s[T]=null;else{let ce;m>2?ce=(m-2)*Y:ce=Y;let ue=ce>=T;for(let Se=1;Se<=ce&&!ue;Se++)ue=s[T-Se]!=null;ue?s[T]=null:(h=z.getRowNumber(),y=1)}}}getRowHeights(){let t=this.getBarcodeMetadata();if(t==null)return null;this.adjustIncompleteIndicatorColumnRowNumbers(t);let s=new Int32Array(t.getRowCount());for(let r of this.getCodewords())if(r!=null){let a=r.getRowNumber();if(a>=s.length)continue;s[a]++}return s}adjustIncompleteIndicatorColumnRowNumbers(t){let s=this.getBoundingBox(),r=this._isLeft?s.getTopLeft():s.getTopRight(),a=this._isLeft?s.getBottomLeft():s.getBottomRight(),i=this.imageRowToCodewordIndex(Math.trunc(r.getY())),o=this.imageRowToCodewordIndex(Math.trunc(a.getY())),d=this.getCodewords(),h=-1;for(let m=i;m<o;m++){if(d[m]==null)continue;let y=d[m];y.setRowNumberAsRowIndicatorColumn();let T=y.getRowNumber()-h;T===0||(T===1?h=y.getRowNumber():y.getRowNumber()>=t.getRowCount()?d[m]=null:h=y.getRowNumber())}}getBarcodeMetadata(){let t=this.getCodewords(),s=new Vr,r=new Vr,a=new Vr,i=new Vr;for(let d of t){if(d==null)continue;d.setRowNumberAsRowIndicatorColumn();let h=d.getValue()%30,m=d.getRowNumber();switch(this._isLeft||(m+=2),m%3){case 0:r.setValue(h*3+1);break;case 1:i.setValue(h/3),a.setValue(h%3);break;case 2:s.setValue(h+1);break}}if(s.getValue().length===0||r.getValue().length===0||a.getValue().length===0||i.getValue().length===0||s.getValue()[0]<1||r.getValue()[0]+a.getValue()[0]<lt.MIN_ROWS_IN_BARCODE||r.getValue()[0]+a.getValue()[0]>lt.MAX_ROWS_IN_BARCODE)return null;let o=new Wi(s.getValue()[0],r.getValue()[0],a.getValue()[0],i.getValue()[0]);return this.removeIncorrectCodewords(t,o),o}removeIncorrectCodewords(t,s){for(let r=0;r<t.length;r++){let a=t[r];if(t[r]==null)continue;let i=a.getValue()%30,o=a.getRowNumber();if(o>s.getRowCount()){t[r]=null;continue}switch(this._isLeft||(o+=2),o%3){case 0:i*3+1!==s.getRowCountUpperPart()&&(t[r]=null);break;case 1:(Math.trunc(i/3)!==s.getErrorCorrectionLevel()||i%3!==s.getRowCountLowerPart())&&(t[r]=null);break;case 2:i+1!==s.getColumnCount()&&(t[r]=null);break}}}isLeft(){return this._isLeft}toString(){return"IsLeft: "+this._isLeft+`
`+super.toString()}}class qr{constructor(t,s){this.ADJUST_ROW_NUMBER_SKIP=2,this.barcodeMetadata=t,this.barcodeColumnCount=t.getColumnCount(),this.boundingBox=s,this.detectionResultColumns=new Array(this.barcodeColumnCount+2)}getDetectionResultColumns(){this.adjustIndicatorColumnRowNumbers(this.detectionResultColumns[0]),this.adjustIndicatorColumnRowNumbers(this.detectionResultColumns[this.barcodeColumnCount+1]);let t=lt.MAX_CODEWORDS_IN_BARCODE,s;do s=t,t=this.adjustRowNumbersAndGetCount();while(t>0&&t<s);return this.detectionResultColumns}adjustIndicatorColumnRowNumbers(t){t!=null&&t.adjustCompleteIndicatorColumnRowNumbers(this.barcodeMetadata)}adjustRowNumbersAndGetCount(){let t=this.adjustRowNumbersByRow();if(t===0)return 0;for(let s=1;s<this.barcodeColumnCount+1;s++){let r=this.detectionResultColumns[s].getCodewords();for(let a=0;a<r.length;a++)r[a]!=null&&(r[a].hasValidRowNumber()||this.adjustRowNumbers(s,a,r))}return t}adjustRowNumbersByRow(){return this.adjustRowNumbersFromBothRI(),this.adjustRowNumbersFromLRI()+this.adjustRowNumbersFromRRI()}adjustRowNumbersFromBothRI(){if(this.detectionResultColumns[0]==null||this.detectionResultColumns[this.barcodeColumnCount+1]==null)return;let t=this.detectionResultColumns[0].getCodewords(),s=this.detectionResultColumns[this.barcodeColumnCount+1].getCodewords();for(let r=0;r<t.length;r++)if(t[r]!=null&&s[r]!=null&&t[r].getRowNumber()===s[r].getRowNumber())for(let a=1;a<=this.barcodeColumnCount;a++){let i=this.detectionResultColumns[a].getCodewords()[r];i!=null&&(i.setRowNumber(t[r].getRowNumber()),i.hasValidRowNumber()||(this.detectionResultColumns[a].getCodewords()[r]=null))}}adjustRowNumbersFromRRI(){if(this.detectionResultColumns[this.barcodeColumnCount+1]==null)return 0;let t=0,s=this.detectionResultColumns[this.barcodeColumnCount+1].getCodewords();for(let r=0;r<s.length;r++){if(s[r]==null)continue;let a=s[r].getRowNumber(),i=0;for(let o=this.barcodeColumnCount+1;o>0&&i<this.ADJUST_ROW_NUMBER_SKIP;o--){let d=this.detectionResultColumns[o].getCodewords()[r];d!=null&&(i=qr.adjustRowNumberIfValid(a,i,d),d.hasValidRowNumber()||t++)}}return t}adjustRowNumbersFromLRI(){if(this.detectionResultColumns[0]==null)return 0;let t=0,s=this.detectionResultColumns[0].getCodewords();for(let r=0;r<s.length;r++){if(s[r]==null)continue;let a=s[r].getRowNumber(),i=0;for(let o=1;o<this.barcodeColumnCount+1&&i<this.ADJUST_ROW_NUMBER_SKIP;o++){let d=this.detectionResultColumns[o].getCodewords()[r];d!=null&&(i=qr.adjustRowNumberIfValid(a,i,d),d.hasValidRowNumber()||t++)}}return t}static adjustRowNumberIfValid(t,s,r){return r==null||r.hasValidRowNumber()||(r.isValidRowNumber(t)?(r.setRowNumber(t),s=0):++s),s}adjustRowNumbers(t,s,r){if(!this.detectionResultColumns[t-1])return;let a=r[s],i=this.detectionResultColumns[t-1].getCodewords(),o=i;this.detectionResultColumns[t+1]!=null&&(o=this.detectionResultColumns[t+1].getCodewords());let d=new Array(14);d[2]=i[s],d[3]=o[s],s>0&&(d[0]=r[s-1],d[4]=i[s-1],d[5]=o[s-1]),s>1&&(d[8]=r[s-2],d[10]=i[s-2],d[11]=o[s-2]),s<r.length-1&&(d[1]=r[s+1],d[6]=i[s+1],d[7]=o[s+1]),s<r.length-2&&(d[9]=r[s+2],d[12]=i[s+2],d[13]=o[s+2]);for(let h of d)if(qr.adjustRowNumber(a,h))return}static adjustRowNumber(t,s){return s==null?!1:s.hasValidRowNumber()&&s.getBucket()===t.getBucket()?(t.setRowNumber(s.getRowNumber()),!0):!1}getBarcodeColumnCount(){return this.barcodeColumnCount}getBarcodeRowCount(){return this.barcodeMetadata.getRowCount()}getBarcodeECLevel(){return this.barcodeMetadata.getErrorCorrectionLevel()}setBoundingBox(t){this.boundingBox=t}getBoundingBox(){return this.boundingBox}setDetectionResultColumn(t,s){this.detectionResultColumns[t]=s}getDetectionResultColumn(t){return this.detectionResultColumns[t]}toString(){let t=this.detectionResultColumns[0];t==null&&(t=this.detectionResultColumns[this.barcodeColumnCount+1]);let s=new Fr;for(let r=0;r<t.getCodewords().length;r++){s.format("CW %3d:",r);for(let a=0;a<this.barcodeColumnCount+2;a++){if(this.detectionResultColumns[a]==null){s.format("    |   ");continue}let i=this.detectionResultColumns[a].getCodewords()[r];if(i==null){s.format("    |   ");continue}s.format(" %3d|%3d",i.getRowNumber(),i.getValue())}s.format("%n")}return s.toString()}}class Hr{constructor(t,s,r,a){this.rowNumber=Hr.BARCODE_ROW_UNKNOWN,this.startX=Math.trunc(t),this.endX=Math.trunc(s),this.bucket=Math.trunc(r),this.value=Math.trunc(a)}hasValidRowNumber(){return this.isValidRowNumber(this.rowNumber)}isValidRowNumber(t){return t!==Hr.BARCODE_ROW_UNKNOWN&&this.bucket===t%3*3}setRowNumberAsRowIndicatorColumn(){this.rowNumber=Math.trunc(Math.trunc(this.value/30)*3+Math.trunc(this.bucket/3))}getWidth(){return this.endX-this.startX}getStartX(){return this.startX}getEndX(){return this.endX}getBucket(){return this.bucket}getValue(){return this.value}getRowNumber(){return this.rowNumber}setRowNumber(t){this.rowNumber=t}toString(){return this.rowNumber+"|"+this.value}}Hr.BARCODE_ROW_UNKNOWN=-1;class fs{static initialize(){for(let t=0;t<lt.SYMBOL_TABLE.length;t++){let s=lt.SYMBOL_TABLE[t],r=s&1;for(let a=0;a<lt.BARS_IN_MODULE;a++){let i=0;for(;(s&1)===r;)i+=1,s>>=1;r=s&1,fs.RATIOS_TABLE[t]||(fs.RATIOS_TABLE[t]=new Array(lt.BARS_IN_MODULE)),fs.RATIOS_TABLE[t][lt.BARS_IN_MODULE-a-1]=Math.fround(i/lt.MODULES_IN_CODEWORD)}}this.bSymbolTableReady=!0}static getDecodedValue(t){let s=fs.getDecodedCodewordValue(fs.sampleBitCounts(t));return s!==-1?s:fs.getClosestDecodedValue(t)}static sampleBitCounts(t){let s=Ge.sum(t),r=new Int32Array(lt.BARS_IN_MODULE),a=0,i=0;for(let o=0;o<lt.MODULES_IN_CODEWORD;o++){let d=s/(2*lt.MODULES_IN_CODEWORD)+o*s/lt.MODULES_IN_CODEWORD;i+t[a]<=d&&(i+=t[a],a++),r[a]++}return r}static getDecodedCodewordValue(t){let s=fs.getBitValue(t);return lt.getCodeword(s)===-1?-1:s}static getBitValue(t){let s=0;for(let r=0;r<t.length;r++)for(let a=0;a<t[r];a++)s=s<<1|(r%2===0?1:0);return Math.trunc(s)}static getClosestDecodedValue(t){let s=Ge.sum(t),r=new Array(lt.BARS_IN_MODULE);if(s>1)for(let o=0;o<r.length;o++)r[o]=Math.fround(t[o]/s);let a=yt.MAX_VALUE,i=-1;this.bSymbolTableReady||fs.initialize();for(let o=0;o<fs.RATIOS_TABLE.length;o++){let d=0,h=fs.RATIOS_TABLE[o];for(let m=0;m<lt.BARS_IN_MODULE;m++){let y=Math.fround(h[m]-r[m]);if(d+=Math.fround(y*y),d>=a)break}d<a&&(a=d,i=lt.SYMBOL_TABLE[o])}return i}}fs.bSymbolTableReady=!1,fs.RATIOS_TABLE=new Array(lt.SYMBOL_TABLE.length).map(A=>new Array(lt.BARS_IN_MODULE));class gn{constructor(){this.segmentCount=-1,this.fileSize=-1,this.timestamp=-1,this.checksum=-1}getSegmentIndex(){return this.segmentIndex}setSegmentIndex(t){this.segmentIndex=t}getFileId(){return this.fileId}setFileId(t){this.fileId=t}getOptionalData(){return this.optionalData}setOptionalData(t){this.optionalData=t}isLastSegment(){return this.lastSegment}setLastSegment(t){this.lastSegment=t}getSegmentCount(){return this.segmentCount}setSegmentCount(t){this.segmentCount=t}getSender(){return this.sender||null}setSender(t){this.sender=t}getAddressee(){return this.addressee||null}setAddressee(t){this.addressee=t}getFileName(){return this.fileName}setFileName(t){this.fileName=t}getFileSize(){return this.fileSize}setFileSize(t){this.fileSize=t}getChecksum(){return this.checksum}setChecksum(t){this.checksum=t}getTimestamp(){return this.timestamp}setTimestamp(t){this.timestamp=t}}class pn{static parseLong(t,s=void 0){return parseInt(t,s)}}class bn extends g{}bn.kind="NullPointerException";class Yi{writeBytes(t){this.writeBytesOffset(t,0,t.length)}writeBytesOffset(t,s,r){if(t==null)throw new bn;if(s<0||s>t.length||r<0||s+r>t.length||s+r<0)throw new C;if(r===0)return;for(let a=0;a<r;a++)this.write(t[s+a])}flush(){}close(){}}class $i extends g{}class Xi extends Yi{constructor(t=32){if(super(),this.count=0,t<0)throw new p("Negative initial size: "+t);this.buf=new Uint8Array(t)}ensureCapacity(t){t-this.buf.length>0&&this.grow(t)}grow(t){let r=this.buf.length<<1;if(r-t<0&&(r=t),r<0){if(t<0)throw new $i;r=U.MAX_VALUE}this.buf=E.copyOfUint8Array(this.buf,r)}write(t){this.ensureCapacity(this.count+1),this.buf[this.count]=t,this.count+=1}writeBytesOffset(t,s,r){if(s<0||s>t.length||r<0||s+r-t.length>0)throw new C;this.ensureCapacity(this.count+r),R.arraycopy(t,s,this.buf,this.count,r),this.count+=r}writeTo(t){t.writeBytesOffset(this.buf,0,this.count)}reset(){this.count=0}toByteArray(){return E.copyOfUint8Array(this.buf,this.count)}size(){return this.count}toString(t){return t?typeof t=="string"?this.toString_string(t):this.toString_number(t):this.toString_void()}toString_void(){return new String(this.buf).toString()}toString_string(t){return new String(this.buf).toString()}toString_number(t){return new String(this.buf).toString()}close(){}}var Dt;(function(A){A[A.ALPHA=0]="ALPHA",A[A.LOWER=1]="LOWER",A[A.MIXED=2]="MIXED",A[A.PUNCT=3]="PUNCT",A[A.ALPHA_SHIFT=4]="ALPHA_SHIFT",A[A.PUNCT_SHIFT=5]="PUNCT_SHIFT"})(Dt||(Dt={}));function wn(){if(typeof window<"u")return window.BigInt||null;if(typeof Yr<"u")return Yr.BigInt||null;if(typeof self<"u")return self.BigInt||null;throw new Error("Can't search globals for BigInt!")}let ca;function rr(A){if(typeof ca>"u"&&(ca=wn()),ca===null)throw new Error("BigInt is not supported!");return ca(A)}function Zi(){let A=[];A[0]=rr(1);let t=rr(900);A[1]=t;for(let s=2;s<16;s++)A[s]=A[s-1]*t;return A}class Me{static decode(t,s){let r=new se(""),a=I.ISO8859_1;r.enableDecoding(a);let i=1,o=t[i++],d=new gn;for(;i<t[0];){switch(o){case Me.TEXT_COMPACTION_MODE_LATCH:i=Me.textCompaction(t,i,r);break;case Me.BYTE_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH_6:i=Me.byteCompaction(o,t,a,i,r);break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:r.append(t[i++]);break;case Me.NUMERIC_COMPACTION_MODE_LATCH:i=Me.numericCompaction(t,i,r);break;case Me.ECI_CHARSET:I.getCharacterSetECIByValue(t[i++]);break;case Me.ECI_GENERAL_PURPOSE:i+=2;break;case Me.ECI_USER_DEFINED:i++;break;case Me.BEGIN_MACRO_PDF417_CONTROL_BLOCK:i=Me.decodeMacroBlock(t,i,d);break;case Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD:case Me.MACRO_PDF417_TERMINATOR:throw new _;default:i--,i=Me.textCompaction(t,i,r);break}if(i<t.length)o=t[i++];else throw _.getFormatInstance()}if(r.length()===0)throw _.getFormatInstance();let h=new ye(null,r.toString(),null,s);return h.setOther(d),h}static decodeMacroBlock(t,s,r){if(s+Me.NUMBER_OF_SEQUENCE_CODEWORDS>t[0])throw _.getFormatInstance();let a=new Int32Array(Me.NUMBER_OF_SEQUENCE_CODEWORDS);for(let d=0;d<Me.NUMBER_OF_SEQUENCE_CODEWORDS;d++,s++)a[d]=t[s];r.setSegmentIndex(U.parseInt(Me.decodeBase900toBase10(a,Me.NUMBER_OF_SEQUENCE_CODEWORDS)));let i=new se;s=Me.textCompaction(t,s,i),r.setFileId(i.toString());let o=-1;for(t[s]===Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD&&(o=s+1);s<t[0];)switch(t[s]){case Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD:switch(s++,t[s]){case Me.MACRO_PDF417_OPTIONAL_FIELD_FILE_NAME:let d=new se;s=Me.textCompaction(t,s+1,d),r.setFileName(d.toString());break;case Me.MACRO_PDF417_OPTIONAL_FIELD_SENDER:let h=new se;s=Me.textCompaction(t,s+1,h),r.setSender(h.toString());break;case Me.MACRO_PDF417_OPTIONAL_FIELD_ADDRESSEE:let m=new se;s=Me.textCompaction(t,s+1,m),r.setAddressee(m.toString());break;case Me.MACRO_PDF417_OPTIONAL_FIELD_SEGMENT_COUNT:let y=new se;s=Me.numericCompaction(t,s+1,y),r.setSegmentCount(U.parseInt(y.toString()));break;case Me.MACRO_PDF417_OPTIONAL_FIELD_TIME_STAMP:let T=new se;s=Me.numericCompaction(t,s+1,T),r.setTimestamp(pn.parseLong(T.toString()));break;case Me.MACRO_PDF417_OPTIONAL_FIELD_CHECKSUM:let z=new se;s=Me.numericCompaction(t,s+1,z),r.setChecksum(U.parseInt(z.toString()));break;case Me.MACRO_PDF417_OPTIONAL_FIELD_FILE_SIZE:let Y=new se;s=Me.numericCompaction(t,s+1,Y),r.setFileSize(pn.parseLong(Y.toString()));break;default:throw _.getFormatInstance()}break;case Me.MACRO_PDF417_TERMINATOR:s++,r.setLastSegment(!0);break;default:throw _.getFormatInstance()}if(o!==-1){let d=s-o;r.isLastSegment()&&d--,r.setOptionalData(E.copyOfRange(t,o,o+d))}return s}static textCompaction(t,s,r){let a=new Int32Array((t[0]-s)*2),i=new Int32Array((t[0]-s)*2),o=0,d=!1;for(;s<t[0]&&!d;){let h=t[s++];if(h<Me.TEXT_COMPACTION_MODE_LATCH)a[o]=h/30,a[o+1]=h%30,o+=2;else switch(h){case Me.TEXT_COMPACTION_MODE_LATCH:a[o++]=Me.TEXT_COMPACTION_MODE_LATCH;break;case Me.BYTE_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH_6:case Me.NUMERIC_COMPACTION_MODE_LATCH:case Me.BEGIN_MACRO_PDF417_CONTROL_BLOCK:case Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD:case Me.MACRO_PDF417_TERMINATOR:s--,d=!0;break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:a[o]=Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE,h=t[s++],i[o]=h,o++;break}}return Me.decodeTextCompaction(a,i,o,r),s}static decodeTextCompaction(t,s,r,a){let i=Dt.ALPHA,o=Dt.ALPHA,d=0;for(;d<r;){let h=t[d],m="";switch(i){case Dt.ALPHA:if(h<26)m=String.fromCharCode(65+h);else switch(h){case 26:m=" ";break;case Me.LL:i=Dt.LOWER;break;case Me.ML:i=Dt.MIXED;break;case Me.PS:o=i,i=Dt.PUNCT_SHIFT;break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:a.append(s[d]);break;case Me.TEXT_COMPACTION_MODE_LATCH:i=Dt.ALPHA;break}break;case Dt.LOWER:if(h<26)m=String.fromCharCode(97+h);else switch(h){case 26:m=" ";break;case Me.AS:o=i,i=Dt.ALPHA_SHIFT;break;case Me.ML:i=Dt.MIXED;break;case Me.PS:o=i,i=Dt.PUNCT_SHIFT;break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:a.append(s[d]);break;case Me.TEXT_COMPACTION_MODE_LATCH:i=Dt.ALPHA;break}break;case Dt.MIXED:if(h<Me.PL)m=Me.MIXED_CHARS[h];else switch(h){case Me.PL:i=Dt.PUNCT;break;case 26:m=" ";break;case Me.LL:i=Dt.LOWER;break;case Me.AL:i=Dt.ALPHA;break;case Me.PS:o=i,i=Dt.PUNCT_SHIFT;break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:a.append(s[d]);break;case Me.TEXT_COMPACTION_MODE_LATCH:i=Dt.ALPHA;break}break;case Dt.PUNCT:if(h<Me.PAL)m=Me.PUNCT_CHARS[h];else switch(h){case Me.PAL:i=Dt.ALPHA;break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:a.append(s[d]);break;case Me.TEXT_COMPACTION_MODE_LATCH:i=Dt.ALPHA;break}break;case Dt.ALPHA_SHIFT:if(i=o,h<26)m=String.fromCharCode(65+h);else switch(h){case 26:m=" ";break;case Me.TEXT_COMPACTION_MODE_LATCH:i=Dt.ALPHA;break}break;case Dt.PUNCT_SHIFT:if(i=o,h<Me.PAL)m=Me.PUNCT_CHARS[h];else switch(h){case Me.PAL:i=Dt.ALPHA;break;case Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE:a.append(s[d]);break;case Me.TEXT_COMPACTION_MODE_LATCH:i=Dt.ALPHA;break}break}m!==""&&a.append(m),d++}}static byteCompaction(t,s,r,a,i){let o=new Xi,d=0,h=0,m=!1;switch(t){case Me.BYTE_COMPACTION_MODE_LATCH:let y=new Int32Array(6),T=s[a++];for(;a<s[0]&&!m;)switch(y[d++]=T,h=900*h+T,T=s[a++],T){case Me.TEXT_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH:case Me.NUMERIC_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH_6:case Me.BEGIN_MACRO_PDF417_CONTROL_BLOCK:case Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD:case Me.MACRO_PDF417_TERMINATOR:a--,m=!0;break;default:if(d%5===0&&d>0){for(let z=0;z<6;++z)o.write(Number(rr(h)>>rr(8*(5-z))));h=0,d=0}break}a===s[0]&&T<Me.TEXT_COMPACTION_MODE_LATCH&&(y[d++]=T);for(let z=0;z<d;z++)o.write(y[z]);break;case Me.BYTE_COMPACTION_MODE_LATCH_6:for(;a<s[0]&&!m;){let z=s[a++];if(z<Me.TEXT_COMPACTION_MODE_LATCH)d++,h=900*h+z;else switch(z){case Me.TEXT_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH:case Me.NUMERIC_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH_6:case Me.BEGIN_MACRO_PDF417_CONTROL_BLOCK:case Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD:case Me.MACRO_PDF417_TERMINATOR:a--,m=!0;break}if(d%5===0&&d>0){for(let Y=0;Y<6;++Y)o.write(Number(rr(h)>>rr(8*(5-Y))));h=0,d=0}}break}return i.append(O.decode(o.toByteArray(),r)),a}static numericCompaction(t,s,r){let a=0,i=!1,o=new Int32Array(Me.MAX_NUMERIC_CODEWORDS);for(;s<t[0]&&!i;){let d=t[s++];if(s===t[0]&&(i=!0),d<Me.TEXT_COMPACTION_MODE_LATCH)o[a]=d,a++;else switch(d){case Me.TEXT_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH:case Me.BYTE_COMPACTION_MODE_LATCH_6:case Me.BEGIN_MACRO_PDF417_CONTROL_BLOCK:case Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD:case Me.MACRO_PDF417_TERMINATOR:s--,i=!0;break}(a%Me.MAX_NUMERIC_CODEWORDS===0||d===Me.NUMERIC_COMPACTION_MODE_LATCH||i)&&a>0&&(r.append(Me.decodeBase900toBase10(o,a)),a=0)}return s}static decodeBase900toBase10(t,s){let r=rr(0);for(let i=0;i<s;i++)r+=Me.EXP900[s-i-1]*rr(t[i]);let a=r.toString();if(a.charAt(0)!=="1")throw new _;return a.substring(1)}}Me.TEXT_COMPACTION_MODE_LATCH=900,Me.BYTE_COMPACTION_MODE_LATCH=901,Me.NUMERIC_COMPACTION_MODE_LATCH=902,Me.BYTE_COMPACTION_MODE_LATCH_6=924,Me.ECI_USER_DEFINED=925,Me.ECI_GENERAL_PURPOSE=926,Me.ECI_CHARSET=927,Me.BEGIN_MACRO_PDF417_CONTROL_BLOCK=928,Me.BEGIN_MACRO_PDF417_OPTIONAL_FIELD=923,Me.MACRO_PDF417_TERMINATOR=922,Me.MODE_SHIFT_TO_BYTE_COMPACTION_MODE=913,Me.MAX_NUMERIC_CODEWORDS=15,Me.MACRO_PDF417_OPTIONAL_FIELD_FILE_NAME=0,Me.MACRO_PDF417_OPTIONAL_FIELD_SEGMENT_COUNT=1,Me.MACRO_PDF417_OPTIONAL_FIELD_TIME_STAMP=2,Me.MACRO_PDF417_OPTIONAL_FIELD_SENDER=3,Me.MACRO_PDF417_OPTIONAL_FIELD_ADDRESSEE=4,Me.MACRO_PDF417_OPTIONAL_FIELD_FILE_SIZE=5,Me.MACRO_PDF417_OPTIONAL_FIELD_CHECKSUM=6,Me.PL=25,Me.LL=27,Me.AS=27,Me.ML=28,Me.AL=28,Me.PS=29,Me.PAL=29,Me.PUNCT_CHARS=`;<>@[\\]_\`~!\r	,:
-.$/"|*()?{}'`,Me.MIXED_CHARS="0123456789&\r	,:#-.$/+%*=^",Me.EXP900=wn()?Zi():[],Me.NUMBER_OF_SEQUENCE_CODEWORDS=2;class bt{constructor(){}static decode(t,s,r,a,i,o,d){let h=new gr(t,s,r,a,i),m=null,y=null,T;for(let ce=!0;;ce=!1){if(s!=null&&(m=bt.getRowIndicatorColumn(t,h,s,!0,o,d)),a!=null&&(y=bt.getRowIndicatorColumn(t,h,a,!1,o,d)),T=bt.merge(m,y),T==null)throw $.getNotFoundInstance();let ue=T.getBoundingBox();if(ce&&ue!=null&&(ue.getMinY()<h.getMinY()||ue.getMaxY()>h.getMaxY()))h=ue;else break}T.setBoundingBox(h);let z=T.getBarcodeColumnCount()+1;T.setDetectionResultColumn(0,m),T.setDetectionResultColumn(z,y);let Y=m!=null;for(let ce=1;ce<=z;ce++){let ue=Y?ce:z-ce;if(T.getDetectionResultColumn(ue)!==void 0)continue;let Se;ue===0||ue===z?Se=new fn(h,ue===0):Se=new Ur(h),T.setDetectionResultColumn(ue,Se);let ze=-1,We=ze;for(let $e=h.getMinY();$e<=h.getMaxY();$e++){if(ze=bt.getStartColumn(T,ue,$e,Y),ze<0||ze>h.getMaxX()){if(We===-1)continue;ze=We}let Ve=bt.detectCodeword(t,h.getMinX(),h.getMaxX(),Y,ze,$e,o,d);Ve!=null&&(Se.setCodeword($e,Ve),We=ze,o=Math.min(o,Ve.getWidth()),d=Math.max(d,Ve.getWidth()))}}return bt.createDecoderResult(T)}static merge(t,s){if(t==null&&s==null)return null;let r=bt.getBarcodeMetadata(t,s);if(r==null)return null;let a=gr.merge(bt.adjustBoundingBox(t),bt.adjustBoundingBox(s));return new qr(r,a)}static adjustBoundingBox(t){if(t==null)return null;let s=t.getRowHeights();if(s==null)return null;let r=bt.getMax(s),a=0;for(let d of s)if(a+=r-d,d>0)break;let i=t.getCodewords();for(let d=0;a>0&&i[d]==null;d++)a--;let o=0;for(let d=s.length-1;d>=0&&(o+=r-s[d],!(s[d]>0));d--);for(let d=i.length-1;o>0&&i[d]==null;d--)o--;return t.getBoundingBox().addMissingRows(a,o,t.isLeft())}static getMax(t){let s=-1;for(let r of t)s=Math.max(s,r);return s}static getBarcodeMetadata(t,s){let r;if(t==null||(r=t.getBarcodeMetadata())==null)return s==null?null:s.getBarcodeMetadata();let a;return s==null||(a=s.getBarcodeMetadata())==null?r:r.getColumnCount()!==a.getColumnCount()&&r.getErrorCorrectionLevel()!==a.getErrorCorrectionLevel()&&r.getRowCount()!==a.getRowCount()?null:r}static getRowIndicatorColumn(t,s,r,a,i,o){let d=new fn(s,a);for(let h=0;h<2;h++){let m=h===0?1:-1,y=Math.trunc(Math.trunc(r.getX()));for(let T=Math.trunc(Math.trunc(r.getY()));T<=s.getMaxY()&&T>=s.getMinY();T+=m){let z=bt.detectCodeword(t,0,t.getWidth(),a,y,T,i,o);z!=null&&(d.setCodeword(T,z),a?y=z.getStartX():y=z.getEndX())}}return d}static adjustCodewordCount(t,s){let r=s[0][1],a=r.getValue(),i=t.getBarcodeColumnCount()*t.getBarcodeRowCount()-bt.getNumberOfECCodeWords(t.getBarcodeECLevel());if(a.length===0){if(i<1||i>lt.MAX_CODEWORDS_IN_BARCODE)throw $.getNotFoundInstance();r.setValue(i)}else a[0]!==i&&r.setValue(i)}static createDecoderResult(t){let s=bt.createBarcodeMatrix(t);bt.adjustCodewordCount(t,s);let r=new Array,a=new Int32Array(t.getBarcodeRowCount()*t.getBarcodeColumnCount()),i=[],o=new Array;for(let h=0;h<t.getBarcodeRowCount();h++)for(let m=0;m<t.getBarcodeColumnCount();m++){let y=s[h][m+1].getValue(),T=h*t.getBarcodeColumnCount()+m;y.length===0?r.push(T):y.length===1?a[T]=y[0]:(o.push(T),i.push(y))}let d=new Array(i.length);for(let h=0;h<d.length;h++)d[h]=i[h];return bt.createDecoderResultFromAmbiguousValues(t.getBarcodeECLevel(),a,lt.toIntArray(r),lt.toIntArray(o),d)}static createDecoderResultFromAmbiguousValues(t,s,r,a,i){let o=new Int32Array(a.length),d=100;for(;d-- >0;){for(let h=0;h<o.length;h++)s[a[h]]=i[h][o[h]];try{return bt.decodeCodewords(s,t,r)}catch(h){if(!(h instanceof B))throw h}if(o.length===0)throw B.getChecksumInstance();for(let h=0;h<o.length;h++)if(o[h]<i[h].length-1){o[h]++;break}else if(o[h]=0,h===o.length-1)throw B.getChecksumInstance()}throw B.getChecksumInstance()}static createBarcodeMatrix(t){let s=Array.from({length:t.getBarcodeRowCount()},()=>new Array(t.getBarcodeColumnCount()+2));for(let a=0;a<s.length;a++)for(let i=0;i<s[a].length;i++)s[a][i]=new Vr;let r=0;for(let a of t.getDetectionResultColumns()){if(a!=null){for(let i of a.getCodewords())if(i!=null){let o=i.getRowNumber();if(o>=0){if(o>=s.length)continue;s[o][r].setValue(i.getValue())}}}r++}return s}static isValidBarcodeColumn(t,s){return s>=0&&s<=t.getBarcodeColumnCount()+1}static getStartColumn(t,s,r,a){let i=a?1:-1,o=null;if(bt.isValidBarcodeColumn(t,s-i)&&(o=t.getDetectionResultColumn(s-i).getCodeword(r)),o!=null)return a?o.getEndX():o.getStartX();if(o=t.getDetectionResultColumn(s).getCodewordNearby(r),o!=null)return a?o.getStartX():o.getEndX();if(bt.isValidBarcodeColumn(t,s-i)&&(o=t.getDetectionResultColumn(s-i).getCodewordNearby(r)),o!=null)return a?o.getEndX():o.getStartX();let d=0;for(;bt.isValidBarcodeColumn(t,s-i);){s-=i;for(let h of t.getDetectionResultColumn(s).getCodewords())if(h!=null)return(a?h.getEndX():h.getStartX())+i*d*(h.getEndX()-h.getStartX());d++}return a?t.getBoundingBox().getMinX():t.getBoundingBox().getMaxX()}static detectCodeword(t,s,r,a,i,o,d,h){i=bt.adjustCodewordStartColumn(t,s,r,a,i,o);let m=bt.getModuleBitCount(t,s,r,a,i,o);if(m==null)return null;let y,T=Ge.sum(m);if(a)y=i+T;else{for(let ce=0;ce<m.length/2;ce++){let ue=m[ce];m[ce]=m[m.length-1-ce],m[m.length-1-ce]=ue}y=i,i=y-T}if(!bt.checkCodewordSkew(T,d,h))return null;let z=fs.getDecodedValue(m),Y=lt.getCodeword(z);return Y===-1?null:new Hr(i,y,bt.getCodewordBucketNumber(z),Y)}static getModuleBitCount(t,s,r,a,i,o){let d=i,h=new Int32Array(8),m=0,y=a?1:-1,T=a;for(;(a?d<r:d>=s)&&m<h.length;)t.get(d,o)===T?(h[m]++,d+=y):(m++,T=!T);return m===h.length||d===(a?r:s)&&m===h.length-1?h:null}static getNumberOfECCodeWords(t){return 2<<t}static adjustCodewordStartColumn(t,s,r,a,i,o){let d=i,h=a?-1:1;for(let m=0;m<2;m++){for(;(a?d>=s:d<r)&&a===t.get(d,o);){if(Math.abs(i-d)>bt.CODEWORD_SKEW_SIZE)return i;d+=h}h=-h,a=!a}return d}static checkCodewordSkew(t,s,r){return s-bt.CODEWORD_SKEW_SIZE<=t&&t<=r+bt.CODEWORD_SKEW_SIZE}static decodeCodewords(t,s,r){if(t.length===0)throw _.getFormatInstance();let a=1<<s+1,i=bt.correctErrors(t,r,a);bt.verifyCodewordCount(t,a);let o=Me.decode(t,""+s);return o.setErrorsCorrected(i),o.setErasures(r.length),o}static correctErrors(t,s,r){if(s!=null&&s.length>r/2+bt.MAX_ERRORS||r<0||r>bt.MAX_EC_CODEWORDS)throw B.getChecksumInstance();return bt.errorCorrection.decode(t,r,s)}static verifyCodewordCount(t,s){if(t.length<4)throw _.getFormatInstance();let r=t[0];if(r>t.length)throw _.getFormatInstance();if(r===0)if(s<t.length)t[0]=t.length-s;else throw _.getFormatInstance()}static getBitCountForCodeword(t){let s=new Int32Array(8),r=0,a=s.length-1;for(;!((t&1)!==r&&(r=t&1,a--,a<0));)s[a]++,t>>=1;return s}static getCodewordBucketNumber(t){return t instanceof Int32Array?this.getCodewordBucketNumber_Int32Array(t):this.getCodewordBucketNumber_number(t)}static getCodewordBucketNumber_number(t){return bt.getCodewordBucketNumber(bt.getBitCountForCodeword(t))}static getCodewordBucketNumber_Int32Array(t){return(t[0]-t[2]+t[4]-t[6]+9)%9}static toString(t){let s=new Fr;for(let r=0;r<t.length;r++){s.format("Row %2d: ",r);for(let a=0;a<t[r].length;a++){let i=t[r][a];i.getValue().length===0?s.format("        ",null):s.format("%4d(%2d)",i.getValue()[0],i.getConfidence(i.getValue()[0]))}s.format("%n")}return s.toString()}}bt.CODEWORD_SKEW_SIZE=2,bt.MAX_ERRORS=3,bt.MAX_EC_CODEWORDS=512,bt.errorCorrection=new mn;class ns{decode(t,s=null){let r=ns.decode(t,s,!1);if(r==null||r.length===0||r[0]==null)throw $.getNotFoundInstance();return r[0]}decodeMultiple(t,s=null){try{return ns.decode(t,s,!0)}catch(r){throw r instanceof _||r instanceof B?$.getNotFoundInstance():r}}static decode(t,s,r){const a=new Array,i=gt.detectMultiple(t,s,r);for(const o of i.getPoints()){const d=bt.decode(i.getBits(),o[4],o[5],o[6],o[7],ns.getMinCodewordWidth(o),ns.getMaxCodewordWidth(o)),h=new V(d.getText(),d.getRawBytes(),void 0,o,ae.PDF_417);h.putMetadata(be.ERROR_CORRECTION_LEVEL,d.getECLevel());const m=d.getOther();m!=null&&h.putMetadata(be.PDF417_EXTRA_METADATA,m),a.push(h)}return a.map(o=>o)}static getMaxWidth(t,s){return t==null||s==null?0:Math.trunc(Math.abs(t.getX()-s.getX()))}static getMinWidth(t,s){return t==null||s==null?U.MAX_VALUE:Math.trunc(Math.abs(t.getX()-s.getX()))}static getMaxCodewordWidth(t){return Math.floor(Math.max(Math.max(ns.getMaxWidth(t[0],t[4]),ns.getMaxWidth(t[6],t[2])*lt.MODULES_IN_CODEWORD/lt.MODULES_IN_STOP_PATTERN),Math.max(ns.getMaxWidth(t[1],t[5]),ns.getMaxWidth(t[7],t[3])*lt.MODULES_IN_CODEWORD/lt.MODULES_IN_STOP_PATTERN)))}static getMinCodewordWidth(t){return Math.floor(Math.min(Math.min(ns.getMinWidth(t[0],t[4]),ns.getMinWidth(t[6],t[2])*lt.MODULES_IN_CODEWORD/lt.MODULES_IN_STOP_PATTERN),Math.min(ns.getMinWidth(t[1],t[5]),ns.getMinWidth(t[7],t[3])*lt.MODULES_IN_CODEWORD/lt.MODULES_IN_STOP_PATTERN)))}reset(){}}class da extends g{}da.kind="ReaderException";class yn{constructor(t,s){this.verbose=t===!0,s&&this.setHints(s)}decode(t,s){return s&&this.setHints(s),this.decodeInternal(t)}decodeWithState(t){return(this.readers===null||this.readers===void 0)&&this.setHints(null),this.decodeInternal(t)}setHints(t){this.hints=t;const s=!u(t)&&t.get(N.TRY_HARDER)===!0,r=u(t)?null:t.get(N.POSSIBLE_FORMATS),a=new Array;if(!u(r)){const i=r.some(o=>o===ae.UPC_A||o===ae.UPC_E||o===ae.EAN_13||o===ae.EAN_8||o===ae.CODABAR||o===ae.CODE_39||o===ae.CODE_93||o===ae.CODE_128||o===ae.ITF||o===ae.RSS_14||o===ae.RSS_EXPANDED);i&&!s&&a.push(new tr(t,this.verbose)),r.includes(ae.QR_CODE)&&a.push(new ss),r.includes(ae.DATA_MATRIX)&&a.push(new xe),r.includes(ae.AZTEC)&&a.push(new Ee),r.includes(ae.PDF_417)&&a.push(new ns),i&&s&&a.push(new tr(t,this.verbose))}a.length===0&&(s||a.push(new tr(t,this.verbose)),a.push(new ss),a.push(new xe),a.push(new Ee),a.push(new ns),s&&a.push(new tr(t,this.verbose))),this.readers=a}reset(){if(this.readers!==null)for(const t of this.readers)t.reset()}decodeInternal(t){if(this.readers===null)throw new da("No readers where selected, nothing can be read.");for(const s of this.readers)try{return s.decode(t,this.hints)}catch(r){if(r instanceof da)continue}throw new $("No MultiFormat Readers were able to detect the code.")}}class Qi extends Q{constructor(t=null,s=500){const r=new yn;r.setHints(t),super(r,s)}decodeBitmap(t){return this.reader.decodeWithState(t)}}class Ki extends Q{constructor(t=500){super(new ns,t)}}class Ji extends Q{constructor(t=500){super(new ss,t)}}var Oa;(function(A){A[A.ERROR_CORRECTION=0]="ERROR_CORRECTION",A[A.CHARACTER_SET=1]="CHARACTER_SET",A[A.DATA_MATRIX_SHAPE=2]="DATA_MATRIX_SHAPE",A[A.MIN_SIZE=3]="MIN_SIZE",A[A.MAX_SIZE=4]="MAX_SIZE",A[A.MARGIN=5]="MARGIN",A[A.PDF417_COMPACT=6]="PDF417_COMPACT",A[A.PDF417_COMPACTION=7]="PDF417_COMPACTION",A[A.PDF417_DIMENSIONS=8]="PDF417_DIMENSIONS",A[A.AZTEC_LAYERS=9]="AZTEC_LAYERS",A[A.QR_VERSION=10]="QR_VERSION"})(Oa||(Oa={}));var Qt=Oa;class Ra{constructor(t){this.field=t,this.cachedGenerators=[],this.cachedGenerators.push(new Ne(t,Int32Array.from([1])))}buildGenerator(t){const s=this.cachedGenerators;if(t>=s.length){let r=s[s.length-1];const a=this.field;for(let i=s.length;i<=t;i++){const o=r.multiply(new Ne(a,Int32Array.from([1,a.exp(i-1+a.getGeneratorBase())])));s.push(o),r=o}}return s[t]}encode(t,s){if(s===0)throw new p("No error correction bytes");const r=t.length-s;if(r<=0)throw new p("No data bytes provided");const a=this.buildGenerator(s),i=new Int32Array(r);R.arraycopy(t,0,i,0,r);let o=new Ne(this.field,i);o=o.multiplyByMonomial(s,1);const h=o.divide(a)[1].getCoefficients(),m=s-h.length;for(let y=0;y<m;y++)t[r+y]=0;R.arraycopy(h,0,t,r+m,h.length)}}class Gt{constructor(){}static applyMaskPenaltyRule1(t){return Gt.applyMaskPenaltyRule1Internal(t,!0)+Gt.applyMaskPenaltyRule1Internal(t,!1)}static applyMaskPenaltyRule2(t){let s=0;const r=t.getArray(),a=t.getWidth(),i=t.getHeight();for(let o=0;o<i-1;o++){const d=r[o];for(let h=0;h<a-1;h++){const m=d[h];m===d[h+1]&&m===r[o+1][h]&&m===r[o+1][h+1]&&s++}}return Gt.N2*s}static applyMaskPenaltyRule3(t){let s=0;const r=t.getArray(),a=t.getWidth(),i=t.getHeight();for(let o=0;o<i;o++)for(let d=0;d<a;d++){const h=r[o];d+6<a&&h[d]===1&&h[d+1]===0&&h[d+2]===1&&h[d+3]===1&&h[d+4]===1&&h[d+5]===0&&h[d+6]===1&&(Gt.isWhiteHorizontal(h,d-4,d)||Gt.isWhiteHorizontal(h,d+7,d+11))&&s++,o+6<i&&r[o][d]===1&&r[o+1][d]===0&&r[o+2][d]===1&&r[o+3][d]===1&&r[o+4][d]===1&&r[o+5][d]===0&&r[o+6][d]===1&&(Gt.isWhiteVertical(r,d,o-4,o)||Gt.isWhiteVertical(r,d,o+7,o+11))&&s++}return s*Gt.N3}static isWhiteHorizontal(t,s,r){s=Math.max(s,0),r=Math.min(r,t.length);for(let a=s;a<r;a++)if(t[a]===1)return!1;return!0}static isWhiteVertical(t,s,r,a){r=Math.max(r,0),a=Math.min(a,t.length);for(let i=r;i<a;i++)if(t[i][s]===1)return!1;return!0}static applyMaskPenaltyRule4(t){let s=0;const r=t.getArray(),a=t.getWidth(),i=t.getHeight();for(let h=0;h<i;h++){const m=r[h];for(let y=0;y<a;y++)m[y]===1&&s++}const o=t.getHeight()*t.getWidth();return Math.floor(Math.abs(s*2-o)*10/o)*Gt.N4}static getDataMaskBit(t,s,r){let a,i;switch(t){case 0:a=r+s&1;break;case 1:a=r&1;break;case 2:a=s%3;break;case 3:a=(r+s)%3;break;case 4:a=Math.floor(r/2)+Math.floor(s/3)&1;break;case 5:i=r*s,a=(i&1)+i%3;break;case 6:i=r*s,a=(i&1)+i%3&1;break;case 7:i=r*s,a=i%3+(r+s&1)&1;break;default:throw new p("Invalid mask pattern: "+t)}return a===0}static applyMaskPenaltyRule1Internal(t,s){let r=0;const a=s?t.getHeight():t.getWidth(),i=s?t.getWidth():t.getHeight(),o=t.getArray();for(let d=0;d<a;d++){let h=0,m=-1;for(let y=0;y<i;y++){const T=s?o[d][y]:o[y][d];T===m?h++:(h>=5&&(r+=Gt.N1+(h-5)),h=1,m=T)}h>=5&&(r+=Gt.N1+(h-5))}return r}}Gt.N1=3,Gt.N2=3,Gt.N3=40,Gt.N4=10;class ua{constructor(t,s){this.width=t,this.height=s;const r=new Array(s);for(let a=0;a!==s;a++)r[a]=new Uint8Array(t);this.bytes=r}getHeight(){return this.height}getWidth(){return this.width}get(t,s){return this.bytes[s][t]}getArray(){return this.bytes}setNumber(t,s,r){this.bytes[s][t]=r}setBoolean(t,s,r){this.bytes[s][t]=r?1:0}clear(t){for(const s of this.bytes)E.fill(s,t)}equals(t){if(!(t instanceof ua))return!1;const s=t;if(this.width!==s.width||this.height!==s.height)return!1;for(let r=0,a=this.height;r<a;++r){const i=this.bytes[r],o=s.bytes[r];for(let d=0,h=this.width;d<h;++d)if(i[d]!==o[d])return!1}return!0}toString(){const t=new se;for(let s=0,r=this.height;s<r;++s){const a=this.bytes[s];for(let i=0,o=this.width;i<o;++i)switch(a[i]){case 0:t.append(" 0");break;case 1:t.append(" 1");break;default:t.append("  ");break}t.append(`
`)}return t.toString()}}class pr{constructor(){this.maskPattern=-1}getMode(){return this.mode}getECLevel(){return this.ecLevel}getVersion(){return this.version}getMaskPattern(){return this.maskPattern}getMatrix(){return this.matrix}toString(){const t=new se;return t.append(`<<
`),t.append(" mode: "),t.append(this.mode?this.mode.toString():"null"),t.append(`
 ecLevel: `),t.append(this.ecLevel?this.ecLevel.toString():"null"),t.append(`
 version: `),t.append(this.version?this.version.toString():"null"),t.append(`
 maskPattern: `),t.append(this.maskPattern.toString()),this.matrix?(t.append(`
 matrix:
`),t.append(this.matrix.toString())):t.append(`
 matrix: null
`),t.append(`>>
`),t.toString()}setMode(t){this.mode=t}setECLevel(t){this.ecLevel=t}setVersion(t){this.version=t}setMaskPattern(t){this.maskPattern=t}setMatrix(t){this.matrix=t}static isValidMaskPattern(t){return t>=0&&t<pr.NUM_MASK_PATTERNS}}pr.NUM_MASK_PATTERNS=8;class kt extends g{}kt.kind="WriterException";class ot{constructor(){}static clearMatrix(t){t.clear(255)}static buildMatrix(t,s,r,a,i){ot.clearMatrix(i),ot.embedBasicPatterns(r,i),ot.embedTypeInfo(s,a,i),ot.maybeEmbedVersionInfo(r,i),ot.embedDataBits(t,a,i)}static embedBasicPatterns(t,s){ot.embedPositionDetectionPatternsAndSeparators(s),ot.embedDarkDotAtLeftBottomCorner(s),ot.maybeEmbedPositionAdjustmentPatterns(t,s),ot.embedTimingPatterns(s)}static embedTypeInfo(t,s,r){const a=new q;ot.makeTypeInfoBits(t,s,a);for(let i=0,o=a.getSize();i<o;++i){const d=a.get(a.getSize()-1-i),h=ot.TYPE_INFO_COORDINATES[i],m=h[0],y=h[1];if(r.setBoolean(m,y,d),i<8){const T=r.getWidth()-i-1;r.setBoolean(T,8,d)}else{const z=r.getHeight()-7+(i-8);r.setBoolean(8,z,d)}}}static maybeEmbedVersionInfo(t,s){if(t.getVersionNumber()<7)return;const r=new q;ot.makeVersionInfoBits(t,r);let a=6*3-1;for(let i=0;i<6;++i)for(let o=0;o<3;++o){const d=r.get(a);a--,s.setBoolean(i,s.getHeight()-11+o,d),s.setBoolean(s.getHeight()-11+o,i,d)}}static embedDataBits(t,s,r){let a=0,i=-1,o=r.getWidth()-1,d=r.getHeight()-1;for(;o>0;){for(o===6&&(o-=1);d>=0&&d<r.getHeight();){for(let h=0;h<2;++h){const m=o-h;if(!ot.isEmpty(r.get(m,d)))continue;let y;a<t.getSize()?(y=t.get(a),++a):y=!1,s!==255&&Gt.getDataMaskBit(s,m,d)&&(y=!y),r.setBoolean(m,d,y)}d+=i}i=-i,d+=i,o-=2}if(a!==t.getSize())throw new kt("Not all bits consumed: "+a+"/"+t.getSize())}static findMSBSet(t){return 32-U.numberOfLeadingZeros(t)}static calculateBCHCode(t,s){if(s===0)throw new p("0 polynomial");const r=ot.findMSBSet(s);for(t<<=r-1;ot.findMSBSet(t)>=r;)t^=s<<ot.findMSBSet(t)-r;return t}static makeTypeInfoBits(t,s,r){if(!pr.isValidMaskPattern(s))throw new kt("Invalid mask pattern");const a=t.getBits()<<3|s;r.appendBits(a,5);const i=ot.calculateBCHCode(a,ot.TYPE_INFO_POLY);r.appendBits(i,10);const o=new q;if(o.appendBits(ot.TYPE_INFO_MASK_PATTERN,15),r.xor(o),r.getSize()!==15)throw new kt("should not happen but we got: "+r.getSize())}static makeVersionInfoBits(t,s){s.appendBits(t.getVersionNumber(),6);const r=ot.calculateBCHCode(t.getVersionNumber(),ot.VERSION_INFO_POLY);if(s.appendBits(r,12),s.getSize()!==18)throw new kt("should not happen but we got: "+s.getSize())}static isEmpty(t){return t===255}static embedTimingPatterns(t){for(let s=8;s<t.getWidth()-8;++s){const r=(s+1)%2;ot.isEmpty(t.get(s,6))&&t.setNumber(s,6,r),ot.isEmpty(t.get(6,s))&&t.setNumber(6,s,r)}}static embedDarkDotAtLeftBottomCorner(t){if(t.get(8,t.getHeight()-8)===0)throw new kt;t.setNumber(8,t.getHeight()-8,1)}static embedHorizontalSeparationPattern(t,s,r){for(let a=0;a<8;++a){if(!ot.isEmpty(r.get(t+a,s)))throw new kt;r.setNumber(t+a,s,0)}}static embedVerticalSeparationPattern(t,s,r){for(let a=0;a<7;++a){if(!ot.isEmpty(r.get(t,s+a)))throw new kt;r.setNumber(t,s+a,0)}}static embedPositionAdjustmentPattern(t,s,r){for(let a=0;a<5;++a){const i=ot.POSITION_ADJUSTMENT_PATTERN[a];for(let o=0;o<5;++o)r.setNumber(t+o,s+a,i[o])}}static embedPositionDetectionPattern(t,s,r){for(let a=0;a<7;++a){const i=ot.POSITION_DETECTION_PATTERN[a];for(let o=0;o<7;++o)r.setNumber(t+o,s+a,i[o])}}static embedPositionDetectionPatternsAndSeparators(t){const s=ot.POSITION_DETECTION_PATTERN[0].length;ot.embedPositionDetectionPattern(0,0,t),ot.embedPositionDetectionPattern(t.getWidth()-s,0,t),ot.embedPositionDetectionPattern(0,t.getWidth()-s,t);const r=8;ot.embedHorizontalSeparationPattern(0,r-1,t),ot.embedHorizontalSeparationPattern(t.getWidth()-r,r-1,t),ot.embedHorizontalSeparationPattern(0,t.getWidth()-r,t);const a=7;ot.embedVerticalSeparationPattern(a,0,t),ot.embedVerticalSeparationPattern(t.getHeight()-a-1,0,t),ot.embedVerticalSeparationPattern(a,t.getHeight()-a,t)}static maybeEmbedPositionAdjustmentPatterns(t,s){if(t.getVersionNumber()<2)return;const r=t.getVersionNumber()-1,a=ot.POSITION_ADJUSTMENT_PATTERN_COORDINATE_TABLE[r];for(let i=0,o=a.length;i!==o;i++){const d=a[i];if(d>=0)for(let h=0;h!==o;h++){const m=a[h];m>=0&&ot.isEmpty(s.get(m,d))&&ot.embedPositionAdjustmentPattern(m-2,d-2,s)}}}}ot.POSITION_DETECTION_PATTERN=Array.from([Int32Array.from([1,1,1,1,1,1,1]),Int32Array.from([1,0,0,0,0,0,1]),Int32Array.from([1,0,1,1,1,0,1]),Int32Array.from([1,0,1,1,1,0,1]),Int32Array.from([1,0,1,1,1,0,1]),Int32Array.from([1,0,0,0,0,0,1]),Int32Array.from([1,1,1,1,1,1,1])]),ot.POSITION_ADJUSTMENT_PATTERN=Array.from([Int32Array.from([1,1,1,1,1]),Int32Array.from([1,0,0,0,1]),Int32Array.from([1,0,1,0,1]),Int32Array.from([1,0,0,0,1]),Int32Array.from([1,1,1,1,1])]),ot.POSITION_ADJUSTMENT_PATTERN_COORDINATE_TABLE=Array.from([Int32Array.from([-1,-1,-1,-1,-1,-1,-1]),Int32Array.from([6,18,-1,-1,-1,-1,-1]),Int32Array.from([6,22,-1,-1,-1,-1,-1]),Int32Array.from([6,26,-1,-1,-1,-1,-1]),Int32Array.from([6,30,-1,-1,-1,-1,-1]),Int32Array.from([6,34,-1,-1,-1,-1,-1]),Int32Array.from([6,22,38,-1,-1,-1,-1]),Int32Array.from([6,24,42,-1,-1,-1,-1]),Int32Array.from([6,26,46,-1,-1,-1,-1]),Int32Array.from([6,28,50,-1,-1,-1,-1]),Int32Array.from([6,30,54,-1,-1,-1,-1]),Int32Array.from([6,32,58,-1,-1,-1,-1]),Int32Array.from([6,34,62,-1,-1,-1,-1]),Int32Array.from([6,26,46,66,-1,-1,-1]),Int32Array.from([6,26,48,70,-1,-1,-1]),Int32Array.from([6,26,50,74,-1,-1,-1]),Int32Array.from([6,30,54,78,-1,-1,-1]),Int32Array.from([6,30,56,82,-1,-1,-1]),Int32Array.from([6,30,58,86,-1,-1,-1]),Int32Array.from([6,34,62,90,-1,-1,-1]),Int32Array.from([6,28,50,72,94,-1,-1]),Int32Array.from([6,26,50,74,98,-1,-1]),Int32Array.from([6,30,54,78,102,-1,-1]),Int32Array.from([6,28,54,80,106,-1,-1]),Int32Array.from([6,32,58,84,110,-1,-1]),Int32Array.from([6,30,58,86,114,-1,-1]),Int32Array.from([6,34,62,90,118,-1,-1]),Int32Array.from([6,26,50,74,98,122,-1]),Int32Array.from([6,30,54,78,102,126,-1]),Int32Array.from([6,26,52,78,104,130,-1]),Int32Array.from([6,30,56,82,108,134,-1]),Int32Array.from([6,34,60,86,112,138,-1]),Int32Array.from([6,30,58,86,114,142,-1]),Int32Array.from([6,34,62,90,118,146,-1]),Int32Array.from([6,30,54,78,102,126,150]),Int32Array.from([6,24,50,76,102,128,154]),Int32Array.from([6,28,54,80,106,132,158]),Int32Array.from([6,32,58,84,110,136,162]),Int32Array.from([6,26,54,82,110,138,166]),Int32Array.from([6,30,58,86,114,142,170])]),ot.TYPE_INFO_COORDINATES=Array.from([Int32Array.from([8,0]),Int32Array.from([8,1]),Int32Array.from([8,2]),Int32Array.from([8,3]),Int32Array.from([8,4]),Int32Array.from([8,5]),Int32Array.from([8,7]),Int32Array.from([8,8]),Int32Array.from([7,8]),Int32Array.from([5,8]),Int32Array.from([4,8]),Int32Array.from([3,8]),Int32Array.from([2,8]),Int32Array.from([1,8]),Int32Array.from([0,8])]),ot.VERSION_INFO_POLY=7973,ot.TYPE_INFO_POLY=1335,ot.TYPE_INFO_MASK_PATTERN=21522;class eo{constructor(t,s){this.dataBytes=t,this.errorCorrectionBytes=s}getDataBytes(){return this.dataBytes}getErrorCorrectionBytes(){return this.errorCorrectionBytes}}class Bt{constructor(){}static calculateMaskPenalty(t){return Gt.applyMaskPenaltyRule1(t)+Gt.applyMaskPenaltyRule2(t)+Gt.applyMaskPenaltyRule3(t)+Gt.applyMaskPenaltyRule4(t)}static encode(t,s,r=null){let a=Bt.DEFAULT_BYTE_MODE_ENCODING;const i=r!==null&&r.get(Qt.CHARACTER_SET)!==void 0;i&&(a=r.get(Qt.CHARACTER_SET).toString());const o=this.chooseMode(t,a),d=new q;if(o===tt.BYTE&&(i||Bt.DEFAULT_BYTE_MODE_ENCODING!==a)){const $e=I.getCharacterSetECIByName(a);$e!==void 0&&this.appendECI($e,d)}this.appendModeInfo(o,d);const h=new q;this.appendBytes(t,o,h,a);let m;if(r!==null&&r.get(Qt.QR_VERSION)!==void 0){const $e=Number.parseInt(r.get(Qt.QR_VERSION).toString(),10);m=He.getVersionForNumber($e);const Ve=this.calculateBitsNeeded(o,d,h,m);if(!this.willFit(Ve,m,s))throw new kt("Data too big for requested version")}else m=this.recommendVersion(s,o,d,h);const y=new q;y.appendBitArray(d);const T=o===tt.BYTE?h.getSizeInBytes():t.length;this.appendLengthInfo(T,m,o,y),y.appendBitArray(h);const z=m.getECBlocksForLevel(s),Y=m.getTotalCodewords()-z.getTotalECCodewords();this.terminateBits(Y,y);const ce=this.interleaveWithECBytes(y,m.getTotalCodewords(),Y,z.getNumBlocks()),ue=new pr;ue.setECLevel(s),ue.setMode(o),ue.setVersion(m);const Se=m.getDimensionForVersion(),ze=new ua(Se,Se),We=this.chooseMaskPattern(ce,s,m,ze);return ue.setMaskPattern(We),ot.buildMatrix(ce,s,m,We,ze),ue.setMatrix(ze),ue}static recommendVersion(t,s,r,a){const i=this.calculateBitsNeeded(s,r,a,He.getVersionForNumber(1)),o=this.chooseVersion(i,t),d=this.calculateBitsNeeded(s,r,a,o);return this.chooseVersion(d,t)}static calculateBitsNeeded(t,s,r,a){return s.getSize()+t.getCharacterCountBits(a)+r.getSize()}static getAlphanumericCode(t){return t<Bt.ALPHANUMERIC_TABLE.length?Bt.ALPHANUMERIC_TABLE[t]:-1}static chooseMode(t,s=null){if(I.SJIS.getName()===s&&this.isOnlyDoubleByteKanji(t))return tt.KANJI;let r=!1,a=!1;for(let i=0,o=t.length;i<o;++i){const d=t.charAt(i);if(Bt.isDigit(d))r=!0;else if(this.getAlphanumericCode(d.charCodeAt(0))!==-1)a=!0;else return tt.BYTE}return a?tt.ALPHANUMERIC:r?tt.NUMERIC:tt.BYTE}static isOnlyDoubleByteKanji(t){let s;try{s=O.encode(t,I.SJIS)}catch{return!1}const r=s.length;if(r%2!==0)return!1;for(let a=0;a<r;a+=2){const i=s[a]&255;if((i<129||i>159)&&(i<224||i>235))return!1}return!0}static chooseMaskPattern(t,s,r,a){let i=Number.MAX_SAFE_INTEGER,o=-1;for(let d=0;d<pr.NUM_MASK_PATTERNS;d++){ot.buildMatrix(t,s,r,d,a);let h=this.calculateMaskPenalty(a);h<i&&(i=h,o=d)}return o}static chooseVersion(t,s){for(let r=1;r<=40;r++){const a=He.getVersionForNumber(r);if(Bt.willFit(t,a,s))return a}throw new kt("Data too big")}static willFit(t,s,r){const a=s.getTotalCodewords(),o=s.getECBlocksForLevel(r).getTotalECCodewords(),d=a-o,h=(t+7)/8;return d>=h}static terminateBits(t,s){const r=t*8;if(s.getSize()>r)throw new kt("data bits cannot fit in the QR Code"+s.getSize()+" > "+r);for(let o=0;o<4&&s.getSize()<r;++o)s.appendBit(!1);const a=s.getSize()&7;if(a>0)for(let o=a;o<8;o++)s.appendBit(!1);const i=t-s.getSizeInBytes();for(let o=0;o<i;++o)s.appendBits(o&1?17:236,8);if(s.getSize()!==r)throw new kt("Bits size does not equal capacity")}static getNumDataBytesAndNumECBytesForBlockID(t,s,r,a,i,o){if(a>=r)throw new kt("Block ID too large");const d=t%r,h=r-d,m=Math.floor(t/r),y=m+1,T=Math.floor(s/r),z=T+1,Y=m-T,ce=y-z;if(Y!==ce)throw new kt("EC bytes mismatch");if(r!==h+d)throw new kt("RS blocks mismatch");if(t!==(T+Y)*h+(z+ce)*d)throw new kt("Total bytes mismatch");a<h?(i[0]=T,o[0]=Y):(i[0]=z,o[0]=ce)}static interleaveWithECBytes(t,s,r,a){if(t.getSizeInBytes()!==r)throw new kt("Number of bits and data bytes does not match");let i=0,o=0,d=0;const h=new Array;for(let y=0;y<a;++y){const T=new Int32Array(1),z=new Int32Array(1);Bt.getNumDataBytesAndNumECBytesForBlockID(s,r,a,y,T,z);const Y=T[0],ce=new Uint8Array(Y);t.toBytes(8*i,ce,0,Y);const ue=Bt.generateECBytes(ce,z[0]);h.push(new eo(ce,ue)),o=Math.max(o,Y),d=Math.max(d,ue.length),i+=T[0]}if(r!==i)throw new kt("Data bytes does not match offset");const m=new q;for(let y=0;y<o;++y)for(const T of h){const z=T.getDataBytes();y<z.length&&m.appendBits(z[y],8)}for(let y=0;y<d;++y)for(const T of h){const z=T.getErrorCorrectionBytes();y<z.length&&m.appendBits(z[y],8)}if(s!==m.getSizeInBytes())throw new kt("Interleaving error: "+s+" and "+m.getSizeInBytes()+" differ.");return m}static generateECBytes(t,s){const r=t.length,a=new Int32Array(r+s);for(let o=0;o<r;o++)a[o]=t[o]&255;new Ra(Ue.QR_CODE_FIELD_256).encode(a,s);const i=new Uint8Array(s);for(let o=0;o<s;o++)i[o]=a[r+o];return i}static appendModeInfo(t,s){s.appendBits(t.getBits(),4)}static appendLengthInfo(t,s,r,a){const i=r.getCharacterCountBits(s);if(t>=1<<i)throw new kt(t+" is bigger than "+((1<<i)-1));a.appendBits(t,i)}static appendBytes(t,s,r,a){switch(s){case tt.NUMERIC:Bt.appendNumericBytes(t,r);break;case tt.ALPHANUMERIC:Bt.appendAlphanumericBytes(t,r);break;case tt.BYTE:Bt.append8BitBytes(t,r,a);break;case tt.KANJI:Bt.appendKanjiBytes(t,r);break;default:throw new kt("Invalid mode: "+s)}}static getDigit(t){return t.charCodeAt(0)-48}static isDigit(t){const s=Bt.getDigit(t);return s>=0&&s<=9}static appendNumericBytes(t,s){const r=t.length;let a=0;for(;a<r;){const i=Bt.getDigit(t.charAt(a));if(a+2<r){const o=Bt.getDigit(t.charAt(a+1)),d=Bt.getDigit(t.charAt(a+2));s.appendBits(i*100+o*10+d,10),a+=3}else if(a+1<r){const o=Bt.getDigit(t.charAt(a+1));s.appendBits(i*10+o,7),a+=2}else s.appendBits(i,4),a++}}static appendAlphanumericBytes(t,s){const r=t.length;let a=0;for(;a<r;){const i=Bt.getAlphanumericCode(t.charCodeAt(a));if(i===-1)throw new kt;if(a+1<r){const o=Bt.getAlphanumericCode(t.charCodeAt(a+1));if(o===-1)throw new kt;s.appendBits(i*45+o,11),a+=2}else s.appendBits(i,6),a++}}static append8BitBytes(t,s,r){let a;try{a=O.encode(t,r)}catch(i){throw new kt(i)}for(let i=0,o=a.length;i!==o;i++){const d=a[i];s.appendBits(d,8)}}static appendKanjiBytes(t,s){let r;try{r=O.encode(t,I.SJIS)}catch(i){throw new kt(i)}const a=r.length;for(let i=0;i<a;i+=2){const o=r[i]&255,d=r[i+1]&255,h=o<<8&4294967295|d;let m=-1;if(h>=33088&&h<=40956?m=h-33088:h>=57408&&h<=60351&&(m=h-49472),m===-1)throw new kt("Invalid byte sequence");const y=(m>>8)*192+(m&255);s.appendBits(y,13)}}static appendECI(t,s){s.appendBits(tt.ECI.getBits(),4),s.appendBits(t.getValue(),8)}}Bt.ALPHANUMERIC_TABLE=Int32Array.from([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,36,-1,-1,-1,37,38,-1,-1,-1,-1,39,40,-1,41,42,43,0,1,2,3,4,5,6,7,8,9,44,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,-1,-1,-1,-1,-1]),Bt.DEFAULT_BYTE_MODE_ENCODING=I.UTF8.getName();class br{write(t,s,r,a=null){if(t.length===0)throw new p("Found empty contents");if(s<0||r<0)throw new p("Requested dimensions are too small: "+s+"x"+r);let i=Pe.L,o=br.QUIET_ZONE_SIZE;a!==null&&(a.get(Qt.ERROR_CORRECTION)!==void 0&&(i=Pe.fromString(a.get(Qt.ERROR_CORRECTION).toString())),a.get(Qt.MARGIN)!==void 0&&(o=Number.parseInt(a.get(Qt.MARGIN).toString(),10)));const d=Bt.encode(t,i,a);return this.renderResult(d,s,r,o)}writeToDom(t,s,r,a,i=null){typeof t=="string"&&(t=document.querySelector(t));const o=this.write(s,r,a,i);t&&t.appendChild(o)}renderResult(t,s,r,a){const i=t.getMatrix();if(i===null)throw new rt;const o=i.getWidth(),d=i.getHeight(),h=o+a*2,m=d+a*2,y=Math.max(s,h),T=Math.max(r,m),z=Math.min(Math.floor(y/h),Math.floor(T/m)),Y=Math.floor((y-o*z)/2),ce=Math.floor((T-d*z)/2),ue=this.createSVGElement(y,T);for(let Se=0,ze=ce;Se<d;Se++,ze+=z)for(let We=0,$e=Y;We<o;We++,$e+=z)if(i.get(We,Se)===1){const Ve=this.createSvgRectElement($e,ze,z,z);ue.appendChild(Ve)}return ue}createSVGElement(t,s){const r=document.createElementNS(br.SVG_NS,"svg");return r.setAttributeNS(null,"height",t.toString()),r.setAttributeNS(null,"width",s.toString()),r}createSvgRectElement(t,s,r,a){const i=document.createElementNS(br.SVG_NS,"rect");return i.setAttributeNS(null,"x",t.toString()),i.setAttributeNS(null,"y",s.toString()),i.setAttributeNS(null,"height",r.toString()),i.setAttributeNS(null,"width",a.toString()),i.setAttributeNS(null,"fill","#000000"),i}}br.QUIET_ZONE_SIZE=4,br.SVG_NS="http://www.w3.org/2000/svg";class jr{encode(t,s,r,a,i){if(t.length===0)throw new p("Found empty contents");if(s!==ae.QR_CODE)throw new p("Can only encode QR_CODE, but got "+s);if(r<0||a<0)throw new p(`Requested dimensions are too small: ${r}x${a}`);let o=Pe.L,d=jr.QUIET_ZONE_SIZE;i!==null&&(i.get(Qt.ERROR_CORRECTION)!==void 0&&(o=Pe.fromString(i.get(Qt.ERROR_CORRECTION).toString())),i.get(Qt.MARGIN)!==void 0&&(d=Number.parseInt(i.get(Qt.MARGIN).toString(),10)));const h=Bt.encode(t,o,i);return jr.renderResult(h,r,a,d)}static renderResult(t,s,r,a){const i=t.getMatrix();if(i===null)throw new rt;const o=i.getWidth(),d=i.getHeight(),h=o+a*2,m=d+a*2,y=Math.max(s,h),T=Math.max(r,m),z=Math.min(Math.floor(y/h),Math.floor(T/m)),Y=Math.floor((y-o*z)/2),ce=Math.floor((T-d*z)/2),ue=new G(y,T);for(let Se=0,ze=ce;Se<d;Se++,ze+=z)for(let We=0,$e=Y;We<o;We++,$e+=z)i.get(We,Se)===1&&ue.setRegion($e,ze,z,z);return ue}}jr.QUIET_ZONE_SIZE=4;class to{encode(t,s,r,a,i){let o;switch(s){case ae.QR_CODE:o=new jr;break;default:throw new p("No encoder available for format "+s)}return o.encode(t,s,r,a,i)}}class Hs extends _e{constructor(t,s,r,a,i,o,d,h){if(super(o,d),this.yuvData=t,this.dataWidth=s,this.dataHeight=r,this.left=a,this.top=i,a+o>s||i+d>r)throw new p("Crop rectangle does not fit within image data.");h&&this.reverseHorizontal(o,d)}getRow(t,s){if(t<0||t>=this.getHeight())throw new p("Requested row is outside the image: "+t);const r=this.getWidth();(s==null||s.length<r)&&(s=new Uint8ClampedArray(r));const a=(t+this.top)*this.dataWidth+this.left;return R.arraycopy(this.yuvData,a,s,0,r),s}getMatrix(){const t=this.getWidth(),s=this.getHeight();if(t===this.dataWidth&&s===this.dataHeight)return this.yuvData;const r=t*s,a=new Uint8ClampedArray(r);let i=this.top*this.dataWidth+this.left;if(t===this.dataWidth)return R.arraycopy(this.yuvData,i,a,0,r),a;for(let o=0;o<s;o++){const d=o*t;R.arraycopy(this.yuvData,i,a,d,t),i+=this.dataWidth}return a}isCropSupported(){return!0}crop(t,s,r,a){return new Hs(this.yuvData,this.dataWidth,this.dataHeight,this.left+t,this.top+s,r,a,!1)}renderThumbnail(){const t=this.getWidth()/Hs.THUMBNAIL_SCALE_FACTOR,s=this.getHeight()/Hs.THUMBNAIL_SCALE_FACTOR,r=new Int32Array(t*s),a=this.yuvData;let i=this.top*this.dataWidth+this.left;for(let o=0;o<s;o++){const d=o*t;for(let h=0;h<t;h++){const m=a[i+h*Hs.THUMBNAIL_SCALE_FACTOR]&255;r[d+h]=4278190080|m*65793}i+=this.dataWidth*Hs.THUMBNAIL_SCALE_FACTOR}return r}getThumbnailWidth(){return this.getWidth()/Hs.THUMBNAIL_SCALE_FACTOR}getThumbnailHeight(){return this.getHeight()/Hs.THUMBNAIL_SCALE_FACTOR}reverseHorizontal(t,s){const r=this.yuvData;for(let a=0,i=this.top*this.dataWidth+this.left;a<s;a++,i+=this.dataWidth){const o=i+t/2;for(let d=i,h=i+t-1;d<o;d++,h--){const m=r[d];r[d]=r[h],r[h]=m}}}invert(){return new ge(this)}}Hs.THUMBNAIL_SCALE_FACTOR=2;class La extends _e{constructor(t,s,r,a,i,o,d){if(super(s,r),this.dataWidth=a,this.dataHeight=i,this.left=o,this.top=d,t.BYTES_PER_ELEMENT===4){const h=s*r,m=new Uint8ClampedArray(h);for(let y=0;y<h;y++){const T=t[y],z=T>>16&255,Y=T>>7&510,ce=T&255;m[y]=(z+Y+ce)/4&255}this.luminances=m}else this.luminances=t;if(a===void 0&&(this.dataWidth=s),i===void 0&&(this.dataHeight=r),o===void 0&&(this.left=0),d===void 0&&(this.top=0),this.left+s>this.dataWidth||this.top+r>this.dataHeight)throw new p("Crop rectangle does not fit within image data.")}getRow(t,s){if(t<0||t>=this.getHeight())throw new p("Requested row is outside the image: "+t);const r=this.getWidth();(s==null||s.length<r)&&(s=new Uint8ClampedArray(r));const a=(t+this.top)*this.dataWidth+this.left;return R.arraycopy(this.luminances,a,s,0,r),s}getMatrix(){const t=this.getWidth(),s=this.getHeight();if(t===this.dataWidth&&s===this.dataHeight)return this.luminances;const r=t*s,a=new Uint8ClampedArray(r);let i=this.top*this.dataWidth+this.left;if(t===this.dataWidth)return R.arraycopy(this.luminances,i,a,0,r),a;for(let o=0;o<s;o++){const d=o*t;R.arraycopy(this.luminances,i,a,d,t),i+=this.dataWidth}return a}isCropSupported(){return!0}crop(t,s,r,a){return new La(this.luminances,r,a,this.dataWidth,this.dataHeight,this.left+t,this.top+s)}invert(){return new ge(this)}}class _n extends I{static forName(t){return this.getCharacterSetECIByName(t)}}class Pa{}Pa.ISO_8859_1=I.ISO8859_1;class vn{isCompact(){return this.compact}setCompact(t){this.compact=t}getSize(){return this.size}setSize(t){this.size=t}getLayers(){return this.layers}setLayers(t){this.layers=t}getCodeWords(){return this.codeWords}setCodeWords(t){this.codeWords=t}getMatrix(){return this.matrix}setMatrix(t){this.matrix=t}}class Nn{static singletonList(t){return[t]}static min(t,s){return t.sort(s)[0]}}class so{constructor(t){this.previous=t}getPrevious(){return this.previous}}class Cr extends so{constructor(t,s,r){super(t),this.value=s,this.bitCount=r}appendTo(t,s){t.appendBits(this.value,this.bitCount)}add(t,s){return new Cr(this,t,s)}addBinaryShift(t,s){return console.warn("addBinaryShift on SimpleToken, this simply returns a copy of this token"),new Cr(this,t,s)}toString(){let t=this.value&(1<<this.bitCount)-1;return t|=1<<this.bitCount,"<"+U.toBinaryString(t|1<<this.bitCount).substring(1)+">"}}class Ba extends Cr{constructor(t,s,r){super(t,0,0),this.binaryShiftStart=s,this.binaryShiftByteCount=r}appendTo(t,s){for(let r=0;r<this.binaryShiftByteCount;r++)(r===0||r===31&&this.binaryShiftByteCount<=62)&&(t.appendBits(31,5),this.binaryShiftByteCount>62?t.appendBits(this.binaryShiftByteCount-31,16):r===0?t.appendBits(Math.min(this.binaryShiftByteCount,31),5):t.appendBits(this.binaryShiftByteCount-31,5)),t.appendBits(s[this.binaryShiftStart+r],8)}addBinaryShift(t,s){return new Ba(this,t,s)}toString(){return"<"+this.binaryShiftStart+"::"+(this.binaryShiftStart+this.binaryShiftByteCount-1)+">"}}function ro(A,t,s){return new Ba(A,t,s)}function Gr(A,t,s){return new Cr(A,t,s)}const ao=["UPPER","LOWER","DIGIT","MIXED","PUNCT"],ar=0,ha=1,Is=2,jn=3,Gs=4,no=new Cr(null,0,0),Fa=[Int32Array.from([0,(5<<16)+28,(5<<16)+30,(5<<16)+29,656318]),Int32Array.from([(9<<16)+480+14,0,(5<<16)+30,(5<<16)+29,656318]),Int32Array.from([(4<<16)+14,(9<<16)+448+28,0,(9<<16)+448+29,932798]),Int32Array.from([(5<<16)+29,(5<<16)+28,656318,0,(5<<16)+30]),Int32Array.from([(5<<16)+31,656380,656382,656381,0])];function io(A){for(let t of A)E.fill(t,-1);return A[ar][Gs]=0,A[ha][Gs]=0,A[ha][ar]=28,A[jn][Gs]=0,A[Is][Gs]=0,A[Is][ar]=15,A}const Cn=io(E.createInt32Array(6,6));class Ws{constructor(t,s,r,a){this.token=t,this.mode=s,this.binaryShiftByteCount=r,this.bitCount=a}getMode(){return this.mode}getToken(){return this.token}getBinaryShiftByteCount(){return this.binaryShiftByteCount}getBitCount(){return this.bitCount}latchAndAppend(t,s){let r=this.bitCount,a=this.token;if(t!==this.mode){let o=Fa[this.mode][t];a=Gr(a,o&65535,o>>16),r+=o>>16}let i=t===Is?4:5;return a=Gr(a,s,i),new Ws(a,t,0,r+i)}shiftAndAppend(t,s){let r=this.token,a=this.mode===Is?4:5;return r=Gr(r,Cn[this.mode][t],a),r=Gr(r,s,5),new Ws(r,this.mode,0,this.bitCount+a+5)}addBinaryShiftChar(t){let s=this.token,r=this.mode,a=this.bitCount;if(this.mode===Gs||this.mode===Is){let d=Fa[r][ar];s=Gr(s,d&65535,d>>16),a+=d>>16,r=ar}let i=this.binaryShiftByteCount===0||this.binaryShiftByteCount===31?18:this.binaryShiftByteCount===62?9:8,o=new Ws(s,r,this.binaryShiftByteCount+1,a+i);return o.binaryShiftByteCount===2078&&(o=o.endBinaryShift(t+1)),o}endBinaryShift(t){if(this.binaryShiftByteCount===0)return this;let s=this.token;return s=ro(s,t-this.binaryShiftByteCount,this.binaryShiftByteCount),new Ws(s,this.mode,0,this.bitCount)}isBetterThanOrEqualTo(t){let s=this.bitCount+(Fa[this.mode][t.mode]>>16);return this.binaryShiftByteCount<t.binaryShiftByteCount?s+=Ws.calculateBinaryShiftCost(t)-Ws.calculateBinaryShiftCost(this):this.binaryShiftByteCount>t.binaryShiftByteCount&&t.binaryShiftByteCount>0&&(s+=10),s<=t.bitCount}toBitArray(t){let s=[];for(let a=this.endBinaryShift(t.length).token;a!==null;a=a.getPrevious())s.unshift(a);let r=new q;for(const a of s)a.appendTo(r,t);return r}toString(){return W.format("%s bits=%d bytes=%d",ao[this.mode],this.bitCount,this.binaryShiftByteCount)}static calculateBinaryShiftCost(t){return t.binaryShiftByteCount>62?21:t.binaryShiftByteCount>31?20:t.binaryShiftByteCount>0?10:0}}Ws.INITIAL_STATE=new Ws(no,ar,0,0);function oo(A){const t=W.getCharCode(" "),s=W.getCharCode("."),r=W.getCharCode(",");A[ar][t]=1;const a=W.getCharCode("Z"),i=W.getCharCode("A");for(let z=i;z<=a;z++)A[ar][z]=z-i+2;A[ha][t]=1;const o=W.getCharCode("z"),d=W.getCharCode("a");for(let z=d;z<=o;z++)A[ha][z]=z-d+2;A[Is][t]=1;const h=W.getCharCode("9"),m=W.getCharCode("0");for(let z=m;z<=h;z++)A[Is][z]=z-m+2;A[Is][r]=12,A[Is][s]=13;const y=["\0"," ","","","","","","","\x07","\b","	",`
`,"\v","\f","\r","\x1B","","","","","@","\\","^","_","`","|","~",""];for(let z=0;z<y.length;z++)A[jn][W.getCharCode(y[z])]=z;const T=["\0","\r","\0","\0","\0","\0","!","'","#","$","%","&","'","(",")","*","+",",","-",".","/",":",";","<","=",">","?","[","]","{","}"];for(let z=0;z<T.length;z++)W.getCharCode(T[z])>0&&(A[Gs][W.getCharCode(T[z])]=z);return A}const Ua=oo(E.createInt32Array(5,256));class Wr{constructor(t){this.text=t}encode(){const t=W.getCharCode(" "),s=W.getCharCode(`
`);let r=Nn.singletonList(Ws.INITIAL_STATE);for(let i=0;i<this.text.length;i++){let o,d=i+1<this.text.length?this.text[i+1]:0;switch(this.text[i]){case W.getCharCode("\r"):o=d===s?2:0;break;case W.getCharCode("."):o=d===t?3:0;break;case W.getCharCode(","):o=d===t?4:0;break;case W.getCharCode(":"):o=d===t?5:0;break;default:o=0}o>0?(r=Wr.updateStateListForPair(r,i,o),i++):r=this.updateStateListForChar(r,i)}return Nn.min(r,(i,o)=>i.getBitCount()-o.getBitCount()).toBitArray(this.text)}updateStateListForChar(t,s){const r=[];for(let a of t)this.updateStateForChar(a,s,r);return Wr.simplifyStates(r)}updateStateForChar(t,s,r){let a=this.text[s]&255,i=Ua[t.getMode()][a]>0,o=null;for(let d=0;d<=Gs;d++){let h=Ua[d][a];if(h>0){if(o==null&&(o=t.endBinaryShift(s)),!i||d===t.getMode()||d===Is){const m=o.latchAndAppend(d,h);r.push(m)}if(!i&&Cn[t.getMode()][d]>=0){const m=o.shiftAndAppend(d,h);r.push(m)}}}if(t.getBinaryShiftByteCount()>0||Ua[t.getMode()][a]===0){let d=t.addBinaryShiftChar(s);r.push(d)}}static updateStateListForPair(t,s,r){const a=[];for(let i of t)this.updateStateForPair(i,s,r,a);return this.simplifyStates(a)}static updateStateForPair(t,s,r,a){let i=t.endBinaryShift(s);if(a.push(i.latchAndAppend(Gs,r)),t.getMode()!==Gs&&a.push(i.shiftAndAppend(Gs,r)),r===3||r===4){let o=i.latchAndAppend(Is,16-r).latchAndAppend(Is,1);a.push(o)}if(t.getBinaryShiftByteCount()>0){let o=t.addBinaryShiftChar(s).addBinaryShiftChar(s+1);a.push(o)}}static simplifyStates(t){let s=[];for(const r of t){let a=!0;for(const i of s){if(i.isBetterThanOrEqualTo(r)){a=!1;break}r.isBetterThanOrEqualTo(i)&&(s=s.filter(o=>o!==i))}a&&s.push(r)}return s}}class Et{constructor(){}static encodeBytes(t){return Et.encode(t,Et.DEFAULT_EC_PERCENT,Et.DEFAULT_AZTEC_LAYERS)}static encode(t,s,r){let a=new Wr(t).encode(),i=U.truncDivision(a.getSize()*s,100)+11,o=a.getSize()+i,d,h,m,y,T;if(r!==Et.DEFAULT_AZTEC_LAYERS){if(d=r<0,h=Math.abs(r),h>(d?Et.MAX_NB_BITS_COMPACT:Et.MAX_NB_BITS))throw new p(W.format("Illegal value %s for layers",r));m=Et.totalBitsInLayer(h,d),y=Et.WORD_SIZE[h];let Ve=m-m%y;if(T=Et.stuffBits(a,y),T.getSize()+i>Ve)throw new p("Data to large for user specified layer");if(d&&T.getSize()>y*64)throw new p("Data to large for user specified layer")}else{y=0,T=null;for(let Ve=0;;Ve++){if(Ve>Et.MAX_NB_BITS)throw new p("Data too large for an Aztec code");if(d=Ve<=3,h=d?Ve+1:Ve,m=Et.totalBitsInLayer(h,d),o>m)continue;(T==null||y!==Et.WORD_SIZE[h])&&(y=Et.WORD_SIZE[h],T=Et.stuffBits(a,y));let vt=m-m%y;if(!(d&&T.getSize()>y*64)&&T.getSize()+i<=vt)break}}let z=Et.generateCheckWords(T,m,y),Y=T.getSize()/y,ce=Et.generateModeMessage(d,h,Y),ue=(d?11:14)+h*4,Se=new Int32Array(ue),ze;if(d){ze=ue;for(let Ve=0;Ve<Se.length;Ve++)Se[Ve]=Ve}else{ze=ue+1+2*U.truncDivision(U.truncDivision(ue,2)-1,15);let Ve=U.truncDivision(ue,2),vt=U.truncDivision(ze,2);for(let mt=0;mt<Ve;mt++){let gs=mt+U.truncDivision(mt,15);Se[Ve-mt-1]=vt-gs-1,Se[Ve+mt]=vt+gs+1}}let We=new G(ze);for(let Ve=0,vt=0;Ve<h;Ve++){let mt=(h-Ve)*4+(d?9:12);for(let gs=0;gs<mt;gs++){let Rs=gs*2;for(let ps=0;ps<2;ps++)z.get(vt+Rs+ps)&&We.set(Se[Ve*2+ps],Se[Ve*2+gs]),z.get(vt+mt*2+Rs+ps)&&We.set(Se[Ve*2+gs],Se[ue-1-Ve*2-ps]),z.get(vt+mt*4+Rs+ps)&&We.set(Se[ue-1-Ve*2-ps],Se[ue-1-Ve*2-gs]),z.get(vt+mt*6+Rs+ps)&&We.set(Se[ue-1-Ve*2-gs],Se[Ve*2+ps])}vt+=mt*8}if(Et.drawModeMessage(We,d,ze,ce),d)Et.drawBullsEye(We,U.truncDivision(ze,2),5);else{Et.drawBullsEye(We,U.truncDivision(ze,2),7);for(let Ve=0,vt=0;Ve<U.truncDivision(ue,2)-1;Ve+=15,vt+=16)for(let mt=U.truncDivision(ze,2)&1;mt<ze;mt+=2)We.set(U.truncDivision(ze,2)-vt,mt),We.set(U.truncDivision(ze,2)+vt,mt),We.set(mt,U.truncDivision(ze,2)-vt),We.set(mt,U.truncDivision(ze,2)+vt)}let $e=new vn;return $e.setCompact(d),$e.setSize(ze),$e.setLayers(h),$e.setCodeWords(Y),$e.setMatrix(We),$e}static drawBullsEye(t,s,r){for(let a=0;a<r;a+=2)for(let i=s-a;i<=s+a;i++)t.set(i,s-a),t.set(i,s+a),t.set(s-a,i),t.set(s+a,i);t.set(s-r,s-r),t.set(s-r+1,s-r),t.set(s-r,s-r+1),t.set(s+r,s-r),t.set(s+r,s-r+1),t.set(s+r,s+r-1)}static generateModeMessage(t,s,r){let a=new q;return t?(a.appendBits(s-1,2),a.appendBits(r-1,6),a=Et.generateCheckWords(a,28,4)):(a.appendBits(s-1,5),a.appendBits(r-1,11),a=Et.generateCheckWords(a,40,4)),a}static drawModeMessage(t,s,r,a){let i=U.truncDivision(r,2);if(s)for(let o=0;o<7;o++){let d=i-3+o;a.get(o)&&t.set(d,i-5),a.get(o+7)&&t.set(i+5,d),a.get(20-o)&&t.set(d,i+5),a.get(27-o)&&t.set(i-5,d)}else for(let o=0;o<10;o++){let d=i-5+o+U.truncDivision(o,5);a.get(o)&&t.set(d,i-7),a.get(o+10)&&t.set(i+7,d),a.get(29-o)&&t.set(d,i+7),a.get(39-o)&&t.set(i-7,d)}}static generateCheckWords(t,s,r){let a=t.getSize()/r,i=new Ra(Et.getGF(r)),o=U.truncDivision(s,r),d=Et.bitsToWords(t,r,o);i.encode(d,o-a);let h=s%r,m=new q;m.appendBits(0,h);for(const y of Array.from(d))m.appendBits(y,r);return m}static bitsToWords(t,s,r){let a=new Int32Array(r),i,o;for(i=0,o=t.getSize()/s;i<o;i++){let d=0;for(let h=0;h<s;h++)d|=t.get(i*s+h)?1<<s-h-1:0;a[i]=d}return a}static getGF(t){switch(t){case 4:return Ue.AZTEC_PARAM;case 6:return Ue.AZTEC_DATA_6;case 8:return Ue.AZTEC_DATA_8;case 10:return Ue.AZTEC_DATA_10;case 12:return Ue.AZTEC_DATA_12;default:throw new p("Unsupported word size "+t)}}static stuffBits(t,s){let r=new q,a=t.getSize(),i=(1<<s)-2;for(let o=0;o<a;o+=s){let d=0;for(let h=0;h<s;h++)(o+h>=a||t.get(o+h))&&(d|=1<<s-1-h);(d&i)===i?(r.appendBits(d&i,s),o--):d&i?r.appendBits(d,s):(r.appendBits(d|1,s),o--)}return r}static totalBitsInLayer(t,s){return((s?88:112)+16*t)*t}}Et.DEFAULT_EC_PERCENT=33,Et.DEFAULT_AZTEC_LAYERS=0,Et.MAX_NB_BITS=32,Et.MAX_NB_BITS_COMPACT=4,Et.WORD_SIZE=Int32Array.from([4,6,6,8,8,8,8,8,8,10,10,10,10,10,10,10,10,10,10,10,10,10,10,12,12,12,12,12,12,12,12,12,12]);class xa{encode(t,s,r,a){return this.encodeWithHints(t,s,r,a,null)}encodeWithHints(t,s,r,a,i){let o=Pa.ISO_8859_1,d=Et.DEFAULT_EC_PERCENT,h=Et.DEFAULT_AZTEC_LAYERS;return i!=null&&(i.has(Qt.CHARACTER_SET)&&(o=_n.forName(i.get(Qt.CHARACTER_SET).toString())),i.has(Qt.ERROR_CORRECTION)&&(d=U.parseInt(i.get(Qt.ERROR_CORRECTION).toString())),i.has(Qt.AZTEC_LAYERS)&&(h=U.parseInt(i.get(Qt.AZTEC_LAYERS).toString()))),xa.encodeLayers(t,s,r,a,o,d,h)}static encodeLayers(t,s,r,a,i,o,d){if(s!==ae.AZTEC)throw new p("Can only encode AZTEC, but got "+s);let h=Et.encode(W.getBytes(t,i),o,d);return xa.renderResult(h,r,a)}static renderResult(t,s,r){let a=t.getMatrix();if(a==null)throw new rt;let i=a.getWidth(),o=a.getHeight(),d=Math.max(s,i),h=Math.max(r,o),m=Math.min(d/i,h/o),y=(d-i*m)/2,T=(h-o*m)/2,z=new G(d,h);for(let Y=0,ce=T;Y<o;Y++,ce+=m)for(let ue=0,Se=y;ue<i;ue++,Se+=m)a.get(ue,Y)&&z.setRegion(Se,ce,m,m);return z}}c.AbstractExpandedDecoder=Rr,c.ArgumentException=j,c.ArithmeticException=Ae,c.AztecCode=vn,c.AztecCodeReader=Ee,c.AztecCodeWriter=xa,c.AztecDecoder=Je,c.AztecDetector=De,c.AztecDetectorResult=H,c.AztecEncoder=Et,c.AztecHighLevelEncoder=Wr,c.AztecPoint=oe,c.BarcodeFormat=ae,c.Binarizer=k,c.BinaryBitmap=M,c.BitArray=q,c.BitMatrix=G,c.BitSource=Br,c.BrowserAztecCodeReader=te,c.BrowserBarcodeReader=la,c.BrowserCodeReader=Q,c.BrowserDatamatrixCodeReader=Be,c.BrowserMultiFormatReader=Qi,c.BrowserPDF417Reader=Ki,c.BrowserQRCodeReader=Ji,c.BrowserQRCodeSvgWriter=br,c.CharacterSetECI=I,c.ChecksumException=B,c.Code128Reader=Z,c.Code39Reader=he,c.DataMatrixDecodedBitStreamParser=qs,c.DataMatrixReader=xe,c.DecodeHintType=N,c.DecoderResult=ye,c.DefaultGridSampler=Re,c.DetectorResult=Te,c.EAN13Reader=At,c.EncodeHintType=Qt,c.Exception=g,c.FormatException=_,c.GenericGF=Ue,c.GenericGFPoly=Ne,c.GlobalHistogramBinarizer=F,c.GridSampler=fe,c.GridSamplerInstance=ee,c.HTMLCanvasElementLuminanceSource=X,c.HybridBinarizer=re,c.ITFReader=we,c.IllegalArgumentException=p,c.IllegalStateException=rt,c.InvertedLuminanceSource=ge,c.LuminanceSource=_e,c.MathUtils=Ge,c.MultiFormatOneDReader=tr,c.MultiFormatReader=yn,c.MultiFormatWriter=to,c.NotFoundException=$,c.OneDReader=ke,c.PDF417DecodedBitStreamParser=Me,c.PDF417DecoderErrorCorrection=mn,c.PDF417Reader=ns,c.PDF417ResultMetadata=gn,c.PerspectiveTransform=Ie,c.PlanarYUVLuminanceSource=Hs,c.QRCodeByteMatrix=ua,c.QRCodeDataMask=Rt,c.QRCodeDecodedBitStreamParser=xt,c.QRCodeDecoderErrorCorrectionLevel=Pe,c.QRCodeDecoderFormatInformation=Ze,c.QRCodeEncoder=Bt,c.QRCodeEncoderQRCode=pr,c.QRCodeMaskUtil=Gt,c.QRCodeMatrixUtil=ot,c.QRCodeMode=tt,c.QRCodeReader=ss,c.QRCodeVersion=He,c.QRCodeWriter=jr,c.RGBLuminanceSource=La,c.RSS14Reader=Vt,c.RSSExpandedReader=Fe,c.ReaderException=da,c.ReedSolomonDecoder=at,c.ReedSolomonEncoder=Ra,c.ReedSolomonException=qe,c.Result=V,c.ResultMetadataType=be,c.ResultPoint=Ye,c.StringUtils=W,c.UnsupportedOperationException=K,c.VideoInputDevice=pe,c.WhiteRectangleDetector=ne,c.WriterException=kt,c.ZXingArrays=E,c.ZXingCharset=_n,c.ZXingInteger=U,c.ZXingStandardCharsets=Pa,c.ZXingStringBuilder=se,c.ZXingStringEncoding=O,c.ZXingSystem=R,c.createAbstractExpandedDecoder=ia,Object.defineProperty(c,"__esModule",{value:!0})})})(tn,tn.exports);var Ft=tn.exports;const pc=xo(Ft),bc=Io({__proto__:null,default:pc},[Ft]);var Hn=function(){function n(l,c,u){if(this.formatMap=new Map([[st.QR_CODE,Ft.BarcodeFormat.QR_CODE],[st.AZTEC,Ft.BarcodeFormat.AZTEC],[st.CODABAR,Ft.BarcodeFormat.CODABAR],[st.CODE_39,Ft.BarcodeFormat.CODE_39],[st.CODE_93,Ft.BarcodeFormat.CODE_93],[st.CODE_128,Ft.BarcodeFormat.CODE_128],[st.DATA_MATRIX,Ft.BarcodeFormat.DATA_MATRIX],[st.MAXICODE,Ft.BarcodeFormat.MAXICODE],[st.ITF,Ft.BarcodeFormat.ITF],[st.EAN_13,Ft.BarcodeFormat.EAN_13],[st.EAN_8,Ft.BarcodeFormat.EAN_8],[st.PDF_417,Ft.BarcodeFormat.PDF_417],[st.RSS_14,Ft.BarcodeFormat.RSS_14],[st.RSS_EXPANDED,Ft.BarcodeFormat.RSS_EXPANDED],[st.UPC_A,Ft.BarcodeFormat.UPC_A],[st.UPC_E,Ft.BarcodeFormat.UPC_E],[st.UPC_EAN_EXTENSION,Ft.BarcodeFormat.UPC_EAN_EXTENSION]]),this.reverseFormatMap=this.createReverseFormatMap(),!bc)throw"Use html5qrcode.min.js without edit, ZXing not found.";this.verbose=c,this.logger=u;var f=this.createZXingFormats(l),x=new Map;x.set(Ft.DecodeHintType.POSSIBLE_FORMATS,f),x.set(Ft.DecodeHintType.TRY_HARDER,!1),this.hints=x}return n.prototype.decodeAsync=function(l){var c=this;return new Promise(function(u,f){try{u(c.decode(l))}catch(x){f(x)}})},n.prototype.decode=function(l){var c=new Ft.MultiFormatReader(this.verbose,this.hints),u=new Ft.HTMLCanvasElementLuminanceSource(l),f=new Ft.BinaryBitmap(new Ft.HybridBinarizer(u)),x=c.decode(f);return{text:x.text,format:zi.create(this.toHtml5QrcodeSupportedFormats(x.format)),debugData:this.createDebugData()}},n.prototype.createReverseFormatMap=function(){var l=new Map;return this.formatMap.forEach(function(c,u,f){l.set(c,u)}),l},n.prototype.toHtml5QrcodeSupportedFormats=function(l){if(!this.reverseFormatMap.has(l))throw"reverseFormatMap doesn't have ".concat(l);return this.reverseFormatMap.get(l)},n.prototype.createZXingFormats=function(l){for(var c=[],u=0,f=l;u<f.length;u++){var x=f[u];this.formatMap.has(x)?c.push(this.formatMap.get(x)):this.logger.logError("".concat(x," is not supported by")+"ZXingHtml5QrcodeShim")}return c},n.prototype.createDebugData=function(){return{decoderName:"zxing-js"}},n}(),wc=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(j){try{g(u.next(j))}catch(p){b(p)}}function S(j){try{g(u.throw(j))}catch(p){b(p)}}function g(j){j.done?x(j.value):f(j.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},yc=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(j){return S([g,j])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(j){g=[6,j],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},Gn=function(){function n(l,c,u){if(this.formatMap=new Map([[st.QR_CODE,"qr_code"],[st.AZTEC,"aztec"],[st.CODABAR,"codabar"],[st.CODE_39,"code_39"],[st.CODE_93,"code_93"],[st.CODE_128,"code_128"],[st.DATA_MATRIX,"data_matrix"],[st.ITF,"itf"],[st.EAN_13,"ean_13"],[st.EAN_8,"ean_8"],[st.PDF_417,"pdf417"],[st.UPC_A,"upc_a"],[st.UPC_E,"upc_e"]]),this.reverseFormatMap=this.createReverseFormatMap(),!n.isSupported())throw"Use html5qrcode.min.js without edit, Use BarcodeDetectorDelegate only if it isSupported();";this.verbose=c,this.logger=u;var f=this.createBarcodeDetectorFormats(l);if(this.detector=new BarcodeDetector(f),!this.detector)throw"BarcodeDetector detector not supported"}return n.isSupported=function(){if(!("BarcodeDetector"in window))return!1;var l=new BarcodeDetector({formats:["qr_code"]});return typeof l<"u"},n.prototype.decodeAsync=function(l){return wc(this,void 0,void 0,function(){var c,u;return yc(this,function(f){switch(f.label){case 0:return[4,this.detector.detect(l)];case 1:if(c=f.sent(),!c||c.length===0)throw"No barcode or QR code detected.";return u=this.selectLargestBarcode(c),[2,{text:u.rawValue,format:zi.create(this.toHtml5QrcodeSupportedFormats(u.format)),debugData:this.createDebugData()}]}})})},n.prototype.selectLargestBarcode=function(l){for(var c=null,u=0,f=0,x=l;f<x.length;f++){var b=x[f],v=b.boundingBox.width*b.boundingBox.height;v>u&&(u=v,c=b)}if(!c)throw"No largest barcode found";return c},n.prototype.createBarcodeDetectorFormats=function(l){for(var c=[],u=0,f=l;u<f.length;u++){var x=f[u];this.formatMap.has(x)?c.push(this.formatMap.get(x)):this.logger.warn("".concat(x," is not supported by")+"BarcodeDetectorDelegate")}return{formats:c}},n.prototype.toHtml5QrcodeSupportedFormats=function(l){if(!this.reverseFormatMap.has(l))throw"reverseFormatMap doesn't have ".concat(l);return this.reverseFormatMap.get(l)},n.prototype.createReverseFormatMap=function(){var l=new Map;return this.formatMap.forEach(function(c,u,f){l.set(c,u)}),l},n.prototype.createDebugData=function(){return{decoderName:"BarcodeDetector"}},n}(),Wn=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(j){try{g(u.next(j))}catch(p){b(p)}}function S(j){try{g(u.throw(j))}catch(p){b(p)}}function g(j){j.done?x(j.value):f(j.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},Yn=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(j){return S([g,j])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(j){g=[6,j],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},_c=function(){function n(l,c,u,f){this.EXECUTIONS_TO_REPORT_PERFORMANCE=100,this.executions=0,this.executionResults=[],this.wasPrimaryDecoderUsedInLastDecode=!1,this.verbose=u,c&&Gn.isSupported()?(this.primaryDecoder=new Gn(l,u,f),this.secondaryDecoder=new Hn(l,u,f)):this.primaryDecoder=new Hn(l,u,f)}return n.prototype.decodeAsync=function(l){return Wn(this,void 0,void 0,function(){var c;return Yn(this,function(u){switch(u.label){case 0:c=performance.now(),u.label=1;case 1:return u.trys.push([1,,3,4]),[4,this.getDecoder().decodeAsync(l)];case 2:return[2,u.sent()];case 3:return this.possiblyLogPerformance(c),[7];case 4:return[2]}})})},n.prototype.decodeRobustlyAsync=function(l){return Wn(this,void 0,void 0,function(){var c,u;return Yn(this,function(f){switch(f.label){case 0:c=performance.now(),f.label=1;case 1:return f.trys.push([1,3,4,5]),[4,this.primaryDecoder.decodeAsync(l)];case 2:return[2,f.sent()];case 3:if(u=f.sent(),this.secondaryDecoder)return[2,this.secondaryDecoder.decodeAsync(l)];throw u;case 4:return this.possiblyLogPerformance(c),[7];case 5:return[2]}})})},n.prototype.getDecoder=function(){return this.secondaryDecoder?this.wasPrimaryDecoderUsedInLastDecode===!1?(this.wasPrimaryDecoderUsedInLastDecode=!0,this.primaryDecoder):(this.wasPrimaryDecoderUsedInLastDecode=!1,this.secondaryDecoder):this.primaryDecoder},n.prototype.possiblyLogPerformance=function(l){if(this.verbose){var c=performance.now()-l;this.executionResults.push(c),this.executions++,this.possiblyFlushPerformanceReport()}},n.prototype.possiblyFlushPerformanceReport=function(){if(!(this.executions<this.EXECUTIONS_TO_REPORT_PERFORMANCE)){for(var l=0,c=0,u=this.executionResults;c<u.length;c++){var f=u[c];l+=f}var x=l/this.executionResults.length;console.log("".concat(x," ms for ").concat(this.executionResults.length," last runs.")),this.executions=0,this.executionResults=[]}},n}(),cn=function(){var n=function(l,c){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(u,f){u.__proto__=f}||function(u,f){for(var x in f)Object.prototype.hasOwnProperty.call(f,x)&&(u[x]=f[x])},n(l,c)};return function(l,c){if(typeof c!="function"&&c!==null)throw new TypeError("Class extends value "+String(c)+" is not a constructor or null");n(l,c);function u(){this.constructor=l}l.prototype=c===null?Object.create(c):(u.prototype=c.prototype,new u)}}(),ja=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(j){try{g(u.next(j))}catch(p){b(p)}}function S(j){try{g(u.throw(j))}catch(p){b(p)}}function g(j){j.done?x(j.value):f(j.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},Ca=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(j){return S([g,j])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(j){g=[6,j],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},Pi=function(){function n(l,c){this.name=l,this.track=c}return n.prototype.isSupported=function(){return this.track.getCapabilities?this.name in this.track.getCapabilities():!1},n.prototype.apply=function(l){var c={};c[this.name]=l;var u={advanced:[c]};return this.track.applyConstraints(u)},n.prototype.value=function(){var l=this.track.getSettings();if(this.name in l){var c=l[this.name];return c}return null},n}(),vc=function(n){cn(l,n);function l(c,u){return n.call(this,c,u)||this}return l.prototype.min=function(){return this.getCapabilities().min},l.prototype.max=function(){return this.getCapabilities().max},l.prototype.step=function(){return this.getCapabilities().step},l.prototype.apply=function(c){var u={};u[this.name]=c;var f={advanced:[u]};return this.track.applyConstraints(f)},l.prototype.getCapabilities=function(){this.failIfNotSupported();var c=this.track.getCapabilities(),u=c[this.name];return{min:u.min,max:u.max,step:u.step}},l.prototype.failIfNotSupported=function(){if(!this.isSupported())throw new Error("".concat(this.name," capability not supported"))},l}(Pi),Nc=function(n){cn(l,n);function l(c){return n.call(this,"zoom",c)||this}return l}(vc),jc=function(n){cn(l,n);function l(c){return n.call(this,"torch",c)||this}return l}(Pi),Cc=function(){function n(l){this.track=l}return n.prototype.zoomFeature=function(){return new Nc(this.track)},n.prototype.torchFeature=function(){return new jc(this.track)},n}(),Ec=function(){function n(l,c,u){this.isClosed=!1,this.parentElement=l,this.mediaStream=c,this.callbacks=u,this.surface=this.createVideoElement(this.parentElement.clientWidth),l.append(this.surface)}return n.prototype.createVideoElement=function(l){var c=document.createElement("video");return c.style.width="".concat(l,"px"),c.style.display="block",c.muted=!0,c.setAttribute("muted","true"),c.playsInline=!0,c},n.prototype.setupSurface=function(){var l=this;this.surface.onabort=function(){throw"RenderedCameraImpl video surface onabort() called"},this.surface.onerror=function(){throw"RenderedCameraImpl video surface onerror() called"};var c=function(){var u=l.surface.clientWidth,f=l.surface.clientHeight;l.callbacks.onRenderSurfaceReady(u,f),l.surface.removeEventListener("playing",c)};this.surface.addEventListener("playing",c),this.surface.srcObject=this.mediaStream,this.surface.play()},n.create=function(l,c,u,f){return ja(this,void 0,void 0,function(){var x,b;return Ca(this,function(v){switch(v.label){case 0:return x=new n(l,c,f),u.aspectRatio?(b={aspectRatio:u.aspectRatio},[4,x.getFirstTrackOrFail().applyConstraints(b)]):[3,2];case 1:v.sent(),v.label=2;case 2:return x.setupSurface(),[2,x]}})})},n.prototype.failIfClosed=function(){if(this.isClosed)throw"The RenderedCamera has already been closed."},n.prototype.getFirstTrackOrFail=function(){if(this.failIfClosed(),this.mediaStream.getVideoTracks().length===0)throw"No video tracks found";return this.mediaStream.getVideoTracks()[0]},n.prototype.pause=function(){this.failIfClosed(),this.surface.pause()},n.prototype.resume=function(l){this.failIfClosed();var c=this,u=function(){setTimeout(l,200),c.surface.removeEventListener("playing",u)};this.surface.addEventListener("playing",u),this.surface.play()},n.prototype.isPaused=function(){return this.failIfClosed(),this.surface.paused},n.prototype.getSurface=function(){return this.failIfClosed(),this.surface},n.prototype.getRunningTrackCapabilities=function(){return this.getFirstTrackOrFail().getCapabilities()},n.prototype.getRunningTrackSettings=function(){return this.getFirstTrackOrFail().getSettings()},n.prototype.applyVideoConstraints=function(l){return ja(this,void 0,void 0,function(){return Ca(this,function(c){if("aspectRatio"in l)throw"Changing 'aspectRatio' in run-time is not yet supported.";return[2,this.getFirstTrackOrFail().applyConstraints(l)]})})},n.prototype.close=function(){if(this.isClosed)return Promise.resolve();var l=this;return new Promise(function(c,u){var f=l.mediaStream.getVideoTracks(),x=f.length,b=0;l.mediaStream.getVideoTracks().forEach(function(v){l.mediaStream.removeTrack(v),v.stop(),++b,b>=x&&(l.isClosed=!0,l.parentElement.removeChild(l.surface),c())})})},n.prototype.getCapabilities=function(){return new Cc(this.getFirstTrackOrFail())},n}(),Sc=function(){function n(l){this.mediaStream=l}return n.prototype.render=function(l,c,u){return ja(this,void 0,void 0,function(){return Ca(this,function(f){return[2,Ec.create(l,this.mediaStream,c,u)]})})},n.create=function(l){return ja(this,void 0,void 0,function(){var c,u;return Ca(this,function(f){switch(f.label){case 0:if(!navigator.mediaDevices)throw"navigator.mediaDevices not supported";return c={audio:!1,video:l},[4,navigator.mediaDevices.getUserMedia(c)];case 1:return u=f.sent(),[2,new n(u)]}})})},n}(),$n=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(j){try{g(u.next(j))}catch(p){b(p)}}function S(j){try{g(u.throw(j))}catch(p){b(p)}}function g(j){j.done?x(j.value):f(j.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},Xn=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(j){return S([g,j])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(j){g=[6,j],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},Ac=function(){function n(){}return n.failIfNotSupported=function(){return $n(this,void 0,void 0,function(){return Xn(this,function(l){if(!navigator.mediaDevices)throw"navigator.mediaDevices not supported";return[2,new n]})})},n.prototype.create=function(l){return $n(this,void 0,void 0,function(){return Xn(this,function(c){return[2,Sc.create(l)]})})},n}(),Ic=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(j){try{g(u.next(j))}catch(p){b(p)}}function S(j){try{g(u.throw(j))}catch(p){b(p)}}function g(j){j.done?x(j.value):f(j.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},Tc=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(j){return S([g,j])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(j){g=[6,j],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},Dc=function(){function n(){}return n.retrieve=function(){if(navigator.mediaDevices)return n.getCamerasFromMediaDevices();var l=MediaStreamTrack;return MediaStreamTrack&&l.getSources?n.getCamerasFromMediaStreamTrack():n.rejectWithError()},n.rejectWithError=function(){var l=Tr.unableToQuerySupportedDevices();return n.isHttpsOrLocalhost()||(l=Tr.insecureContextCameraQueryError()),Promise.reject(l)},n.isHttpsOrLocalhost=function(){if(location.protocol==="https:")return!0;var l=location.host.split(":")[0];return l==="127.0.0.1"||l==="localhost"},n.getCamerasFromMediaDevices=function(){return Ic(this,void 0,void 0,function(){var l,c,u,f,x,b,v;return Tc(this,function(S){switch(S.label){case 0:return l=function(g){for(var j=g.getVideoTracks(),p=0,M=j;p<M.length;p++){var B=M[p];B.enabled=!1,B.stop(),g.removeTrack(B)}},[4,navigator.mediaDevices.getUserMedia({audio:!1,video:!0})];case 1:return c=S.sent(),[4,navigator.mediaDevices.enumerateDevices()];case 2:for(u=S.sent(),f=[],x=0,b=u;x<b.length;x++)v=b[x],v.kind==="videoinput"&&f.push({id:v.deviceId,label:v.label});return l(c),[2,f]}})})},n.getCamerasFromMediaStreamTrack=function(){return new Promise(function(l,c){var u=function(x){for(var b=[],v=0,S=x;v<S.length;v++){var g=S[v];g.kind==="video"&&b.push({id:g.id,label:g.label})}l(b)},f=MediaStreamTrack;f.getSources(u)})},n}(),Wt;(function(n){n[n.UNKNOWN=0]="UNKNOWN",n[n.NOT_STARTED=1]="NOT_STARTED",n[n.SCANNING=2]="SCANNING",n[n.PAUSED=3]="PAUSED"})(Wt||(Wt={}));var kc=function(){function n(){this.state=Wt.NOT_STARTED,this.onGoingTransactionNewState=Wt.UNKNOWN}return n.prototype.directTransition=function(l){this.failIfTransitionOngoing(),this.validateTransition(l),this.state=l},n.prototype.startTransition=function(l){return this.failIfTransitionOngoing(),this.validateTransition(l),this.onGoingTransactionNewState=l,this},n.prototype.execute=function(){if(this.onGoingTransactionNewState===Wt.UNKNOWN)throw"Transaction is already cancelled, cannot execute().";var l=this.onGoingTransactionNewState;this.onGoingTransactionNewState=Wt.UNKNOWN,this.directTransition(l)},n.prototype.cancel=function(){if(this.onGoingTransactionNewState===Wt.UNKNOWN)throw"Transaction is already cancelled, cannot cancel().";this.onGoingTransactionNewState=Wt.UNKNOWN},n.prototype.getState=function(){return this.state},n.prototype.failIfTransitionOngoing=function(){if(this.onGoingTransactionNewState!==Wt.UNKNOWN)throw"Cannot transition to a new state, already under transition"},n.prototype.validateTransition=function(l){switch(this.state){case Wt.UNKNOWN:throw"Transition from unknown is not allowed";case Wt.NOT_STARTED:this.failIfNewStateIs(l,[Wt.PAUSED]);break;case Wt.SCANNING:break;case Wt.PAUSED:break}},n.prototype.failIfNewStateIs=function(l,c){for(var u=0,f=c;u<f.length;u++){var x=f[u];if(l===x)throw"Cannot transition from ".concat(this.state," to ").concat(l)}},n}(),Mc=function(){function n(l){this.stateManager=l}return n.prototype.startTransition=function(l){return this.stateManager.startTransition(l)},n.prototype.directTransition=function(l){this.stateManager.directTransition(l)},n.prototype.getState=function(){return this.stateManager.getState()},n.prototype.canScanFile=function(){return this.stateManager.getState()===Wt.NOT_STARTED},n.prototype.isScanning=function(){return this.stateManager.getState()!==Wt.NOT_STARTED},n.prototype.isStrictlyScanning=function(){return this.stateManager.getState()===Wt.SCANNING},n.prototype.isPaused=function(){return this.stateManager.getState()===Wt.PAUSED},n}(),zc=function(){function n(){}return n.create=function(){return new Mc(new kc)},n}(),Oc=function(){var n=function(l,c){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(u,f){u.__proto__=f}||function(u,f){for(var x in f)Object.prototype.hasOwnProperty.call(f,x)&&(u[x]=f[x])},n(l,c)};return function(l,c){if(typeof c!="function"&&c!==null)throw new TypeError("Class extends value "+String(c)+" is not a constructor or null");n(l,c);function u(){this.constructor=l}l.prototype=c===null?Object.create(c):(u.prototype=c.prototype,new u)}}(),js=function(n){Oc(l,n);function l(){return n!==null&&n.apply(this,arguments)||this}return l.DEFAULT_WIDTH=300,l.DEFAULT_WIDTH_OFFSET=2,l.FILE_SCAN_MIN_HEIGHT=300,l.FILE_SCAN_HIDDEN_CANVAS_PADDING=100,l.MIN_QR_BOX_SIZE=50,l.SHADED_LEFT=1,l.SHADED_RIGHT=2,l.SHADED_TOP=3,l.SHADED_BOTTOM=4,l.SHADED_REGION_ELEMENT_ID="qr-shaded-region",l.VERBOSE=!1,l.BORDER_SHADER_DEFAULT_COLOR="#ffffff",l.BORDER_SHADER_MATCH_COLOR="rgb(90, 193, 56)",l}(Ps),Rc=function(){function n(l,c){this.logger=c,this.fps=js.SCAN_DEFAULT_FPS,l?(l.fps&&(this.fps=l.fps),this.disableFlip=l.disableFlip===!0,this.qrbox=l.qrbox,this.aspectRatio=l.aspectRatio,this.videoConstraints=l.videoConstraints):this.disableFlip=js.DEFAULT_DISABLE_FLIP}return n.prototype.isMediaStreamConstraintsValid=function(){return this.videoConstraints?Li.isMediaStreamConstraintsValid(this.videoConstraints,this.logger):(this.logger.logError("Empty videoConstraints",!0),!1)},n.prototype.isShadedBoxEnabled=function(){return!Ys(this.qrbox)},n.create=function(l,c){return new n(l,c)},n}(),Zn=function(){function n(l,c){if(this.element=null,this.canvasElement=null,this.scannerPausedUiElement=null,this.hasBorderShaders=null,this.borderShaders=null,this.qrMatch=null,this.renderedCamera=null,this.qrRegion=null,this.context=null,this.lastScanImageFile=null,this.isScanning=!1,!document.getElementById(l))throw"HTML Element with id=".concat(l," not found");this.elementId=l,this.verbose=!1;var u;typeof c=="boolean"?this.verbose=c===!0:c&&(u=c,this.verbose=u.verbose===!0,u.experimentalFeatures),this.logger=new Ri(this.verbose),this.qrcode=new _c(this.getSupportedFormats(c),this.getUseBarCodeDetectorIfSupported(u),this.verbose,this.logger),this.foreverScanTimeout,this.shouldScan=!0,this.stateManagerProxy=zc.create()}return n.prototype.start=function(l,c,u,f){var x=this;if(!l)throw"cameraIdOrConfig is required";if(!u||typeof u!="function")throw"qrCodeSuccessCallback is required and should be a function.";var b;f?b=f:b=this.verbose?this.logger.log:function(){};var v=Rc.create(c,this.logger);this.clearElement();var S=!1;v.videoConstraints&&(v.isMediaStreamConstraintsValid()?S=!0:this.logger.logError("'videoConstraints' is not valid 'MediaStreamConstraints, it will be ignored.'",!0));var g=S,j=document.getElementById(this.elementId);j.clientWidth?j.clientWidth:js.DEFAULT_WIDTH,j.style.position="relative",this.shouldScan=!0,this.element=j;var p=this,M=this.stateManagerProxy.startTransition(Wt.SCANNING);return new Promise(function(B,k){var R=g?v.videoConstraints:p.createVideoConstraints(l);if(!R){M.cancel(),k("videoConstraints should be defined");return}var C={};(!g||v.aspectRatio)&&(C.aspectRatio=v.aspectRatio);var D={onRenderSurfaceReady:function(E,U){p.setupUi(E,U,v),p.isScanning=!0,p.foreverScan(v,u,b)}};Ac.failIfNotSupported().then(function(E){E.create(R).then(function(U){return U.render(x.element,C,D).then(function(q){p.renderedCamera=q,M.execute(),B(null)}).catch(function(q){M.cancel(),k(q)})}).catch(function(U){M.cancel(),k(Tr.errorGettingUserMedia(U))})}).catch(function(E){M.cancel(),k(Tr.cameraStreamingNotSupported())})})},n.prototype.pause=function(l){if(!this.stateManagerProxy.isStrictlyScanning())throw"Cannot pause, scanner is not scanning.";this.stateManagerProxy.directTransition(Wt.PAUSED),this.showPausedState(),(Ys(l)||l!==!0)&&(l=!1),l&&this.renderedCamera&&this.renderedCamera.pause()},n.prototype.resume=function(){if(!this.stateManagerProxy.isPaused())throw"Cannot result, scanner is not paused.";if(!this.renderedCamera)throw"renderedCamera doesn't exist while trying resume()";var l=this,c=function(){l.stateManagerProxy.directTransition(Wt.SCANNING),l.hidePausedState()};if(!this.renderedCamera.isPaused()){c();return}this.renderedCamera.resume(function(){c()})},n.prototype.getState=function(){return this.stateManagerProxy.getState()},n.prototype.stop=function(){var l=this;if(!this.stateManagerProxy.isScanning())throw"Cannot stop, scanner is not running or paused.";var c=this.stateManagerProxy.startTransition(Wt.NOT_STARTED);this.shouldScan=!1,this.foreverScanTimeout&&clearTimeout(this.foreverScanTimeout);var u=function(){if(l.element){var x=document.getElementById(js.SHADED_REGION_ELEMENT_ID);x&&l.element.removeChild(x)}},f=this;return this.renderedCamera.close().then(function(){return f.renderedCamera=null,f.element&&(f.element.removeChild(f.canvasElement),f.canvasElement=null),u(),f.qrRegion&&(f.qrRegion=null),f.context&&(f.context=null),c.execute(),f.hidePausedState(),f.isScanning=!1,Promise.resolve()})},n.prototype.scanFile=function(l,c){return this.scanFileV2(l,c).then(function(u){return u.decodedText})},n.prototype.scanFileV2=function(l,c){var u=this;if(!l||!(l instanceof File))throw"imageFile argument is mandatory and should be instance of File. Use 'event.target.files[0]'.";if(Ys(c)&&(c=!0),!this.stateManagerProxy.canScanFile())throw"Cannot start file scan - ongoing camera scan";return new Promise(function(f,x){u.possiblyCloseLastScanImageFile(),u.clearElement(),u.lastScanImageFile=URL.createObjectURL(l);var b=new Image;b.onload=function(){var v=b.width,S=b.height,g=document.getElementById(u.elementId),j=g.clientWidth?g.clientWidth:js.DEFAULT_WIDTH,p=Math.max(g.clientHeight?g.clientHeight:S,js.FILE_SCAN_MIN_HEIGHT),M=u.computeCanvasDrawConfig(v,S,j,p);if(c){var B=u.createCanvasElement(j,p,"qr-canvas-visible");B.style.display="inline-block",g.appendChild(B);var k=B.getContext("2d");if(!k)throw"Unable to get 2d context from canvas";k.canvas.width=j,k.canvas.height=p,k.drawImage(b,0,0,v,S,M.x,M.y,M.width,M.height)}var R=js.FILE_SCAN_HIDDEN_CANVAS_PADDING,C=Math.max(b.width,M.width),D=Math.max(b.height,M.height),E=C+2*R,U=D+2*R,q=u.createCanvasElement(E,U);g.appendChild(q);var J=q.getContext("2d");if(!J)throw"Unable to get 2d context from canvas";J.canvas.width=E,J.canvas.height=U,J.drawImage(b,0,0,v,S,R,R,C,D);try{u.qrcode.decodeRobustlyAsync(q).then(function(N){f(Vn.createFromQrcodeResult(N))}).catch(x)}catch(N){x("QR code parse error, error = ".concat(N))}},b.onerror=x,b.onabort=x,b.onstalled=x,b.onsuspend=x,b.src=URL.createObjectURL(l)})},n.prototype.clear=function(){this.clearElement()},n.getCameras=function(){return Dc.retrieve()},n.prototype.getRunningTrackCapabilities=function(){return this.getRenderedCameraOrFail().getRunningTrackCapabilities()},n.prototype.getRunningTrackSettings=function(){return this.getRenderedCameraOrFail().getRunningTrackSettings()},n.prototype.getRunningTrackCameraCapabilities=function(){return this.getRenderedCameraOrFail().getCapabilities()},n.prototype.applyVideoConstraints=function(l){if(l){if(!Li.isMediaStreamConstraintsValid(l,this.logger))throw"invalid videoConstaints passed, check logs for more details"}else throw"videoConstaints is required argument.";return this.getRenderedCameraOrFail().applyVideoConstraints(l)},n.prototype.getRenderedCameraOrFail=function(){if(this.renderedCamera==null)throw"Scanning is not in running state, call this API only when QR code scanning using camera is in running state.";return this.renderedCamera},n.prototype.getSupportedFormats=function(l){var c=[st.QR_CODE,st.AZTEC,st.CODABAR,st.CODE_39,st.CODE_93,st.CODE_128,st.DATA_MATRIX,st.MAXICODE,st.ITF,st.EAN_13,st.EAN_8,st.PDF_417,st.RSS_14,st.RSS_EXPANDED,st.UPC_A,st.UPC_E,st.UPC_EAN_EXTENSION];if(!l||typeof l=="boolean"||!l.formatsToSupport)return c;if(!Array.isArray(l.formatsToSupport))throw"configOrVerbosityFlag.formatsToSupport should be undefined or an array.";if(l.formatsToSupport.length===0)throw"Atleast 1 formatsToSupport is needed.";for(var u=[],f=0,x=l.formatsToSupport;f<x.length;f++){var b=x[f];fc(b)?u.push(b):this.logger.warn("Invalid format: ".concat(b," passed in config, ignoring."))}if(u.length===0)throw"None of formatsToSupport match supported values.";return u},n.prototype.getUseBarCodeDetectorIfSupported=function(l){if(Ys(l))return!0;if(!Ys(l.useBarCodeDetectorIfSupported))return l.useBarCodeDetectorIfSupported!==!1;if(Ys(l.experimentalFeatures))return!0;var c=l.experimentalFeatures;return Ys(c.useBarCodeDetectorIfSupported)?!0:c.useBarCodeDetectorIfSupported!==!1},n.prototype.validateQrboxSize=function(l,c,u){var f=this,x=u.qrbox;this.validateQrboxConfig(x);var b=this.toQrdimensions(l,c,x),v=function(g){if(g<js.MIN_QR_BOX_SIZE)throw"minimum size of 'config.qrbox' dimension value is"+" ".concat(js.MIN_QR_BOX_SIZE,"px.")},S=function(g){return g>l&&(f.logger.warn("`qrbox.width` or `qrbox` is larger than the width of the root element. The width will be truncated to the width of root element."),g=l),g};v(b.width),v(b.height),b.width=S(b.width)},n.prototype.validateQrboxConfig=function(l){if(typeof l!="number"&&typeof l!="function"&&(l.width===void 0||l.height===void 0))throw"Invalid instance of QrDimensions passed for 'config.qrbox'. Both 'width' and 'height' should be set."},n.prototype.toQrdimensions=function(l,c,u){if(typeof u=="number")return{width:u,height:u};if(typeof u=="function")try{return u(l,c)}catch(f){throw new Error("qrbox config was passed as a function but it failed with unknown error"+f)}return u},n.prototype.setupUi=function(l,c,u){u.isShadedBoxEnabled()&&this.validateQrboxSize(l,c,u);var f=Ys(u.qrbox)?{width:l,height:c}:u.qrbox;this.validateQrboxConfig(f);var x=this.toQrdimensions(l,c,f);x.height>c&&this.logger.warn("[Html5Qrcode] config.qrbox has height that isgreater than the height of the video stream. Shading will be ignored");var b=u.isShadedBoxEnabled()&&x.height<=c,v={x:0,y:0,width:l,height:c},S=b?this.getShadedRegionBounds(l,c,x):v,g=this.createCanvasElement(S.width,S.height),j={willReadFrequently:!0},p=g.getContext("2d",j);p.canvas.width=S.width,p.canvas.height=S.height,this.element.append(g),b&&this.possiblyInsertShadingElement(this.element,l,c,x),this.createScannerPausedUiElement(this.element),this.qrRegion=S,this.context=p,this.canvasElement=g},n.prototype.createScannerPausedUiElement=function(l){var c=document.createElement("div");c.innerText=Tr.scannerPaused(),c.style.display="none",c.style.position="absolute",c.style.top="0px",c.style.zIndex="1",c.style.background="rgba(9, 9, 9, 0.46)",c.style.color="#FFECEC",c.style.textAlign="center",c.style.width="100%",l.appendChild(c),this.scannerPausedUiElement=c},n.prototype.scanContext=function(l,c){var u=this;return this.stateManagerProxy.isPaused()?Promise.resolve(!1):this.qrcode.decodeAsync(this.canvasElement).then(function(f){return l(f.text,Vn.createFromQrcodeResult(f)),u.possiblyUpdateShaders(!0),!0}).catch(function(f){u.possiblyUpdateShaders(!1);var x=Tr.codeParseError(f);return c(x,Oi.createFrom(x)),!1})},n.prototype.foreverScan=function(l,c,u){var f=this;if(this.shouldScan&&this.renderedCamera){var x=this.renderedCamera.getSurface(),b=x.videoWidth/x.clientWidth,v=x.videoHeight/x.clientHeight;if(!this.qrRegion)throw"qrRegion undefined when localMediaStream is ready.";var S=this.qrRegion.width*b,g=this.qrRegion.height*v,j=this.qrRegion.x*b,p=this.qrRegion.y*v;this.context.drawImage(x,j,p,S,g,0,0,this.qrRegion.width,this.qrRegion.height);var M=function(){f.foreverScanTimeout=setTimeout(function(){f.foreverScan(l,c,u)},f.getTimeoutFps(l.fps))};this.scanContext(c,u).then(function(B){!B&&l.disableFlip!==!0?(f.context.translate(f.context.canvas.width,0),f.context.scale(-1,1),f.scanContext(c,u).finally(function(){M()})):M()}).catch(function(B){f.logger.logError("Error happend while scanning context",B),M()})}},n.prototype.createVideoConstraints=function(l){if(typeof l=="string")return{deviceId:{exact:l}};if(typeof l=="object"){var c="facingMode",u="deviceId",f={user:!0,environment:!0},x="exact",b=function(k){if(k in f)return!0;throw"config has invalid 'facingMode' value = "+"'".concat(k,"'")},v=Object.keys(l);if(v.length!==1)throw"'cameraIdOrConfig' object should have exactly 1 key,"+" if passed as an object, found ".concat(v.length," keys");var S=Object.keys(l)[0];if(S!==c&&S!==u)throw"Only '".concat(c,"' and '").concat(u,"' ")+" are supported for 'cameraIdOrConfig'";if(S===c){var g=l.facingMode;if(typeof g=="string"){if(b(g))return{facingMode:g}}else if(typeof g=="object")if(x in g){if(b(g["".concat(x)]))return{facingMode:{exact:g["".concat(x)]}}}else throw"'facingMode' should be string or object with"+" ".concat(x," as key.");else{var j=typeof g;throw"Invalid type of 'facingMode' = ".concat(j)}}else{var p=l.deviceId;if(typeof p=="string")return{deviceId:p};if(typeof p=="object"){if(x in p)return{deviceId:{exact:p["".concat(x)]}};throw"'deviceId' should be string or object with"+" ".concat(x," as key.")}else{var M=typeof p;throw"Invalid type of 'deviceId' = ".concat(M)}}}var B=typeof l;throw"Invalid type of 'cameraIdOrConfig' = ".concat(B)},n.prototype.computeCanvasDrawConfig=function(l,c,u,f){if(l<=u&&c<=f){var x=(u-l)/2,b=(f-c)/2;return{x,y:b,width:l,height:c}}else{var v=l,S=c;return l>u&&(c=u/l*c,l=u),c>f&&(l=f/c*l,c=f),this.logger.log("Image downsampled from "+"".concat(v,"X").concat(S)+" to ".concat(l,"X").concat(c,".")),this.computeCanvasDrawConfig(l,c,u,f)}},n.prototype.clearElement=function(){if(this.stateManagerProxy.isScanning())throw"Cannot clear while scan is ongoing, close it first.";var l=document.getElementById(this.elementId);l&&(l.innerHTML="")},n.prototype.possiblyUpdateShaders=function(l){this.qrMatch!==l&&(this.hasBorderShaders&&this.borderShaders&&this.borderShaders.length&&this.borderShaders.forEach(function(c){c.style.backgroundColor=l?js.BORDER_SHADER_MATCH_COLOR:js.BORDER_SHADER_DEFAULT_COLOR}),this.qrMatch=l)},n.prototype.possiblyCloseLastScanImageFile=function(){this.lastScanImageFile&&(URL.revokeObjectURL(this.lastScanImageFile),this.lastScanImageFile=null)},n.prototype.createCanvasElement=function(l,c,u){var f=l,x=c,b=document.createElement("canvas");return b.style.width="".concat(f,"px"),b.style.height="".concat(x,"px"),b.style.display="none",b.id=Ys(u)?"qr-canvas":u,b},n.prototype.getShadedRegionBounds=function(l,c,u){if(u.width>l||u.height>c)throw"'config.qrbox' dimensions should not be greater than the dimensions of the root HTML element.";return{x:(l-u.width)/2,y:(c-u.height)/2,width:u.width,height:u.height}},n.prototype.possiblyInsertShadingElement=function(l,c,u,f){if(!(c-f.width<1||u-f.height<1)){var x=document.createElement("div");x.style.position="absolute";var b=(c-f.width)/2,v=(u-f.height)/2;if(x.style.borderLeft="".concat(b,"px solid rgba(0, 0, 0, 0.48)"),x.style.borderRight="".concat(b,"px solid rgba(0, 0, 0, 0.48)"),x.style.borderTop="".concat(v,"px solid rgba(0, 0, 0, 0.48)"),x.style.borderBottom="".concat(v,"px solid rgba(0, 0, 0, 0.48)"),x.style.boxSizing="border-box",x.style.top="0px",x.style.bottom="0px",x.style.left="0px",x.style.right="0px",x.id="".concat(js.SHADED_REGION_ELEMENT_ID),c-f.width<11||u-f.height<11)this.hasBorderShaders=!1;else{var S=5,g=40;this.insertShaderBorders(x,g,S,-S,null,0,!0),this.insertShaderBorders(x,g,S,-S,null,0,!1),this.insertShaderBorders(x,g,S,null,-S,0,!0),this.insertShaderBorders(x,g,S,null,-S,0,!1),this.insertShaderBorders(x,S,g+S,-S,null,-S,!0),this.insertShaderBorders(x,S,g+S,null,-S,-S,!0),this.insertShaderBorders(x,S,g+S,-S,null,-S,!1),this.insertShaderBorders(x,S,g+S,null,-S,-S,!1),this.hasBorderShaders=!0}l.append(x)}},n.prototype.insertShaderBorders=function(l,c,u,f,x,b,v){var S=document.createElement("div");S.style.position="absolute",S.style.backgroundColor=js.BORDER_SHADER_DEFAULT_COLOR,S.style.width="".concat(c,"px"),S.style.height="".concat(u,"px"),f!==null&&(S.style.top="".concat(f,"px")),x!==null&&(S.style.bottom="".concat(x,"px")),v?S.style.left="".concat(b,"px"):S.style.right="".concat(b,"px"),this.borderShaders||(this.borderShaders=[]),this.borderShaders.push(S),l.appendChild(S)},n.prototype.showPausedState=function(){if(!this.scannerPausedUiElement)throw"[internal error] scanner paused UI element not found";this.scannerPausedUiElement.style.display="block"},n.prototype.hidePausedState=function(){if(!this.scannerPausedUiElement)throw"[internal error] scanner paused UI element not found";this.scannerPausedUiElement.style.display="none"},n.prototype.getTimeoutFps=function(l){return 1e3/l},n}(),dn="data:image/svg+xml;base64,",Lc=dn+"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzNzEuNjQzIDM3MS42NDMiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDM3MS42NDMgMzcxLjY0MyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZD0iTTEwNS4wODQgMzguMjcxaDE2My43Njh2MjBIMTA1LjA4NHoiLz48cGF0aCBkPSJNMzExLjU5NiAxOTAuMTg5Yy03LjQ0MS05LjM0Ny0xOC40MDMtMTYuMjA2LTMyLjc0My0yMC41MjJWMzBjMC0xNi41NDItMTMuNDU4LTMwLTMwLTMwSDEyNS4wODRjLTE2LjU0MiAwLTMwIDEzLjQ1OC0zMCAzMHYxMjAuMTQzaC04LjI5NmMtMTYuNTQyIDAtMzAgMTMuNDU4LTMwIDMwdjEuMzMzYTI5LjgwNCAyOS44MDQgMCAwIDAgNC42MDMgMTUuOTM5Yy03LjM0IDUuNDc0LTEyLjEwMyAxNC4yMjEtMTIuMTAzIDI0LjA2MXYxLjMzM2MwIDkuODQgNC43NjMgMTguNTg3IDEyLjEwMyAyNC4wNjJhMjkuODEgMjkuODEgMCAwIDAtNC42MDMgMTUuOTM4djEuMzMzYzAgMTYuNTQyIDEzLjQ1OCAzMCAzMCAzMGg4LjMyNGMuNDI3IDExLjYzMSA3LjUwMyAyMS41ODcgMTcuNTM0IDI2LjE3Ny45MzEgMTAuNTAzIDQuMDg0IDMwLjE4NyAxNC43NjggNDUuNTM3YTkuOTg4IDkuOTg4IDAgMCAwIDguMjE2IDQuMjg4IDkuOTU4IDkuOTU4IDAgMCAwIDUuNzA0LTEuNzkzYzQuNTMzLTMuMTU1IDUuNjUtOS4zODggMi40OTUtMTMuOTIxLTYuNzk4LTkuNzY3LTkuNjAyLTIyLjYwOC0xMC43Ni0zMS40aDgyLjY4NWMuMjcyLjQxNC41NDUuODE4LjgxNSAxLjIxIDMuMTQyIDQuNTQxIDkuMzcyIDUuNjc5IDEzLjkxMyAyLjUzNCA0LjU0Mi0zLjE0MiA1LjY3Ny05LjM3MSAyLjUzNS0xMy45MTMtMTEuOTE5LTE3LjIyOS04Ljc4Ny0zNS44ODQgOS41ODEtNTcuMDEyIDMuMDY3LTIuNjUyIDEyLjMwNy0xMS43MzIgMTEuMjE3LTI0LjAzMy0uODI4LTkuMzQzLTcuMTA5LTE3LjE5NC0xOC42NjktMjMuMzM3YTkuODU3IDkuODU3IDAgMCAwLTEuMDYxLS40ODZjLS40NjYtLjE4Mi0xMS40MDMtNC41NzktOS43NDEtMTUuNzA2IDEuMDA3LTYuNzM3IDE0Ljc2OC04LjI3MyAyMy43NjYtNy42NjYgMjMuMTU2IDEuNTY5IDM5LjY5OCA3LjgwMyA0Ny44MzYgMTguMDI2IDUuNzUyIDcuMjI1IDcuNjA3IDE2LjYyMyA1LjY3MyAyOC43MzMtLjQxMyAyLjU4NS0uODI0IDUuMjQxLTEuMjQ1IDcuOTU5LTUuNzU2IDM3LjE5NC0xMi45MTkgODMuNDgzLTQ5Ljg3IDExNC42NjEtNC4yMjEgMy41NjEtNC43NTYgOS44Ny0xLjE5NCAxNC4wOTJhOS45OCA5Ljk4IDAgMCAwIDcuNjQ4IDMuNTUxIDkuOTU1IDkuOTU1IDAgMCAwIDYuNDQ0LTIuMzU4YzQyLjY3Mi0zNi4wMDUgNTAuODAyLTg4LjUzMyA1Ni43MzctMTI2Ljg4OC40MTUtMi42ODQuODIxLTUuMzA5IDEuMjI5LTcuODYzIDIuODM0LTE3LjcyMS0uNDU1LTMyLjY0MS05Ljc3Mi00NC4zNDV6bS0yMzIuMzA4IDQyLjYyYy01LjUxNCAwLTEwLTQuNDg2LTEwLTEwdi0xLjMzM2MwLTUuNTE0IDQuNDg2LTEwIDEwLTEwaDE1djIxLjMzM2gtMTV6bS0yLjUtNTIuNjY2YzAtNS41MTQgNC40ODYtMTAgMTAtMTBoNy41djIxLjMzM2gtNy41Yy01LjUxNCAwLTEwLTQuNDg2LTEwLTEwdi0xLjMzM3ptMTcuNSA5My45OTloLTcuNWMtNS41MTQgMC0xMC00LjQ4Ni0xMC0xMHYtMS4zMzNjMC01LjUxNCA0LjQ4Ni0xMCAxMC0xMGg3LjV2MjEuMzMzem0zMC43OTYgMjguODg3Yy01LjUxNCAwLTEwLTQuNDg2LTEwLTEwdi04LjI3MWg5MS40NTdjLS44NTEgNi42NjgtLjQzNyAxMi43ODcuNzMxIDE4LjI3MWgtODIuMTg4em03OS40ODItMTEzLjY5OGMtMy4xMjQgMjAuOTA2IDEyLjQyNyAzMy4xODQgMjEuNjI1IDM3LjA0IDUuNDQxIDIuOTY4IDcuNTUxIDUuNjQ3IDcuNzAxIDcuMTg4LjIxIDIuMTUtMi41NTMgNS42ODQtNC40NzcgNy4yNTEtLjQ4Mi4zNzgtLjkyOS44LTEuMzM1IDEuMjYxLTYuOTg3IDcuOTM2LTExLjk4MiAxNS41Mi0xNS40MzIgMjIuNjg4aC05Ny41NjRWMzBjMC01LjUxNCA0LjQ4Ni0xMCAxMC0xMGgxMjMuNzY5YzUuNTE0IDAgMTAgNC40ODYgMTAgMTB2MTM1LjU3OWMtMy4wMzItLjM4MS02LjE1LS42OTQtOS4zODktLjkxNC0yNS4xNTktMS42OTQtNDIuMzcgNy43NDgtNDQuODk4IDI0LjY2NnoiLz48cGF0aCBkPSJNMTc5LjEyOSA4My4xNjdoLTI0LjA2YTUgNSAwIDAgMC01IDV2MjQuMDYxYTUgNSAwIDAgMCA1IDVoMjQuMDZhNSA1IDAgMCAwIDUtNVY4OC4xNjdhNSA1IDAgMCAwLTUtNXpNMTcyLjYyOSAxNDIuODZoLTEyLjU2VjEzMC44YTUgNSAwIDEgMC0xMCAwdjE3LjA2MWE1IDUgMCAwIDAgNSA1aDE3LjU2YTUgNSAwIDEgMCAwLTEwLjAwMXpNMjE2LjU2OCA4My4xNjdoLTI0LjA2YTUgNSAwIDAgMC01IDV2MjQuMDYxYTUgNSAwIDAgMCA1IDVoMjQuMDZhNSA1IDAgMCAwIDUtNVY4OC4xNjdhNSA1IDAgMCAwLTUtNXptLTUgMjQuMDYxaC0xNC4wNlY5My4xNjdoMTQuMDZ2MTQuMDYxek0yMTEuNjY5IDEyNS45MzZIMTk3LjQxYTUgNSAwIDAgMC01IDV2MTQuMjU3YTUgNSAwIDAgMCA1IDVoMTQuMjU5YTUgNSAwIDAgMCA1LTV2LTE0LjI1N2E1IDUgMCAwIDAtNS01eiIvPjwvc3ZnPg==",Pc=dn+"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1OS4wMTggNTkuMDE4IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1OS4wMTggNTkuMDE4IiB4bWw6c3BhY2U9InByZXNlcnZlIj48cGF0aCBkPSJtNTguNzQxIDU0LjgwOS01Ljk2OS02LjI0NGExMC43NCAxMC43NCAwIDAgMCAyLjgyLTcuMjVjMC01Ljk1My00Ljg0My0xMC43OTYtMTAuNzk2LTEwLjc5NlMzNCAzNS4zNjEgMzQgNDEuMzE0IDM4Ljg0MyA1Mi4xMSA0NC43OTYgNTIuMTFjMi40NDEgMCA0LjY4OC0uODI0IDYuNDk5LTIuMTk2bDYuMDAxIDYuMjc3YS45OTguOTk4IDAgMCAwIDEuNDE0LjAzMiAxIDEgMCAwIDAgLjAzMS0xLjQxNHpNMzYgNDEuMzE0YzAtNC44NSAzLjk0Ni04Ljc5NiA4Ljc5Ni04Ljc5NnM4Ljc5NiAzLjk0NiA4Ljc5NiA4Ljc5Ni0zLjk0NiA4Ljc5Ni04Ljc5NiA4Ljc5NlMzNiA0Ni4xNjQgMzYgNDEuMzE0ek0xMC40MzEgMTYuMDg4YzAgMy4wNyAyLjQ5OCA1LjU2OCA1LjU2OSA1LjU2OHM1LjU2OS0yLjQ5OCA1LjU2OS01LjU2OGMwLTMuMDcxLTIuNDk4LTUuNTY5LTUuNTY5LTUuNTY5cy01LjU2OSAyLjQ5OC01LjU2OSA1LjU2OXptOS4xMzggMGMwIDEuOTY4LTEuNjAyIDMuNTY4LTMuNTY5IDMuNTY4cy0zLjU2OS0xLjYwMS0zLjU2OS0zLjU2OCAxLjYwMi0zLjU2OSAzLjU2OS0zLjU2OSAzLjU2OSAxLjYwMSAzLjU2OSAzLjU2OXoiLz48cGF0aCBkPSJtMzAuODgyIDI4Ljk4NyA5LjE4LTEwLjA1NCAxMS4yNjIgMTAuMzIzYTEgMSAwIDAgMCAxLjM1MS0xLjQ3NWwtMTItMTFhMSAxIDAgMCAwLTEuNDE0LjA2M2wtOS43OTQgMTAuNzI3LTQuNzQzLTQuNzQzYTEuMDAzIDEuMDAzIDAgMCAwLTEuMzY4LS4wNDRMNi4zMzkgMzcuNzY4YTEgMSAwIDEgMCAxLjMyMiAxLjUwMWwxNi4zMTMtMTQuMzYyIDcuMzE5IDcuMzE4YS45OTkuOTk5IDAgMSAwIDEuNDE0LTEuNDE0bC0xLjgyNS0xLjgyNHoiLz48cGF0aCBkPSJNMzAgNDYuNTE4SDJ2LTQyaDU0djI4YTEgMSAwIDEgMCAyIDB2LTI5YTEgMSAwIDAgMC0xLTFIMWExIDEgMCAwIDAtMSAxdjQ0YTEgMSAwIDAgMCAxIDFoMjlhMSAxIDAgMSAwIDAtMnoiLz48L3N2Zz4=",Qn=dn+"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NjAgNDYwIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA0NjAgNDYwIiB4bWw6c3BhY2U9InByZXNlcnZlIj48cGF0aCBkPSJNMjMwIDBDMTAyLjk3NSAwIDAgMTAyLjk3NSAwIDIzMHMxMDIuOTc1IDIzMCAyMzAgMjMwIDIzMC0xMDIuOTc0IDIzMC0yMzBTMzU3LjAyNSAwIDIzMCAwem0zOC4zMzMgMzc3LjM2YzAgOC42NzYtNy4wMzQgMTUuNzEtMTUuNzEgMTUuNzFoLTQzLjEwMWMtOC42NzYgMC0xNS43MS03LjAzNC0xNS43MS0xNS43MVYyMDIuNDc3YzAtOC42NzYgNy4wMzMtMTUuNzEgMTUuNzEtMTUuNzFoNDMuMTAxYzguNjc2IDAgMTUuNzEgNy4wMzMgMTUuNzEgMTUuNzFWMzc3LjM2ek0yMzAgMTU3Yy0yMS41MzkgMC0zOS0xNy40NjEtMzktMzlzMTcuNDYxLTM5IDM5LTM5IDM5IDE3LjQ2MSAzOSAzOS0xNy40NjEgMzktMzkgMzl6Ii8+PC9zdmc+",Bc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAQgAAAEIBarqQRAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAE1SURBVDiNfdI7S0NBEAXgLya1otFgpbYSbISAgpXYi6CmiH9KCAiChaVga6OiWPgfRDQ+0itaGVNosXtluWwcuMzePfM4M3sq8lbHBubwg1dc4m1E/J/N4ghDPOIsfk/4xiEao5KX0McFljN4C9d4QTPXuY99jP3DsIoDPGM6BY5i5yI5R7O4q+ImFkJY2DCh3cAH2klyB+9J1xUMMAG7eCh1a+Mr+k48b5diXrFVwwLuS+BJ9MfR7+G0FHOHhTHhnXNWS87VDF4pcnfQK4Ep7XScNLmPTZgURNKKYENYWDpzW1BhscS1WHS8CDgURFJQrWcoF3c13KKbgg1BYQfy8xZWEzTTw1QZbAoKu8FqJnktdu5hcVSHmchiILzzuaDQvjBzV2m8yohCE1jHfPx/xhU+y4G/D75ELlRJsSYAAAAASUVORK5CYII=",Kn=function(){function n(){}return n.createDefault=function(){return{hasPermission:!1,lastUsedCameraId:null}},n}(),Fc=function(){function n(){this.data=Kn.createDefault();var l=localStorage.getItem(n.LOCAL_STORAGE_KEY);l?this.data=JSON.parse(l):this.reset()}return n.prototype.hasCameraPermissions=function(){return this.data.hasPermission},n.prototype.getLastUsedCameraId=function(){return this.data.lastUsedCameraId},n.prototype.setHasPermission=function(l){this.data.hasPermission=l,this.flush()},n.prototype.setLastUsedCameraId=function(l){this.data.lastUsedCameraId=l,this.flush()},n.prototype.resetLastUsedCameraId=function(){this.data.lastUsedCameraId=null,this.flush()},n.prototype.reset=function(){this.data=Kn.createDefault(),this.flush()},n.prototype.flush=function(){localStorage.setItem(n.LOCAL_STORAGE_KEY,JSON.stringify(this.data))},n.LOCAL_STORAGE_KEY="HTML5_QRCODE_DATA",n}(),Uc=function(){function n(){this.infoDiv=document.createElement("div")}return n.prototype.renderInto=function(l){this.infoDiv.style.position="absolute",this.infoDiv.style.top="10px",this.infoDiv.style.right="10px",this.infoDiv.style.zIndex="2",this.infoDiv.style.display="none",this.infoDiv.style.padding="5pt",this.infoDiv.style.border="1px solid #171717",this.infoDiv.style.fontSize="10pt",this.infoDiv.style.background="rgb(0 0 0 / 69%)",this.infoDiv.style.borderRadius="5px",this.infoDiv.style.textAlign="center",this.infoDiv.style.fontWeight="400",this.infoDiv.style.color="white",this.infoDiv.innerText=qn.poweredBy();var c=document.createElement("a");c.innerText="ScanApp",c.href="https://scanapp.org",c.target="new",c.style.color="white",this.infoDiv.appendChild(c);var u=document.createElement("br"),f=document.createElement("br");this.infoDiv.appendChild(u),this.infoDiv.appendChild(f);var x=document.createElement("a");x.innerText=qn.reportIssues(),x.href="https://github.com/mebjas/html5-qrcode/issues",x.target="new",x.style.color="white",this.infoDiv.appendChild(x),l.appendChild(this.infoDiv)},n.prototype.show=function(){this.infoDiv.style.display="block"},n.prototype.hide=function(){this.infoDiv.style.display="none"},n}(),Vc=function(){function n(l,c){this.isShowingInfoIcon=!0,this.onTapIn=l,this.onTapOut=c,this.infoIcon=document.createElement("img")}return n.prototype.renderInto=function(l){var c=this;this.infoIcon.alt="Info icon",this.infoIcon.src=Qn,this.infoIcon.style.position="absolute",this.infoIcon.style.top="4px",this.infoIcon.style.right="4px",this.infoIcon.style.opacity="0.6",this.infoIcon.style.cursor="pointer",this.infoIcon.style.zIndex="2",this.infoIcon.style.width="16px",this.infoIcon.style.height="16px",this.infoIcon.onmouseover=function(u){return c.onHoverIn()},this.infoIcon.onmouseout=function(u){return c.onHoverOut()},this.infoIcon.onclick=function(u){return c.onClick()},l.appendChild(this.infoIcon)},n.prototype.onHoverIn=function(){this.isShowingInfoIcon&&(this.infoIcon.style.opacity="1")},n.prototype.onHoverOut=function(){this.isShowingInfoIcon&&(this.infoIcon.style.opacity="0.6")},n.prototype.onClick=function(){this.isShowingInfoIcon?(this.isShowingInfoIcon=!1,this.onTapIn(),this.infoIcon.src=Bc,this.infoIcon.style.opacity="1"):(this.isShowingInfoIcon=!0,this.onTapOut(),this.infoIcon.src=Qn,this.infoIcon.style.opacity="0.6")},n}(),qc=function(){function n(){var l=this;this.infoDiv=new Uc,this.infoIcon=new Vc(function(){l.infoDiv.show()},function(){l.infoDiv.hide()})}return n.prototype.renderInto=function(l){this.infoDiv.renderInto(l),this.infoIcon.renderInto(l)},n}(),Hc=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(j){try{g(u.next(j))}catch(p){b(p)}}function S(j){try{g(u.throw(j))}catch(p){b(p)}}function g(j){j.done?x(j.value):f(j.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},Gc=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(j){return S([g,j])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(j){g=[6,j],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},Jn=function(){function n(){}return n.hasPermissions=function(){return Hc(this,void 0,void 0,function(){var l,c,u,f;return Gc(this,function(x){switch(x.label){case 0:return[4,navigator.mediaDevices.enumerateDevices()];case 1:for(l=x.sent(),c=0,u=l;c<u.length;c++)if(f=u[c],f.kind==="videoinput"&&f.label)return[2,!0];return[2,!1]}})})},n}(),nr=function(){function n(l){this.supportedScanTypes=this.validateAndReturnScanTypes(l)}return n.prototype.getDefaultScanType=function(){return this.supportedScanTypes[0]},n.prototype.hasMoreThanOneScanType=function(){return this.supportedScanTypes.length>1},n.prototype.isCameraScanRequired=function(){for(var l=0,c=this.supportedScanTypes;l<c.length;l++){var u=c[l];if(n.isCameraScanType(u))return!0}return!1},n.isCameraScanType=function(l){return l===ur.SCAN_TYPE_CAMERA},n.isFileScanType=function(l){return l===ur.SCAN_TYPE_FILE},n.prototype.validateAndReturnScanTypes=function(l){if(!l||l.length===0)return Ps.DEFAULT_SUPPORTED_SCAN_TYPE;var c=Ps.DEFAULT_SUPPORTED_SCAN_TYPE.length;if(l.length>c)throw"Max ".concat(c," values expected for ")+"supportedScanTypes";for(var u=0,f=l;u<f.length;u++){var x=f[u];if(!Ps.DEFAULT_SUPPORTED_SCAN_TYPE.includes(x))throw"Unsupported scan type ".concat(x)}return l},n}(),Es=function(){function n(){}return n.ALL_ELEMENT_CLASS="html5-qrcode-element",n.CAMERA_PERMISSION_BUTTON_ID="html5-qrcode-button-camera-permission",n.CAMERA_START_BUTTON_ID="html5-qrcode-button-camera-start",n.CAMERA_STOP_BUTTON_ID="html5-qrcode-button-camera-stop",n.TORCH_BUTTON_ID="html5-qrcode-button-torch",n.CAMERA_SELECTION_SELECT_ID="html5-qrcode-select-camera",n.FILE_SELECTION_BUTTON_ID="html5-qrcode-button-file-selection",n.ZOOM_SLIDER_ID="html5-qrcode-input-range-zoom",n.SCAN_TYPE_CHANGE_ANCHOR_ID="html5-qrcode-anchor-scan-type-change",n.TORCH_BUTTON_CLASS_TORCH_ON="html5-qrcode-button-torch-on",n.TORCH_BUTTON_CLASS_TORCH_OFF="html5-qrcode-button-torch-off",n}(),Qs=function(){function n(){}return n.createElement=function(l,c){var u=document.createElement(l);return u.id=c,u.classList.add(Es.ALL_ELEMENT_CLASS),l==="button"&&u.setAttribute("type","button"),u},n}(),Bi=function(n,l,c,u){function f(x){return x instanceof c?x:new c(function(b){b(x)})}return new(c||(c=Promise))(function(x,b){function v(j){try{g(u.next(j))}catch(p){b(p)}}function S(j){try{g(u.throw(j))}catch(p){b(p)}}function g(j){j.done?x(j.value):f(j.value).then(v,S)}g((u=u.apply(n,l||[])).next())})},Fi=function(n,l){var c={label:0,sent:function(){if(x[0]&1)throw x[1];return x[1]},trys:[],ops:[]},u,f,x,b;return b={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function v(g){return function(j){return S([g,j])}}function S(g){if(u)throw new TypeError("Generator is already executing.");for(;b&&(b=0,g[0]&&(c=0)),c;)try{if(u=1,f&&(x=g[0]&2?f.return:g[0]?f.throw||((x=f.return)&&x.call(f),0):f.next)&&!(x=x.call(f,g[1])).done)return x;switch(f=0,x&&(g=[g[0]&2,x.value]),g[0]){case 0:case 1:x=g;break;case 4:return c.label++,{value:g[1],done:!1};case 5:c.label++,f=g[1],g=[0];continue;case 7:g=c.ops.pop(),c.trys.pop();continue;default:if(x=c.trys,!(x=x.length>0&&x[x.length-1])&&(g[0]===6||g[0]===2)){c=0;continue}if(g[0]===3&&(!x||g[1]>x[0]&&g[1]<x[3])){c.label=g[1];break}if(g[0]===6&&c.label<x[1]){c.label=x[1],x=g;break}if(x&&c.label<x[2]){c.label=x[2],c.ops.push(g);break}x[2]&&c.ops.pop(),c.trys.pop();continue}g=l.call(n,c)}catch(j){g=[6,j],f=0}finally{u=x=0}if(g[0]&5)throw g[1];return{value:g[0]?g[1]:void 0,done:!0}}},ei=function(){function n(l,c,u){this.isTorchOn=!1,this.torchCapability=l,this.buttonController=c,this.onTorchActionFailureCallback=u}return n.prototype.isTorchEnabled=function(){return this.isTorchOn},n.prototype.flipState=function(){return Bi(this,void 0,void 0,function(){var l,c;return Fi(this,function(u){switch(u.label){case 0:this.buttonController.disable(),l=!this.isTorchOn,u.label=1;case 1:return u.trys.push([1,3,,4]),[4,this.torchCapability.apply(l)];case 2:return u.sent(),this.updateUiBasedOnLatestSettings(this.torchCapability.value(),l),[3,4];case 3:return c=u.sent(),this.propagateFailure(l,c),this.buttonController.enable(),[3,4];case 4:return[2]}})})},n.prototype.updateUiBasedOnLatestSettings=function(l,c){l===c?(this.buttonController.setText(c?It.torchOffButton():It.torchOnButton()),this.isTorchOn=c):this.propagateFailure(c),this.buttonController.enable()},n.prototype.propagateFailure=function(l,c){var u=l?It.torchOnFailedMessage():It.torchOffFailedMessage();c&&(u+="; Error = "+c),this.onTorchActionFailureCallback(u)},n.prototype.reset=function(){this.isTorchOn=!1},n}(),Wc=function(){function n(l,c){this.onTorchActionFailureCallback=c,this.torchButton=Qs.createElement("button",Es.TORCH_BUTTON_ID),this.torchController=new ei(l,this,c)}return n.prototype.render=function(l,c){var u=this;this.torchButton.innerText=It.torchOnButton(),this.torchButton.style.display=c.display,this.torchButton.style.marginLeft=c.marginLeft;var f=this;this.torchButton.addEventListener("click",function(x){return Bi(u,void 0,void 0,function(){return Fi(this,function(b){switch(b.label){case 0:return[4,f.torchController.flipState()];case 1:return b.sent(),f.torchController.isTorchEnabled()?(f.torchButton.classList.remove(Es.TORCH_BUTTON_CLASS_TORCH_OFF),f.torchButton.classList.add(Es.TORCH_BUTTON_CLASS_TORCH_ON)):(f.torchButton.classList.remove(Es.TORCH_BUTTON_CLASS_TORCH_ON),f.torchButton.classList.add(Es.TORCH_BUTTON_CLASS_TORCH_OFF)),[2]}})})}),l.appendChild(this.torchButton)},n.prototype.updateTorchCapability=function(l){this.torchController=new ei(l,this,this.onTorchActionFailureCallback)},n.prototype.getTorchButton=function(){return this.torchButton},n.prototype.hide=function(){this.torchButton.style.display="none"},n.prototype.show=function(){this.torchButton.style.display="inline-block"},n.prototype.disable=function(){this.torchButton.disabled=!0},n.prototype.enable=function(){this.torchButton.disabled=!1},n.prototype.setText=function(l){this.torchButton.innerText=l},n.prototype.reset=function(){this.torchButton.innerText=It.torchOnButton(),this.torchController.reset()},n.create=function(l,c,u,f){var x=new n(c,f);return x.render(l,u),x},n}(),Yc=function(){function n(l,c,u){this.fileBasedScanRegion=this.createFileBasedScanRegion(),this.fileBasedScanRegion.style.display=c?"block":"none",l.appendChild(this.fileBasedScanRegion);var f=document.createElement("label");f.setAttribute("for",this.getFileScanInputId()),f.style.display="inline-block",this.fileBasedScanRegion.appendChild(f),this.fileSelectionButton=Qs.createElement("button",Es.FILE_SELECTION_BUTTON_ID),this.setInitialValueToButton(),this.fileSelectionButton.addEventListener("click",function(v){f.click()}),f.append(this.fileSelectionButton),this.fileScanInput=Qs.createElement("input",this.getFileScanInputId()),this.fileScanInput.type="file",this.fileScanInput.accept="image/*",this.fileScanInput.style.display="none",f.appendChild(this.fileScanInput);var x=this;this.fileScanInput.addEventListener("change",function(v){if(!(v==null||v.target==null)){var S=v.target;if(!(S.files&&S.files.length===0)){var g=S.files,j=g[0],p=j.name;x.setImageNameToButton(p),u(j)}}});var b=this.createDragAndDropMessage();this.fileBasedScanRegion.appendChild(b),this.fileBasedScanRegion.addEventListener("dragenter",function(v){x.fileBasedScanRegion.style.border=x.fileBasedScanRegionActiveBorder(),v.stopPropagation(),v.preventDefault()}),this.fileBasedScanRegion.addEventListener("dragleave",function(v){x.fileBasedScanRegion.style.border=x.fileBasedScanRegionDefaultBorder(),v.stopPropagation(),v.preventDefault()}),this.fileBasedScanRegion.addEventListener("dragover",function(v){x.fileBasedScanRegion.style.border=x.fileBasedScanRegionActiveBorder(),v.stopPropagation(),v.preventDefault()}),this.fileBasedScanRegion.addEventListener("drop",function(v){v.stopPropagation(),v.preventDefault(),x.fileBasedScanRegion.style.border=x.fileBasedScanRegionDefaultBorder();var S=v.dataTransfer;if(S){var g=S.files;if(!g||g.length===0)return;for(var j=!1,p=0;p<g.length;++p){var M=g.item(p);if(M){var B=/image.*/;if(M.type.match(B)){j=!0;var k=M.name;x.setImageNameToButton(k),u(M),b.innerText=It.dragAndDropMessage();break}}}j||(b.innerText=It.dragAndDropMessageOnlyImages())}})}return n.prototype.hide=function(){this.fileBasedScanRegion.style.display="none",this.fileScanInput.disabled=!0},n.prototype.show=function(){this.fileBasedScanRegion.style.display="block",this.fileScanInput.disabled=!1},n.prototype.isShowing=function(){return this.fileBasedScanRegion.style.display==="block"},n.prototype.resetValue=function(){this.fileScanInput.value="",this.setInitialValueToButton()},n.prototype.createFileBasedScanRegion=function(){var l=document.createElement("div");return l.style.textAlign="center",l.style.margin="auto",l.style.width="80%",l.style.maxWidth="600px",l.style.border=this.fileBasedScanRegionDefaultBorder(),l.style.padding="10px",l.style.marginBottom="10px",l},n.prototype.fileBasedScanRegionDefaultBorder=function(){return"6px dashed #ebebeb"},n.prototype.fileBasedScanRegionActiveBorder=function(){return"6px dashed rgb(153 151 151)"},n.prototype.createDragAndDropMessage=function(){var l=document.createElement("div");return l.innerText=It.dragAndDropMessage(),l.style.fontWeight="400",l},n.prototype.setImageNameToButton=function(l){var c=20;if(l.length>c){var u=l.substring(0,8),f=l.length,x=l.substring(f-8,f);l="".concat(u,"....").concat(x)}var b=It.fileSelectionChooseAnother()+" - "+l;this.fileSelectionButton.innerText=b},n.prototype.setInitialValueToButton=function(){var l=It.fileSelectionChooseImage()+" - "+It.fileSelectionNoImageSelected();this.fileSelectionButton.innerText=l},n.prototype.getFileScanInputId=function(){return"html5-qrcode-private-filescan-input"},n.create=function(l,c,u){var f=new n(l,c,u);return f},n}(),$c=function(){function n(l){this.selectElement=Qs.createElement("select",Es.CAMERA_SELECTION_SELECT_ID),this.cameras=l,this.options=[]}return n.prototype.render=function(l){var c=document.createElement("span");c.style.marginRight="10px";var u=this.cameras.length;if(u===0)throw new Error("No cameras found");if(u===1)c.style.display="none";else{var f=It.selectCamera();c.innerText="".concat(f," (").concat(this.cameras.length,")  ")}for(var x=1,b=0,v=this.cameras;b<v.length;b++){var S=v[b],g=S.id,j=S.label==null?g:S.label;(!j||j==="")&&(j=[It.anonymousCameraPrefix(),x++].join(" "));var p=document.createElement("option");p.value=g,p.innerText=j,this.options.push(p),this.selectElement.appendChild(p)}c.appendChild(this.selectElement),l.appendChild(c)},n.prototype.disable=function(){this.selectElement.disabled=!0},n.prototype.isDisabled=function(){return this.selectElement.disabled===!0},n.prototype.enable=function(){this.selectElement.disabled=!1},n.prototype.getValue=function(){return this.selectElement.value},n.prototype.hasValue=function(l){for(var c=0,u=this.options;c<u.length;c++){var f=u[c];if(f.value===l)return!0}return!1},n.prototype.setValue=function(l){if(!this.hasValue(l))throw new Error("".concat(l," is not present in the camera list."));this.selectElement.value=l},n.prototype.hasSingleItem=function(){return this.cameras.length===1},n.prototype.numCameras=function(){return this.cameras.length},n.create=function(l,c){var u=new n(c);return u.render(l),u},n}(),Xc=function(){function n(){this.onChangeCallback=null,this.zoomElementContainer=document.createElement("div"),this.rangeInput=Qs.createElement("input",Es.ZOOM_SLIDER_ID),this.rangeInput.type="range",this.rangeText=document.createElement("span"),this.rangeInput.min="1",this.rangeInput.max="5",this.rangeInput.value="1",this.rangeInput.step="0.1"}return n.prototype.render=function(l,c){this.zoomElementContainer.style.display=c?"block":"none",this.zoomElementContainer.style.padding="5px 10px",this.zoomElementContainer.style.textAlign="center",l.appendChild(this.zoomElementContainer),this.rangeInput.style.display="inline-block",this.rangeInput.style.width="50%",this.rangeInput.style.height="5px",this.rangeInput.style.background="#d3d3d3",this.rangeInput.style.outline="none",this.rangeInput.style.opacity="0.7";var u=It.zoom();this.rangeText.innerText="".concat(this.rangeInput.value,"x ").concat(u),this.rangeText.style.marginRight="10px";var f=this;this.rangeInput.addEventListener("input",function(){return f.onValueChange()}),this.rangeInput.addEventListener("change",function(){return f.onValueChange()}),this.zoomElementContainer.appendChild(this.rangeInput),this.zoomElementContainer.appendChild(this.rangeText)},n.prototype.onValueChange=function(){var l=It.zoom();this.rangeText.innerText="".concat(this.rangeInput.value,"x ").concat(l),this.onChangeCallback&&this.onChangeCallback(parseFloat(this.rangeInput.value))},n.prototype.setValues=function(l,c,u,f){this.rangeInput.min=l.toString(),this.rangeInput.max=c.toString(),this.rangeInput.step=f.toString(),this.rangeInput.value=u.toString(),this.onValueChange()},n.prototype.show=function(){this.zoomElementContainer.style.display="block"},n.prototype.hide=function(){this.zoomElementContainer.style.display="none"},n.prototype.setOnCameraZoomValueChangeCallback=function(l){this.onChangeCallback=l},n.prototype.removeOnCameraZoomValueChangeCallback=function(){this.onChangeCallback=null},n.create=function(l,c){var u=new n;return u.render(l,c),u},n}(),Cs;(function(n){n[n.STATUS_DEFAULT=0]="STATUS_DEFAULT",n[n.STATUS_SUCCESS=1]="STATUS_SUCCESS",n[n.STATUS_WARNING=2]="STATUS_WARNING",n[n.STATUS_REQUESTING_PERMISSION=3]="STATUS_REQUESTING_PERMISSION"})(Cs||(Cs={}));function Zc(n){return{fps:n.fps,qrbox:n.qrbox,aspectRatio:n.aspectRatio,disableFlip:n.disableFlip,videoConstraints:n.videoConstraints}}function Qc(n,l){return{formatsToSupport:n.formatsToSupport,useBarCodeDetectorIfSupported:n.useBarCodeDetectorIfSupported,experimentalFeatures:n.experimentalFeatures,verbose:l}}var Kc=function(){function n(l,c,u){if(this.lastMatchFound=null,this.cameraScanImage=null,this.fileScanImage=null,this.fileSelectionUi=null,this.elementId=l,this.config=this.createConfig(c),this.verbose=u===!0,!document.getElementById(l))throw"HTML Element with id=".concat(l," not found");this.scanTypeSelector=new nr(this.config.supportedScanTypes),this.currentScanType=this.scanTypeSelector.getDefaultScanType(),this.sectionSwapAllowed=!0,this.logger=new Ri(this.verbose),this.persistedDataManager=new Fc,c.rememberLastUsedCamera!==!0&&this.persistedDataManager.reset()}return n.prototype.render=function(l,c){var u=this;this.lastMatchFound=null,this.qrCodeSuccessCallback=function(x,b){if(l)l(x,b);else{if(u.lastMatchFound===x)return;u.lastMatchFound=x,u.setHeaderMessage(It.lastMatch(x),Cs.STATUS_SUCCESS)}},this.qrCodeErrorCallback=function(x,b){c&&c(x,b)};var f=document.getElementById(this.elementId);if(!f)throw"HTML Element with id=".concat(this.elementId," not found");f.innerHTML="",this.createBasicLayout(f),this.html5Qrcode=new Zn(this.getScanRegionId(),Qc(this.config,this.verbose))},n.prototype.pause=function(l){(Ys(l)||l!==!0)&&(l=!1),this.getHtml5QrcodeOrFail().pause(l)},n.prototype.resume=function(){this.getHtml5QrcodeOrFail().resume()},n.prototype.getState=function(){return this.getHtml5QrcodeOrFail().getState()},n.prototype.clear=function(){var l=this,c=function(){var u=document.getElementById(l.elementId);u&&(u.innerHTML="",l.resetBasicLayout(u))};return this.html5Qrcode?new Promise(function(u,f){if(!l.html5Qrcode){u();return}l.html5Qrcode.isScanning?l.html5Qrcode.stop().then(function(x){if(!l.html5Qrcode){u();return}l.html5Qrcode.clear(),c(),u()}).catch(function(x){l.verbose&&l.logger.logError("Unable to stop qrcode scanner",x),f(x)}):(l.html5Qrcode.clear(),c(),u())}):Promise.resolve()},n.prototype.getRunningTrackCapabilities=function(){return this.getHtml5QrcodeOrFail().getRunningTrackCapabilities()},n.prototype.getRunningTrackSettings=function(){return this.getHtml5QrcodeOrFail().getRunningTrackSettings()},n.prototype.applyVideoConstraints=function(l){return this.getHtml5QrcodeOrFail().applyVideoConstraints(l)},n.prototype.getHtml5QrcodeOrFail=function(){if(!this.html5Qrcode)throw"Code scanner not initialized.";return this.html5Qrcode},n.prototype.createConfig=function(l){return l?(l.fps||(l.fps=Ps.SCAN_DEFAULT_FPS),l.rememberLastUsedCamera!==!Ps.DEFAULT_REMEMBER_LAST_CAMERA_USED&&(l.rememberLastUsedCamera=Ps.DEFAULT_REMEMBER_LAST_CAMERA_USED),l.supportedScanTypes||(l.supportedScanTypes=Ps.DEFAULT_SUPPORTED_SCAN_TYPE),l):{fps:Ps.SCAN_DEFAULT_FPS,rememberLastUsedCamera:Ps.DEFAULT_REMEMBER_LAST_CAMERA_USED,supportedScanTypes:Ps.DEFAULT_SUPPORTED_SCAN_TYPE}},n.prototype.createBasicLayout=function(l){l.style.position="relative",l.style.padding="0px",l.style.border="1px solid silver",this.createHeader(l);var c=document.createElement("div"),u=this.getScanRegionId();c.id=u,c.style.width="100%",c.style.minHeight="100px",c.style.textAlign="center",l.appendChild(c),nr.isCameraScanType(this.currentScanType)?this.insertCameraScanImageToScanRegion():this.insertFileScanImageToScanRegion();var f=document.createElement("div"),x=this.getDashboardId();f.id=x,f.style.width="100%",l.appendChild(f),this.setupInitialDashboard(f)},n.prototype.resetBasicLayout=function(l){l.style.border="none"},n.prototype.setupInitialDashboard=function(l){this.createSection(l),this.createSectionControlPanel(),this.scanTypeSelector.hasMoreThanOneScanType()&&this.createSectionSwap()},n.prototype.createHeader=function(l){var c=document.createElement("div");c.style.textAlign="left",c.style.margin="0px",l.appendChild(c);var u=new qc;u.renderInto(c);var f=document.createElement("div");f.id=this.getHeaderMessageContainerId(),f.style.display="none",f.style.textAlign="center",f.style.fontSize="14px",f.style.padding="2px 10px",f.style.margin="4px",f.style.borderTop="1px solid #f6f6f6",c.appendChild(f)},n.prototype.createSection=function(l){var c=document.createElement("div");c.id=this.getDashboardSectionId(),c.style.width="100%",c.style.padding="10px 0px 10px 0px",c.style.textAlign="left",l.appendChild(c)},n.prototype.createCameraListUi=function(l,c,u){var f=this;f.showHideScanTypeSwapLink(!1),f.setHeaderMessage(It.cameraPermissionRequesting());var x=function(){u||f.createPermissionButton(l,c)};Zn.getCameras().then(function(b){f.persistedDataManager.setHasPermission(!0),f.showHideScanTypeSwapLink(!0),f.resetHeaderMessage(),b&&b.length>0?(l.removeChild(c),f.renderCameraSelection(b)):(f.setHeaderMessage(It.noCameraFound(),Cs.STATUS_WARNING),x())}).catch(function(b){f.persistedDataManager.setHasPermission(!1),u?u.disabled=!1:x(),f.setHeaderMessage(b,Cs.STATUS_WARNING),f.showHideScanTypeSwapLink(!0)})},n.prototype.createPermissionButton=function(l,c){var u=this,f=Qs.createElement("button",this.getCameraPermissionButtonId());f.innerText=It.cameraPermissionTitle(),f.addEventListener("click",function(){f.disabled=!0,u.createCameraListUi(l,c,f)}),c.appendChild(f)},n.prototype.createPermissionsUi=function(l,c){var u=this;if(nr.isCameraScanType(this.currentScanType)&&this.persistedDataManager.hasCameraPermissions()){Jn.hasPermissions().then(function(f){f?u.createCameraListUi(l,c):(u.persistedDataManager.setHasPermission(!1),u.createPermissionButton(l,c))}).catch(function(f){u.persistedDataManager.setHasPermission(!1),u.createPermissionButton(l,c)});return}this.createPermissionButton(l,c)},n.prototype.createSectionControlPanel=function(){var l=document.getElementById(this.getDashboardSectionId()),c=document.createElement("div");l.appendChild(c);var u=document.createElement("div");u.id=this.getDashboardSectionCameraScanRegionId(),u.style.display=nr.isCameraScanType(this.currentScanType)?"block":"none",c.appendChild(u);var f=document.createElement("div");f.style.textAlign="center",u.appendChild(f),this.scanTypeSelector.isCameraScanRequired()&&this.createPermissionsUi(u,f),this.renderFileScanUi(c)},n.prototype.renderFileScanUi=function(l){var c=nr.isFileScanType(this.currentScanType),u=this,f=function(x){if(!u.html5Qrcode)throw"html5Qrcode not defined";nr.isFileScanType(u.currentScanType)&&(u.setHeaderMessage(It.loadingImage()),u.html5Qrcode.scanFileV2(x,!0).then(function(b){u.resetHeaderMessage(),u.qrCodeSuccessCallback(b.decodedText,b)}).catch(function(b){u.setHeaderMessage(b,Cs.STATUS_WARNING),u.qrCodeErrorCallback(b,Oi.createFrom(b))}))};this.fileSelectionUi=Yc.create(l,c,f)},n.prototype.renderCameraSelection=function(l){var c=this,u=this,f=document.getElementById(this.getDashboardSectionCameraScanRegionId());f.style.textAlign="center";var x=Xc.create(f,!1),b=function(R){var C=R.zoomFeature();if(C.isSupported()){x.setOnCameraZoomValueChangeCallback(function(E){C.apply(E)});var D=1;c.config.defaultZoomValueIfSupported&&(D=c.config.defaultZoomValueIfSupported),D=gc(D,C.min(),C.max()),x.setValues(C.min(),C.max(),D,C.step()),x.show()}},v=$c.create(f,l),S=document.createElement("span"),g=Qs.createElement("button",Es.CAMERA_START_BUTTON_ID);g.innerText=It.scanButtonStartScanningText(),S.appendChild(g);var j=Qs.createElement("button",Es.CAMERA_STOP_BUTTON_ID);j.innerText=It.scanButtonStopScanningText(),j.style.display="none",j.disabled=!0,S.appendChild(j);var p,M=function(R){if(!R.torchFeature().isSupported()){p&&p.hide();return}p?p.updateTorchCapability(R.torchFeature()):p=Wc.create(S,R.torchFeature(),{display:"none",marginLeft:"5px"},function(C){u.setHeaderMessage(C,Cs.STATUS_WARNING)}),p.show()};f.appendChild(S);var B=function(R){R||(g.style.display="none"),g.innerText=It.scanButtonStartScanningText(),g.style.opacity="1",g.disabled=!1,R&&(g.style.display="inline-block")};if(g.addEventListener("click",function(R){g.innerText=It.scanButtonScanningStarting(),v.disable(),g.disabled=!0,g.style.opacity="0.5",c.scanTypeSelector.hasMoreThanOneScanType()&&u.showHideScanTypeSwapLink(!1),u.resetHeaderMessage();var C=v.getValue();u.persistedDataManager.setLastUsedCameraId(C),u.html5Qrcode.start(C,Zc(u.config),u.qrCodeSuccessCallback,u.qrCodeErrorCallback).then(function(D){j.disabled=!1,j.style.display="inline-block",B(!1);var E=u.html5Qrcode.getRunningTrackCameraCapabilities();c.config.showTorchButtonIfSupported===!0&&M(E),c.config.showZoomSliderIfSupported===!0&&b(E)}).catch(function(D){u.showHideScanTypeSwapLink(!0),v.enable(),B(!0),u.setHeaderMessage(D,Cs.STATUS_WARNING)})}),v.hasSingleItem()&&g.click(),j.addEventListener("click",function(R){if(!u.html5Qrcode)throw"html5Qrcode not defined";j.disabled=!0,u.html5Qrcode.stop().then(function(C){c.scanTypeSelector.hasMoreThanOneScanType()&&u.showHideScanTypeSwapLink(!0),v.enable(),g.disabled=!1,j.style.display="none",g.style.display="inline-block",p&&(p.reset(),p.hide()),x.removeOnCameraZoomValueChangeCallback(),x.hide(),u.insertCameraScanImageToScanRegion()}).catch(function(C){j.disabled=!1,u.setHeaderMessage(C,Cs.STATUS_WARNING)})}),u.persistedDataManager.getLastUsedCameraId()){var k=u.persistedDataManager.getLastUsedCameraId();v.hasValue(k)?(v.setValue(k),g.click()):u.persistedDataManager.resetLastUsedCameraId()}},n.prototype.createSectionSwap=function(){var l=this,c=It.textIfCameraScanSelected(),u=It.textIfFileScanSelected(),f=document.getElementById(this.getDashboardSectionId()),x=document.createElement("div");x.style.textAlign="center";var b=Qs.createElement("span",this.getDashboardSectionSwapLinkId());b.style.textDecoration="underline",b.style.cursor="pointer",b.innerText=nr.isCameraScanType(this.currentScanType)?c:u,b.addEventListener("click",function(){if(!l.sectionSwapAllowed){l.verbose&&l.logger.logError("Section swap called when not allowed");return}l.resetHeaderMessage(),l.fileSelectionUi.resetValue(),l.sectionSwapAllowed=!1,nr.isCameraScanType(l.currentScanType)?(l.clearScanRegion(),l.getCameraScanRegion().style.display="none",l.fileSelectionUi.show(),b.innerText=u,l.currentScanType=ur.SCAN_TYPE_FILE,l.insertFileScanImageToScanRegion()):(l.clearScanRegion(),l.getCameraScanRegion().style.display="block",l.fileSelectionUi.hide(),b.innerText=c,l.currentScanType=ur.SCAN_TYPE_CAMERA,l.insertCameraScanImageToScanRegion(),l.startCameraScanIfPermissionExistsOnSwap()),l.sectionSwapAllowed=!0}),x.appendChild(b),f.appendChild(x)},n.prototype.startCameraScanIfPermissionExistsOnSwap=function(){var l=this,c=this;if(this.persistedDataManager.hasCameraPermissions()){Jn.hasPermissions().then(function(u){if(u){var f=document.getElementById(c.getCameraPermissionButtonId());if(!f)throw l.logger.logError("Permission button not found, fail;"),"Permission button not found";f.click()}else c.persistedDataManager.setHasPermission(!1)}).catch(function(u){c.persistedDataManager.setHasPermission(!1)});return}},n.prototype.resetHeaderMessage=function(){var l=document.getElementById(this.getHeaderMessageContainerId());l.style.display="none"},n.prototype.setHeaderMessage=function(l,c){c||(c=Cs.STATUS_DEFAULT);var u=this.getHeaderMessageDiv();switch(u.innerText=l,u.style.display="block",c){case Cs.STATUS_SUCCESS:u.style.background="rgba(106, 175, 80, 0.26)",u.style.color="#477735";break;case Cs.STATUS_WARNING:u.style.background="rgba(203, 36, 49, 0.14)",u.style.color="#cb2431";break;case Cs.STATUS_DEFAULT:default:u.style.background="rgba(0, 0, 0, 0)",u.style.color="rgb(17, 17, 17)";break}},n.prototype.showHideScanTypeSwapLink=function(l){this.scanTypeSelector.hasMoreThanOneScanType()&&(l!==!0&&(l=!1),this.sectionSwapAllowed=l,this.getDashboardSectionSwapLink().style.display=l?"inline-block":"none")},n.prototype.insertCameraScanImageToScanRegion=function(){var l=this,c=document.getElementById(this.getScanRegionId());if(this.cameraScanImage){c.innerHTML="<br>",c.appendChild(this.cameraScanImage);return}this.cameraScanImage=new Image,this.cameraScanImage.onload=function(u){c.innerHTML="<br>",c.appendChild(l.cameraScanImage)},this.cameraScanImage.width=64,this.cameraScanImage.style.opacity="0.8",this.cameraScanImage.src=Lc,this.cameraScanImage.alt=It.cameraScanAltText()},n.prototype.insertFileScanImageToScanRegion=function(){var l=this,c=document.getElementById(this.getScanRegionId());if(this.fileScanImage){c.innerHTML="<br>",c.appendChild(this.fileScanImage);return}this.fileScanImage=new Image,this.fileScanImage.onload=function(u){c.innerHTML="<br>",c.appendChild(l.fileScanImage)},this.fileScanImage.width=64,this.fileScanImage.style.opacity="0.8",this.fileScanImage.src=Pc,this.fileScanImage.alt=It.fileScanAltText()},n.prototype.clearScanRegion=function(){var l=document.getElementById(this.getScanRegionId());l.innerHTML=""},n.prototype.getDashboardSectionId=function(){return"".concat(this.elementId,"__dashboard_section")},n.prototype.getDashboardSectionCameraScanRegionId=function(){return"".concat(this.elementId,"__dashboard_section_csr")},n.prototype.getDashboardSectionSwapLinkId=function(){return Es.SCAN_TYPE_CHANGE_ANCHOR_ID},n.prototype.getScanRegionId=function(){return"".concat(this.elementId,"__scan_region")},n.prototype.getDashboardId=function(){return"".concat(this.elementId,"__dashboard")},n.prototype.getHeaderMessageContainerId=function(){return"".concat(this.elementId,"__header_message")},n.prototype.getCameraPermissionButtonId=function(){return Es.CAMERA_PERMISSION_BUTTON_ID},n.prototype.getCameraScanRegion=function(){return document.getElementById(this.getDashboardSectionCameraScanRegionId())},n.prototype.getDashboardSectionSwapLink=function(){return document.getElementById(this.getDashboardSectionSwapLinkId())},n.prototype.getHeaderMessageDiv=function(){return document.getElementById(this.getHeaderMessageContainerId())},n}();const un=()=>{const[n,l]=w.useState(null),[c,u]=w.useState(!1),[f,x]=w.useState(null),[b,v]=w.useState(null),S=async(M,B)=>{try{const k=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${M}&lon=${B}&zoom=18&addressdetails=1`,{headers:{"User-Agent":"CrewManager-Mobile/1.0"}});if(!k.ok)throw new Error("Servizio geocoding non disponibile");const R=await k.json();return R&&R.display_name?R.display_name:`${M.toFixed(6)}, ${B.toFixed(6)}`}catch(k){return console.error("Errore reverse geocoding:",k),`Lat: ${M.toFixed(6)}, Lng: ${B.toFixed(6)}`}},g=w.useCallback(async(M={})=>{const{requiredAccuracy:B=10,maxRetries:k=3,retryDelay:R=2e3}=M;u(!0),x(null);let C=0,D=null;for(;C<k;){try{const E=await new Promise((q,J)=>{navigator.geolocation.getCurrentPosition(q,J,{enableHighAccuracy:!0,timeout:C===0?15e3:3e4,maximumAge:0})}),U=Math.round(E.coords.accuracy);if(v(U),(!D||U<D.coords.accuracy)&&(D=E),U<=B){console.log(`‚úÖ GPS precisione raggiunta: ${U}m (richiesti ‚â§${B}m)`);break}console.log(`üéØ Tentativo ${C+1}: precisione ${U}m (target ‚â§${B}m)`),C<k-1&&await new Promise(q=>setTimeout(q,R))}catch(E){if(console.error(`‚ùå Errore GPS tentativo ${C+1}:`,E),C===k-1)return x(j(E.code)),u(!1),null}C++}if(D)try{const E=await S(D.coords.latitude,D.coords.longitude),U={latitude:D.coords.latitude,longitude:D.coords.longitude,address:E,accuracy:Math.round(D.coords.accuracy),timestamp:new Date};return l(U),u(!1),console.log(`üìç Posizione finale: ${E} (¬±${U.accuracy}m)`),U}catch(E){return console.error("Errore nel reverse geocoding:",E),x("Errore nel determinare l'indirizzo"),u(!1),null}return x("Impossibile ottenere posizione GPS precisa"),u(!1),null},[]),j=M=>{switch(M){case 1:return"Permesso GPS negato - Attiva GPS nelle impostazioni del telefono";case 2:return"Posizione non disponibile - Controlla che il GPS sia attivo";case 3:return"Timeout GPS - Segnale debole o GPS spento. Vai all'aperto e riprova";default:return"Errore GPS - Controlla che il GPS sia attivo e riprova"}};return{currentLocation:n,isLoading:c,error:f,accuracy:b,getCurrentLocation:g,clearLocation:()=>{l(null),x(null),v(null)}}},hn=()=>{const{user:n}=Pt(),[l,c]=w.useState(null),[u,f]=w.useState([]),[x,b]=w.useState(!0),[v,S]=w.useState("00:00:00"),[g,j]=w.useState({}),p=w.useRef(null),M=w.useRef(null);w.useEffect(()=>(l&&l.isActive?B(l.checkInTime):k(),()=>{k()}),[l==null?void 0:l.id,l==null?void 0:l.isActive]),w.useEffect(()=>(u.length>0?R(u):C(),()=>{C()}),[u.length]);const B=N=>{if(console.log("üïê startTimer chiamato con checkInTime:",N),p.current&&clearInterval(p.current),!N){console.error("‚ùå checkInTime √® null o undefined!");return}const _=new Date,L=N.split(":");console.log("üïê timeParts:",L);const[I,K]=L.map(Number),O=new Date(_.getFullYear(),_.getMonth(),_.getDate(),I,K,0),W=()=>{const G=new Date().getTime()-O.getTime();if(G<0){S("00:00:00");return}const $=Math.floor(G/1e3),F=Math.floor($/3600),re=Math.floor($%3600/60),_e=$%60,ge=`${F.toString().padStart(2,"0")}:${re.toString().padStart(2,"0")}:${_e.toString().padStart(2,"0")}`;S(ge)};W(),p.current=setInterval(W,1e3)},k=()=>{p.current&&(clearInterval(p.current),p.current=null),S("00:00:00")},R=N=>{M.current&&clearInterval(M.current);const _=()=>{const L=new Date,I=new Date,K={};N.forEach(O=>{const[W,se]=O.checkInTime.split(":").map(Number),G=new Date(I.getFullYear(),I.getMonth(),I.getDate(),W,se,0),$=L.getTime()-G.getTime();if($<0){K[O.id]="00:00:00";return}const F=Math.floor($/1e3),re=Math.floor(F/3600),_e=Math.floor(F%3600/60),ge=F%60;K[O.id]=`${re.toString().padStart(2,"0")}:${_e.toString().padStart(2,"0")}:${ge.toString().padStart(2,"0")}`}),j(K)};_(),M.current=setInterval(_,1e3)},C=()=>{M.current&&(clearInterval(M.current),M.current=null),j({})};w.useEffect(()=>{n!=null&&n.id&&D()},[n==null?void 0:n.id]);const D=async()=>{try{if(b(!0),!je)return;const N=new Date().toISOString().split("T")[0],_=new Date(new Date().getTime()+24*60*60*1e3).toISOString().split("T")[0],L=new Date,I=L.getFullYear()+"-"+String(L.getMonth()+1).padStart(2,"0")+"-"+String(L.getDate()).padStart(2,"0"),K=new Date(L.getTime()+24*60*60*1e3),O=K.getFullYear()+"-"+String(K.getMonth()+1).padStart(2,"0")+"-"+String(K.getDate()).padStart(2,"0");console.log("üìÖ Date di ricerca:",{localToday:I,localTomorrowStr:O,utcToday:N});const W=[],{data:se,error:G}=await je.from("warehouse_checkins").select("*").eq("crew_id",n==null?void 0:n.id).in("date",[I,O]).in("status",["active","checked_in"]).is("check_out_time",null).order("date",{ascending:!0}),$=(se==null?void 0:se[0])||null;if(!G&&$){console.log("üì¶ Warehouse check-in trovato:",$),console.log("   - check_in_time:",$.check_in_time),console.log("   - ora_inizio_turno:",$.ora_inizio_turno),console.log("   - ora_fine_turno:",$.ora_fine_turno);const X={id:$.id,type:"warehouse",warehouseId:$.warehouse_id,checkInTime:$.check_in_time,scheduledEndTime:$.ora_fine_turno||"17:00",shiftName:"Turno Magazzino",shiftStartTime:$.ora_inizio_turno||"09:00",shiftEndTime:$.ora_fine_turno||"17:00",hasLunchBreak:$.break_minutes>0,hasCompanyMeal:$.company_meal||!1,hasMealVoucher:$.meal_voucher||!1,breakTime:$.break_minutes||0,isActive:!0,tableName:"warehouse_checkins"};console.log("üì¶ Sessione creata:",X),W.push(X),c(X)}const{data:F,error:re}=await je.from("extra_shifts_checkins").select("*").eq("crew_id",n==null?void 0:n.id).eq("date",N).in("status",["active","checked_in"]).is("check_out_time",null).maybeSingle();if(!re&&F){const X={id:F.id,type:"extra",warehouseId:null,checkInTime:F.check_in_time,scheduledEndTime:"17:00",shiftName:"Turno Extra",hasCompanyMeal:F.company_meal||!1,hasMealVoucher:F.meal_voucher||!1,breakTime:F.break_minutes||0,isActive:!0,tableName:"extra_shifts_checkins"};W.push(X),$||c(X)}const{data:_e,error:ge}=await je.from("timesheet_entries").select(`
          *,
          crew_events!event_id(title, end_date, location)
        `).eq("crew_id",n==null?void 0:n.id).eq("date",N).eq("status","draft").is("end_time",null).maybeSingle();if(!ge&&_e){const X=_e.crew_events,pe={id:_e.id,type:"event",eventId:_e.event_id,checkInTime:_e.start_time,scheduledEndTime:"17:00",shiftName:(X==null?void 0:X.title)||"Evento",hasCompanyMeal:_e.company_meal||!1,hasMealVoucher:_e.meal_voucher||!1,isActive:!0};W.push(pe),$||c(pe)}f(W),console.log("‚úÖ Sessioni caricate:",W.length,"sessioni attive")}catch(N){console.error("Errore caricamento sessioni:",N)}finally{b(!1)}},E=w.useCallback(N=>{const _={...N,isActive:!0};c(_),f(L=>[...L.filter(K=>K.id!==_.id),_]),console.log("‚úÖ Sessione avviata:",_.id,"Type:",_.type)},[]),U=w.useCallback(N=>{N?(f(_=>_.filter(L=>L.id!==N)),(l==null?void 0:l.id)===N&&(k(),c(null))):(k(),c(null))},[l]),q=async(N,_)=>{if(!l)return console.error("‚ùå Nessuna sessione attiva per check-out"),!1;try{if(!(n!=null&&n.id))return console.error("‚ùå User ID non valido per check-out"),!1;const L=new Date,I=`${L.getHours().toString().padStart(2,"0")}:${L.getMinutes().toString().padStart(2,"0")}`;if(console.log(`üîÑ Tentativo check-out manuale alle ${I} per sessione ${l.id}`),console.log(`üìã Tipo sessione: ${l.type}`),console.log("üìç Checkout location:",N),console.log("üìù Note checkout:",_),l.type==="warehouse"){const K=l.tableName||"warehouse_checkins";console.log(`üíæ Aggiornamento ${K} id=${l.id}`);const{data:O,error:W}=await je.from(K).select("check_in_time, pausa_pranzo_minuti, break_minutes, warehouse_id").eq("id",l.id).maybeSingle();if(W&&console.error("‚ùå ERRORE nella verifica del record:",W),!O)return console.error(`‚ùå Record NON TROVATO in ${K} con id:`,l.id),!1;let se=!1,G=null;if(N&&O.warehouse_id){const{data:ye}=await je.from("warehouses").select("latitude, longitude").eq("id",O.warehouse_id).maybeSingle();if(ye!=null&&ye.latitude&&(ye!=null&&ye.longitude)){const Ce=J(N.latitude,N.longitude,ye.latitude,ye.longitude);G=Math.round(Ce),se=Ce>1e3,se&&console.warn("üö® ALERT: Check-out effettuato lontano dal magazzino!",{distance:G})}}const $=O.check_in_time,[F,re]=$.split(":").map(Number),[_e,ge]=I.split(":").map(Number),X=F*60+re;let me=_e*60+ge-X;me<0&&(me+=24*60);const Q=me/60,V=O.pausa_pranzo_minuti||O.break_minutes||0,de=(me-V)/60,ae={check_out_time:I,status:"completed",total_hours:Math.round(Q*100)/100,net_hours:Math.round(de*100)/100};_&&_.trim()&&(ae.notes=_.trim()),N&&(ae.checkout_location={latitude:N.latitude,longitude:N.longitude,address:N.address,accuracy:N.accuracy,timestamp:N.timestamp.toISOString()},ae.checkout_location_alert=se,ae.checkout_distance_from_warehouse=G),console.log("üìù Dati da aggiornare:",ae),console.log("üîç Condizione WHERE: id =",l.id),console.log("‚è±Ô∏è Ore calcolate - Totali:",ae.total_hours,"Nette:",ae.net_hours);const{data:le,error:be}=await je.from(K).update(ae).eq("id",l.id).select().maybeSingle();if(be)return console.error("‚ùå ERRORE UPDATE WAREHOUSE CHECK-OUT:",be),console.error("‚ùå Dettagli errore:",JSON.stringify(be,null,2)),console.error("‚ùå Codice errore:",be.code),console.error("‚ùå Messaggio errore:",be.message),!1;if(!le)return console.error("‚ùå Nessun dato restituito dall'update (possibile record non trovato dopo update)"),!1;console.log("‚úÖ Check-out magazzino salvato nel DB:",le),console.log("‚úÖ Verifica campi aggiornati:"),console.log("   - check_out_time:",le.check_out_time),console.log("   - status:",le.status)}else if(l.type==="extra"){const K="extra_shifts_checkins";console.log(`üíæ Aggiornamento ${K} id=${l.id}`);const{data:O,error:W}=await je.from(K).select("check_in_time, break_minutes").eq("id",l.id).maybeSingle();if(W&&console.error("‚ùå ERRORE nella verifica del record:",W),!O)return console.error(`‚ùå Record NON TROVATO in ${K} con id:`,l.id),!1;const se=O.check_in_time,[G,$]=se.split(":").map(Number),[F,re]=I.split(":").map(Number),_e=G*60+$;let X=F*60+re-_e;X<0&&(X+=24*60);const pe=X/60,me=O.break_minutes||0,Q=(X-me)/60,V={check_out_time:I,status:"completed",total_hours:Math.round(pe*100)/100,net_hours:Math.round(Q*100)/100};console.log("üìù Dati da aggiornare:",V),console.log("‚è±Ô∏è Ore calcolate - Totali:",V.total_hours,"Nette:",V.net_hours);const{data:de,error:ae}=await je.from(K).update(V).eq("id",l.id).select().maybeSingle();if(ae)return console.error("‚ùå ERRORE UPDATE EXTRA CHECK-OUT:",ae),console.error("‚ùå Dettagli errore:",JSON.stringify(ae,null,2)),!1;if(!de)return console.error("‚ùå Nessun dato restituito dall'update"),!1;console.log("‚úÖ Check-out turno extra salvato nel DB:",de)}else{console.log(`üíæ Aggiornamento timesheet_entries id=${l.id}`);const{data:K,error:O}=await je.from("timesheet_entries").update({end_time:I,status:"submitted"}).eq("id",l.id).select().single();if(O)return console.error("‚ùå ERRORE UPDATE TIMESHEET CHECK-OUT:",O),console.error("‚ùå Dettagli errore:",JSON.stringify(O,null,2)),!1;console.log("‚úÖ Check-out evento salvato nel DB:",K)}return console.log("‚úÖ Check-out completato con successo nel database"),!0}catch(L){return console.error("‚ùå Errore nel check-out manuale:",L),!1}},J=(N,_,L,I)=>{const O=N*Math.PI/180,W=L*Math.PI/180,se=(L-N)*Math.PI/180,G=(I-_)*Math.PI/180,$=Math.sin(se/2)*Math.sin(se/2)+Math.cos(O)*Math.cos(W)*Math.sin(G/2)*Math.sin(G/2);return 6371e3*(2*Math.atan2(Math.sqrt($),Math.sqrt(1-$)))};return{currentSession:l,activeSessions:u,elapsedTime:v,elapsedTimes:g,isLoading:x,startSession:E,endSession:U,manualCheckOut:q,loadActiveSession:D}};function wr(n=new Date){const l=n.getFullYear(),c=String(n.getMonth()+1).padStart(2,"0"),u=String(n.getDate()).padStart(2,"0");return`${l}-${c}-${u}`}function Ya(){return wr(new Date)}function Jc(){const n=new Date;return n.setDate(n.getDate()+1),wr(n)}function or(n){if(!n)return"";if(/^\d{2}:\d{2}$/.test(n))return n;if(/^\d{2}:\d{2}:\d{2}$/.test(n))return n.substring(0,5);try{const l=new Date(n);if(!isNaN(l.getTime()))return l.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit",hour12:!1,timeZone:"Europe/Rome"})}catch(l){console.error("Errore parsing timestamp:",l)}return""}const ed=()=>{var qt;const{user:n}=Pt(),{showSuccess:l,showError:c,showWarning:u,showInfo:f}=us(),{currentLocation:x,getCurrentLocation:b,isLoading:v,error:S}=un(),{isOnline:g,addOfflineData:j}=Da(),{currentSession:p,activeSessions:M,elapsedTime:B,elapsedTimes:k,startSession:R,endSession:C,manualCheckOut:D}=hn(),[E,U]=w.useState("main"),[q,J]=w.useState([]),[N,_]=w.useState([]),[L,I]=w.useState(null),[K,O]=w.useState(!0),[W,se]=w.useState(null),[G,$]=w.useState(null),[F,re]=w.useState([]),[_e,ge]=w.useState(""),[X,pe]=w.useState(null),[me,Q]=w.useState(!1),[V,de]=w.useState(!1),[ae,le]=w.useState(!1),[be,ye]=w.useState(null),Ce=w.useRef(null),[Ne,Ae]=w.useState(!1),[Ue,qe]=w.useState(!1),[rt,at]=w.useState(null),[Ke,Je]=w.useState(!1),[Ge,yt]=w.useState(null),[Ye,Te]=w.useState(null),[H,ne]=w.useState(!1),[fe,Ie]=w.useState(null),[Re,ee]=w.useState(""),[oe,De]=w.useState(""),[Ee,te]=w.useState(!1),[ke,Z]=w.useState(""),[he,we]=w.useState(""),[ve,Qe]=w.useState(!1),[nt,pt]=w.useState({x:0,y:0}),[Oe,At]=w.useState(!1),[it,ks]=w.useState({x:0,y:0}),[Kt,St]=w.useState(!1),[ht,Jt]=w.useState(null),xr=xe=>{At(!0);const Be="touches"in xe?xe.touches[0].clientX:xe.clientX,Xe="touches"in xe?xe.touches[0].clientY:xe.clientY;ks({x:Be-nt.x,y:Xe-nt.y})},bs=xe=>{if(!Oe)return;const Be="touches"in xe?xe.touches[0].clientX:xe.clientX,Xe="touches"in xe?xe.touches[0].clientY:xe.clientY;pt({x:Be-it.x,y:Xe-it.y})},na=()=>{At(!1)},Fs=w.useCallback(async(xe,Be,Xe)=>{try{const Pe={check_out_time:Be,status:"completed",auto_checkout:!0,notes:`Auto-checkout effettuato alle ${Be}. Sessione chiusa automaticamente dopo ${Xe.toFixed(1)} ore di ritardo.`};xe.break_minutes>0&&!xe.has_taken_break&&!xe.pausa_pranzo_inizio&&(Pe.has_taken_break=!0,Pe.break_auto_applied=!0,Pe.pausa_pranzo_inizio="13:00",Pe.pausa_pranzo_fine="14:00",console.log("‚è∞ Pausa pranzo applicata automaticamente all'auto-checkout"));const{error:Ze}=await je.from("warehouse_checkins").update(Pe).eq("id",xe.id).select().single();if(Ze)return;p&&p.id===xe.id&&C(),f("Turno Auto-Completato",`Il tuo turno √® stato completato automaticamente alle ${Be}. ${xe.break_minutes>0&&!xe.has_taken_break?"Pausa pranzo registrata automaticamente.":""}`,8e3)}catch{}},[p,C,f]),mr=w.useCallback(async()=>{if(!(!p||p.type!=="warehouse"))try{const Xe=new Date().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit",hour12:!1,timeZone:"Europe/Rome"}).replace(":",": "),{data:Pe,error:Ze}=await je.from("warehouse_checkins").select("*").eq("id",p.id).eq("status","active").is("check_out_time",null).maybeSingle();if(Ze||!Pe)return;const ie=Pe.ora_fine_turno||"17:00",P=xs(ie),He=$s(Xe,P);if(He>=60){const dt=He/60;console.log(`‚è∞ Auto-checkout attivato: ${He} minuti dopo la fine turno (${P})`),await Fs(Pe,P,dt)}}catch{}},[p,n==null?void 0:n.id,Fs]);w.useEffect(()=>(n!=null&&n.id&&(ws(),er(),Us(),ka(),es(),!x&&!v&&(console.log("üìç Attivazione GPS automatica all'apertura pagina Check-in..."),b({requiredAccuracy:50,maxRetries:2}))),()=>{Ce.current&&Ce.current.clear()}),[n==null?void 0:n.id]);const es=async()=>{if(!(!p||p.type!=="warehouse"))try{const{data:xe,error:Be}=await je.from("warehouse_checkins").select("pausa_pranzo_inizio, pausa_pranzo_fine, break_start_location, has_taken_break").eq("id",p.id).maybeSingle();if(Be||!xe)return;xe.pausa_pranzo_inizio&&!xe.pausa_pranzo_fine?(Je(!0),yt(xe.pausa_pranzo_inizio),Te(null)):xe.pausa_pranzo_inizio&&xe.pausa_pranzo_fine&&(Je(!1),yt(xe.pausa_pranzo_inizio),Te(xe.pausa_pranzo_fine))}catch(xe){console.error("Errore caricamento stato pausa:",xe)}};w.useEffect(()=>{(p==null?void 0:p.type)==="warehouse"&&es()},[p==null?void 0:p.id]),w.useEffect(()=>{if(!p||p.type!=="warehouse")return;b({requiredAccuracy:50,maxRetries:2});const xe=setInterval(()=>{b({requiredAccuracy:50,maxRetries:1})},3e4);return()=>{clearInterval(xe)}},[p==null?void 0:p.id,b]),w.useEffect(()=>{if(!(n!=null&&n.id)||!p||p.type!=="warehouse")return;mr();const xe=setInterval(()=>{mr()},6e4);return()=>{clearInterval(xe)}},[n==null?void 0:n.id,p==null?void 0:p.id,p==null?void 0:p.type,mr]);const Ms=xe=>{const Be=new Date,Pe=Be.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit",hour12:!1,timeZone:"Europe/Rome"}).replace(":",":"),Ze=wr(Be),ie=xe.data_turno,P=xs(xe.ora_inizio_turno),He=xs(xe.ora_fine_turno);if(Ze!==ie)return Ze>ie?{isValid:!1,reason:`Turno del ${new Date(ie).toLocaleDateString("it-IT")} gi√† passato`,canCheckIn:!1,canCheckOut:!1,isExpired:!0}:{isValid:!1,reason:`Turno programmato per ${new Date(ie).toLocaleDateString("it-IT")}`,canCheckIn:!1,canCheckOut:!1,isExpired:!1};const dt=hs(Pe,P),Rt=et(Pe,He),_s=parseInt(Pe.split(":")[0])*60+parseInt(Pe.split(":")[1]),ms=parseInt(P.split(":")[0])*60+parseInt(P.split(":")[1]);parseInt(He.split(":")[0])*60+parseInt(He.split(":")[1]);const $t=_s<300,tt=ms>=1200;if($t&&tt){const xt=ms-_s,cs=4*60;return console.log("üåô Turno notturno - Check anticipo:",{currentTime:Pe,currentMinutes:_s,shiftStartTime:P,startMinutes:ms,minutesEarly:xt,allowedMinutes:cs,isAllowed:xt<=cs}),xt<=cs?{isValid:!0,reason:`Check-in anticipato consentito (turno inizia alle ${P})`,canCheckIn:!0,canCheckOut:!1,isExpired:!1}:{isValid:!1,reason:`Turno inizia alle ${P} (tra ${Math.floor(xt/60)} ore e ${xt%60} minuti). Check-in disponibile dalle ${rs(P)}.`,canCheckIn:!1,canCheckOut:!1,isExpired:!1}}if(dt){const xt=$s(P,Pe),cs=4*60;return console.log("‚è∞ Check anticipo:",{currentTime:Pe,shiftStartTime:P,minutesEarly:xt,allowedMinutes:cs,isAllowed:xt<=cs}),xt<=cs?{isValid:!0,reason:`Check-in anticipato consentito (turno inizia alle ${P})`,canCheckIn:!0,canCheckOut:!1,isExpired:!1}:{isValid:!1,reason:`Turno inizia alle ${P} (tra ${Math.floor(xt/60)} ore e ${xt%60} minuti). Check-in disponibile dalle ${rs(P)}.`,canCheckIn:!1,canCheckOut:!1,isExpired:!1}}if(Rt){const xt=Rr(He,Pe);return{isValid:!1,reason:`Turno terminato alle ${He} (${xt.toFixed(1)} ore fa)`,canCheckIn:!1,canCheckOut:!1,isExpired:!0,hoursLate:xt}}return{isValid:!0,reason:`Turno attivo:  ${P} - ${He}`,canCheckIn:!0,canCheckOut:!0,isExpired:!1}},hs=(xe,Be)=>{const[Xe,Pe]=xe.split(": ").map(Number),[Ze,ie]=Be.split(":").map(Number);return Xe*60+Pe<Ze*60+ie},et=(xe,Be)=>{const[Xe,Pe]=xe.split(":").map(Number),[Ze,ie]=Be.split(":").map(Number);return Xe*60+Pe>Ze*60+ie},$s=(xe,Be)=>{const[Xe,Pe]=xe.split(":").map(Number),[Ze,ie]=Be.split(":").map(Number);return Xe*60+Pe-(Ze*60+ie)},Rr=(xe,Be)=>{const[Xe,Pe]=xe.split(":").map(Number),[Ze,ie]=Be.split(":").map(Number);return(Ze*60+ie-(Xe*60+Pe))/60},rs=xe=>{const[Be,Xe]=xe.split(":").map(Number),Pe=Be*60+Xe-240;if(Pe<0){const P=Pe+1440,He=Math.floor(P/60),dt=P%60;return`${He.toString().padStart(2,"0")}:${dt.toString().padStart(2,"0")} (giorno prima)`}const Ze=Math.floor(Pe/60),ie=Pe%60;return`${Ze.toString().padStart(2,"0")}:${ie.toString().padStart(2,"0")}`},er=async()=>{try{const{data:xe,error:Be}=await je.from("employee_meal_benefits").select("*").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0).maybeSingle();if(Be){I({buoni_pasto_enabled:!1,buoni_pasto_value:7.5,pasto_aziendale_cost:12});return}I(xe?{buoni_pasto_enabled:xe.buoni_pasto_enabled,buoni_pasto_value:xe.buoni_pasto_value||7.5,pasto_aziendale_cost:xe.pasto_aziendale_cost||12}:{buoni_pasto_enabled:!1,buoni_pasto_value:7.5,pasto_aziendale_cost:12})}catch{I({buoni_pasto_enabled:!1,buoni_pasto_value:7.5,pasto_aziendale_cost:12})}},Us=async()=>{try{const xe=Ya(),{data:Be,error:Xe}=await je.from("warehouse_checkins").select("*").eq("crew_id",n==null?void 0:n.id).eq("date",xe);if(!Xe&&Be){console.log("üìã Check-in trovati oggi:",Be.length),re(Be);const Pe=Be.find(Ze=>Ze.status==="active");if($(Pe||null),Pe&&(!p||p.id!==Pe.id)){console.log("üîÑ Ripristino sessione da check-in attivo nel DB");let Ze=Pe.ora_inizio_turno,ie=Pe.ora_fine_turno;if(!Ze||!ie){console.log("‚ö†Ô∏è Orari mancanti nel check-in, recupero da crew_assegnazione_turni...");const{data:He}=await je.from("crew_assegnazione_turni").select("ora_inizio_turno, ora_fine_turno").eq("turno_id",Pe.shift_id).maybeSingle();He?(Ze=He.ora_inizio_turno||"09:00",ie=He.ora_fine_turno||"17:00",console.log("‚úÖ Orari recuperati:",{shiftStartTime:Ze,shiftEndTime:ie})):(Ze="09:00",ie="17:00")}const P=Pe.break_minutes>0;R({id:Pe.id,type:"warehouse",warehouseId:Pe.warehouse_id,checkInTime:Pe.check_in_time,scheduledEndTime:xs(ie),shiftName:"Turno Magazzino",shiftStartTime:xs(Ze),shiftEndTime:xs(ie),hasLunchBreak:P,hasCompanyMeal:Pe.company_meal||!1,hasMealVoucher:Pe.meal_voucher||!1,breakTime:Pe.break_minutes||0}),console.log("üìç Attivazione GPS automatica per turno in corso..."),b({requiredAccuracy:50,maxRetries:2})}vr(Be)}}catch{}},vr=async xe=>{var Be;try{const Xe=new Date;for(const Pe of xe){const{data:Ze}=await je.from("crew_assegnazione_turni").select("*, crew_template_turni!turno_id(pausa_pranzo)").eq("id",Pe.shift_id).maybeSingle();if(Pe.status!=="completed"||!((Be=Ze==null?void 0:Ze.crew_template_turni)!=null&&Be.pausa_pranzo)||Pe.has_taken_break||Pe.break_auto_applied)continue;const ie=new Date(`${Pe.date}T${Pe.check_out_time}`);if((Xe.getTime()-ie.getTime())/(1e3*60*60)<8){Ie(Pe),ne(!0);break}}}catch(Xe){console.error("Errore controllo pause mancanti:",Xe)}},ws=async()=>{try{O(!0);const xe=Ya();console.log("üìÖ Caricamento turni da data:",xe);const{data:Be,error:Xe}=await je.from("crew_assegnazione_turni").select(`
          *,
          crew_template_turni!turno_id(
            id_template,
            nome_template,
            ora_inizio_turno,
            ora_fine_turno,
            pausa_pranzo,
            warehouse_id,
            nome_magazzino,
            warehouses! warehouse_id(
              name,
              address
            )
          )
        `).eq("dipendente_id",n==null?void 0:n.id).gte("data_turno",xe).order("data_turno",{ascending:!0}).order("ora_inizio_turno",{ascending:!0});if(Xe)J([]);else{const Pe=(Be||[]).map(Ze=>{var ie,P,He,dt,Rt;return{...Ze,ora_inizio_turno:Ze.ora_inizio_turno||((ie=Ze.crew_template_turni)==null?void 0:ie.ora_inizio_turno),ora_fine_turno:Ze.ora_fine_turno||((P=Ze.crew_template_turni)==null?void 0:P.ora_fine_turno),nome_magazzino:((He=Ze.crew_template_turni)==null?void 0:He.nome_magazzino)||Ze.nome_magazzino,warehouse_address:((Rt=(dt=Ze.crew_template_turni)==null?void 0:dt.warehouses)==null?void 0:Rt.address)||"Indirizzo non disponibile"}});console.log("‚úÖ Turni magazzino caricati:",Pe.length,Pe.map(Ze=>{var ie,P;return{nome:Ze.nome_turno,data:Ze.data_turno,orario_assegnazione:`${Ze.ora_inizio_turno}-${Ze.ora_fine_turno}`,orario_template:`${(ie=Ze.crew_template_turni)==null?void 0:ie.ora_inizio_turno}-${(P=Ze.crew_template_turni)==null?void 0:P.ora_fine_turno}`}})),J(Pe)}}catch{J([])}finally{O(!1)}},ka=async()=>{try{const{data:xe,error:Be}=await je.from("warehouses").select("*").order("name");if(Be){_([]);return}_(xe||[])}catch{_([])}},Ma=xe=>{const Be=Ms(xe);if(pe(Be),!Be.isValid||!Be.canCheckIn){Be.isExpired?c("Turno Scaduto",`Non puoi fare check-in:  ${Be.reason}`):u("Turno Non Disponibile",`Check-in non disponibile:  ${Be.reason}`);return}se(xe),x?ys(xe):(u("GPS Richiesto","Attivazione GPS in corso per il check-in magazzino.. ."),b({requiredAccuracy:20,maxRetries:3}).then(()=>{ys(xe)}))},ys=xe=>{var Be;de((L==null?void 0:L.buoni_pasto_enabled)||!1),((Be=xe.crew_template_turni)==null?void 0:Be.pausa_pranzo)!==!1?U("meal_selection"):(Q(!1),ts())},ts=()=>{U("scanner"),Ot()},Ot=()=>{le(!0),ye(null),setTimeout(()=>{if(!document.getElementById("qr-reader")){ye("Elemento scanner non trovato nel DOM");return}try{const Be={fps:10,qrbox:{width:250,height:250},rememberLastUsedCamera:!0,supportedScanTypes:[0],aspectRatio:1,formatsToSupport:[0],defaultZoomValueIfSupported:2,videoConstraints:{facingMode:"environment"},experimentalFeatures:{useBarCodeDetectorIfSupported:!0}},Xe=new Kc("qr-reader",Be,!1);Xe.render(ia,Vs),Ce.current=Xe}catch(Be){console.error("Errore inizializzazione scanner:",Be),ye("Errore nell'inizializzazione del scanner QR")}},300)},ia=xe=>{if(Ne){console.log("‚ö†Ô∏è Scansione ignorata - gi√† in elaborazione");return}if(ge(""),Ae(!0),console.log("üì∑ QR Code scansionato:",xe),Ce.current)try{Ce.current.pause()}catch(Be){console.warn("Impossibile mettere in pausa lo scanner:",Be)}Fe(xe)},Vs=xe=>{xe.includes("NotFoundException")||console.error("QR scan error:",xe)},Nr=()=>{Ce.current&&Ce.current.clear(),le(!1),U("main"),Ae(!1)},Fe=xe=>{const Be=N.find(Xe=>Xe.backup_code===xe);if(!Be){if(Ae(!1),Ce.current)try{Ce.current.resume()}catch(Xe){console.warn("Impossibile riattivare lo scanner:",Xe)}N.length===0?c("Errore Database","Nessun magazzino caricato dal database! Verifica connessione e permessi."):c("Codice Backup Non Riconosciuto",`Il codice backup "${xe}" non corrisponde a nessun magazzino registrato. Verifica di aver inserito il codice corretto.`);return}oa(Be)},oa=async(xe,Be=!1)=>{var tt,xt,cs;let Xe=x,Pe=!1,Ze=null;if(!Xe&&!Be){at(xe),qe(!0);return}if(!Xe&&Be&&(Pe=!0,Ze=S||"GPS non disponibile - Check-in forzato dall'utente",console.warn("‚ö†Ô∏è Check-in magazzino forzato senza GPS:",Ze)),!W){c("Errore Check-in","Turno non selezionato");return}const ie=Ms(W);if(!ie.isValid||!ie.canCheckIn){c("Check-in Non Valido",`Impossibile procedere:  ${ie.reason}`);return}const P=new Date,He=`${P.getHours().toString().padStart(2,"0")}:${P.getMinutes().toString().padStart(2,"0")}`,dt=wr(P);if(F.find(zs=>{const Os=zs.date,Xs=W.data_turno.split("T")[0];return zs.shift_id===W.turno_id&&Os===Xs&&zs.status==="active"})){c("Check-in Duplicato","Hai gi√† effettuato il check-in per questo turno oggi. Verifica lo storico dei tuoi check-in.");return}const _s=W.data_turno.split("T")[0],{data:ms,error:$t}=await je.from("warehouse_checkins").select("id, status").eq("crew_id",n==null?void 0:n.id).eq("shift_id",W.turno_id).eq("date",_s).eq("status","active").maybeSingle();if(!$t&&ms){console.warn("‚ö†Ô∏è Check-in duplicato rilevato nel database:",ms),c("Check-in Duplicato","Esiste gi√† un check-in attivo per questo turno. Ricaricamento..."),await Us();return}try{const zs=((tt=W.crew_template_turni)==null?void 0:tt.pausa_pranzo)!==!1?60:0;let Os=!1,Xs=null;if(Xe&&!Pe){const vs=await Yt(Xe.latitude,Xe.longitude,xe.id,500);Xs=vs.distance,Os=vs.alert,Os&&console.warn("üö® ALERT: Check-in effettuato lontano dal magazzino! ",{distance:Math.round(vs.distance),warehouse:xe.name})}const fr={warehouse_id:xe.id,crew_id:n==null?void 0:n.id,date:dt,check_in_time:He,status:"active",location:Xe?{latitude:Xe.latitude,longitude:Xe.longitude,address:Xe.address,accuracy:Xe.accuracy,timestamp:Xe.timestamp.toISOString()}:null,forced_checkin:Pe,gps_error_reason:Ze,location_alert:Os,distance_from_warehouse:Xs,shift_id:W.turno_id,ora_inizio_turno:W.ora_inizio_turno,ora_fine_turno:W.ora_fine_turno,break_minutes:zs,company_meal:me,meal_voucher:V,meal_cost:me?(L==null?void 0:L.pasto_aziendale_cost)||12:0,meal_notes:me?"Pasto aziendale richiesto":V?"Buono pasto richiesto":null};if(g){const{data:vs,error:Lt}=await je.from("warehouse_checkins").insert(fr).select().single();if(Lt)console.error("‚ùå ERRORE CHECK-IN WAREHOUSE:",Lt),console.error("   - Code:",Lt.code),console.error("   - Message:",Lt.message),console.error("   - Details:",Lt.details),console.error("   - Hint:",Lt.hint),j("checkin",fr),u("Check-in Offline",`Errore database: ${Lt.message} - Salvato offline e sar√† sincronizzato`);else{const sr=xs(W.ora_fine_turno);console.log("‚úÖ CHECK-IN WAREHOUSE SALVATO NEL DB: "),console.log("   - ID check-in:",vs.id),console.log("   - Crew ID:",vs.crew_id),console.log("   - Warehouse ID:",vs.warehouse_id),console.log("   - Check-in time:",vs.check_in_time),console.log("   - Status:",vs.status),R({id:vs.id,type:"warehouse",warehouseId:xe.id,checkInTime:He,scheduledEndTime:sr,shiftName:`Turno ${W.nome_magazzino}`,shiftStartTime:W.ora_inizio_turno,shiftEndTime:W.ora_fine_turno,hasLunchBreak:((xt=W.crew_template_turni)==null?void 0:xt.pausa_pranzo)!==!1,hasCompanyMeal:me,hasMealVoucher:V,breakTime:zs}),console.log("‚úÖ SESSIONE LOCALE AVVIATA con ID:",vs.id);let ss=Pe?`CHECK-IN FORZATO COMPLETATO!

`:`CHECK-IN COMPLETATO!

`;ss+=`Magazzino: ${W.nome_magazzino}
`,ss+=`Inizio: ${He}
`,ss+=`Fine prevista: ${sr}
`,ss+=Pe?`Check-in senza GPS (forzato)
`:`Posizione GPS verificata
`,((cs=W.crew_template_turni)==null?void 0:cs.pausa_pranzo)!==!1&&(ss+=`Include 1 ora di pausa pranzo
`),me&&(ss+=`Pasto aziendale: ‚Ç¨${(L==null?void 0:L.pasto_aziendale_cost)||12}
`),V&&(ss+=`Buono pasto: ‚Ç¨${(L==null?void 0:L.buoni_pasto_value)||7.5}
`),Pe?u("Check-in Forzato Completato",ss):l("Check-in Completato",ss),Nr(),await Us()}}else j("checkin",fr),f("Check-in Offline","Check-in salvato offline - Verr√† sincronizzato quando torni online"),Nr();se(null),Q(!1),de(!1)}catch{c("Errore Check-in","Si √® verificato un errore durante il check-in.  Riprova.")}},Vt=async()=>{if(!p||p.type!=="warehouse"){u("Nessuna Sessione","Non c'√® una sessione magazzino attiva da terminare");return}te(!0)},tr=async()=>{te(!1),console.log("üî¥ INIZIO PROCESSO CHECK-OUT MANUALE"),console.log("üìã Sessione corrente:",p),console.log("‚è±Ô∏è Tempo trascorso:",B),console.log("üìù Note checkout:",ke);try{f("Check-out in corso... ","Sto completando il turno magazzino",2e3),console.log("üìû Chiamata a manualCheckOut().. ."),console.log("üìç Passaggio location al checkout:",x);const xe=await D(x,ke);if(console.log("‚úÖ Risultato manualCheckOut():",xe),xe){if(console.log("‚úÖ Check-out salvato nel database, ora termino la sessione locale"),C(),console.log("‚úÖ Sessione locale terminata"),Je(!1),yt(null),Te(null),Z(""),l("Check-out Completato",`Turno magazzino terminato con successo!  Tempo totale: ${B}`),console.log("üîÑ Ricaricamento dati dal database..."),await Us(),await ws(),console.log("‚úÖ Dati ricaricati"),"caches"in window){const Be=await caches.keys();for(const Xe of Be)(Xe.includes("supabase")||Xe.includes("warehouse"))&&await caches.delete(Xe);console.log("üóëÔ∏è Cache pulita")}setTimeout(()=>{window.location.reload()},1e3)}else console.error("‚ùå Check-out FALLITO - success = false"),c("Errore Check-out","Si √® verificato un errore durante il check-out. Riprova.")}catch(xe){console.error("‚ùå ERRORE CATCH nel check-out:",xe),c("Errore Sistema","Errore imprevisto durante il check-out magazzino")}},la=async(xe=!1)=>{if(console.log("üçΩÔ∏è === INIZIO PAUSA - DEBUG ==="),console.log("Current Session:",p),console.log("Session ID:",p==null?void 0:p.id),console.log("Current Location:",x),console.log("Force without GPS:",xe),!p||p.type!=="warehouse"){console.error("‚ùå Nessuna sessione warehouse attiva"),c("Errore","Nessuna sessione warehouse attiva");return}if(Ke){console.warn("‚ö†Ô∏è Pausa gi√† in corso"),u("Pausa gi√† iniziata","Hai gi√† iniziato una pausa. Termina prima questa pausa.");return}if(Ge&&Ye){console.warn("‚ö†Ô∏è Pausa gi√† completata"),u("Pausa gi√† effettuata","Hai gi√† effettuato la pausa pranzo per questo turno.");return}let Be=x,Xe=!1,Pe=null;if(!Be&&!xe&&(console.warn("‚ö†Ô∏è GPS non disponibile, tentativo riattivazione..."),u("GPS Non Disponibile","Richiesta attivazione GPS..."),await b({requiredAccuracy:20,maxRetries:2}),Be=x,!Be)){console.warn("‚ö†Ô∏è GPS ancora non disponibile dopo tentativi, mostro modal forzatura"),Jt("start"),St(!0);return}!Be&&xe&&(Xe=!0,Pe=S||"GPS non disponibile - Pausa forzata dall'utente",console.warn("‚ö†Ô∏è Inizio pausa forzato senza GPS:",Pe));const Ze=new Date,ie=`${Ze.getHours().toString().padStart(2,"0")}:${Ze.getMinutes().toString().padStart(2,"0")}`;console.log("‚è∞ Orario inizio pausa:",ie),console.log("üìç Location da salvare:",Be),console.log("üîí Forced break:",Xe);try{const P={pausa_pranzo_inizio:ie,break_start_forced:Xe};Be&&(P.break_start_location={latitude:Be.latitude,longitude:Be.longitude,address:Be.address,accuracy:Be.accuracy,timestamp:Be.timestamp.toISOString(),forced:Xe}),Xe&&Pe&&(P.break_start_gps_error=Pe),console.log("üíæ Dati da salvare:",P),console.log("üéØ Update su ID:",p.id);const{data:He,error:dt}=await je.from("warehouse_checkins").update(P).eq("id",p.id).select();if(console.log("üì§ Risposta Supabase:",{data:He,error:dt}),dt){console.error("‚ùå Errore salvataggio pausa:",dt),console.error("Dettagli errore:",JSON.stringify(dt,null,2)),c("Errore",`Impossibile salvare inizio pausa: ${dt.message}`);return}Je(!0),yt(ie),Xe?u("Pausa Iniziata (Forzata)",`Inizio pausa registrato alle ${ie} SENZA GPS`):l("Pausa Iniziata",`Inizio pausa registrato alle ${ie} con GPS verificato`)}catch(P){console.error("Errore sistema pausa:",P),c("Errore Sistema","Errore durante il salvataggio della pausa")}},Ct=async(xe=!1)=>{if(!p||p.type!=="warehouse"){c("Errore","Nessuna sessione warehouse attiva");return}if(!Ke){u("Nessuna pausa attiva","Devi prima iniziare una pausa");return}let Be=x,Xe=!1,Pe=null;if(!Be&&!xe&&(u("GPS Non Disponibile","Richiesta attivazione GPS..."),await b({requiredAccuracy:20,maxRetries:2}),Be=x,!Be)){Jt("end"),St(!0);return}!Be&&xe&&(Xe=!0,Pe=S||"GPS non disponibile - Pausa forzata dall'utente",console.warn("‚ö†Ô∏è Fine pausa forzata senza GPS:",Pe));const Ze=new Date,ie=`${Ze.getHours().toString().padStart(2,"0")}:${Ze.getMinutes().toString().padStart(2,"0")}`;try{const P={pausa_pranzo_fine:ie,has_taken_break:!0,break_registered_late:!1,break_end_forced:Xe};Be&&(P.break_end_location={latitude:Be.latitude,longitude:Be.longitude,address:Be.address,accuracy:Be.accuracy,timestamp:Be.timestamp.toISOString(),forced:Xe}),Xe&&Pe&&(P.break_end_gps_error=Pe),console.log("üíæ Dati fine pausa da salvare:",JSON.stringify(P,null,2)),console.log("üéØ Update su ID:",p.id);const{error:He}=await je.from("warehouse_checkins").update(P).eq("id",p.id);if(He){console.error("Errore salvataggio fine pausa:",He),c("Errore","Impossibile salvare fine pausa");return}const dt=Nt(Ge,ie);await es(),Xe?u("Pausa Terminata (Forzata)",`Fine pausa registrata alle ${ie} SENZA GPS. Durata: ${dt} minuti`):l("Pausa Terminata",`Fine pausa registrata alle ${ie}. Durata: ${dt} minuti`)}catch(P){console.error("Errore sistema fine pausa:",P),c("Errore Sistema","Errore durante il salvataggio della pausa")}},Nt=(xe,Be)=>{const[Xe,Pe]=xe.split(":").map(Number),[Ze,ie]=Be.split(":").map(Number);return Ze*60+ie-(Xe*60+Pe)},_t=async()=>{if(!(!p||p.type!=="warehouse"))try{const{error:xe}=await je.from("warehouse_checkins").update({NoteTurno:he||null}).eq("id",p.id);if(xe){console.error("Errore salvataggio note:",xe),c("Errore","Impossibile salvare le note");return}l("Note Salvate","Le tue note sono state salvate con successo",2e3)}catch(xe){console.error("Errore sistema salvataggio note:",xe),c("Errore Sistema","Errore durante il salvataggio delle note")}},Lr=async()=>{if(!(!p||p.type!=="warehouse"))try{const{data:xe,error:Be}=await je.from("warehouse_checkins").select("NoteTurno").eq("id",p.id).maybeSingle();if(Be||!xe)return;we(xe.NoteTurno||"")}catch(xe){console.error("Errore caricamento note:",xe)}};w.useEffect(()=>{(p==null?void 0:p.type)==="warehouse"?Lr():we("")},[p==null?void 0:p.id]);const Pr=(xe,Be,Xe,Pe)=>{const ie=xe*Math.PI/180,P=Xe*Math.PI/180,He=(Xe-xe)*Math.PI/180,dt=(Pe-Be)*Math.PI/180,Rt=Math.sin(He/2)*Math.sin(He/2)+Math.cos(ie)*Math.cos(P)*Math.sin(dt/2)*Math.sin(dt/2);return 6371e3*(2*Math.atan2(Math.sqrt(Rt),Math.sqrt(1-Rt)))},Br=async xe=>{try{const{data:Be,error:Xe}=await je.from("warehouses").select("latitude, longitude, address").eq("id",xe).maybeSingle();return Xe||!Be?(console.warn("Coordinate magazzino non trovate:",Xe),null):Be.latitude&&Be.longitude?{lat:Be.latitude,lon:Be.longitude}:(console.warn("‚ö†Ô∏è Magazzino senza coordinate GPS. Impossibile validare posizione."),null)}catch(Be){return console.error("Errore recupero coordinate magazzino:",Be),null}},Yt=async(xe,Be,Xe,Pe=500)=>{const Ze=await Br(Xe);if(!Ze)return{isValid:!0,distance:null,alert:!1};const ie=Pr(xe,Be,Ze.lat,Ze.lon),P=ie>1e3,He=ie<=Pe;return console.log(`üìç Validazione posizione:
      - Distanza dal magazzino: ${Math.round(ie)}m
      - Limite permesso: ${Pe}m
      - Validazione: ${He?"‚úÖ OK":"‚ùå FUORI RANGE"}
      - Alert: ${P?"üö® SOSPETTO":"‚úÖ Normale"}`),{isValid:He,distance:ie,alert:P}},qs=async()=>{if(!fe||!Re||!oe){c("Campi Mancanti","Inserisci sia l'orario di inizio che di fine pausa");return}if(oe<=Re){c("Orario Non Valido","L'orario di fine pausa deve essere dopo l'inizio");return}try{const{error:xe}=await je.from("warehouse_checkins").update({break_start_time:Re,break_end_time:oe,has_taken_break:!0,break_registered_late:!0,break_modified_at:new Date().toISOString()}).eq("id",fe.id);if(xe){c("Errore","Impossibile salvare la pausa");return}const Be=Nt(Re,oe);l("Pausa Registrata",`Pausa pranzo registrata: ${Re} - ${oe} (${Be} minuti)

Nota: Inserita dopo il check-out`),ne(!1),Ie(null),ee(""),De(""),await Us()}catch{c("Errore Sistema","Errore durante il salvataggio della pausa")}},xs=xe=>xe?/^\d{2}:\d{2}$/.test(xe)?xe:/^\d{2}:\d{2}:\d{2}$/.test(xe)?xe.substring(0,5):"09:00":"09:00";return K?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento check-in magazzino..."})]})}):e.jsxs("div",{className:"space-y-6",children:[G&&G.status==="active"&&!p&&e.jsx("div",{className:"bg-orange-900 rounded-xl p-4 border border-orange-700",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(wt,{className:"h-5 w-5 text-orange-400"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-orange-100",children:"Turno in Corso"}),e.jsxs("p",{className:"text-sm text-orange-200",children:["Check-in attivo dalle ",G.check_in_time," - ",G.nome_turno||"Turno Magazzino"]}),e.jsx("p",{className:"text-xs text-orange-300 mt-1",children:"Caricamento sessione in corso..."})]})]})}),((p==null?void 0:p.type)==="warehouse"||M.filter(xe=>xe.type==="warehouse").length>0)&&e.jsxs("div",{className:"bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl p-6 shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:M.filter(xe=>xe.type==="warehouse").length===1?"Sessione Attiva":`Sessioni Attive (${M.filter(xe=>xe.type==="warehouse").length})`}),e.jsx("div",{className:"w-3 h-3 bg-purple-300 rounded-full animate-pulse"})]}),e.jsxs("div",{className:"space-y-4",children:[M.filter(xe=>xe.type==="warehouse").map((xe,Be)=>e.jsxs("div",{className:`${Be>0?"pt-4 border-t border-white/20":""}`,children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[xe.type==="warehouse"?e.jsx(zt,{className:"h-6 w-6 text-white"}):e.jsx(ct,{className:"h-6 w-6 text-white"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-medium text-white",children:xe.type==="warehouse"?"Turno Magazzino":xe.shiftName||"Evento"}),M.length>1&&e.jsx("span",{className:"text-xs bg-white/20 px-2 py-1 rounded-full text-white",children:xe.type==="warehouse"?"Magazzino":"Evento"})]}),xe.type==="warehouse"&&xe.hasLunchBreak&&e.jsx("p",{className:"text-xs text-purple-200",children:"‚òï Include 1 ora di pausa pranzo"})]})]}),e.jsx("div",{className:"bg-white bg-opacity-20 rounded-lg p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-mono font-bold text-white mb-2",children:k[xe.id]||"00:00:00"}),e.jsx("div",{className:"text-sm text-purple-100",children:xe.type==="warehouse"?"Tempo di lavoro (pausa inclusa)":"Tempo trascorso"})]})}),xe.type==="warehouse"&&(xe.hasCompanyMeal||xe.hasMealVoucher)&&e.jsxs("div",{className:"bg-white bg-opacity-10 rounded-lg p-3 mt-3",children:[e.jsxs("h5",{className:"text-white font-medium mb-2 flex items-center space-x-2",children:[e.jsx(Bs,{className:"h-4 w-4"}),e.jsx("span",{children:"Pasti Selezionati"})]}),e.jsxs("div",{className:"space-y-1",children:[xe.hasCompanyMeal&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-purple-200",children:"Pasto Aziendale:"}),e.jsxs("span",{className:"text-orange-300 font-medium",children:["-‚Ç¨",(L==null?void 0:L.pasto_aziendale_cost)||12]})]}),xe.hasMealVoucher&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-purple-200",children:"üé´ Buono Pasto:"}),e.jsxs("span",{className:"text-green-300 font-medium",children:["+‚Ç¨",(L==null?void 0:L.buoni_pasto_value)||7.5]})]})]})]})]},xe.id)),M.filter(xe=>xe.type==="warehouse").length>1&&e.jsx("div",{className:"mt-4 p-3 bg-yellow-500/20 rounded-lg",children:e.jsxs("p",{className:"text-white text-sm flex items-center space-x-2",children:[e.jsx(wt,{className:"h-4 w-4 flex-shrink-0"}),e.jsxs("span",{children:["Stai lavorando su ",M.filter(xe=>xe.type==="warehouse").length," turni magazzino contemporaneamente"]})]})})]}),p&&p.type==="warehouse"&&e.jsxs("div",{className:"bg-gradient-to-r from-blue-900 to-indigo-900 rounded-xl p-4 border border-blue-700 shadow-lg mt-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx("div",{className:"bg-blue-600 p-2 rounded-lg",children:e.jsx("svg",{className:"h-5 w-5 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),e.jsx("h5",{className:"text-white font-bold text-lg",children:"üìù Note Turno"})]}),e.jsx("textarea",{value:he,onChange:xe=>we(xe.target.value),placeholder:"Scrivi qui eventuali note, osservazioni o segnalazioni durante il turno...",className:"w-full bg-gray-800 bg-opacity-50 text-white border-2 border-blue-600 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400 min-h-[100px] placeholder-gray-400 transition-all",maxLength:500}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("p",{className:"text-blue-200 text-xs",children:[he.length,"/500 caratteri"]}),e.jsxs("button",{onClick:_t,className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center space-x-2 shadow-md",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),e.jsx("span",{children:"Salva Note"})]})]})]}),p&&p.type==="warehouse"&&p.hasLunchBreak&&e.jsx("div",{className:"space-y-4 mt-4",children:e.jsxs("div",{className:"bg-gradient-to-br from-orange-900/40 to-amber-900/40 backdrop-blur-sm rounded-xl p-5 shadow-2xl border border-orange-700/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-gradient-to-br from-orange-500 to-amber-600 p-2.5 rounded-xl shadow-lg",children:e.jsx(As,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-white font-bold text-lg",children:"Pausa Pranzo"}),e.jsx("p",{className:"text-orange-200 text-xs",children:"Gestisci la tua pausa"})]})]}),e.jsx("div",{className:`flex items-center space-x-1.5 px-3 py-1.5 rounded-full text-xs font-semibold shadow-md ${v?"bg-yellow-500":x?"bg-green-500":"bg-red-500"}`,children:v?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-3.5 w-3.5 border-2 border-white border-t-transparent rounded-full"}),e.jsx("span",{className:"text-white",children:"Rilevamento..."})]}):x?e.jsxs(e.Fragment,{children:[e.jsx(Ut,{className:"h-3.5 w-3.5 text-white animate-pulse"}),e.jsx("span",{className:"text-white",children:"GPS Attivo"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ut,{className:"h-3.5 w-3.5 text-white"}),e.jsx("span",{className:"text-white",children:"GPS Off"})]})})]}),!Ke&&!Ge?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>la(!1),disabled:v,className:"w-full bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white py-4 px-5 rounded-xl font-bold text-base flex items-center justify-center space-x-2.5 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-[1.02]",children:[e.jsx(As,{className:"h-6 w-6"}),e.jsx("span",{children:v?"Verifica GPS in corso...":x?"‚òï INIZIA PAUSA PRANZO":"‚òï INIZIA PAUSA (Richiedi GPS)"})]}),!x&&!v&&e.jsx("div",{className:"mt-3 bg-gradient-to-r from-yellow-900/50 to-amber-900/50 border-2 border-yellow-500/50 rounded-xl p-4 backdrop-blur-sm",children:e.jsxs("p",{className:"text-yellow-100 text-sm text-center flex items-center justify-center space-x-2",children:[e.jsx(wt,{className:"h-5 w-5 text-yellow-300 flex-shrink-0"}),e.jsx("span",{children:"GPS non disponibile. Verr√† richiesta l'attivazione o la pausa forzata."})]})})]}):Ke?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gradient-to-br from-orange-500/30 to-amber-500/30 border-2 border-orange-400 rounded-xl p-4 shadow-lg backdrop-blur-sm",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2.5 mb-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-4 h-4 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"absolute inset-0 w-4 h-4 bg-orange-400 rounded-full animate-ping"})]}),e.jsx("span",{className:"text-white font-bold text-lg",children:"üçΩÔ∏è PAUSA IN CORSO"})]}),e.jsxs("p",{className:"text-center text-sm text-orange-100 font-medium",children:["‚è∞ Iniziata alle ",e.jsx("span",{className:"text-white font-bold",children:Ge})]})]}),e.jsxs("button",{onClick:()=>Ct(!1),disabled:v,className:"w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white py-4 px-5 rounded-xl font-bold text-base flex items-center justify-center space-x-2.5 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-[1.02]",children:[e.jsx(ft,{className:"h-6 w-6"}),e.jsx("span",{children:v?"Verifica GPS in corso...":x?"‚úÖ TERMINA PAUSA PRANZO":"‚úÖ TERMINA PAUSA (Richiedi GPS)"})]}),!x&&!v&&e.jsx("div",{className:"bg-gradient-to-r from-yellow-900/50 to-amber-900/50 border-2 border-yellow-500/50 rounded-xl p-4 backdrop-blur-sm",children:e.jsxs("p",{className:"text-yellow-100 text-sm text-center flex items-center justify-center space-x-2",children:[e.jsx(wt,{className:"h-5 w-5 text-yellow-300 flex-shrink-0"}),e.jsx("span",{children:"GPS non disponibile. Verr√† richiesta l'attivazione o la pausa forzata."})]})})]}):e.jsxs("div",{className:"bg-gradient-to-br from-green-500/20 to-emerald-500/20 border-2 border-green-400 rounded-xl p-4 shadow-lg backdrop-blur-sm",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2.5 mb-2",children:[e.jsx(ft,{className:"h-6 w-6 text-green-300 animate-bounce"}),e.jsx("span",{className:"text-white font-bold text-lg",children:"‚úÖ Pausa Completata"})]}),Ge&&Ye&&e.jsxs("p",{className:"text-center text-sm text-green-100 font-medium",children:["üïê Dalle ",e.jsx("span",{className:"text-white font-bold",children:Ge})," alle ",e.jsx("span",{className:"text-white font-bold",children:Ye})]})]})]})}),e.jsx("button",{onClick:Vt,className:"w-full mt-4 bg-red-600 text-white py-3 px-4 rounded-xl hover:bg-red-700 font-bold text-lg shadow-lg",children:(p==null?void 0:p.type)==="warehouse"?"üõë TERMINA TURNO MAGAZZINO":"üõë TERMINA EVENTO"})]}),E==="main"&&(!p||p.type!=="warehouse")&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:`rounded-xl p-4 border ${x?"bg-green-900 border-green-700":"bg-red-900 border-red-700"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Qr,{className:`h-6 w-6 ${x?"text-green-400":"text-red-400"}`}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-white",children:x?"GPS Attivo":"GPS Richiesto"}),e.jsx("p",{className:"text-sm opacity-75",children:x?`${x.address} (¬±${x.accuracy}m)`:S||"Attivazione GPS necessaria per check-in"})]})]}),!x&&e.jsxs("button",{onClick:()=>b({requiredAccuracy:20,maxRetries:3}),disabled:v,className:"bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 disabled:bg-gray-600 flex items-center space-x-2",children:[v?e.jsx(Ds,{className:"h-4 w-4 animate-spin"}):e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:v?"Rilevamento...":"Attiva GPS"})]})]})}),q.length>0?e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-bold text-white mb-4 flex items-center space-x-2",children:[e.jsx(ba,{className:"h-6 w-6 text-purple-400"}),e.jsxs("span",{children:["Tuoi Turni Magazzino (",q.length,")"]})]}),e.jsx("div",{className:"space-y-3 mb-4",children:q.map(xe=>{var xt;const Be=xe.data_turno.split("T")[0],Xe=Be===Ya(),Pe=Be===Jc(),Ze=new Date(xe.data_turno),ie=new Date;ie.setHours(0,0,0,0),Ze.setHours(0,0,0,0);const P=Ze.getTime()-ie.getTime(),He=Math.ceil(P/(1e3*60*60*24));let dt="",Rt="";Xe?(dt="OGGI",Rt="bg-green-600"):Pe?(dt="DOMANI",Rt="bg-blue-600"):(dt=Ze.toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"}).toUpperCase(),Rt="bg-gray-600");const _s=F.find(cs=>{const zs=cs.date,Os=xe.data_turno.split("T")[0];return cs.shift_id===xe.turno_id&&zs===Os}),ms=!!_s,$t=(_s==null?void 0:_s.status)==="active",tt=Ms(xe);return e.jsxs("div",{className:`bg-gray-700 rounded-lg p-4 border-l-4 ${ms?"border-green-500":"border-purple-500"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:`${Rt} text-white px-3 py-1 rounded-full text-xs font-bold`,children:dt}),ms&&e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${$t?"bg-orange-600 text-white":"bg-green-600 text-white"}`,children:$t?"üî• IN CORSO":"‚úÖ COMPLETATO"})]}),e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx(zt,{className:"h-5 w-5 text-purple-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h4",{className:"font-medium text-white",children:["Turno ",xe.nome_magazzino]}),e.jsxs("p",{className:"text-xs text-purple-300 font-medium",children:["üìç ",xe.nome_magazzino]}),e.jsxs("p",{className:"text-sm text-gray-300",children:[xs(xe.ora_inizio_turno)," - ",xs(xe.ora_fine_turno)]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-3",children:[e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800",children:((xt=xe.crew_template_turni)==null?void 0:xt.pausa_pranzo)!==!1?"üçΩÔ∏è Con pausa pranzo":"‚ö° Senza pausa pranzo"}),!tt.isValid&&e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${tt.isExpired?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:tt.isExpired?"‚è∞ Turno scaduto":"‚è≥ Non ancora iniziato"}),tt.isValid&&e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-green-100 text-green-800",children:"Turno attivo"})]}),ms?e.jsx("div",{className:"w-full px-4 py-2 rounded-lg font-medium bg-green-600 text-white text-center",children:$t?"Turno in Corso":"Turno Completato"}):e.jsx("button",{onClick:()=>Ma(xe),disabled:!Xe||!x||!tt.canCheckIn||G&&G.status==="active",className:`w-full px-4 py-2 rounded-lg font-medium ${Xe&&tt.canCheckIn&&x&&(!G||G.status!=="active")?"bg-purple-600 text-white hover:bg-purple-700":"bg-gray-600 text-gray-300 cursor-not-allowed"}`,children:Xe?G&&G.status==="active"?"Completa turno attivo":x?tt.isExpired?"Turno Scaduto":tt.canCheckIn?"Inizia Check-in":"Non Disponibile":"GPS Richiesto":He>0?`Inizia tra ${He} ${He===1?"giorno":"giorni"}`:"Turno passato"})]},xe.id)})}),e.jsx("div",{className:"bg-blue-900 border border-blue-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(ct,{className:"h-5 w-5 text-blue-400 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-blue-100",children:"Processo Check-in Magazzino"}),e.jsxs("ol",{className:"text-sm text-blue-200 mt-2 space-y-1 list-decimal list-inside",children:[e.jsx("li",{children:"Verifica orario turno (deve essere attivo)"}),e.jsx("li",{children:"Verifica attivazione GPS"}),e.jsx("li",{children:"Selezione opzioni pasto (se turno con pausa)"}),e.jsx("li",{children:"Scansione QR code magazzino"}),e.jsx("li",{children:"Check-in con timer e auto-checkout programmato"})]})]})]})})]}):e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700 text-center",children:[e.jsx(zt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Nessun Turno Magazzino Oggi"}),e.jsx("p",{className:"text-gray-300",children:"Non hai turni di magazzino assegnati per oggi."}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Controlla il calendario per i prossimi turni."})]})]}),E==="meal_selection"&&W&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:"Opzioni Pasto"}),e.jsx("button",{onClick:()=>{U("main"),se(null)},className:"bg-gray-700 p-3 rounded-lg hover:bg-gray-600",children:e.jsx(jt,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(Bs,{className:"h-12 w-12 mx-auto mb-2 text-orange-400"}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"Selezione Pasto"}),e.jsxs("p",{className:"text-gray-300 mt-1",children:['Il turno "',W.nome_magazzino,'" include pausa pranzo']})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:`border-2 rounded-xl p-4 cursor-pointer transition-all ${me?"border-orange-500 bg-orange-600":"border-gray-600 bg-gray-700 hover:bg-gray-600"}`,onClick:()=>{Q(!me),me||de(!1)},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center ${me?"bg-white bg-opacity-20":"bg-orange-600"}`,children:e.jsx(Bs,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-white",children:"Pasto Aziendale"}),e.jsx("p",{className:"text-sm text-gray-300",children:"L'azienda anticipa il costo, verr√† detratto dallo stipendio"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-lg font-bold text-orange-300",children:["‚Ç¨",(L==null?void 0:L.pasto_aziendale_cost)||12]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Costo"})]})]})}),e.jsx("div",{className:`border-2 rounded-xl p-4 ${L!=null&&L.buoni_pasto_enabled?"border-green-500 bg-green-600":"border-gray-600 bg-gray-700"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center ${L!=null&&L.buoni_pasto_enabled?"bg-white bg-opacity-20":"bg-gray-600"}`,children:e.jsx(Ss,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-white",children:"Buono Pasto"}),e.jsx("p",{className:"text-sm text-gray-300",children:L!=null&&L.buoni_pasto_enabled?"‚úÖ Incluso automaticamente nel tuo contratto":"‚ùå Non incluso nel tuo contratto"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:`text-lg font-bold ${L!=null&&L.buoni_pasto_enabled?"text-green-300":"text-gray-500"}`,children:L!=null&&L.buoni_pasto_enabled?`‚Ç¨${(L==null?void 0:L.buoni_pasto_value)||7.5}`:"Non disponibile"}),e.jsx("div",{className:"text-xs text-gray-400",children:L!=null&&L.buoni_pasto_enabled?"Valore":"Benefit"})]})]})})]}),e.jsx("button",{onClick:ts,className:"w-full mt-6 bg-blue-600 text-white py-4 px-4 rounded-xl hover:bg-blue-700 font-bold text-lg shadow-lg",children:"‚û°Ô∏è CONTINUA CON QR CODE"})]})]}),E==="scanner"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:"Scanner QR Magazzino"}),e.jsx("button",{onClick:()=>{Ce.current&&Ce.current.clear(),le(!1),U("main"),se(null)},className:"bg-gray-700 p-3 rounded-lg hover:bg-gray-600",children:e.jsx(jt,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx(ba,{className:"h-12 w-12 mx-auto mb-2 text-purple-400"}),e.jsx("p",{className:"text-white font-medium",children:"Inquadra il QR Code del Magazzino"}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Posiziona il QR code al centro del riquadro"})]}),ae&&e.jsx("div",{id:"qr-reader",className:"w-full max-w-sm mx-auto"}),be&&e.jsx("div",{className:"mt-4 bg-red-900 border border-red-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(wt,{className:"h-4 w-4 text-red-400"}),e.jsx("span",{className:"text-red-200 text-sm",children:be})]})}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-600",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("h4",{className:"text-white font-medium mb-2",children:"Non riesci a scansionare?"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Inserisci manualmente il codice backup del magazzino"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"text",placeholder:"Inserisci codice backup o QR code...",className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400",value:_e,onChange:xe=>ge(xe.target.value.toUpperCase())}),e.jsx("button",{onClick:()=>{_e.trim()?Fe(_e.trim()):u("Codice Richiesto","Inserisci un codice backup valido prima di procedere")},disabled:!_e.trim(),className:"w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed font-medium",children:"‚úÖ CONFERMA CODICE"})]})]})]}),W&&e.jsxs("div",{className:"bg-blue-900 rounded-xl p-4 border border-blue-700",children:[e.jsx("h4",{className:"font-medium text-blue-100 mb-3",children:"Riepilogo Check-in"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-blue-200",children:"Turno:"}),e.jsxs("span",{className:"text-white font-medium",children:["Turno ",W.nome_magazzino]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-blue-200",children:"Orario:"}),e.jsxs("span",{className:"text-white font-medium",children:[xs(W.ora_inizio_turno)," - ",xs(W.ora_fine_turno)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-blue-200",children:"Pausa pranzo:"}),e.jsx("span",{className:"text-white font-medium",children:((qt=W.crew_template_turni)==null?void 0:qt.pausa_pranzo)!==!1?"1 ora inclusa":"Nessuna pausa"})]}),me&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-blue-200",children:"Pasto aziendale:"}),e.jsxs("span",{className:"text-orange-300 font-medium",children:["‚Ç¨",(L==null?void 0:L.pasto_aziendale_cost)||12]})]}),V&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-blue-200",children:"Buono pasto:"}),e.jsxs("span",{className:"text-yellow-300 font-medium",children:["‚Ç¨",(L==null?void 0:L.buoni_pasto_value)||7.5]})]}),X&&e.jsx("div",{className:"border-t border-blue-600 pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[X.isValid?e.jsx(ft,{className:"h-4 w-4 text-green-400"}):e.jsx(wt,{className:"h-4 w-4 text-red-400"}),e.jsx("span",{className:`text-sm ${X.isValid?"text-green-200":"text-red-200"}`,children:X.reason})]})})]})]}),e.jsx("div",{className:"bg-purple-900 rounded-xl p-4 border border-purple-700",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(di,{className:"h-5 w-5 text-purple-400 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-purple-100",children:"Scanner QR Magazzino"}),e.jsxs("ul",{className:"text-sm text-purple-200 mt-2 space-y-1",children:[e.jsx("li",{children:"‚Ä¢ Punta la fotocamera verso il QR code del magazzino"}),e.jsx("li",{children:"‚Ä¢ Mantieni il telefono fermo e stabile"}),e.jsx("li",{children:"‚Ä¢ Assicurati che ci sia buona illuminazione"}),e.jsx("li",{children:"‚Ä¢ Il QR code deve essere completamente visibile"}),e.jsx("li",{children:"‚Ä¢ La posizione GPS verr√† verificata automaticamente"})]})]})]})})]}),!g&&e.jsx("div",{className:"bg-orange-900 rounded-xl p-4 border border-orange-700",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(wt,{className:"h-5 w-5 text-orange-400"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-orange-100",children:"Modalit√† Offline"}),e.jsx("p",{className:"text-sm text-orange-200",children:"I check-in magazzino verranno salvati localmente e sincronizzati quando torni online"})]})]})}),Ue&&rt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-6 border border-red-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-red-900 p-3 rounded-full",children:e.jsx(wt,{className:"h-6 w-6 text-red-400"})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"Check-in Forzato"})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-4",children:[e.jsxs("p",{className:"text-red-300 text-sm mb-2",children:[e.jsx("strong",{children:"Attenzione:"})," Il GPS non √® disponibile o non funziona correttamente."]}),e.jsxs("p",{className:"text-red-200 text-xs",children:["Stai per effettuare un check-in ",e.jsx("strong",{children:"senza posizione GPS"}),'. Questo verr√† registrato come "Check-in Forzato" e sar√† visibile ai supervisori.']})]}),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-3",children:[e.jsx("h4",{className:"text-white font-medium mb-2",children:"Magazzino:"}),e.jsx("p",{className:"text-gray-300 text-sm",children:rt.name}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:rt.address})]}),S&&e.jsx("div",{className:"bg-gray-700 rounded-lg p-3",children:e.jsxs("p",{className:"text-gray-400 text-xs",children:[e.jsx("strong",{children:"Motivo:"})," ",S]})}),e.jsx("div",{className:"bg-yellow-900/20 border border-yellow-700 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-300 text-xs",children:"‚ÑπÔ∏è Consigliamo di risolvere il problema GPS prima del check-in. Se continui, il sistema registrer√† l'assenza della posizione."})})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>{qe(!1),at(null)},className:"flex-1 bg-gray-700 text-white py-3 px-4 rounded-lg hover:bg-gray-600 font-medium",children:"Annulla"}),e.jsx("button",{onClick:()=>{rt&&(oa(rt,!0),qe(!1),at(null))},className:"flex-1 bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 font-medium",children:"Conferma Check-in Forzato"})]})]})}),H&&fe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-6 border border-orange-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-orange-900 p-3 rounded-full",children:e.jsx(As,{className:"h-6 w-6 text-orange-400"})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"Inserisci Pausa Pranzo"})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"bg-orange-900/20 border border-orange-700 rounded-lg p-4",children:[e.jsx("p",{className:"text-orange-300 text-sm mb-2",children:e.jsx("strong",{children:"Pausa Non Registrata"})}),e.jsx("p",{className:"text-orange-200 text-xs",children:"Non hai registrato la pausa pranzo durante il turno. Puoi ancora inserire manualmente gli orari entro 8 ore dal check-out."})]}),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-3",children:[e.jsx("h4",{className:"text-white font-medium mb-2",children:"Turno:"}),e.jsx("p",{className:"text-gray-300 text-sm",children:fe.nome_turno}),e.jsxs("p",{className:"text-gray-400 text-xs mt-1",children:[new Date(fe.date).toLocaleDateString("it-IT")," ‚Ä¢ ",fe.check_in_time," - ",fe.check_out_time]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-white font-medium mb-2",children:"Orario Inizio Pausa"}),e.jsx("input",{type:"time",value:Re,onChange:xe=>ee(xe.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-white font-medium mb-2",children:"Orario Fine Pausa"}),e.jsx("input",{type:"time",value:oe,onChange:xe=>De(xe.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white"})]})]}),e.jsx("div",{className:"bg-yellow-900/20 border border-yellow-700 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-300 text-xs",children:'‚ö†Ô∏è La posizione GPS non verr√† registrata per questa pausa. Inserendo gli orari manualmente, la pausa verr√† marcata come "inserita in ritardo".'})}),Re&&oe&&oe>Re&&e.jsx("div",{className:"bg-blue-900/20 border border-blue-700 rounded-lg p-3",children:e.jsxs("p",{className:"text-blue-300 text-sm text-center",children:["Durata pausa: ",e.jsxs("strong",{children:[Nt(Re,oe)," minuti"]})]})})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>{ne(!1),Ie(null),ee(""),De("")},className:"flex-1 bg-gray-700 text-white py-3 px-4 rounded-lg hover:bg-gray-600 font-medium",children:"Annulla"}),e.jsx("button",{onClick:qs,disabled:!Re||!oe,className:"flex-1 bg-orange-600 text-white py-3 px-4 rounded-lg hover:bg-orange-700 disabled:bg-gray-600 disabled:cursor-not-allowed font-medium",children:"Salva Pausa"})]})]})}),Kt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-6 border border-yellow-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-yellow-900 p-3 rounded-full",children:e.jsx(wt,{className:"h-6 w-6 text-yellow-400"})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"GPS Non Disponibile"})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"bg-yellow-900/20 border border-yellow-700 rounded-lg p-4",children:[e.jsx("p",{className:"text-yellow-200 text-sm mb-2",children:"Il sistema GPS non √® disponibile o non funziona correttamente."}),e.jsx("p",{className:"text-yellow-300 text-xs",children:ht==="start"?"Non √® possibile registrare la posizione di inizio pausa.":"Non √® possibile registrare la posizione di fine pausa."})]}),e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-4",children:[e.jsx("p",{className:"text-red-300 text-sm font-medium mb-2",children:"‚ö†Ô∏è Opzione Forzatura"}),e.jsxs("p",{className:"text-red-200 text-xs mb-3",children:["Puoi procedere senza GPS, ma questa azione verr√† registrata come ",e.jsx("strong",{children:"FORZATA"})," nel sistema e l'azienda verr√† notificata."]}),e.jsx("p",{className:"text-red-300 text-xs",children:"Consigliamo di:"}),e.jsxs("ul",{className:"text-red-200 text-xs list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Verificare che il GPS sia attivato nelle impostazioni"}),e.jsx("li",{children:"Controllare i permessi dell'app"}),e.jsx("li",{children:"Spostarsi in un'area con migliore copertura"})]})]})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>{St(!1),Jt(null)},className:"flex-1 bg-gray-700 text-white py-3 px-4 rounded-lg hover:bg-gray-600 font-medium",children:"Annulla"}),e.jsx("button",{onClick:()=>{St(!1),ht==="start"?la(!0):Ct(!0),Jt(null)},className:"flex-1 bg-yellow-600 text-white py-3 px-4 rounded-lg hover:bg-yellow-700 font-medium",children:"Forza Senza GPS"})]})]})}),Ee&&p&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 z-50 p-4",onTouchMove:bs,onTouchEnd:na,onMouseMove:bs,onMouseUp:na,children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-4 border border-red-500 max-h-[85vh] overflow-y-auto absolute",style:{left:nt.x?`${nt.x}px`:"50%",top:nt.y?`${nt.y}px`:"50%",transform:nt.x?"none":"translate(-50%, -50%)",cursor:Oe?"grabbing":"default"},children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3 cursor-grab active:cursor-grabbing select-none",onTouchStart:xr,onMouseDown:xr,children:[e.jsx("div",{className:"bg-red-900 p-2 rounded-full",children:e.jsx(wt,{className:"h-5 w-5 text-red-400"})}),e.jsx("h3",{className:"text-lg font-bold text-white flex-1",children:"Conferma Check-out"}),e.jsxs("div",{className:"text-gray-400 text-xs flex items-center space-x-1",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"})}),e.jsx("span",{children:"Trascina"})]})]}),e.jsxs("div",{className:"space-y-3 mb-4",children:[e.jsx("div",{className:"bg-gray-700 rounded-lg p-3",children:e.jsxs("div",{className:"space-y-1.5 text-sm",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("span",{className:"text-gray-400",children:"Turno:"}),e.jsx("span",{className:"text-white font-medium text-xs text-right ml-2",children:p.shiftName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"Check-in:"}),e.jsx("span",{className:"text-white",children:xs(p.checkInTime)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"Tempo:"}),e.jsx("span",{className:"text-white font-medium",children:B})]}),p.hasLunchBreak&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"Pausa:"}),e.jsx("span",{className:"text-white text-xs",children:Ke?"‚è∏Ô∏è In corso":Ge?"‚úÖ Fatta":"‚ö†Ô∏è Non fatta"})]})]})}),he&&e.jsxs("div",{className:"bg-gradient-to-r from-blue-900/50 to-indigo-900/50 rounded-lg p-3 border border-blue-600",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsxs("label",{className:"text-blue-200 font-medium text-sm flex items-center space-x-2",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),e.jsx("span",{children:"üìù Note scritte durante il turno:"})]}),e.jsxs("button",{onClick:()=>Qe(!ve),className:"text-blue-300 text-xs px-2 py-1 bg-blue-800/50 rounded hover:bg-blue-700/50 transition-colors flex items-center space-x-1",children:[e.jsx("span",{children:ve?"Comprimi":"Espandi"}),e.jsx("svg",{className:`h-3 w-3 transition-transform ${ve?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})]}),e.jsx("div",{className:`bg-gray-800/70 text-blue-100 border border-blue-700 rounded-lg p-2.5 text-sm italic whitespace-pre-wrap transition-all overflow-hidden ${ve?"max-h-[400px] overflow-y-auto":"max-h-[80px]"}`,children:he}),!ve&&he.length>100&&e.jsx("div",{className:"text-blue-400 text-xs mt-1 italic",children:'... clicca "Espandi" per vedere tutto'}),e.jsx("p",{className:"text-blue-300 text-xs mt-1.5 italic",children:"‚úì Queste note sono state salvate in NoteTurno"})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-700 to-gray-800 rounded-lg p-3 border border-gray-600",children:[e.jsxs("label",{className:"block text-white font-medium mb-1.5 text-sm flex items-center space-x-2",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("span",{children:"üèÅ Vuoi aggiungere note di fine turno?"})]}),e.jsx("p",{className:"text-gray-400 text-xs mb-2",children:he?"Puoi aggiungere ulteriori osservazioni finali, problemi o consegne":"Aggiungi eventuali osservazioni, problemi riscontrati o consegne da fare"}),e.jsx("textarea",{value:ke,onChange:xe=>Z(xe.target.value),placeholder:he?"Note aggiuntive di fine turno (opzionali)...":"Note di fine turno (opzionali)...",className:"w-full bg-gray-900 text-white border-2 border-gray-600 rounded-lg p-2.5 text-sm focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500 min-h-[80px] placeholder-gray-500 transition-all",maxLength:500}),e.jsxs("div",{className:"flex items-center justify-between mt-1.5",children:[e.jsx("p",{className:"text-gray-400 text-xs italic",children:ke.length>0?'‚úì Salvate in "notes" al checkout':"Facoltative"}),e.jsxs("p",{className:"text-gray-400 text-xs",children:[ke.length,"/500"]})]})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:()=>{te(!1),Z("")},className:"flex-1 bg-gray-700 text-white py-2.5 px-3 rounded-lg hover:bg-gray-600 font-medium text-sm",children:"Annulla"}),e.jsx("button",{onClick:tr,className:"flex-1 bg-red-600 text-white py-2.5 px-3 rounded-lg hover:bg-red-700 font-medium text-sm",children:"Conferma"})]})]})})]})},td=()=>{const{user:n}=Pt(),{showSuccess:l,showError:c,showWarning:u}=us(),{currentLocation:f,getCurrentLocation:x,isLoading:b,error:v}=un(),{isOnline:S,addOfflineData:g}=Da(),{currentSession:j,activeSessions:p,elapsedTime:M,elapsedTimes:B,startSession:k,endSession:R,manualCheckOut:C,loadActiveSession:D}=hn(),[E,U]=w.useState([]),[q,J]=w.useState(!0),[N,_]=w.useState(!1),[L,I]=w.useState(null),[K,O]=w.useState(null),[W,se]=w.useState({}),[G,$]=w.useState({});w.useEffect(()=>{n!=null&&n.id&&(_e(),F())},[n==null?void 0:n.id]);const F=async()=>{try{const{data:V,error:de}=await je.from("employee_meal_benefits").select("*").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0).maybeSingle();de?console.error("‚ùå Errore caricamento benefit dipendente:",de):V&&O(V)}catch(V){console.error("‚ùå Errore generale caricamento benefit:",V)}},re=V=>{if(!K)return[];const de=[];return V.bonus_diaria&&K.diaria_eventi_enabled&&K.diaria_eventi_value>0&&de.push({name:"Diaria Eventi",value:K.diaria_eventi_value}),V.bonus_trasferta&&K.diaria_trasferta_enabled&&K.diaria_trasferta_value>0&&de.push({name:"Diaria Trasferta",value:K.diaria_trasferta_value}),V.benefits_evento_ids&&V.benefits_evento_ids.length>0&&V.benefits_evento_ids.forEach(ae=>{const le=W[ae];le&&de.push({name:le.name,value:le.value})}),de},_e=async()=>{try{J(!0);const V=new Date,de=V.getFullYear(),ae=String(V.getMonth()+1).padStart(2,"0"),le=String(V.getDate()).padStart(2,"0"),be=`${de}-${ae}-${le}`;console.log("üìÖ Caricamento eventi di oggi e futuri:",be);const{data:ye,error:Ce}=await je.from("crew_event_assegnazione").select(`
          *,
          event_benefits:benefits_evento_ids
        `).eq("dipendente_freelance_id",n==null?void 0:n.id).gte("giorno_inizio_evento",be).order("giorno_inizio_evento",{ascending:!0}).order("evento_orario_convocazione",{ascending:!0});if(Ce){console.error("‚ùå Errore caricamento eventi:",Ce),U([]),J(!1);return}const{data:Ne,error:Ae}=await je.from("timesheet_entries").select("id, event_id, start_time, end_time, status").eq("crew_id",n==null?void 0:n.id).eq("date",be);Ae&&console.error("‚ùå Errore caricamento check-in:",Ae);const Ue=(ye||[]).flatMap(at=>at.benefits_evento_ids||[]).filter((at,Ke,Je)=>at&&Je.indexOf(at)===Ke);let qe={};if(Ue.length>0){const{data:at,error:Ke}=await je.from("crew_tariffe").select("id, nome_tariffa, importo, categoria").in("id",Ue);!Ke&&at&&(qe=at.reduce((Je,Ge)=>(Je[Ge.id]={name:Ge.nome_tariffa,value:parseFloat(Ge.importo),category:Ge.categoria},Je),{}),se(qe),console.log("‚úÖ Benefit caricati:",Object.keys(qe).length))}const rt=(ye||[]).map(at=>{const Ke=Ne==null?void 0:Ne.find(Je=>Je.event_id===at.evento_id);return{...at,checkin:Ke||void 0}});console.log("‚úÖ Eventi trovati:",rt.length),U(rt)}catch(V){console.error("‚ùå Errore generale caricamento eventi:",V),U([])}finally{J(!1)}};async function ge(V,de=!1){var ae;try{let le=f,be=!1,ye=null;if(!le&&!de){I(V),_(!0);return}!le&&de&&(be=!0,ye=v||"GPS non disponibile - Check-in forzato dall'utente",console.warn("‚ö†Ô∏è Check-in forzato senza GPS:",ye));const Ce=new Date;let Ne="nessuna",Ae=0;K&&(V.bonus_trasferta&&K.diaria_trasferta_enabled?(Ne="trasferta",Ae=K.diaria_trasferta_value):V.bonus_diaria&&K.diaria_eventi_enabled&&(Ne="evento",Ae=K.diaria_eventi_value));const Ue=Ce.getFullYear(),qe=String(Ce.getMonth()+1).padStart(2,"0"),rt=String(Ce.getDate()).padStart(2,"0"),at=`${Ue}-${qe}-${rt}`,Ke=((ae=G[V.id])==null?void 0:ae.trim())||null;let Je=Ke;be&&(Je=Ke?`${Ke}

[Check-in forzato: ${ye}]`:`Check-in forzato: ${ye}`);const Ge={crew_id:n==null?void 0:n.id,event_id:V.evento_id,date:at,start_time:Ce.toTimeString().split(" ")[0],tracking_type:V.evento_trasferta?"days":"hours",retention_percentage:0,gross_amount:V.tariffa_evento_assegnata||0,net_amount:V.tariffa_evento_assegnata||0,hourly_rate:V.evento_trasferta?null:V.tariffa_evento_assegnata,daily_rate:V.evento_trasferta?V.tariffa_evento_assegnata:null,gps_location:le?{latitude:le.latitude,longitude:le.longitude,accuracy:le.accuracy,address:le.address,timestamp:le.timestamp,forced:be,error_reason:ye}:null,diaria_type:Ne,diaria_amount:Ae,meal_voucher:(K==null?void 0:K.buoni_pasto_enabled)||!1,status:"submitted",notes:Je};if(S){const{error:yt}=await je.from("timesheet_entries").insert([Ge]);if(yt){console.error("‚ùå Errore check-in evento:",yt),c(`Errore durante il check-in: ${yt.message}`);return}}else g("event_checkin",Ge),u("Check-in salvato offline - verr√† sincronizzato quando tornerai online");be?u("Check-in forzato completato (senza GPS)"):l(`Check-in completato per ${V.nome_evento}`),_(!1),I(null),await _e(),await D()}catch(le){console.error("‚ùå Errore durante check-in evento:",le),c("Errore imprevisto durante il check-in")}}async function X(V){if(!V.checkin){c("Nessun check-in trovato per questo evento");return}try{const ae={end_time:"23:59:00",status:"submitted"};if(S){const{error:be}=await je.from("timesheet_entries").update(ae).eq("id",V.checkin.id);if(be){console.error("‚ùå Errore check-out evento:",be),c(`Errore durante il check-out: ${be.message}`);return}}else g("event_checkout",{id:V.checkin.id,...ae}),u("Check-out salvato offline - verr√† sincronizzato quando tornerai online");const le=p.find(be=>{var ye;return be.id===((ye=V.checkin)==null?void 0:ye.id)});le&&R(le.id),l(`Presenza confermata per ${V.nome_evento}`),await _e()}catch(de){console.error("‚ùå Errore durante check-out evento:",de),c("Errore imprevisto durante il check-out")}}const pe=V=>V?/^\d{2}:\d{2}$/.test(V)?V:/^\d{2}:\d{2}:\d{2}$/.test(V)?V.substring(0,5):"09:00":"09:00",me=V=>V.nome_evento.toLowerCase().includes("magazzino")?zt:V.evento_trasferta?Ts:ut,Q=V=>V.nome_evento.toLowerCase().includes("magazzino")?"from-gray-500 to-gray-600":V.evento_trasferta?"from-purple-500 to-pink-500":"from-blue-500 to-cyan-500";return q?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento check-in eventi..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:`rounded-xl p-4 border ${f?"bg-green-900 border-green-700":"bg-red-900 border-red-700"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Qr,{className:`h-6 w-6 ${f?"text-green-400":"text-red-400"}`}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-white",children:f?"GPS Attivo":"GPS Richiesto"}),e.jsx("p",{className:"text-sm opacity-75",children:f?`${f.address} (¬±${f.accuracy}m)`:v||"Attivazione GPS necessaria per check-in eventi"})]})]}),!f&&e.jsxs("button",{onClick:()=>x({requiredAccuracy:20,maxRetries:3}),disabled:b,className:"bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 disabled:bg-gray-600 flex items-center space-x-2",children:[b?e.jsx(Ds,{className:"h-4 w-4 animate-spin"}):e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:b?"Rilevamento...":"Attiva GPS"})]})]})}),p.filter(V=>V.type!=="warehouse").length>0&&e.jsxs("div",{className:"bg-gradient-to-br from-orange-600 to-red-600 rounded-xl p-4 border border-orange-500",children:[e.jsxs("h3",{className:"text-lg font-bold text-white mb-3 flex items-center space-x-2",children:[e.jsx(ct,{className:"h-5 w-5"}),e.jsxs("span",{children:["Sessioni Attive (",p.filter(V=>V.type!=="warehouse").length,")"]})]}),e.jsx("div",{className:"space-y-2",children:p.filter(V=>V.type!=="warehouse").map(V=>e.jsx("div",{className:"bg-black/20 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[V.type==="warehouse"?e.jsx(zt,{className:"h-5 w-5 text-white"}):e.jsx(ut,{className:"h-5 w-5 text-white"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:V.type==="warehouse"?"Turno Magazzino":V.shiftName||"Evento"}),e.jsxs("p",{className:"text-white/70 text-sm",children:["Check-in: ",V.checkInTime]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold text-white font-mono",children:B[V.id]||"00:00:00"}),e.jsx("p",{className:"text-white/70 text-xs",children:"Tempo trascorso"})]})]})},V.id))}),p.filter(V=>V.type!=="warehouse").length>1&&e.jsx("div",{className:"mt-3 p-2 bg-yellow-500/20 rounded-lg",children:e.jsxs("p",{className:"text-white text-sm flex items-center space-x-2",children:[e.jsx(wt,{className:"h-4 w-4"}),e.jsxs("span",{children:["Hai ",p.filter(V=>V.type!=="warehouse").length," eventi attivi contemporaneamente"]})]})})]}),E.length>0?e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-bold text-white mb-4 flex items-center space-x-2",children:[e.jsx(Ut,{className:"h-6 w-6 text-blue-400"}),e.jsxs("span",{children:["I Tuoi Eventi (",E.length,")"]})]}),e.jsx("div",{className:"space-y-4",children:E.map(V=>{const de=me(V),ae=V.giorno_inizio_evento,le=new Date,be=le.getFullYear(),ye=String(le.getMonth()+1).padStart(2,"0"),Ce=String(le.getDate()).padStart(2,"0"),Ne=`${be}-${ye}-${Ce}`,Ae=new Date(le);Ae.setDate(Ae.getDate()+1);const Ue=Ae.getFullYear(),qe=String(Ae.getMonth()+1).padStart(2,"0"),rt=String(Ae.getDate()).padStart(2,"0"),at=`${Ue}-${qe}-${rt}`,Ke=ae===Ne,Je=ae===at,Ge=new Date(ae+"T00:00:00");let yt="",Ye="";return Ke?(yt="OGGI",Ye="bg-green-600"):Je?(yt="DOMANI",Ye="bg-blue-600"):(yt=Ge.toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"}).toUpperCase(),Ye="bg-gray-600"),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-4 border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:`${Ye} text-white px-3 py-1 rounded-full text-xs font-bold`,children:yt}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium bg-gradient-to-r ${Q(V)} text-white`,children:V.evento_trasferta?"Trasferta":"Evento"})]}),e.jsxs("div",{className:"flex items-start mb-3",children:[e.jsx(de,{className:"h-5 w-5 text-blue-400 mt-1 mr-2"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-white",children:V.nome_evento}),e.jsx("p",{className:"text-sm text-gray-300",children:V.evento_localita}),e.jsx("p",{className:"text-xs text-gray-400",children:V.nome_azienda})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 mb-3",children:[V.evento_orario_convocazione&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ct,{className:"h-4 w-4 text-green-400"}),e.jsxs("span",{className:"text-sm text-white",children:["Convocazione: ",pe(V.evento_orario_convocazione)]})]}),V.evento_indirizzo&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm text-white",children:V.evento_indirizzo})]}),V.tariffa_evento_assegnata&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Xa,{className:"h-4 w-4 text-yellow-400"}),e.jsxs("span",{className:"text-sm text-white",children:["Tariffa: ‚Ç¨",V.tariffa_evento_assegnata]})]})]}),(V.link_scheda_tecnica||V.link_mappa_gps)&&e.jsxs("div",{className:"flex gap-2 mb-3",children:[V.link_scheda_tecnica&&e.jsxs("a",{href:V.link_scheda_tecnica,target:"_blank",rel:"noopener noreferrer",className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg flex items-center justify-center space-x-2 transition-colors text-sm",children:[e.jsx(Ht,{className:"h-4 w-4"}),e.jsx("span",{children:"SCHEDA LAVORO"})]}),V.link_mappa_gps&&e.jsxs("a",{href:V.link_mappa_gps,target:"_blank",rel:"noopener noreferrer",className:"flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg flex items-center justify-center space-x-2 transition-colors text-sm",children:[e.jsx(Qr,{className:"h-4 w-4"}),e.jsx("span",{children:"MAPPA"})]})]}),(()=>{const Te=re(V);return Te.length>0&&e.jsxs("div",{className:"bg-green-900/20 border border-green-700 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(Ss,{className:"h-4 w-4 text-green-400"}),e.jsx("span",{className:"text-sm font-medium text-green-400",children:"Benefit Attivi per questo Evento"})]}),e.jsx("div",{className:"space-y-1",children:Te.map((H,ne)=>e.jsxs("div",{className:"flex items-center justify-between bg-green-800/30 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-green-300",children:H.name}),e.jsxs("span",{className:"text-xs font-bold text-green-200",children:["‚Ç¨",H.value.toFixed(2)]})]},ne))})]})})(),Ke?V.checkin?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-green-900/30 border border-green-700 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ft,{className:"h-5 w-5 text-green-400"}),e.jsx("span",{className:"text-green-400 font-medium",children:"Check-in Effettuato"})]}),e.jsx("span",{className:"text-green-300 text-sm font-bold",children:pe(V.checkin.start_time)})]}),V.checkin.end_time&&e.jsxs("div",{className:"flex items-center justify-between text-sm text-green-300",children:[e.jsx("span",{children:"Check-out:"}),e.jsx("span",{className:"font-bold",children:pe(V.checkin.end_time)})]})]}),!V.checkin.end_time&&e.jsxs("button",{onClick:()=>X(V),className:"w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 font-medium flex items-center justify-center space-x-2",children:[e.jsx(ft,{className:"h-5 w-5"}),e.jsx("span",{children:"CHECK-OUT EVENTO"})]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Note (opzionale)"}),e.jsx("textarea",{value:G[V.id]||"",onChange:Te=>$(H=>({...H,[V.id]:Te.target.value})),placeholder:"Aggiungi eventuali note per il check-in...",rows:3,className:"w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsx("button",{onClick:()=>ge(V),className:"w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-medium",children:f?"üìç CHECK-IN GPS EVENTO":"‚ö†Ô∏è CHECK-IN SENZA GPS"})]}):e.jsx("div",{className:"w-full bg-gray-600 text-gray-300 py-3 px-4 rounded-lg font-medium text-center cursor-not-allowed",children:"Check-in disponibile il giorno dell'evento"})]},V.id)})})]}):e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700 text-center",children:[e.jsx(ut,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Nessun Evento Oggi"}),e.jsx("p",{className:"text-gray-300",children:"Non hai eventi assegnati per oggi."}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Controlla il calendario per le prossime attivit√†."})]})]}),!S&&e.jsx("div",{className:"bg-orange-900 rounded-xl p-4 border border-orange-700",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(wt,{className:"h-5 w-5 text-orange-400"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-orange-100",children:"Modalit√† Offline"}),e.jsx("p",{className:"text-sm text-orange-200",children:"I check-in eventi verranno salvati localmente e sincronizzati quando torni online"})]})]})}),N&&L&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-6 border border-red-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-red-900 p-3 rounded-full",children:e.jsx(wt,{className:"h-6 w-6 text-red-400"})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"Check-in Forzato"})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-4",children:[e.jsxs("p",{className:"text-red-300 text-sm mb-2",children:[e.jsx("strong",{children:"Attenzione:"})," Il GPS non √® disponibile o non funziona correttamente."]}),e.jsxs("p",{className:"text-red-200 text-xs",children:["Stai per effettuare un check-in ",e.jsx("strong",{children:"senza posizione GPS"}),'. Questo verr√† registrato come "Check-in Forzato" e sar√† visibile ai supervisori. Si consiglia di  ',e.jsx("strong",{children:"abilitare la posizione"})," per evitare l' eventuale annullamento del turno."]})]}),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-3",children:[e.jsx("h4",{className:"text-white font-medium mb-2",children:"Evento:"}),e.jsx("p",{className:"text-gray-300 text-sm",children:L.nome_evento}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:L.evento_localita})]}),v&&e.jsx("div",{className:"bg-gray-700 rounded-lg p-3",children:e.jsxs("p",{className:"text-gray-400 text-xs",children:[e.jsx("strong",{children:"Motivo:"})," ",v]})}),e.jsx("div",{className:"bg-yellow-900/20 border border-yellow-700 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-300 text-xs",children:"‚ÑπÔ∏è Consigliamo di risolvere il problema GPS prima del check-in. Se continui, il sistema registrer√† l'assenza della posizione."})})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>{_(!1),I(null)},className:"flex-1 bg-gray-700 text-white py-3 px-4 rounded-lg hover:bg-gray-600 font-medium",children:"Annulla"}),e.jsx("button",{onClick:()=>L&&ge(L,!0),className:"flex-1 bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 font-medium",children:"Conferma Check-in Forzato"})]})]})})]})},Ls=50,sd=()=>{const{user:n}=Pt(),{showSuccess:l,showError:c,showWarning:u,showInfo:f}=us(),{currentLocation:x,getCurrentLocation:b,isLoading:v,error:S}=un(),{isOnline:g,addOfflineData:j}=Da(),{currentSession:p,elapsedTime:M,elapsedTimes:B,startSession:k,endSession:R,manualCheckOut:C,loadActiveSession:D}=hn(),[E,U]=w.useState(!1),[q,J]=w.useState(!1),[N,_]=w.useState(null),[L,I]=w.useState(null),[K,O]=w.useState(""),[W,se]=w.useState(!1),[G,$]=w.useState(!1),[F,re]=w.useState(!1),[_e,ge]=w.useState(!1),[X,pe]=w.useState(!1),[me,Q]=w.useState(!1),[V,de]=w.useState(!1),ae=Z=>Z.toString().padStart(2,"0"),le=()=>{const Z=new Date;return`${ae(Z.getHours())}:${ae(Z.getMinutes())}`},be=(Z,he)=>{const[we,ve]=(Z||"00:00").split(":").map(Number);let Qe=new Date;if(he){const nt=he.split("-").map(Number);nt.length===3&&(Qe=new Date(nt[0],nt[1]-1,nt[2],0,0,0,0))}return Qe.setHours(we,ve,0,0),Qe},ye=(Z,he,we)=>{if(!Z||!he)return 0;const ve=be(Z,we);let Qe=be(he,we);return Qe.getTime()<ve.getTime()&&(Qe=new Date(Qe.getTime()+24*60*60*1e3)),Math.round((Qe.getTime()-ve.getTime())/6e4)},Ce=(Z,he)=>`cs_pending_${Z}_${he}`,Ne=(Z,he)=>{try{localStorage.setItem(Ce(Z,he),"1")}catch{}},Ae=(Z,he)=>{try{localStorage.removeItem(Ce(Z,he))}catch{}},Ue=(Z,he)=>{if(!Z)return!1;try{return!!localStorage.getItem(Ce(Z,he))}catch{return!1}},qe=Z=>{try{for(let he=0;he<localStorage.length;he++){const we=localStorage.key(he)||"";if(we.startsWith("cs_pending_")&&we.endsWith(`_${Z}`))return!0}return!1}catch{return!1}},rt=w.useCallback(async()=>{try{const{data:Z,error:he}=await je.from("employee_meal_benefits").select("*").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0).maybeSingle();!he&&Z?(_(Z),J(!!Z.buoni_pasto_enabled)):_({buoni_pasto_enabled:!1,buoni_pasto_value:7.5,pasto_aziendale_cost:12})}catch{_({buoni_pasto_enabled:!1,buoni_pasto_value:7.5,pasto_aziendale_cost:12})}},[n==null?void 0:n.id]),at=w.useCallback(async()=>{if(n!=null&&n.id)try{const Z="e6427847-3291-424f-a092-4bec548859cf",{data:he,error:we}=await je.from("crew_assegnazionetariffa").select("tariffe_ids, tariffe_personalizzate, tariffe_overrides").eq("dipendente_id",n.id).eq("attivo",!0).maybeSingle();if(we||!he||!he.tariffe_ids||he.tariffe_ids.length===0){I(null);return}if(!he.tariffe_ids.includes(Z)){I(null);return}const{data:ve,error:Qe}=await je.from("crew_tariffe").select("id, nome_tariffa, importo").eq("id",Z).maybeSingle();if(Qe||!ve){I(null);return}let nt=parseFloat(String(ve.importo||0));he.tariffe_personalizzate&&he.tariffe_personalizzate[Z]?nt=parseFloat(String(he.tariffe_personalizzate[Z])):he.tariffe_overrides&&he.tariffe_overrides[Z]&&(nt=parseFloat(String(he.tariffe_overrides[Z]))),nt>0?I({tariffa_id:Z,importo_orario:nt}):I(null)}catch(Z){console.error("Errore caricamento benefit turno extra:",Z),I(null)}},[n==null?void 0:n.id]);w.useEffect(()=>{rt(),at()},[rt,at]),w.useEffect(()=>{let Z=!1,he=!1,we=0;const ve=async()=>{if(!(Z||he)){he=!0,we+=1;try{typeof D=="function"&&(await D(),console.debug("ExtraCheckIn: loadActiveSession executed (PWA)"),we=0)}catch(nt){if(console.error("ExtraCheckIn: loadActiveSession failed (PWA)",nt),we<5&&!Z){const pt=Math.min(3e4,500*Math.pow(2,we));setTimeout(()=>{Z||ve()},pt)}}finally{he=!1}}};ve();const Qe=()=>{document.visibilityState==="visible"&&ve()};return document.addEventListener("visibilitychange",Qe),()=>{Z=!0,document.removeEventListener("visibilitychange",Qe)}},[]),w.useEffect(()=>{if(p){const Z=p,he=!!(Z.pausa_pranzo_inizio&&!Z.pausa_pranzo_fine),we=!!Z.pausa_pranzo_fine,ve=!!(Z.pausa_cena_inizio&&!Z.pausa_cena_fine),Qe=!!Z.pausa_cena_fine,nt=Ue(Z.id,"lunch"),pt=Ue(Z.id,"dinner");ge(he||nt),pe(we),Q(ve||pt),de(Qe),Z.pausa_pranzo_inizio&&Ae(Z.id,"lunch"),Z.pausa_cena_inizio&&Ae(Z.id,"dinner")}else{const Z=qe("lunch"),he=qe("dinner");ge(Z),pe(!1),Q(he),de(!1)}},[p==null?void 0:p.id,p==null?void 0:p.type,p==null?void 0:p.pausa_pranzo_inizio,p==null?void 0:p.pausa_pranzo_fine,p==null?void 0:p.pausa_cena_inizio,p==null?void 0:p.pausa_cena_fine]);const Ke=()=>{var Z,he;try{const we=new Intl.DateTimeFormat("en-GB",{timeZone:"Europe/Rome",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date),ve=((Z=we.find(Oe=>Oe.type==="hour"))==null?void 0:Z.value)??"00",Qe=((he=we.find(Oe=>Oe.type==="minute"))==null?void 0:he.value)??"00",nt=parseInt(ve,10),pt=parseInt(Qe,10);return{hour:Number.isNaN(nt)?0:nt,minute:Number.isNaN(pt)?0:pt}}catch{const ve=new Date;return{hour:ve.getHours(),minute:ve.getMinutes()}}},Je=()=>{const{hour:Z,minute:he}=Ke(),we=Z*60+he,ve=(Qe,nt=0)=>Qe*60+nt;return we>=ve(8,0)&&we<=ve(16,0)?{allowLunch:!0,allowDinner:!1}:we>=ve(16,1)&&we<=ve(17,0)?{allowLunch:!0,allowDinner:!0}:we>=ve(17,1)&&we<=ve(23,59)?{allowLunch:!1,allowDinner:!0}:{allowLunch:!0,allowDinner:!1}},Ge=()=>{if(v)return e.jsx("p",{className:"text-xs text-yellow-300",children:"Rilevamento GPS in corso..."});if(x){const Z=x.accuracy??null,he=typeof Z=="number"?Math.abs(Math.round(Z)):null,we=typeof x.latitude=="number"?x.latitude.toFixed(5):"",ve=typeof x.longitude=="number"?x.longitude.toFixed(5):"",Qe=typeof he=="number"?he<=Ls:!1;return he===null||he>=1e5?e.jsx("p",{className:"text-xs text-red-300",children:"GPS non affidabile ‚Äî precisione troppo bassa"}):he>=1e3?e.jsxs("p",{className:"text-xs text-yellow-300",children:["Precisione GPS insufficiente (‚âà ",he,' m). Premi "Aggiorna GPS".']}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:`text-xs ${Qe?"text-green-300":"text-yellow-300"}`,children:["OK ‚Äî ",Qe||he<1e3?x.address||`${we}, ${ve}`:"Posizione disponibile"," (¬±",he,"m)",Qe?"":" ‚Äî precisione migliorabile"]}),!Qe&&e.jsxs("p",{className:"text-xs text-gray-400",children:[`Consiglio: clicca "Aggiorna GPS" finch√© l'accuratezza √® ‚â§ `,Ls," m."]})]})}return e.jsx("p",{className:"text-xs text-red-300",children:S||"GPS non disponibile"})},yt=async(Z=!1)=>{!x&&!Z&&(u("GPS Richiesto","Sto tentando di ottenere la posizione GPS per il check-in..."),await b({requiredAccuracy:Ls,maxRetries:3}));let he=x,we=!1,ve=null;if(!he&&!Z)return u("Nessun GPS","Impossibile ottenere la posizione. Puoi forzare il check-in senza GPS."),!1;!he&&Z&&(we=!0,ve=S||"GPS non disponibile - Check-in forzato");const Qe=new Date,nt=`${Qe.getHours().toString().padStart(2,"0")}:${Qe.getMinutes().toString().padStart(2,"0")}`,pt=wr(Qe),Oe={crew_id:n==null?void 0:n.id,date:pt,check_in_time:nt,status:"active",location:he?{latitude:he.latitude,longitude:he.longitude,address:he.address,accuracy:he.accuracy,timestamp:he.timestamp?he.timestamp.toISOString():new Date().toISOString()}:null,forced_checkin:we,gps_error_reason:ve,break_minutes:60,company_meal:E,meal_voucher:q,meal_cost:E?(N==null?void 0:N.pasto_aziendale_cost)||12:0,meal_notes:E?"Pasto aziendale richiesto":q?"Buono pasto richiesto":null,notes:"TURNO EXTRA",NoteTurno:K||null,benefit_tariffa_id:(L==null?void 0:L.tariffa_id)||null,benefit_importo_orario:(L==null?void 0:L.importo_orario)||null};try{if(g){console.log("Tentativo check-in con dati:",Oe);const{data:At,error:it}=await je.from("extra_shifts_checkins").insert(Oe).select().single();return it?(console.error("Errore insert extra checkin:",it),console.error("Dettagli errore:",{message:it.message,details:it.details,hint:it.hint,code:it.code}),j("checkin",Oe),u("Check-in Offline",`Problema salvataggio sul server: ${it.message}. Il check-in √® stato salvato offline e verr√† sincronizzato.`),!1):(k({id:At.id,type:"extra",warehouseId:null,checkInTime:nt,scheduledEndTime:null,shiftName:"Turno Extra",shiftStartTime:null,shiftEndTime:null,hasLunchBreak:!0,hasCompanyMeal:E,hasMealVoucher:q,breakTime:60,tableName:"extra_shifts_checkins"}),re(!0),l("Check-in Extra",`Check-in extra registrato alle ${nt}`),we&&u("Attenzione GPS","Consigliamo di risolvere il problema GPS prima del check-in. Se continui, il sistema registrer√† l'assenza della posizione.",8e3),typeof D=="function"&&await D(),!0)}else return j("checkin",Oe),re(!0),f("Check-in Offline","Check-in extra salvato offline - verr√† sincronizzato quando torni online"),!0}catch(At){return console.error("Errore durante check-in extra:",At),c("Errore","Si √® verificato un errore durante il check-in extra. Riprova."),!1}},Ye=()=>{se(!0)},Te=async()=>{se(!1),await yt(!0)},H=async(Z=!1)=>{try{f("Check-out in corso...","Sto completando il turno extra",1500);let he=x;if(!Z&&(await b({requiredAccuracy:Ls,maxRetries:2}),he=x,!he)){u("Nessun GPS","Non √® stata acquisita una posizione valida. Puoi riprovare ad aggiornare GPS o forzare il checkout.");return}if(!await C(he)){c("Errore Check-out","Si √® verificato un errore durante il check-out. Riprova.");return}try{if(p&&p.id){let ve=null;if(he&&(ve={latitude:he.latitude,longitude:he.longitude,address:he.address,accuracy:he.accuracy,timestamp:he.timestamp?he.timestamp.toISOString():new Date().toISOString()}),g){const{error:Qe}=await je.from("extra_shifts_checkins").update({NoteTurno:K||null,checkout_location:ve}).eq("id",p.id);Qe&&(console.error("Errore salvataggio checkout extra:",Qe),j("checkout_notes",{id:p.id,NoteTurno:K,checkout_location:ve}))}else j("checkout_notes",{id:p.id,NoteTurno:K,checkout_location:ve})}}catch(ve){console.error("Errore salvataggio NoteTurno/checkout_location:",ve)}R(),O(""),re(!1),ge(!1),pe(!1),Q(!1),de(!1),l("Check-out Completato",`Turno extra terminato. Tempo totale: ${M}`),typeof D=="function"&&await D()}catch(he){console.error("Errore conferma check-out extra:",he),c("Errore Sistema","Errore imprevisto durante il check-out extra")}},ne=async()=>{const Z=x==null?void 0:x.accuracy,he=!!x,we=typeof Z=="number"?Z<=Ls:!1;if(!he||!we){$(!0);return}await H(!1)},fe=async()=>{$(!1),await b({requiredAccuracy:Ls,maxRetries:3}),x?await H(!1):$(!0)},Ie=async()=>{$(!1),await H(!0),u("Attenzione GPS","Hai terminato il turno senza posizione finale. Il checkout viene registrato senza coordinate.",8e3)},Re=async(Z=!1)=>{if(!p||p.type!=="extra"){c("Errore","Nessuna sessione attiva per avviare la pausa");return}const{allowLunch:he}=Je();if(!he){u("Pausa Pranzo","La pausa pranzo non √® disponibile in questa fascia oraria");return}if(_e||X){u("Pausa","La pausa pranzo √® gi√† attiva o completata");return}let we=x;if(!we&&!Z&&(u("GPS Non Disponibile","Richiesta attivazione GPS per registrare la pausa..."),await b({requiredAccuracy:Ls,maxRetries:2}),we=x,!we)){u("Nessun GPS","Impossibile ottenere la posizione. Puoi forzare la pausa senza GPS.");return}const ve=le(),Qe={pausa_pranzo_inizio:ve,break_start_time:ve};we&&(Qe.break_start_location={latitude:we.latitude,longitude:we.longitude,address:we.address,accuracy:we.accuracy,timestamp:we.timestamp?we.timestamp.toISOString():new Date().toISOString()});const{error:nt}=await je.from("extra_shifts_checkins").update(Qe).eq("id",p.id);if(nt){console.error("Errore salvataggio inizio pausa pranzo:",nt),c("Errore","Impossibile salvare inizio pausa pranzo");return}Ne(p.id,"lunch"),ge(!0),pe(!1),l("Pausa Iniziata",`Pausa pranzo iniziata alle ${ve}`),typeof D=="function"&&await D()},ee=async(Z=!1)=>{if(!p||p.type!=="extra"){c("Errore","Nessuna sessione attiva per terminare la pausa");return}if(!_e){u("Pausa","La pausa pranzo non risulta avviata");return}let he=x;if(!he&&!Z&&(u("GPS Non Disponibile","Richiesta attivazione GPS per registrare la fine pausa..."),await b({requiredAccuracy:Ls,maxRetries:2}),he=x,!he)){u("Nessun GPS","Impossibile ottenere la posizione. Puoi forzare la fine pausa senza GPS.");return}const we=le(),ve=p,Qe=(ve==null?void 0:ve.date)||wr(new Date),nt=ye((ve==null?void 0:ve.pausa_pranzo_inizio)||(ve==null?void 0:ve.break_start_time)||"",we,Qe),pt={pausa_pranzo_fine:we,pausa_pranzo_minuti:nt,has_taken_break:!0,break_end_time:we};he&&(pt.break_end_location={latitude:he.latitude,longitude:he.longitude,address:he.address,accuracy:he.accuracy,timestamp:he.timestamp?he.timestamp.toISOString():new Date().toISOString()});const Oe=(ve==null?void 0:ve.pausa_cena_minuti)&&Number(ve.pausa_cena_minuti)||0;pt.pausa_totale_minuti=(nt||0)+Oe;const{error:At}=await je.from("extra_shifts_checkins").update(pt).eq("id",p.id);if(At){console.error("Errore salvataggio fine pausa pranzo:",At),c("Errore","Impossibile salvare fine pausa pranzo");return}Ae(p.id,"lunch"),ge(!1),pe(!0),Q(!1),de(!1),l("Pausa Terminata",`Fine pausa pranzo registrata alle ${we} (${nt} minuti)`),typeof D=="function"&&await D()},oe=async(Z=!1)=>{if(!p||p.type!=="extra"){c("Errore","Nessuna sessione attiva per avviare la pausa cena");return}const{allowDinner:he}=Je();if(!(he||X)){u("Pausa Cena","La pausa cena non √® disponibile in questa fascia oraria");return}if(me||V){u("Pausa Cena","La pausa cena √® gi√† attiva o completata");return}let ve=x;if(!ve&&!Z&&(u("GPS Non Disponibile","Richiesta attivazione GPS per registrare la pausa..."),await b({requiredAccuracy:Ls,maxRetries:2}),ve=x,!ve)){u("Nessun GPS","Impossibile ottenere la posizione. Puoi forzare la pausa senza GPS.");return}const Qe=le(),nt={pausa_cena_inizio:Qe};ve&&(nt.pausa_cena_start_location={latitude:ve.latitude,longitude:ve.longitude,address:ve.address,accuracy:ve.accuracy,timestamp:ve.timestamp?ve.timestamp.toISOString():new Date().toISOString()});const{error:pt}=await je.from("extra_shifts_checkins").update(nt).eq("id",p.id);if(pt){console.error("Errore salvataggio inizio pausa cena:",pt),c("Errore","Impossibile salvare inizio pausa cena");return}Ne(p.id,"dinner"),Q(!0),de(!1),l("Pausa Cena Iniziata",`Pausa cena iniziata alle ${Qe}`),typeof D=="function"&&await D()},De=async(Z=!1)=>{if(!p||p.type!=="extra"){c("Errore","Nessuna sessione attiva per terminare la pausa cena");return}if(!me){u("Pausa Cena","La pausa cena non risulta avviata");return}let he=x;if(!he&&!Z&&(u("GPS Non Disponibile","Richiesta attivazione GPS per registrare la fine pausa..."),await b({requiredAccuracy:Ls,maxRetries:2}),he=x,!he)){u("Nessun GPS","Impossibile ottenere la posizione. Puoi forzare la fine pausa senza GPS.");return}const we=le(),ve=p,Qe=(ve==null?void 0:ve.date)||wr(new Date),nt=ye((ve==null?void 0:ve.pausa_cena_inizio)||"",we,Qe),Oe=((ve==null?void 0:ve.pausa_pranzo_minuti)&&Number(ve.pausa_pranzo_minuti)||0)+(nt||0),At={pausa_cena_fine:we,pausa_cena_minuti:nt,pausa_totale_minuti:Oe};he&&(At.pausa_cena_end_location={latitude:he.latitude,longitude:he.longitude,address:he.address,accuracy:he.accuracy,timestamp:he.timestamp?he.timestamp.toISOString():new Date().toISOString()});const{error:it}=await je.from("extra_shifts_checkins").update(At).eq("id",p.id);if(it){console.error("Errore salvataggio fine pausa cena:",it),c("Errore","Impossibile salvare fine pausa cena");return}Ae(p.id,"dinner"),Q(!1),de(!0),l("Pausa Cena Terminata",`Fine pausa cena registrata alle ${we} (${nt} minuti)`),typeof D=="function"&&await D()},{allowLunch:Ee,allowDinner:te}=Je(),ke=te||X;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:"Turno Extra"}),e.jsx("p",{className:"text-sm text-gray-300",children:"Registra qui un turno extra non programmato. Questo flusso usa solo GPS (nessun QR). I turni extra verranno registrati senza riferimento a un magazzino."}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm text-gray-200 font-medium",children:"Stato GPS"}),Ge()]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>b({requiredAccuracy:Ls,maxRetries:3}),className:"bg-gray-700 px-3 py-1 rounded-lg text-xs",disabled:v,children:"Aggiorna GPS"}),e.jsx("button",{onClick:()=>b({requiredAccuracy:10,maxRetries:5}),className:"bg-gray-700 px-3 py-1 rounded-lg text-xs",title:"Tentativo avanzato (maggior tempo/priorit√†)",disabled:v,children:"Migliora posizione"})]})]}),e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsx("label",{className:"block text-sm text-gray-300",children:"Note turno (opzionali)"}),e.jsx("textarea",{value:K,onChange:Z=>O(Z.target.value),placeholder:"Annota eventuali note sul turno...",className:"w-full min-h-[80px] bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Queste note verranno salvate nella colonna NoteTurno al check-out."})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:E,onChange:()=>{U(!E),E||J(!1)}}),e.jsx("span",{className:"text-sm text-gray-300",children:"Pasto aziendale"})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:q,onChange:()=>{J(!q),q||U(!1)}}),e.jsx("span",{className:"text-sm text-gray-300",children:"Buono pasto"})]})]})}),e.jsxs("div",{className:"mt-4 flex space-x-2",children:[e.jsx("button",{onClick:()=>yt(!1),className:`flex-1 ${F||p?"bg-gray-600 cursor-not-allowed":"bg-green-600 hover:bg-green-700"} text-white py-2 px-3 rounded-lg`,disabled:!!(F||p),children:"‚úÖ Effettua Check-in Extra"}),e.jsx("button",{onClick:Ye,className:`flex-1 ${F||p?"bg-gray-600 cursor-not-allowed":"bg-yellow-600 hover:bg-yellow-700"} text-white py-2 px-3 rounded-lg`,disabled:!!(F||p),children:"‚ö†Ô∏è Forza Check-in (Senza GPS)"})]})]}),W&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-6 border border-red-600",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-red-900 p-3 rounded-full",children:e.jsx(wt,{className:"h-6 w-6 text-red-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:"Conferma Check-in Forzato"}),e.jsxs("p",{className:"text-red-200 text-xs mt-2",children:["Stai per effettuare un check-in ",e.jsx("strong",{children:"senza posizione GPS"}),'. Questo verr√† registrato come "Check-in Forzato" e sar√† visibile ai supervisori. Si consiglia di  ',e.jsx("strong",{children:"abilitare la posizione"})," per evitare l' eventuale annullamento del turno."]})]})]}),e.jsx("button",{onClick:()=>se(!1),className:"text-gray-400 hover:text-gray-200",children:e.jsx(jt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"mt-6 flex space-x-3",children:[e.jsx("button",{onClick:()=>se(!1),className:"flex-1 bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-600",children:"Annulla"}),e.jsx("button",{onClick:Te,className:"flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700",children:"Conferma Forza Check-in"})]}),e.jsx("div",{className:"mt-4 text-xs text-yellow-200",children:"Consigliamo di risolvere il problema GPS prima del check-in. Se continui, il sistema registrer√† l'assenza della posizione."})]})}),G&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl max-w-md w-full p-6 border border-red-600",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-red-900 p-3 rounded-full",children:e.jsx(wt,{className:"h-6 w-6 text-red-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:"Conferma Terminazione Turno"}),e.jsx("p",{className:"text-red-200 text-xs mt-2",children:"Prima di terminare il turno, abilita la posizione per registrare la posizione finale."})]})]}),e.jsx("button",{onClick:()=>$(!1),className:"text-gray-400 hover:text-gray-200",children:e.jsx(jt,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("p",{className:"text-red-200 text-xs",children:["Stai per effettuare un check-out ",e.jsx("strong",{children:"senza posizione GPS"}),". Questo verr√† registrato senza coordinate finali e potrebbe essere visibile ai supervisori."]})}),e.jsxs("div",{className:"mt-6 flex space-x-3",children:[e.jsx("button",{onClick:fe,className:"flex-1 bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-600",children:"Riprova GPS e termina turno"}),e.jsx("button",{onClick:Ie,className:"flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700",children:"Conferma senza posizione"})]})]})}),p&&p.type==="extra"&&e.jsxs("div",{className:"bg-purple-900 rounded-xl p-4 border border-purple-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-white font-medium",children:"Sessione Attiva ‚Äî Turno Extra"}),e.jsx("div",{className:"text-white font-mono",children:p&&p.id?B[p.id]||M||"00:00:00":M||"00:00:00"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-purple-200",children:"Gestione pause (Pranzo ‚Üí Cena)"}),e.jsxs("div",{className:"mt-2 flex space-x-2",children:[!_e&&!X&&e.jsx("button",{onClick:()=>Re(!1),className:`flex-1 ${Ee?"bg-orange-500 hover:bg-orange-600 text-white":"bg-gray-700 text-gray-300 opacity-60 cursor-not-allowed"} py-2 rounded-lg`,disabled:!Ee,title:Ee?"Inizia Pausa Pranzo":"Pausa pranzo non disponibile in questa fascia oraria",children:"Inizia Pausa Pranzo"}),_e&&e.jsx("button",{onClick:()=>ee(!1),className:"flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg",children:"Termina Pausa Pranzo"}),X&&e.jsx("button",{disabled:!0,className:"flex-1 bg-gray-700 text-gray-300 py-2 rounded-lg opacity-60 cursor-not-allowed",children:"Pausa Pranzo Completata"}),!me&&!V&&e.jsx("button",{onClick:()=>oe(!1),className:`flex-1 ${ke?"bg-orange-700 hover:bg-orange-800 text-white":"bg-gray-700 text-gray-300 opacity-60 cursor-not-allowed"} py-2 rounded-lg`,disabled:!ke,title:ke?"Inizia Pausa Cena":te?"Pausa cena non disponibile":"Pausa cena disponibile solo in orari consentiti o dopo la pausa pranzo",children:"Inizia Pausa Cena"}),me&&e.jsx("button",{onClick:()=>De(!1),className:"flex-1 bg-green-700 hover:bg-green-800 text-white py-2 rounded-lg",children:"Termina Pausa Cena"}),V&&e.jsx("button",{disabled:!0,className:"flex-1 bg-gray-700 text-gray-300 py-2 rounded-lg opacity-60 cursor-not-allowed",children:"Pausa Cena Completata"})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-300",children:[_e&&e.jsx("div",{children:"Pausa pranzo iniziata"}),X&&!me&&e.jsx("div",{children:"Pausa pranzo completata"}),me&&e.jsx("div",{children:"Pausa cena iniziata"}),V&&e.jsx("div",{children:"Pausa cena completata"})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-purple-200",children:"Fine turno"}),e.jsx("div",{className:"mt-2 flex space-x-2",children:e.jsx("button",{onClick:ne,className:"flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg",children:"üõë Termina Turno Extra"})})]})]})]}),!g&&e.jsx("div",{className:"bg-orange-900 rounded-xl p-3 border border-orange-700",children:e.jsx("p",{className:"text-orange-100 text-sm",children:"Sei offline: i check-in verranno salvati localmente e sincronizzati quando torni online."})})]})},rd=()=>{const[n,l]=w.useState("warehouse");return e.jsx("div",{className:"min-h-screen bg-gray-900 text-white",children:e.jsxs("div",{className:"p-4 pb-20 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Check-in Mobile"}),e.jsx("p",{className:"text-gray-300",children:"Scegli il tipo di check-in"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-gray-300",children:new Date().toLocaleDateString("it-IT")}),e.jsx("div",{className:"text-xs text-gray-400",children:new Date().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-2 border border-gray-700",children:e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("button",{onClick:()=>l("warehouse"),className:`flex items-center justify-center space-x-2 py-3 px-4 rounded-lg transition-all ${n==="warehouse"?"bg-purple-600 text-white shadow-lg":"text-gray-400 hover:text-white hover:bg-gray-700"}`,children:[e.jsx(ba,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Turni"})]}),e.jsxs("button",{onClick:()=>l("event"),className:`flex items-center justify-center space-x-2 py-3 px-4 rounded-lg transition-all ${n==="event"?"bg-blue-600 text-white shadow-lg":"text-gray-400 hover:text-white hover:bg-gray-700"}`,children:[e.jsx(Ut,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Eventi"})]}),e.jsxs("button",{onClick:()=>l("extra"),className:`flex items-center justify-center space-x-2 py-3 px-4 rounded-lg transition-all ${n==="extra"?"bg-green-600 text-white shadow-lg":"text-gray-400 hover:text-white hover:bg-gray-700"}`,children:[e.jsx(ut,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Turni extra"})]})]})}),e.jsx("div",{className:"space-y-6",children:n==="warehouse"?e.jsx(ed,{}):n==="event"?e.jsx(td,{}):e.jsx(sd,{})}),e.jsx(aa,{})]})})},ad=()=>{const{user:n}=Pt(),[l,c]=w.useState({permission:"default",isSupported:!1,isServiceWorkerReady:!1,subscription:null}),[u,f]=w.useState(!1),[x,b]=w.useState(null);w.useEffect(()=>{(async()=>{const D="Notification"in window&&"serviceWorker"in navigator&&"PushManager"in window,E=Notification.permission;let U=!1,q=null;if(D&&"serviceWorker"in navigator)try{const J=await navigator.serviceWorker.ready;U=!!J,J&&J.pushManager&&(q=await J.pushManager.getSubscription())}catch(J){console.error("Errore nel controllo service worker:",J)}c({permission:E,isSupported:D,isServiceWorkerReady:U,subscription:q}),console.log("üîî Stato notifiche iniziale:",{isSupported:D,permission:E,isServiceWorkerReady:U,hasSubscription:!!q})})()},[]);const v=w.useCallback(async()=>{if(!l.isSupported)return b("Notifiche non supportate su questo dispositivo"),!1;if(l.permission==="granted")return!0;f(!0),b(null);try{const C=await Notification.requestPermission();return c(D=>({...D,permission:C})),C==="granted"?await S():(b("Permessi notifiche negati"),!1)}catch(C){return console.error("Errore richiesta permessi:",C),b("Errore nella richiesta permessi notifiche"),!1}finally{f(!1)}},[l.isSupported,l.permission]),S=w.useCallback(async()=>{if(!l.isServiceWorkerReady)return b("Service Worker non pronto"),!1;try{const E=await(await navigator.serviceWorker.ready).pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:nd("BEl62iUYgUivxIkv69yViEuiBIa6iMjyr3PJQYjdKFOqKxsr8CxaVkMpBGFGlqOlZHgAhyNcHGpWWBJB1bFfLUo")});c(U=>({...U,subscription:E}));try{await g(E)}catch(U){console.warn("Impossibile salvare la subscription sul server:",U)}return console.log("‚úÖ Sottoscrizione push creata:",E),!0}catch(C){return console.error("Errore sottoscrizione push:",C),b("Errore nella sottoscrizione alle notifiche"),!1}},[l.isServiceWorkerReady,n==null?void 0:n.id]),g=async C=>{try{const D=C&&typeof C.toJSON=="function"?C.toJSON():C,E=D==null?void 0:D.endpoint,U=(D==null?void 0:D.keys)||(D&&D.getKey?{p256dh:D.getKey("p256dh")?btoa(String.fromCharCode(...new Uint8Array(D.getKey("p256dh")))):null,auth:D.getKey("auth")?btoa(String.fromCharCode(...new Uint8Array(D.getKey("auth")))):null}:null);if(!E)return console.warn("savePushSubscription: endpoint mancante nella subscription"),!1;const q={user_id:(n==null?void 0:n.id)||null,endpoint:E,keys:U,subscription:D,platform:navigator.userAgent.includes("Android")?"android":"web",user_agent:navigator.userAgent,is_pwa:window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches||!1,status:"active",last_seen:new Date().toISOString(),created_at:new Date().toISOString()},{data:J,error:N}=await je.from("push_subscriptions").select("id").match({endpoint:E,user_id:n==null?void 0:n.id}).limit(1);if(N&&console.warn("Attenzione: errore durante la ricerca subscription esistente:",N),J&&J.length>0){const _=J[0].id,{error:L}=await je.from("push_subscriptions").update({subscription:q.subscription,keys:q.keys,user_agent:q.user_agent,is_pwa:q.is_pwa,status:"active",last_seen:q.last_seen}).eq("id",_);return L?(console.error("Errore aggiornamento subscription su DB:",L),!1):(console.log("üíæ Subscription aggiornata su DB (id):",_),!0)}else{const{data:_,error:L}=await je.from("push_subscriptions").insert([q]);return L?(console.error("Errore inserimento subscription su DB:",L),!1):(console.log("üíæ Subscription inserita su DB:",_),!0)}}catch(D){return console.error("Errore savePushSubscription:",D),!1}},j=w.useCallback(C=>{if(l.permission!=="granted"){console.warn("Permessi notifiche non concessi");return}const D={body:C.body,icon:C.icon||"/pwa-192x192.png",badge:C.badge||"/pwa-192x192.png",tag:C.tag||"crew-notification",requireInteraction:C.requireInteraction||!1,silent:C.silent||!1,vibrate:C.vibrate||[200,100,200],data:{url:C.url||"/",timestamp:Date.now()}};if("serviceWorker"in navigator){navigator.serviceWorker.ready.then(E=>{if(E&&typeof E.showNotification=="function")return E.showNotification(C.title,D);throw new Error("registration.showNotification non disponibile")}).catch(E=>{console.warn("showNotification via SW fallita, uso Notification API come fallback",E);try{const U=new Notification(C.title,D);U.onclick=()=>{window.focus(),C.url&&(window.location.href=C.url),U.close()},setTimeout(()=>U.close(),1e4)}catch(U){console.error("Errore fallback Notification API:",U)}});return}try{const E=new Notification(C.title,D);E.onclick=()=>{window.focus(),C.url&&(window.location.href=C.url),E.close()},setTimeout(()=>E.close(),1e4)}catch(E){console.error("Errore nel mostrare la notifica localmente:",E)}},[l.permission]),p=w.useCallback(()=>{if(!(n!=null&&n.id))return;console.log("üëÇ Sottoscrizione notifiche database per user:",n.id);const C=je.channel("user-notifications-"+n.id).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifiche",filter:`id_utente=eq.${n.id}`},D=>{console.log("üì¨ Nuova notifica ricevuta:",D);const E=D.new;j({title:E.titolo||"Notifica",body:E.messaggio||"",tag:`notifica-${E.id}`,url:E.url_azione||"/",requireInteraction:E.tipo==="urgente",vibrate:[200,100,200]})}).subscribe();return()=>{je.removeChannel(C)}},[n==null?void 0:n.id,j]),M=w.useCallback(()=>{j({title:"üß™ Test Notifica",body:"Questa √® una notifica di test",tag:"test-notification",requireInteraction:!1,vibrate:[200,100,200]})},[j]),B=w.useCallback((C,D)=>{j({title:"‚è∞ Promemoria Turno",body:`Il tuo turno "${C}" inizia alle ${D}`,tag:"shift-reminder",url:"/checkin",requireInteraction:!0,vibrate:[300,100,300]})},[j]),k=w.useCallback(C=>{j({title:"üìç Check-in Richiesto",body:`Non dimenticare di fare check-in presso ${C}`,tag:"checkin-reminder",url:"/checkin",requireInteraction:!0,vibrate:[200,100,200]})},[j]),R=w.useCallback(C=>{j({title:"‚è±Ô∏è Straordinari Rilevati",body:`Hai lavorato ${C.toFixed(1)} ore di straordinario oggi`,tag:"overtime-alert",url:"/timesheet",requireInteraction:!1,vibrate:[100,50,100]})},[j]);return w.useEffect(()=>{let C;return n!=null&&n.id&&l.permission==="granted"&&(C=p()),()=>{C&&C()}},[n==null?void 0:n.id,l.permission,p]),{permission:l.permission,isSupported:l.isSupported,isServiceWorkerReady:l.isServiceWorkerReady,subscription:l.subscription,isLoading:u,error:x,requestPermission:v,subscribeToPush:S,sendLocalNotification:j,sendTestNotification:M,sendShiftReminder:B,sendCheckInReminder:k,sendOvertimeAlert:R,subscribeToNotifications:p}};function nd(n){const l="=".repeat((4-n.length%4)%4),c=(n+l).replace(/-/g,"+").replace(/_/g,"/"),u=window.atob(c),f=new Uint8Array(u.length);for(let x=0;x<u.length;++x)f[x]=u.charCodeAt(x);return f}function id(){const{user:n}=Pt(),[l,c]=w.useState([]),[u,f]=w.useState(!0),x=S=>S.titolo_corso||S.corso_titolo||S.corso_nome||S.corso&&(S.corso.titolo||S.corso.nome)||null,b=(S=[])=>S.map(g=>({...g,courseTitle:x(g)||"Corso da confermare"})),v=w.useCallback(async S=>{if(!S){c([]),f(!1);return}f(!0);try{const{data:g,error:j}=await je.from("crew_assegnazionecorsi").select("*, corso:corso_id(id, titolo, nome)").eq("persona_id",S).eq("stato_invito","invitato").order("data_invito",{ascending:!1});j?(console.error("Errore caricamento crew_assegnazionecorsi (pending):",j),c([])):c(b(g||[]))}catch(g){console.error("Eccezione loadPending course assignments:",g),c([])}finally{f(!1)}},[]);return w.useEffect(()=>{if(!(n!=null&&n.id)){c([]),f(!1);return}v(n.id);const S=je.channel(`course-notifs-${n.id}`).on("postgres_changes",{event:"*",schema:"public",table:"crew_assegnazionecorsi",filter:`persona_id=eq.${n.id}`},g=>{try{const j=g.event;if(j==="INSERT"){const p=g.new;if(p.stato_invito==="invitato"){const M=b([p])[0];c(B=>B.find(k=>String(k.id)===String(M.id))?B:[M,...B])}}else if(j==="UPDATE"){const p=g.new,M=b([p])[0];c(B=>{const k=B.find(R=>String(R.id)===String(M.id));return p.stato_invito==="invitato"?k?B.map(R=>String(R.id)===String(M.id)?M:R):[M,...B]:B.filter(R=>String(R.id)!==String(M.id))})}else if(j==="DELETE"){const p=g.old;c(M=>M.filter(B=>String(B.id)!==String(p.id)))}}catch(j){console.warn("Errore gestione realtime crew_assegnazionecorsi payload",j),v(n.id)}}).subscribe();return()=>{je.removeChannel(S)}},[n==null?void 0:n.id,v]),{pendingCourses:l,count:l.length,loading:u,reload:()=>v(n==null?void 0:n.id)}}function od({className:n,onClick:l}){const{pendingCourses:c,count:u,loading:f}=id();return f||u===0?null:e.jsx("button",{onClick:()=>l&&l(),className:`absolute -top-1 -right-1 bg-transparent ${n||""}`,"aria-label":`${u} corso${u>1?"i":""} da confermare`,type:"button",children:e.jsx("span",{className:"inline-flex items-center justify-center bg-red-500 text-white text-[10px] font-semibold rounded-full h-5 w-5",children:u>9?"9+":u})})}const ld=()=>{var ge;const{user:n,logout:l}=Pt(),{permission:c}=ad(),{showSuccess:u,showError:f,showWarning:x}=us(),[b,v]=w.useState(null),[S,g]=w.useState([]),[j,p]=w.useState(!0),[M,B]=w.useState(!0),[k,R]=w.useState(!0),[C,D]=w.useState(!0),[E,U]=w.useState(!1),[q,J]=w.useState(!1);w.useEffect(()=>{n!=null&&n.id&&(N(),_())},[n==null?void 0:n.id]);const N=async()=>{try{p(!0);const{data:X,error:pe}=await je.from("registration_requests").select(`
          *,
          regaziendasoftware!parent_company_id(
            id,
            ragione_sociale,
            email,
            telefono,
            indirizzo
          )
        `).eq("auth_user_id",n==null?void 0:n.id).single();if(pe){console.error("Errore nel caricamento profilo:",pe);return}v(X)}catch(X){console.error("Errore nel caricamento profilo utente:",X)}finally{p(!1)}},_=async()=>{try{B(!0),console.log("üéÅ Caricamento benefit dipendente per user:",n==null?void 0:n.id);const{data:X,error:pe}=await je.from("crew_assegnazionetariffa").select("tariffe_ids, tariffe_personalizzate").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0);if(pe){console.error("‚ùå Errore caricamento assegnazioni tariffe:",pe),g([]);return}console.log("üìã Assegnazioni tariffe trovate:",(X==null?void 0:X.length)||0);const me=[];let Q={};if(X==null||X.forEach(V=>{V.tariffe_ids&&V.tariffe_ids.length>0&&me.push(...V.tariffe_ids),V.tariffe_personalizzate&&(Q={...Q,...V.tariffe_personalizzate})}),console.log("üîç ID tariffe da caricare:",me),console.log("üí∞ Tariffe personalizzate:",Q),me.length>0){const V=[...new Set(me)],{data:de,error:ae}=await je.from("crew_tariffe").select("*").in("id",V).eq("attivo",!0).order("categoria",{ascending:!0});if(ae){console.error("‚ùå Errore caricamento dettagli tariffe:",ae),g([]);return}console.log("‚úÖ Benefit caricati:",(de==null?void 0:de.length)||0);const le=(de||[]).map(be=>{const ye=Q[be.id],Ce=ye!==void 0?ye:be.importo;return console.log(`üíµ Benefit "${be.nome_tariffa}": personalizzato=${ye}, standard=${be.importo}, finale=${Ce}`),{id:be.id,nome_tariffa:be.nome_tariffa,categoria:be.categoria,tipo_calcolo:be.tipo_calcolo,importo:Ce,descrizione:be.descrizione,attivo:be.attivo}});g(le)}else console.log("‚ö†Ô∏è Nessuna tariffa assegnata al dipendente"),g([]);await K()}catch(X){console.error("‚ùå Errore generale caricamento benefit:",X),g([])}finally{B(!1)}},[L,I]=w.useState(null),K=async()=>{try{console.log("üçΩÔ∏è Caricamento benefit pasti per dipendente:",n==null?void 0:n.id);const{data:X,error:pe}=await je.from("employee_meal_benefits").select("*").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0).maybeSingle();if(pe){console.error("‚ùå Errore caricamento benefit pasti:",pe),I(null);return}X?(console.log("‚úÖ Benefit pasti caricati:",X),I(X)):(console.log("‚ö†Ô∏è Nessun benefit pasti configurato per questo dipendente"),I(null))}catch(X){console.error("‚ùå Errore generale caricamento benefit pasti:",X),I(null)}},O=X=>({indennita_trasferta:"Indennit√† Trasferta",bonus_responsabile:"Bonus Responsabile",bonus_autista:"Bonus Autista",straordinario_festivo:"Straordinario Festivo",straordinario_notturno:"Straordinario Notturno",straordinario_trasferta:"Straordinario Trasferta",rimborso_chilometrico:"Rimborso Chilometrico",stipendio_base:"Stipendio Base",bonus_guida_automezzo:"Bonus Guida Automezzo",indennita_reperibilita:"Indennit√† Reperibilit√†",altro:"Altro"})[X]||X,W=(L==null?void 0:L.buoni_pasto_enabled)||!1;L!=null&&L.pasto_aziendale_enabled;const se=[{id:"notifications",label:"Notifiche Push",description:"Ricevi notifiche per turni e aggiornamenti",value:k,onChange:R},{id:"autoSync",label:"Sincronizzazione Automatica",description:"Sincronizza dati quando connesso",value:C,onChange:D},{id:"offlineMode",label:"Modalit√† Offline",description:"Salva dati localmente quando offline",value:E,onChange:U}],G=async()=>{try{x("Logout in corso..."),await l(),u("Logout effettuato con successo!"),window.location.href="/"}catch(X){console.error("Errore durante il logout:",X),u("Sessione terminata localmente"),setTimeout(()=>{window.location.href="/"},1e3)}};if(j)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento profilo..."})]})});if(!b)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("p",{className:"text-lg",children:"Errore nel caricamento del profilo"}),e.jsx("button",{onClick:()=>N(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg",children:"Riprova"})]})});const F=(b.full_name||b.company_name||"").split(" "),re=F[0]||"Nome",_e=F.slice(1).join(" ")||"Cognome";return e.jsx("div",{className:"min-h-screen bg-gray-900 text-white",children:e.jsxs("div",{className:"p-4 pb-20 space-y-6",children:[e.jsx("div",{className:"bg-gradient-to-br from-blue-600 to-cyan-600 rounded-2xl p-6 shadow-xl",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center",children:e.jsx(ea,{className:"h-8 w-8 text-white"})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold text-white",children:[re," ",_e]}),e.jsx("p",{className:"text-blue-100",children:((ge=b.regaziendasoftware)==null?void 0:ge.ragione_sociale)||"Azienda"}),e.jsx("p",{className:"text-sm text-blue-200",children:"Dipendente"})]})]})}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4 flex items-center space-x-2",children:[e.jsx(Ss,{className:"h-5 w-5 text-purple-400"}),e.jsx("span",{children:"I Miei Benefit Contrattuali"})]}),M?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-300",children:"Caricamento benefit..."})]}):S.length===0?e.jsxs("div",{className:"text-center py-6 text-gray-400",children:[e.jsx(Ss,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsx("p",{children:"Nessun benefit assegnato"}),e.jsx("p",{className:"text-sm mt-1",children:"Contatta l'azienda per informazioni sui benefit"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-600 to-red-600 rounded-lg p-4 mb-4",children:[e.jsxs("h4",{className:"font-bold text-white mb-2 flex items-center space-x-2",children:[e.jsx(Bs,{className:"h-5 w-5"}),e.jsx("span",{children:"Benefit Pasti"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:`p-3 rounded-lg ${W?"bg-green-900 border border-green-700":"bg-red-900 border border-red-700"}`,children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[W?e.jsx(ft,{className:"h-4 w-4 text-green-400"}):e.jsx(jt,{className:"h-4 w-4 text-red-400"}),e.jsx("span",{className:"text-white text-sm font-medium",children:"Buoni Pasto"})]}),e.jsx("p",{className:"text-xs text-gray-300 mt-1",children:W?`‚Ç¨${(L==null?void 0:L.buoni_pasto_value)||"7.50"} per turno`:"Non incluso"})]}),e.jsxs("div",{className:"p-3 rounded-lg bg-blue-900 border border-blue-700",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ft,{className:"h-4 w-4 text-blue-400"}),e.jsx("span",{className:"text-white text-sm font-medium",children:"Pasto Aziendale"})]}),e.jsxs("p",{className:"text-xs text-gray-300 mt-1",children:["Costo: ‚Ç¨",(L==null?void 0:L.pasto_aziendale_cost)||"12.00"]})]})]}),L&&(L.diaria_eventi_enabled||L.diaria_trasferta_enabled)&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-orange-500",children:[e.jsx("h5",{className:"text-white font-medium mb-2",children:"Diarie"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[L.diaria_eventi_enabled&&e.jsxs("div",{className:"p-2 rounded bg-green-900 border border-green-700",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ft,{className:"h-3 w-3 text-green-400"}),e.jsx("span",{className:"text-white text-xs font-medium",children:"Diaria Eventi"})]}),e.jsxs("p",{className:"text-xs text-green-300",children:["‚Ç¨",L.diaria_eventi_value||"25.00"]})]}),L.diaria_trasferta_enabled&&e.jsxs("div",{className:"p-2 rounded bg-green-900 border border-green-700",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ft,{className:"h-3 w-3 text-green-400"}),e.jsx("span",{className:"text-white text-xs font-medium",children:"Diaria Trasferta"})]}),e.jsxs("p",{className:"text-xs text-green-300",children:["‚Ç¨",L.diaria_trasferta_value||"35.00"]})]})]})]})]}),e.jsx("div",{className:"space-y-2",children:S.map(X=>e.jsx("div",{className:"bg-gray-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center space-x-3",children:e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-white",children:X.nome_tariffa}),e.jsx("p",{className:"text-xs text-gray-400",children:O(X.categoria)}),X.descrizione&&e.jsx("p",{className:"text-xs text-gray-300 mt-1",children:X.descrizione})]})}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-lg font-bold text-green-400",children:X.tipo_calcolo==="percentuale"?`${X.importo}%`:`‚Ç¨${X.importo}`}),e.jsx("div",{className:"text-xs text-gray-400",children:X.tipo_calcolo==="orario"?"/ora":X.tipo_calcolo==="giornaliero"?"/giorno":X.tipo_calcolo==="fisso"?"fisso":X.tipo_calcolo==="percentuale"?"percentuale":""})]})]})},X.id))}),e.jsx("div",{className:"bg-blue-900 border border-blue-700 rounded-lg p-3 mt-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ss,{className:"h-4 w-4 text-blue-400"}),e.jsxs("span",{className:"text-blue-200 text-sm",children:[e.jsx("strong",{children:"Totale benefit attivi:"})," ",S.length]})]})})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Informazioni Contatto"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(wa,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.email}),e.jsx("p",{className:"text-xs text-gray-400",children:"Email aziendale"})]})]}),b.phone&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Za,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.phone}),e.jsx("p",{className:"text-xs text-gray-400",children:"Telefono personale"})]})]})]})]}),b.regaziendasoftware&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"La Mia Azienda"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(zt,{className:"h-5 w-5 text-blue-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.regaziendasoftware.ragione_sociale}),e.jsx("p",{className:"text-xs text-gray-400",children:"Ragione sociale"})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(wa,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.regaziendasoftware.email}),e.jsx("p",{className:"text-xs text-gray-400",children:"Email aziendale"})]})]}),b.regaziendasoftware.telefono&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Za,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.regaziendasoftware.telefono}),e.jsx("p",{className:"text-xs text-gray-400",children:"Telefono aziendale"})]})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Impostazioni App"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white font-medium",children:"Notifiche Push"}),e.jsx("p",{className:"text-sm text-gray-400",children:c==="granted"?"Abilitate":c==="denied"?"Bloccate":"Non configurate"})]}),e.jsx("button",{onClick:()=>J(!q),className:"bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm",children:"Gestisci"})]}),c==="denied"&&e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-red-400 text-sm font-medium mb-2",children:"Notifiche Bloccate dal Browser"}),e.jsx("p",{className:"text-red-300 text-xs mb-3",children:"Le notifiche sono state bloccate. Per ricevere aggiornamenti importanti su turni, note spese e straordinari, devi sbloccarle manualmente."}),e.jsxs("div",{className:"bg-red-950/50 rounded p-2 text-xs text-red-200 space-y-1",children:[e.jsx("p",{className:"font-medium",children:"Come sbloccare:"}),e.jsx("p",{children:"1. Tocca l'icona del lucchetto nella barra del browser"}),e.jsx("p",{children:'2. Trova "Notifiche" nelle impostazioni'}),e.jsx("p",{children:'3. Cambia da "Bloccato" a "Consenti"'}),e.jsx("p",{children:"4. Ricarica la pagina"})]})]}),c==="granted"&&e.jsxs("div",{className:"bg-green-900/20 border border-green-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-green-400 text-sm font-medium mb-2",children:"Notifiche Attive"}),e.jsx("p",{className:"text-green-300 text-xs",children:"Riceverai notifiche per:"}),e.jsxs("ul",{className:"text-green-200 text-xs mt-2 space-y-1 ml-4",children:[e.jsx("li",{children:"‚Ä¢ Nuovi turni assegnati"}),e.jsx("li",{children:"‚Ä¢ Modifiche ai turni"}),e.jsx("li",{children:"‚Ä¢ Approvazione note spese"}),e.jsx("li",{children:"‚Ä¢ Richieste straordinari"}),e.jsx("li",{children:"‚Ä¢ Messaggi importanti"})]})]}),c==="default"&&e.jsxs("div",{className:"bg-yellow-900/20 border border-yellow-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-yellow-400 text-sm font-medium mb-2",children:"Configura le Notifiche"}),e.jsx("p",{className:"text-yellow-300 text-xs mb-2",children:'Clicca su "Gestisci" per attivare le notifiche e rimanere aggiornato su turni e approvazioni.'})]})]}),se.map(X=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white font-medium",children:X.label}),e.jsx("p",{className:"text-sm text-gray-400",children:X.description})]}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:X.value,onChange:pe=>X.onChange(pe.target.checked),className:"sr-only peer"}),e.jsx("div",{className:"w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"})]})]},X.id))]})]}),q&&e.jsx(od,{}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Informazioni App"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Versione"}),e.jsx("span",{className:"text-white font-medium",children:"1.0.8"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Ultimo Aggiornamento"}),e.jsx("span",{className:"text-white font-medium",children:"Gennaio 2025"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Modalit√†"}),e.jsx("span",{className:"text-blue-400 font-medium",children:"Mobile"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Connessione"}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ui,{className:"h-4 w-4 text-green-400"}),e.jsx("span",{className:"text-green-400 font-medium",children:"Online"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Tipo Utente"}),e.jsx("span",{className:"text-purple-400 font-medium",children:"Dipendente"})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Informazioni Lavorative"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"ID Dipendente"}),e.jsx("span",{className:"text-white font-medium",children:b.id.slice(0,8)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Data Registrazione"}),e.jsx("span",{className:"text-white font-medium",children:new Date(b.created_at).toLocaleDateString("it-IT")})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Status"}),e.jsx("span",{className:`text-sm px-2 py-1 rounded-full ${b.status==="approved"?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"}`,children:b.status==="approved"?"Approvato":"In Attesa"})]})]})]}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("button",{onClick:G,className:"w-full bg-red-600 text-white py-4 px-4 rounded-xl hover:bg-red-700 font-bold text-lg shadow-lg flex items-center justify-center space-x-3",children:[e.jsx(Ea,{className:"h-6 w-6"}),e.jsx("span",{children:"ESCI DALL'APP"})]})}),e.jsx(aa,{})]})})},cd=({report:n,onRectify:l})=>{const{assignment:c,timesheet:u,benefitBreakdown:f}=n,x=D=>{if(!D)return"Non specificato";if(/^\d{2}:\d{2}$/.test(D))return D;if(/^\d{2}:\d{2}:\d{2}$/.test(D))return D.substring(0,5);try{const E=new Date(D);if(!isNaN(E.getTime()))return E.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})}catch(E){console.error("Errore parsing timestamp:",E)}return D},b=D=>{if(!D)return"00:00";const E=Math.round(D*60),U=Math.floor(E/60),q=E%60;return`${U.toString().padStart(2,"0")}:${q.toString().padStart(2,"0")}`},v=D=>{switch(D){case"evento":return"Diaria Eventi";case"trasferta":return"Diaria Trasferta";default:return null}},S=(u==null?void 0:u.rectified_start_time)||(u==null?void 0:u.start_time),g=(u==null?void 0:u.rectified_end_time)||(u==null?void 0:u.end_time),j=u&&S&&g,p=f&&f.length>0?f.reduce((D,E)=>E.applied?D+E.amount:D,0):0,M=(u==null?void 0:u.total_benefits)||p,B=M>0||f&&f.some(D=>D.applied),k=c.bonus_previsti&&c.bonus_previsti>0,R=c.benefits_evento_nomi&&c.benefits_evento_nomi.length>0,C=!j&&!B&&(k||R||c.bonus_trasferta||c.bonus_diaria);return e.jsxs("div",{className:"bg-gray-700 rounded-xl p-4 border border-gray-600",children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx("h4",{className:"font-bold text-white",children:c.nome_evento}),(u==null?void 0:u.is_rectified)&&e.jsx("span",{className:"bg-orange-600 text-white text-xs px-2 py-0.5 rounded font-semibold",children:"Rettificato"})]}),e.jsx("p",{className:"text-sm text-blue-400",children:c.nome_azienda}),e.jsxs("p",{className:"text-xs text-gray-400",children:[new Date(c.giorno_inizio_evento).toLocaleDateString("it-IT"),c.giorno_inizio_evento!==c.giorno_fine_evento&&e.jsxs(e.Fragment,{children:[" - ",new Date(c.giorno_fine_evento).toLocaleDateString("it-IT")]})]})]})}),c.evento_orario_convocazione&&e.jsx("div",{className:"bg-green-900 bg-opacity-30 border-2 border-green-600 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(ct,{className:"h-5 w-5 text-green-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-green-200",children:"Orario Convocazione"}),e.jsx("div",{className:"text-xl font-bold text-green-400",children:x(c.evento_orario_convocazione)})]})]})}),(u==null?void 0:u.convocation_start_time)&&(u==null?void 0:u.convocation_end_time)&&e.jsxs("div",{className:"bg-cyan-900 bg-opacity-30 border border-cyan-600 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ct,{className:"h-4 w-4 text-cyan-400"}),e.jsx("h5",{className:"text-sm font-medium text-cyan-400",children:"Orari Convocazione"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Inizio:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(u.convocation_start_time)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Fine:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(u.convocation_end_time)})]})]})]}),j?e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 mb-3 border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ct,{className:"h-4 w-4 text-blue-400"}),e.jsx("h5",{className:"text-sm font-medium text-blue-400",children:"Orari Effettivi"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs mb-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Check-in:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(S)}),(u==null?void 0:u.is_rectified)&&(u==null?void 0:u.original_start_time)&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",x(u.original_start_time)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Check-out:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(g)}),(u==null?void 0:u.is_rectified)&&(u==null?void 0:u.original_end_time)&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",x(u.original_end_time)]}),(u==null?void 0:u.is_rectified)&&!u.original_end_time&&(u==null?void 0:u.rectified_end_time)&&e.jsxs("div",{className:"text-xs text-green-400 mt-1 flex items-center space-x-1",children:[e.jsx(ft,{className:"h-3 w-3"}),e.jsx("span",{children:"Aggiunto via rettifica"})]})]})]}),(u==null?void 0:u.total_hours)&&e.jsx("div",{className:"border-t border-gray-700 pt-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-gray-400",children:"Ore Totali:"}),e.jsx("span",{className:"text-sm font-bold text-blue-400",children:b(u.total_hours)})]})})]}):e.jsx("div",{className:"bg-gray-800 rounded-lg p-3 mb-3 border-l-4 border-gray-600",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-xs text-gray-400",children:u?"Turno in corso - Check-out non effettuato":"Nessun check-in registrato"})]})}),B&&e.jsxs("div",{className:"bg-green-900 bg-opacity-20 border border-green-700 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(Ss,{className:"h-4 w-4 text-green-400"}),e.jsx("h5",{className:"text-sm font-medium text-green-400",children:j?"Benefit Ricevuti":"Benefit Assegnati"})]}),e.jsxs("div",{className:"space-y-2",children:[(u==null?void 0:u.meal_voucher)&&(u==null?void 0:u.meal_voucher_amount)&&u.meal_voucher_amount>0&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(As,{className:"h-4 w-4 text-yellow-400"}),e.jsx("span",{className:"text-sm text-gray-200",children:"Buono Pasto"})]}),e.jsxs("span",{className:"text-sm font-bold text-yellow-400",children:["‚Ç¨",u.meal_voucher_amount.toFixed(2)]})]}),(u==null?void 0:u.company_meal)&&(u==null?void 0:u.company_meal_cost)&&u.company_meal_cost>0&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(As,{className:"h-4 w-4 text-orange-400"}),e.jsx("span",{className:"text-sm text-gray-200",children:"Pasto Aziendale"})]}),e.jsxs("span",{className:"text-sm font-bold text-orange-400",children:["‚Ç¨",u.company_meal_cost.toFixed(2)]})]}),(u==null?void 0:u.diaria_type)&&u.diaria_type!=="nessuna"&&(u==null?void 0:u.diaria_amount)&&u.diaria_amount>0&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ts,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-gray-200",children:v(u.diaria_type)})]}),e.jsxs("span",{className:"text-sm font-bold text-purple-400",children:["‚Ç¨",u.diaria_amount.toFixed(2)]})]}),f&&f.length>0&&f.map((D,E)=>{if(!D.applied)return null;const U=_=>{switch(_==null?void 0:_.toLowerCase()){case"trasferta":return Ts;case"benefit":return Ss;case"rimborso":return Sa;default:return kr}},q=_=>{switch(_==null?void 0:_.toLowerCase()){case"trasferta":return"text-purple-400";case"benefit":return"text-green-400";case"rimborso":return"text-cyan-400";default:return"text-yellow-400"}},J=U(D.category),N=q(D.category);return e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(J,{className:`h-4 w-4 ${N}`}),e.jsx("span",{className:"text-sm text-gray-200",children:D.name})]}),e.jsxs("span",{className:`text-sm font-bold ${N}`,children:["‚Ç¨",D.amount.toFixed(2)]})]},E)}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-900 bg-opacity-30 border border-blue-700 rounded px-3 py-2 mt-3",children:[e.jsx("span",{className:"text-sm font-bold text-white",children:"Totale Benefit:"}),e.jsxs("span",{className:"text-lg font-bold text-blue-400",children:["‚Ç¨",M.toFixed(2)]})]})]})]}),C&&e.jsxs("div",{className:"bg-blue-900 bg-opacity-20 border border-blue-600 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(kr,{className:"h-4 w-4 text-blue-400"}),e.jsx("h5",{className:"text-sm font-medium text-blue-400",children:"Bonus/Benefit Previsti"})]}),e.jsxs("div",{className:"space-y-1 text-xs",children:[c.tariffa_evento_assegnata&&e.jsxs("div",{className:"flex items-center justify-between text-gray-200",children:[e.jsx("span",{children:"Tariffa Base:"}),e.jsxs("span",{className:"font-semibold",children:["‚Ç¨",c.tariffa_evento_assegnata.toFixed(2)]})]}),k&&e.jsxs("div",{className:"flex items-center justify-between text-yellow-300",children:[e.jsx("span",{children:"Bonus Fisso:"}),e.jsxs("span",{className:"font-semibold",children:["‚Ç¨",c.bonus_previsti.toFixed(2)]})]}),c.bonus_trasferta&&e.jsx("div",{className:"flex items-center text-purple-300",children:e.jsx("span",{children:"Bonus Trasferta Previsto"})}),c.bonus_diaria&&e.jsx("div",{className:"flex items-center text-purple-300",children:e.jsx("span",{children:"Diaria Prevista"})}),R&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-blue-800",children:[e.jsx("div",{className:"text-blue-200 mb-1",children:"Altri benefit previsti:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:c.benefits_evento_nomi.map((D,E)=>e.jsx("span",{className:"bg-blue-800 text-blue-200 px-2 py-0.5 rounded text-xs",children:D},E))})]}),e.jsx("div",{className:"mt-2 pt-2 border-t border-blue-800 text-blue-200 text-center",children:"üí° Gli importi effettivi verranno calcolati al check-out"})]})]}),(u==null?void 0:u.is_rectified)&&u.rectification_notes&&e.jsx("div",{className:"bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-orange-200 mb-1",children:"Nota di Rettifica:"}),e.jsx("div",{className:"text-xs text-orange-300",children:u.rectification_notes})]})]})}),(u==null?void 0:u.notedipendente)&&e.jsx("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Ks,{className:"h-4 w-4 text-blue-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-1",children:"Note Dipendente:"}),e.jsx("div",{className:"text-xs text-blue-300 whitespace-pre-wrap",children:u.notedipendente})]})]})}),e.jsxs("div",{className:"space-y-2 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm text-white",children:c.evento_localita})]}),c.evento_trasferta&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ts,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-purple-300",children:"Evento con Trasferta"})]})]}),e.jsxs("button",{onClick:l,className:"w-full flex items-center justify-center space-x-2 px-4 py-2 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700 transition-colors border border-orange-500",children:[e.jsx(hi,{className:"h-4 w-4"}),e.jsx("span",{children:"RETTIFICA ORARIO"})]}),!j&&u&&e.jsx("div",{className:"mt-2 text-xs text-center text-gray-400",children:"I benefit verranno calcolati al check-out"})]})},dd=({event:n,existingTimesheet:l,onClose:c,onSuccess:u})=>{const{user:f}=Pt(),[x,b]=w.useState((l==null?void 0:l.start_time)||""),[v,S]=w.useState((l==null?void 0:l.end_time)||""),[g,j]=w.useState(""),[p,M]=w.useState(!1),[B,k]=w.useState(null),C=((E,U)=>{if(!E||!U)return 0;const[q,J]=E.split(":").map(Number),[N,_]=U.split(":").map(Number),L=q*60+J,K=N*60+_-L;return Math.max(0,K/60)})(x,v),D=async E=>{if(E.preventDefault(),!x||!v){k("Inserisci sia orario di check-in che di check-out");return}if(C<=0){k("L'orario di check-out deve essere successivo al check-in");return}if(!g||g.trim().length===0){k("La motivazione della rettifica √® obbligatoria");return}M(!0),k(null);try{if(l){const U={original_start_time:l.start_time,original_end_time:l.end_time,rectified_start_time:x,rectified_end_time:v,start_time:x,end_time:v,total_hours:C,is_rectified:!0,rectified_by:f==null?void 0:f.id,rectified_at:new Date().toISOString(),rectification_notes:g.trim()},{error:q}=await je.from("timesheet_entries").update(U).eq("id",l.id);if(q)throw q}else{const U={crew_id:f==null?void 0:f.id,event_id:n.evento_id,date:n.giorno_inizio_evento,start_time:x,end_time:v,rectified_start_time:x,rectified_end_time:v,total_hours:C,status:"submitted",tracking_type:"hours",is_rectified:!0,rectified_by:f==null?void 0:f.id,rectified_at:new Date().toISOString(),rectification_notes:g.trim(),retention_percentage:0,gross_amount:0,net_amount:0},{error:q}=await je.from("timesheet_entries").insert([U]);if(q)throw q}u(),c()}catch(U){console.error("Errore salvataggio rettifica:",U),k(U.message||"Errore durante il salvataggio")}finally{M(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl w-full max-w-md border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Rettifica Orario"}),e.jsx("p",{className:"text-sm text-gray-400",children:n.nome_evento})]}),e.jsx("button",{onClick:c,className:"text-gray-400 hover:text-white",children:e.jsx(jt,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:D,className:"p-4 space-y-4",children:[e.jsxs("div",{className:"bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3 flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-5 w-5 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsx("div",{className:"text-sm text-orange-200",children:"Questa operazione registra un orario rettificato manualmente. Verr√† segnalato come rettifica nel sistema."})]}),B&&e.jsx("div",{className:"bg-red-900 bg-opacity-30 border border-red-700 rounded-lg p-3 text-sm text-red-200",children:B}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Orario Check-in"}),e.jsxs("div",{className:"relative",children:[e.jsx(ct,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"time",value:x,onChange:E=>b(E.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Orario Check-out"}),e.jsxs("div",{className:"relative",children:[e.jsx(ct,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"time",value:v,onChange:E=>S(E.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]})]}),x&&v&&e.jsx("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-3",children:e.jsxs("div",{className:"text-sm text-blue-200",children:[e.jsx("span",{className:"font-medium",children:"Ore totali:"})," ",C.toFixed(2),"h"]})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Motivazione Rettifica ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("textarea",{value:g,onChange:E=>j(E.target.value),rows:3,className:"w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",placeholder:"Spiega il motivo della rettifica (es: dimenticato check-in, errore nell'orario, ecc...)",required:!0})]}),e.jsxs("div",{className:"flex space-x-3 pt-4",children:[e.jsx("button",{type:"button",onClick:c,className:"flex-1 py-2 px-4 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors",children:"Annulla"}),e.jsx("button",{type:"submit",disabled:p||!x||!v||!g.trim(),className:"flex-1 py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:p?"Salvataggio...":l?"Aggiorna":"Salva"})]})]})]})})},ud=({selectedMonth:n,selectedYear:l})=>{const{user:c}=Pt(),[u,f]=w.useState([]),[x,b]=w.useState([]),[v,S]=w.useState(""),[g,j]=w.useState("all"),[p,M]=w.useState([]),[B,k]=w.useState(!0),[R,C]=w.useState(null),[D,E]=w.useState(!1),[U,q]=w.useState(null),J=I=>String(I).padStart(2,"0"),N=I=>`${I.getFullYear()}-${J(I.getMonth()+1)}-${J(I.getDate())}`,_=I=>{if(!I)return new Date(NaN);const K=I.split("-").map(O=>parseInt(O,10));return K.length!==3?new Date(I):new Date(K[0],K[1]-1,K[2])};w.useEffect(()=>{c!=null&&c.id&&L()},[c==null?void 0:c.id,n,l]),w.useEffect(()=>{let I=[...u];v&&(I=I.filter(K=>K.assignment.giorno_inizio_evento<=v&&K.assignment.giorno_fine_evento>=v)),g!=="all"&&(I=I.filter(K=>K.assignment.nome_evento===g)),b(I)},[u,v,g]);const L=async()=>{try{k(!0),C(null);const I=new Date(l,n,1),K=new Date(l,n+1,0),O=N(I),W=N(K),{data:se,error:G}=await je.from("crew_event_assegnazione").select("*").eq("dipendente_freelance_id",c==null?void 0:c.id).gte("giorno_inizio_evento",O).lte("giorno_inizio_evento",W).order("giorno_inizio_evento",{ascending:!0});if(G)throw G;const{data:$,error:F}=await je.from("crew_assegnazionetariffa").select("tariffe_ids, tariffe_personalizzate").eq("dipendente_id",c==null?void 0:c.id).eq("attivo",!0);if(F)throw F;const re={},_e={};if($&&$.length>0){const V=[];if($.forEach(de=>{de.tariffe_ids&&de.tariffe_ids.length>0&&V.push(...de.tariffe_ids),de.tariffe_personalizzate&&Object.assign(_e,de.tariffe_personalizzate)}),V.length>0){const{data:de,error:ae}=await je.from("crew_tariffe").select("*").in("id",V).eq("attivo",!0);if(ae)throw ae;de==null||de.forEach(le=>{const be=_e[le.id];re[le.id]={id:le.id,nome_tariffa:le.nome_tariffa,categoria:le.categoria,tipo_calcolo:le.tipo_calcolo,importo:be!==void 0?be:le.importo,attivo:le.attivo}})}}const{data:ge,error:X}=await je.from("timesheet_entries").select(`
          id,
          crew_id,
          event_id,
          date,
          start_time,
          end_time,
          total_hours,
          status,
          meal_voucher,
          meal_voucher_amount,
          company_meal,
          company_meal_cost,
          diaria_type,
          diaria_amount,
          other_benefits_amount,
          total_benefits,
          benefits_breakdown,
          is_rectified,
          rectification_notes,
          rectified_by,
          rectified_at,
          original_start_time,
          original_end_time,
          rectified_start_time,
          rectified_end_time,
          convocation_start_time,
          convocation_end_time,
          notedipendente
        `).eq("crew_id",c==null?void 0:c.id).gte("date",O).lte("date",W);if(X)throw X;const pe={};ge==null||ge.forEach(V=>{pe[V.event_id]=V});const me=[];for(const V of se||[]){const de=pe[V.evento_id],ae=[],le=[];let be=0;if(de&&de.benefits_breakdown&&de.benefits_breakdown.length>0)de.benefits_breakdown.forEach(Ne=>{ae.push({id:Ne.id,nome_tariffa:Ne.nome_tariffa,categoria:"benefit",importo:Ne.importo,applied:!0}),be+=Ne.importo,le.push({name:Ne.nome_tariffa,amount:Ne.importo,category:"benefit",applied:!0})});else{if(V.benefits_storicizzati&&V.benefits_storicizzati.length>0?V.benefits_storicizzati.forEach(Ne=>{ae.push({id:Ne.id,nome_tariffa:Ne.nome_tariffa,categoria:"benefit",importo:Ne.importo,applied:!0}),be+=Ne.importo,le.push({name:Ne.nome_tariffa,amount:Ne.importo,category:"benefit",applied:!0})}):V.benefits_evento_ids&&V.benefits_evento_ids.length>0&&V.benefits_evento_ids.forEach(Ne=>{const Ae=re[Ne];Ae?(ae.push({id:Ae.id,nome_tariffa:Ae.nome_tariffa,categoria:Ae.categoria,importo:Ae.importo,applied:!0}),be+=Ae.importo,le.push({name:Ae.nome_tariffa,amount:Ae.importo,category:Ae.categoria,applied:!0})):le.push({name:`Benefit ID: ${Ne}`,amount:0,category:"non_disponibile",applied:!1,reason:"Benefit non presente nel contratto del dipendente"})}),V.bonus_trasferta&&V.evento_trasferta){const Ne=Object.values(re).find(Ae=>Ae.categoria==="indennita_trasferta"||Ae.nome_tariffa.toLowerCase().includes("trasferta"));Ne&&!ae.find(Ae=>Ae.id===Ne.id)&&(ae.push({id:Ne.id,nome_tariffa:Ne.nome_tariffa,categoria:Ne.categoria,importo:Ne.importo,applied:!0}),be+=Ne.importo)}V.bonus_previsti&&V.bonus_previsti>0&&(be+=V.bonus_previsti,le.push({name:"Bonus Evento Fisso",amount:V.bonus_previsti,category:"bonus_evento",applied:!0}))}const Ce=(V.tariffa_evento_assegnata||0)+be;me.push({assignment:V,timesheet:de?{id:de.id,start_time:de.start_time,end_time:de.end_time,status:de.status,total_hours:de.total_hours,meal_voucher:de.meal_voucher,meal_voucher_amount:de.meal_voucher_amount,company_meal:de.company_meal,company_meal_cost:de.company_meal_cost,diaria_type:de.diaria_type,diaria_amount:de.diaria_amount,other_benefits_amount:de.other_benefits_amount,total_benefits:de.total_benefits,is_rectified:de.is_rectified,rectification_notes:de.rectification_notes,original_start_time:de.original_start_time,original_end_time:de.original_end_time,rectified_start_time:de.rectified_start_time,rectified_end_time:de.rectified_end_time,convocation_start_time:de.convocation_start_time,convocation_end_time:de.convocation_end_time}:void 0,applicableBenefits:ae,totalBenefitsAmount:be,totalEventAmount:Ce,benefitBreakdown:le})}f(me);const Q=new Set;me.forEach(V=>{V.assignment.nome_evento&&Q.add(V.assignment.nome_evento)}),M(Array.from(Q).sort())}catch(I){console.error("Errore caricamento eventi:",I),C(I instanceof Error?I.message:"Errore sconosciuto")}finally{k(!1)}};return B?e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"Caricamento eventi..."})]})}):R?e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"text-center py-8 text-red-400",children:[e.jsx(Zt,{className:"h-12 w-12 mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Errore nel caricamento"}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:R}),e.jsx("button",{onClick:()=>L(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Riprova"})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Dettaglio Eventi (",x.length,u.length!==x.length?` di ${u.length}`:"",")"]}),e.jsxs("div",{className:"mb-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Giorno Specifico:"}),e.jsx("input",{type:"date",value:v,onChange:I=>S(I.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",placeholder:"Seleziona un giorno..."}),v&&e.jsx("button",{onClick:()=>S(""),className:"mt-2 text-xs text-blue-400 hover:text-blue-300",children:"Rimuovi filtro data"})]}),p.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Nome Evento:"}),e.jsxs("select",{value:g,onChange:I=>j(I.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",children:[e.jsx("option",{value:"all",children:"Tutti gli Eventi"}),p.map((I,K)=>e.jsx("option",{value:I,children:I},K))]})]}),(v||g!=="all")&&e.jsxs("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-2 text-xs text-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ut,{className:"h-3 w-3"}),e.jsx("span",{className:"font-semibold",children:"Filtri attivi:"})]}),e.jsxs("div",{className:"mt-1 space-y-1",children:[v&&(()=>{const I=_(v);return e.jsxs("div",{children:["Data: ",isNaN(I.getTime())?v:I.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"})]})})(),g!=="all"&&e.jsxs("div",{children:["Evento: ",g]})]})]})]}),x.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(ut,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsxs("p",{children:["Nessun evento ",v||g!=="all"?"trovato con i filtri selezionati":"nel periodo selezionato"]}),e.jsx("p",{className:"text-sm mt-1",children:v||g!=="all"?"Prova a modificare i filtri":"Seleziona un mese diverso o attendi nuove assegnazioni"})]}):e.jsx("div",{className:"space-y-4",children:x.map(I=>e.jsx(cd,{report:{...I,benefitBreakdown:I.benefitBreakdown},onRectify:()=>{q(I),E(!0)}},I.assignment.id))})]}),D&&U&&e.jsx(dd,{event:{id:U.assignment.id,evento_id:U.assignment.evento_id,nome_evento:U.assignment.nome_evento,giorno_inizio_evento:U.assignment.giorno_inizio_evento,giorno_fine_evento:U.assignment.giorno_fine_evento},existingTimesheet:U.timesheet,onClose:()=>{E(!1),q(null)},onSuccess:()=>{L()}})]})},Ui=({shift:n,onUpdate:l,tableName:c})=>{const{user:u}=Pt(),{showSuccess:f,showError:x}=us(),[b,v]=w.useState(!1),[S,g]=w.useState(""),[j,p]=w.useState(""),[M,B]=w.useState(""),[k,R]=w.useState(""),[C,D]=w.useState(""),[E,U]=w.useState(""),[q,J]=w.useState(""),[N,_]=w.useState(!1),[L,I]=w.useState(null),[K,O]=w.useState(!1),[W,se]=w.useState(!1),[G,$]=w.useState(!0),[F,re]=w.useState(null),_e=(de,ae,le,be,ye,Ce)=>{if(!de||!ae)return 0;const[Ne,Ae]=de.split(":").map(Number),[Ue,qe]=ae.split(":").map(Number),rt=Ne*60+Ae;let Ke=(Ue*60+qe-rt)/60;if(le&&be){const[Je,Ge]=le.split(":").map(Number),[yt,Ye]=be.split(":").map(Number),Te=Je*60+Ge,ne=(yt*60+Ye-Te)/60;ne>0&&(Ke-=ne)}if(ye&&Ce){const[Je,Ge]=ye.split(":").map(Number),[yt,Ye]=Ce.split(":").map(Number),Te=Je*60+Ge,ne=(yt*60+Ye-Te)/60;ne>0&&(Ke-=ne)}return Ke},ge=de=>{const ae=Math.round(de*60),le=Math.floor(ae/60),be=ae%60;return`${le.toString().padStart(2,"0")}:${be.toString().padStart(2,"0")}`},X=c?c==="extra_shifts_checkins":!n.turno_id||n.turno_id===""||n.nome_turno==="TURNO EXTRA";w.useEffect(()=>{const de=async()=>{try{if(X){const{data:ae,error:le}=await je.from("extra_shifts_checkins").select("*").eq("id",n.id).maybeSingle();if(le)throw le;if(ae){re(ae);const be=ae.rectified_check_in_time||ae.check_in_time,ye=ae.rectified_check_out_time||ae.check_out_time,Ce=ae.rectified_break_start||ae.break_start_time,Ne=ae.rectified_break_end||ae.break_end_time,Ae=ae.rectified_pausa_cena_inizio||ae.pausa_cena_inizio,Ue=ae.rectified_pausa_cena_fine||ae.pausa_cena_fine;g(or(be)),p(or(ye)),B(Ce||""),R(Ne||""),D(Ae||""),U(Ue||""),J(ae.rectification_note||"")}}else{const{data:ae,error:le}=await je.from("warehouse_checkins_enriched").select("*").eq("id",n.id).maybeSingle();if(le)throw le;if(ae){re(ae);const be=ae.rectified_check_in_time||ae.check_in_time,ye=ae.rectified_check_out_time||ae.check_out_time,Ce=ae.rectified_pausa_pranzo_inizio||ae.pausa_pranzo_inizio||ae.break_start_time||ae.break_start,Ne=ae.rectified_pausa_pranzo_fine||ae.pausa_pranzo_fine||ae.break_end_time||ae.break_end,Ae=ae.rectified_pausa_cena_inizio||ae.pausa_cena_inizio,Ue=ae.rectified_pausa_cena_fine||ae.pausa_cena_fine;g(or(be)),p(or(ye)),B(Ce||""),R(Ne||""),D(Ae||""),U(Ue||""),J(ae.rectification_note||"")}}}catch(ae){console.error("Errore caricamento dati turno:",ae)}};b&&n.id&&de()},[b,n.id,X]),w.useEffect(()=>{$(!0)},[]),w.useEffect(()=>{if(S&&j){const de=_e(S,j,M,k,C,E),ae=n.ore_previste||8;de>ae?O(!0):(O(!1),se(!1))}},[S,j,M,k,C,E,n.ore_previste]);const pe=async()=>{if(console.log("üîç Inizio salvataggio rettifica..."),console.log("üìù Dati da salvare:",{editedCheckIn:S,editedCheckOut:j,breakStart:M,breakEnd:k,breakCenaStart:C,breakCenaEnd:E,rectificationNote:q,requestOvertime:W,shiftId:n.id}),!S||!j){I("Inserisci orari validi");return}if(!q||q.trim().length<10){I("La nota di rettifica √® obbligatoria (minimo 10 caratteri)");return}if(M&&!k||!M&&k){I("Specifica sia l'inizio che la fine della pausa pranzo");return}if(M&&k){const[ae,le]=M.split(":").map(Number),[be,ye]=k.split(":").map(Number);if(be*60+ye<=ae*60+le){I("La fine della pausa pranzo deve essere dopo l'inizio");return}}if(C&&!E||!C&&E){I("Specifica sia l'inizio che la fine della pausa cena");return}if(C&&E){const[ae,le]=C.split(":").map(Number),[be,ye]=E.split(":").map(Number);if(be*60+ye<=ae*60+le){I("La fine della pausa cena deve essere dopo l'inizio");return}}const de=_e(S,j,M,k,C,E);if(de<=0){I("Le pause non possono coprire tutto il tempo di lavoro. Le ore effettive devono essere maggiori di zero.");return}_(!0),I(null);try{const ae=new Date().toISOString(),le={rectified_check_in_time:S,rectified_check_out_time:j,rectified_break_start:M||null,rectified_break_end:k||null,rectified_pausa_pranzo:!!(M&&k),rectified_pausa_pranzo_inizio:M||null,rectified_pausa_pranzo_fine:k||null,rectified_pausa_cena_inizio:C||null,rectified_pausa_cena_fine:E||null,rectified_total_hours:de,rectification_note:q.trim(),rectified_by:u==null?void 0:u.id,rectified_at:ae,overtime_requested:W,total_hours:de,status:"completed"};(!n.check_out_turno||n.status!=="completed")&&(le.check_out_time=j);const be=X?"extra_shifts_checkins":"warehouse_checkins";console.log("üíæ Invio update a Supabase:",{tableName:be,shiftId:n.id,updateData:le});const{error:ye}=await je.from(be).update(le).eq("id",n.id);if(console.log("‚úÖ Risposta Supabase:",{error:ye}),ye)throw console.error("‚ùå Errore Supabase:",ye),ye;f("Rettifica salvata con successo!"),v(!1),l()}catch(ae){console.error("‚ùå Errore aggiornamento turno:",ae);const le=ae.message||"Errore nel salvataggio delle modifiche";I(le),x(le)}finally{_(!1)}},me=()=>{var de,ae;g(((de=n.check_in_turno)==null?void 0:de.substring(0,5))||""),p(((ae=n.check_out_turno)==null?void 0:ae.substring(0,5))||""),B(""),R(""),D(""),U(""),J(""),se(!1),O(!1),I(null),v(!1)};if(!b)return e.jsxs("button",{onClick:()=>v(!0),className:"w-full mt-2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center space-x-2",children:[e.jsx(cr,{className:"h-4 w-4"}),e.jsx("span",{children:"Rettifica Orari Turno"})]});const V=(()=>{const de=F&&F.notes||n.notes||"",ae=F&&F.warehouse_name||n.warehouse_name||n.nome_turno||"",le=F&&F.noteturno||n.noteturno||"";if(typeof de=="string"&&de.toLowerCase().includes("turno extra"))return{label:"TURNO EXTRA",isExtra:!0,subtitle:""};const be=[];return ae&&be.push(ae),le&&be.push(le),{label:"TURNO MAGAZZINO",isExtra:!1,subtitle:be.join(" ‚Ä¢ ")}})();return e.jsxs("div",{className:"mt-3 bg-gray-800 border border-gray-600 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-sm font-semibold text-white mb-3 flex items-center space-x-2",children:[e.jsx(cr,{className:"h-4 w-4"}),e.jsx("span",{children:"Rettifica Orari"})]}),e.jsx("div",{className:"mb-3",children:V.isExtra?e.jsx("div",{className:"inline-flex items-center px-3 py-1 rounded-full bg-indigo-700 text-white text-xs font-semibold",children:"TURNO EXTRA"}):e.jsxs("div",{className:"inline-flex flex-col px-3 py-2 rounded-lg bg-gray-700 text-white text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Turno di Magazzino"}),V.subtitle?e.jsx("span",{className:"text-xs text-gray-300 mt-1",children:V.subtitle}):null]})}),(!n.original_check_out||n.status!=="completed")&&e.jsx("div",{className:"mb-4 bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(wt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-orange-200 mb-1",children:"Turno Ancora Aperto"}),e.jsx("div",{className:"text-xs text-orange-300",children:"Il checkout non √® stato effettuato. Compilando questa rettifica il turno verr√† automaticamente chiuso."})]})]})}),n.original_check_in&&e.jsxs("div",{className:"mb-4 bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-2",children:"Dati Originali Registrati:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-300",children:"Check-in:"}),e.jsx("div",{className:"text-white font-semibold",children:or(n.original_check_in)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-300",children:"Check-out:"}),e.jsx("div",{className:"text-white font-semibold",children:n.original_check_out?e.jsxs(e.Fragment,{children:[or(n.original_check_out),n.auto_checkout&&e.jsx("span",{className:"ml-1 text-xs bg-purple-800 text-purple-200 px-1 py-0.5 rounded",children:"AUTO"})]}):e.jsx("span",{className:"text-orange-400 italic",children:"Non effettuato"})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-blue-300",children:"Pausa Pranzo:"}),e.jsx("span",{className:"ml-2 text-white font-semibold",children:n.original_pausa_pranzo?"S√¨ ‚úì":"No ‚úó"})]})]})]}),L&&e.jsxs("div",{className:"mb-3 bg-red-900 border border-red-700 rounded-lg p-2 flex items-start space-x-2",children:[e.jsx(wt,{className:"h-4 w-4 text-red-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"text-xs text-red-200",children:L})]}),e.jsxs("div",{className:"space-y-3 mb-3",children:[e.jsxs("div",{className:"bg-green-900 bg-opacity-20 border border-green-700 rounded-lg p-3 mb-3",children:[e.jsx("div",{className:"text-xs font-semibold text-green-200 mb-3",children:"Nuovi Orari Rettificati:"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-1",children:["Orario Entrata ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"time",value:S,onChange:de=>g(de.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-1",children:["Orario Uscita ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"time",value:j,onChange:de=>p(de.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"})]})]})]}),e.jsxs("div",{className:"border-t border-gray-600 pt-3 mt-3",children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-2 flex items-center space-x-2",children:[e.jsx(As,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{children:"Pausa Pranzo (opzionale):"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Inizio Pausa"}),e.jsx("input",{type:"time",value:M,onChange:de=>B(de.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Fine Pausa"}),e.jsx("input",{type:"time",value:k,onChange:de=>R(de.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"‚ÑπÔ∏è Lascia vuoto se non hai effettuato pausa pranzo"})]}),e.jsxs("div",{className:"border-t border-gray-600 pt-3 mt-3",children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-2 flex items-center space-x-2",children:[e.jsx(As,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{children:"Pausa Cena (opzionale):"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Inizio Pausa"}),e.jsx("input",{type:"time",value:C,onChange:de=>D(de.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Fine Pausa"}),e.jsx("input",{type:"time",value:E,onChange:de=>U(de.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"‚ÑπÔ∏è Lascia vuoto se non hai effettuato pausa cena"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-1",children:["Nota Rettifica ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("textarea",{value:q,onChange:de=>J(de.target.value),placeholder:"Specifica il motivo della rettifica (obbligatorio, min 10 caratteri)...",rows:3,className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[q.length,"/10 caratteri minimi"]})]}),S&&j&&e.jsxs("div",{className:"space-y-2",children:[K&&G&&e.jsx("div",{className:"bg-orange-900 border border-orange-700 rounded p-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(wt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-xs font-semibold text-orange-200 mb-2",children:["Le ore superano il turno previsto (",n.ore_previste||8,"h)"]}),e.jsxs("label",{className:"flex items-center space-x-2 text-xs text-orange-300",children:[e.jsx("input",{type:"checkbox",checked:W,onChange:de=>se(de.target.checked),className:"rounded border-orange-600 bg-orange-800 text-orange-500 focus:ring-orange-500"}),e.jsx("span",{children:"Richiedi straordinari per le ore eccedenti"})]})]})]})}),e.jsxs("div",{className:"bg-blue-900 border border-blue-700 rounded p-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs mb-1",children:[e.jsx("span",{className:"text-blue-200",children:"Nuove ore totali:"}),e.jsx("span",{className:"font-bold text-blue-100 text-lg",children:ge(_e(S,j,M,k,C,E))})]}),M&&k||C&&E?e.jsxs("div",{className:"text-xs text-blue-300 mt-1 space-y-0.5",children:[M&&k&&e.jsxs("div",{children:["Pausa pranzo: ",M," - ",k]}),C&&E&&e.jsxs("div",{children:["Pausa cena: ",C," - ",E]})]}):null]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("button",{type:"button",onClick:()=>se(!W),disabled:!G,className:`w-full py-3 rounded-lg font-semibold transition-all ${G?W?"bg-orange-600 text-white hover:bg-orange-700":"bg-gray-700 text-gray-300 hover:bg-gray-600 border border-gray-600":"bg-gray-800 text-gray-500 border border-gray-700 cursor-not-allowed"}`,children:G?W?e.jsxs("span",{className:"flex items-center justify-center space-x-2",children:[e.jsx(wt,{className:"h-4 w-4"}),e.jsx("span",{children:"Straordinari Richiesti"})]}):e.jsx("span",{children:"Richiedi Straordinari"}):e.jsx("span",{children:"Straordinari Non Previsti nel Contratto"})}),!G&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 text-center",children:"Il tuo contratto non prevede il pagamento degli straordinari"})]})]}),e.jsxs("div",{className:"flex space-x-2 mt-4",children:[e.jsxs("button",{onClick:me,disabled:N,className:"flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-500 disabled:opacity-50 flex items-center justify-center space-x-1",children:[e.jsx(jt,{className:"h-4 w-4"}),e.jsx("span",{children:"Annulla"})]}),e.jsx("button",{onClick:pe,disabled:N,className:"flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 flex items-center justify-center space-x-1",children:N?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Salvataggio..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Zr,{className:"h-4 w-4"}),e.jsx("span",{children:"Salva"})]})})]})]})},hd=({selectedMonth:n,selectedYear:l})=>{var N;const{user:c}=Pt(),[u,f]=w.useState([]),[x,b]=w.useState([]),[v,S]=w.useState([]),[g,j]=w.useState(""),[p,M]=w.useState("all"),[B,k]=w.useState(!0),[R,C]=w.useState(null),D=_=>String(_).padStart(2,"0"),E=_=>`${_.getFullYear()}-${D(_.getMonth()+1)}-${D(_.getDate())}`,U=_=>{if(!_)return new Date(NaN);const L=_.split("-").map(I=>parseInt(I,10));return L.length!==3?new Date(_):new Date(L[0],L[1]-1,L[2])};w.useEffect(()=>{c!=null&&c.id&&q()},[c==null?void 0:c.id,n,l]),w.useEffect(()=>{let _=[...u];g&&(_=_.filter(L=>L.giorno_turno===g)),p!=="all"&&(_=_.filter(L=>L.warehouse_id===p)),S(_)},[u,g,p]);const q=async()=>{try{k(!0),C(null);const _=new Date(l,n,1),L=new Date(l,n+1,0),I=E(_),K=E(L),{data:O,error:W}=await je.from("warehouse_checkins").select("*").eq("crew_id",c==null?void 0:c.id).gte("date",I).lte("date",K).order("date",{ascending:!1});if(W)throw W;const se=(O||[]).map(F=>{const re=F.rectified_check_in_time||F.check_in_time,_e=F.rectified_check_out_time||F.check_out_time,ge=F.effective_ore_lavorate_minuti?F.effective_ore_lavorate_minuti/60:F.rectified_total_hours||parseFloat(F.total_hours)||0,X=F.rectified_pausa_pranzo!==null?F.rectified_pausa_pranzo:F.pausa_pranzo||!1;return{id:F.id,turno_id:F.turno_id||"",warehouse_id:F.warehouse_id||"",warehouse_name:"Turno Magazzino",notes:F.notes||"",noteturno:F.NoteTurno||"",giorno_turno:F.date,nome_turno:"Turno Magazzino",check_in_turno:re,check_out_turno:_e,conteggio_ore:ge,buoni_pasto_assegnato:F.meal_voucher||!1,pasto_aziendale_usufruito:F.company_meal||!1,ore_straordinario:parseFloat(F.overtime_hours)||0,ore_previste:8,pausa_pranzo:X,pausa_cena:!!(F.pausa_cena_inizio&&F.pausa_cena_fine),pausa_pranzo_inizio:F.pausa_pranzo_inizio||F.break_start_time,pausa_pranzo_fine:F.pausa_pranzo_fine||F.break_end_time,pausa_pranzo_minuti:F.pausa_pranzo_minuti||F.break_minutes,pausa_cena_inizio:F.pausa_cena_inizio,pausa_cena_fine:F.pausa_cena_fine,pausa_cena_minuti:F.pausa_cena_minuti,pausa_totale_minuti:F.pausa_totale_minuti||F.break_minutes,status:F.status,is_rectified:!!F.rectified_at,rectification_note:F.rectification_note||null,original_check_in:F.check_in_time,original_check_out:F.check_out_time,original_pausa_pranzo:F.pausa_pranzo||!1,rectified_check_in:F.rectified_check_in_time,rectified_check_out:F.rectified_check_out_time,rectified_pausa_pranzo:F.rectified_pausa_pranzo,rectified_pausa_pranzo_inizio:F.rectified_pausa_pranzo_inizio,rectified_pausa_pranzo_fine:F.rectified_pausa_pranzo_fine,rectified_pausa_cena_inizio:F.rectified_pausa_cena_inizio,rectified_pausa_cena_fine:F.rectified_pausa_cena_fine,effective_pausa_pranzo_inizio:F.effective_pausa_pranzo_inizio,effective_pausa_pranzo_fine:F.effective_pausa_pranzo_fine,effective_pausa_pranzo_minuti:F.effective_pausa_pranzo_minuti,effective_pausa_cena_inizio:F.effective_pausa_cena_inizio,effective_pausa_cena_fine:F.effective_pausa_cena_fine,effective_pausa_cena_minuti:F.effective_pausa_cena_minuti,effective_pausa_totale_minuti:F.effective_pausa_totale_minuti,effective_ore_lavorate_minuti:F.effective_ore_lavorate_minuti,auto_checkout:F.auto_checkout||!1}});f(se);const{data:G,error:$}=await je.from("warehouse_checkins_enriched").select("warehouse_id, warehouse_name").eq("crew_id",c==null?void 0:c.id).not("warehouse_id","is",null);if(!$&&G){const F=new Map;G.forEach((_e,ge)=>{const X=_e.warehouse_id,pe=_e.warehouse_name||`Magazzino ${ge+1}`;X&&!F.has(X)&&F.set(X,pe)});const re=Array.from(F.entries()).map(([_e,ge])=>({id:_e,name:ge}));b(re)}}catch(_){console.error("Errore caricamento turni magazzino:",_),C(_ instanceof Error?_.message:"Errore sconosciuto")}finally{k(!1)}},J=_=>_&&or(_)||"Non specificato";return B?e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"Caricamento turni magazzino..."})]})}):R?e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"text-center py-8 text-red-400",children:[e.jsx(Zt,{className:"h-12 w-12 mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Errore nel caricamento"}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:R}),e.jsx("button",{onClick:()=>q(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Riprova"})]})}):e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Turni Magazzino (",v.length,u.length!==v.length?` di ${u.length}`:"",")"]}),e.jsxs("div",{className:"mb-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Giorno Specifico:"}),e.jsx("input",{type:"date",value:g,onChange:_=>j(_.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",placeholder:"Seleziona un giorno..."}),g&&e.jsx("button",{onClick:()=>j(""),className:"mt-2 text-xs text-blue-400 hover:text-blue-300",children:"Rimuovi filtro data"})]}),x.length>1&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Magazzino:"}),e.jsxs("select",{value:p,onChange:_=>M(_.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",children:[e.jsx("option",{value:"all",children:"Tutti i Magazzini"}),x.map(_=>e.jsx("option",{value:_.id,children:_.name},_.id))]})]}),(g||p!=="all")&&e.jsxs("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-2 text-xs text-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ya,{className:"h-3 w-3"}),e.jsx("span",{className:"font-semibold",children:"Filtri attivi:"})]}),e.jsxs("div",{className:"mt-1 space-y-1",children:[g&&e.jsxs("div",{children:["Data: ",U(g).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"})]}),p!=="all"&&e.jsxs("div",{children:["Magazzino: ",(N=x.find(_=>_.id===p))==null?void 0:N.name]})]})]})]}),v.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(zt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsxs("p",{children:["Nessun turno magazzino ",g||p!=="all"?"trovato con i filtri selezionati":"nel periodo selezionato"]}),e.jsx("p",{className:"text-sm mt-1",children:g||p!=="all"?"Prova a modificare i filtri":"I turni appariranno qui"})]}):e.jsx("div",{className:"space-y-3",children:v.map(_=>{const L=_.check_out_turno||_.rectified_check_out,I=_.status!=="completed"||!L;return e.jsxs("div",{className:"bg-gray-700 rounded-lg p-4 border border-gray-600",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h4",{className:"font-bold text-white",children:_.nome_turno||"Turno Magazzino"}),_.is_rectified&&e.jsx("span",{className:"bg-orange-600 text-white text-xs px-2 py-0.5 rounded font-semibold",children:"Rettificato"})]}),e.jsx("p",{className:"text-sm text-gray-400",children:U(_.giorno_turno).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})})]}),e.jsx("div",{className:"text-right",children:I?e.jsx("div",{className:"text-sm text-orange-400 font-semibold",children:"In corso"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-lg font-bold text-blue-400",children:[_.effective_ore_lavorate_minuti?Math.floor(_.effective_ore_lavorate_minuti/60):_.conteggio_ore,"h"]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Ore Lavorate"})]})})]}),e.jsx("div",{className:"bg-gray-800 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[e.jsx(ct,{className:"h-3 w-3 text-green-400"}),e.jsx("span",{className:"text-gray-400 font-medium",children:"Check-in:"})]}),e.jsx("div",{className:"text-white font-semibold",children:J(_.check_in_turno)||"--:--"}),_.is_rectified&&_.original_check_in&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",J(_.original_check_in)]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[e.jsx(ct,{className:"h-3 w-3 text-red-400"}),e.jsx("span",{className:"text-gray-400 font-medium",children:"Check-out:"})]}),I?e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-orange-400 font-semibold",children:"In corso"}),_.is_rectified&&_.rectified_check_out&&e.jsxs("div",{className:"text-green-400 text-xs mt-1 flex items-center space-x-1",children:[e.jsx(ft,{className:"h-3 w-3"}),e.jsxs("span",{children:["Chiuso via rettifica: ",J(_.rectified_check_out)]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-white font-semibold flex items-center space-x-1 flex-wrap",children:[e.jsx("span",{children:J(_.check_out_turno)||"--:--"}),_.auto_checkout&&e.jsx("span",{className:"text-xs bg-purple-900 text-purple-200 px-1 py-0.5 rounded",title:"Checkout automatico",children:"AUTO"}),_.is_rectified&&_.rectified_check_out&&!_.original_check_out&&e.jsx("span",{className:"text-xs bg-green-900 text-green-200 px-1 py-0.5 rounded",title:"Chiuso via rettifica",children:"RETTIFICA"})]}),_.is_rectified&&_.original_check_out&&_.rectified_check_out&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",J(_.original_check_out),_.auto_checkout&&e.jsx("span",{className:"ml-1",children:"(AUTO)"})]}),_.is_rectified&&!_.original_check_out&&_.rectified_check_out&&e.jsx("div",{className:"text-gray-500 text-xs mt-1 italic",children:"(Non era stato effettuato)"})]})]})]})}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 mb-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(As,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm text-gray-300",children:"Pausa Pranzo:"})]}),e.jsxs("div",{className:"text-right",children:[_.pausa_pranzo?e.jsxs("div",{children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"S√¨"}),(()=>{const K=_.effective_pausa_pranzo_inizio||_.rectified_pausa_pranzo_inizio||_.pausa_pranzo_inizio,O=_.effective_pausa_pranzo_fine||_.rectified_pausa_pranzo_fine||_.pausa_pranzo_fine,W=_.effective_pausa_pranzo_minuti;return K&&O&&W?e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[K.substring(0,5)," - ",O.substring(0,5)," (",W," min)"]}):null})()]}):e.jsx("span",{className:"text-gray-500",children:"No"}),_.is_rectified&&_.original_pausa_pranzo!==_.pausa_pranzo&&e.jsxs("div",{className:"text-xs text-gray-500 line-through mt-1",children:["Era: ",_.original_pausa_pranzo?"S√¨":"No"]})]})]}),(_.pausa_cena||_.rectified_pausa_cena_inizio||_.pausa_cena_inizio)&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-700",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Bs,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-gray-300",children:"Pausa Cena:"})]}),e.jsxs("div",{className:"text-right",children:[_.pausa_cena||_.rectified_pausa_cena_inizio||_.pausa_cena_inizio?e.jsxs("div",{children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"S√¨"}),(()=>{const K=_.effective_pausa_cena_inizio||_.rectified_pausa_cena_inizio||_.pausa_cena_inizio,O=_.effective_pausa_cena_fine||_.rectified_pausa_cena_fine||_.pausa_cena_fine,W=_.effective_pausa_cena_minuti;return K&&O&&W?e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[K.substring(0,5)," - ",O.substring(0,5)," (",W," min)"]}):null})()]}):e.jsx("span",{className:"text-gray-500",children:"No"}),_.is_rectified&&_.rectified_pausa_cena_inizio&&!_.pausa_cena_inizio&&e.jsx("div",{className:"text-xs text-gray-500 line-through mt-1",children:"Era: No"})]})]}),_.effective_pausa_totale_minuti>0&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-700",children:[e.jsx("span",{className:"text-xs text-gray-400",children:"Totale Pause:"}),e.jsxs("span",{className:"text-xs text-gray-300 font-semibold",children:[_.effective_pausa_totale_minuti," minuti"]})]}),_.effective_ore_lavorate_minuti>0&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-700",children:[e.jsx("span",{className:"text-xs text-gray-400",children:"Ore Effettive:"}),e.jsxs("span",{className:"text-xs text-green-400 font-semibold",children:[Math.floor(_.effective_ore_lavorate_minuti/60),"h ",_.effective_ore_lavorate_minuti%60,"min"]})]})]}),(_.noteturno||_.notes)&&e.jsxs("div",{className:"space-y-2 mb-3",children:[_.noteturno&&e.jsx("div",{className:"bg-gradient-to-r from-blue-900/30 to-indigo-900/30 border border-blue-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("svg",{className:"h-4 w-4 text-blue-400 flex-shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-1",children:"üìù Note durante il turno:"}),e.jsx("div",{className:"text-xs text-blue-100 whitespace-pre-wrap",children:_.noteturno})]})]})}),_.notes&&e.jsx("div",{className:"bg-gradient-to-r from-gray-800/50 to-gray-900/50 border border-gray-600 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Ht,{className:"h-4 w-4 text-gray-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-xs font-semibold text-gray-300 mb-1",children:"üèÅ Note fine turno:"}),e.jsx("div",{className:"text-xs text-gray-200 whitespace-pre-wrap",children:_.notes})]})]})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs mb-2",children:[_.buoni_pasto_assegnato&&e.jsxs("span",{className:"bg-yellow-900 text-yellow-200 px-2 py-1 rounded flex items-center space-x-1",children:[e.jsx(Ss,{className:"h-3 w-3"}),e.jsx("span",{children:"Buono Pasto"})]}),_.pasto_aziendale_usufruito&&e.jsxs("span",{className:"bg-orange-900 text-orange-200 px-2 py-1 rounded flex items-center space-x-1",children:[e.jsx(Bs,{className:"h-3 w-3"}),e.jsx("span",{children:"Pasto Aziendale"})]})]}),_.is_rectified&&_.rectification_note&&e.jsx("div",{className:"bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-orange-200 mb-1",children:"Nota di Rettifica:"}),e.jsx("div",{className:"text-xs text-orange-300",children:_.rectification_note})]})]})}),e.jsx(Ui,{shift:_,onUpdate:q,tableName:"warehouse_checkins"})]},_.id)})})]})},xd=n=>{const l=Math.floor(n/60),c=n%60;return{hours:l,minutes:c}},Dr=n=>{const{hours:l,minutes:c}=xd(n);return`${l}h ${c}min`},md=(n,l=480,c)=>{const u=n-l;if(u<=0)return 0;const f=u/60*c;return Math.round(f*100)/100},fd=(n,l=480,c)=>{const u=n-l,f=md(n,l,c);return{actualWorkedMinutes:n,actualWorkedFormatted:Dr(n),expectedWarehouseMinutes:l,expectedWarehouseFormatted:Dr(l),extraMinutes:Math.max(0,u),extraMinutesFormatted:u>0?Dr(u):"0h 0min",hourlyRate:c,benefit:f,hasBenefit:u>0}},gd=({selectedMonth:n,selectedYear:l})=>{const{user:c}=Pt(),[u,f]=w.useState([]),[x,b]=w.useState([]),[v,S]=w.useState(""),[g,j]=w.useState("all"),[p,M]=w.useState([]),[B,k]=w.useState(!0),[R,C]=w.useState(null),D=N=>String(N).padStart(2,"0"),E=N=>`${N.getFullYear()}-${D(N.getMonth()+1)}-${D(N.getDate())}`,U=N=>{if(!N)return new Date(NaN);const _=N.split("-").map(L=>parseInt(L,10));return _.length!==3?new Date(N):new Date(_[0],_[1]-1,_[2])};w.useEffect(()=>{c!=null&&c.id&&q()},[c==null?void 0:c.id,n,l]),w.useEffect(()=>{let N=[...u];v&&(N=N.filter(_=>_.giorno_turno===v)),g!=="all"&&(N=N.filter(_=>(_.notes||"").includes(g))),b(N)},[u,v,g]);const q=async()=>{try{k(!0),C(null);const N=new Date(l,n,1),_=new Date(l,n+1,0),L=E(N),I=E(_),{data:K,error:O}=await je.from("extra_shifts_checkins").select("*").eq("crew_id",c==null?void 0:c.id).gte("date",L).lte("date",I).order("date",{ascending:!1});if(O)throw O;const W=(K||[]).map(G=>{const $=G.rectified_check_in_time||G.check_in_time,F=G.rectified_check_out_time||G.check_out_time,re=G.rectified_pausa_pranzo!==null?G.rectified_pausa_pranzo:G.has_taken_break||!1;return{id:G.id,turno_id:"",warehouse_id:"",warehouse_name:"TURNO EXTRA",notes:G.notes||"",noteturno:G.NoteTurno||"",giorno_turno:G.date,nome_turno:"TURNO EXTRA",check_in_turno:$,check_out_turno:F,conteggio_ore:G.effective_ore_lavorate_minuti||0,buoni_pasto_assegnato:G.meal_voucher||!1,pasto_aziendale_usufruito:G.company_meal||!1,ore_straordinario:0,ore_previste:480,pausa_pranzo:re,pausa_cena:!!(G.pausa_cena_inizio&&G.pausa_cena_fine),pausa_pranzo_inizio:G.pausa_pranzo_inizio||G.break_start_time,pausa_pranzo_fine:G.pausa_pranzo_fine||G.break_end_time,pausa_pranzo_minuti:G.pausa_pranzo_minuti||G.break_minutes,pausa_cena_inizio:G.pausa_cena_inizio,pausa_cena_fine:G.pausa_cena_fine,pausa_cena_minuti:G.pausa_cena_minuti,pausa_totale_minuti:G.pausa_totale_minuti,status:G.status,is_rectified:!!G.rectified_at,rectification_note:G.rectification_note||null,original_check_in:G.check_in_time,original_check_out:G.check_out_time,original_pausa_pranzo:G.has_taken_break||!1,rectified_check_in:G.rectified_check_in_time,rectified_check_out:G.rectified_check_out_time,rectified_pausa_pranzo:G.rectified_pausa_pranzo,rectified_pausa_pranzo_inizio:G.rectified_pausa_pranzo_inizio,rectified_pausa_pranzo_fine:G.rectified_pausa_pranzo_fine,rectified_pausa_cena_inizio:G.rectified_pausa_cena_inizio,rectified_pausa_cena_fine:G.rectified_pausa_cena_fine,effective_pausa_pranzo_inizio:G.effective_pausa_pranzo_inizio,effective_pausa_pranzo_fine:G.effective_pausa_pranzo_fine,effective_pausa_pranzo_minuti:G.effective_pausa_pranzo_minuti,effective_pausa_cena_inizio:G.effective_pausa_cena_inizio,effective_pausa_cena_fine:G.effective_pausa_cena_fine,effective_pausa_cena_minuti:G.effective_pausa_cena_minuti,effective_pausa_totale_minuti:G.effective_pausa_totale_minuti,effective_ore_lavorate_minuti:G.effective_ore_lavorate_minuti,auto_checkout:!1,benefit_tariffa_id:G.benefit_tariffa_id,benefit_importo_orario:G.benefit_importo_orario?parseFloat(G.benefit_importo_orario):void 0}});f(W);const se=new Set;W.forEach(G=>{G.notes&&se.add(G.notes)}),M(Array.from(se).sort())}catch(N){console.error("Errore caricamento turni extra:",N),C(N instanceof Error?N.message:"Errore sconosciuto")}finally{k(!1)}},J=N=>N&&or(N)||"Non specificato";return B?e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"Caricamento turni extra..."})]})}):R?e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"text-center py-8 text-red-400",children:[e.jsx(Zt,{className:"h-12 w-12 mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Errore nel caricamento"}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:R}),e.jsx("button",{onClick:()=>q(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Riprova"})]})}):e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Turni Extra (",x.length,u.length!==x.length?` di ${u.length}`:"",")"]}),e.jsxs("div",{className:"mb-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Giorno Specifico:"}),e.jsx("input",{type:"date",value:v,onChange:N=>S(N.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",placeholder:"Seleziona un giorno..."}),v&&e.jsx("button",{onClick:()=>S(""),className:"mt-2 text-xs text-blue-400 hover:text-blue-300",children:"Rimuovi filtro data"})]}),p.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Nome Turno:"}),e.jsxs("select",{value:g,onChange:N=>j(N.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",children:[e.jsx("option",{value:"all",children:"Tutti i Turni"}),p.map((N,_)=>e.jsx("option",{value:N,children:N||"Senza nome"},_))]})]}),(v||g!=="all")&&e.jsxs("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-2 text-xs text-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ya,{className:"h-3 w-3"}),e.jsx("span",{className:"font-semibold",children:"Filtri attivi:"})]}),e.jsxs("div",{className:"mt-1 space-y-1",children:[v&&e.jsxs("div",{children:["Data: ",U(v).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"})]}),g!=="all"&&e.jsxs("div",{children:["Turno: ",g]})]})]})]}),x.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(kr,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsxs("p",{children:["Nessun turno extra ",v?"trovato con il filtro selezionato":"nel periodo selezionato"]}),e.jsx("p",{className:"text-sm mt-1",children:v?"Prova a modificare il filtro":"I turni extra appariranno qui"})]}):e.jsx("div",{className:"space-y-3",children:x.map(N=>{const _=N.check_out_turno||N.rectified_check_out,L=N.status!=="completed"||!_;return e.jsxs("div",{className:"bg-gradient-to-r from-blue-900 to-blue-800 rounded-lg p-4 border border-blue-600",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(kr,{className:"h-5 w-5 text-blue-300"}),e.jsx("h4",{className:"font-bold text-white",children:"TURNO EXTRA"}),N.is_rectified&&e.jsx("span",{className:"bg-blue-600 text-white text-xs px-2 py-0.5 rounded font-semibold",children:"Rettificato"})]}),e.jsx("p",{className:"text-sm text-blue-200",children:U(N.giorno_turno).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})})]}),e.jsx("div",{className:"text-right",children:L?e.jsx("div",{className:"text-sm text-blue-300 font-semibold",children:"In corso"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-lg font-bold text-blue-300",children:N.effective_ore_lavorate_minuti?Dr(N.effective_ore_lavorate_minuti):"0h 0min"}),e.jsx("div",{className:"text-xs text-blue-200",children:"Ore Lavorate"})]})})]}),e.jsx("div",{className:"bg-gray-900 bg-opacity-40 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[e.jsx(ct,{className:"h-3 w-3 text-green-400"}),e.jsx("span",{className:"text-blue-200 font-medium",children:"Check-in:"})]}),e.jsx("div",{className:"text-white font-semibold",children:J(N.check_in_turno)||"--:--"}),N.is_rectified&&N.original_check_in&&e.jsxs("div",{className:"text-blue-300 line-through text-xs mt-1",children:["Era: ",J(N.original_check_in)]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[e.jsx(ct,{className:"h-3 w-3 text-red-400"}),e.jsx("span",{className:"text-blue-200 font-medium",children:"Check-out:"})]}),L?e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-blue-300 font-semibold",children:"In corso"}),N.is_rectified&&N.rectified_check_out&&e.jsxs("div",{className:"text-green-400 text-xs mt-1 flex items-center space-x-1",children:[e.jsx(ft,{className:"h-3 w-3"}),e.jsxs("span",{children:["Chiuso via rettifica: ",J(N.rectified_check_out)]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-white font-semibold flex items-center space-x-1 flex-wrap",children:[e.jsx("span",{children:J(N.check_out_turno)||"--:--"}),N.auto_checkout&&e.jsx("span",{className:"text-xs bg-purple-900 text-purple-200 px-1 py-0.5 rounded",title:"Checkout automatico",children:"AUTO"}),N.is_rectified&&N.rectified_check_out&&!N.original_check_out&&e.jsx("span",{className:"text-xs bg-green-900 text-green-200 px-1 py-0.5 rounded",title:"Chiuso via rettifica",children:"RETTIFICA"})]}),N.is_rectified&&N.original_check_out&&N.rectified_check_out&&e.jsxs("div",{className:"text-blue-300 line-through text-xs mt-1",children:["Era: ",J(N.original_check_out),N.auto_checkout&&e.jsx("span",{className:"ml-1",children:"(AUTO)"})]}),N.is_rectified&&!N.original_check_out&&N.rectified_check_out&&e.jsx("div",{className:"text-blue-300 text-xs mt-1 italic",children:"(Non era stato effettuato)"})]})]})]})}),e.jsxs("div",{className:"bg-gray-900 bg-opacity-40 rounded-lg p-3 mb-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(As,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm text-blue-200",children:"Pausa Pranzo:"})]}),e.jsxs("div",{className:"text-right",children:[N.pausa_pranzo?e.jsxs("div",{children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"S√¨"}),(()=>{const I=N.effective_pausa_pranzo_inizio||N.rectified_pausa_pranzo_inizio||N.pausa_pranzo_inizio,K=N.effective_pausa_pranzo_fine||N.rectified_pausa_pranzo_fine||N.pausa_pranzo_fine,O=N.effective_pausa_pranzo_minuti;return I&&K&&O?e.jsxs("div",{className:"text-xs text-blue-200 mt-0.5",children:[I.substring(0,5)," - ",K.substring(0,5)," (",O," min)"]}):null})()]}):e.jsx("span",{className:"text-blue-300",children:"No"}),N.is_rectified&&N.original_pausa_pranzo!==N.pausa_pranzo&&e.jsxs("div",{className:"text-xs text-blue-300 line-through mt-1",children:["Era: ",N.original_pausa_pranzo?"S√¨":"No"]})]})]}),(N.pausa_cena||N.rectified_pausa_cena_inizio||N.pausa_cena_inizio)&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-blue-700",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Bs,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-blue-200",children:"Pausa Cena:"})]}),e.jsxs("div",{className:"text-right",children:[N.pausa_cena||N.rectified_pausa_cena_inizio||N.pausa_cena_inizio?e.jsxs("div",{children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"S√¨"}),(()=>{const I=N.effective_pausa_cena_inizio||N.rectified_pausa_cena_inizio||N.pausa_cena_inizio,K=N.effective_pausa_cena_fine||N.rectified_pausa_cena_fine||N.pausa_cena_fine,O=N.effective_pausa_cena_minuti;return I&&K&&O?e.jsxs("div",{className:"text-xs text-blue-200 mt-0.5",children:[I.substring(0,5)," - ",K.substring(0,5)," (",O," min)"]}):null})()]}):e.jsx("span",{className:"text-blue-300",children:"No"}),N.is_rectified&&N.rectified_pausa_cena_inizio&&!N.pausa_cena_inizio&&e.jsx("div",{className:"text-xs text-blue-300 line-through mt-1",children:"Era: No"})]})]}),N.effective_pausa_totale_minuti>0&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-blue-700",children:[e.jsx("span",{className:"text-xs text-blue-200",children:"Totale Pause:"}),e.jsx("span",{className:"text-xs text-white font-semibold",children:Dr(N.effective_pausa_totale_minuti)})]}),N.effective_ore_lavorate_minuti>0&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-blue-700",children:[e.jsx("span",{className:"text-xs text-blue-200",children:"Ore Effettive:"}),e.jsx("span",{className:"text-xs text-green-400 font-semibold",children:Dr(N.effective_ore_lavorate_minuti)})]})]}),N.benefit_tariffa_id&&N.benefit_importo_orario&&N.effective_ore_lavorate_minuti>0&&_&&(()=>{const I=fd(N.effective_ore_lavorate_minuti,N.ore_previste||480,N.benefit_importo_orario);return I.hasBenefit?e.jsx("div",{className:"bg-gradient-to-r from-green-900 to-green-800 rounded-lg p-3 mb-3 border border-green-600",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Sa,{className:"h-5 w-5 text-green-300 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-bold text-green-200 mb-2",children:"Benefit Turno Extra"}),e.jsxs("div",{className:"space-y-1 text-xs text-green-100",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Ore Extra Lavorate:"}),e.jsx("span",{className:"font-semibold",children:I.actualWorkedFormatted})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Ore Magazzino Previste:"}),e.jsx("span",{className:"font-semibold",children:I.expectedWarehouseFormatted})]}),e.jsxs("div",{className:"flex justify-between pt-1 border-t border-green-700",children:[e.jsx("span",{children:"Ore da Conteggiare:"}),e.jsx("span",{className:"font-semibold text-green-300",children:I.extraMinutesFormatted})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Tariffa Oraria:"}),e.jsxs("span",{className:"font-semibold",children:["‚Ç¨",I.hourlyRate.toFixed(2),"/ora"]})]}),e.jsxs("div",{className:"flex justify-between pt-2 border-t border-green-700",children:[e.jsx("span",{className:"text-base font-bold",children:"Importo Benefit:"}),e.jsxs("span",{className:"text-base font-bold text-green-300",children:["‚Ç¨",I.benefit.toFixed(2)]})]})]})]})]})}):null})(),(N.noteturno||N.notes)&&e.jsx("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Ht,{className:"h-4 w-4 text-blue-300 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-1",children:"Note Dipendente:"}),e.jsx("div",{className:"text-xs text-blue-100",children:N.noteturno||N.notes})]})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs mb-2",children:[N.buoni_pasto_assegnato&&e.jsxs("span",{className:"bg-yellow-600 text-white px-2 py-1 rounded flex items-center space-x-1",children:[e.jsx(Ss,{className:"h-3 w-3"}),e.jsx("span",{children:"Buono Pasto"})]}),N.pasto_aziendale_usufruito&&e.jsxs("span",{className:"bg-blue-600 text-white px-2 py-1 rounded flex items-center space-x-1",children:[e.jsx(Bs,{className:"h-3 w-3"}),e.jsx("span",{children:"Pasto Aziendale"})]})]}),N.is_rectified&&N.rectification_note&&e.jsx("div",{className:"bg-blue-900 bg-opacity-50 border border-blue-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-blue-300 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-1",children:"Nota di Rettifica:"}),e.jsx("div",{className:"text-xs text-blue-100",children:N.rectification_note})]})]})}),e.jsx(Ui,{shift:N,onUpdate:q,tableName:"extra_shifts_checkins"})]},N.id)})})]})},pd=()=>{var N;const{user:n}=Pt(),[l,c]=w.useState(null),[u,f]=w.useState(new Date().getMonth()),[x,b]=w.useState(new Date().getFullYear()),[v,S]=w.useState(!0),[g,j]=w.useState(null),[p,M]=w.useState(null),[B,k]=w.useState("events"),R=_=>String(_).padStart(2,"0"),C=_=>`${_.getFullYear()}-${R(_.getMonth()+1)}-${R(_.getDate())}`,D=_=>{if(!_)return new Date(NaN);const L=_.split("-").map(I=>parseInt(I,10));return L.length!==3?new Date(_):new Date(L[0],L[1]-1,L[2])};w.useEffect(()=>{n!=null&&n.id&&E()},[n==null?void 0:n.id,u,x]);const E=async()=>{try{S(!0),M(null);const{data:_,error:L}=await je.from("registration_requests").select(`
          *,
          regaziendasoftware!parent_company_id(ragione_sociale)
        `).eq("auth_user_id",n==null?void 0:n.id).single();if(L||!_){console.error("Errore caricamento profilo:",L),M("Errore nel caricamento del profilo utente");return}j(_);const I=new Date(x,u,1),K=new Date(x,u+1,0),O=C(I),W=C(K),{data:se}=await je.from("crew_event_assegnazione").select("evento_id, evento_trasferta, nome_evento, giorno_inizio_evento, giorno_fine_evento").eq("dipendente_freelance_id",n==null?void 0:n.id).gte("giorno_inizio_evento",O).lte("giorno_inizio_evento",W),{data:G}=await je.from("timesheet_entries").select("event_id, status, start_time").eq("crew_id",n==null?void 0:n.id).gte("date",O).lte("date",W),$=new Set((G||[]).filter(ae=>ae.start_time&&(ae.status==="active"||ae.status==="completed"||ae.status==="submitted")).map(ae=>ae.event_id)),F={warehouse:0,event:0,event_travel:0},re=[];(se||[]).forEach(ae=>{var le;if($.has(ae.evento_id)){(le=ae.nome_evento)!=null&&le.toLowerCase().includes("magazzino")?F.warehouse++:ae.evento_trasferta?F.event_travel++:F.event++;const be=D(ae.giorno_inizio_evento),ye=D(ae.giorno_fine_evento),Ce=new Date(be);for(;Ce<=ye;)re.push(C(Ce)),Ce.setDate(Ce.getDate()+1)}});const{data:_e}=await je.from("warehouse_checkins").select("id, date, status, check_out_time, overtime_hours").eq("crew_id",n==null?void 0:n.id).gte("date",O).lte("date",W),{data:ge}=await je.from("extra_shifts_checkins").select("id, date, status, check_out_time, overtime_hours").eq("crew_id",n==null?void 0:n.id).gte("date",O).lte("date",W),X=(_e||[]).filter(ae=>ae.status==="completed"&&ae.check_out_time),pe=(ge||[]).filter(ae=>ae.status==="completed"&&ae.check_out_time);F.warehouse+=X.length;let me=0;[...X,...pe].forEach(ae=>{me+=parseFloat(ae.overtime_hours)||0,re.push(ae.date)});const{data:Q}=await je.from("expenses").select("id").eq("crew_id",n==null?void 0:n.id).gte("expense_date",O).lte("expense_date",W),V=new Set(re),de={month:new Date(x,u).toLocaleDateString("it-IT",{month:"long"}),year:x,totalEvents:((se==null?void 0:se.length)||0)+X.length+pe.length,totalDays:V.size,totalShifts:X.length+pe.length,eventsByType:F,expensesCount:(Q==null?void 0:Q.length)||0,overtimeHours:me,vacationRequested:_.vacation_days_used||0,vacationRemaining:(_.vacation_days_total||0)-(_.vacation_days_used||0),leaveRequested:_.leave_days_used||0,leaveRemaining:(_.leave_days_total||0)-(_.leave_days_used||0)};c(de)}catch(_){console.error("Errore caricamento riepilogo mensile:",_),M(`Errore nel caricamento del riepilogo: ${_ instanceof Error?_.message:"Errore sconosciuto"}`)}finally{S(!1)}},U=()=>{var L;if(!l)return;const _={dipendente:(g==null?void 0:g.full_name)||"Dipendente",azienda:((L=g==null?void 0:g.regaziendasoftware)==null?void 0:L.ragione_sociale)||"Azienda",periodo:`${l.month} ${l.year}`,eventi:l.totalEvents};console.log("Download report:",_),alert(`Report ${l.month} ${l.year} generato!`)},q=()=>{u===0?(f(11),b(x-1)):f(u-1)},J=()=>{u===11?(f(0),b(x+1)):f(u+1)};return v?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento riepilogo..."})]})}):p?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(Zt,{className:"h-16 w-16 mx-auto mb-4 text-red-400"}),e.jsx("p",{className:"text-lg text-red-400",children:"Errore nel caricamento"}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:p}),e.jsx("button",{onClick:()=>E(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Riprova"})]})}):e.jsx("div",{className:"min-h-screen bg-gray-900 text-white",children:e.jsxs("div",{className:"p-4 pb-20 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Report Mensile"}),e.jsx("p",{className:"text-gray-300",children:(g==null?void 0:g.full_name)||"Dipendente"}),e.jsx("p",{className:"text-sm text-blue-400",children:((N=g==null?void 0:g.regaziendasoftware)==null?void 0:N.ragione_sociale)||"La Mia Azienda"})]}),e.jsx("button",{onClick:U,disabled:!l,className:"bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-600",children:e.jsx(hr,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("button",{onClick:q,className:"flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors",children:[e.jsx(ta,{className:"h-5 w-5"}),e.jsx("span",{children:"Precedente"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-white capitalize",children:new Date(x,u).toLocaleDateString("it-IT",{month:"long"})}),e.jsx("div",{className:"text-sm text-gray-400",children:x})]}),e.jsxs("button",{onClick:J,className:"flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors",children:[e.jsx("span",{children:"Successivo"}),e.jsx(sa,{className:"h-5 w-5"})]})]})}),e.jsx("div",{className:"bg-gray-800 rounded-xl border border-gray-700 overflow-hidden",children:e.jsxs("div",{className:"grid grid-cols-3",children:[e.jsxs("button",{onClick:()=>k("events"),className:`flex items-center justify-center space-x-2 py-4 px-2 transition-all ${B==="events"?"bg-blue-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:[e.jsx(ut,{className:"h-5 w-5"}),e.jsx("span",{className:"font-semibold text-sm",children:"Eventi"})]}),e.jsxs("button",{onClick:()=>k("warehouse"),className:`flex items-center justify-center space-x-2 py-4 px-2 transition-all ${B==="warehouse"?"bg-blue-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:[e.jsx(zt,{className:"h-5 w-5"}),e.jsx("span",{className:"font-semibold text-sm",children:"Turni"})]}),e.jsxs("button",{onClick:()=>k("extra"),className:`flex items-center justify-center space-x-2 py-4 px-2 transition-all ${B==="extra"?"bg-blue-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:[e.jsx(Ts,{className:"h-5 w-5"}),e.jsx("span",{className:"font-semibold text-sm",children:"Extra"})]})]})}),l&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Riepilogo ",l.month," ",l.year]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(zt,{className:"h-5 w-5 mx-auto mb-1 text-gray-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:l.eventsByType.warehouse}),e.jsx("div",{className:"text-xs text-gray-400",children:"Turni Magazzino"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(ut,{className:"h-5 w-5 mx-auto mb-1 text-blue-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:l.eventsByType.event}),e.jsx("div",{className:"text-xs text-gray-400",children:"Eventi"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(Ts,{className:"h-5 w-5 mx-auto mb-1 text-orange-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:l.eventsByType.event_travel}),e.jsx("div",{className:"text-xs text-gray-400",children:"Trasferte"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(ut,{className:"h-5 w-5 mx-auto mb-1 text-blue-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:l.totalDays}),e.jsx("div",{className:"text-xs text-gray-400",children:"Giorni"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(xi,{className:"h-5 w-5 mx-auto mb-1 text-yellow-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:l.expensesCount}),e.jsx("div",{className:"text-xs text-gray-400",children:"Note Spese"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(ct,{className:"h-5 w-5 mx-auto mb-1 text-green-400"}),e.jsxs("div",{className:"text-lg font-bold text-white",children:[l.overtimeHours.toFixed(1),"h"]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Straordinari"})]})]})]}),B==="events"&&e.jsx(ud,{selectedMonth:u,selectedYear:x}),B==="warehouse"&&e.jsx(hd,{selectedMonth:u,selectedYear:x}),B==="extra"&&e.jsx(gd,{selectedMonth:u,selectedYear:x}),!l&&!v&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700 text-center",children:[e.jsx(Ht,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Nessun Dato Disponibile"}),e.jsx("p",{className:"text-gray-300",children:"Non ci sono eventi per il periodo selezionato."}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Prova a selezionare un mese diverso o attendi nuove assegnazioni."})]}),e.jsx(aa,{})]})})},bd=()=>{const{user:n}=Pt(),{showSuccess:l,showError:c}=us(),[u,f]=w.useState(!0),[x,b]=w.useState(!1),[v,S]=w.useState({request_type:"vacation",start_date:"",end_date:"",start_time:"",end_time:"",reason:""}),[g,j]=w.useState([]),[p,M]=w.useState(!1);w.useEffect(()=>{if(!(n!=null&&n.id)){f(!1);return}(async()=>(f(!0),await B(),f(!1)))()},[n==null?void 0:n.id]);async function B(){try{const{data:N,error:_}=await je.from("crew_richiesteferie_permessi").select("*").eq("dipendente_id",n==null?void 0:n.id).order("created_at",{ascending:!1}).limit(1e3);if(_){console.warn("Errore loadVacationRequests:",_),j([]);return}j(N||[])}catch(N){console.error("Errore loadVacationRequests:",N),j([])}}async function k(){try{const{data:N}=await je.from("crew_members").select("company_id").eq("id",n==null?void 0:n.id).maybeSingle();if(N!=null&&N.company_id)return String(N.company_id);const{data:_}=await je.from("registration_requests").select("parent_company_id").eq("auth_user_id",n==null?void 0:n.id).maybeSingle();if(_!=null&&_.parent_company_id)return String(_.parent_company_id);const{data:L}=await je.from("users").select("email").eq("id",n==null?void 0:n.id).maybeSingle(),I=(L==null?void 0:L.email)??null;if(I){const{data:K}=await je.from("registration_requests").select("parent_company_id").ilike("email",I).limit(1).maybeSingle();if(K!=null&&K.parent_company_id)return String(K.parent_company_id)}return null}catch(N){return console.error("resolveCompanyId error:",N),null}}function R(N,_){if(!N||!_)return 0;const L=new Date(N),I=new Date(_),K=Math.floor((I.getTime()-L.getTime())/(1e3*60*60*24))+1;return K>0?K:0}function C(N,_){if(!N||!_)return 0;const[L,I]=N.split(":").map(Number),[K,O]=_.split(":").map(Number),W=L*60+I,G=K*60+O-W;return G>0?Number((G/60).toFixed(2)):0}async function D(){if(!v.start_date){c("Inserisci la data di inizio");return}if(v.request_type==="vacation"&&!v.end_date){c("Inserisci la data di fine per le ferie");return}if(v.request_type==="vacation"&&new Date(v.end_date)<new Date(v.start_date)){c("La data di fine deve essere successiva alla data di inizio");return}if(v.request_type==="leave"){if(!v.start_time||!v.end_time){c("Inserisci orario di inizio e fine per il permesso");return}if(v.start_time>=v.end_time){c("L'orario di fine deve essere successivo all'orario di inizio");return}}b(!0);try{const N=await k();if(!N){c("Azienda non trovata per il tuo profilo. Contatta l'amministratore."),b(!1);return}const _={azienda_id:N,dipendente_id:n==null?void 0:n.id,tipo_richiesta:v.request_type==="vacation"?"ferie":"permesso",data_inizio:v.start_date,motivo:v.reason||null,stato:"in_attesa"};v.request_type==="vacation"?(_.data_fine=v.end_date,_.giorni_richiesti=R(v.start_date,v.end_date)):(_.data_fine=v.start_date,_.orario_inizio=v.start_time,_.orario_fine=v.end_time,_.ore_richieste=C(v.start_time,v.end_time),_.giorni_richiesti=0);const{error:L}=await je.from("crew_richiesteferie_permessi").insert(_);if(L)throw L;l("Richiesta inviata"),S({request_type:"vacation",start_date:"",end_date:"",start_time:"",end_time:"",reason:""}),await B()}catch(N){console.error("Errore handleVacationSubmit:",N),c((N==null?void 0:N.message)||"Errore invio richiesta")}finally{b(!1)}}function E(N){const _=N.stato??N.status??N.state??N.stato_richiesta??null;if(!_)return"in_attesa";const L=String(_).toLowerCase();return L.includes("approv")||L==="approved"||L==="accepted"?"approved":L.includes("rifiut")||L==="rejected"||L==="refused"?"rejected":L.includes("in_attesa")||L.includes("pending")||L.includes("in attesa")?"pending":L}function U(N){const _=E(N);return _==="approved"?{label:"Approvata",className:"bg-green-100 text-green-800"}:_==="rejected"?{label:"Rifiutata",className:"bg-red-100 text-red-800"}:{label:"In attesa",className:"bg-yellow-100 text-yellow-800"}}function q(N){if(!N)return"-";try{return new Date(N).toLocaleDateString("it-IT")}catch{return N}}async function J(){M(!0);try{await B(),l("Aggiornato")}catch(N){console.error("refresh error",N),c("Errore aggiornamento")}finally{M(!1)}}return e.jsxs("div",{className:"bg-gray-900 p-4 rounded-lg border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Ferie e Permessi"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Invia richieste e controlla lo stato"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:J,className:"p-2 rounded bg-gray-800 hover:bg-gray-700 text-gray-200",title:"Aggiorna",children:e.jsx(Ds,{})})})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4",children:[e.jsx("button",{onClick:()=>S({...v,request_type:"vacation"}),className:`w-full text-left py-3 px-3 rounded ${v.request_type==="vacation"?"bg-blue-600 text-white":"bg-gray-800 text-gray-200"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ut,{className:"h-5 w-5 flex-shrink-0"}),e.jsxs("div",{className:"leading-snug",children:[e.jsx("div",{className:"text-sm font-medium whitespace-normal break-words",children:"Ferie"}),e.jsx("div",{className:"text-xs text-gray-300",children:"Giorni interi"})]})]})}),e.jsx("button",{onClick:()=>S({...v,request_type:"leave"}),className:`w-full text-left py-3 px-3 rounded ${v.request_type==="leave"?"bg-blue-600 text-white":"bg-gray-800 text-gray-200"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ct,{className:"h-5 w-5 flex-shrink-0"}),e.jsxs("div",{className:"leading-snug",children:[e.jsx("div",{className:"text-sm font-medium whitespace-normal break-words",children:"Permesso"}),e.jsx("div",{className:"text-xs text-gray-300",children:"Ore / Mezze giornate"})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Data Inizio *"}),e.jsx("input",{type:"date",value:v.start_date,onChange:N=>S({...v,start_date:N.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:v.request_type==="vacation"?"Data Fine *":"Data *"}),e.jsx("input",{type:"date",value:v.request_type==="vacation"?v.end_date:v.start_date,onChange:N=>S({...v,end_date:v.request_type==="vacation"?N.target.value:v.end_date,start_date:v.request_type==="leave"?N.target.value:v.start_date}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2"})]})]}),v.request_type==="leave"&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Ora Inizio *"}),e.jsx("input",{type:"time",value:v.start_time,onChange:N=>S({...v,start_time:N.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Ora Fine *"}),e.jsx("input",{type:"time",value:v.end_time,onChange:N=>S({...v,end_time:N.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2",required:!0})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Motivo (opzionale)"}),e.jsx("textarea",{value:v.reason,onChange:N=>S({...v,reason:N.target.value}),rows:3,className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2",placeholder:v.request_type==="leave"?"Es: visita medica, commissione personale...":"Es: motivi personali, vacanza..."})]}),e.jsx("div",{className:"flex space-x-3 mb-6",children:e.jsx("button",{onClick:D,disabled:x,className:"flex-1 py-3 rounded bg-blue-600 text-white",children:x?"Invio...":"Invia Richiesta"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Richieste Inviate"}),e.jsx("div",{className:"space-y-3",children:g.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"Nessuna richiesta inviata"}):g.map(N=>{const _=N;E(N);const{label:L,className:I}=U(N),K=N.rejection_reason??N.rifiuto??N.motivo_rifiuto??(_==null?void 0:_.rejection_reason)??null,O=N.approved_by??(_==null?void 0:_.approved_by)??null,W=N.approved_at??(_==null?void 0:_.approved_at)??null,se=N.tipo_richiesta??(_==null?void 0:_.tipo_richiesta)??"Ferie/Permesso",G=se.toLowerCase().includes("permess"),$=(_==null?void 0:_.orario_inizio)??null,F=(_==null?void 0:_.orario_fine)??null,re=(_==null?void 0:_.ore_richieste)??null;return e.jsx("div",{className:"bg-gray-800 p-3 rounded border border-gray-700",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-white capitalize",children:se}),e.jsxs("div",{className:"text-sm text-gray-300",children:[q(N.data_inizio??(_==null?void 0:_.data_inizio)??(_==null?void 0:_.start_date)??null),!G&&(N.data_fine||_!=null&&_.data_fine)?` ‚Äî ${q(N.data_fine??(_==null?void 0:_.data_fine)??(_==null?void 0:_.end_date)??null)}`:"",!G&&N.giorni_richiesti?` ‚Ä¢ ${N.giorni_richiesti} giorno/i`:"",G&&$&&F&&e.jsxs("span",{children:[" ‚Ä¢ ",$.substring(0,5)," - ",F.substring(0,5)]}),G&&re&&e.jsxs("span",{children:[" ‚Ä¢ ",re," ore"]})]}),N.motivo&&e.jsxs("div",{className:"text-sm text-gray-300 mt-2",children:["Motivo: ",N.motivo]}),K&&e.jsxs("div",{className:"text-sm text-red-300 mt-2",children:["Motivo rifiuto: ",K]}),O&&e.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["Approvata da: ",O," ",W?`‚Ä¢ ${q(W)}`:""]})]}),e.jsx("div",{className:"text-right ml-2",children:e.jsx("div",{className:`text-xs px-2 py-1 rounded-full ${I}`,children:L})})]})},N.id)})})]})]})},wd=[{value:"vitto",label:"Vitto"},{value:"alloggio",label:"Alloggio"},{value:"trasporto",label:"Trasporto"},{value:"materiali",label:"Materiali"},{value:"comunicazioni",label:"Comunicazioni"},{value:"altro",label:"Altro"}],yd=()=>{const{user:n}=Pt(),{showSuccess:l,showError:c}=us(),[u,f]=w.useState([]),[x,b]=w.useState(!1),[v,S]=w.useState(!1),[g,j]=w.useState(!1),[p,M]=w.useState(null),B=w.useRef(null),k=w.useRef(null),[R,C]=w.useState({selectedSourceId:"",category:"vitto",amount:"",description:"",expenseDate:new Date().toISOString().slice(0,10),paymentMethod:"electronic",receiptFile:null,allowStandalone:!1}),[D,E]=w.useState([]);w.useEffect(()=>{n!=null&&n.id&&(U(),q().catch(O=>{console.warn("loadAvailableEvents initial failed",O)}))},[n==null?void 0:n.id]);async function U(){if(n!=null&&n.id)try{const{data:O,error:W}=await je.from("expenses").select(`
          id,
          category,
          description,
          amount,
          event_id,
          event_title,
          warehouse_checkin_id,
          warehouse_name,
          warehouse_shift_id,
          warehouse_shift_name,
          company_id,
          company_name,
          expense_date,
          status,
          submitted_at
        `).eq("crew_id",n.id).order("expense_date",{ascending:!1}).limit(6);if(W){console.warn("loadRecentExpenses error",W),E([]);return}E(O||[])}catch(O){console.error("loadRecentExpenses",O),E([])}}async function q(){if(!(n!=null&&n.id))return f([]),b(!0),[];const O=[];try{const{data:se}=await je.from("registration_requests").select("id").eq("auth_user_id",n.id).maybeSingle();se&&se.id&&O.push(String(se.id))}catch{}O.push(n.id);const W=[];for(const se of Array.from(new Set(O)))try{const{data:G}=await je.from("timesheet_entries").select("id, event_id, date, start_time").eq("crew_id",se).order("start_time",{ascending:!1}).limit(500),{data:$}=await je.from("warehouse_checkins").select("id, warehouse_id, shift_id, date, check_in_time").eq("crew_id",se).order("check_in_time",{ascending:!1}).limit(500),F=Array.from(new Set((G||[]).map(X=>X.event_id).filter(Boolean))),re=Array.from(new Set(($||[]).map(X=>X.warehouse_id).filter(Boolean))),_e={};if(F.length>0)try{const{data:X}=await je.from("crew_events").select("*").in("id",F);(X||[]).forEach(pe=>_e[String(pe.id)]=pe)}catch{}const ge={};if(re.length>0)try{const{data:X}=await je.from("warehouses").select("*").in("id",re);(X||[]).forEach(pe=>ge[String(pe.id)]=pe)}catch{}(G||[]).forEach(X=>{const pe=_e[String(X.event_id)]||{},me=pe.title??pe.name??pe.event_title??"Evento";W.push({sourceId:String(X.id),refEventId:X.event_id??null,refShiftId:null,title:me,date:X.date??X.start_time??null,location:pe.location??pe.address??null,type:"event"})}),($||[]).forEach(X=>{const pe=ge[String(X.warehouse_id)]||{},me=pe.title??pe.name??pe.warehouse_name??"Magazzino";W.push({sourceId:String(X.id),refEventId:null,refShiftId:X.shift_id??null,title:me,date:X.date??X.check_in_time??null,location:pe.address??pe.warehouse_address??null,type:"warehouse"})})}catch(G){console.warn("partial loadAvailableEvents fail for",se,G)}return W.sort((se,G)=>{const $=se.date?new Date(se.date).getTime():0;return(G.date?new Date(G.date).getTime():0)-$}),f(W),b(W.length===0),W}function J(O){if(C({...R,receiptFile:O}),!O){M(null);return}if(!O.type.startsWith("image/")){M(null);return}const W=new FileReader;W.onload=se=>{var G;return M(String(((G=se.target)==null?void 0:G.result)||null))},W.readAsDataURL(O)}async function N(O){try{const W=O.name.split(".").pop()??"jpg",se=`${n==null?void 0:n.id}/receipts/${Date.now()}.${W}`,{data:G,error:$}=await je.storage.from("receipts").upload(se,O,{cacheControl:"3600",upsert:!1});if($)return console.warn("upload error",$),null;try{const{data:F}=je.storage.from("receipts").getPublicUrl(G.path);return(F==null?void 0:F.publicURL)??(F==null?void 0:F.publicUrl)??null}catch(F){return console.warn("getPublicUrl failed",F),null}}catch(W){return console.error("uploadReceipt",W),null}}async function _(O,W=!1){j(!0);try{const se=parseFloat(R.amount);let G=null;if(R.receiptFile){const pe=await N(R.receiptFile);pe&&(G=pe)}let $=null;try{const{data:pe}=await je.from("crew_members").select("company_id").eq("id",n.id).maybeSingle();$=(pe==null?void 0:pe.company_id)??null}catch{}const F=O&&O.type==="warehouse"?O.sourceId:null,re=O&&O.type==="event"?O.refEventId:null,_e=R.description??"",ge={crew_id:n.id,event_id:re,warehouse_shift_id:null,warehouse_checkin_id:F,expense_date:R.expenseDate,category:R.category,amount:se,description:R.description,notes:_e,receipt_url:G,status:"pending",company_id:$};(W||R.allowStandalone)&&(ge.event_id=null,ge.warehouse_shift_id=null,ge.warehouse_checkin_id=null),console.debug("NoteSpese: inserting expense payload",{selected:O,basePayload:ge});const X=await je.from("expenses").insert(ge);if(X.error){console.error("expenses insert error",X.error),c(X.error.message??"Errore invio nota spesa");return}l("Nota spesa inviata"),S(!1),C({selectedSourceId:"",category:"vitto",amount:"",description:"",expenseDate:new Date().toISOString().slice(0,10),paymentMethod:"electronic",receiptFile:null,allowStandalone:!1}),M(null),await U()}catch(se){console.error("doInsert error",se),c((se==null?void 0:se.message)||"Errore invio nota spesa")}finally{j(!1)}}async function L(){try{if(!(n!=null&&n.id)){c("Utente non autenticato");return}if(await q().catch(()=>{}),!R.allowStandalone&&!R.selectedSourceId){c('Seleziona un evento o turno oppure abilita "Nota non collegata"');return}if(!R.description||!R.amount){c("Compila descrizione e importo");return}const O=parseFloat(R.amount);if(isNaN(O)||O<=0){c("Inserisci un importo valido");return}const W=u.find(se=>se.sourceId===R.selectedSourceId)??null;if(R.selectedSourceId&&!W){c("Evento/turno non valido");return}await _(W,!1)}catch(O){console.error("handleSubmit unexpected",O),c((O==null?void 0:O.message)||"Errore invio nota spesa")}}const I=O=>{const W=se=>se!=null&&String(se).trim()!=="";return W(O.event_title)?O.event_title:W(O.warehouse_shift_name)?O.warehouse_shift_name+(W(O.warehouse_name)?" ‚Ä¢ "+O.warehouse_name:""):W(O.warehouse_name)?O.warehouse_name:W(O.company_name)?O.company_name:W(O.event_id)?String(O.event_id):W(O.warehouse_checkin_id)?String(O.warehouse_checkin_id):""},K=O=>{try{return O?new Date(O).toLocaleDateString("it-IT"):"-"}catch{return String(O)}};return e.jsxs("div",{className:"bg-gray-900 p-4 rounded border border-gray-700",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Note Spese"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Invia le tue spese associate a eventi/turni"})]}),e.jsx("div",{className:"w-full sm:w-auto",children:e.jsxs("button",{onClick:()=>{S(!0),q().catch(()=>{})},className:"w-full sm:w-auto py-3 px-4 rounded bg-green-600 text-white text-sm font-medium",children:[e.jsx(Ht,{className:"inline mr-2"})," Nuova Nota Spesa"]})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm text-gray-300 mb-2",children:"Note spese recenti"}),D.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"Nessuna nota spesa recente"}):e.jsx("div",{className:"space-y-3",children:D.map(O=>e.jsxs("div",{className:"bg-gray-800 p-3 rounded border border-gray-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-white truncate",children:O.category}),e.jsx("div",{className:"text-sm text-gray-300 truncate",children:O.description}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[I(O)," ‚Ä¢ ",K(O.expense_date)]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-green-400 font-semibold",children:["‚Ç¨",Number(O.amount||0).toFixed(2)]}),e.jsx("div",{className:`text-xs mt-1 ${O.status==="approved"?"text-green-300":O.status==="rejected"?"text-red-300":"text-yellow-300"}`,children:O.status==="approved"?"Approvata":O.status==="rejected"?"Rifiutata":"In attesa"})]})]},O.id))})]}),v&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4",children:e.jsxs("div",{className:"w-full h-full sm:h-auto max-w-full sm:max-w-lg bg-gray-900 rounded-none sm:rounded p-4 sm:p-6 overflow-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Nuova Nota Spesa"}),e.jsx("button",{onClick:()=>{S(!1),M(null)},className:"text-gray-400",children:e.jsx(jt,{})})]}),x&&e.jsx("div",{className:"mb-3 p-2 rounded bg-yellow-900/20 border border-yellow-700 text-yellow-200 text-sm",children:'Nessun evento/turno trovato per il tuo account. Puoi comunque compilare la nota spesa abilitando "Nota non collegata".'}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Turno / Evento"}),e.jsxs("select",{value:R.selectedSourceId,onChange:O=>C({...R,selectedSourceId:O.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:u.length===0?"Nessun evento disponibile":"Seleziona evento/turno"}),u.map(O=>e.jsxs("option",{value:O.sourceId,children:[O.type==="warehouse"?"[MAG] ":"[EV] ",O.title," ‚Äî ",O.date?new Date(O.date).toLocaleDateString("it-IT"):"-"]},O.sourceId))]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("input",{id:"standalone",type:"checkbox",checked:R.allowStandalone,onChange:O=>C({...R,allowStandalone:O.target.checked}),className:"h-4 w-4"}),e.jsx("label",{htmlFor:"standalone",className:"text-sm text-gray-300",children:"Nota non collegata (crea nota senza evento)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Categoria"}),e.jsx("select",{value:R.category,onChange:O=>C({...R,category:O.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm",children:wd.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Importo (‚Ç¨)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:R.amount,onChange:O=>C({...R,amount:O.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Data Spesa"}),e.jsx("input",{type:"date",value:R.expenseDate,onChange:O=>C({...R,expenseDate:O.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Descrizione"}),e.jsx("textarea",{value:R.description,onChange:O=>C({...R,description:O.target.value}),rows:3,className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Metodo di pagamento"}),e.jsxs("select",{value:R.paymentMethod,onChange:O=>C({...R,paymentMethod:O.target.value}),className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm",children:[e.jsx("option",{value:"electronic",children:"Pagamento Elettronico"}),e.jsx("option",{value:"cash",children:"Contanti"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Scontrino (opzionale)"}),e.jsxs("div",{className:"mt-1 flex gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>{var O;return(O=k.current)==null?void 0:O.click()},className:"flex-1 bg-gray-800 border border-gray-700 rounded py-2 text-gray-200 text-sm",children:[e.jsx(di,{className:"inline mr-2"})," Scatta"]}),e.jsxs("button",{type:"button",onClick:()=>{var O;return(O=B.current)==null?void 0:O.click()},className:"flex-1 bg-gray-800 border border-gray-700 rounded py-2 text-gray-200 text-sm",children:[e.jsx(oi,{className:"inline mr-2"})," Carica"]}),e.jsx("input",{ref:k,type:"file",accept:"image/*",capture:"environment",onChange:O=>{var W;return J(((W=O.target.files)==null?void 0:W[0])??null)},className:"hidden"}),e.jsx("input",{ref:B,type:"file",accept:"image/*,application/pdf",onChange:O=>{var W;return J(((W=O.target.files)==null?void 0:W[0])??null)},className:"hidden"})]})]}),p&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("img",{src:p,alt:"Anteprima",className:"w-full h-40 object-cover rounded"}),e.jsx("div",{className:"mt-2 text-right",children:e.jsx("button",{onClick:()=>J(null),className:"text-sm text-red-400",children:"Rimuovi immagine"})})]}),e.jsxs("div",{className:"sm:col-span-2 flex flex-col sm:flex-row gap-3 mt-3",children:[e.jsx("button",{onClick:L,disabled:g,className:"w-full sm:w-auto flex-1 py-3 rounded bg-green-600 text-white text-sm",children:g?"Invio...":"Invia Nota Spesa"}),e.jsx("button",{onClick:()=>S(!1),className:"w-full sm:w-auto px-4 py-3 rounded border border-gray-700 text-sm",children:"Annulla"})]})]})]})})]})};function _d(n){return Math.floor(n/30)*30}function ti(n){const l=Math.round(n*60);return _d(l)/60}function ir(n){const l=Math.floor(n/60),c=n%60;return l===0&&c===0?"0min":l===0?`${c}min`:c===0?`${l}h`:`${l}h ${c}min`}function Zs(n){return Math.round(n*60)}const vd=()=>{const{user:n}=Pt(),{showSuccess:l,showError:c}=us(),[u,f]=w.useState(!0),[x,b]=w.useState(!1),[v,S]=w.useState(null),[g,j]=w.useState([]),[p,M]=w.useState(null),[B,k]=w.useState(!1),[R,C]=w.useState(0),[D,E]=w.useState(0),[U,q]=w.useState(""),[J,N]=w.useState(!1);w.useEffect(()=>{if(!(n!=null&&n.id)){f(!1);return}(async()=>{f(!0);try{await Promise.all([_(),K()])}catch(G){console.error("init straordinari error",G)}finally{f(!1)}})()},[n==null?void 0:n.id]);async function _(){try{const{data:G}=await je.from("crew_assegnazionetariffa").select("tariffe_ids").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0);if(G&&G.length>0){const $=[];if(G.forEach(F=>{F.tariffe_ids&&F.tariffe_ids.length>0&&$.push(...F.tariffe_ids)}),$.length>0){const{data:F}=await je.from("crew_tariffe").select("tipo_calcolo, categoria").in("id",$).eq("attivo",!0);if(F&&F.length>0&&F.some(_e=>{var ge,X;return((ge=_e.tipo_calcolo)==null?void 0:ge.includes("straordinario"))||((X=_e.categoria)==null?void 0:X.includes("straordinario"))}))return S(!0),!0}}}catch(G){console.error("Error checking overtime authorization via tariffe",G)}try{const{data:G}=await je.from("crew_members").select("benefit_straordinari").eq("id",n==null?void 0:n.id).maybeSingle();if(G&&G.benefit_straordinari)return S(!0),!0}catch{}try{const{data:G}=await je.from("registration_requests").select("benefit_straordinari").eq("auth_user_id",n==null?void 0:n.id).maybeSingle();if(G&&G.benefit_straordinari)return S(!0),!0}catch{}return S(!1),!1}function L(G){if(!G)return null;const $=new Date(G);return isNaN($.getTime())?null:$}function I(G,$){const F=L(G),re=L($);if(!F||!re)return null;const _e=re.getTime()-F.getTime();return Math.round(_e/(1e3*60*60)*100)/100}async function K(){if(!(n!=null&&n.id))return[];const G=[];let $=[];try{const{data:F}=await je.from("richieste_straordinari_v2").select("turno_id").eq("crewid",n.id).not("turno_id","is",null);F&&F.length>0&&($=F.map(re=>re.turno_id).filter(re=>re!==null))}catch(F){console.warn("Failed to load existing overtime requests",F)}try{const{data:F}=await je.from("warehouse_checkins").select(`
          id,
          date,
          check_in_time,
          check_out_time,
          net_hours,
          overtime_hours,
          "oraro in eccesso",
          shift_id,
          assegnazione_id,
          notes
        `).eq("crew_id",n.id).eq("requisito_straordinari",!0).order("date",{ascending:!1}).limit(100);for(const re of F||[])try{let _e=0;if(re.overtime_hours)_e=Number(re.overtime_hours);else if(re["oraro in eccesso"]){const pe=re["oraro in eccesso"].match(/(\d+):(\d+):(\d+)/);if(pe){const me=parseInt(pe[1],10),Q=parseInt(pe[2],10);_e=me+Q/60}}const ge=ti(_e);if(ge>0){const X=re.net_hours?Number(re.net_hours):null,pe=X?Math.round((X-_e)*100)/100:8;let me=re.assegnazione_id;if(!me&&re.shift_id&&re.date)try{const{data:Q}=await je.from("crew_assegnazione_turni").select("id").eq("dipendente_id",n.id).eq("turno_id",re.shift_id).eq("data_turno",re.date).maybeSingle();Q?(me=Q.id,console.log("Found assignment via fallback:",me)):console.warn("No assignment found for shift",{shift_id:re.shift_id,date:re.date,user_id:n.id})}catch(Q){console.warn("Failed to find assignment for shift",re.id,Q)}if(console.log("Final assignmentId for shift:",{shift_id:re.id,date:re.date,assignmentId:me}),me&&$.includes(me)){console.log("Skipping shift - already requested:",me);continue}G.push({source:"warehouse",assignment_id:me||re.shift_id||re.id,refShiftId:me,date:re.date,title:`Turno Magazzino ${re.date}`,scheduledHours:pe,workedHours:X||pe+_e,excessHours:Math.round(_e*100)/100,requestableHours:Math.round(ge*100)/100,raw:re})}}catch(_e){console.warn("Error processing overtime shift",re,_e);continue}}catch(F){console.warn("Failed to load warehouse overtime shifts",F)}try{const{data:F}=await je.from("timesheet_entries").select("id, event_id, start_time, end_time, date").eq("crew_id",n.id).order("date",{ascending:!1}).limit(500);if(F)for(const re of F)try{const _e=I(re.start_time,re.end_time);if(!_e||!re.event_id)continue;const{data:ge}=await je.from("crew_events").select("*").eq("id",re.event_id).maybeSingle();let X=null;ge&&(ge.durata_ore?X=Number(ge.durata_ore):ge.duration_hours?X=Number(ge.duration_hours):ge.start_time&&ge.end_time&&(X=I(ge.start_time,ge.end_time))),X||(X=8);const pe=Math.round(Math.max(0,_e-X)*100)/100,me=ti(pe);me>0&&G.push({source:"event",assignment_id:re.id,refEventId:re.event_id,date:re.date??null,title:ge&&(ge.title||ge.name)||`Evento ${re.event_id}`,scheduledHours:X,workedHours:Math.round(_e*100)/100,excessHours:pe,requestableHours:Math.round(me*100)/100,raw:{timesheet:re,event:ge}})}catch{}}catch(F){console.warn("timesheet_entries load failed",F)}return G.sort((F,re)=>{if(re.requestableHours!==F.requestableHours)return re.requestableHours-F.requestableHours;const _e=F.date?new Date(F.date).getTime():0;return(re.date?new Date(re.date).getTime():0)-_e}),j(G),G}async function O(G){if(!(n!=null&&n.id)){c("Utente non autenticato");return}const $=R*60+D;if($<=0){c("Inserisci almeno 30 minuti di straordinario");return}if($%30!==0){c("Le ore straordinarie devono essere richieste con tagli di 30 minuti");return}if(G){const re=Zs(G.requestableHours);if($>re){const _e=ir(re);c(`Puoi richiedere al massimo ${_e} per questo turno`);return}}if(!v){c("Non sei autorizzato agli straordinari");return}const F=$/60;N(!0);try{const re={crewid:n.id,ore_straordinario:F,note:U||null,status:"in_attesa"};G&&(console.log("Shift data before insert:",{source:G.source,refShiftId:G.refShiftId,refEventId:G.refEventId,assignment_id:G.assignment_id}),G.source==="warehouse"&&G.refShiftId&&(re.turno_id=G.refShiftId,console.log("Added turno_id to payload:",G.refShiftId)),G.source==="event"&&G.refEventId&&(re.event_id=G.refEventId,console.log("Added event_id to payload:",G.refEventId))),console.log("Final payload before insert:",re);const{error:_e}=await je.from("richieste_straordinari_v2").insert(re);if(_e)throw console.error("Insert to richieste_straordinari_v2 failed",_e),_e;l("Richiesta straordinario inviata"),M(null),k(!1),C(0),E(0),q(""),await K()}catch(re){console.error("handleRequestSubmit",re),c((re==null?void 0:re.message)||"Errore invio richiesta straordinario")}finally{N(!1)}}async function W(){b(!0);try{await Promise.all([_(),K()]),l("Aggiornato")}catch(G){console.error("refresh straordinari error",G),c("Errore aggiornamento")}finally{b(!1)}}const se=G=>{if(M(G??null),G){const $=Zs(G.requestableHours),F=Math.floor($/60),re=$%60;C(F),E(re)}else C(0),E(0)};return e.jsxs("div",{className:"bg-gray-900 p-4 rounded border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Richieste Straordinari"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Richiedi straordinario se autorizzato e se hai lavorato oltre le ore assegnate"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:W,className:"p-2 rounded bg-gray-800 hover:bg-gray-700",title:"Aggiorna",children:e.jsx(Ds,{})})})]}),e.jsx("div",{className:"mb-4",children:v===null?e.jsx("div",{className:"text-sm text-gray-400",children:"Verifica autorizzazione..."}):v===!1?e.jsx("div",{className:"text-sm text-red-300",children:"Non risulti autorizzato agli straordinari dal tuo contratto."}):e.jsx("div",{className:"text-sm text-green-300",children:"Sei autorizzato agli straordinari."})}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Turni con ore eccedenti"}),u?e.jsx("div",{className:"text-sm text-gray-400",children:"Caricamento..."}):g.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"Nessun turno con ore eccedenti rilevato."}):e.jsx("div",{className:"space-y-3",children:g.map(G=>e.jsxs("div",{className:"bg-gray-800 p-3 rounded border border-gray-700 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:G.title}),e.jsx("div",{className:"text-sm text-gray-300",children:G.date?new Date(G.date).toLocaleDateString("it-IT"):"-"}),e.jsxs("div",{className:"text-sm text-gray-300 mt-2",children:["Previsto: ",ir(Zs(G.scheduledHours))," ‚Ä¢ Lavorato: ",ir(Zs(G.workedHours))]}),e.jsxs("div",{className:"text-sm font-semibold text-yellow-400 mt-1",children:["Richiedibili: ",ir(Zs(G.requestableHours)),G.excessHours!==G.requestableHours&&e.jsxs("span",{className:"text-xs text-gray-400 ml-1",children:["(su ",ir(Zs(G.excessHours))," effettivi)"]})]})]}),e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx("button",{onClick:()=>se(G),className:"py-2 px-3 rounded bg-yellow-600 text-black mb-2",children:"Richiedi"}),e.jsxs("div",{className:"text-xs text-gray-400",children:["Fonte: ",G.source==="warehouse"?"Magazzino":"Evento"]})]})]},G.assignment_id))})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Richiesta manuale"}),e.jsx("p",{className:"text-sm text-gray-400 mb-2",children:"Se non vedi il turno ma sei autorizzato, puoi creare una richiesta manuale (ammessa solo se autorizzato)."}),e.jsx("div",{className:"flex gap-3",children:e.jsx("button",{onClick:()=>{k(!0),se(void 0)},className:"py-2 px-3 rounded bg-blue-600 text-white",children:"Crea richiesta manuale"})})]}),(p!==null||B)&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4",children:e.jsxs("div",{className:"w-full max-w-lg bg-gray-900 rounded p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:B?"Richiesta Straordinario (manuale)":`Richiesta per ${p==null?void 0:p.title}`}),e.jsx("button",{onClick:()=>{M(null),k(!1),C(0),E(0),q("")},className:"text-gray-400",children:"Chiudi"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[!B&&p&&e.jsxs("div",{className:"bg-yellow-900/20 border border-yellow-600/30 rounded p-3 mb-2",children:[e.jsxs("div",{className:"text-sm text-yellow-400 font-semibold",children:["Massimo richiedibile: ",ir(Zs(p.requestableHours))]}),p.excessHours!==p.requestableHours&&e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["Ore effettive: ",ir(Zs(p.excessHours))," (arrotondato a multipli di 30 min)"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300 mb-2 block",children:"Ore e minuti da richiedere (tagli di 30 minuti)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-400 mb-1 block",children:"Ore"}),e.jsx("input",{type:"number",min:"0",max:p?Math.floor(Zs(p.requestableHours)/60):24,value:R,onChange:G=>C(parseInt(G.target.value)||0),className:"w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-center text-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-400 mb-1 block",children:"Minuti"}),e.jsxs("select",{value:D,onChange:G=>E(parseInt(G.target.value)),className:"w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-center text-lg",children:[e.jsx("option",{value:"0",children:"00"}),e.jsx("option",{value:"30",children:"30"})]})]})]}),e.jsxs("div",{className:"text-xs text-gray-400 mt-2 text-center",children:["Totale: ",ir(R*60+D)]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Note"}),e.jsx("textarea",{value:U,onChange:G=>q(G.target.value),rows:3,placeholder:"Descrivi il motivo della richiesta...",className:"mt-1 w-full bg-gray-800 border border-gray-700 rounded px-2 py-2"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>O(p??void 0),disabled:J,className:"flex-1 py-3 rounded bg-yellow-600 text-black",children:J?"Invio...":"Invia richiesta"}),e.jsx("button",{onClick:()=>{M(null),k(!1)},className:"px-4 py-3 rounded border border-gray-700",children:"Annulla"})]})]})]})})]})},fa=n=>n?new Date(n).toLocaleDateString("it-IT"):"-",Nd=()=>{const{user:n}=Pt(),{showError:l}=us(),[c,u]=w.useState(!0),[f,x]=w.useState([]),[b,v]=w.useState(""),[S,g]=w.useState(""),[j,p]=w.useState("");w.useEffect(()=>{if(!(n!=null&&n.id)){u(!1);return}M().catch(E=>{console.error("loadAll error",E),l("Errore caricamento riepilogo")})},[n==null?void 0:n.id]);async function M(){u(!0);try{const[E,U,q]=await Promise.all([B().catch(N=>(console.warn("loadVacations failed",N),[])),k().catch(N=>(console.warn("loadExpenses failed",N),[])),R().catch(N=>(console.warn("loadStraordinari failed (maybe table missing)",N),[]))]),J=[...E,...U,...q].sort((N,_)=>{const L=N.dateForFilter?new Date(N.dateForFilter).getTime():0;return(_.dateForFilter?new Date(_.dateForFilter).getTime():0)-L});x(J)}finally{u(!1)}}async function B(){if(!(n!=null&&n.id))return[];const E=[];try{const{data:U,error:q}=await je.from("crew_richiesteferie_permessi").select("*").eq("dipendente_id",n.id).order("created_at",{ascending:!1}).limit(1e3);if(q)throw q;return(U||[]).forEach(J=>{E.push({id:String(J.id),kind:"vacation",title:J.tipo_richiesta??"Ferie/Permesso",start_date:J.data_inizio??J.start_date??null,end_date:J.data_fine??J.end_date??null,days:J.giorni_richiesti??null,status:J.stato??null,raw:J,dateForFilter:J.data_inizio??J.start_date??J.created_at??null})}),E}catch(U){throw console.error("loadVacations error",U),U}}async function k(){if(!(n!=null&&n.id))return[];const E=[];try{const{data:U,error:q}=await je.from("expenses").select("*").eq("crew_id",n.id).order("expense_date",{ascending:!1}).limit(1e3);if(q)throw q;return(U||[]).forEach(J=>{E.push({id:String(J.id),kind:"expense",title:J.category??"Spesa",amount:Number(J.amount??0),expense_date:J.expense_date??null,status:J.status??null,raw:J,dateForFilter:J.expense_date??J.submitted_at??null})}),E}catch(U){throw console.error("loadExpenses error",U),U}}async function R(){if(!(n!=null&&n.id))return[];const E=["crew_richieste_straordinari","crew_straordinari","straordinari"];for(const U of E)try{const{data:q,error:J}=await je.from(U).select("*").eq("dipendente_id",n.id).limit(1e3);if(J){console.warn(`loadStraordinari: table ${U} query error`,J);continue}if(!q)continue;return q.map(N=>({id:String(N.id),kind:"straordinario",title:N.tipo??N.title??"Straordinario",date:N.data??N.date??N.created_at??null,hours:N.ore??N.hours??null,status:N.stato??N.status??null,raw:N,dateForFilter:N.data??N.date??N.created_at??null}))}catch(q){console.warn(`loadStraordinari: table ${U} fetch failed`,q);continue}return[]}function C(E){var U,q,J,N,_,L,I,K;if(b&&(!E.dateForFilter||new Date(E.dateForFilter)<new Date(b)))return!1;if(S){if(!E.dateForFilter)return!1;const O=new Date(E.dateForFilter),W=new Date(S);if(W.setHours(23,59,59,999),O>W)return!1}if(j){const O=j.toLowerCase(),W=[];if(E.kind==="vacation"?W.push(E.title,String(((U=E.raw)==null?void 0:U.motivo)??""),String(((q=E.raw)==null?void 0:q.azienda_id)??""),String(((J=E.raw)==null?void 0:J.event_title)??"")):E.kind==="expense"?W.push(E.title,String(((N=E.raw)==null?void 0:N.description)??""),String(((_=E.raw)==null?void 0:_.notes)??""),String(((L=E.raw)==null?void 0:L.company_name)??"")):W.push(E.title,String(((I=E.raw)==null?void 0:I.motivo)??""),String(((K=E.raw)==null?void 0:K.description)??"")),!W.filter(Boolean).join(" ").toLowerCase().includes(O))return!1}return!0}const D=f.filter(C);return e.jsxs("div",{className:"bg-gray-900 p-4 rounded border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Riepilogo Richieste"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Visualizza tutte le tue richieste: ferie, note spese e straordinari"})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("button",{title:"Aggiorna",onClick:()=>M().catch(E=>console.error(E)),className:"p-2 rounded bg-gray-800 hover:bg-gray-700",children:e.jsx(Ds,{})})})]}),e.jsxs("div",{className:"bg-gray-800 p-3 rounded mb-4 grid grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Da"}),e.jsx("input",{type:"date",value:b,onChange:E=>v(E.target.value),className:"mt-1 w-full bg-gray-900 border border-gray-700 rounded px-2 py-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"A"}),e.jsx("input",{type:"date",value:S,onChange:E=>g(E.target.value),className:"mt-1 w-full bg-gray-900 border border-gray-700 rounded px-2 py-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Cerca"}),e.jsx("input",{type:"text",placeholder:"Evento, descrizione...",value:j,onChange:E=>p(E.target.value),className:"mt-1 w-full bg-gray-900 border border-gray-700 rounded px-2 py-1"})]})]}),e.jsx("div",{children:c?e.jsx("div",{className:"text-sm text-gray-400",children:"Caricamento..."}):D.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"Nessuna richiesta trovata"}):e.jsx("div",{className:"space-y-3",children:D.map(E=>{var U,q,J;return e.jsxs("div",{className:"bg-gray-800 p-3 rounded border border-gray-700 flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-sm px-2 py-1 rounded-full bg-gray-700 text-gray-200 font-medium",children:E.kind.toUpperCase()}),e.jsx("div",{className:"font-medium text-white",children:E.title})]}),E.kind==="vacation"&&e.jsxs("div",{className:"text-sm text-gray-300 mt-2",children:[fa(E.start_date),E.end_date?` ‚Äî ${fa(E.end_date)}`:""," ",E.days?` ‚Ä¢ ${E.days} giorno/i`:"",(U=E.raw)!=null&&U.motivo?e.jsxs("div",{className:"mt-1",children:["Motivo: ",String(E.raw.motivo)]}):null]}),E.kind==="expense"&&e.jsxs("div",{className:"text-sm text-gray-300 mt-2",children:[E.amount!==void 0?e.jsxs(e.Fragment,{children:["‚Ç¨",Number(E.amount).toFixed(2)," ‚Ä¢ "]}):null,fa(E.expense_date)," ‚Ä¢ ",String(((q=E.raw)==null?void 0:q.description)??"")]}),E.kind==="straordinario"&&e.jsxs("div",{className:"text-sm text-gray-300 mt-2",children:[fa(E.date)," ",E.hours?`‚Ä¢ ${E.hours}h`:null,(J=E.raw)!=null&&J.motivo?e.jsxs("div",{className:"mt-1",children:["Motivo: ",String(E.raw.motivo)]}):null]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:`text-xs px-2 py-1 rounded-full ${E.status==="approved"?"bg-green-100 text-green-800":E.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:E.status==="approved"?"Approvato":E.status==="rejected"?"Rifiutato":E.status??"In attesa"}),e.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["ID: ",E.id]})]})]},`${E.kind}_${E.id}`)})})})]})},si=[{key:"ferie",label:"Ferie",Icon:ut},{key:"spese",label:"Spese",Icon:Ht},{key:"straordinari",label:"Ore",Icon:ct},{key:"riepilogo",label:"Riepilogo",Icon:po}],jd=()=>{const[n,l]=w.useState("ferie");return w.useEffect(()=>{window.scrollTo({top:0,behavior:"smooth"})},[n]),e.jsxs("div",{className:"min-h-screen bg-neutral-950 text-gray-100",children:[e.jsxs("header",{className:"sticky top-0 z-40 bg-gray-900/95 backdrop-blur-sm border-b border-gray-800",children:[e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-3 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg md:text-2xl font-semibold leading-tight",children:"Richieste"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-400 mt-0.5",children:"Gestisci ferie, note spese, straordinari e riepiloghi"})]}),e.jsx("div",{className:"hidden md:flex items-center space-x-2",children:e.jsx("div",{className:"text-sm text-gray-400",children:" "})})]}),e.jsx("nav",{className:"overflow-x-auto no-scrollbar",children:e.jsx("div",{className:"max-w-4xl mx-auto px-2 py-2 flex items-center space-x-2",children:si.map(c=>{const u=n===c.key;return e.jsxs("button",{onClick:()=>l(c.key),className:`flex-shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium transition-all ${u?"bg-gradient-to-r from-blue-600 to-cyan-500 text-white shadow":"bg-gray-800 text-gray-200"}`,"aria-pressed":u,children:[e.jsx(c.Icon,{className:"h-4 w-4"}),e.jsx("span",{className:"whitespace-nowrap",children:c.label})]},c.key)})})})]}),e.jsx("main",{className:"pb-28 md:pb-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 md:px-6 pt-4 space-y-6",children:[n==="ferie"&&e.jsx("section",{children:e.jsx(bd,{})}),n==="spese"&&e.jsx("section",{children:e.jsx(yd,{})}),n==="straordinari"&&e.jsx("section",{children:e.jsx(vd,{})}),n==="riepilogo"&&e.jsx("section",{children:e.jsx(Nd,{})})]})}),e.jsx("nav",{className:"fixed bottom-0 left-0 right-0 z-50 md:hidden bg-gray-900 border-t border-gray-800",children:e.jsx("div",{className:"max-w-4xl mx-auto px-2",children:e.jsx("div",{className:"flex justify-between items-center",children:si.map(c=>{const u=n===c.key;return e.jsxs("button",{onClick:()=>l(c.key),className:`w-full py-3 flex flex-col items-center text-xs ${u?"text-white":"text-gray-400"} focus:outline-none`,"aria-pressed":u,children:[e.jsx(c.Icon,{className:"h-5 w-5"}),e.jsx("span",{className:"mt-1",children:c.label})]},c.key)})})})})]})},Cd="https://idewdhvmcyhpgvpmkefd.supabase.co",Ed="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkZXdkaHZtY3locGd2cG1rZWZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU1ODgxNDMsImV4cCI6MjA1MTE2NDE0M30.RAIBKUjHAbx_a5_KUvs-Loc2hNd6SU6etOEczz4-moQ";let $a=null;function Sd(){return $a||($a=ri(Cd,Ed,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,flowType:"pkce",storageKey:"company-app-auth",storage:window.localStorage}})),$a}const Le=Sd(),Vi=w.createContext(void 0),Ad=({children:n})=>{const[l,c]=w.useState(null),[u,f]=w.useState(null),[x,b]=w.useState(!0);w.useEffect(()=>{Le.auth.getSession().then(({data:{session:p}})=>{c((p==null?void 0:p.user)??null),p!=null&&p.user?v(p.user.id):b(!1)});const{data:{subscription:j}}=Le.auth.onAuthStateChange((p,M)=>{c((M==null?void 0:M.user)??null),M!=null&&M.user?v(M.user.id):(f(null),b(!1))});return()=>j.unsubscribe()},[]);const v=async j=>{try{const{data:p,error:M}=await Le.from("registration_requests").select("parent_company_id").eq("auth_user_id",j).maybeSingle();if(!M&&p&&p.parent_company_id)throw console.error("‚ùå L'utente √® un dipendente, non un'azienda"),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("EMPLOYEE_LOGIN");const{data:B,error:k}=await Le.from("regaziendasoftware").select("*").eq("auth_user_id",j).maybeSingle();if(k)throw k;if(!B)throw setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("Accesso non autorizzato. Solo aziende possono accedere.");const{data:R,error:C}=await Le.from("azienda_software").select("data_scadenza, stato").eq("auth_user_id",j).eq("software_codice","app_crew_azienda").maybeSingle();if(!C&&R){if(R.stato!=="attivo")throw console.error("‚ùå Abbonamento non attivo. Stato:",R.stato),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("SUBSCRIPTION_INACTIVE");if(R.data_scadenza){const D=new Date(R.data_scadenza),E=new Date;if(E.setHours(0,0,0,0),D.setHours(0,0,0,0),E>D)throw console.error("‚ùå Abbonamento scaduto il:",D.toLocaleDateString()),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("SUBSCRIPTION_EXPIRED")}}if(B.password_scadenza){const D=new Date(B.password_scadenza);if(new Date>D)throw console.error("‚ùå Password scaduta:",D),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("PASSWORD_EXPIRED")}console.log("‚úÖ Azienda verificata:",B.ragione_sociale),f(B)}catch(p){throw console.error("Error loading company profile:",p),f(null),p}finally{b(!1)}},S=async(j,p)=>{try{console.log("üîë Tentativo login azienda per:",j);const{data:M,error:B}=await Le.auth.signInWithPassword({email:j,password:p});if(B)throw console.error("‚ùå Errore autenticazione:",B.message),B;if(!M.user)throw new Error("Dati utente non validi");console.log("‚úÖ Login Supabase riuscito per:",M.user.email);const{data:k,error:R}=await Le.from("registration_requests").select("parent_company_id").eq("auth_user_id",M.user.id).maybeSingle();if(!R&&k&&k.parent_company_id)throw console.error("‚ùå L'utente √® un dipendente, non un'azienda"),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("EMPLOYEE_LOGIN");const{data:C,error:D}=await Le.from("regaziendasoftware").select("*").eq("auth_user_id",M.user.id).maybeSingle();if(D)throw D;if(!C)throw console.error("‚ùå Profilo azienda non trovato"),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("Accesso non autorizzato. Solo aziende possono accedere.");const{data:E,error:U}=await Le.from("azienda_software").select("data_scadenza, stato").eq("auth_user_id",M.user.id).eq("software_codice","app_crew_azienda").maybeSingle();if(!U&&E){if(E.stato!=="attivo")throw console.error("‚ùå Abbonamento non attivo. Stato:",E.stato),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("SUBSCRIPTION_INACTIVE");if(E.data_scadenza){const q=new Date(E.data_scadenza),J=new Date;if(J.setHours(0,0,0,0),q.setHours(0,0,0,0),J>q)throw console.error("‚ùå Abbonamento scaduto il:",q.toLocaleDateString()),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("SUBSCRIPTION_EXPIRED")}}if(C.password_scadenza){const q=new Date(C.password_scadenza);if(new Date>q)throw console.error("‚ùå Password scaduta:",q),setTimeout(async()=>{await Le.auth.signOut()},3e3),new Error("PASSWORD_EXPIRED")}console.log("‚úÖ Azienda verificata:",C.ragione_sociale)}catch(M){throw console.error("Login error:",M),M}},g=async()=>{try{const{error:j}=await Le.auth.signOut();if(j)throw j;f(null)}catch(j){throw console.error("Errore durante il logout:",j),f(null),c(null),j}};return e.jsx(Vi.Provider,{value:{user:l,companyProfile:u,loading:x,signIn:S,signOut:g},children:n})},ds=()=>{const n=w.useContext(Vi);if(n===void 0)throw new Error("useCompanyAuth must be used within a CompanyAuthProvider");return n},qi=w.createContext(void 0),Id=({children:n})=>{const[l,c]=w.useState([]),u=w.useCallback((g,j)=>{const p=Math.random().toString(36).substring(7);c(M=>[...M,{id:p,message:g,type:j}]),setTimeout(()=>f(p),5e3)},[]),f=w.useCallback(g=>{c(j=>j.filter(p=>p.id!==g))},[]),x=w.useCallback(g=>{u(g,"success")},[u]),b=w.useCallback(g=>{u(g,"error")},[u]),v=w.useCallback(g=>{u(g,"info")},[u]),S=w.useCallback(g=>{u(g,"warning")},[u]);return e.jsx(qi.Provider,{value:{toasts:l,addToast:u,removeToast:f,showSuccess:x,showError:b,showInfo:v,showWarning:S},children:n})},zr=()=>{const n=w.useContext(qi);if(n===void 0)throw new Error("useToast must be used within a ToastProvider");return n},Or=zr,Td=({toast:n,onRemove:l})=>{w.useEffect(()=>{const x=setTimeout(()=>{l(n.id)},n.duration||5e3);return()=>clearTimeout(x)},[n.id,n.duration,l]);const c=()=>{switch(n.type){case"success":return e.jsx(ft,{className:"h-7 w-7 text-green-500"});case"error":return e.jsx(sn,{className:"h-7 w-7 text-red-500"});case"warning":return e.jsx(Zt,{className:"h-7 w-7 text-yellow-500"});case"info":return e.jsx(pa,{className:"h-7 w-7 text-blue-500"});default:return e.jsx(pa,{className:"h-7 w-7 text-blue-500"})}},u=()=>{switch(n.type){case"success":return"bg-white border-green-300 shadow-green-100";case"error":return"bg-white border-red-300 shadow-red-100";case"warning":return"bg-white border-yellow-300 shadow-yellow-100";case"info":return"bg-white border-blue-300 shadow-blue-100";default:return"bg-white border-blue-300 shadow-blue-100"}},f=()=>{switch(n.type){case"success":return"text-green-700";case"error":return"text-red-700";case"warning":return"text-yellow-700";case"info":return"text-blue-700";default:return"text-blue-700"}};return e.jsx("div",{className:`min-w-96 max-w-lg w-full border-2 rounded-xl shadow-2xl pointer-events-auto ${u()} mx-auto transform transition-all duration-300 ease-out`,children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0",children:c()}),e.jsxs("div",{className:"ml-4 w-0 flex-1",children:[e.jsx("p",{className:`text-lg font-semibold ${f()} leading-tight`,children:n.title}),n.message&&e.jsx("p",{className:`mt-3 text-base ${f()} opacity-90 leading-relaxed`,children:n.message})]}),e.jsx("div",{className:"ml-4 flex-shrink-0 flex",children:e.jsxs("button",{className:`rounded-full inline-flex ${f()} hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 p-2 transition-all duration-200 hover:bg-white hover:bg-opacity-20`,onClick:()=>l(n.id),children:[e.jsx("span",{className:"sr-only",children:"Chiudi"}),e.jsx(jt,{className:"h-5 w-5"})]})})]})})})},Dd=({toasts:n,onRemoveToast:l})=>e.jsx("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 space-y-4 pointer-events-none",children:n.map(c=>e.jsx("div",{className:"transform transition-all duration-300 ease-in-out pointer-events-auto",children:e.jsx(Td,{toast:c,onRemove:l})},c.id))}),kd=()=>{const[n,l]=w.useState(""),[c,u]=w.useState(""),[f,x]=w.useState(!1),[b,v]=w.useState("1.0.0"),[S,g]=w.useState("Dicembre 2025"),{signIn:j}=ds(),{addToast:p}=zr(),M=k=>{const R=new Date(k),D=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][R.getMonth()],E=R.getFullYear();return`${D} ${E}`};w.useEffect(()=>{(async()=>{try{const{data:R,error:C}=await Le.from("software_versions").select("current_version, release_date").eq("software_code","app_crew_azienda").eq("is_active",!0).order("release_date",{ascending:!1}).limit(1).maybeSingle();R&&!C&&(v(R.current_version),g(M(R.release_date)))}catch(R){console.error("Errore caricamento versione:",R)}})()},[]);const B=async k=>{k.preventDefault(),x(!0);try{await j(n,c),p("Accesso effettuato con successo","success")}catch(R){console.error("Errore login azienda:",R);let C="Errore durante l'accesso";R.message==="EMPLOYEE_LOGIN"?C="Accesso negato. Sei un dipendente, usa l'App Dipendenti per accedere.":R.message==="SUBSCRIPTION_EXPIRED"?C="Abbonamento scaduto. Contatta l'amministratore per rinnovare.":R.message==="SUBSCRIPTION_INACTIVE"?C="Abbonamento non attivo. Contatta l'amministratore.":R.message==="PASSWORD_EXPIRED"?C="Password scaduta. Contatta l'amministratore per reimpostarla.":R.message&&(C=R.message),p(C,"error")}finally{x(!1)}};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-cyan-100 flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white rounded-2xl shadow-xl p-8",children:[e.jsxs(Ii,{to:"/",className:"inline-flex items-center text-sm text-gray-600 hover:text-blue-600 mb-6 transition-colors",children:[e.jsx(bo,{className:"w-4 h-4 mr-1"}),"Torna al login dipendenti"]}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-full mb-4",children:e.jsx(zt,{className:"w-8 h-8 text-white"})}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Crew Manager"}),e.jsx("p",{className:"text-gray-600",children:"Pannello Azienda"})]}),e.jsxs("form",{onSubmit:B,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-2",children:"Email Aziendale"}),e.jsxs("div",{className:"relative",children:[e.jsx(wa,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{id:"email",type:"email",value:n,onChange:k=>l(k.target.value),required:!0,className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"azienda@esempio.it"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-2",children:"Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(ii,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{id:"password",type:"password",value:c,onChange:k=>u(k.target.value),required:!0,className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"})]})]}),e.jsx("button",{type:"submit",disabled:f,className:"w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-colors",children:f?"Accesso in corso...":e.jsxs(e.Fragment,{children:[e.jsx(ai,{className:"w-5 h-5"}),"Accedi"]})})]}),e.jsx("div",{className:"mt-6 text-center text-sm text-gray-600",children:e.jsx("p",{children:"Solo per aziende registrate"})}),e.jsxs("div",{className:"mt-6 pt-4 border-t border-gray-200 text-center",children:[e.jsxs("p",{className:"text-xs text-gray-500",children:["Versione ",b," - ",S]}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"¬© 2025 ControlStage - Crew Manager Azienda"})]})]})})},Md=()=>{const[n,l]=w.useState({currentVersion:null,latestVersion:null,releaseNotes:null,hasUpdate:!1,isLoading:!1,isUpdating:!1,error:null}),[c,u]=w.useState(0),f=5*60*1e3,x=w.useCallback(()=>{const M=new URLSearchParams(window.location.search).get("_v");return M?(localStorage.setItem("app_crew_azienda_version",M),M):localStorage.getItem("app_crew_azienda_version")},[]),b=w.useCallback(()=>new URLSearchParams(window.location.search).get("_updated")==="true",[]),v=w.useCallback(async()=>{try{console.log("üîç Controllo versione da database per software_code: app_crew_azienda");const{data:p,error:M}=await Le.from("software_versions").select("*").eq("software_code","app_crew_azienda").eq("is_active",!0).order("release_date",{ascending:!1}).limit(1).maybeSingle();return M?(console.error("‚ùå Errore caricamento versione da database:",M),await S()):p?(console.log("‚úÖ Versione caricata da database:",p.current_version),{version:p.current_version,buildTimestamp:p.release_date,features:Array.isArray(p.features)?p.features:[],releaseNotes:p.release_notes||"",description:p.description||""}):(console.warn("‚ö†Ô∏è Nessuna versione attiva trovata nel database per app_crew_azienda"),await S())}catch(p){return console.error("‚ùå Errore generale nel controllo versione database:",p),await S()}},[]),S=w.useCallback(async()=>{try{console.log("üìÑ Fallback: caricamento versione da file statico");const p=Date.now(),M=await fetch(`/version.json?_t=${p}`,{method:"GET",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}});if(!M.ok)throw new Error(`HTTP ${M.status}: ${M.statusText}`);const B=await M.json();return console.log("‚úÖ Versione caricata da file statico:",B.version),B}catch(p){return console.error("‚ùå Errore nel fetch versione da file:",p),null}},[]),g=w.useCallback(async(p=!1)=>{const M=Date.now();if(!p&&M-c<f||n.isLoading||n.isUpdating)return!1;l(B=>({...B,isLoading:!0,error:null})),u(M);try{const B=x(),k=await v();if(!k)return l(C=>({...C,isLoading:!1,error:"Impossibile verificare aggiornamenti"})),!1;const R=B!==k.version;return l(C=>({...C,currentVersion:B,latestVersion:k.version,releaseNotes:k.releaseNotes||null,hasUpdate:R,isLoading:!1,error:null})),console.log("üîç Controllo versione:",{current:B,latest:k.version,hasUpdate:R,buildTime:k.buildTimestamp}),R}catch(B){return console.error("Errore nel controllo versioni:",B),l(k=>({...k,isLoading:!1,error:"Errore controllo versioni"})),!1}},[x,v,c,n.isLoading,n.isUpdating,f]),j=w.useCallback(async()=>{if(!(n.isUpdating||!n.hasUpdate)){l(p=>({...p,isUpdating:!0}));try{if(console.log("üîÑ Applicazione aggiornamento..."),"caches"in window){const B=await caches.keys();await Promise.all(B.map(k=>caches.delete(k))),console.log("üóëÔ∏è Cache cancellate:",B.length)}n.latestVersion&&(localStorage.setItem("app_crew_azienda_version",n.latestVersion),localStorage.setItem("app_crew_azienda_last_update",new Date().toISOString()));const p=Date.now(),M=new URL(window.location.href);M.searchParams.set("_v",n.latestVersion||""),M.searchParams.set("_t",p.toString()),M.searchParams.set("_updated","true"),console.log("üöÄ Reindirizzamento a:",M.toString()),window.location.href=M.toString()}catch(p){console.error("Errore nell'applicazione aggiornamento:",p),l(M=>({...M,isUpdating:!1,error:"Errore durante aggiornamento"}))}}},[n.isUpdating,n.hasUpdate,n.latestVersion]);return w.useEffect(()=>{(async()=>{let B=x();if(B)l(k=>({...k,currentVersion:B}));else{const k=await v();k&&(B=k.version,localStorage.setItem("app_crew_azienda_version",B),l(R=>({...R,currentVersion:B,latestVersion:B,hasUpdate:!1})))}})(),b()||(async()=>(await new Promise(k=>setTimeout(k,2e3)),await g(!1)))();const M=()=>{g(!1)};return window.addEventListener("focus",M),()=>{window.removeEventListener("focus",M)}},[g,x,b,v]),{...n,checkForUpdates:p=>g(p||!1),applyUpdate:j}},zd=({currentVersion:n,hasUpdate:l,isLoading:c,isUpdating:u,onCheckUpdate:f})=>{const x=()=>u?e.jsx(Ds,{className:"h-4 w-4 animate-spin text-blue-500"}):c?e.jsx(Ds,{className:"h-4 w-4 animate-spin text-gray-500"}):l?e.jsx(hr,{className:"h-4 w-4 text-orange-500"}):e.jsx(ft,{className:"h-4 w-4 text-green-500"}),b=()=>u?"Aggiornamento...":c?"Controllo...":l?"Aggiornamento disponibile":"Aggiornato",v=()=>u?"text-blue-600":c?"text-gray-500":l?"text-orange-600":"text-green-600",S=`Versione ${n||"Sconosciuta"} - ${b()}`;return e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:f,disabled:c||u,className:`sm:hidden inline-flex items-center space-x-1 px-2 py-1 rounded-md transition-colors text-xs
          ${l?"bg-orange-100 hover:bg-orange-200 text-orange-800":"bg-gray-100 hover:bg-gray-200 text-gray-700"}
          disabled:opacity-50 disabled:cursor-not-allowed`,title:S,"aria-label":S,type:"button",children:[x(),e.jsxs("span",{className:"font-medium text-[11px]",children:["v",n||"?"]})]}),e.jsxs("button",{onClick:f,disabled:c||u,className:`hidden sm:flex items-center space-x-1.5 px-2 py-1 rounded-md transition-colors ${l?"bg-orange-100 hover:bg-orange-200 text-orange-800":"bg-gray-100 hover:bg-gray-200 text-gray-700"} disabled:opacity-50 disabled:cursor-not-allowed`,title:S,type:"button",children:[e.jsx("div",{className:"scale-75",children:x()}),e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"text-[10px] font-medium leading-tight",children:["v",n||"?"]}),e.jsx("div",{className:`text-[9px] leading-tight ${v()}`,children:b()})]})]})]})},Od=()=>{const{signOut:n,user:l}=ds(),[c,u]=Tt.useState(!1),{showSuccess:f,showInfo:x}=zr(),{currentVersion:b,hasUpdate:v,isLoading:S,isUpdating:g,checkForUpdates:j,applyUpdate:p}=Md(),M=async()=>{v?(x("Aggiornamento in corso..."),await p()):await j(!0)?x("Aggiornamento disponibile! Clicca nuovamente per aggiornare."):f("Stai usando la versione piu recente!")},B=async()=>{try{await n(),f("Logout effettuato con successo")}catch(k){console.error("Errore logout:",k)}};return e.jsx("header",{className:"sticky top-0 z-40 bg-gray-800 border-b border-gray-700 shadow-lg",children:e.jsx("div",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 bg-blue-600 rounded-lg",children:e.jsx(zt,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-white",children:"CREW MANAGER"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Pannello Azienda"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(zd,{currentVersion:b,hasUpdate:v,isLoading:S,isUpdating:g,onCheckUpdate:M}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>u(!c),className:"p-2 text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(rn,{className:"w-6 h-6"})}),c&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>u(!1)}),e.jsxs("div",{className:"absolute right-0 mt-2 w-56 bg-gray-800 rounded-lg shadow-xl border border-gray-700 z-50",children:[e.jsxs("div",{className:"p-4 border-b border-gray-700",children:[e.jsx("p",{className:"text-sm text-gray-400",children:"Accesso come:"}),e.jsx("p",{className:"text-sm font-medium text-white truncate",children:l==null?void 0:l.email})]}),e.jsx("div",{className:"p-2",children:e.jsxs("button",{onClick:B,className:"w-full flex items-center space-x-2 px-3 py-2 text-red-400 hover:bg-gray-700 rounded-lg transition-colors",children:[e.jsx(Ea,{className:"w-5 h-5"}),e.jsx("span",{children:"Esci"})]})})]})]})]})]})]})})})},Rd=({activeTab:n,onTabChange:l})=>{const c=[{id:"dashboard",label:"Home",icon:ci,description:"Dashboard principale"},{id:"checkin",label:"Check-In",icon:wo,description:"Monitor presenze"},{id:"events",label:"Eventi",icon:ls,description:"Assegna crew agli eventi"},{id:"courses",label:"Corsi",icon:mi,description:"Gestione corsi"},{id:"shifts",label:"Turni",icon:ct,description:"Gestione turni"},{id:"calendar",label:"Calendario",icon:ut,description:"I miei eventi"},{id:"expenses",label:"Richieste",icon:Ht,description:"Richieste e Rimborsi"},{id:"talk",label:"Talk",icon:yo,description:"Talk"},{id:"profile",label:"Profilo",icon:ea,description:"Il mio profilo"}];return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        @keyframes pulse-red {
          0%, 100% {
            background-color: rgb(220, 38, 38);
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
          }
          50% {
            background-color: rgb(185, 28, 28);
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.8);
          }
        }
        .animate-pulse-red {
          animation: pulse-red 1s ease-in-out infinite;
        }
      `}),e.jsx("nav",{className:"fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 z-50 shadow-lg pb-safe",children:e.jsxs("div",{className:"relative max-w-screen-lg mx-auto",children:[e.jsx("div",{className:"flex items-center gap-2 px-2 py-2 overflow-x-auto scrollbar-hide snap-x snap-mandatory",style:{scrollbarWidth:"none",msOverflowStyle:"none",WebkitOverflowScrolling:"touch"},children:c.map(u=>{const f=u.icon,x=n===u.id,b=u.id==="talk";return e.jsxs("button",{onClick:()=>l(u.id),className:`flex flex-col items-center space-y-0.5 px-4 py-1.5 rounded-lg transition-all duration-200 flex-shrink-0 w-[85px] snap-center ${b?"animate-pulse-red text-white shadow-lg":x?"bg-blue-600 text-white shadow-lg transform scale-105":"text-gray-400 hover:text-white hover:bg-gray-700"}`,title:u.description,children:[e.jsx(f,{className:`h-5 w-5 flex-shrink-0 ${x||b?"text-white":""}`}),e.jsx("span",{className:`text-[10px] font-medium leading-tight text-center ${x||b?"text-white":""}`,children:u.label}),x&&!b&&e.jsx("div",{className:"w-1 h-1 bg-cyan-400 rounded-full"})]},u.id)})}),e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-4 bg-gradient-to-r from-gray-800 to-transparent pointer-events-none"}),e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-4 bg-gradient-to-l from-gray-800 to-transparent pointer-events-none"})]})})]})},Ld=()=>{const{companyProfile:n}=ds(),[l,c]=w.useState({totalEmployees:0,activeShifts:0,pendingRequests:0,pendingExpenses:0}),[u,f]=w.useState(!0);w.useEffect(()=>{n!=null&&n.id&&x()},[n==null?void 0:n.id]);const x=async()=>{if(n!=null&&n.id)try{f(!0);const b=new Date,v=b.getMonth(),S=b.getFullYear(),g=new Date(S,v,1).toISOString().split("T")[0],j=new Date(S,v+1,0).toISOString().split("T")[0],[p,M,B,k]=await Promise.all([Le.from("crew_members").select("id",{count:"exact",head:!0}).eq("company_id",n.id),Le.from("crew_assegnazione_turni").select("id",{count:"exact",head:!0}).eq("azienda_id",n.id).gte("data_turno",g).lte("data_turno",j),Le.from("crew_richiesteferie_permessi").select("id",{count:"exact",head:!0}).eq("azienda_id",n.id).eq("stato","in_attesa"),Le.from("crew_note_spese").select("id",{count:"exact",head:!0}).eq("azienda_id",n.id).eq("stato","in_attesa")]),R=p.count||0,C=M.count||0,D=B.count||0,E=k.count||0;console.log("Dashboard Stats:",{companyId:n.id,totalEmployees:R,activeShifts:C,pendingRequests:D,pendingExpenses:E}),c({totalEmployees:R,activeShifts:C,pendingRequests:D,pendingExpenses:E})}catch(b){console.error("Errore caricamento dashboard:",b)}finally{f(!1)}};return u?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"})}):e.jsxs("div",{className:"space-y-4 pb-20",children:[e.jsxs("div",{className:"bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl p-6 text-white",children:[e.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Dashboard Azienda"}),e.jsx("p",{className:"text-blue-100",children:n==null?void 0:n.ragione_sociale})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-blue-500/20 rounded-lg",children:e.jsx(ls,{className:"h-5 w-5 text-blue-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:l.totalEmployees}),e.jsx("p",{className:"text-sm text-gray-400",children:"Dipendenti"})]})]})}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-green-500/20 rounded-lg",children:e.jsx(ut,{className:"h-5 w-5 text-green-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:l.activeShifts}),e.jsx("p",{className:"text-sm text-gray-400",children:"Turni mese"})]})]})}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-yellow-500/20 rounded-lg",children:e.jsx(wt,{className:"h-5 w-5 text-yellow-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:l.pendingRequests}),e.jsx("p",{className:"text-sm text-gray-400",children:"Richieste"})]})]})}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-orange-500/20 rounded-lg",children:e.jsx(Ht,{className:"h-5 w-5 text-orange-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:l.pendingExpenses}),e.jsx("p",{className:"text-sm text-gray-400",children:"Note spese"})]})]})})]}),(l.pendingRequests>0||l.pendingExpenses>0)&&e.jsx("div",{className:"bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(wt,{className:"h-5 w-5 text-yellow-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-yellow-200 mb-1",children:"Azioni in sospeso"}),e.jsxs("ul",{className:"text-sm text-yellow-100 space-y-1",children:[l.pendingRequests>0&&e.jsxs("li",{children:["‚Ä¢ ",l.pendingRequests," ",l.pendingRequests===1?"richiesta":"richieste"," ferie/permessi da approvare"]}),l.pendingExpenses>0&&e.jsxs("li",{children:["‚Ä¢ ",l.pendingExpenses," ",l.pendingExpenses===1?"nota spese":"note spese"," da approvare"]})]})]})]})}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"font-semibold text-white mb-3",children:"Accesso Rapido"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("button",{className:"p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-left transition-colors",children:[e.jsx(ls,{className:"h-5 w-5 text-blue-400 mb-1"}),e.jsx("p",{className:"text-sm font-medium text-white",children:"Dipendenti"})]}),e.jsxs("button",{className:"p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-left transition-colors",children:[e.jsx(ut,{className:"h-5 w-5 text-green-400 mb-1"}),e.jsx("p",{className:"text-sm font-medium text-white",children:"Calendario"})]}),e.jsxs("button",{className:"p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-left transition-colors",children:[e.jsx(Ht,{className:"h-5 w-5 text-orange-400 mb-1"}),e.jsx("p",{className:"text-sm font-medium text-white",children:"Richieste"})]}),e.jsxs("button",{className:"p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-left transition-colors",children:[e.jsx(Sa,{className:"h-5 w-5 text-purple-400 mb-1"}),e.jsx("p",{className:"text-sm font-medium text-white",children:"Report"})]})]})]})]})},xn=()=>e.jsxs("div",{className:"text-center text-gray-500 text-xs",children:[e.jsx("p",{children:"¬© 2025 ControlStage - Crew Manager Azienda V. 1.0.0"}),e.jsx("p",{children:"Tutti i diritti riservati - Software realizzato da ControlStage"})]}),Pd=()=>{const{companyProfile:n}=ds(),{showError:l}=Or(),[c,u]=w.useState(new Date),[f,x]=w.useState([]),[b,v]=w.useState([]),[S,g]=w.useState(!0),[j,p]=w.useState(null),[M,B]=w.useState(!1),[k,R]=w.useState("month");w.useEffect(()=>{n!=null&&n.id&&(D(),E())},[n==null?void 0:n.id]);const C=me=>{if(!me)return"bg-blue-500";const Q=["bg-blue-500","bg-green-500","bg-purple-500","bg-pink-500","bg-indigo-500","bg-red-500","bg-orange-500","bg-teal-500","bg-cyan-500","bg-emerald-500"];let V=0;for(let ae=0;ae<me.length;ae++)V=me.charCodeAt(ae)+((V<<5)-V);const de=Math.abs(V)%Q.length;return Q[de]},D=async()=>{if(n!=null&&n.id){g(!0);try{const me=[],{data:Q,error:V}=await Le.from("crew_events").select(`
          id,
          title,
          description,
          type,
          start_date,
          end_date,
          location,
          address,
          call_time,
          required_crew,
          event_group_code
        `).eq("company_id",n.id).order("start_date",{ascending:!0});V&&console.error("Errore caricamento eventi:",V);let de={};if(Q&&Q.length>0){const ye=Q.map(Ne=>Ne.id),{data:Ce}=await Le.from("crew_event_assegnazione").select("evento_id").in("evento_id",ye);Ce&&Ce.forEach(Ne=>{de[Ne.evento_id]=(de[Ne.evento_id]||0)+1})}if(Q)for(const ye of Q){const Ce=de[ye.id]||0,Ne=C(ye.event_group_code);me.push({id:ye.id,title:ye.title,description:ye.description||void 0,type:"event",date:ye.start_date,endDate:ye.end_date||ye.start_date,startTime:ye.call_time?ye.call_time.substring(0,5):"09:00",endTime:"18:00",location:ye.location||"Non specificato",address:ye.address||void 0,callTime:ye.call_time?ye.call_time.substring(0,5):void 0,companyName:(n==null?void 0:n.ragione_sociale)||"",assignedCrewCount:Ce,requiredCrewCount:ye.required_crew||0,eventGroupCode:ye.event_group_code||void 0,color:Ne,raw:ye})}const{data:ae,error:le}=await Le.from("crew_corsi").select(`
          id,
          titolo,
          descrizione,
          data_corso,
          ora_inizio,
          ora_fine,
          luogo,
          istruttore,
          categoria,
          obbligatorio,
          max_partecipanti
        `).eq("azienda_id",n.id).order("data_corso",{ascending:!0});le&&console.error("Errore caricamento corsi:",le);let be={};if(ae&&ae.length>0){const ye=ae.map(Ne=>Ne.id),{data:Ce}=await Le.from("crew_assegnazionecorsi").select("corso_id").in("corso_id",ye);Ce&&Ce.forEach(Ne=>{be[Ne.corso_id]=(be[Ne.corso_id]||0)+1})}if(ae)for(const ye of ae){const Ce=be[ye.id]||0;me.push({id:ye.id,title:ye.titolo,description:ye.descrizione||void 0,type:"course",date:ye.data_corso,endDate:ye.data_corso,startTime:ye.ora_inizio?ye.ora_inizio.substring(0,5):"09:00",endTime:ye.ora_fine?ye.ora_fine.substring(0,5):"17:00",location:ye.luogo,address:void 0,callTime:void 0,companyName:(n==null?void 0:n.ragione_sociale)||"",assignedCrewCount:Ce,requiredCrewCount:ye.max_partecipanti||0,eventGroupCode:void 0,color:"bg-yellow-500",raw:ye})}x(me),console.log("üìÖ Eventi totali caricati:",me.length,{eventi:(Q==null?void 0:Q.length)||0,corsi:(ae==null?void 0:ae.length)||0})}catch(me){console.error("Errore nel caricamento eventi:",me),l("Errore","Impossibile caricare gli eventi"),x([])}finally{g(!1)}}},E=async()=>{if(n!=null&&n.id)try{const{data:me,error:Q}=await Le.from("crew_richiesteferie_permessi").select(`
          id,
          dipendente_id,
          tipo_richiesta,
          data_inizio,
          data_fine,
          motivo,
          dipendente_nome
        `).eq("stato","approvata").eq("azienda_id",n.id);if(Q)throw Q;const V=(me||[]).map(de=>({id:de.id,crewId:de.dipendente_id,crewName:de.dipendente_nome||"N/D",type:de.tipo_richiesta,startDate:de.data_inizio,endDate:de.data_fine,reason:de.motivo}));v(V),console.log("üìÖ Assenze caricate:",V.length)}catch(me){console.error("Errore nel caricamento assenze:",me)}},U=me=>{const Q=me.getFullYear(),V=String(me.getMonth()+1).padStart(2,"0"),de=String(me.getDate()).padStart(2,"0");return`${Q}-${V}-${de}`},q=()=>{u(new Date(c.getFullYear(),c.getMonth()-1,1))},J=()=>{u(new Date(c.getFullYear(),c.getMonth()+1,1))},N=()=>u(new Date),_=me=>{const Q=U(me);return b.filter(V=>Q>=V.startDate&&Q<=V.endDate)},L=me=>{const Q=me.getFullYear(),V=me.getMonth(),de=new Date(Q,V,1),le=new Date(Q,V+1,0).getDate(),be=[],ye=(de.getDay()+6)%7;for(let Ne=0;Ne<ye;Ne++){const Ae=new Date(Q,V,1-(ye-Ne));be.push({date:Ae,isCurrentMonth:!1,isToday:!1,events:I(Ae),absences:_(Ae)})}for(let Ne=1;Ne<=le;Ne++){const Ae=new Date(Q,V,Ne),Ue=I(Ae),qe=_(Ae);be.push({date:Ae,isCurrentMonth:!0,isToday:U(Ae)===U(new Date),events:Ue,absences:qe})}const Ce=42-be.length;for(let Ne=1;Ne<=Ce;Ne++){const Ae=new Date(Q,V+1,Ne);be.push({date:Ae,isCurrentMonth:!1,isToday:!1,events:I(Ae),absences:_(Ae)})}return be},I=me=>{const Q=U(me);return f.filter(V=>{const de=V.date,ae=V.endDate||V.date;return Q>=de&&Q<=ae}).sort((V,de)=>(V.startTime||"").localeCompare(de.startTime||""))},K=me=>{p(me),B(!0)},O=()=>{const me=c.getFullYear(),Q=c.getMonth(),V=new Date(me,Q,1),de=new Date(me,Q+1,0),ae=U(V),le=U(de),ye=f.filter(qe=>qe.date<=le&&(qe.endDate||qe.date)>=ae).sort((qe,rt)=>qe.date!==rt.date?qe.date.localeCompare(rt.date):(qe.startTime||"").localeCompare(rt.startTime||"")).reduce((qe,rt)=>{const at=rt.date;return qe[at]||(qe[at]=[]),qe[at].push(rt),qe},{}),Ce=b.filter(qe=>qe.startDate<=le&&qe.endDate>=ae),Ne={};Ce.forEach(qe=>{const rt=new Date(qe.startDate),at=new Date(qe.endDate);for(let Ke=new Date(rt);Ke<=at;Ke.setDate(Ke.getDate()+1))if(Ke.getMonth()===Q&&Ke.getFullYear()===me){const Je=U(Ke);Ne[Je]||(Ne[Je]=[]),Ne[Je].push(qe)}});const Ae=new Set([...Object.keys(ye),...Object.keys(Ne)]),Ue=Array.from(Ae).sort();return e.jsx("div",{className:"space-y-4",children:Ue.length===0?e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 p-8 text-center",children:[e.jsx(ut,{className:"h-16 w-16 mx-auto mb-4 text-gray-600"}),e.jsx("p",{className:"text-base text-gray-400",children:"Nessun evento in questo mese"})]}):Ue.map(qe=>{const rt=new Date(qe+"T12:00:00"),at=U(rt)===U(new Date),Ke=ye[qe]||[],Je=Ne[qe]||[];return e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 overflow-hidden",children:[e.jsx("div",{className:`p-4 border-b border-gray-700 ${at?"bg-blue-600":"bg-gray-750"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-bold text-white",children:rt.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})}),at&&e.jsx("div",{className:"text-sm text-blue-100 mt-1",children:"Oggi"})]}),e.jsxs("div",{className:"text-sm text-gray-300 font-medium",children:[Ke.length>0&&`${Ke.length} ${Ke.length===1?"evento":"eventi"}`,Ke.length>0&&Je.length>0&&" ‚Ä¢ ",Je.length>0&&`${Je.length} ${Je.length===1?"assenza":"assenze"}`]})]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[Je.length>0&&e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(wt,{className:"h-4 w-4 text-red-400"}),e.jsx("h4",{className:"text-sm font-bold text-red-300",children:"Dipendenti Assenti"})]}),e.jsx("div",{className:"space-y-2",children:Je.map(Ge=>{const yt=Ye=>{switch(Ye){case"ferie":return"Ferie";case"permesso":return"Permesso";case"malattia":return"Malattia";case"infortunio":return"Infortunio";default:return Ye}};return e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-white",children:Ge.crewName}),e.jsx("span",{className:"text-xs px-2 py-1 rounded bg-red-600 text-white font-medium",children:yt(Ge.type)})]},Ge.id)})})]}),Ke.map(Ge=>e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700 hover:border-gray-600 transition-colors cursor-pointer",onClick:()=>K(qe),children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("span",{className:`inline-block px-3 py-1 text-xs font-semibold text-white rounded-full ${Ge.color}`,children:Ge.type==="course"?"Corso":"Evento"}),Ge.assignedCrewCount!==void 0&&Ge.requiredCrewCount!==void 0&&e.jsxs("span",{className:"inline-flex items-center text-xs text-gray-300 font-medium",children:[e.jsx(ls,{className:"h-3.5 w-3.5 mr-1"}),Ge.assignedCrewCount,"/",Ge.requiredCrewCount]})]}),e.jsx("h4",{className:"text-base font-bold text-white mb-1",children:Ge.title})]})}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-300",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ct,{className:"h-4 w-4 flex-shrink-0 text-gray-400"}),e.jsxs("span",{children:[Ge.startTime," - ",Ge.endTime,Ge.callTime&&e.jsxs("span",{className:"text-gray-400 ml-2",children:["(Convocazione:  ",Ge.callTime,")"]})]})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 flex-shrink-0 text-gray-400 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:Ge.location}),Ge.address&&e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:Ge.address})]})]}),Ge.description&&e.jsx("div",{className:"mt-2 p-2 bg-gray-800 rounded text-xs text-gray-400 border border-gray-700",children:Ge.description})]})]},Ge.id))]})]},qe)})})},W=c.getMonth(),se=c.getFullYear(),G=f.filter(me=>{const Q=new Date(me.date);return Q.getMonth()===W&&Q.getFullYear()===se&&me.type==="event"}).length,$=f.filter(me=>{const Q=new Date(me.date);return Q.getMonth()===W&&Q.getFullYear()===se&&me.type==="course"}).length,F=new Date(se,W,1),re=new Date(se,W+1,0),_e=U(F),ge=U(re),X=b.filter(me=>me.startDate<=ge&&me.endDate>=_e).length;if(S)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento calendario..."})]})});const pe=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white",children:[e.jsxs("div",{className:"p-4 pb-20 space-y-4",children:[e.jsxs("div",{className:"flex flex-col space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Calendario Aziendale"}),e.jsx("p",{className:"text-gray-300",children:(n==null?void 0:n.nome_azienda)||"Azienda"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:q,className:"p-2 hover:bg-gray-800 rounded",children:e.jsx(ta,{className:"h-5 w-5"})}),e.jsx("button",{onClick:N,className:"px-3 py-1 bg-gray-800 rounded text-sm",children:"Oggi"}),e.jsx("button",{onClick:J,className:"p-2 hover:bg-gray-800 rounded",children:e.jsx(sa,{className:"h-5 w-5"})})]})]}),e.jsx("div",{className:"flex justify-center px-2",children:e.jsxs("div",{className:"inline-flex items-center gap-1.5",children:[e.jsx("button",{onClick:()=>R("month"),className:`px-2. 5 py-2 rounded-lg font-medium text-sm transition-colors ${k==="month"?"bg-gray-700 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"}`,children:"Mensile"}),e.jsx("button",{onClick:()=>R("agenda"),className:`px-2.5 py-2 rounded-lg font-medium text-sm transition-colors ${k==="agenda"?"bg-green-600 text-white":"bg-green-700 text-white hover:bg-green-600"}`,children:"Agenda"})]})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700 text-center",children:[e.jsx(ut,{className:"h-6 w-6 mx-auto mb-2 text-blue-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:G}),e.jsx("div",{className:"text-xs text-gray-400",children:"Eventi"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700 text-center",children:[e.jsx(zt,{className:"h-6 w-6 mx-auto mb-2 text-yellow-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:$}),e.jsx("div",{className:"text-xs text-gray-400",children:"Corsi"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700 text-center",children:[e.jsx(wt,{className:"h-6 w-6 mx-auto mb-2 text-red-400"}),e.jsx("div",{className:"text-xl font-bold text-white",children:X}),e.jsx("div",{className:"text-xs text-gray-400",children:"Assenze"})]})]}),k==="month"&&e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[e.jsxs("h2",{className:"text-lg font-semibold text-white",children:[pe[c.getMonth()]," ",c.getFullYear()]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Vista Mensile"})]}),e.jsxs("div",{className:"p-3",children:[e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["Lun","Mar","Mer","Gio","Ven","Sab","Dom"].map(me=>e.jsx("div",{className:"p-2 text-center text-sm font-semibold text-gray-300",children:me},me))}),e.jsx("div",{className:"grid grid-cols-7 gap-1.5",children:L(c).map((me,Q)=>{let V="min-h-[85px] p-1. 5 rounded-lg border border-gray-700 cursor-pointer transition-colors relative ";return me.isCurrentMonth?me.isToday?V+="bg-blue-600 text-white shadow-lg ":V+="bg-gray-750 hover:bg-gray-700 ":V+="bg-gray-800 text-gray-500 ",e.jsxs("div",{className:V,onClick:()=>K(U(me.date)),children:[e.jsxs("div",{className:"flex items-start justify-between mb-1",children:[e.jsx("div",{className:"text-sm font-semibold",children:me.date.getDate()}),me.absences.length>0&&e.jsx("div",{className:"h-2 w-2 rounded-full bg-red-500 shadow-lg mt-0.5",title:`${me.absences.length} assenze approvate`})]}),e.jsxs("div",{className:"space-y-0.5",children:[me.events.slice(0,2).map(de=>e.jsx("div",{className:`text-[10px] leading-tight px-1 py-0.5 rounded text-white truncate font-medium ${de.color}`,title:de.title,children:de.title},de.id)),me.events.length>2&&e.jsxs("div",{className:"text-[10px] text-gray-300 px-1 font-medium",children:["+",me.events.length-2]})]})]},Q)})})]})]}),k==="agenda"&&O(),e.jsx(xn,{})]}),M&&j&&e.jsx(Bd,{date:j,events:I(new Date(j+"T12:00:00")),absences:_(new Date(j+"T12:00:00")),onClose:()=>B(!1)})]})},Bd=({date:n,events:l,absences:c,onClose:u})=>{const f=b=>new Date(b+"T12:00:00").toLocaleDateString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),x=b=>{switch(b){case"ferie":return"Ferie";case"permesso":return"Permesso";case"malattia":return"Malattia";case"infortunio":return"Infortunio";default:return b}};return e.jsx("div",{className:"fixed inset-0 bg-gray-900 bg-opacity-95 z-[9999] flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-3xl max-h-[90vh] overflow-y-auto p-5 space-y-6 bg-gray-800 rounded-xl border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-white",children:["Eventi del ",f(n)]}),e.jsx("button",{onClick:u,className:"bg-gray-700 hover:bg-gray-600 p-2.5 rounded-lg transition-colors",children:e.jsx(jt,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"space-y-4",children:[c.length>0&&e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(wt,{className:"h-5 w-5 text-red-400"}),e.jsxs("h3",{className:"text-base font-bold text-red-300",children:["Dipendenti Assenti (",c.length,")"]})]}),e.jsx("div",{className:"space-y-2",children:c.map(b=>e.jsxs("div",{className:"bg-gray-900/50 rounded-lg p-3 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("div",{className:"font-semibold text-white",children:b.crewName}),e.jsx("div",{className:"text-xs px-2 py-1 rounded bg-red-600 text-white font-medium",children:x(b.type)})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:["Dal ",new Date(b.startDate+"T12:00:00").toLocaleDateString("it-IT")," al"," ",new Date(b.endDate+"T12:00:00").toLocaleDateString("it-IT")]}),b.reason&&e.jsx("div",{className:"text-sm text-gray-300 mt-2",children:b.reason})]},b.id))})]}),l.length===0&&c.length===0&&e.jsxs("div",{className:"text-center py-10 text-gray-400",children:[e.jsx(ut,{className:"h-12 w-12 mx-auto mb-3 text-gray-600"}),e.jsx("p",{className:"text-base",children:"Nessun evento o assenza in questa data"})]}),l.map(b=>e.jsx("div",{className:"bg-gray-900 rounded-xl p-5 border border-gray-700",children:e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("h4",{className:"text-lg font-bold text-white",children:b.title}),e.jsx("span",{className:`inline-flex px-2.5 py-1 text-sm font-semibold rounded-full ${b.color} text-white`,children:b.type==="course"?"Corso":"Evento"})]}),e.jsxs("div",{className:"text-sm text-gray-300 space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{children:b.location})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ct,{className:"h-4 w-4 flex-shrink-0"}),e.jsxs("span",{children:[b.startTime," - ",b.endTime,b.callTime&&` (Convocazione: ${b.callTime})`]})]}),b.address&&e.jsx("div",{className:"text-sm text-gray-400 break-words mt-2",children:b.address}),b.description&&e.jsx("div",{className:"text-sm text-gray-400 break-words mt-2",children:b.description})]}),b.assignedCrewCount!==void 0&&b.requiredCrewCount!==void 0&&e.jsxs("div",{className:"mt-3 flex items-center space-x-2 text-sm",children:[e.jsx(ls,{className:"h-4 w-4 text-gray-400"}),e.jsxs("span",{className:"text-gray-300",children:["Assegnati: ",b.assignedCrewCount," / ",b.requiredCrewCount]})]})]})})},b.id))]})]})})},Fd=()=>{const{user:n,signOut:l}=ds(),c="default",{showSuccess:u,showError:f,showWarning:x}=Or(),[b,v]=w.useState(null),[S,g]=w.useState(!0),[j,p]=w.useState(!0),[M,B]=w.useState(!0),[k,R]=w.useState(!1),[C,D]=w.useState(!1);w.useEffect(()=>{n!=null&&n.id&&E()},[n==null?void 0:n.id]);const E=async()=>{try{g(!0);const{data:N,error:_}=await Le.from("regaziendasoftware").select("*").eq("auth_user_id",n==null?void 0:n.id).single();if(_){console.error("Errore nel caricamento profilo aziendale:",_);return}v(N)}catch(N){console.error("Errore nel caricamento profilo aziendale:",N)}finally{g(!1)}},U=[{id:"notifications",label:"Notifiche Push",description:"Ricevi notifiche per turni e aggiornamenti",value:j,onChange:p},{id:"autoSync",label:"Sincronizzazione Automatica",description:"Sincronizza dati quando connesso",value:M,onChange:B},{id:"offlineMode",label:"Modalit√† Offline",description:"Salva dati localmente quando offline",value:k,onChange:R}],q=async()=>{try{x("Logout in corso..."),await l(),u("Logout effettuato con successo!"),window.location.href="/"}catch(N){console.error("Errore durante il logout:",N),u("Sessione terminata localmente"),setTimeout(()=>{window.location.href="/"},1e3)}};if(S)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Caricamento profilo..."})]})});if(!b)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("p",{className:"text-lg",children:"Errore nel caricamento del profilo"}),e.jsx("button",{onClick:()=>E(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg",children:"Riprova"})]})});const J=b.ragione_sociale||"Azienda";return e.jsx("div",{className:"min-h-screen bg-gray-900 text-white",children:e.jsxs("div",{className:"p-4 pb-20 space-y-6",children:[e.jsx("div",{className:"bg-gradient-to-br from-blue-600 to-cyan-600 rounded-2xl p-6 shadow-xl",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center",children:e.jsx(zt,{className:"h-8 w-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:J}),e.jsx("p",{className:"text-blue-100",children:b.citta||"Italia"}),e.jsx("p",{className:"text-sm text-blue-200",children:b.partita_iva?`P.IVA: ${b.partita_iva}`:"Azienda"})]})]})}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Informazioni Aziendali"}),e.jsxs("div",{className:"space-y-4",children:[b.email&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(wa,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.email}),e.jsx("p",{className:"text-xs text-gray-400",children:"Email aziendale"})]})]}),b.telefono&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Za,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.telefono}),e.jsx("p",{className:"text-xs text-gray-400",children:"Telefono aziendale"})]})]}),b.partita_iva&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(zt,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.partita_iva}),e.jsx("p",{className:"text-xs text-gray-400",children:"Partita IVA"})]})]}),b.codice_fiscale&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(zt,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:b.codice_fiscale}),e.jsx("p",{className:"text-xs text-gray-400",children:"Codice Fiscale"})]})]}),b.indirizzo&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ut,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-white font-medium",children:[b.indirizzo,b.cap&&`, ${b.cap}`,b.citta&&` - ${b.citta}`,b.provincia&&` (${b.provincia})`]}),e.jsx("p",{className:"text-xs text-gray-400",children:"Indirizzo completo"})]})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Impostazioni App"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white font-medium",children:"Notifiche Push"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Non configurate"})]}),e.jsx("button",{onClick:()=>D(!C),className:"bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm",children:"Gestisci"})]}),c==="denied",c==="granted",e.jsxs("div",{className:"bg-yellow-900/20 border border-yellow-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-yellow-400 text-sm font-medium mb-2",children:"Configura le Notifiche"}),e.jsx("p",{className:"text-yellow-300 text-xs mb-2",children:'Clicca su "Gestisci" per attivare le notifiche e rimanere aggiornato su turni e approvazioni.'})]})]}),U.map(N=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white font-medium",children:N.label}),e.jsx("p",{className:"text-sm text-gray-400",children:N.description})]}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:N.value,onChange:_=>N.onChange(_.target.checked),className:"sr-only peer"}),e.jsx("div",{className:"w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"})]})]},N.id))]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Informazioni App"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Versione"}),e.jsx("span",{className:"text-white font-medium",children:"1.0.8"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Ultimo Aggiornamento"}),e.jsx("span",{className:"text-white font-medium",children:"Gennaio 2025"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Modalit√†"}),e.jsx("span",{className:"text-blue-400 font-medium",children:"Mobile"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Connessione"}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ui,{className:"h-4 w-4 text-green-400"}),e.jsx("span",{className:"text-green-400 font-medium",children:"Online"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Tipo Utente"}),e.jsx("span",{className:"text-blue-400 font-medium",children:"Azienda"})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Stato Account"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Stato"}),e.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-medium ${b.attivo?"bg-green-900 text-green-300":"bg-red-900 text-red-300"}`,children:b.attivo?"Attivo":"Disattivato"})]}),b.created_at&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Registrazione"}),e.jsx("span",{className:"text-white font-medium",children:new Date(b.created_at).toLocaleDateString("it-IT")})]}),b.ultimo_accesso&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Ultimo Accesso"}),e.jsx("span",{className:"text-white font-medium",children:new Date(b.ultimo_accesso).toLocaleDateString("it-IT")})]})]})]}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("button",{onClick:q,className:"w-full bg-red-600 text-white py-4 px-4 rounded-xl hover:bg-red-700 font-bold text-lg shadow-lg flex items-center justify-center space-x-3",children:[e.jsx(Ea,{className:"h-6 w-6"}),e.jsx("span",{children:"ESCI DALL'APP"})]})}),e.jsx(xn,{})]})})},Ar=n=>{if(!n)return"";if(/^\d{2}:\d{2}$/.test(n))return n;if(/^\d{2}:\d{2}:\d{2}$/.test(n))return n.substring(0,5);try{const l=new Date(n);if(!isNaN(l.getTime()))return l.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit",hour12:!1})}catch(l){console.error("Errore parsing timestamp:",l)}return""},Ud=({shift:n,onUpdate:l})=>{const{user:c}=ds(),{showSuccess:u,showError:f}=Or(),[x,b]=w.useState(!1),[v,S]=w.useState(""),[g,j]=w.useState(""),[p,M]=w.useState(""),[B,k]=w.useState(""),[R,C]=w.useState(""),[D,E]=w.useState(!1),[U,q]=w.useState(null),[J,N]=w.useState(!1),[_,L]=w.useState(!1),[I,K]=w.useState(!0),[O,W]=w.useState(null),se=(ge,X,pe,me)=>{if(!ge||!X)return 0;const[Q,V]=ge.split(":").map(Number),[de,ae]=X.split(":").map(Number),le=Q*60+V;let ye=(de*60+ae-le)/60;if(pe&&me){const[Ce,Ne]=pe.split(":").map(Number),[Ae,Ue]=me.split(":").map(Number),qe=Ce*60+Ne,at=(Ae*60+Ue-qe)/60;at>0&&(ye-=at)}return ye},G=!n.turno_id||n.turno_id===""||n.nome_turno==="TURNO EXTRA";w.useEffect(()=>{const ge=async()=>{try{if(G){const{data:X,error:pe}=await Le.from("extra_shifts_checkins").select("*").eq("id",n.id).maybeSingle();if(pe)throw pe;if(X){W(X);const me=X.rectified_check_in_time||X.check_in_time,Q=X.rectified_check_out_time||X.check_out_time,V=X.rectified_break_start||X.break_start_time,de=X.rectified_break_end||X.break_end_time;S(Ar(me)),j(Ar(Q)),M(V||""),k(de||""),C(X.rectification_note||"")}}else{const{data:X,error:pe}=await Le.from("warehouse_checkins_enriched").select("*").eq("id",n.id).maybeSingle();if(pe)throw pe;if(X){W(X);const me=X.rectified_check_in_time||X.check_in_time,Q=X.rectified_check_out_time||X.check_out_time,V=X.rectified_break_start||X.break_start_time||X.break_start,de=X.rectified_break_end||X.break_end_time||X.break_end;S(Ar(me)),j(Ar(Q)),M(V||""),k(de||""),C(X.rectification_note||"")}}}catch(X){console.error("Errore caricamento dati turno:",X)}};x&&n.id&&ge()},[x,n.id,G]),w.useEffect(()=>{K(!0)},[]),w.useEffect(()=>{if(v&&g){const ge=se(v,g,p,B),X=n.ore_previste||8;ge>X?N(!0):(N(!1),L(!1))}},[v,g,p,B,n.ore_previste]);const $=async()=>{if(console.log("üîç Inizio salvataggio rettifica (azienda)..."),console.log("üìù Dati da salvare:",{editedCheckIn:v,editedCheckOut:g,breakStart:p,breakEnd:B,rectificationNote:R,requestOvertime:_,shiftId:n.id}),!v||!g){q("Inserisci orari validi");return}if(!R||R.trim().length<10){q("La nota di rettifica √® obbligatoria (minimo 10 caratteri)");return}if(p&&!B||!p&&B){q("Specifica sia l'inizio che la fine della pausa pranzo");return}if(p&&B){const[X,pe]=p.split(":").map(Number),[me,Q]=B.split(":").map(Number);if(me*60+Q<=X*60+pe){q("La fine della pausa deve essere dopo l'inizio");return}}const ge=se(v,g,p,B);if(ge<=0){q("Le pause non possono coprire tutto il tempo di lavoro. Le ore effettive devono essere maggiori di zero.");return}E(!0),q(null);try{const X=new Date().toISOString(),pe={rectified_check_in_time:v,rectified_check_out_time:g,rectified_break_start:p||null,rectified_break_end:B||null,rectified_pausa_pranzo:!!(p&&B),rectified_total_hours:ge,rectification_note:R.trim(),rectified_by:c==null?void 0:c.id,rectified_at:X,overtime_requested:_,total_hours:ge,status:"completed"};(!n.check_out_turno||n.status!=="completed")&&(pe.check_out_time=g);const me=G?"extra_shifts_checkins":"warehouse_checkins";console.log("üíæ Invio update a Supabase (azienda):",{tableName:me,shiftId:n.id,updateData:pe});const{error:Q}=await Le.from(me).update(pe).eq("id",n.id);if(console.log("‚úÖ Risposta Supabase (azienda):",{error:Q}),Q)throw console.error("‚ùå Errore Supabase:",Q),Q;u("Rettifica salvata con successo!"),b(!1),l()}catch(X){console.error("‚ùå Errore aggiornamento turno:",X);const pe=X.message||"Errore nel salvataggio delle modifiche";q(pe),f(pe)}finally{E(!1)}},F=()=>{var ge,X;S(((ge=n.check_in_turno)==null?void 0:ge.substring(0,5))||""),j(((X=n.check_out_turno)==null?void 0:X.substring(0,5))||""),M(""),k(""),C(""),L(!1),N(!1),q(null),b(!1)};if(!x)return e.jsxs("button",{onClick:()=>b(!0),className:"w-full mt-2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center space-x-2",children:[e.jsx(cr,{className:"h-4 w-4"}),e.jsx("span",{children:"Rettifica Orari Turno"})]});const _e=(()=>{const ge=O&&O.notes||n.notes||"",X=O&&O.warehouse_name||n.warehouse_name||n.nome_turno||"",pe=O&&O.noteturno||n.noteturno||"";if(typeof ge=="string"&&ge.toLowerCase().includes("turno extra"))return{label:"TURNO EXTRA",isExtra:!0,subtitle:""};const me=[];return X&&me.push(X),pe&&me.push(pe),{label:"TURNO MAGAZZINO",isExtra:!1,subtitle:me.join(" ‚Ä¢ ")}})();return e.jsxs("div",{className:"mt-3 bg-gray-800 border border-gray-600 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-sm font-semibold text-white mb-3 flex items-center space-x-2",children:[e.jsx(cr,{className:"h-4 w-4"}),e.jsx("span",{children:"Rettifica Orari"})]}),e.jsx("div",{className:"mb-3",children:_e.isExtra?e.jsx("div",{className:"inline-flex items-center px-3 py-1 rounded-full bg-indigo-700 text-white text-xs font-semibold",children:"TURNO EXTRA"}):e.jsxs("div",{className:"inline-flex flex-col px-3 py-2 rounded-lg bg-gray-700 text-white text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Turno di Magazzino"}),_e.subtitle?e.jsx("span",{className:"text-xs text-gray-300 mt-1",children:_e.subtitle}):null]})}),(!n.original_check_out||n.status!=="completed")&&e.jsx("div",{className:"mb-4 bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(wt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-orange-200 mb-1",children:"Turno Ancora Aperto"}),e.jsx("div",{className:"text-xs text-orange-300",children:"Il checkout non √® stato effettuato. Compilando questa rettifica il turno verr√† automaticamente chiuso."})]})]})}),n.original_check_in&&e.jsxs("div",{className:"mb-4 bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-2",children:"Dati Originali Registrati:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-300",children:"Check-in:"}),e.jsx("div",{className:"text-white font-semibold",children:Ar(n.original_check_in)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-300",children:"Check-out:"}),e.jsx("div",{className:"text-white font-semibold",children:n.original_check_out?e.jsxs(e.Fragment,{children:[Ar(n.original_check_out),n.auto_checkout&&e.jsx("span",{className:"ml-1 text-xs bg-purple-800 text-purple-200 px-1 py-0.5 rounded",children:"AUTO"})]}):e.jsx("span",{className:"text-orange-400 italic",children:"Non effettuato"})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-blue-300",children:"Pausa Pranzo:"}),e.jsx("span",{className:"ml-2 text-white font-semibold",children:n.original_pausa_pranzo?"S√¨ ‚úì":"No ‚úó"})]})]})]}),U&&e.jsxs("div",{className:"mb-3 bg-red-900 border border-red-700 rounded-lg p-2 flex items-start space-x-2",children:[e.jsx(wt,{className:"h-4 w-4 text-red-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"text-xs text-red-200",children:U})]}),e.jsxs("div",{className:"space-y-3 mb-3",children:[e.jsxs("div",{className:"bg-green-900 bg-opacity-20 border border-green-700 rounded-lg p-3 mb-3",children:[e.jsx("div",{className:"text-xs font-semibold text-green-200 mb-3",children:"Nuovi Orari Rettificati:"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-1",children:["Orario Entrata ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"time",value:v,onChange:ge=>S(ge.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-1",children:["Orario Uscita ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"time",value:g,onChange:ge=>j(ge.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"})]})]})]}),e.jsxs("div",{className:"border-t border-gray-600 pt-3 mt-3",children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-2 flex items-center space-x-2",children:[e.jsx(As,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{children:"Pausa Pranzo (opzionale):"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Inizio Pausa"}),e.jsx("input",{type:"time",value:p,onChange:ge=>M(ge.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Fine Pausa"}),e.jsx("input",{type:"time",value:B,onChange:ge=>k(ge.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"Lascia vuoto se non hai effettuato pausa pranzo"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-300 mb-1",children:["Nota Rettifica ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("textarea",{value:R,onChange:ge=>C(ge.target.value),placeholder:"Specifica il motivo della rettifica (obbligatorio, min 10 caratteri)...",rows:3,className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[R.length,"/10 caratteri minimi"]})]}),v&&g&&e.jsxs("div",{className:"space-y-2",children:[J&&I&&e.jsx("div",{className:"bg-orange-900 border border-orange-700 rounded p-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(wt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-xs font-semibold text-orange-200 mb-2",children:["Le ore superano il turno previsto (",n.ore_previste||8,"h)"]}),e.jsxs("label",{className:"flex items-center space-x-2 text-xs text-orange-300",children:[e.jsx("input",{type:"checkbox",checked:_,onChange:ge=>L(ge.target.checked),className:"rounded border-orange-600 bg-orange-800 text-orange-500 focus:ring-orange-500"}),e.jsx("span",{children:"Richiedi straordinari per le ore eccedenti"})]})]})]})}),e.jsxs("div",{className:"bg-blue-900 border border-blue-700 rounded p-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs mb-1",children:[e.jsx("span",{className:"text-blue-200",children:"Nuove ore totali:"}),e.jsxs("span",{className:"font-bold text-blue-100 text-lg",children:[se(v,g,p,B).toFixed(2),"h"]})]}),p&&B&&e.jsxs("div",{className:"text-xs text-blue-300 mt-1",children:["(Include pausa: ",p," - ",B,")"]})]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("button",{type:"button",onClick:()=>L(!_),disabled:!I,className:`w-full py-3 rounded-lg font-semibold transition-all ${I?_?"bg-orange-600 text-white hover:bg-orange-700":"bg-gray-700 text-gray-300 hover:bg-gray-600 border border-gray-600":"bg-gray-800 text-gray-500 border border-gray-700 cursor-not-allowed"}`,children:I?_?e.jsxs("span",{className:"flex items-center justify-center space-x-2",children:[e.jsx(wt,{className:"h-4 w-4"}),e.jsx("span",{children:"Straordinari Richiesti"})]}):e.jsx("span",{children:"Richiedi Straordinari"}):e.jsx("span",{children:"Straordinari Non Previsti nel Contratto"})}),!I&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 text-center",children:"Il tuo contratto non prevede il pagamento degli straordinari"})]})]}),e.jsxs("div",{className:"flex space-x-2 mt-4",children:[e.jsxs("button",{onClick:F,disabled:D,className:"flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-500 disabled:opacity-50 flex items-center justify-center space-x-1",children:[e.jsx(jt,{className:"h-4 w-4"}),e.jsx("span",{children:"Annulla"})]}),e.jsx("button",{onClick:$,disabled:D,className:"flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 flex items-center justify-center space-x-1",children:D?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Salvataggio..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Zr,{className:"h-4 w-4"}),e.jsx("span",{children:"Salva"})]})})]})]})},Vd=({event:n,existingTimesheet:l,onClose:c,onSuccess:u})=>{const{user:f}=ds(),[x,b]=w.useState((l==null?void 0:l.start_time)||""),[v,S]=w.useState((l==null?void 0:l.end_time)||""),[g,j]=w.useState(""),[p,M]=w.useState(!1),[B,k]=w.useState(null),C=((E,U)=>{if(!E||!U)return 0;const[q,J]=E.split(":").map(Number),[N,_]=U.split(":").map(Number),L=q*60+J,K=N*60+_-L;return Math.max(0,K/60)})(x,v),D=async E=>{if(E.preventDefault(),!x||!v){k("Inserisci sia orario di check-in che di check-out");return}if(C<=0){k("L'orario di check-out deve essere successivo al check-in");return}if(!g||g.trim().length===0){k("La motivazione della rettifica √® obbligatoria");return}M(!0),k(null);try{if(l){const U={original_start_time:l.start_time,original_end_time:l.end_time,rectified_start_time:x,rectified_end_time:v,start_time:x,end_time:v,total_hours:C,is_rectified:!0,rectified_by:f==null?void 0:f.id,rectified_at:new Date().toISOString(),rectification_notes:g.trim()},{error:q}=await Le.from("timesheet_entries").update(U).eq("id",l.id);if(q)throw q}else{const U={crew_id:f==null?void 0:f.id,event_id:n.evento_id,date:n.giorno_inizio_evento,start_time:x,end_time:v,rectified_start_time:x,rectified_end_time:v,total_hours:C,status:"submitted",tracking_type:"hours",is_rectified:!0,rectified_by:f==null?void 0:f.id,rectified_at:new Date().toISOString(),rectification_notes:g.trim(),retention_percentage:0,gross_amount:0,net_amount:0},{error:q}=await Le.from("timesheet_entries").insert([U]);if(q)throw q}u(),c()}catch(U){console.error("Errore salvataggio rettifica:",U),k(U.message||"Errore durante il salvataggio")}finally{M(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl w-full max-w-md border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Rettifica Orario"}),e.jsx("p",{className:"text-sm text-gray-400",children:n.nome_evento})]}),e.jsx("button",{onClick:c,className:"text-gray-400 hover:text-white",children:e.jsx(jt,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:D,className:"p-4 space-y-4",children:[e.jsxs("div",{className:"bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3 flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-5 w-5 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsx("div",{className:"text-sm text-orange-200",children:"Questa operazione registra un orario rettificato manualmente. Verr√† segnalato come rettifica nel sistema."})]}),B&&e.jsx("div",{className:"bg-red-900 bg-opacity-30 border border-red-700 rounded-lg p-3 text-sm text-red-200",children:B}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Orario Check-in"}),e.jsxs("div",{className:"relative",children:[e.jsx(ct,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"time",value:x,onChange:E=>b(E.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Orario Check-out"}),e.jsxs("div",{className:"relative",children:[e.jsx(ct,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"time",value:v,onChange:E=>S(E.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]})]}),x&&v&&e.jsx("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-3",children:e.jsxs("div",{className:"text-sm text-blue-200",children:[e.jsx("span",{className:"font-medium",children:"Ore totali:"})," ",C.toFixed(2),"h"]})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Motivazione Rettifica ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("textarea",{value:g,onChange:E=>j(E.target.value),rows:3,className:"w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",placeholder:"Spiega il motivo della rettifica (es: dimenticato check-in, errore nell'orario, ecc...)",required:!0})]}),e.jsxs("div",{className:"flex space-x-3 pt-4",children:[e.jsx("button",{type:"button",onClick:c,className:"flex-1 py-2 px-4 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors",children:"Annulla"}),e.jsx("button",{type:"submit",disabled:p||!x||!v||!g.trim(),className:"flex-1 py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:p?"Salvataggio...":l?"Aggiorna":"Salva"})]})]})]})})},qd=({report:n,onRectify:l})=>{const{assignment:c,timesheet:u,benefitBreakdown:f}=n,x=R=>{if(!R)return"Non specificato";if(/^\d{2}:\d{2}$/.test(R))return R;if(/^\d{2}:\d{2}:\d{2}$/.test(R))return R.substring(0,5);try{const C=new Date(R);if(!isNaN(C.getTime()))return C.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})}catch(C){console.error("Errore parsing timestamp:",C)}return R},b=R=>{switch(R){case"evento":return"Diaria Eventi";case"trasferta":return"Diaria Trasferta";default:return null}},v=(u==null?void 0:u.rectified_start_time)||(u==null?void 0:u.start_time),S=(u==null?void 0:u.rectified_end_time)||(u==null?void 0:u.end_time),g=u&&v&&S,j=(u==null?void 0:u.total_benefits)||0,p=j>0,M=c.bonus_previsti&&c.bonus_previsti>0,B=c.benefits_evento_nomi&&c.benefits_evento_nomi.length>0,k=!g&&(M||B||c.bonus_trasferta||c.bonus_diaria);return e.jsxs("div",{className:"bg-gray-700 rounded-xl p-4 border border-gray-600",children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx("h4",{className:"font-bold text-white",children:c.nome_evento}),(u==null?void 0:u.is_rectified)&&e.jsx("span",{className:"bg-orange-600 text-white text-xs px-2 py-0.5 rounded font-semibold",children:"Rettificato"})]}),e.jsx("p",{className:"text-sm text-blue-400",children:c.nome_azienda}),e.jsxs("p",{className:"text-xs text-gray-400",children:[new Date(c.giorno_inizio_evento).toLocaleDateString("it-IT"),c.giorno_inizio_evento!==c.giorno_fine_evento&&e.jsxs(e.Fragment,{children:[" - ",new Date(c.giorno_fine_evento).toLocaleDateString("it-IT")]})]})]})}),c.evento_orario_convocazione&&e.jsx("div",{className:"bg-green-900 bg-opacity-30 border-2 border-green-600 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(ct,{className:"h-5 w-5 text-green-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-green-200",children:"Orario Convocazione"}),e.jsx("div",{className:"text-xl font-bold text-green-400",children:x(c.evento_orario_convocazione)})]})]})}),(u==null?void 0:u.convocation_start_time)&&(u==null?void 0:u.convocation_end_time)&&e.jsxs("div",{className:"bg-cyan-900 bg-opacity-30 border border-cyan-600 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ct,{className:"h-4 w-4 text-cyan-400"}),e.jsx("h5",{className:"text-sm font-medium text-cyan-400",children:"Orari Convocazione"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Inizio:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(u.convocation_start_time)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Fine:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(u.convocation_end_time)})]})]})]}),g?e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 mb-3 border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ct,{className:"h-4 w-4 text-blue-400"}),e.jsx("h5",{className:"text-sm font-medium text-blue-400",children:"Orari Effettivi"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs mb-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Check-in:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(v)}),u.is_rectified&&u.original_start_time&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",x(u.original_start_time)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Check-out:"}),e.jsx("div",{className:"text-white font-bold mt-1",children:x(S)}),u.is_rectified&&u.original_end_time&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",x(u.original_end_time)]}),u.is_rectified&&!u.original_end_time&&u.rectified_end_time&&e.jsxs("div",{className:"text-xs text-green-400 mt-1 flex items-center space-x-1",children:[e.jsx(ft,{className:"h-3 w-3"}),e.jsx("span",{children:"Aggiunto via rettifica"})]})]})]}),u.total_hours&&e.jsx("div",{className:"border-t border-gray-700 pt-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-gray-400",children:"Ore Totali:"}),e.jsxs("span",{className:"text-sm font-bold text-blue-400",children:[u.total_hours,"h"]})]})})]}):e.jsx("div",{className:"bg-gray-800 rounded-lg p-3 mb-3 border-l-4 border-gray-600",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-xs text-gray-400",children:u?"Turno in corso - Check-out non effettuato":"Nessun check-in registrato"})]})}),p&&g&&e.jsxs("div",{className:"bg-green-900 bg-opacity-20 border border-green-700 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(Ss,{className:"h-4 w-4 text-green-400"}),e.jsx("h5",{className:"text-sm font-medium text-green-400",children:"Benefit Ricevuti"})]}),e.jsxs("div",{className:"space-y-2",children:[u.meal_voucher&&u.meal_voucher_amount&&u.meal_voucher_amount>0&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(As,{className:"h-4 w-4 text-yellow-400"}),e.jsx("span",{className:"text-sm text-gray-200",children:"Buono Pasto"})]}),e.jsxs("span",{className:"text-sm font-bold text-yellow-400",children:["‚Ç¨",u.meal_voucher_amount.toFixed(2)]})]}),u.company_meal&&u.company_meal_cost&&u.company_meal_cost>0&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(As,{className:"h-4 w-4 text-orange-400"}),e.jsx("span",{className:"text-sm text-gray-200",children:"Pasto Aziendale"})]}),e.jsxs("span",{className:"text-sm font-bold text-orange-400",children:["‚Ç¨",u.company_meal_cost.toFixed(2)]})]}),u.diaria_type&&u.diaria_type!=="nessuna"&&u.diaria_amount&&u.diaria_amount>0&&e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ts,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-gray-200",children:b(u.diaria_type)})]}),e.jsxs("span",{className:"text-sm font-bold text-purple-400",children:["‚Ç¨",u.diaria_amount.toFixed(2)]})]}),f&&f.length>0&&f.map((R,C)=>{if(!R.applied)return null;const D=J=>{switch(J==null?void 0:J.toLowerCase()){case"trasferta":return Ts;case"benefit":return Ss;case"rimborso":return Sa;default:return kr}},E=J=>{switch(J==null?void 0:J.toLowerCase()){case"trasferta":return"text-purple-400";case"benefit":return"text-green-400";case"rimborso":return"text-cyan-400";default:return"text-yellow-400"}},U=D(R.category),q=E(R.category);return e.jsxs("div",{className:"flex items-center justify-between bg-gray-800 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(U,{className:`h-4 w-4 ${q}`}),e.jsx("span",{className:"text-sm text-gray-200",children:R.name})]}),e.jsxs("span",{className:`text-sm font-bold ${q}`,children:["‚Ç¨",R.amount.toFixed(2)]})]},C)}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-900 bg-opacity-30 border border-blue-700 rounded px-3 py-2 mt-3",children:[e.jsx("span",{className:"text-sm font-bold text-white",children:"Totale Benefit:"}),e.jsxs("span",{className:"text-lg font-bold text-blue-400",children:["‚Ç¨",j.toFixed(2)]})]})]})]}),k&&e.jsxs("div",{className:"bg-blue-900 bg-opacity-20 border border-blue-600 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(kr,{className:"h-4 w-4 text-blue-400"}),e.jsx("h5",{className:"text-sm font-medium text-blue-400",children:"Bonus/Benefit Previsti"})]}),e.jsxs("div",{className:"space-y-1 text-xs",children:[c.tariffa_evento_assegnata&&e.jsxs("div",{className:"flex items-center justify-between text-gray-200",children:[e.jsx("span",{children:"Tariffa Base:"}),e.jsxs("span",{className:"font-semibold",children:["‚Ç¨",c.tariffa_evento_assegnata.toFixed(2)]})]}),M&&e.jsxs("div",{className:"flex items-center justify-between text-yellow-300",children:[e.jsx("span",{children:"Bonus Fisso:"}),e.jsxs("span",{className:"font-semibold",children:["‚Ç¨",c.bonus_previsti.toFixed(2)]})]}),c.bonus_trasferta&&e.jsx("div",{className:"flex items-center text-purple-300",children:e.jsx("span",{children:"Bonus Trasferta Previsto"})}),c.bonus_diaria&&e.jsx("div",{className:"flex items-center text-purple-300",children:e.jsx("span",{children:"Diaria Prevista"})}),B&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-blue-800",children:[e.jsx("div",{className:"text-blue-200 mb-1",children:"Altri benefit previsti:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:c.benefits_evento_nomi.map((R,C)=>e.jsx("span",{className:"bg-blue-800 text-blue-200 px-2 py-0.5 rounded text-xs",children:R},C))})]}),e.jsx("div",{className:"mt-2 pt-2 border-t border-blue-800 text-blue-200 text-center",children:"Gli importi effettivi verranno calcolati al check-out"})]})]}),(u==null?void 0:u.is_rectified)&&u.rectification_notes&&e.jsx("div",{className:"bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-orange-200 mb-1",children:"Nota di Rettifica:"}),e.jsx("div",{className:"text-xs text-orange-300",children:u.rectification_notes})]})]})}),e.jsxs("div",{className:"space-y-2 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ut,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm text-white",children:c.evento_localita})]}),c.evento_trasferta&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ts,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-purple-300",children:"Evento con Trasferta"})]})]}),e.jsxs("button",{onClick:l,className:"w-full flex items-center justify-center space-x-2 px-4 py-2 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700 transition-colors border border-orange-500",children:[e.jsx(hi,{className:"h-4 w-4"}),e.jsx("span",{children:"RETTIFICA ORARIO"})]}),!g&&u&&e.jsx("div",{className:"mt-2 text-xs text-center text-gray-400",children:"I benefit verranno calcolati al check-out"})]})},Hd=()=>{var pe,me;const{user:n}=ds(),[l,c]=w.useState([]),[u,f]=w.useState(null),[x,b]=w.useState(new Date().getMonth()),[v,S]=w.useState(new Date().getFullYear()),[g,j]=w.useState(!0),[p,M]=w.useState(null),[B,k]=w.useState(null),[R,C]=w.useState([]),[D,E]=w.useState([]),[U,q]=w.useState(!1),[J,N]=w.useState(null),[_,L]=w.useState("events"),[I,K]=w.useState(""),[O,W]=w.useState("all"),[se,G]=w.useState([]),$=Q=>String(Q).padStart(2,"0"),F=Q=>`${Q.getFullYear()}-${$(Q.getMonth()+1)}-${$(Q.getDate())}`,re=Q=>{if(!Q)return new Date(NaN);const V=Q.split("-").map(de=>parseInt(de,10));return V.length!==3?new Date(Q):new Date(V[0],V[1]-1,V[2])};w.useEffect(()=>{n!=null&&n.id&&_e()},[n==null?void 0:n.id,x,v]),w.useEffect(()=>{(async()=>{if(n!=null&&n.id)try{const{data:V,error:de}=await Le.from("warehouse_checkins_enriched").select("warehouse_id, warehouse_name").eq("crew_id",n.id).not("warehouse_id","is",null);if(de)throw de;const ae=new Map;(V||[]).forEach((be,ye)=>{const Ce=be.warehouse_id,Ne=be.warehouse_name||`Magazzino ${ye+1}`;Ce&&!ae.has(Ce)&&ae.set(Ce,Ne)});const le=Array.from(ae.entries()).map(([be,ye])=>({id:be,name:ye}));G(le)}catch(V){console.error("Errore caricamento magazzini:",V)}})()},[n==null?void 0:n.id]),w.useEffect(()=>{let Q=[...R];I&&(Q=Q.filter(V=>V.giorno_turno===I)),O!=="all"&&(Q=Q.filter(V=>V.warehouse_id===O)),E(Q)},[R,I,O]);const _e=async()=>{try{j(!0),k(null),console.log("üìä Caricamento report per user:",n==null?void 0:n.id),console.log("üìÖ Periodo:",{month:x+1,year:v});const{data:Q,error:V}=await Le.from("registration_requests").select(`
          *,
          regaziendasoftware!parent_company_id(ragione_sociale)
        `).eq("auth_user_id",n==null?void 0:n.id).single();if(V||!Q){console.error("‚ùå Errore caricamento profilo:",V),k("Errore nel caricamento del profilo utente");return}M(Q),console.log("‚úÖ Profilo caricato:",Q.full_name);const de=new Date(v,x,1),ae=new Date(v,x+1,0),le=F(de),be=F(ae);console.log("‚è± Intervallo locale usato per query:",{startDate:le,endDate:be});const{data:ye,error:Ce}=await Le.from("crew_event_assegnazione").select("*").eq("dipendente_freelance_id",n==null?void 0:n.id).gte("giorno_inizio_evento",le).lte("giorno_inizio_evento",be).order("giorno_inizio_evento",{ascending:!0});if(Ce){console.error("‚ùå Errore caricamento eventi mese:",Ce),k("Errore nel caricamento degli eventi del mese");return}console.log("üìÖ Eventi del mese trovati:",(ye==null?void 0:ye.length)||0);const{data:Ne,error:Ae}=await Le.from("crew_assegnazionetariffa").select("tariffe_ids").eq("dipendente_id",n==null?void 0:n.id).eq("attivo",!0);if(Ae){console.error("‚ùå Errore caricamento tariffe dipendente:",Ae),k("Errore nel caricamento delle tariffe del dipendente");return}console.log("üí∞ Assegnazioni tariffe trovate:",(Ne==null?void 0:Ne.length)||0);const Ue={};if(Ne&&Ne.length>0){const ve=[];if(Ne.forEach(Qe=>{Qe.tariffe_ids&&Qe.tariffe_ids.length>0&&ve.push(...Qe.tariffe_ids)}),console.log("üîç ID tariffe da caricare:",ve),ve.length>0){const{data:Qe,error:nt}=await Le.from("crew_tariffe").select("*").in("id",ve).eq("attivo",!0);if(nt){console.error("‚ùå Errore caricamento dettagli tariffe:",nt),k("Errore nel caricamento dei dettagli delle tariffe");return}console.log("‚úÖ Tariffe caricate:",(Qe==null?void 0:Qe.length)||0),Qe==null||Qe.forEach(pt=>{Ue[pt.id]={id:pt.id,nome_tariffa:pt.nome_tariffa,categoria:pt.categoria,tipo_calcolo:pt.tipo_calcolo,importo:pt.importo,attivo:pt.attivo}})}}console.log("üí∞ Benefit dipendente disponibili:",Object.keys(Ue).length);const{data:qe,error:rt}=await Le.from("timesheet_entries").select(`
          id,
          crew_id,
          event_id,
          date,
          start_time,
          end_time,
          total_hours,
          status,
          meal_voucher,
          meal_voucher_amount,
          company_meal,
          company_meal_cost,
          diaria_type,
          diaria_amount,
          other_benefits_amount,
          total_benefits,
          is_rectified,
          rectification_notes,
          rectified_by,
          rectified_at,
          original_start_time,
          original_end_time,
          rectified_start_time,
          rectified_end_time,
          convocation_start_time,
          convocation_end_time
        `).eq("crew_id",n==null?void 0:n.id).gte("date",le).lte("date",be);rt&&console.error("‚ùå Errore caricamento timesheet:",rt),console.log("üìã Timesheet entries trovati:",(qe==null?void 0:qe.length)||0);const at={};qe==null||qe.forEach(ve=>{at[ve.event_id]=ve});let Ke=[];const Je=[];let Ge=0,yt=0,Ye=0;const Te={warehouse:0,event:0,event_travel:0},H={},ne=[];for(const ve of ye||[]){console.log(`
üé≠ CALCOLO REPORT EVENTO: "${ve.nome_evento}"`);const Qe=[],nt=[];let pt=0;if(ve.benefits_evento_ids&&ve.benefits_evento_ids.length>0&&ve.benefits_evento_ids.forEach(St=>{const ht=Ue[St];ht?(Qe.push({id:ht.id,nome_tariffa:ht.nome_tariffa,categoria:ht.categoria,importo:ht.importo,applied:!0}),pt+=ht.importo,H[ht.categoria]||(H[ht.categoria]={count:0,amount:0}),H[ht.categoria].count++,H[ht.categoria].amount+=ht.importo,nt.push({name:ht.nome_tariffa,amount:ht.importo,category:ht.categoria,applied:!0}),console.log(`‚úÖ BENEFIT APPLICATO: ${ht.nome_tariffa} = ‚Ç¨${ht.importo}`)):(nt.push({name:`Benefit ID: ${St}`,amount:0,category:"non_disponibile",applied:!1,reason:"Benefit non presente nel contratto del dipendente"}),console.log(`‚ùå BENEFIT NON APPLICABILE: ID ${St}`))}),ve.bonus_trasferta&&ve.evento_trasferta){const St=Object.values(Ue).find(ht=>ht.categoria==="indennita_trasferta"||ht.nome_tariffa.toLowerCase().includes("trasferta"));St&&!Qe.find(ht=>ht.id===St.id)&&(Qe.push({id:St.id,nome_tariffa:St.nome_tariffa,categoria:St.categoria,importo:St.importo,applied:!0}),pt+=St.importo,H[St.categoria]||(H[St.categoria]={count:0,amount:0}),H[St.categoria].count++,H[St.categoria].amount+=St.importo,console.log(`‚úÖ BONUS TRASFERTA: ${St.nome_tariffa} = ‚Ç¨${St.importo}`))}ve.bonus_previsti&&ve.bonus_previsti>0&&(pt+=ve.bonus_previsti,nt.push({name:"Bonus Evento Fisso",amount:ve.bonus_previsti,category:"bonus_evento",applied:!0}),console.log(`‚úÖ BONUS FISSO EVENTO: ‚Ç¨${ve.bonus_previsti}`));const Oe=ve.tariffa_evento_assegnata||0,At=Oe+pt;Ge+=Oe,yt+=pt;const it=at[ve.evento_id],ks=it&&it.start_time;if(ks&&(it.status==="active"||it.status==="completed"||it.status==="submitted")){ve.nome_evento.toLowerCase().includes("magazzino")?Te.warehouse++:ve.evento_trasferta?(console.log("‚úàÔ∏è EVENTO TRASFERTA TROVATO:",{nome:ve.nome_evento,evento_trasferta:ve.evento_trasferta,hasCheckedIn:ks,status:it==null?void 0:it.status,id:ve.id}),Te.event_travel++):Te.event++;const St=re(ve.giorno_inizio_evento),ht=re(ve.giorno_fine_evento),Jt=new Date(St);for(;Jt<=ht;)ne.push(F(Jt)),Jt.setDate(Jt.getDate()+1)}Je.push({assignment:ve,timesheet:it?{id:it.id,start_time:it.start_time,end_time:it.end_time,status:it.status,total_hours:it.total_hours,meal_voucher:it.meal_voucher,meal_voucher_amount:it.meal_voucher_amount,company_meal:it.company_meal,company_meal_cost:it.company_meal_cost,diaria_type:it.diaria_type,diaria_amount:it.diaria_amount,other_benefits_amount:it.other_benefits_amount,total_benefits:it.total_benefits,is_rectified:it.is_rectified,rectification_notes:it.rectification_notes,original_start_time:it.original_start_time,original_end_time:it.original_end_time,rectified_start_time:it.rectified_start_time,rectified_end_time:it.rectified_end_time,convocation_start_time:it.convocation_start_time,convocation_end_time:it.convocation_end_time}:void 0,applicableBenefits:Qe,totalBenefitsAmount:pt,totalEventAmount:At,benefitBreakdown:nt}),console.log(`üí∞ TOTALE EVENTO "${ve.nome_evento}": ‚Ç¨${At} (base: ‚Ç¨${Oe} + benefit: ‚Ç¨${pt})`)}c(Je);const{data:fe,error:Ie}=await Le.from("warehouse_checkins_enriched").select("*").eq("crew_id",n==null?void 0:n.id).gte("date",le).lte("date",be).order("date",{ascending:!1}),{data:Re,error:ee}=await Le.from("extra_shifts_checkins").select("*").eq("crew_id",n==null?void 0:n.id).gte("date",le).lte("date",be).order("date",{ascending:!1});if(Ie?console.error("‚ùå Errore caricamento turni (enriched):",Ie):console.log("‚úÖ Turni trovati (enriched):",(fe==null?void 0:fe.length)||0),ee?console.error("‚ùå Errore caricamento turni extra:",ee):console.log("‚úÖ Turni extra trovati:",(Re==null?void 0:Re.length)||0),!Ie||!ee){const ve=(fe||[]).map(Oe=>{const At=Oe.rectified_check_in_time||Oe.check_in_time,it=Oe.rectified_check_out_time||Oe.check_out_time,ks=Oe.rectified_total_hours||parseFloat(Oe.total_hours)||0,Kt=Oe.rectified_pausa_pranzo!==null?Oe.rectified_pausa_pranzo:Oe.pausa_pranzo||!1,St=Oe.notes||Oe.noteturno||"",Jt=typeof St=="string"&&St.toLowerCase().includes("turno extra")?"TURNO EXTRA":Oe.warehouse_name||Oe.noteturno||"Turno Magazzino";return{id:Oe.id,turno_id:Oe.shift_id||"",warehouse_id:Oe.warehouse_id||"",warehouse_name:Oe.warehouse_name||"",notes:Oe.notes||"",noteturno:Oe.noteturno||"",giorno_turno:Oe.date,nome_turno:Jt,check_in_turno:At,check_out_turno:it,conteggio_ore:ks,buoni_pasto_assegnato:Oe.meal_voucher||!1,pasto_aziendale_usufruito:Oe.company_meal||!1,ore_straordinario:parseFloat(Oe.overtime_hours)||0,ore_previste:8,pausa_pranzo:Kt,pausa_cena:!1,pausa_pranzo_inizio:Oe.pausa_pranzo_inizio||Oe.break_start_time,pausa_pranzo_fine:Oe.pausa_pranzo_fine||Oe.break_end_time,pausa_pranzo_minuti:Oe.pausa_pranzo_minuti||Oe.break_minutes,pausa_cena_inizio:void 0,pausa_cena_fine:void 0,pausa_cena_minuti:void 0,pausa_totale_minuti:Oe.pausa_totale_minuti||Oe.break_minutes,status:Oe.status,is_rectified:!!Oe.rectified_at,rectification_note:Oe.rectification_note||null,original_check_in:Oe.check_in_time,original_check_out:Oe.check_out_time,original_pausa_pranzo:Oe.pausa_pranzo||!1,rectified_check_in:Oe.rectified_check_in_time,rectified_check_out:Oe.rectified_check_out_time,rectified_pausa_pranzo:Oe.rectified_pausa_pranzo,auto_checkout:Oe.auto_checkout||!1}}),Qe=(Re||[]).map(Oe=>{const At=Oe.rectified_check_in_time||Oe.check_in_time,it=Oe.rectified_check_out_time||Oe.check_out_time,ks=Oe.rectified_total_hours||parseFloat(Oe.total_hours)||0,Kt=Oe.rectified_pausa_pranzo!==null?Oe.rectified_pausa_pranzo:Oe.has_taken_break||!1;return{id:Oe.id,turno_id:"",warehouse_id:"",warehouse_name:"",notes:Oe.notes||"",noteturno:Oe.NoteTurno||"",giorno_turno:Oe.date,nome_turno:"TURNO EXTRA",check_in_turno:At,check_out_turno:it,conteggio_ore:ks,buoni_pasto_assegnato:Oe.meal_voucher||!1,pasto_aziendale_usufruito:Oe.company_meal||!1,ore_straordinario:parseFloat(Oe.overtime_hours)||0,ore_previste:8,pausa_pranzo:Kt,pausa_cena:!!(Oe.pausa_cena_inizio&&Oe.pausa_cena_fine),pausa_pranzo_inizio:Oe.pausa_pranzo_inizio||Oe.break_start_time,pausa_pranzo_fine:Oe.pausa_pranzo_fine||Oe.break_end_time,pausa_pranzo_minuti:Oe.pausa_pranzo_minuti||Oe.break_minutes,pausa_cena_inizio:Oe.pausa_cena_inizio,pausa_cena_fine:Oe.pausa_cena_fine,pausa_cena_minuti:Oe.pausa_cena_minuti,pausa_totale_minuti:Oe.pausa_totale_minuti,status:Oe.status,is_rectified:!!Oe.rectified_at,rectification_note:Oe.rectification_note||null,original_check_in:Oe.check_in_time,original_check_out:Oe.check_out_time,original_pausa_pranzo:Oe.has_taken_break||!1,rectified_check_in:Oe.rectified_check_in_time,rectified_check_out:Oe.rectified_check_out_time,rectified_pausa_pranzo:Oe.rectified_pausa_pranzo,auto_checkout:!1}}),nt=[...ve,...Qe].sort((Oe,At)=>new Date(At.giorno_turno).getTime()-new Date(Oe.giorno_turno).getTime());C(nt),Ke=nt.filter(Oe=>Oe.status==="completed"&&Oe.check_out_turno),console.log("üìã Turni totali:",nt.length),console.log("üìã Turni completati:",Ke.length);const pt=Ke.length;Te.warehouse+=pt,Ke.forEach(Oe=>{Ye+=Oe.ore_straordinario||0,ne.push(Oe.giorno_turno)}),console.log(`üìÖ Turni magazzino completati: ${Ke.length}`)}let oe=0;try{const{data:ve,error:Qe}=await Le.from("expenses").select("id").eq("crew_id",n==null?void 0:n.id).gte("expense_date",le).lte("expense_date",be);if(Qe)throw Qe;oe=(ve==null?void 0:ve.length)||0}catch(ve){console.error("‚ùå Errore caricamento note spese:",ve)}let De=0,Ee=0,te=0,ke=0;p&&(De=p.vacation_days_used||0,Ee=(p.vacation_days_total||0)-De,te=p.leave_days_used||0,ke=(p.leave_days_total||0)-te);const he=new Set(ne).size;console.log(`üìÖ Giorni lavorati unici totali: ${he} (da ${ne.length} date totali)`);const we={month:new Date(v,x).toLocaleDateString("it-IT",{month:"long"}),year:v,totalEvents:Je.length+Ke.length,totalDays:he,totalShifts:Ke.length,eventsByType:Te,expensesCount:oe,overtimeHours:Ye,vacationRequested:De,vacationRemaining:Ee,leaveRequested:te,leaveRemaining:ke};f(we),console.log("üìä REPORT MENSILE COMPLETO:",we),console.log("üì¶ Turni magazzino conteggiati:",Te.warehouse),console.log("‚úàÔ∏è EVENTI TRASFERTA CONTEGGIATI:",Te.event_travel),console.log("üìÖ EVENTI STANDARD CONTEGGIATI:",Te.event)}catch(Q){console.error("‚ùå Errore generale caricamento report:",Q),k(`Errore nel caricamento del report: ${Q instanceof Error?Q.message:"Errore sconosciuto"}`)}finally{j(!1)}},ge=Q=>{if(!Q)return"Non specificato";if(/^\d{2}:\d{2}$/.test(Q))return Q;if(/^\d{2}:\d{2}:\d{2}$/.test(Q))return Q.substring(0,5);try{const V=new Date(Q);if(!isNaN(V.getTime()))return V.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})}catch(V){console.error("Errore parsing timestamp:",V)}return Q},X=()=>{var V;if(!u)return;const Q={dipendente:(p==null?void 0:p.full_name)||"Dipendente",azienda:((V=p==null?void 0:p.regaziendasoftware)==null?void 0:V.ragione_sociale)||"Azienda",periodo:`${u.month} ${u.year}`,eventi:l.length,importoTotale:u.totalAmount,benefitTotali:u.benefitsAmount};console.log("üìÑ Download report:",Q),alert(`üìÑ Report ${u.month} ${u.year} generato!`)};return g?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Generazione report..."})]})}):B?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(Zt,{className:"h-16 w-16 mx-auto mb-4 text-red-400"}),e.jsx("p",{className:"text-lg text-red-400",children:"Errore nel caricamento"}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:B}),e.jsx("button",{onClick:()=>_e(),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Riprova"})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white",children:[e.jsxs("div",{className:"p-4 pb-20 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Report Mensile"}),e.jsx("p",{className:"text-gray-300",children:(p==null?void 0:p.full_name)||"Dipendente"}),e.jsx("p",{className:"text-sm text-blue-400",children:((pe=p==null?void 0:p.regaziendasoftware)==null?void 0:pe.ragione_sociale)||"La Mia Azienda"})]}),e.jsx("button",{onClick:X,disabled:!u,className:"bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-600",children:e.jsx(hr,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(ya,{className:"h-5 w-5 text-gray-400"}),e.jsx("select",{value:x,onChange:Q=>b(Number(Q.target.value)),className:"bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white",children:Array.from({length:12},(Q,V)=>e.jsx("option",{value:V,children:new Date(2024,V).toLocaleDateString("it-IT",{month:"long"})},V))}),e.jsxs("select",{value:v,onChange:Q=>S(Number(Q.target.value)),className:"bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white",children:[e.jsx("option",{value:2024,children:"2024"}),e.jsx("option",{value:2025,children:"2025"})]})]})}),e.jsx("div",{className:"bg-gray-800 rounded-xl border border-gray-700 overflow-hidden",children:e.jsxs("div",{className:"grid grid-cols-2",children:[e.jsxs("button",{onClick:()=>L("events"),className:`flex items-center justify-center space-x-2 py-4 px-4 transition-all ${_==="events"?"bg-blue-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:[e.jsx(ut,{className:"h-5 w-5"}),e.jsx("span",{className:"font-semibold",children:"Eventi"}),l.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full ${_==="events"?"bg-blue-500":"bg-gray-600"}`,children:l.length})]}),e.jsxs("button",{onClick:()=>L("warehouse"),className:`flex items-center justify-center space-x-2 py-4 px-4 transition-all ${_==="warehouse"?"bg-blue-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:[e.jsx(zt,{className:"h-5 w-5"}),e.jsx("span",{className:"font-semibold",children:"Turni"}),R.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full ${_==="warehouse"?"bg-blue-500":"bg-gray-600"}`,children:R.length})]})]})}),u&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Riepilogo ",u.month," ",u.year]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(zt,{className:"h-5 w-5 mx-auto mb-1 text-gray-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:u.eventsByType.warehouse}),e.jsx("div",{className:"text-xs text-gray-400",children:"Turni Magazzino"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(ut,{className:"h-5 w-5 mx-auto mb-1 text-blue-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:u.eventsByType.event}),e.jsx("div",{className:"text-xs text-gray-400",children:"Eventi"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(Ts,{className:"h-5 w-5 mx-auto mb-1 text-orange-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:u.eventsByType.event_travel}),e.jsx("div",{className:"text-xs text-gray-400",children:"Trasferte"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(ut,{className:"h-5 w-5 mx-auto mb-1 text-blue-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:u.totalDays}),e.jsx("div",{className:"text-xs text-gray-400",children:"Giorni"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(xi,{className:"h-5 w-5 mx-auto mb-1 text-yellow-400"}),e.jsx("div",{className:"text-lg font-bold text-white",children:u.expensesCount}),e.jsx("div",{className:"text-xs text-gray-400",children:"Note Spese"})]}),e.jsxs("div",{className:"text-center p-3 bg-gray-700 rounded-lg",children:[e.jsx(ct,{className:"h-5 w-5 mx-auto mb-1 text-green-400"}),e.jsxs("div",{className:"text-lg font-bold text-white",children:[u.overtimeHours.toFixed(1),"h"]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Straordinari"})]})]})]}),_==="events"&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Dettaglio Eventi (",l.length,")"]}),l.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(ut,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsx("p",{children:"Nessun evento nel periodo selezionato"}),e.jsx("p",{className:"text-sm mt-1",children:"Seleziona un mese diverso o attendi nuove assegnazioni"})]}):e.jsx("div",{className:"space-y-4",children:l.map(Q=>e.jsx(qd,{report:{...Q,benefitBreakdown:Q.benefitBreakdown},onRectify:()=>{N(Q),q(!0)}},Q.assignment.id))})]}),_==="warehouse"&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Turni Magazzino (",D.length,R.length!==D.length?` di ${R.length}`:"",")"]}),e.jsxs("div",{className:"mb-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Giorno Specifico:"}),e.jsx("input",{type:"date",value:I,onChange:Q=>K(Q.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",placeholder:"Seleziona un giorno..."}),I&&e.jsx("button",{onClick:()=>K(""),className:"mt-2 text-xs text-blue-400 hover:text-blue-300",children:"Rimuovi filtro data"})]}),se.length>1&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-300 mb-2",children:"Filtra per Magazzino:"}),e.jsxs("select",{value:O,onChange:Q=>W(Q.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm",children:[e.jsx("option",{value:"all",children:"Tutti i Magazzini"}),se.map(Q=>e.jsx("option",{value:Q.id,children:Q.name},Q.id))]})]}),(I||O!=="all")&&e.jsxs("div",{className:"bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-2 text-xs text-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ya,{className:"h-3 w-3"}),e.jsx("span",{className:"font-semibold",children:"Filtri attivi:"})]}),e.jsxs("div",{className:"mt-1 space-y-1",children:[I&&e.jsxs("div",{children:["Data: ",re(I).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"})]}),O!=="all"&&e.jsxs("div",{children:["Magazzino: ",(me=se.find(Q=>Q.id===O))==null?void 0:me.name]})]})]})]}),D.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(zt,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsxs("p",{children:["Nessun turno ",I||O!=="all"?"trovato con i filtri selezionati":"nel periodo selezionato"]}),e.jsx("p",{className:"text-sm mt-1",children:I||O!=="all"?"Prova a modificare i filtri":"I turni appariranno qui"})]}):e.jsx("div",{className:"space-y-3",children:D.map(Q=>{const V=Q.check_out_turno||Q.rectified_check_out,de=Q.status!=="completed"||!V;return e.jsxs("div",{className:"bg-gray-700 rounded-lg p-4 border border-gray-600",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h4",{className:"font-bold text-white",children:Q.nome_turno||"Turno Magazzino"}),Q.is_rectified&&e.jsx("span",{className:"bg-orange-600 text-white text-xs px-2 py-0.5 rounded font-semibold",children:"Rettificato"})]}),e.jsx("p",{className:"text-sm text-gray-400",children:re(Q.giorno_turno).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})})]}),e.jsx("div",{className:"text-right",children:de?e.jsx("div",{className:"text-sm text-orange-400 font-semibold",children:"In corso"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-lg font-bold text-blue-400",children:[Q.conteggio_ore,"h"]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Ore Lavorate"})]})})]}),e.jsx("div",{className:"bg-gray-800 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[e.jsx(ct,{className:"h-3 w-3 text-green-400"}),e.jsx("span",{className:"text-gray-400 font-medium",children:"Check-in:"})]}),e.jsx("div",{className:"text-white font-semibold",children:ge(Q.check_in_turno)||"--:--"}),Q.is_rectified&&Q.original_check_in&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",ge(Q.original_check_in)]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[e.jsx(ct,{className:"h-3 w-3 text-red-400"}),e.jsx("span",{className:"text-gray-400 font-medium",children:"Check-out:"})]}),de?e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-orange-400 font-semibold",children:"In corso"}),Q.is_rectified&&Q.rectified_check_out&&e.jsxs("div",{className:"text-green-400 text-xs mt-1 flex items-center space-x-1",children:[e.jsx(ft,{className:"h-3 w-3"}),e.jsxs("span",{children:["Chiuso via rettifica: ",ge(Q.rectified_check_out)]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-white font-semibold flex items-center space-x-1 flex-wrap",children:[e.jsx("span",{children:ge(Q.check_out_turno)||"--:--"}),Q.auto_checkout&&e.jsx("span",{className:"text-xs bg-purple-900 text-purple-200 px-1 py-0.5 rounded",title:"Checkout automatico",children:"AUTO"}),Q.is_rectified&&Q.rectified_check_out&&!Q.original_check_out&&e.jsx("span",{className:"text-xs bg-green-900 text-green-200 px-1 py-0.5 rounded",title:"Chiuso via rettifica",children:"RETTIFICA"})]}),Q.is_rectified&&Q.original_check_out&&Q.rectified_check_out&&e.jsxs("div",{className:"text-gray-500 line-through text-xs mt-1",children:["Era: ",ge(Q.original_check_out),Q.auto_checkout&&e.jsx("span",{className:"ml-1",children:"(AUTO)"})]}),Q.is_rectified&&!Q.original_check_out&&Q.rectified_check_out&&e.jsx("div",{className:"text-gray-500 text-xs mt-1 italic",children:"(Non era stato effettuato)"})]})]})]})}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 mb-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(As,{className:"h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-sm text-gray-300",children:"Pausa Pranzo:"})]}),e.jsxs("div",{className:"text-right",children:[Q.pausa_pranzo?e.jsxs("div",{children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"S√¨"}),Q.pausa_pranzo_inizio&&Q.pausa_pranzo_fine&&e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[Q.pausa_pranzo_inizio," - ",Q.pausa_pranzo_fine,Q.pausa_pranzo_minuti&&` (${Q.pausa_pranzo_minuti} min)`]})]}):e.jsx("span",{className:"text-gray-500",children:"No"}),Q.is_rectified&&Q.original_pausa_pranzo!==Q.pausa_pranzo&&e.jsxs("div",{className:"text-xs text-gray-500 line-through mt-1",children:["Era: ",Q.original_pausa_pranzo?"S√¨":"No"]})]})]}),Q.pausa_cena&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-700",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Bs,{className:"h-4 w-4 text-purple-400"}),e.jsx("span",{className:"text-sm text-gray-300",children:"Pausa Cena:"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-green-400 font-semibold",children:"S√¨"}),Q.pausa_cena_inizio&&Q.pausa_cena_fine&&e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[Q.pausa_cena_inizio," - ",Q.pausa_cena_fine,Q.pausa_cena_minuti&&` (${Q.pausa_cena_minuti} min)`]})]})]}),Q.pausa_totale_minuti&&Q.pausa_totale_minuti>0&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-700",children:[e.jsx("span",{className:"text-xs text-gray-400",children:"Pausa Totale:"}),e.jsxs("span",{className:"text-xs text-gray-300 font-semibold",children:[Q.pausa_totale_minuti," minuti"]})]})]}),(Q.notes||Q.noteturno)&&e.jsx("div",{className:"bg-blue-900 bg-opacity-20 border border-blue-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Ht,{className:"h-4 w-4 text-blue-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-200 mb-1",children:"Note:"}),e.jsx("div",{className:"text-xs text-blue-100",children:Q.notes||Q.noteturno})]})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs mb-2",children:[Q.buoni_pasto_assegnato&&e.jsxs("span",{className:"bg-yellow-900 text-yellow-200 px-2 py-1 rounded flex items-center space-x-1",children:[e.jsx(Ss,{className:"h-3 w-3"}),e.jsx("span",{children:"Buono Pasto"})]}),Q.pasto_aziendale_usufruito&&e.jsxs("span",{className:"bg-orange-900 text-orange-200 px-2 py-1 rounded flex items-center space-x-1",children:[e.jsx(Bs,{className:"h-3 w-3"}),e.jsx("span",{children:"Pasto Aziendale"})]})]}),Q.is_rectified&&Q.rectification_note&&e.jsx("div",{className:"bg-orange-900 bg-opacity-30 border border-orange-700 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-orange-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-orange-200 mb-1",children:"Nota di Rettifica:"}),e.jsx("div",{className:"text-xs text-orange-300",children:Q.rectification_note})]})]})}),e.jsx(Ud,{shift:Q,onUpdate:_e})]},Q.id)})})]}),!u&&!g&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700 text-center",children:[e.jsx(Ht,{className:"h-12 w-12 mx-auto mb-4 text-gray-600"}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Nessun Dato Disponibile"}),e.jsx("p",{className:"text-gray-300",children:"Non ci sono eventi per il periodo selezionato."}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Prova a selezionare un mese diverso o attendi nuove assegnazioni."})]}),e.jsx(xn,{})]}),U&&J&&e.jsx(Vd,{event:{id:J.assignment.id,evento_id:J.assignment.evento_id,nome_evento:J.assignment.nome_evento,giorno_inizio_evento:J.assignment.giorno_inizio_evento,giorno_fine_evento:J.assignment.giorno_fine_evento},existingTimesheet:J.timesheet,onClose:()=>{q(!1),N(null)},onSuccess:()=>{_e()}})]})},Gd=({isOpen:n,title:l,message:c,onConfirm:u,onCancel:f,confirmText:x="Conferma",cancelText:b="Annulla",type:v="warning"})=>{if(!n)return null;const S={danger:"bg-red-600 hover:bg-red-700",success:"bg-green-600 hover:bg-green-700",warning:"bg-yellow-600 hover:bg-yellow-700"}[v];return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:e.jsxs("div",{className:"bg-gray-900 rounded-xl border border-gray-800 p-6 max-w-md w-full",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:l}),e.jsx("p",{className:"text-gray-300 mb-6",children:c}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:u,className:`flex-1 px-4 py-2 ${S} text-white rounded-lg font-medium`,children:x}),e.jsx("button",{onClick:f,className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium",children:b})]})]})})},Wd=({isOpen:n,dipendenteNome:l,onConfirm:c,onCancel:u})=>{const[f,x]=w.useState("");return n?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:e.jsxs("div",{className:"bg-gray-900 rounded-xl border border-gray-800 p-6 max-w-md w-full",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Rifiuta richiesta"}),e.jsxs("p",{className:"text-gray-300 mb-4",children:["Inserisci il motivo del rifiuto per ",l,":"]}),e.jsx("textarea",{value:f,onChange:b=>x(b.target.value),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-red-500 focus:border-transparent mb-4",rows:3,placeholder:"Motivo del rifiuto..."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{c(f),x("")},className:"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium",children:"Rifiuta"}),e.jsx("button",{onClick:()=>{u(),x("")},className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium",children:"Annulla"})]})]})}):null},Yd=()=>{const{companyProfile:n}=ds(),{showSuccess:l,showError:c}=Or(),[u,f]=w.useState("ferie"),[x,b]=w.useState("pending"),[v,S]=w.useState([]),[g,j]=w.useState([]),[p,M]=w.useState([]),[B,k]=w.useState([]),[R,C]=w.useState([]),[D,E]=w.useState(!1),[U,q]=w.useState(!1),[J,N]=w.useState(!1),[_,L]=w.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}}),[I,K]=w.useState({isOpen:!1,requestId:"",dipendenteNome:""}),[O,W]=w.useState({dipendente_id:"",tipo:"ferie",data_inizio:"",data_fine:"",orario_inizio:"",orario_fine:"",certificato_medico:"",note:""}),[se,G]=w.useState({id:"",dipendente_id:"",tipo:"ferie",data_inizio:"",data_fine:"",orario_inizio:"",orario_fine:"",certificato_medico:"",note:""});w.useEffect(()=>{n!=null&&n.id&&($(),F())},[n==null?void 0:n.id,x]);const $=async()=>{if(n!=null&&n.id)try{const{data:le,error:be}=await Le.from("registration_requests").select("id, full_name, email").eq("parent_company_id",n.id).eq("status","approved").in("tipologia_registrazione",["dipendente","freelance"]).order("full_name",{ascending:!0});if(be)throw be;S(le||[])}catch(le){console.error("Errore caricamento dipendenti:",le)}},F=async()=>{if(n!=null&&n.id){E(!0);try{const le=x==="pending"?"in_attesa":"approvata",[be,ye]=await Promise.all([Le.from("crew_richiesteferie_permessi").select("*").eq("azienda_id",n.id).eq("stato",le).order("created_at",{ascending:!1}),Le.from("crew_malattia_infortunio").select("*").eq("azienda_id",n.id).order("created_at",{ascending:!1})]);if(be.data){const Ce=be.data.filter(Ae=>Ae.tipo_richiesta==="ferie").map(Ae=>({id:Ae.id,dipendente_id:Ae.dipendente_id,dipendente_nome:Ae.dipendente_nome||"N/D",tipo:"ferie",data_inizio:Ae.data_inizio,data_fine:Ae.data_fine,giorni_richiesti:Ae.giorni_richiesti||0,note:Ae.note,stato:Ae.stato,created_at:Ae.created_at})),Ne=be.data.filter(Ae=>Ae.tipo_richiesta==="permesso").map(Ae=>({id:Ae.id,dipendente_id:Ae.dipendente_id,dipendente_nome:Ae.dipendente_nome||"N/D",tipo:"permessi",data_inizio:Ae.data_inizio,data_fine:Ae.data_fine,ore_richieste:Ae.ore_richieste||0,orario_inizio:Ae.orario_inizio,orario_fine:Ae.orario_fine,note:Ae.note,stato:Ae.stato,created_at:Ae.created_at}));j(Ce),M(Ne)}if(ye.data){const Ce=ye.data.filter(Ae=>Ae.tipo==="malattia").map(Ae=>({id:Ae.id,dipendente_id:Ae.dipendente_id,dipendente_nome:Ae.dipendente_nome||"N/D",tipo:"malattia",data_inizio:Ae.data_inizio,data_fine:Ae.data_fine,giorni_totali:Ae.giorni_totali||0,certificato_medico:Ae.certificato_medico,note:Ae.note,created_at:Ae.created_at})),Ne=ye.data.filter(Ae=>Ae.tipo==="infortunio").map(Ae=>({id:Ae.id,dipendente_id:Ae.dipendente_id,dipendente_nome:Ae.dipendente_nome||"N/D",tipo:"infortunio",data_inizio:Ae.data_inizio,data_fine:Ae.data_fine,giorni_totali:Ae.giorni_totali||0,certificato_medico:Ae.certificato_medico,note:Ae.note,created_at:Ae.created_at}));k(Ce),C(Ne)}}catch(le){console.error("Errore caricamento richieste:",le),c("Impossibile caricare le richieste")}finally{E(!1)}}},re=async le=>{try{const{error:be}=await Le.from("crew_richiesteferie_permessi").update({stato:"approvata",approvato_da:n==null?void 0:n.auth_user_id,approvato_il:new Date().toISOString()}).eq("id",le);if(be)throw be;l("Richiesta approvata con successo"),F()}catch(be){console.error("Errore approvazione:",be),c(be.message||"Errore durante l'approvazione")}},_e=async(le,be)=>{try{const{error:ye}=await Le.from("crew_richiesteferie_permessi").update({stato:"rifiutata",approvato_da:n==null?void 0:n.auth_user_id,approvato_il:new Date().toISOString(),motivo_rifiuto:be||"Nessun motivo specificato"}).eq("id",le);if(ye)throw ye;l("Richiesta rifiutata"),F()}catch(ye){console.error("Errore rifiuto:",ye),c(ye.message||"Errore durante il rifiuto")}},ge=async(le,be)=>{try{if(be==="ferie"||be==="permessi"){const{error:ye}=await Le.from("crew_richiesteferie_permessi").delete().eq("id",le);if(ye)throw ye}else{const{error:ye}=await Le.from("crew_malattia_infortunio").delete().eq("id",le);if(ye)throw ye}l("Elemento eliminato con successo"),F()}catch(ye){console.error("Errore eliminazione:",ye),c(ye.message||"Errore durante l'eliminazione")}},X=le=>{if(u==="malattia"||u==="infortunio"){const ye=le;G({id:ye.id,dipendente_id:ye.dipendente_id,tipo:u,data_inizio:ye.data_inizio,data_fine:ye.data_fine,orario_inizio:"",orario_fine:"",certificato_medico:ye.certificato_medico||"",note:ye.note||""})}else{const ye=le;G({id:ye.id,dipendente_id:ye.dipendente_id,tipo:u,data_inizio:ye.data_inizio,data_fine:ye.data_fine,orario_inizio:ye.orario_inizio||"",orario_fine:ye.orario_fine||"",certificato_medico:"",note:ye.note||""})}N(!0)},pe=async le=>{if(le.preventDefault(),!(n!=null&&n.id)||!se.dipendente_id){c("Seleziona un dipendente");return}try{if(se.tipo==="ferie"||se.tipo==="permessi"){let be=0,ye=0,Ce=se.data_fine;if(se.tipo==="permessi"){const[Ae,Ue]=se.orario_inizio.split(":").map(Number),[qe,rt]=se.orario_fine.split(":").map(Number),at=Ae*60+Ue;ye=(qe*60+rt-at)/60,Ce=se.data_inizio}else{const Ae=new Date(se.data_inizio),Ue=new Date(se.data_fine),qe=Math.abs(Ue.getTime()-Ae.getTime());be=Math.ceil(qe/(1e3*60*60*24))+1}const{error:Ne}=await Le.from("crew_richiesteferie_permessi").update({data_inizio:se.data_inizio,data_fine:Ce,giorni_richiesti:be,ore_richieste:ye,orario_inizio:se.tipo==="permessi"?se.orario_inizio:null,orario_fine:se.tipo==="permessi"?se.orario_fine:null,note:se.note||null}).eq("id",se.id);if(Ne)throw Ne;l(`${se.tipo==="ferie"?"Ferie":"Permesso"} modificato con successo`)}else if(se.tipo==="malattia"||se.tipo==="infortunio"){const be=new Date(se.data_inizio),ye=new Date(se.data_fine),Ce=Math.abs(ye.getTime()-be.getTime()),Ne=Math.ceil(Ce/(1e3*60*60*24))+1,{error:Ae}=await Le.from("crew_malattia_infortunio").update({data_inizio:se.data_inizio,data_fine:se.data_fine,giorni_totali:Ne,certificato_medico:se.certificato_medico||null,note:se.note||null}).eq("id",se.id);if(Ae)throw Ae;l(`${se.tipo==="malattia"?"Malattia":"Infortunio"} modificato con successo`)}N(!1),F()}catch(be){console.error("Errore modifica:",be),c(be.message||"Errore durante la modifica")}},me=async le=>{if(le.preventDefault(),!(n!=null&&n.id)||!O.dipendente_id){c("Seleziona un dipendente");return}if(!O.data_inizio){c("Inserisci la data");return}if(O.tipo==="permessi"&&(!O.orario_inizio||!O.orario_fine)){c("Inserisci gli orari per il permesso");return}if(O.tipo!=="permessi"&&!O.data_fine){c("Inserisci la data fine");return}try{const be=v.find(ye=>ye.id===O.dipendente_id);if(O.tipo==="ferie"||O.tipo==="permessi"){let ye=0,Ce=0,Ne=O.data_fine;if(O.tipo==="permessi"){const[qe,rt]=O.orario_inizio.split(":").map(Number),[at,Ke]=O.orario_fine.split(":").map(Number),Je=qe*60+rt;Ce=(at*60+Ke-Je)/60,Ne=O.data_inizio}else{const qe=new Date(O.data_inizio),rt=new Date(O.data_fine),at=Math.abs(rt.getTime()-qe.getTime());ye=Math.ceil(at/(1e3*60*60*24))+1}const Ae=O.tipo==="permessi"?"permesso":"ferie",{error:Ue}=await Le.from("crew_richiesteferie_permessi").insert({azienda_id:n.id,dipendente_id:O.dipendente_id,dipendente_nome:(be==null?void 0:be.full_name)||"",tipo_richiesta:Ae,data_inizio:O.data_inizio,data_fine:Ne,giorni_richiesti:ye,ore_richieste:Ce,orario_inizio:O.tipo==="permessi"?O.orario_inizio:null,orario_fine:O.tipo==="permessi"?O.orario_fine:null,note:O.note||null,stato:"approvata",approvato_da:n.auth_user_id,approvato_il:new Date().toISOString()});if(Ue)throw Ue;l(`${O.tipo==="ferie"?"Ferie":"Permesso"} inserito con successo`)}else if(O.tipo==="malattia"||O.tipo==="infortunio"){const ye=new Date(O.data_inizio),Ce=new Date(O.data_fine),Ne=Math.abs(Ce.getTime()-ye.getTime()),Ae=Math.ceil(Ne/(1e3*60*60*24))+1,{error:Ue}=await Le.from("crew_malattia_infortunio").insert({azienda_id:n.id,dipendente_id:O.dipendente_id,dipendente_nome:(be==null?void 0:be.full_name)||"",tipo:O.tipo,data_inizio:O.data_inizio,data_fine:O.data_fine,giorni_totali:Ae,certificato_medico:O.certificato_medico||null,note:O.note||null});if(Ue)throw Ue;l(`${O.tipo==="malattia"?"Malattia":"Infortunio"} inserito con successo`)}q(!1),W({dipendente_id:"",tipo:"ferie",data_inizio:"",data_fine:"",orario_inizio:"",orario_fine:"",certificato_medico:"",note:""}),F()}catch(be){console.error("Errore inserimento:",be),c(be.message||"Errore nell'inserimento")}},Q=()=>{switch(u){case"ferie":return g;case"permessi":return p;case"malattia":return B;case"infortunio":return R;default:return[]}},V=le=>{var Ae;const be=u==="malattia"||u==="infortunio",ye=le,Ce=le,Ne=x==="pending"&&(u==="ferie"||u==="permessi");return e.jsxs("div",{className:"bg-gray-900 rounded-xl border border-gray-800 p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[be?e.jsx(Va,{className:"w-5 h-5 text-red-500"}):e.jsx(ut,{className:"w-5 h-5 text-blue-500"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-white",children:le.dipendente_nome}),e.jsx("p",{className:"text-xs text-gray-400",children:new Date(le.created_at).toLocaleDateString("it-IT",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})})]})]}),Ne&&e.jsx(ct,{className:"w-5 h-5 text-yellow-500"})]}),e.jsx("div",{className:"space-y-2 mb-4",children:u==="permessi"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Giorno:"}),e.jsx("span",{className:"text-white font-medium",children:new Date(Ce.data_inizio).toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"})})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Orario:"}),e.jsxs("span",{className:"text-white font-medium",children:[Ce.orario_inizio," - ",Ce.orario_fine]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Ore:"}),e.jsxs("span",{className:"text-white font-medium",children:[((Ae=Ce.ore_richieste)==null?void 0:Ae.toFixed(1))||0," h"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Dal:"}),e.jsx("span",{className:"text-white font-medium",children:new Date(le.data_inizio).toLocaleDateString("it-IT",{day:"numeric",month:"short",year:"numeric"})})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Al:"}),e.jsx("span",{className:"text-white font-medium",children:new Date(le.data_fine).toLocaleDateString("it-IT",{day:"numeric",month:"short",year:"numeric"})})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Giorni:"}),e.jsxs("span",{className:"text-white font-medium",children:[be?ye.giorni_totali:Ce.giorni_richiesti," giorni"]})]})]})}),be&&ye.certificato_medico&&e.jsx("div",{className:"mb-4",children:e.jsxs("a",{href:ye.certificato_medico,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 bg-blue-900 text-blue-300 rounded-lg hover:bg-blue-800 text-sm",children:[e.jsx(Ht,{className:"w-4 h-4"}),"Certificato"]})}),le.note&&e.jsxs("div",{className:"mb-4 p-3 bg-gray-800 rounded-lg",children:[e.jsx("span",{className:"text-xs font-medium text-gray-400",children:"Note:"}),e.jsx("p",{className:"text-sm text-gray-300 mt-1",children:le.note})]}),e.jsx("div",{className:"flex gap-2",children:Ne?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{L({isOpen:!0,title:"Approva richiesta",message:`Confermi di voler approvare la richiesta di ${le.dipendente_nome}?`,onConfirm:()=>{re(le.id),L({..._,isOpen:!1})},type:"success"})},className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center justify-center gap-2 text-sm font-medium",children:[e.jsx(Xr,{className:"w-4 h-4"}),"Approva"]}),e.jsxs("button",{onClick:()=>{K({isOpen:!0,requestId:le.id,dipendenteNome:le.dipendente_nome})},className:"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg flex items-center justify-center gap-2 text-sm font-medium",children:[e.jsx(jt,{className:"w-4 h-4"}),"Rifiuta"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>X(le),className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center gap-2 text-sm font-medium",children:[e.jsx(_o,{className:"w-4 h-4"}),"Modifica"]}),e.jsxs("button",{onClick:()=>{L({isOpen:!0,title:"Elimina elemento",message:`Confermi di voler eliminare questo elemento per ${le.dipendente_nome}?`,onConfirm:()=>{ge(le.id,u),L({..._,isOpen:!1})},type:"danger"})},className:"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg flex items-center justify-center gap-2 text-sm font-medium",children:[e.jsx(Js,{className:"w-4 h-4"}),"Elimina"]})]})})]},le.id)};if(!(n!=null&&n.id))return e.jsx("div",{className:"min-h-screen bg-neutral-950 flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(wt,{className:"w-12 h-12 text-red-500 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-400",children:"Impossibile identificare l'azienda"})]})});const de=Q(),ae=[{id:"ferie",label:"Ferie",count:g.length,icon:ut},{id:"permessi",label:"Permessi",count:p.length,icon:ct},{id:"malattia",label:"Malattia",count:B.length,icon:Va},{id:"infortunio",label:"Infortunio",count:R.length,icon:Va}];return e.jsxs("div",{className:"min-h-screen bg-neutral-950 text-white pb-20",children:[e.jsxs("header",{className:"sticky top-0 z-40 bg-gray-900/95 backdrop-blur-sm border-b border-gray-800",children:[e.jsxs("div",{className:"px-4 py-4",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Gestione Richieste"}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Gestisci ferie, permessi e assenze"})]}),e.jsx("div",{className:"px-4 pb-3 flex gap-2 overflow-x-auto",children:ae.map(le=>{const be=le.icon;return e.jsxs("button",{onClick:()=>f(le.id),className:`flex items-center gap-2 px-4 py-2 rounded-lg whitespace-nowrap transition-colors ${u===le.id?"bg-gradient-to-r from-blue-600 to-cyan-500 text-white":"bg-gray-800 text-gray-400 hover:text-white"}`,children:[e.jsx(be,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:le.label}),le.count>0&&e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-bold ${u===le.id?"bg-white text-blue-600":"bg-gray-700 text-gray-300"}`,children:le.count})]},le.id)})}),e.jsxs("div",{className:"px-4 pb-3 flex gap-2",children:[e.jsx("button",{onClick:()=>b("pending"),className:`flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${x==="pending"?"bg-yellow-600 text-white":"bg-gray-800 text-gray-400 hover:text-white"}`,children:"In attesa"}),e.jsx("button",{onClick:()=>b("approved"),className:`flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${x==="approved"?"bg-green-600 text-white":"bg-gray-800 text-gray-400 hover:text-white"}`,children:"Approvate"})]})]}),e.jsxs("main",{className:"px-4 py-6",children:[e.jsxs("button",{onClick:()=>{W({...O,tipo:u}),q(!0)},className:"w-full mb-4 px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-500 text-white rounded-lg hover:from-green-700 hover:to-emerald-600 flex items-center justify-center gap-2 font-medium",children:[e.jsx(_a,{className:"w-5 h-5"}),"Inserisci ",u]}),D?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):de.length===0?e.jsxs("div",{className:"bg-gray-900 rounded-xl border border-gray-800 p-12 text-center",children:[e.jsx(ut,{className:"w-16 h-16 mx-auto mb-4 text-gray-600"}),e.jsx("p",{className:"text-gray-400 text-lg",children:"Nessun elemento trovato"}),e.jsxs("p",{className:"text-gray-500 text-sm mt-2",children:["Non ci sono ",x==="pending"?"richieste in attesa":"elementi approvati"," per ",u]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("h2",{className:"text-lg font-semibold",children:[x==="pending"?"In attesa":"Approvate"," (",de.length,")"]})}),de.map(le=>V(le))]})]}),U&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 overflow-y-auto",children:e.jsxs("div",{className:"bg-gray-900 rounded-xl border border-gray-800 p-6 max-w-md w-full my-8",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Inserisci ",u]}),e.jsxs("form",{onSubmit:me,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Dipendente ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:O.dipendente_id,onChange:le=>W({...O,dipendente_id:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0,children:[e.jsx("option",{value:"",children:"Seleziona dipendente"}),v.map(le=>e.jsx("option",{value:le.id,children:le.full_name},le.id))]})]}),u==="permessi"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Giorno ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:O.data_inizio,onChange:le=>W({...O,data_inizio:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Dalle ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"time",value:O.orario_inizio,onChange:le=>W({...O,orario_inizio:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Alle ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"time",value:O.orario_fine,onChange:le=>W({...O,orario_fine:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]})]})]}):e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Dal ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:O.data_inizio,onChange:le=>W({...O,data_inizio:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Al ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:O.data_fine,onChange:le=>W({...O,data_fine:le.target.value}),min:O.data_inizio,className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]})]}),(u==="malattia"||u==="infortunio")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Link Certificato Medico"}),e.jsx("input",{type:"url",value:O.certificato_medico,onChange:le=>W({...O,certificato_medico:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",placeholder:"https://..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Note"}),e.jsx("textarea",{value:O.note,onChange:le=>W({...O,note:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",rows:3,placeholder:"Note aggiuntive..."})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium",children:"Conferma"}),e.jsx("button",{type:"button",onClick:()=>{q(!1),W({dipendente_id:"",tipo:"ferie",data_inizio:"",data_fine:"",orario_inizio:"",orario_fine:"",certificato_medico:"",note:""})},className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium",children:"Annulla"})]})]})]})}),J&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 overflow-y-auto",children:e.jsxs("div",{className:"bg-gray-900 rounded-xl border border-gray-800 p-6 max-w-md w-full my-8",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4",children:["Modifica ",u]}),e.jsxs("form",{onSubmit:pe,className:"space-y-4",children:[se.tipo==="permessi"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Giorno ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:se.data_inizio,onChange:le=>G({...se,data_inizio:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Dalle ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"time",value:se.orario_inizio,onChange:le=>G({...se,orario_inizio:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Alle ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"time",value:se.orario_fine,onChange:le=>G({...se,orario_fine:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]})]})]}):e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Dal ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:se.data_inizio,onChange:le=>G({...se,data_inizio:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:["Al ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:se.data_fine,onChange:le=>G({...se,data_fine:le.target.value}),min:se.data_inizio,className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",required:!0})]})]}),(se.tipo==="malattia"||se.tipo==="infortunio")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Link Certificato Medico"}),e.jsx("input",{type:"url",value:se.certificato_medico,onChange:le=>G({...se,certificato_medico:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",placeholder:"https://..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Note"}),e.jsx("textarea",{value:se.note,onChange:le=>G({...se,note:le.target.value}),className:"w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",rows:3,placeholder:"Note aggiuntive..."})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium",children:"Salva Modifiche"}),e.jsx("button",{type:"button",onClick:()=>N(!1),className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium",children:"Annulla"})]})]})]})}),e.jsx(Gd,{isOpen:_.isOpen,title:_.title,message:_.message,onConfirm:_.onConfirm,onCancel:()=>L({..._,isOpen:!1}),type:_.type}),e.jsx(Wd,{isOpen:I.isOpen,dipendenteNome:I.dipendenteNome,onConfirm:le=>{_e(I.requestId,le),K({isOpen:!1,requestId:"",dipendenteNome:""})},onCancel:()=>K({isOpen:!1,requestId:"",dipendenteNome:""})})]})},$d=()=>{const{companyProfile:n}=ds(),[l,c]=w.useState("list"),[u,f]=w.useState([]),[x,b]=w.useState([]),[v,S]=w.useState(null),[g,j]=w.useState([]),[p,M]=w.useState([]),[B,k]=w.useState(!0),[R,C]=w.useState(null),[D,E]=w.useState(null),[U,q]=w.useState({}),[J,N]=w.useState({title:"",description:"",type:"event",start_date:"",end_date:"",location:"",address:"",required_crew:1,link_scheda_tecnica:"",link_mappa_gps:""}),[_,L]=w.useState([]),[I,K]=w.useState(new Map),[O,W]=w.useState([]),[se,G]=w.useState(null),[$,F]=w.useState(""),[re,_e]=w.useState(null),[ge,X]=w.useState({title:"",type:"event",start_date:"",end_date:"",location:"",visibility:"public",benefits_evento_ids:[]});w.useEffect(()=>{n!=null&&n.id&&pe()},[n]);const pe=async()=>{try{k(!0),C(null);const[H,ne,fe,Ie]=await Promise.all([Le.from("crew_events_temp").select("*").eq("company_id",n.id).order("created_at",{ascending:!1}),Le.from("crew_events").select("*").eq("company_id",n.id).gte("end_date",new Date().toISOString().split("T")[0]).order("start_date",{ascending:!0}),Le.from("registration_requests").select("id, full_name, email, tipologia_registrazione, company_name").eq("parent_company_id",n.id).eq("status","approved").in("tipologia_registrazione",["dipendente","freelance"]).order("full_name",{ascending:!0}),Le.from("crew_tariffe").select("id, nome_tariffa, importo, tipo_calcolo, categoria").eq("azienda_id",n.id).eq("attivo",!0)]);if(H.error)throw H.error;if(ne.error)throw ne.error;if(fe.error)throw fe.error;const Re=fe.data||[],oe=(await Promise.all(Re.map(async De=>{const{data:Ee}=await Le.from("crew_ruoli").select("visibile_in_eventi").eq("dipendente_id",De.id).eq("azienda_id",n.id).eq("attivo",!0).maybeSingle();return{...De,visibile_in_eventi:(Ee==null?void 0:Ee.visibile_in_eventi)??!0}}))).filter(De=>De.visibile_in_eventi);if(f(H.data||[]),b(ne.data||[]),j(oe),!Ie.error&&Ie.data){const De=Ie.data.map(Ee=>({id:Ee.id,nome:Ee.nome_tariffa,importo:parseFloat(Ee.importo)||0,categoria:Ee.categoria||"altro"}));M(De)}}catch(H){console.error("Errore caricamento dati:",H),C(H.message)}finally{k(!1)}},me=(H,ne)=>{const fe=[],Ie=new Date(H),Re=new Date(ne);let ee=1;for(let oe=new Date(Ie);oe<=Re;oe.setDate(oe.getDate()+1))fe.push({giorno:ee,nome:ee===1?"Giorno 1":`Giorno ${ee}`,data:oe.toISOString().split("T")[0],orario_convocazione:"09:00",tariffe_abilitate:[],bonus_previsti:0}),ee++;return fe},Q=(H,ne)=>{N(fe=>{const Ie={...fe,[H]:ne};if(Ie.start_date&&Ie.end_date){const Re=me(Ie.start_date,Ie.end_date);L(Re)}return Ie})},V=(H,ne,fe)=>{L(Ie=>{const Re=[...Ie];return Re[H]={...Re[H],[ne]:fe},Re})},de=(H,ne)=>{console.log("Toggle tariffa:",{dayIndex:H,tariffaId:ne}),L(fe=>{const Ie=[...fe],Re=Ie[H].tariffe_abilitate;return Re.includes(ne)?(Ie[H].tariffe_abilitate=Re.filter(ee=>ee!==ne),console.log("Rimossa tariffa:",ne)):(Ie[H].tariffe_abilitate=[...Re,ne],console.log("Aggiunta tariffa:",ne)),console.log("Tariffe aggiornate per giorno",H,":",Ie[H].tariffe_abilitate),Ie})},ae=async()=>{try{if(!J.title||!J.start_date||!J.end_date){C("Compila tutti i campi obbligatori");return}k(!0),C(null);const ne={id_gruppo_evento:se||`evt-${Date.now()}`,company_id:n.id,...J,giorni_config:_,status:"draft",required_crew_per_day:_.reduce((fe,Ie)=>(fe[Ie.data]=J.required_crew,fe),{})};if(se){const{error:fe}=await Le.from("crew_events_temp").update(ne).eq("id_gruppo_evento",se);if(fe)throw fe;E("Bozza aggiornata con successo!")}else{const{error:fe}=await Le.from("crew_events_temp").insert(ne);if(fe)throw fe;E("Bozza salvata con successo!")}await pe(),Ge(),c("list"),setTimeout(()=>E(null),3e3)}catch(H){console.error("Errore salvataggio bozza:",H),C(H.message)}finally{k(!1)}},le=async H=>{try{k(!0),C(null);const ne=H.giorni_config.length>1,fe=H.giorni_config.length,Ie=[];for(const oe of H.giorni_config){const De={company_id:H.company_id,title:ne?`${H.title} - ${oe.nome}`:H.title,description:H.description,type:H.type,start_date:oe.data,end_date:oe.data,location:H.location,address:H.address,call_time:oe.orario_convocazione,event_group_code:H.id_gruppo_evento,is_multi_day_event:!1,parent_event_id:null,day_number:1,total_days:1,day_name:oe.nome,benefits_evento_ids:oe.tariffe_abilitate.filter(Ee=>Ee!=="diaria_eventi"&&Ee!=="diaria_trasferta"),diaria_abilitata:oe.tariffe_abilitate.includes("diaria_eventi")||oe.tariffe_abilitate.includes("diaria_trasferta"),diaria_tipo:oe.tariffe_abilitate.includes("diaria_eventi")?"evento":oe.tariffe_abilitate.includes("diaria_trasferta")?"trasferta":null,buoni_pasto_evento:!1,status:"published",is_confirmed:!0,link_scheda_tecnica:H.link_scheda_tecnica,link_mappa_gps:H.link_mappa_gps};Ie.push(De)}const{error:Re}=await Le.from("crew_events").insert(Ie);if(Re)throw Re;const{error:ee}=await Le.from("crew_events_temp").delete().eq("id_gruppo_evento",H.id_gruppo_evento);if(ee)throw ee;E(`Evento confermato! Creati ${Ie.length} giorni.`),await pe(),setTimeout(()=>E(null),3e3)}catch(ne){console.error("Errore conferma evento:",ne),C(ne.message)}finally{k(!1)}},be=async H=>{if(confirm("Sei sicuro di voler eliminare questa bozza?"))try{k(!0);const{error:ne}=await Le.from("crew_events_temp").delete().eq("id_gruppo_evento",H);if(ne)throw ne;E("Bozza eliminata"),await pe(),setTimeout(()=>E(null),2e3)}catch(ne){C(ne.message)}finally{k(!1)}},ye=H=>{N({title:H.title,description:H.description,type:H.type,start_date:H.start_date,end_date:H.end_date,location:H.location,address:H.address,required_crew:H.required_crew,link_scheda_tecnica:H.link_scheda_tecnica||"",link_mappa_gps:H.link_mappa_gps||""}),L(H.giorni_config),G(H.id_gruppo_evento),c("create")},Ce=async H=>{if(confirm("Sei sicuro di voler eliminare questo evento? Verranno eliminate anche tutte le assegnazioni crew associate."))try{k(!0);const fe=x.filter(ee=>(ee.event_group_code||ee.id)===H).map(ee=>ee.id),{error:Ie}=await Le.from("crew_event_assegnazione").delete().in("evento_id",fe);if(Ie)throw Ie;const{error:Re}=await Le.from("crew_events").delete().in("id",fe);if(Re)throw Re;E("Evento eliminato con successo!"),await pe(),setTimeout(()=>E(null),3e3)}catch(ne){console.error("Errore eliminazione evento:",ne),C(ne.message)}finally{k(!1)}},Ne=H=>{const ne=x.filter(Ie=>(Ie.event_group_code||Ie.id)===H),fe=ne[0];_e(fe),X({title:fe.title.split(" - ")[0],type:fe.type||"event",start_date:fe.start_date,end_date:ne.length>1?ne[ne.length-1].end_date:fe.end_date,location:fe.location||"",visibility:fe.visibility||"public",benefits_evento_ids:fe.benefits_evento_ids||[]}),c("edit")},Ae=async()=>{try{if(!re)return;k(!0),C(null);const H=re.event_group_code||re.id,ne=x.filter(fe=>(fe.event_group_code||fe.id)===H);for(const fe of ne){const Ie={type:ge.type,location:ge.location,visibility:ge.visibility,benefits_evento_ids:ge.benefits_evento_ids,updated_at:new Date().toISOString()};if(ne.length===1)Ie.title=ge.title,Ie.start_date=ge.start_date,Ie.end_date=ge.end_date;else{const ee=ge.title.split(" - ")[0];Ie.title=`${ee} - ${fe.day_name}`}const{error:Re}=await Le.from("crew_events").update(Ie).eq("id",fe.id);if(Re)throw Re}E("Evento aggiornato con successo!"),await pe(),_e(null),c("list"),setTimeout(()=>E(null),3e3)}catch(H){console.error("Errore aggiornamento evento:",H),C(H.message)}finally{k(!1)}},Ue=async(H,ne)=>{var fe,Ie,Re;try{const[ee,oe,De]=await Promise.all([Le.from("crew_assegnazionetariffa").select("tariffe_ids, tariffe_personalizzate").eq("dipendente_id",H).eq("azienda_id",n.id).eq("attivo",!0).maybeSingle(),Le.from("crew_tariffe").select("id, nome_tariffa, importo, categoria").eq("azienda_id",n.id).eq("attivo",!0),Le.from("employee_meal_benefits").select("*").eq("dipendente_id",H).eq("azienda_id",n.id).eq("attivo",!0).maybeSingle()]),te=(((fe=ee.data)==null?void 0:fe.tariffe_ids)||[]).filter(he=>ne.includes(he)),ke=((Ie=ee.data)==null?void 0:Ie.tariffe_personalizzate)||{},Z=[];for(const he of te){const we=(Re=oe.data)==null?void 0:Re.find(ve=>ve.id===he);if(we){const ve=ke[he];Z.push({id:we.id,nome:we.nome_tariffa,importo:ve!==void 0?ve:we.importo,categoria:we.categoria})}}return{tariffe_ids:te,tariffe_disponibili:Z,meal_benefits:De.data}}catch(ee){return console.error("Errore caricamento benefits:",ee),{tariffe_ids:[],tariffe_disponibili:[],meal_benefits:null}}},qe=async H=>{S(H),c("assign");try{k(!0);const{data:ne,error:fe}=await Le.from("crew_event_assegnazione").select("*").eq("evento_id",H.id);if(fe){console.error("Errore caricamento assegnazioni:",fe),K(new Map),W([]);return}const Ie=new Map,Re=[],ee=new Set((ne==null?void 0:ne.map(Z=>Z.dipendente_freelance_id))||[]),De=g.filter(Z=>!ee.has(Z.id)).map(Z=>Le.from("crew_richiesteferie_permessi").select("id, tipo_richiesta").eq("dipendente_id",Z.id).eq("status","approved").lte("data_inizio",H.end_date).gte("data_fine",H.start_date).then(he=>({crew:Z,conflicts:he.data||[]}))),Ee=await Promise.all(De),te=(ne||[]).map(async Z=>{const he=g.find(Qe=>Qe.id===Z.dipendente_freelance_id);if(!he)return null;let we=[];if(Z.benefits_storicizzati&&Array.isArray(Z.benefits_storicizzati))we=Z.benefits_storicizzati;else{const Qe=(H==null?void 0:H.benefits_evento_ids)||[];we=(await Ue(he.id,Qe)).tariffe_disponibili}const ve={crew_id:he.id,tariffe_ids:Z.benefits_evento_ids||[],tariffe_disponibili:we,diaria_enabled:Z.diaria_abilitata||!1,diaria_tipo:Z.diaria_tipo||void 0,buoni_pasto_enabled:Z.buoni_pasto_abilitati||!1,note:Z.note_assegnazione||"",orario_convocazione:Z.orario_convocazione||H.call_time||"",is_existing:!0};return{crew:he,assignment:ve}}),ke=await Promise.all(te);for(const Z of ke)Z&&(Ie.set(Z.crew.id,Z.assignment),Re.push({crew:Z.crew,status:"assigned",assignment:Z.assignment}));for(const{crew:Z,conflicts:he}of Ee)he.length>0?Re.push({crew:Z,status:"unavailable",reason:he.map(we=>we.tipo_richiesta).join(", ")}):Re.push({crew:Z,status:"available"});K(Ie),W(Re)}catch(ne){console.error("Errore:",ne),K(new Map),W([])}finally{k(!1)}},rt=async H=>{const ne=O.find(ee=>ee.crew.id===H);if(!ne)return;if(ne.status==="unavailable"){C(`${ne.crew.full_name} non √® disponibile: ${ne.reason}`);return}const fe=new Map(I),Ie=[...O],Re=Ie.findIndex(ee=>ee.crew.id===H);if(ne.status==="assigned")fe.delete(H),Ie[Re]={...Ie[Re],status:"available",assignment:void 0};else{const ee=v,oe=(ee==null?void 0:ee.benefits_evento_ids)||[],De=await Ue(H,oe),Ee={crew_id:H,tariffe_ids:De.tariffe_ids,tariffe_disponibili:De.tariffe_disponibili,diaria_enabled:!1,buoni_pasto_enabled:!1,note:"",orario_convocazione:"",is_existing:!1};fe.set(H,Ee),Ie[Re]={...Ie[Re],status:"assigned",assignment:Ee}}K(fe),W(Ie),C(null)},at=(H,ne,fe)=>{const Ie=new Map(I),Re=Ie.get(H);if(Re){const ee={...Re,[ne]:fe};Ie.set(H,ee),K(Ie);const oe=O.map(De=>De.crew.id===H&&De.status==="assigned"?{...De,assignment:ee}:De);W(oe)}},Ke=(H,ne,fe)=>{const Ie=new Map(I),Re=Ie.get(H);if(Re){const ee=Re.tariffe_disponibili.map(Ee=>Ee.id===ne?{...Ee,importo:fe}:Ee),oe={...Re,tariffe_disponibili:ee};Ie.set(H,oe),K(Ie);const De=O.map(Ee=>Ee.crew.id===H&&Ee.status==="assigned"?{...Ee,assignment:oe}:Ee);W(De)}},Je=async()=>{try{k(!0),C(null);const H=v;if(!H)return;if(await Le.from("crew_event_assegnazione").delete().eq("evento_id",H.id),I.size===0){E("Assegnazioni aggiornate con successo!"),c("list"),S(null),W([]),setTimeout(()=>E(null),3e3);return}const fe=(await Promise.all(Array.from(I).map(async([Re,ee])=>{const oe=g.find(we=>we.id===Re);if(!oe)return null;const De=ee.tariffe_disponibili.map(we=>({id:we.id,nome:we.nome,importo:we.importo,categoria:we.categoria})),Ee=H.diaria_abilitata&&H.diaria_tipo==="evento",te=H.diaria_abilitata&&H.diaria_tipo==="trasferta",ke=[],Z=new Date(H.start_date),he=new Date(H.end_date);for(let we=new Date(Z);we<=he;we.setDate(we.getDate()+1))ke.push(we.toISOString().split("T")[0]);return{azienda_id:n.id,nome_azienda:n.name||"",dipendente_freelance_id:Re,nome_dipendente_freelance:oe.full_name,evento_id:H.id,nome_evento:H.title,giorno_inizio_evento:H.start_date,giorno_fine_evento:H.end_date,evento_localita:H.location,evento_orario_convocazione:H.call_time,orario_convocazione:ee.orario_convocazione||null,bonus_diaria:Ee,bonus_trasferta:te,note_assegnazione:ee.note,benefits_evento_ids:ee.tariffe_ids,benefits_storicizzati:De.length>0?De:null,giorni_assegnati:ke,link_scheda_tecnica:H.link_scheda_tecnica,link_mappa_gps:H.link_mappa_gps}}))).filter(Re=>Re!==null),{error:Ie}=await Le.from("crew_event_assegnazione").insert(fe);if(Ie)throw Ie;E(`${fe.length} membri assegnati con successo!`),c("list"),S(null),K(new Map),W([]),setTimeout(()=>E(null),3e3)}catch(H){console.error("Errore salvataggio assegnazioni:",H),C(H.message)}finally{k(!1)}},Ge=()=>{N({title:"",description:"",type:"event",start_date:"",end_date:"",location:"",address:"",required_crew:1,link_scheda_tecnica:"",link_mappa_gps:""}),L([]),G(null)},yt=H=>{q(ne=>({...ne,[H]:!ne[H]}))};if(B&&l==="list")return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"Caricamento..."})]})});if(l==="create")return e.jsxs("div",{className:"space-y-6 p-4 pb-24",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:se?"Modifica Evento":"Nuovo Evento"}),e.jsx("button",{onClick:()=>{Ge(),c("list")},className:"text-gray-400 hover:text-white",children:e.jsx(jt,{className:"h-6 w-6"})})]}),R&&e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(wt,{className:"h-5 w-5 text-red-500 flex-shrink-0"}),e.jsx("p",{className:"text-red-400 text-sm",children:R})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Titolo *"}),e.jsx("input",{type:"text",value:J.title,onChange:H=>N(ne=>({...ne,title:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"Nome evento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Descrizione"}),e.jsx("textarea",{value:J.description,onChange:H=>N(ne=>({...ne,description:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white h-24 resize-none",placeholder:"Descrizione evento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Tipo"}),e.jsxs("select",{value:J.type,onChange:H=>N(ne=>({...ne,type:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",children:[e.jsx("option",{value:"event",children:"Evento"}),e.jsx("option",{value:"event_travel",children:"Trasferta"}),e.jsx("option",{value:"training",children:"Formazione"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Data Inizio *"}),e.jsx("input",{type:"date",value:J.start_date,onChange:H=>Q("start_date",H.target.value),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Data Fine *"}),e.jsx("input",{type:"date",value:J.end_date,onChange:H=>Q("end_date",H.target.value),min:J.start_date,className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Localit√†"}),e.jsx("input",{type:"text",value:J.location,onChange:H=>N(ne=>({...ne,location:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"Citt√†"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Indirizzo"}),e.jsx("input",{type:"text",value:J.address,onChange:H=>N(ne=>({...ne,address:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"Via, numero civico"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Crew Richiesta"}),e.jsx("input",{type:"number",min:"1",value:J.required_crew,onChange:H=>N(ne=>({...ne,required_crew:parseInt(H.target.value)||1})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-white mb-2",children:[e.jsx(Ht,{className:"h-4 w-4 inline mr-1"}),"Link Scheda Tecnica"]}),e.jsx("input",{type:"url",value:J.link_scheda_tecnica,onChange:H=>N(ne=>({...ne,link_scheda_tecnica:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"https://..."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-white mb-2",children:[e.jsx(Qr,{className:"h-4 w-4 inline mr-1"}),"Link Mappa GPS"]}),e.jsx("input",{type:"url",value:J.link_mappa_gps,onChange:H=>N(ne=>({...ne,link_mappa_gps:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"https://maps.google.com/..."})]}),_.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white",children:["Configurazione Giorni (",_.length,")"]}),_.map((H,ne)=>e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("button",{onClick:()=>yt(`day-${ne}`),className:"w-full flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold",children:H.giorno}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"font-medium text-white",children:H.nome}),e.jsx("p",{className:"text-sm text-gray-400",children:new Date(H.data).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})})]})]}),U[`day-${ne}`]?e.jsx(vo,{className:"h-5 w-5 text-gray-400"}):e.jsx(No,{className:"h-5 w-5 text-gray-400"})]}),U[`day-${ne}`]&&e.jsxs("div",{className:"space-y-4 pt-3 border-t border-gray-700",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-2",children:"Nome Giorno"}),e.jsx("input",{type:"text",value:H.nome,onChange:fe=>V(ne,"nome",fe.target.value),className:"w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm text-gray-400 mb-2",children:[e.jsx(ct,{className:"h-4 w-4 inline mr-1"}),"Orario Convocazione"]}),e.jsx("input",{type:"time",value:H.orario_convocazione,onChange:fe=>V(ne,"orario_convocazione",fe.target.value),className:"w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-2",children:"Tariffe Abilitate"}),e.jsxs("div",{className:"space-y-2",children:[p.map(fe=>e.jsxs("label",{className:"flex items-start gap-3 bg-gray-900 rounded-lg p-3 cursor-pointer hover:bg-gray-800 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:H.tariffe_abilitate.includes(fe.id),onChange:()=>de(ne,fe.id),className:"w-5 h-5 rounded border-2 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer mt-0.5 accent-blue-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white text-sm",children:fe.nome}),e.jsxs("p",{className:"text-gray-500 text-xs",children:[fe.categoria," - ‚Ç¨",fe.importo]})]})]},fe.id)),e.jsxs("label",{className:"flex items-start gap-3 bg-gray-900 rounded-lg p-3 cursor-pointer hover:bg-gray-800 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:H.tariffe_abilitate.includes("diaria_eventi"),onChange:()=>de(ne,"diaria_eventi"),className:"w-5 h-5 rounded border-2 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer mt-0.5 accent-blue-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white text-sm",children:"Diaria Eventi"}),e.jsx("p",{className:"text-gray-500 text-xs",children:"Benefit speciale"})]})]}),e.jsxs("label",{className:"flex items-start gap-3 bg-gray-900 rounded-lg p-3 cursor-pointer hover:bg-gray-800 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:H.tariffe_abilitate.includes("diaria_trasferta"),onChange:()=>de(ne,"diaria_trasferta"),className:"w-5 h-5 rounded border-2 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer mt-0.5 accent-blue-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white text-sm",children:"Diaria Trasferta"}),e.jsx("p",{className:"text-gray-500 text-xs",children:"Benefit speciale"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-2",children:"Bonus Previsti (‚Ç¨)"}),e.jsx("input",{type:"number",step:"0.01",value:H.bonus_previsti,onChange:fe=>V(ne,"bonus_previsti",parseFloat(fe.target.value)||0),className:"w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white"})]})]})]},ne))]}),e.jsx("button",{onClick:ae,disabled:B||!J.title||!J.start_date||!J.end_date,className:"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 text-white py-4 rounded-lg font-medium text-lg flex items-center justify-center gap-2",children:B?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),"Salvataggio..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Zr,{className:"h-5 w-5"}),se?"Aggiorna Bozza":"Salva Bozza"]})})]})]});if(l==="assign"&&v){const H=v;return e.jsxs("div",{className:"space-y-6 p-4 pb-24",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Assegna Crew"}),e.jsx("button",{onClick:()=>{c("list"),S(null)},className:"text-gray-400 hover:text-white",children:e.jsx(jt,{className:"h-6 w-6"})})]}),R&&e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(wt,{className:"h-5 w-5 text-red-500 flex-shrink-0"}),e.jsx("p",{className:"text-red-400 text-sm",children:R})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsx("h3",{className:"font-semibold text-white mb-2",children:H.title}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ut,{className:"h-4 w-4"}),e.jsx("span",{children:new Date(H.start_date).toLocaleDateString("it-IT")})]}),H.call_time&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ct,{className:"h-4 w-4"}),e.jsxs("span",{children:["Convocazione: ",H.call_time]})]}),H.location&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:H.location})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-white mb-3 flex items-center gap-2",children:[e.jsx(ls,{className:"h-5 w-5"}),"Crew (",I.size," assegnati)"]}),B&&O.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 space-y-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"}),e.jsx("p",{className:"text-gray-400 text-center",children:"Caricamento lista crew in corso..."})]}):e.jsx("div",{className:"space-y-2",children:O.map(({crew:ne,status:fe,reason:Ie,assignment:Re})=>{const ee=fe==="assigned",oe=fe==="unavailable";return e.jsxs("div",{className:"rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:()=>rt(ne.id),disabled:oe,className:`w-full flex items-center justify-between p-4 transition-colors ${ee?"bg-green-700 hover:bg-green-800":oe?"bg-red-900/30 cursor-not-allowed":"bg-gray-800 hover:bg-gray-700"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${ee?"bg-white":oe?"bg-red-700":"bg-gray-700"}`,children:ee?e.jsx(ft,{className:"h-5 w-5 text-green-700"}):oe?e.jsx(jt,{className:"h-5 w-5 text-white"}):e.jsx(ls,{className:"h-5 w-5 text-gray-400"})}),e.jsxs("div",{className:"text-left flex-1",children:[e.jsx("p",{className:"font-medium text-white",children:ne.full_name}),e.jsxs("p",{className:`text-sm ${ee?"text-green-200 font-semibold":oe?"text-red-300":"text-gray-400"}`,children:[ee&&"ASSEGNATO",fe==="available"&&"DISPONIBILE",oe&&`NON DISPONIBILE: ${Ie}`]})]})]}),ee&&e.jsx(jo,{className:"h-5 w-5 text-white flex-shrink-0"})]}),ee&&Re&&e.jsxs("div",{className:"border-t border-green-600 p-4 space-y-4 bg-green-800",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm text-green-200 mb-2",children:[e.jsx(ct,{className:"h-4 w-4 inline mr-1"}),"Orario di Convocazione"]}),e.jsx("input",{type:"time",value:Re.orario_convocazione||"",onChange:De=>at(ne.id,"orario_convocazione",De.target.value),className:"w-full bg-green-900 border border-green-700 rounded-lg px-3 py-2 text-white"})]}),Re.tariffe_disponibili&&Re.tariffe_disponibili.length>0&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm text-green-200 mb-2",children:[e.jsx(Xa,{className:"h-4 w-4 inline mr-1"}),"Benefit Assegnati (Modifica Prezzo)"]}),e.jsx("div",{className:"space-y-2",children:Re.tariffe_disponibili.map(De=>e.jsxs("div",{className:"bg-green-900 border border-green-700 rounded-lg px-3 py-2",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-white text-sm font-medium",children:De.nome}),e.jsx("span",{className:"text-xs text-green-300",children:De.categoria})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-green-200 text-sm",children:"‚Ç¨"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:De.importo,onChange:Ee=>{const te=parseFloat(Ee.target.value)||0;Ke(ne.id,De.id,te)},className:"flex-1 bg-gray-900 border border-green-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:ring-2 focus:ring-green-500",style:{colorScheme:"dark"}})]})]},De.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-green-200 mb-2",children:"Note"}),e.jsx("textarea",{value:Re.note,onChange:De=>at(ne.id,"note",De.target.value),className:"w-full bg-green-900 border border-green-700 rounded-lg px-3 py-2 text-white h-20 resize-none",placeholder:"Note aggiuntive..."})]})]})]},ne.id)})})]}),I.size>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-blue-900/30 border border-blue-700 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xa,{className:"h-5 w-5 text-blue-400"}),e.jsx("span",{className:"text-blue-200 font-medium",children:"Preview Costi Benefit"})]}),e.jsxs("span",{className:"text-2xl font-bold text-blue-400",children:["‚Ç¨ ",Array.from(I.values()).reduce((ne,fe)=>ne+fe.tariffe_disponibili.reduce((Ie,Re)=>Ie+Re.importo,0),0).toFixed(2)]})]}),e.jsxs("p",{className:"text-xs text-blue-300 mt-2",children:["Totale benefit per ",I.size," crew member",I.size!==1?"s":""]})]}),e.jsx("button",{onClick:Je,disabled:B,className:"w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-700 text-white py-4 rounded-lg font-medium text-lg flex items-center justify-center gap-2",children:B?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),"Salvataggio..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ft,{className:"h-5 w-5"}),"Conferma Assegnazioni (",I.size,")"]})})]})]})}const Te=x.filter(H=>{var ee;if(!$)return!0;const ne=$.toLowerCase(),fe=H.title.toLowerCase().includes(ne),Ie=H.start_date.includes($)||H.end_date.includes($),Re=(ee=H.location)==null?void 0:ee.toLowerCase().includes(ne);return fe||Ie||Re}).reduce((H,ne)=>{const fe=ne.event_group_code||ne.id;return H[fe]||(H[fe]=[]),H[fe].push(ne),H},{});return l==="edit"&&re?e.jsxs("div",{className:"space-y-6 p-4 pb-24",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Modifica Evento"}),e.jsx("button",{onClick:()=>{_e(null),c("list")},className:"text-gray-400 hover:text-white",children:e.jsx(jt,{className:"h-6 w-6"})})]}),R&&e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(wt,{className:"h-5 w-5 text-red-500 flex-shrink-0"}),e.jsx("p",{className:"text-red-400 text-sm",children:R})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Titolo *"}),e.jsx("input",{type:"text",value:ge.title,onChange:H=>X(ne=>({...ne,title:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"Nome evento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Tipo *"}),e.jsxs("select",{value:ge.type,onChange:H=>X(ne=>({...ne,type:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",children:[e.jsx("option",{value:"event",children:"Evento"}),e.jsx("option",{value:"transfer",children:"Trasferta"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Data Inizio *"}),e.jsx("input",{type:"date",value:ge.start_date,onChange:H=>X(ne=>({...ne,start_date:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Data Fine *"}),e.jsx("input",{type:"date",value:ge.end_date,onChange:H=>X(ne=>({...ne,end_date:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Localit√†"}),e.jsx("input",{type:"text",value:ge.location,onChange:H=>X(ne=>({...ne,location:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",placeholder:"Localit√† evento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Visibilit√† *"}),e.jsxs("select",{value:ge.visibility,onChange:H=>X(ne=>({...ne,visibility:H.target.value})),className:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white",children:[e.jsx("option",{value:"public",children:"Pubblico (Dipendenti e Freelance)"}),e.jsx("option",{value:"private",children:"Privato (Solo Dipendenti)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-3",children:"Benefits Disponibili"}),e.jsx("div",{className:"space-y-2",children:p.map(H=>{const ne=ge.benefits_evento_ids.includes(H.id);return e.jsxs("div",{onClick:()=>{X(fe=>({...fe,benefits_evento_ids:ne?fe.benefits_evento_ids.filter(Ie=>Ie!==H.id):[...fe.benefits_evento_ids,H.id]}))},className:`flex items-center justify-between p-4 rounded-lg cursor-pointer transition-all ${ne?"bg-green-600 hover:bg-green-700":"bg-gray-800 hover:bg-gray-700"}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white font-medium",children:H.nome}),e.jsxs("p",{className:`text-sm ${ne?"text-green-100":"text-gray-400"}`,children:[H.importo.toFixed(2),"‚Ç¨"]})]}),e.jsx("div",{className:`relative inline-flex h-7 w-12 items-center rounded-full transition-colors ${ne?"bg-green-400":"bg-gray-600"}`,children:e.jsx("span",{className:`inline-block h-5 w-5 transform rounded-full bg-white transition-transform ${ne?"translate-x-6":"translate-x-1"}`})})]},H.id)})})]})]}),e.jsxs("div",{className:"flex gap-3 pt-6",children:[e.jsx("button",{onClick:()=>{_e(null),c("list")},className:"flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-medium",children:"Annulla"}),e.jsx("button",{onClick:Ae,disabled:B,className:"flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 text-white py-3 rounded-lg font-medium flex items-center justify-center gap-2",children:B?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),"Salvataggio..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Zr,{className:"h-5 w-5"}),"Salva Modifiche"]})})]})]}):e.jsxs("div",{className:"space-y-6 p-4 pb-24",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:"Gestione Eventi"}),e.jsxs("button",{onClick:()=>c("create"),className:"bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg flex items-center gap-2",children:[e.jsx(_a,{className:"h-5 w-5"}),e.jsx("span",{children:"Nuovo"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(nn,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"text",value:$,onChange:H=>F(H.target.value),placeholder:"Cerca per nome, data o localit√†...",className:"w-full bg-gray-800 border border-gray-700 rounded-lg pl-12 pr-4 py-3 text-white placeholder-gray-400"}),$&&e.jsx("button",{onClick:()=>F(""),className:"absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white",children:e.jsx(jt,{className:"h-5 w-5"})})]}),R&&e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(wt,{className:"h-5 w-5 text-red-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-red-500 font-medium",children:"Errore"}),e.jsx("p",{className:"text-red-400 text-sm mt-1",children:R})]})]}),D&&e.jsxs("div",{className:"bg-green-500/10 border border-green-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(ft,{className:"h-5 w-5 text-green-500 flex-shrink-0"}),e.jsx("p",{className:"text-green-500 font-medium",children:D})]}),u.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-3 flex items-center gap-2",children:[e.jsx(cr,{className:"h-5 w-5"}),"Bozze (",u.length,")"]}),e.jsx("div",{className:"space-y-3",children:u.map(H=>e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-yellow-500/30",children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-semibold text-white",children:H.title}),e.jsx("span",{className:"px-2 py-1 text-xs rounded-full bg-yellow-500/20 text-yellow-400",children:"BOZZA"})]}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ut,{className:"h-4 w-4"}),e.jsxs("span",{children:[new Date(H.start_date).toLocaleDateString("it-IT")," - ",new Date(H.end_date).toLocaleDateString("it-IT")]})]}),H.location&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:H.location})]}),e.jsxs("p",{className:"text-xs text-gray-500",children:[H.giorni_config.length," giorn",H.giorni_config.length===1?"o":"i"," configurati"]})]})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>ye(H),className:"bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg",children:e.jsx(cr,{className:"h-4 w-4"})}),e.jsxs("button",{onClick:()=>le(H),className:"flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2",children:[e.jsx(ft,{className:"h-4 w-4"}),"Conferma"]}),e.jsx("button",{onClick:()=>be(H.id_gruppo_evento),className:"bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg",children:e.jsx(Js,{className:"h-4 w-4"})})]})]},H.id_gruppo_evento))})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-3 flex items-center gap-2",children:[e.jsx(ft,{className:"h-5 w-5"}),"Eventi Confermati (",Object.keys(Te).length,")"]}),Object.keys(Te).length===0?e.jsxs("div",{className:"bg-gray-800 rounded-lg p-8 text-center",children:[e.jsx(ut,{className:"h-12 w-12 text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-400",children:"Nessun evento confermato"})]}):e.jsx("div",{className:"space-y-3",children:Object.entries(Te).map(([H,ne])=>{const fe=ne.length>1,Ie=ne[0];return e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-white mb-1",children:fe?Ie.title.split(" - ")[0]:Ie.title}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ut,{className:"h-4 w-4"}),e.jsxs("span",{children:[new Date(Ie.start_date).toLocaleDateString("it-IT"),fe&&` - ${new Date(ne[ne.length-1].end_date).toLocaleDateString("it-IT")}`]})]}),Ie.location&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:Ie.location})]}),fe&&e.jsxs("p",{className:"text-xs text-blue-400",children:[ne.length," giorni"]})]})]})}),fe?e.jsx("div",{className:"space-y-2 mb-3",children:ne.map(Re=>e.jsxs("button",{onClick:()=>qe(Re),className:"w-full bg-gray-900 hover:bg-gray-850 border border-gray-700 rounded-lg p-3 text-left flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold",children:Re.day_number}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white text-sm font-medium",children:Re.day_name}),e.jsxs("p",{className:"text-gray-400 text-xs",children:[new Date(Re.start_date).toLocaleDateString("it-IT")," - ",Re.call_time]})]})]}),e.jsx(ls,{className:"h-5 w-5 text-gray-400"})]},Re.id))}):e.jsxs("button",{onClick:()=>qe(Ie),className:"w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 mb-2",children:[e.jsx(ls,{className:"h-4 w-4"}),"Assegna Crew"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>Ne(H),className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2",children:[e.jsx(cr,{className:"h-4 w-4"}),"Modifica"]}),e.jsxs("button",{onClick:()=>Ce(H),className:"flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2",children:[e.jsx(Js,{className:"h-4 w-4"}),"Elimina"]})]})]},H)})})]})]})},Xd=()=>{const{companyProfile:n}=ds(),[l,c]=w.useState([]),[u,f]=w.useState(!0),x=()=>{const k=new Date;return new Date(k.toLocaleString("en-US",{timeZone:"Europe/Rome"})).toISOString().split("T")[0]},[b,v]=w.useState(x()),[S,g]=w.useState("all"),j=async()=>{if(n!=null&&n.id)try{f(!0),console.log("[CompanyCheckInMonitor] Caricamento turni per data:",b),console.log("[CompanyCheckInMonitor] Data italiana corrente:",x());const k=[],R=[],C=[],{data:D,error:E}=await Le.from("crew_assegnazione_turni").select("*").eq("azienda_id",n.id).eq("data_turno",b);if(!E&&D){const _=D.map(K=>K.turno_id),{data:L}=await Le.from("warehouse_checkins").select("*").eq("date",b).in("crew_id",D.map(K=>K.dipendente_id)),I=new Map;L==null||L.forEach(K=>{I.set(K.crew_id,K)}),D.forEach(K=>{const O=I.get(K.dipendente_id),W=new Date,se=new Date(`${b}T${K.ora_inizio_turno}`),G=W>se&&!O;let $="not_started";O!=null&&O.check_out_time?$="checked_out":O!=null&&O.check_in_time?$="checked_in":G&&($="late"),k.push({type:"warehouse",id:K.id,employee_id:K.dipendente_id,employee_name:K.dipendente_nome,warehouse_name:K.nome_magazzino,shift_date:K.data_turno,start_time:K.ora_inizio_turno,end_time:K.ora_fine_turno,checkin_time:O==null?void 0:O.check_in_time,checkout_time:O==null?void 0:O.check_out_time,status:$,location:O==null?void 0:O.location})})}const{data:U,error:q}=await Le.from("crew_event_assegnazione").select("*").eq("azienda_id",n.id).lte("giorno_inizio_evento",b).gte("giorno_fine_evento",b);if(!q&&U){const{data:_}=await Le.from("timesheet_entries").select("*").eq("date",b).in("crew_id",U.map(I=>I.dipendente_freelance_id)),L=new Map;_==null||_.forEach(I=>{L.has(I.crew_id)||L.set(I.crew_id,[]),L.get(I.crew_id).push(I)}),U.forEach(I=>{const O=(L.get(I.dipendente_freelance_id)||[]).find(se=>se.date===b);let W="not_started";O&&(O.end_time?W="checked_out":O.start_time&&(W="checked_in")),R.push({type:"event",id:I.id,employee_id:I.dipendente_freelance_id,employee_name:I.nome_dipendente_freelance,event_name:I.nome_evento,event_location:I.evento_localita||"Non specificato",shift_date:b,convocation_time:I.orario_convocazione||I.evento_orario_convocazione,checkin_time:O==null?void 0:O.start_time,checkout_time:O==null?void 0:O.end_time,status:W})})}const{data:J,error:N}=await Le.from("extra_shifts_checkins").select(`
          *,
          crew_members (
            full_name,
            first_name,
            last_name,
            company_name
          )
        `).eq("date",b);!N&&J&&(console.log("[CompanyCheckInMonitor] Extra checkins trovati:",J.length),console.log("[CompanyCheckInMonitor] Ragione sociale azienda:",n.ragione_sociale),J.forEach(_=>{var I,K,O,W,se,G;if(console.log("[CompanyCheckInMonitor] Checkin:",{id:_.id,crew_id:_.crew_id,company_name:(I=_.crew_members)==null?void 0:I.company_name,matches:((K=_.crew_members)==null?void 0:K.company_name)===n.ragione_sociale}),((O=_.crew_members)==null?void 0:O.company_name)!==n.ragione_sociale)return;const L=((W=_.crew_members)==null?void 0:W.full_name)||`${((se=_.crew_members)==null?void 0:se.first_name)||""} ${((G=_.crew_members)==null?void 0:G.last_name)||""}`.trim()||"Nome non disponibile";C.push({type:"extra",id:_.id,employee_id:_.crew_id,employee_name:L,shift_date:_.date,checkin_time:_.check_in_time,checkout_time:_.check_out_time,status:_.check_out_time?"checked_out":"checked_in",warehouse_name:"Turno Extra"})}),console.log("[CompanyCheckInMonitor] Extra shifts aggiunti:",C.length)),c([...k,...R,...C])}catch(k){console.error("Errore caricamento turni:",k)}finally{f(!1)}};w.useEffect(()=>{j();const k=Le.channel("warehouse_checkins_changes").on("postgres_changes",{event:"*",schema:"public",table:"warehouse_checkins"},()=>{j()}).subscribe(),R=Le.channel("timesheet_entries_changes").on("postgres_changes",{event:"*",schema:"public",table:"timesheet_entries"},()=>{j()}).subscribe(),C=Le.channel("extra_shifts_checkins_changes").on("postgres_changes",{event:"*",schema:"public",table:"extra_shifts_checkins"},()=>{j()}).subscribe();return()=>{Le.removeChannel(k),Le.removeChannel(R),Le.removeChannel(C)}},[n==null?void 0:n.id,b]);const p=k=>{switch(k){case"checked_in":return e.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 bg-green-900/30 text-green-400 rounded-lg text-xs font-medium",children:[e.jsx(ft,{className:"w-3 h-3"}),"Presente"]});case"checked_out":return e.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 bg-blue-900/30 text-blue-400 rounded-lg text-xs font-medium",children:[e.jsx(ft,{className:"w-3 h-3"}),"Concluso"]});case"late":return e.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 bg-orange-900/30 text-orange-400 rounded-lg text-xs font-medium",children:[e.jsx(wt,{className:"w-3 h-3"}),"In Ritardo"]});case"not_started":return e.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 bg-gray-700 text-gray-400 rounded-lg text-xs font-medium",children:[e.jsx(ct,{className:"w-3 h-3"}),"Non Iniziato"]});case"absent":return e.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 bg-red-900/30 text-red-400 rounded-lg text-xs font-medium",children:[e.jsx(sn,{className:"w-3 h-3"}),"Assente"]});default:return null}},M=l.filter(k=>S==="all"?!0:k.status===S),B={total:l.length,checked_in:l.filter(k=>k.status==="checked_in").length,checked_out:l.filter(k=>k.status==="checked_out").length,late:l.filter(k=>k.status==="late").length,not_started:l.filter(k=>k.status==="not_started").length};return u?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white pb-20",children:[e.jsxs("div",{className:"bg-gradient-to-br from-blue-900 to-gray-900 p-6 border-b border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Check-In Monitor"}),e.jsx("p",{className:"text-gray-300 text-sm mt-1",children:"Monitoraggio presenze in tempo reale"})]}),e.jsx("button",{onClick:j,className:"p-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors",title:"Aggiorna",children:e.jsx(Ds,{className:"w-5 h-5"})})]}),e.jsx("input",{type:"date",value:b,onChange:k=>v(k.target.value),className:"w-full px-4 py-2 bg-gray-800 text-white border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2 mt-4",children:[e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:B.total}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"Totale"})]}),e.jsxs("div",{className:"bg-green-900/30 rounded-lg p-3 text-center border border-green-700/30",children:[e.jsx("div",{className:"text-2xl font-bold text-green-400",children:B.checked_in}),e.jsx("div",{className:"text-xs text-green-300 mt-1",children:"Presenti"})]}),e.jsxs("div",{className:"bg-blue-900/30 rounded-lg p-3 text-center border border-blue-700/30",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-400",children:B.checked_out}),e.jsx("div",{className:"text-xs text-blue-300 mt-1",children:"Conclusi"})]}),e.jsxs("div",{className:"bg-orange-900/30 rounded-lg p-3 text-center border border-orange-700/30",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-400",children:B.late}),e.jsx("div",{className:"text-xs text-orange-300 mt-1",children:"Ritardo"})]})]}),e.jsx("div",{className:"flex gap-2 mt-4 overflow-x-auto pb-2",children:[{id:"all",label:"Tutti"},{id:"checked_in",label:"Presenti"},{id:"checked_out",label:"Conclusi"},{id:"late",label:"Ritardo"},{id:"not_started",label:"Non iniziati"}].map(k=>e.jsx("button",{onClick:()=>g(k.id),className:`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${S===k.id?"bg-blue-600 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"}`,children:k.label},k.id))})]}),e.jsx("div",{className:"p-4 space-y-3",children:M.length===0?e.jsxs("div",{className:"bg-gray-800 rounded-lg p-8 text-center",children:[e.jsx(ls,{className:"w-12 h-12 text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-400",children:"Nessun turno trovato per questa data"})]}):M.map(k=>e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-gray-600 transition-colors",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center",children:e.jsx(ea,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-white",children:(k.type==="extra",k.employee_name)}),e.jsxs("p",{className:"text-sm text-gray-400",children:[k.type==="warehouse"&&k.warehouse_name,k.type==="event"&&k.event_name,k.type==="extra"&&k.warehouse_name]})]})]}),p(k.status)]}),e.jsxs("div",{className:"space-y-2",children:[k.type==="warehouse"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ct,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{className:"text-gray-300",children:["Orario: ",k.start_time," - ",k.end_time]})]}),k.checkin_time&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ft,{className:"w-4 h-4 text-green-400"}),e.jsxs("span",{className:"text-gray-300",children:["Check-in: ",k.checkin_time]})]}),k.checkout_time&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ft,{className:"w-4 h-4 text-blue-400"}),e.jsxs("span",{className:"text-gray-300",children:["Check-out: ",k.checkout_time]})]})]}),k.type==="event"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ut,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"text-gray-300",children:k.event_location})]}),k.convocation_time&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ct,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{className:"text-gray-300",children:["Convocazione: ",k.convocation_time]})]}),k.checkin_time&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ft,{className:"w-4 h-4 text-green-400"}),e.jsxs("span",{className:"text-gray-300",children:["Inizio: ",k.checkin_time]})]}),k.checkout_time&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ft,{className:"w-4 h-4 text-blue-400"}),e.jsxs("span",{className:"text-gray-300",children:["Fine: ",k.checkout_time]})]})]}),k.type==="extra"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(wt,{className:"w-4 h-4 text-yellow-400"}),e.jsx("span",{className:"text-yellow-300 font-medium",children:"Turno straordinario"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ft,{className:"w-4 h-4 text-green-400"}),e.jsxs("span",{className:"text-gray-300",children:["Check-in: ",k.checkin_time]})]}),k.checkout_time&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ft,{className:"w-4 h-4 text-blue-400"}),e.jsxs("span",{className:"text-gray-300",children:["Check-out: ",k.checkout_time]})]})]})]})]},`${k.type}-${k.id}`))})]})};function Zd(){const{companyProfile:n}=ds(),{showSuccess:l,showError:c,showWarning:u}=Or(),[f,x]=w.useState([]),[b,v]=w.useState([]),[S,g]=w.useState([]),[j,p]=w.useState(null),[M,B]=w.useState("individual"),[k,R]=w.useState("text"),[C,D]=w.useState(""),[E,U]=w.useState(null),[q,J]=w.useState(!1),[N,_]=w.useState(!1),[L,I]=w.useState([]),[K,O]=w.useState(!1),[W,se]=w.useState(!0),[G,$]=w.useState(null),[F,re]=w.useState([]),[_e,ge]=w.useState(!1),[X,pe]=w.useState(0),[me,Q]=w.useState(null),V=w.useRef(null),de=w.useRef(null),ae=w.useRef(null),le=w.useRef([]),be=w.useRef(null);w.useEffect(()=>{n&&(ye(),at())},[n]),w.useEffect(()=>()=>{be.current&&clearInterval(be.current),ae.current&&ae.current.state!=="inactive"&&ae.current.stop()},[]),w.useEffect(()=>{M==="event"&&n&&Ce()},[M,n]),w.useEffect(()=>{M==="warehouse"&&n&&Ne()},[M,n]),w.useEffect(()=>{j&&(M==="event"||M==="warehouse")?Ae():M==="extra"?Ue():M==="individual"?qe():re([])},[j,M]);const ye=async()=>{try{se(!0);const{data:ee,error:oe}=await Le.from("crew_members").select("id, first_name, last_name, email, full_name").eq("company_id",n==null?void 0:n.id).order("full_name",{ascending:!0});if(oe)throw oe;x(ee||[])}catch(ee){console.error("Errore caricamento dipendenti:",ee)}finally{se(!1)}},Ce=async()=>{try{const ee=new Date().toISOString().split("T")[0],{data:oe,error:De}=await Le.from("crew_event_assegnazione").select(`
          evento_id,
          nome_evento,
          giorno_inizio_evento,
          dipendente_freelance_id
        `).eq("azienda_id",n==null?void 0:n.id).lte("giorno_inizio_evento",ee).gte("giorno_fine_evento",ee);if(De)throw De;const Ee=new Map;(oe||[]).forEach(te=>{Ee.has(te.evento_id)||Ee.set(te.evento_id,{id:te.evento_id,nome_evento:te.nome_evento,giorno_inizio_evento:te.giorno_inizio_evento,assigned_count:0});const ke=Ee.get(te.evento_id);ke.assigned_count++}),v(Array.from(Ee.values()))}catch(ee){console.error("Errore caricamento eventi:",ee),v([])}},Ne=async()=>{try{const ee=new Date().toISOString().split("T")[0],{data:oe,error:De}=await Le.from("crew_assegnazione_turni").select("turno_id, nome_magazzino, data_turno, dipendente_id").eq("azienda_id",n==null?void 0:n.id).eq("data_turno",ee);if(De)throw De;const Ee=new Map;(oe||[]).forEach(te=>{const ke=`${te.turno_id}|${te.data_turno}`;Ee.has(ke)||Ee.set(ke,{id:ke,turno_id:te.turno_id,nome_magazzino:te.nome_magazzino,data_turno:te.data_turno,assigned_count:0});const Z=Ee.get(ke);Z.assigned_count++}),g(Array.from(Ee.values()))}catch(ee){console.error("Errore caricamento turni:",ee),g([])}},Ae=async()=>{try{let ee=[],oe=new Map;if(M==="event"&&j){const{data:te}=await Le.from("crew_event_assegnazione").select("dipendente_freelance_id, nome_dipendente_freelance").eq("evento_id",j);(te||[]).forEach(ke=>{ee.push(ke.dipendente_freelance_id),oe.set(ke.dipendente_freelance_id,ke.nome_dipendente_freelance)})}else if(M==="warehouse"&&j){const te=j.split("|"),ke=te[0],Z=te[1],{data:he}=await Le.from("crew_assegnazione_turni").select("dipendente_id, dipendente_nome").eq("turno_id",ke).eq("data_turno",Z);(he||[]).forEach(we=>{ee.push(we.dipendente_id),oe.set(we.dipendente_id,we.dipendente_nome)})}const Ee=[...new Set(ee)].map(te=>({id:te,name:oe.get(te)||"Nome non disponibile",selected:!0}));re(Ee)}catch(ee){console.error("Errore caricamento dipendenti selezionabili:",ee),re([])}},Ue=async()=>{try{const ee=new Date().toISOString().split("T")[0],{data:oe}=await Le.from("extra_shifts_checkins").select(`
          crew_id,
          crew_members!crew_id (
            full_name,
            first_name,
            last_name
          )
        `).eq("date",ee),De=new Map;(oe||[]).forEach(te=>{var Z,he,we;const ke=((Z=te.crew_members)==null?void 0:Z.full_name)||`${((he=te.crew_members)==null?void 0:he.first_name)||""} ${((we=te.crew_members)==null?void 0:we.last_name)||""}`.trim()||"Nome non disponibile";De.set(te.crew_id,ke)});const Ee=Array.from(De.entries()).map(([te,ke])=>({id:te,name:ke,selected:!0}));re(Ee)}catch(ee){console.error("Errore caricamento dipendenti extra:",ee),re([])}},qe=()=>{const ee=f.map(oe=>({id:oe.id,name:oe.full_name||`${oe.first_name} ${oe.last_name}`,selected:!1}));re(ee)},rt=ee=>{re(oe=>oe.map(De=>De.id===ee?{...De,selected:!De.selected}:De))},at=async()=>{try{const{data:ee,error:oe}=await Le.from("company_talks").select("*").eq("sender_company_id",n==null?void 0:n.id).order("created_at",{ascending:!1}).limit(100);if(oe)throw oe;if(!ee||ee.length===0){I([]);return}const De=[...new Set(ee.map(ke=>ke.recipient_id).filter(Boolean))];let Ee={};if(De.length>0){const{data:ke}=await Le.from("crew_members").select("id, full_name, first_name, last_name").in("id",De);Ee=(ke||[]).reduce((Z,he)=>(Z[he.id]=he.full_name||`${he.first_name} ${he.last_name}`,Z),{})}const te=ee.map(ke=>({...ke,recipient_name:ke.recipient_id?Ee[ke.recipient_id]||"Dipendente":"Tutti i dipendenti"}));I(te)}catch(ee){console.error("Errore caricamento messaggi inviati:",ee)}},Ke=async()=>{try{const ee=await navigator.mediaDevices.getUserMedia({audio:!0}),oe=MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":"audio/mp4",De=new MediaRecorder(ee,{mimeType:oe});le.current=[],De.ondataavailable=Ee=>{Ee.data.size>0&&le.current.push(Ee.data)},De.onstop=()=>{const Ee=new Blob(le.current,{type:oe});Ee.size>10*1024*1024?(c("Registrazione troppo lunga! Massimo 10MB"),Q(null)):Q(Ee),ee.getTracks().forEach(te=>te.stop()),be.current&&clearInterval(be.current)},De.start(),ae.current=De,ge(!0),pe(0),R("audio"),U(null),be.current=setInterval(()=>{pe(Ee=>Ee+1)},1e3)}catch(ee){console.error("Errore accesso microfono:",ee),c("Impossibile accedere al microfono. Verifica i permessi.")}},Je=()=>{ae.current&&ae.current.state!=="inactive"&&(ae.current.stop(),ge(!1))},Ge=()=>{ae.current&&ae.current.state!=="inactive"&&ae.current.stop(),be.current&&clearInterval(be.current),ge(!1),pe(0),Q(null),le.current=[]},yt=ee=>{const oe=Math.floor(ee/60),De=ee%60;return`${oe}:${De.toString().padStart(2,"0")}`},Ye=(ee,oe)=>{var te;const De=(te=ee.target.files)==null?void 0:te[0];if(!De)return;const Ee=oe==="file"?20*1024*1024:10*1024*1024;if(De.size>Ee){c(`File troppo grande! Massimo ${oe==="file"?"20":"10"}MB`);return}U(De),R(oe),Q(null)},Te=async ee=>{try{const oe=ee.name.split(".").pop(),De=`${Date.now()}_${Math.random().toString(36).substring(7)}.${oe}`,Ee=`${n==null?void 0:n.id}/${De}`,{error:te}=await Le.storage.from("company-talks").upload(Ee,ee);if(te)throw te;const{data:{publicUrl:ke}}=Le.storage.from("company-talks").getPublicUrl(Ee);return ke}catch(oe){throw console.error("Errore upload file:",oe),oe}},H=async()=>M==="individual"?F.filter(ee=>ee.selected).map(ee=>ee.id):M==="all"?f.map(ee=>ee.id):M==="event"||M==="warehouse"||M==="extra"?F.filter(ee=>ee.selected).map(ee=>ee.id):[],ne=async()=>{if(!n){c("Profilo azienda non trovato");return}if(k==="text"&&!C.trim()){u("Inserisci un messaggio");return}if(k==="audio"&&!E&&!me){u("Registra o seleziona un file audio");return}if((k==="image"||k==="file")&&!E){u("Seleziona un file");return}try{_(!0);const ee=await H();if(ee.length===0){u("Nessun destinatario selezionato"),_(!1);return}let oe=null,De=null,Ee=null;if(E)oe=await Te(E),De=E.name,Ee=E.size;else if(me&&k==="audio"){const Z=new File([me],`recording_${Date.now()}.${me.type.includes("webm")?"webm":"mp4"}`,{type:me.type});oe=await Te(Z),De=Z.name,Ee=Z.size}const te=ee.map(Z=>({sender_company_id:n.id,recipient_id:Z,sender_name:n.ragione_sociale||"Azienda",message_type:k,message_text:k==="text"?C:null,file_url:oe,file_name:De,file_size:Ee,is_urgent:q})),{error:ke}=await Le.from("company_talks").insert(te);if(ke)throw console.error("Errore inserimento DB:",ke),ke;l(`Messaggio inviato a ${ee.length} ${ee.length===1?"dipendente":"dipendenti"}!`),D(""),U(null),Q(null),pe(0),R("text"),J(!1),p(null),B("individual"),re([]),at()}catch(ee){console.error("Errore invio messaggio:",ee),c(`Errore durante l'invio del messaggio: ${ee.message||"Errore sconosciuto"}`)}finally{_(!1)}},fe=async ee=>{try{const{error:oe}=await Le.from("company_talks").delete().eq("id",ee).eq("sender_company_id",n==null?void 0:n.id);if(oe)throw oe;I(De=>De.filter(Ee=>Ee.id!==ee)),$(null),l("Messaggio eliminato")}catch(oe){console.error("Errore eliminazione:",oe),c("Errore durante l'eliminazione")}},Ie=ee=>new Date(ee).toLocaleString("it-IT",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}),Re=ee=>{switch(ee){case"audio":return e.jsx(Ir,{className:"w-4 h-4"});case"image":return e.jsx($r,{className:"w-4 h-4"});case"file":return e.jsx(Ht,{className:"w-4 h-4"});default:return e.jsx(Ks,{className:"w-4 h-4"})}};return W?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(En,{className:"w-8 h-8 animate-spin text-blue-600"})}):e.jsxs("div",{className:"min-h-screen flex flex-col bg-gray-900",children:[e.jsx("div",{className:"bg-gray-800 border-b border-gray-700 p-4",children:e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Invia Messaggio ai Dipendenti"}),e.jsx("button",{onClick:()=>O(!K),className:"px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm",children:K?"Nuovo Messaggio":"Cronologia"})]})}),K?e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Messaggi Inviati"}),L.length===0?e.jsxs("div",{className:"text-center text-gray-400 py-8",children:[e.jsx(Ks,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"Nessun messaggio inviato"})]}):e.jsx("div",{className:"space-y-3",children:L.map(ee=>e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 bg-blue-900/30 rounded-lg text-blue-400",children:Re(ee.message_type)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-white",children:ee.recipient_name}),e.jsx("p",{className:"text-xs text-gray-400",children:Ie(ee.created_at)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[ee.is_urgent&&e.jsx("span",{className:"flex items-center gap-1 text-xs text-red-400",children:e.jsx(wt,{className:"w-3 h-3"})}),ee.is_read&&e.jsx(ft,{className:"w-4 h-4 text-green-400"}),e.jsx("button",{onClick:()=>$(ee.id),className:"p-1 hover:bg-red-900/30 rounded text-red-400",children:e.jsx(Js,{className:"w-4 h-4"})})]})]}),ee.message_type==="text"&&ee.message_text&&e.jsx("p",{className:"text-sm text-gray-300 line-clamp-2",children:ee.message_text}),ee.message_type!=="text"&&ee.file_name&&e.jsx("p",{className:"text-sm text-gray-400",children:ee.file_name})]},ee.id))})]}):e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsxs("div",{className:"max-w-2xl mx-auto space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Tipo Destinatari"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-2 mb-3",children:[e.jsx("button",{onClick:()=>{B("individual"),p("individual"),re([])},className:`p-2 rounded-lg border-2 text-sm ${M==="individual"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 text-gray-400 hover:border-gray-600"}`,children:"Seleziona"}),e.jsx("button",{onClick:()=>{B("all"),p("all"),re([])},className:`p-2 rounded-lg border-2 text-sm ${M==="all"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 text-gray-400 hover:border-gray-600"}`,children:"Tutti"}),e.jsx("button",{onClick:()=>{B("event"),p(null),re([])},className:`p-2 rounded-lg border-2 text-sm ${M==="event"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 text-gray-400 hover:border-gray-600"}`,children:"Evento"}),e.jsx("button",{onClick:()=>{B("warehouse"),p(null),re([])},className:`p-2 rounded-lg border-2 text-sm ${M==="warehouse"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 text-gray-400 hover:border-gray-600"}`,children:"Magazzino"}),e.jsx("button",{onClick:()=>{B("extra"),p("extra"),Ue()},className:`p-2 rounded-lg border-2 text-sm ${M==="extra"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 text-gray-400 hover:border-gray-600"}`,children:"Extra Oggi"})]}),M==="individual"&&F.length===0&&e.jsx("div",{className:"p-3 bg-gray-800 border border-gray-700 rounded-lg",children:e.jsx("p",{className:"text-sm text-gray-400 text-center",children:"Caricamento dipendenti..."})}),M==="event"&&e.jsx(e.Fragment,{children:e.jsxs("select",{value:j||"",onChange:ee=>p(ee.target.value||null),className:"w-full px-3 py-2 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:b.length===0?"Nessun evento oggi":"Seleziona evento"}),b.map(ee=>e.jsxs("option",{value:ee.id,children:[ee.nome_evento," (",ee.assigned_count," ",ee.assigned_count===1?"dipendente":"dipendenti",")"]},ee.id))]})}),M==="warehouse"&&e.jsx(e.Fragment,{children:e.jsxs("select",{value:j||"",onChange:ee=>p(ee.target.value||null),className:"w-full px-3 py-2 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:S.length===0?"Nessun turno oggi":"Seleziona turno magazzino"}),S.map(ee=>e.jsxs("option",{value:ee.id,children:[ee.nome_magazzino," (",ee.assigned_count," ",ee.assigned_count===1?"dipendente":"dipendenti",")"]},ee.id))]})}),M==="all"&&e.jsx("div",{className:"p-3 bg-blue-900/30 border border-blue-700 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-300",children:["Il messaggio verr√† inviato a tutti i ",f.length," dipendenti"]})}),F.length>0&&e.jsxs("div",{className:"mt-3 p-3 bg-gray-800 border border-gray-700 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h4",{className:"text-sm font-medium text-white flex items-center gap-2",children:[e.jsx(Co,{className:"w-4 h-4"}),"Destinatari (",F.filter(ee=>ee.selected).length,"/",F.length,")"]}),e.jsx("button",{onClick:()=>re(ee=>ee.map(oe=>({...oe,selected:!ee.every(De=>De.selected)}))),className:"text-xs text-blue-400 hover:text-blue-300",children:F.every(ee=>ee.selected)?"Deseleziona tutti":"Seleziona tutti"})]}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:F.map(ee=>e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-700 rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:ee.selected,onChange:()=>rt(ee.id),className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm text-gray-300",children:ee.name})]},ee.id))})]}),M==="extra"&&F.length===0&&e.jsx("div",{className:"p-3 bg-purple-900/30 border border-purple-700 rounded-lg",children:e.jsx("p",{className:"text-sm text-purple-300",children:"Nessun dipendente ha effettuato check-in extra oggi"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Tipo di Messaggio"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsxs("button",{onClick:()=>{R("text"),U(null)},className:`p-3 rounded-lg border-2 transition-all ${k==="text"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 hover:border-gray-600 text-gray-400"}`,children:[e.jsx(Ks,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Testo"})]}),e.jsxs("button",{onClick:()=>{R("audio"),U(null),!_e&&!me&&Ke()},className:`p-3 rounded-lg border-2 transition-all ${k==="audio"||_e?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 hover:border-gray-600 text-gray-400"}`,children:[e.jsx(Ir,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Vocale"})]}),e.jsxs("button",{onClick:()=>{var ee;return(ee=V.current)==null?void 0:ee.click()},className:`p-3 rounded-lg border-2 transition-all ${k==="image"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 hover:border-gray-600 text-gray-400"}`,children:[e.jsx($r,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Immagine"})]}),e.jsxs("button",{onClick:()=>{var ee;R("file"),(ee=V.current)==null||ee.click()},className:`p-3 rounded-lg border-2 transition-all ${k==="file"?"border-blue-600 bg-blue-900/30 text-blue-400":"border-gray-700 hover:border-gray-600 text-gray-400"}`,children:[e.jsx(Ht,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"File"})]})]}),e.jsx("input",{ref:V,type:"file",accept:"image/*",onChange:ee=>Ye(ee,"image"),className:"hidden"}),e.jsx("input",{ref:de,type:"file",accept:"audio/*",onChange:ee=>Ye(ee,"audio"),className:"hidden"})]}),_e?e.jsx("div",{className:"p-6 bg-red-900/30 border-2 border-red-600 rounded-lg",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-3 mb-4",children:[e.jsx("div",{className:"w-4 h-4 bg-red-500 rounded-full animate-pulse"}),e.jsx("p",{className:"text-2xl font-bold text-white",children:yt(X)})]}),e.jsx("p",{className:"text-sm text-red-200 mb-4",children:"Registrazione in corso..."}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsx("button",{onClick:Ge,className:"px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors",children:"Annulla"}),e.jsxs("button",{onClick:Je,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(Eo,{className:"w-4 h-4 fill-current"}),"Ferma"]})]})]})}):k==="text"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Messaggio"}),e.jsx("textarea",{value:C,onChange:ee=>D(ee.target.value),placeholder:"Scrivi il tuo messaggio...",rows:6,className:"w-full px-3 py-2 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-500"})]}):k==="audio"&&me?e.jsxs("div",{className:"p-4 bg-gray-800 rounded-lg border border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ir,{className:"w-8 h-8 text-blue-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-white",children:"Messaggio vocale"}),e.jsxs("p",{className:"text-sm text-gray-400",children:["Durata: ",yt(X)," | ",(me.size/1024/1024).toFixed(2)," MB"]}),e.jsx("audio",{controls:!0,src:URL.createObjectURL(me),className:"w-full mt-2"})]}),e.jsx("button",{onClick:()=>{Q(null),pe(0)},className:"p-1 hover:bg-gray-700 rounded",children:e.jsx(jt,{className:"w-5 h-5 text-gray-300"})})]}),e.jsx("button",{onClick:Ke,className:"w-full mt-3 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm",children:"Registra di nuovo"})]}):E&&e.jsx("div",{className:"p-4 bg-gray-800 rounded-lg border border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-3",children:[k==="audio"&&e.jsx(Ir,{className:"w-8 h-8 text-blue-400"}),k==="image"&&e.jsx($r,{className:"w-8 h-8 text-blue-400"}),k==="file"&&e.jsx(Ht,{className:"w-8 h-8 text-blue-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-white",children:E.name}),e.jsxs("p",{className:"text-sm text-gray-400",children:[(E.size/1024/1024).toFixed(2)," MB"]})]}),e.jsx("button",{onClick:()=>U(null),className:"ml-auto p-1 hover:bg-gray-700 rounded",children:e.jsx(jt,{className:"w-5 h-5 text-gray-300"})})]})}),e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-amber-900/30 border border-amber-700 rounded-lg",children:[e.jsx("input",{type:"checkbox",id:"urgent",checked:q,onChange:ee=>J(ee.target.checked),className:"w-4 h-4 text-blue-600"}),e.jsxs("label",{htmlFor:"urgent",className:"text-sm text-amber-300 flex items-center gap-2",children:[e.jsx(wt,{className:"w-4 h-4"}),"Messaggio urgente (invia notifica push immediata)"]})]}),e.jsx("button",{onClick:ne,disabled:N||_e||(k==="text"?!C.trim():k==="audio"?!me:!E)||M!=="all"&&F.filter(ee=>ee.selected).length===0,className:"w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-700 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2",children:N?e.jsxs(e.Fragment,{children:[e.jsx(En,{className:"w-5 h-5 animate-spin"}),"Invio in corso..."]}):e.jsxs(e.Fragment,{children:[e.jsx(So,{className:"w-5 h-5"}),"Invia Messaggio"]})})]})}),G&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-sm w-full border border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Conferma Eliminazione"}),e.jsx("p",{className:"text-gray-300 mb-6",children:"Sei sicuro di voler eliminare questo messaggio?"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>$(null),className:"flex-1 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors",children:"Annulla"}),e.jsx("button",{onClick:()=>fe(G),className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Elimina"})]})]})})]})}const Qd=({isOpen:n,onClose:l,date:c,crewMembers:u,shifts:f,selectedTemplate:x,onAddShift:b})=>{const[v,S]=w.useState(""),[g,j]=w.useState([]),[p,M]=w.useState({}),[B,k]=w.useState(!1);w.useEffect(()=>{n&&c&&u.length>0&&R()},[n,c,u]);const R=async()=>{k(!0);const N={};for(const _ of u){const L=await C(_.id,c);N[_.id]=L}M(N),k(!1)},C=async(N,_)=>{var L,I;try{const{data:K,error:O}=await Le.from("crew_ferie").select("*").eq("dipendente_id",N).eq("stato","approvata").lte("data_inizio",_).gte("data_fine",_).maybeSingle();if(K&&!O)return{isUnavailable:!0,reason:"Ferie",tipo:"ferie",details:`Dal ${new Date(K.data_inizio).toLocaleDateString("it-IT")} al ${new Date(K.data_fine).toLocaleDateString("it-IT")}`};const{data:W,error:se}=await Le.from("crew_richieste_permessi").select("*").eq("dipendente_id",N).eq("stato","approvata").eq("data",_);if(W&&W.length>0&&!se){const F=W[0];return{isUnavailable:!0,reason:"Permesso",tipo:"permessi",details:`${(L=F.ora_inizio)==null?void 0:L.slice(0,5)} - ${(I=F.ora_fine)==null?void 0:I.slice(0,5)}`}}const{data:G,error:$}=await Le.from("crew_richiesteferie_permessi").select("*").eq("dipendente_id",N).eq("stato","approvata").lte("data_inizio",_).gte("data_fine",_);if(G&&G.length>0&&!$){const F=G[0];let re="ferie",_e="Assente";return F.tipo_richiesta==="ferie"?(re="ferie",_e="Ferie"):F.tipo_richiesta==="permesso"||F.tipo_richiesta==="permessi"?(re="permessi",_e="Permesso"):F.tipo_richiesta==="malattia"?(re="malattia",_e="Malattia"):F.tipo_richiesta==="infortunio"&&(re="infortunio",_e="Infortunio"),{isUnavailable:!0,reason:_e,tipo:re,details:F.data_fine?`Dal ${new Date(F.data_inizio).toLocaleDateString("it-IT")} al ${new Date(F.data_fine).toLocaleDateString("it-IT")}`:new Date(F.data_inizio).toLocaleDateString("it-IT")}}return{isUnavailable:!1,reason:"",tipo:null}}catch(K){return console.error("Errore verifica disponibilit√†:",K),{isUnavailable:!1,reason:"",tipo:null}}},D=()=>{S(""),j([]),l()},E=N=>{const _=g.find(L=>L.id===N);j(_?g.filter(L=>L.id!==N):[...g,{id:N,ora_inizio:(x==null?void 0:x.ora_inizio_turno)||"09:00:00",ora_fine:(x==null?void 0:x.ora_fine_turno)||"18:00:00"}])},U=(N,_,L)=>{j(g.map(I=>I.id===N?{...I,[_]:L}:I))},q=()=>{g.forEach(N=>{b(N.id,{ora_inizio:N.ora_inizio,ora_fine:N.ora_fine})}),D()};if(!n)return null;const J=u.filter(N=>v?(N.full_name||`${N.first_name} ${N.last_name}`).toLowerCase().includes(v.toLowerCase()):!0);return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-end sm:items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 rounded-t-2xl sm:rounded-2xl w-full sm:max-w-3xl max-h-[90vh] overflow-y-auto border border-gray-700",children:[e.jsxs("div",{className:"sticky top-0 bg-gray-800 border-b border-gray-700 px-6 py-4 flex items-center justify-between z-10",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"Aggiungi Dipendenti al Turno"}),e.jsx("button",{onClick:D,className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(jt,{className:"w-5 h-5 text-gray-300"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Data"}),e.jsx("div",{className:"text-white font-semibold",children:new Date(c+"T00:00:00").toLocaleDateString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]}),x&&e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-2",children:"Turno Template"}),e.jsx("div",{className:"text-white font-semibold",children:x.nome_template}),e.jsxs("div",{className:"text-sm text-gray-400 mt-2",children:[x.ora_inizio_turno.slice(0,5)," -"," ",x.ora_fine_turno.slice(0,5)]}),e.jsx("div",{className:"text-sm text-gray-400 mt-1",children:x.nome_magazzino})]}),e.jsxs("div",{className:"bg-gray-900 rounded-lg border border-gray-700",children:[e.jsx("div",{className:"p-4 border-b border-gray-700",children:e.jsxs("div",{className:"relative",children:[e.jsx(nn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Cerca dipendente...",value:v,onChange:N=>S(N.target.value),className:"w-full pl-10 pr-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"})]})}),e.jsx("div",{className:"p-4 space-y-2 max-h-[400px] overflow-y-auto",children:B?e.jsx("div",{className:"text-center py-8 text-gray-400",children:"Verifica disponibilit√† dipendenti..."}):J.map(N=>{const _=f.some(W=>W.dipendente_id===N.id&&W.data_turno===c),L=p[N.id],I=g.some(W=>W.id===N.id),K=g.find(W=>W.id===N.id),O=_||(L==null?void 0:L.isUnavailable);return e.jsxs("div",{className:`rounded-lg border transition-colors ${O?"bg-gray-800 border-gray-700 opacity-60":I?"bg-blue-900 border-blue-600":"bg-gray-800 border-gray-600 hover:border-blue-500"}`,children:[e.jsxs("div",{className:`p-4 flex items-center gap-3 ${O?"cursor-not-allowed":"cursor-pointer"}`,onClick:()=>!O&&E(N.id),children:[e.jsx("input",{type:"checkbox",checked:I,disabled:O,onChange:()=>{},className:"w-5 h-5 rounded border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-white",children:N.full_name||`${N.first_name} ${N.last_name}`}),_&&e.jsx("div",{className:"text-xs text-yellow-400 mt-1",children:"Gi√† assegnato a questo turno"}),(L==null?void 0:L.isUnavailable)&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-red-400 mt-1",children:[e.jsx(Zt,{className:"w-3 h-3"}),e.jsxs("span",{children:[L.reason,L.details&&` - ${L.details}`]})]})]})]}),I&&K&&e.jsx("div",{className:"px-4 pb-4 pt-2 border-t border-gray-700",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Ora Inizio"}),e.jsx("input",{type:"time",value:K.ora_inizio.slice(0,5),onChange:W=>U(N.id,"ora_inizio",W.target.value+":00"),className:"w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Ora Fine"}),e.jsx("input",{type:"time",value:K.ora_fine.slice(0,5),onChange:W=>U(N.id,"ora_fine",W.target.value+":00"),className:"w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]})})]},N.id)})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:D,className:"flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors",children:"Annulla"}),e.jsxs("button",{onClick:q,disabled:g.length===0,className:"flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:["Aggiungi ",g.length>0&&`(${g.length})`]})]})]})]})})},Kd=()=>{const{companyProfile:n}=ds(),{addToast:l}=zr(),[c,u]=w.useState([]),[f,x]=w.useState([]),[b,v]=w.useState([]),[S,g]=w.useState(!0),[j,p]=w.useState(ge(new Date)),[M,B]=w.useState(null),[k,R]=w.useState(null),[C,D]=w.useState(!1),[E,U]=w.useState(""),[q,J]=w.useState(!1),[N,_]=w.useState(""),[L,I]=w.useState(!1),[K,O]=w.useState([]),[W,se]=w.useState(!1),[G,$]=w.useState(null),[F,re]=w.useState(!1),_e=w.useRef(null);function ge(te){const ke=new Date(te),Z=ke.getDay(),he=ke.getDate()-Z+(Z===0?-6:1);return new Date(ke.setDate(he))}function X(te){const ke=[];for(let Z=0;Z<7;Z++){const he=new Date(te);he.setDate(te.getDate()+Z),ke.push(he)}return ke}function pe(te){return te.toISOString().split("T")[0]}function me(te){return te.toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"})}const Q=X(j);w.useEffect(()=>{n&&V()},[n]),w.useEffect(()=>{n&&E&&le()},[n,j,E]);const V=async()=>{await Promise.all([de(),ae()])},de=async()=>{if(n)try{const{data:te,error:ke}=await Le.from("crew_members").select("id, first_name, last_name, full_name").eq("company_id",n.id).order("full_name");if(ke)throw ke;x(te||[])}catch(te){console.error("Errore caricamento dipendenti:",te)}},ae=async()=>{if(n)try{const{data:te,error:ke}=await Le.from("crew_template_turni").select("id_template, nome_template, ora_inizio_turno, ora_fine_turno, warehouse_id, nome_magazzino, indirizzo_magazzino").eq("company_id",n.id).order("nome_template");if(ke)throw ke;v(te||[]),te&&te.length>0&&!E&&U(te[0].id_template)}catch(te){console.error("Errore caricamento template:",te)}},le=async()=>{if(!(!n||!E)){g(!0);try{const te=new Date(j);te.setDate(j.getDate()+6);const{data:ke,error:Z}=await Le.from("crew_assegnazione_turni").select("*").eq("azienda_id",n.id).eq("turno_id",E).gte("data_turno",pe(j)).lte("data_turno",pe(te)).order("ora_inizio_turno",{ascending:!0});if(Z)throw Z;u(ke||[])}catch(te){l(te.message||"Errore nel caricamento turni","error")}finally{g(!1)}}},be=()=>{const te=new Date(j);te.setDate(j.getDate()-7),p(te)},ye=()=>{const te=new Date(j);te.setDate(j.getDate()+7),p(te)},Ce=()=>{p(ge(new Date))},Ne=te=>{const ke=pe(te);return c.filter(Z=>Z.data_turno===ke)},Ae=(te,ke)=>{B({shift:te,sourceDate:ke})},Ue=te=>{te.preventDefault()},qe=async te=>{if(M){if(M.sourceDate===te){B(null);return}try{const{error:ke}=await Le.from("crew_assegnazione_turni").update({data_turno:te}).eq("id",M.shift.id);if(ke)throw ke;l("Turno spostato con successo","success"),le()}catch(ke){l(ke.message||"Errore nello spostamento del turno","error")}finally{B(null)}}},rt=te=>{L?Je(te.id):(R(te),D(!0))},at=te=>{_e.current=setTimeout(()=>{I(!0),O([te.id]),l("Modalit√† selezione multipla attivata","success")},500)},Ke=()=>{_e.current&&(clearTimeout(_e.current),_e.current=null)},Je=te=>{O(ke=>ke.includes(te)?ke.filter(Z=>Z!==te):[...ke,te])},Ge=()=>{I(!1),O([])},yt=async te=>{if(!L||K.length===0||!n)return;const ke=c.filter(Z=>K.includes(Z.id));try{const Z=ke.map(we=>({dipendente_id:we.dipendente_id,dipendente_nome:we.dipendente_nome,turno_id:we.turno_id,nome_turno:we.nome_turno,ora_inizio_turno:we.ora_inizio_turno,ora_fine_turno:we.ora_fine_turno,nome_magazzino:we.nome_magazzino,indirizzo_magazzino:we.indirizzo_magazzino,warehouse_id:we.warehouse_id,data_turno:te,azienda_id:we.azienda_id,nome_azienda:we.nome_azienda})),{error:he}=await Le.from("crew_assegnazione_turni").insert(Z);if(he)throw he;l(`${Z.length} turni copiati con successo`,"success"),Ge(),le()}catch(Z){l(Z.message||"Errore nella copia dei turni","error")}},Ye=te=>{L?yt(te):De(te)},Te=async te=>{if(k)try{const{error:ke}=await Le.from("crew_assegnazione_turni").update(te).eq("id",k.id);if(ke)throw ke;l("Turno aggiornato con successo","success"),D(!1),R(null),le()}catch(ke){l(ke.message||"Errore nell'aggiornamento del turno","error")}},H=te=>{$(te),se(!0)},ne=async()=>{if(G)try{const{error:te}=await Le.from("crew_assegnazione_turni").delete().eq("id",G);if(te)throw te;l("Turno eliminato con successo","success"),D(!1),R(null),le()}catch(te){l(te.message||"Errore nell'eliminazione del turno","error")}finally{se(!1),$(null)}},fe=()=>{se(!1),$(null)},Ie=()=>{if(K.length===0){l("Nessun turno selezionato","error");return}re(!0)},Re=async()=>{if(K.length!==0)try{const{error:te}=await Le.from("crew_assegnazione_turni").delete().in("id",K);if(te)throw te;l(`${K.length} turni eliminati con successo`,"success"),Ge(),le()}catch(te){l(te.message||"Errore nell'eliminazione dei turni","error")}finally{re(!1)}},ee=()=>{re(!1)},oe=async(te,ke)=>{if(!n||!E||!N)return;const Z=f.find(we=>we.id===te),he=b.find(we=>we.id_template===E);if(!Z||!he){l("Dipendente o turno non valido","error");return}try{const we={dipendente_id:te,dipendente_nome:Z.full_name||`${Z.first_name} ${Z.last_name}`,turno_id:E,nome_turno:he.nome_template,ora_inizio_turno:(ke==null?void 0:ke.ora_inizio)||he.ora_inizio_turno,ora_fine_turno:(ke==null?void 0:ke.ora_fine)||he.ora_fine_turno,nome_magazzino:he.nome_magazzino,indirizzo_magazzino:he.indirizzo_magazzino,warehouse_id:he.warehouse_id,data_turno:N,azienda_id:n.id,nome_azienda:n.company_name||""},{error:ve}=await Le.from("crew_assegnazione_turni").insert(we);if(ve)throw ve;l("Dipendente aggiunto al turno","success"),J(!1),_(""),le()}catch(we){l(we.message||"Errore nell'aggiunta del dipendente","error")}},De=te=>{_(te),J(!0)};if(S)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"})});const Ee=b.find(te=>te.id_template===E);return e.jsxs("div",{className:"space-y-4 pb-20",children:[L&&e.jsxs("div",{className:"bg-green-600 rounded-xl border border-green-500 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Sn,{className:"w-5 h-5 text-white"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-white font-semibold",children:"Modalit√† Selezione Attiva"}),e.jsxs("div",{className:"text-green-100 text-sm",children:[K.length," turno",K.length!==1?"i":""," selezionato",K.length!==1?"i":""]})]})]}),e.jsx("button",{onClick:Ge,className:"p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors",children:e.jsx(jt,{className:"w-5 h-5 text-white"})})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:Ie,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:[e.jsx(Js,{className:"w-4 h-4"}),e.jsx("span",{children:"Elimina Selezionati"})]})})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 p-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Seleziona Template Turno"}),e.jsx("select",{value:E,onChange:te=>U(te.target.value),className:"w-full bg-gray-900 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500",disabled:L,children:b.map(te=>e.jsxs("option",{value:te.id_template,children:[te.nome_template," - ",te.nome_magazzino," (",te.ora_inizio_turno.slice(0,5)," - ",te.ora_fine_turno.slice(0,5),")"]},te.id_template))})]}),Ee&&e.jsxs("div",{className:"bg-gray-800 rounded-xl border border-gray-700 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ut,{className:"w-4 h-4 text-blue-400"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-white font-medium",children:Ee.nome_magazzino}),Ee.indirizzo_magazzino&&e.jsx("span",{className:"text-gray-400 ml-2",children:Ee.indirizzo_magazzino})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm mt-2",children:[e.jsx(ct,{className:"w-4 h-4 text-blue-400"}),e.jsxs("span",{className:"text-gray-300",children:[Ee.ora_inizio_turno.slice(0,5)," - ",Ee.ora_fine_turno.slice(0,5)]})]})]}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-gray-800 rounded-xl border border-gray-700",children:[e.jsx("button",{onClick:be,disabled:L,className:`p-2 rounded-lg transition-colors ${L?"opacity-50 cursor-not-allowed":"hover:bg-gray-700"}`,children:e.jsx(ta,{className:"w-5 h-5 text-gray-300"})}),e.jsxs("div",{className:"text-center",children:[e.jsxs("button",{onClick:Ce,disabled:L,className:`text-lg font-semibold text-white transition-colors ${L?"cursor-not-allowed":"hover:text-blue-400"}`,children:[me(Q[0])," - ",me(Q[6])]}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:L?"Clicca su altri dipendenti o su un giorno":"Tocca per oggi"})]}),e.jsx("button",{onClick:ye,disabled:L,className:`p-2 rounded-lg transition-colors ${L?"opacity-50 cursor-not-allowed":"hover:bg-gray-700"}`,children:e.jsx(sa,{className:"w-5 h-5 text-gray-300"})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-7 gap-2 md:gap-1",children:Q.map((te,ke)=>{const Z=pe(te),he=Ne(te),we=pe(new Date)===Z;return e.jsxs("div",{className:`min-h-[100px] md:min-h-[120px] rounded-lg border ${we?"border-blue-500 bg-blue-900/20":"border-gray-700 bg-gray-800"}`,onDragOver:Ue,onDrop:()=>qe(Z),children:[e.jsxs("div",{className:`text-center py-2 md:py-2 border-b ${we?"border-blue-500":"border-gray-700"}`,children:[e.jsx("div",{className:"text-sm md:text-xs text-gray-400 uppercase font-medium md:font-normal",children:te.toLocaleDateString("it-IT",{weekday:window.innerWidth<768?"long":"short"})}),e.jsxs("div",{className:`text-base md:text-sm font-semibold ${we?"text-blue-400":"text-white"}`,children:[te.getDate()," ",window.innerWidth<768&&te.toLocaleDateString("it-IT",{month:"short"})]})]}),e.jsxs("div",{className:"p-2 md:p-1 space-y-1.5 md:space-y-1",children:[he.map(ve=>{const Qe=K.includes(ve.id);return e.jsxs("div",{draggable:!L,onDragStart:()=>!L&&Ae(ve,Z),onClick:()=>rt(ve),onTouchStart:()=>at(ve),onTouchEnd:Ke,onMouseDown:()=>at(ve),onMouseUp:Ke,onMouseLeave:Ke,className:`rounded p-2 md:p-1.5 text-white text-sm md:text-xs transition-all ${Qe?"bg-green-600 border-2 border-green-400 shadow-lg":"bg-blue-600 hover:bg-blue-700 border-2 border-transparent"} ${L?"cursor-pointer":"cursor-move"}`,title:`${ve.dipendente_nome}
${ve.nome_magazzino}
${ve.ora_inizio_turno.slice(0,5)} - ${ve.ora_fine_turno.slice(0,5)}`,children:[e.jsx("div",{className:"font-medium truncate",children:ve.dipendente_nome}),e.jsxs("div",{className:"flex items-center gap-1 text-blue-200 mt-0.5",children:[e.jsx(ct,{className:"w-3 h-3 md:w-2.5 md:h-2.5"}),e.jsxs("span",{className:"truncate",children:[ve.ora_inizio_turno.slice(0,5),"-",ve.ora_fine_turno.slice(0,5)]})]}),e.jsx("div",{className:"block md:hidden text-xs text-blue-100 mt-1 truncate",children:ve.nome_magazzino})]},ve.id)}),e.jsx("button",{onClick:()=>Ye(Z),className:`w-full rounded p-2 md:p-1.5 text-sm md:text-xs transition-colors flex items-center justify-center gap-1 ${L?"bg-green-600 hover:bg-green-700 text-white font-semibold":"bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white"}`,children:L?e.jsxs(e.Fragment,{children:[e.jsx(Sn,{className:"w-4 h-4 md:w-3 md:h-3"}),e.jsx("span",{children:"Incolla qui"})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-xl md:text-lg leading-none",children:"+"}),e.jsx("span",{children:"Aggiungi"})]})})]})]},ke)})}),C&&k&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-end sm:items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 rounded-t-2xl sm:rounded-2xl w-full sm:max-w-md max-h-[80vh] overflow-y-auto border border-gray-700",children:[e.jsx("div",{className:"sticky top-0 bg-gray-800 border-b border-gray-700 px-6 py-4",children:e.jsx("h3",{className:"text-xl font-bold text-white",children:"Modifica Turno"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-2",children:"Dipendente"}),e.jsx("div",{className:"text-white font-semibold",children:k.dipendente_nome})]}),e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-2",children:"Data"}),e.jsx("input",{type:"date",value:k.data_turno,onChange:te=>R({...k,data_turno:te.target.value}),className:"w-full bg-gray-800 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500"})]}),e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-2",children:"Template Turno"}),e.jsx("select",{value:k.turno_id,onChange:te=>{const ke=b.find(Z=>Z.id_template===te.target.value);ke&&R({...k,turno_id:te.target.value,nome_turno:ke.nome_template,ora_inizio_turno:ke.ora_inizio_turno,ora_fine_turno:ke.ora_fine_turno,nome_magazzino:ke.nome_magazzino,indirizzo_magazzino:ke.indirizzo_magazzino,warehouse_id:ke.warehouse_id})},className:"w-full bg-gray-800 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500",children:b.map(te=>e.jsxs("option",{value:te.id_template,children:[te.nome_template," - ",te.nome_magazzino," (",te.ora_inizio_turno.slice(0,5)," - ",te.ora_fine_turno.slice(0,5),")"]},te.id_template))})]}),e.jsx("div",{className:"bg-gray-900 rounded-lg p-4 border border-gray-700",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Ut,{className:"w-4 h-4 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-white font-medium",children:k.nome_magazzino}),k.indirizzo_magazzino&&e.jsx("div",{className:"text-sm text-gray-400 mt-1",children:k.indirizzo_magazzino})]})]})}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:()=>H(k.id),className:"flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Elimina"}),e.jsx("button",{onClick:()=>Te(k),className:"flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors",children:"Salva"})]}),e.jsx("button",{onClick:()=>{D(!1),R(null)},className:"w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors",children:"Annulla"})]})]})}),e.jsx(Qd,{isOpen:q,onClose:()=>{J(!1),_("")},date:N,crewMembers:f,shifts:c,selectedTemplate:Ee,onAddShift:oe}),W&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-xl max-w-md w-full shadow-2xl",children:e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-red-100 rounded-full mx-auto mb-4",children:e.jsx(Js,{className:"w-6 h-6 text-red-600"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 text-center mb-2",children:"Elimina Turno"}),e.jsx("p",{className:"text-gray-600 text-center mb-6",children:"Sei sicuro di voler eliminare questo turno? Questa azione non pu√≤ essere annullata."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:fe,className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors",children:"Annulla"}),e.jsx("button",{onClick:ne,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Elimina"})]})]})})}),F&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-xl max-w-md w-full shadow-2xl",children:e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-red-100 rounded-full mx-auto mb-4",children:e.jsx(Js,{className:"w-6 h-6 text-red-600"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 text-center mb-2",children:"Elimina Turni Selezionati"}),e.jsxs("p",{className:"text-gray-600 text-center mb-6",children:["Sei sicuro di voler eliminare ",K.length," turno",K.length!==1?"i":"","? Questa azione non pu√≤ essere annullata."]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:ee,className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors",children:"Annulla"}),e.jsx("button",{onClick:Re,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Elimina Tutto"})]})]})})})]})},Jd=()=>{const{companyProfile:n}=ds(),{addToast:l}=zr(),[c,u]=w.useState([]),[f,x]=w.useState(!0),[b,v]=w.useState(""),[S,g]=w.useState("all"),[j,p]=w.useState("all"),[M,B]=w.useState(!1),[k,R]=w.useState(!1),[C,D]=w.useState(!1),[E,U]=w.useState(null),[q,J]=w.useState(!1),[N,_]=w.useState(null),[L,I]=w.useState([]),[K,O]=w.useState(new Set),[W,se]=w.useState([]),[G,$]=w.useState(!1),F=[{value:"tecnico",label:"Tecnico"},{value:"sicurezza",label:"Sicurezza"},{value:"gestionale",label:"Gestionale"},{value:"comunicazione",label:"Comunicazione"},{value:"altro",label:"Altro"}],re=[{value:"bozza",label:"Bozza",color:"gray"},{value:"pubblicato",label:"Pubblicato",color:"blue"},{value:"confermato",label:"Confermato",color:"green"},{value:"completato",label:"Completato",color:"emerald"},{value:"annullato",label:"Annullato",color:"red"}];w.useEffect(()=>{_e()},[n]);const _e=async()=>{if(n)try{x(!0);const{data:Ce,error:Ne}=await Le.from("crew_corsi").select(`
          *,
          partecipanti_count:crew_assegnazionecorsi(count)
        `).eq("azienda_id",n.id).order("data_corso",{ascending:!1});if(Ne)throw Ne;const Ae=(Ce==null?void 0:Ce.map(Ue=>{var qe,rt;return{...Ue,partecipanti_count:((rt=(qe=Ue.partecipanti_count)==null?void 0:qe[0])==null?void 0:rt.count)||0}}))||[];u(Ae)}catch(Ce){l(Ce.message||"Errore nel caricamento corsi","error")}finally{x(!1)}},ge=c.filter(Ce=>{var qe;const Ne=Ce.titolo.toLowerCase().includes(b.toLowerCase())||((qe=Ce.descrizione)==null?void 0:qe.toLowerCase().includes(b.toLowerCase()))||Ce.luogo.toLowerCase().includes(b.toLowerCase()),Ae=S==="all"||Ce.categoria===S,Ue=j==="all"||Ce.stato===j;return Ne&&Ae&&Ue}),X=()=>{U(null),J(!1),B(!0)},pe=Ce=>{U(Ce),J(!0),B(!0)},me=async Ce=>{if(confirm("Sei sicuro di voler eliminare questo corso?"))try{const{error:Ne}=await Le.from("crew_corsi").delete().eq("id",Ce);if(Ne)throw Ne;l("Corso eliminato con successo","success"),_e()}catch(Ne){l(Ne.message||"Errore durante l'eliminazione","error")}},Q=Ce=>{U(Ce),R(!0)},V=async Ce=>{_(Ce),O(new Set);try{const[Ne,Ae]=await Promise.all([Le.from("registration_requests").select("id, full_name, email, tipologia_registrazione").eq("parent_company_id",n.id).eq("status","approved").in("tipologia_registrazione",["dipendente","freelance"]).order("full_name",{ascending:!0}),Le.from("crew_assegnazionecorsi").select("persona_id").eq("corso_id",Ce.id)]);if(Ne.error)throw Ne.error;if(Ae.error)throw Ae.error;I(Ne.data||[]),se(Ae.data||[])}catch(Ne){l(Ne.message||"Errore caricamento dipendenti","error")}},de=Ce=>{U(Ce),D(!0)},ae=async()=>{if(E)try{const{error:Ce}=await Le.from("crew_corsi").update({stato:"confermato",confermato:!0,updated_at:new Date().toISOString()}).eq("id",E.id);if(Ce)throw Ce;l("Corso confermato con successo","success"),D(!1),U(null),_e()}catch(Ce){l(Ce.message||"Errore durante la conferma","error")}},le=Ce=>{const Ne=new Set(K);if(Ne.has(Ce))Ne.delete(Ce);else{const Ae=W.map(qe=>qe.persona_id),Ue=((N==null?void 0:N.max_partecipanti)||0)-Ae.length;if(Ne.size>=Ue){l(`Massimo ${N==null?void 0:N.max_partecipanti} partecipanti raggiunto`,"error");return}Ne.add(Ce)}O(Ne)},be=async()=>{if(!N||K.size===0){l("Seleziona almeno un dipendente","error");return}try{$(!0);const Ce=Array.from(K).map(Ae=>{const Ue=L.find(rt=>rt.id===Ae),qe=new Date().toISOString();return{azienda_id:n.id,corso_id:N.id,corso_titolo:N.titolo,persona_id:Ae,persona_nome:Ue==null?void 0:Ue.full_name,persona_tipo:(Ue==null?void 0:Ue.tipologia_registrazione)||"dipendente",persona_email:Ue==null?void 0:Ue.email,stato_invito:"confermato",data_invito:qe,data_conferma:qe}}),{error:Ne}=await Le.from("crew_assegnazionecorsi").insert(Ce);if(Ne)throw Ne;l(`${K.size} partecipanti assegnati con successo`,"success"),_(null),O(new Set),I([]),se([]),_e()}catch(Ce){l(Ce.message||"Errore durante l'assegnazione","error")}finally{$(!1)}},ye=Ce=>{const Ne=re.find(Ae=>Ae.value===Ce);return(Ne==null?void 0:Ne.color)||"gray"};if(f)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"})});if(N){const Ce=W.map(Ae=>Ae.persona_id),Ne=N.max_partecipanti-Ce.length;return e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white p-4 space-y-4 pb-24",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Assegna Partecipanti"}),e.jsx("button",{onClick:()=>{_(null),O(new Set),I([]),se([])},className:"text-gray-400 hover:text-white",children:e.jsx(jt,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsx("h3",{className:"font-semibold text-white mb-2",children:N.titolo}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ut,{className:"h-4 w-4"}),e.jsx("span",{children:new Date(N.data_corso).toLocaleDateString("it-IT")})]}),N.luogo&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:N.luogo})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ls,{className:"h-4 w-4"}),e.jsxs("span",{children:[Ce.length+K.size," / ",N.max_partecipanti," partecipanti",Ce.length>0&&e.jsxs("span",{className:"text-green-400 ml-1",children:["(",Ce.length," gi√† assegnati)"]})]})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-white mb-3",children:["Seleziona Dipendenti (",K.size," / ",Ne," disponibili)"]}),L.length===0?e.jsxs("div",{className:"bg-gray-800 rounded-lg p-8 text-center",children:[e.jsx(ls,{className:"w-12 h-12 text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-400",children:"Nessun dipendente disponibile"})]}):e.jsx("div",{className:"space-y-2",children:L.map(Ae=>{const Ue=K.has(Ae.id),qe=Ce.includes(Ae.id);return e.jsxs("button",{onClick:()=>!qe&&le(Ae.id),disabled:qe,className:`w-full flex items-center justify-between p-4 rounded-lg border-2 transition-all ${qe?"bg-green-600/30 border-green-500 cursor-not-allowed":Ue?"bg-blue-500/20 border-blue-500":"bg-gray-800 border-gray-700 hover:bg-gray-750"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${qe?"bg-green-500":Ue?"bg-blue-500":"bg-gray-700"}`,children:qe||Ue?e.jsx(Xr,{className:"h-6 w-6 text-white"}):e.jsx(ls,{className:"h-5 w-5 text-gray-400"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:`font-semibold ${qe?"text-green-300":"text-white"}`,children:Ae.full_name}),e.jsx("p",{className:`text-sm ${qe?"text-green-400 font-medium":"text-gray-400"} capitalize`,children:qe?"Gi√† assegnato":Ae.tipologia_registrazione})]})]}),qe&&e.jsx("span",{className:"text-sm text-green-300 font-bold bg-green-500/20 px-3 py-1 rounded-full",children:"ASSEGNATO"})]},Ae.id)})})]}),K.size>0&&e.jsx("button",{onClick:be,disabled:G,className:"w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-700 text-white py-4 rounded-lg font-medium text-lg flex items-center justify-center gap-2",children:G?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),e.jsx("span",{children:"Salvataggio..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Xr,{className:"h-5 w-5"}),e.jsxs("span",{children:["Conferma Assegnazioni (",K.size,")"]})]})})]})}return e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white p-4 space-y-4",children:[e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Gestione Corsi"}),e.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"Organizza e monitora i corsi di formazione"})]})}),e.jsxs("button",{onClick:X,className:"w-full flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors shadow-lg",children:[e.jsx(_a,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"Nuovo Corso"})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(nn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Cerca corsi...",value:b,onChange:Ce=>v(Ce.target.value),className:"w-full pl-10 pr-4 py-2.5 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Categoria"}),e.jsxs("select",{value:S,onChange:Ce=>g(Ce.target.value),className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"Tutte"}),F.map(Ce=>e.jsx("option",{value:Ce.value,children:Ce.label},Ce.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Stato"}),e.jsxs("select",{value:j,onChange:Ce=>p(Ce.target.value),className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"Tutti"}),re.map(Ce=>e.jsx("option",{value:Ce.value,children:Ce.label},Ce.value))]})]})]})]}),ge.length===0?e.jsxs("div",{className:"bg-gray-800 rounded-lg p-12 text-center",children:[e.jsx(mi,{className:"w-16 h-16 text-gray-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"Nessun corso trovato"}),e.jsx("p",{className:"text-gray-400 mb-6",children:b||S!=="all"||j!=="all"?"Prova a modificare i filtri di ricerca":"Inizia creando il tuo primo corso di formazione"}),!b&&S==="all"&&j==="all"&&e.jsxs("button",{onClick:X,className:"inline-flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(_a,{className:"w-5 h-5"}),e.jsx("span",{children:"Crea Primo Corso"})]})]}):e.jsx("div",{className:"space-y-3",children:ge.map(Ce=>e.jsx(eu,{course:Ce,onEdit:pe,onDelete:me,onViewDetails:Q,onAssignParticipants:V,onConfirm:de,getStatusColor:ye},Ce.id))}),M&&e.jsx(tu,{course:E,isEdit:q,onClose:()=>{B(!1),U(null),J(!1)},onSuccess:()=>{B(!1),U(null),J(!1),_e()},categories:F,statusOptions:re}),k&&E&&e.jsx(su,{course:E,onClose:()=>{R(!1),U(null)}}),C&&E&&e.jsx("div",{className:"fixed top-16 left-0 right-0 bottom-0 z-30 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg border border-gray-700 w-full max-w-md p-6 space-y-4 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-green-600/20 flex items-center justify-center",children:e.jsx(Xr,{className:"w-6 h-6 text-green-500"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Conferma Corso"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Questa azione render√† il corso visibile"})]})]}),e.jsxs("div",{className:"bg-gray-900/50 rounded-lg p-4 space-y-2",children:[e.jsx("p",{className:"text-white font-medium",children:E.titolo}),e.jsxs("p",{className:"text-sm text-gray-400",children:["Il corso passer√† allo stato ",e.jsx("span",{className:"text-green-400 font-medium",children:'"Confermato"'})," e sar√† visibile a tutti i dipendenti assegnati."]})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>{D(!1),U(null)},className:"flex-1 px-4 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium",children:"Annulla"}),e.jsx("button",{onClick:ae,className:"flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium",children:"Conferma"})]})]})})]})},eu=({course:n,onEdit:l,onDelete:c,onViewDetails:u,onAssignParticipants:f,onConfirm:x,getStatusColor:b})=>{const v=b(n.stato),S={gray:"bg-gray-700 text-gray-300",blue:"bg-blue-900/50 text-blue-300",yellow:"bg-yellow-900/50 text-yellow-300",green:"bg-green-900/50 text-green-300",red:"bg-red-900/50 text-red-300"},g=j=>new Date(j).toLocaleDateString("it-IT",{day:"2-digit",month:"long",year:"numeric"});return e.jsx("div",{className:"bg-gray-800 rounded-lg border border-gray-700 overflow-hidden",children:e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{className:"flex items-start justify-between gap-2",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-lg text-white mb-1 truncate",children:n.titolo}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`inline-block px-2 py-0.5 text-xs font-medium rounded ${S[v]}`,children:n.stato.replace("_"," ").toUpperCase()}),n.obbligatorio&&e.jsx("span",{className:"bg-red-900/50 text-red-300 text-xs px-2 py-0.5 rounded font-medium",children:"OBBLIGATORIO"})]})]})}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-300",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ut,{className:"w-4 h-4 text-gray-500 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:g(n.data_corso)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ct,{className:"w-4 h-4 text-gray-500 flex-shrink-0"}),e.jsxs("span",{children:[n.ora_inizio," - ",n.ora_fine]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"w-4 h-4 text-gray-500 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:n.luogo})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ls,{className:"w-4 h-4 text-gray-500 flex-shrink-0"}),e.jsxs("span",{children:[n.partecipanti_count||0," / ",n.max_partecipanti," partecipanti"]})]})]}),n.descrizione&&e.jsx("p",{className:"text-sm text-gray-400 line-clamp-2",children:n.descrizione}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 pt-3 border-t border-gray-700",children:[n.stato==="bozza"&&e.jsxs("button",{onClick:()=>x(n),className:"col-span-2 flex items-center justify-center gap-2 px-3 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",children:[e.jsx(Xr,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Conferma Corso"})]}),e.jsxs("button",{onClick:()=>u(n),className:"flex items-center justify-center gap-2 px-3 py-2 bg-gray-700 text-gray-200 rounded-lg hover:bg-gray-600 transition-colors",children:[e.jsx(an,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Dettagli"})]}),e.jsxs("button",{onClick:()=>f(n),className:"flex items-center justify-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(Ao,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Assegna"})]}),e.jsxs("button",{onClick:()=>l(n),className:"flex items-center justify-center gap-2 px-3 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors",children:[e.jsx(cr,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Modifica"})]}),e.jsxs("button",{onClick:()=>c(n.id),className:"flex items-center justify-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:[e.jsx(Js,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Elimina"})]})]})]})})},tu=({course:n,isEdit:l,onClose:c,onSuccess:u,categories:f,statusOptions:x})=>{const{companyProfile:b}=ds(),{addToast:v}=zr(),[S,g]=w.useState(!1),[j,p]=w.useState({titolo:(n==null?void 0:n.titolo)||"",descrizione:(n==null?void 0:n.descrizione)||"",data_corso:(n==null?void 0:n.data_corso)||"",ora_inizio:(n==null?void 0:n.ora_inizio)||"09:00",ora_fine:(n==null?void 0:n.ora_fine)||"17:00",luogo:(n==null?void 0:n.luogo)||"",istruttore:(n==null?void 0:n.istruttore)||"",categoria:(n==null?void 0:n.categoria)||"tecnico",obbligatorio:(n==null?void 0:n.obbligatorio)||!1,max_partecipanti:(n==null?void 0:n.max_partecipanti)||20,visibilita:(n==null?void 0:n.visibilita)||"pubblico",stato:(n==null?void 0:n.stato)||"bozza",confermato:(n==null?void 0:n.confermato)||!1,note:(n==null?void 0:n.note)||""}),M=async B=>{if(B&&B.preventDefault(),!!b){if(!j.titolo||!j.data_corso||!j.luogo){v("Compila tutti i campi obbligatori","error");return}try{if(g(!0),l&&n){const{error:k}=await Le.from("crew_corsi").update({...j,updated_at:new Date().toISOString()}).eq("id",n.id);if(k)throw k;v("Corso aggiornato con successo","success")}else{const{error:k}=await Le.from("crew_corsi").insert({...j,azienda_id:b.id});if(k)throw k;v("Corso creato con successo","success")}u()}catch(k){v(k.message||"Errore durante il salvataggio","error")}finally{g(!1)}}};return e.jsx("div",{className:"fixed top-16 left-0 right-0 bottom-0 bg-black/95 z-30 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-gray-900 w-full max-w-2xl rounded-lg shadow-xl flex flex-col max-h-[85vh]",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-800",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:l?"Modifica Corso":"Nuovo Corso"}),e.jsx("button",{onClick:c,className:"p-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(jt,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:M,className:"flex-1 overflow-y-auto p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Titolo Corso *"}),e.jsx("input",{type:"text",value:j.titolo,onChange:B=>p({...j,titolo:B.target.value}),className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",placeholder:"Es: Corso Sicurezza Base",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Descrizione"}),e.jsx("textarea",{value:j.descrizione,onChange:B=>p({...j,descrizione:B.target.value}),rows:2,className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm",placeholder:"Descrizione del corso..."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Data Corso *"}),e.jsx("input",{type:"date",value:j.data_corso,onChange:B=>p({...j,data_corso:B.target.value}),className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Categoria *"}),e.jsx("select",{value:j.categoria,onChange:B=>p({...j,categoria:B.target.value}),className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",children:f.map(B=>e.jsx("option",{value:B.value,children:B.label},B.value))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Ora Inizio *"}),e.jsx("input",{type:"time",value:j.ora_inizio,onChange:B=>p({...j,ora_inizio:B.target.value}),className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Ora Fine *"}),e.jsx("input",{type:"time",value:j.ora_fine,onChange:B=>p({...j,ora_fine:B.target.value}),className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Luogo *"}),e.jsx("input",{type:"text",value:j.luogo,onChange:B=>p({...j,luogo:B.target.value}),placeholder:"Es: Sede Centrale, Aula 1",className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Istruttore"}),e.jsx("input",{type:"text",value:j.istruttore,onChange:B=>p({...j,istruttore:B.target.value}),placeholder:"Nome dell'istruttore",className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Max Partecipanti"}),e.jsx("input",{type:"number",value:j.max_partecipanti,onChange:B=>p({...j,max_partecipanti:parseInt(B.target.value)}),min:"1",className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Stato"}),e.jsx("select",{value:j.stato,onChange:B=>p({...j,stato:B.target.value}),className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",children:x.map(B=>e.jsx("option",{value:B.value,children:B.label},B.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center gap-2 bg-gray-800 p-3 rounded-lg cursor-pointer hover:bg-gray-750 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:j.obbligatorio,onChange:B=>p({...j,obbligatorio:B.target.checked}),className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-200",children:"Corso Obbligatorio"})]}),e.jsxs("label",{className:"flex items-center gap-2 bg-gray-800 p-3 rounded-lg cursor-pointer hover:bg-gray-750 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:j.confermato,onChange:B=>p({...j,confermato:B.target.checked}),className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-200",children:"Confermato"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-400 mb-1.5",children:"Note"}),e.jsx("textarea",{value:j.note,onChange:B=>p({...j,note:B.target.value}),rows:2,className:"w-full px-3 py-2.5 bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm",placeholder:"Note aggiuntive..."})]})]}),e.jsxs("div",{className:"border-t border-gray-800 p-4 flex gap-3",children:[e.jsx("button",{type:"button",onClick:c,className:"flex-1 px-4 py-2.5 text-white bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors font-medium text-sm",children:"Annulla"}),e.jsx("button",{type:"submit",disabled:S,onClick:M,className:"flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 font-medium text-sm",children:S?"Salvataggio...":l?"Aggiorna":"Crea Corso"})]})]})})},su=({course:n,onClose:l})=>{const[c,u]=w.useState([]),[f,x]=w.useState(!0);w.useEffect(()=>{b()},[]);const b=async()=>{try{const{data:S,error:g}=await Le.from("crew_assegnazionecorsi").select("*").eq("corso_id",n.id).order("persona_nome");if(g)throw g;u(S||[])}catch(S){console.error("Error loading assignments:",S)}finally{x(!1)}},v=S=>new Date(S).toLocaleDateString("it-IT",{day:"2-digit",month:"long",year:"numeric"});return e.jsx("div",{className:"fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-gray-900 w-full max-w-2xl rounded-lg shadow-xl flex flex-col max-h-[90vh]",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-800",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:n.titolo}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:n.categoria})]}),e.jsx("button",{onClick:l,className:"p-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(jt,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 space-y-2",children:[e.jsx("h3",{className:"font-semibold text-white text-sm",children:"Informazioni Corso"}),e.jsxs("div",{className:"space-y-1.5 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ut,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-gray-300",children:v(n.data_corso)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ct,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),e.jsxs("span",{className:"text-gray-300",children:[n.ora_inizio," - ",n.ora_fine]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-gray-300",children:n.luogo})]}),n.istruttore&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ls,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),e.jsxs("span",{className:"text-gray-300",children:["Istruttore: ",n.istruttore]})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3 space-y-2",children:[e.jsx("h3",{className:"font-semibold text-white text-sm",children:"Dettagli"}),e.jsxs("div",{className:"space-y-1 text-xs text-gray-300",children:[e.jsxs("div",{children:["Stato: ",e.jsx("span",{className:"font-medium text-white",children:n.stato})]}),e.jsxs("div",{children:["Max Partecipanti: ",e.jsx("span",{className:"font-medium text-white",children:n.max_partecipanti})]}),e.jsxs("div",{children:["Obbligatorio: ",e.jsx("span",{className:"font-medium text-white",children:n.obbligatorio?"S√¨":"No"})]}),e.jsxs("div",{children:["Confermato: ",e.jsx("span",{className:"font-medium text-white",children:n.confermato?"S√¨":"No"})]})]})]}),n.descrizione&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3",children:[e.jsx("h3",{className:"font-semibold text-white text-sm mb-1.5",children:"Descrizione"}),e.jsx("p",{className:"text-xs text-gray-300",children:n.descrizione})]}),n.note&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3",children:[e.jsx("h3",{className:"font-semibold text-white text-sm mb-1.5",children:"Note"}),e.jsx("p",{className:"text-xs text-gray-300",children:n.note})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-3",children:[e.jsxs("h3",{className:"font-semibold text-white text-sm mb-2",children:["Partecipanti (",c.length,")"]}),f?e.jsx("div",{className:"text-center py-6",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mx-auto"})}):c.length===0?e.jsxs("div",{className:"text-center py-6",children:[e.jsx(ls,{className:"w-10 h-10 text-gray-600 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"Nessun partecipante assegnato"})]}):e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:c.map(S=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-700 rounded-lg",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-white truncate",children:S.persona_nome}),e.jsx("div",{className:"text-xs text-gray-400 truncate",children:S.persona_email})]}),e.jsx("span",{className:`px-2 py-0.5 text-xs rounded flex-shrink-0 ml-2 ${S.stato_invito==="confermato"?"bg-green-900/50 text-green-300":S.stato_invito==="rifiutato"?"bg-red-900/50 text-red-300":"bg-yellow-900/50 text-yellow-300"}`,children:S.stato_invito})]},S.id))})]})]}),e.jsx("div",{className:"border-t border-gray-800 p-4",children:e.jsx("button",{onClick:l,className:"w-full px-4 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium text-sm",children:"Chiudi"})})]})})},ru=()=>{const{user:n,loading:l}=ds(),{toasts:c,removeToast:u}=Or(),[f,x]=Tt.useState("dashboard");if(l)return e.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"})});if(!n)return e.jsx(kd,{});const b=()=>{switch(f){case"checkin":return e.jsx(Xd,{});case"events":return e.jsx($d,{});case"courses":return e.jsx(Jd,{});case"shifts":return e.jsx("div",{className:"p-4",children:e.jsx(Kd,{})});case"calendar":return e.jsx(Pd,{});case"expenses":return e.jsx(Yd,{});case"report":return e.jsx(Hd,{});case"talk":return e.jsx(Zd,{});case"profile":return e.jsx(Fd,{});default:return e.jsx(Ld,{onNavigate:x})}};return e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white flex flex-col",children:[e.jsx(Od,{}),e.jsx("div",{className:"flex-1 flex flex-col pb-20",children:e.jsx("main",{className:"flex-1 p-0 overflow-y-auto",children:b()})}),e.jsx(Rd,{activeTab:f,onTabChange:x}),e.jsx(Dd,{toasts:c,onRemoveToast:u})]})},au=()=>e.jsx(Id,{children:e.jsx(Ad,{children:e.jsx(ru,{})})}),nu=()=>{const{user:n,loading:l,isFirstAccess:c}=Pt(),{toasts:u,removeToast:f,showInfo:x}=us(),{currentVersion:b,latestVersion:v,releaseNotes:S,hasUpdate:g,isLoading:j,isUpdating:p,checkForUpdates:M,applyUpdate:B}=$l(),[k,R]=Tt.useState("dashboard"),[C,D]=Tt.useState(!1),[E,U]=Tt.useState(!0),[q,J]=Tt.useState(!1);Tt.useEffect(()=>{c&&n&&D(!0)},[c,n]),Tt.useEffect(()=>{g&&!q&&(J(!0),x("Aggiornamento Disponibile",`Nuova versione ${v} disponibile. Tocca per aggiornare.`,1e4))},[g,q,v,x]);const N=async()=>{J(!1),x("Aggiornamento in corso...","L'app si riavvier√† automaticamente",3e3),await B()},_=()=>{J(!1),x("Aggiornamento rimandato","Puoi aggiornare in qualsiasi momento dal menu",5e3)},L=async()=>{await M(!0)?J(!0):x("App Aggiornata","Stai gi√† usando l'ultima versione disponibile",3e3)};if(E&&!n)return e.jsx("div",{className:"min-h-screen",children:e.jsx(Xl,{onEnter:()=>U(!1)})});if(l)return e.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"})});if(!n)return e.jsx("div",{className:"min-h-screen bg-gray-100",children:e.jsx(On,{children:e.jsxs(Cl,{children:[e.jsx(ga,{path:"/register",element:e.jsx(tc,{})}),e.jsx(ga,{path:"/azienda/*",element:e.jsx(au,{})}),e.jsx(ga,{path:"*",element:e.jsx(Zl,{})})]})})});const I=()=>{switch(k){case"calendar":return e.jsx(xc,{});case"checkin":return e.jsx(rd,{});case"expenses":return e.jsx(jd,{});case"talk":return e.jsx(Mi,{});case"report":return e.jsx(pd,{});case"profile":return e.jsx(ld,{});default:return e.jsx(hc,{onNavigate:R})}};return e.jsxs(On,{children:[e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white flex flex-col",children:[e.jsx(nc,{currentVersion:b,hasUpdate:g,isVersionLoading:j,isUpdating:p,onCheckUpdate:L}),e.jsx("div",{className:"flex-1 flex flex-col pb-20",children:e.jsx("main",{className:"flex-1 p-0 overflow-y-auto",children:I()})}),e.jsx(ic,{activeTab:k,onTabChange:R})]}),e.jsx(Wl,{toasts:u,onRemoveToast:f}),q&&g&&e.jsx(Yl,{currentVersion:b,latestVersion:v,releaseNotes:S,isUpdating:p,onUpdate:N,onDismiss:_}),C&&e.jsx(sc,{isOpen:C,onClose:()=>D(!1)})]})},iu=()=>e.jsx(Ul,{children:e.jsx(Hl,{children:e.jsx(ql,{children:e.jsx(nu,{})})})});if("serviceWorker"in navigator){const n=window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches,l=window.navigator.standalone===!0;n||l?(console.log("üì± App gi√† installata come PWA"),document.body.classList.add("pwa-installed")):(console.log("üì± App in modalit√† browser"),document.body.classList.add("pwa-browser"))}pi(document.getElementById("root")).render(e.jsx(w.StrictMode,{children:e.jsx(iu,{})}));
